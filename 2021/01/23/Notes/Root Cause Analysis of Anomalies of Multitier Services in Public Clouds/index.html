<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;zh-HK&quot;,&quot;zh-TW&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Root Cause Analysis of Anomalies of Multitier Services in Public Clouds | Jckling's Blog</title><meta name="author" content="Jckling"><meta name="copyright" content="Jckling"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="从云服务提供商角度，定位服务异常的根本原因。">
<meta property="og:type" content="article">
<meta property="og:title" content="Root Cause Analysis of Anomalies of Multitier Services in Public Clouds">
<meta property="og:url" content="https://jckling.github.io/2021/01/23/Notes/Root%20Cause%20Analysis%20of%20Anomalies%20of%20Multitier%20Services%20in%20Public%20Clouds/index.html">
<meta property="og:site_name" content="Jckling&#39;s Blog">
<meta property="og:description" content="从云服务提供商角度，定位服务异常的根本原因。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jckling.github.io/img/jckling/post.jpg">
<meta property="article:published_time" content="2021-01-23T07:29:02.000Z">
<meta property="article:modified_time" content="2021-11-23T14:04:58.777Z">
<meta property="article:author" content="Jckling">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jckling.github.io/img/jckling/post.jpg"><link rel="shortcut icon" href="/img/jckling/favicon.ico"><link rel="canonical" href="https://jckling.github.io/2021/01/23/Notes/Root%20Cause%20Analysis%20of%20Anomalies%20of%20Multitier%20Services%20in%20Public%20Clouds/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google_site_verification" content="pZZt69mo0ndoxIJ1vjEe830lXbvD26aiVAZ-k0FWM5k"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?20b7797c0b5f4e821c1449cd4c6c98c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-164555720-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-164555720-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Root Cause Analysis of Anomalies of Multitier Services in Public Clouds',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-23 22:04:58'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Jckling's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/jckling/avatar.jpg" onerror="onerror=null;src='/img/jckling/avatar_404.png'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/jckling/post.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jckling's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Root Cause Analysis of Anomalies of Multitier Services in Public Clouds</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-01-23T07:29:02.000Z" title="undefined 2021-01-23 15:29:02">2021-01-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Notes/">Notes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Root Cause Analysis of Anomalies of Multitier Services in Public Clouds"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/01/23/Notes/Root%20Cause%20Analysis%20of%20Anomalies%20of%20Multitier%20Services%20in%20Public%20Clouds/#post-comment"><span class="waline-comment-count" id="/2021/01/23/Notes/Root%20Cause%20Analysis%20of%20Anomalies%20of%20Multitier%20Services%20in%20Public%20Clouds/"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>从云供应商的角度，快速定位导致云平台上多层业务异常的根本原因，解决方案应该对租户的服务或应用程序是无侵入的（非侵入式）。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>多层服务或云应用涉及上百个组件，而这些组件又分布在不同的主机上。IaaS 云允许租户共享物理计算基础设施，可能影响性能。</p>
<p>公有云上租户的多层服务出现异常，可能是租户自身服务组件的问题，也可能是被其他租户的服务影响。</p>
<p>多层服务组件之间的依赖关系非常复杂，入侵式修改租户的服务组件代码不可行。</p>
<p>考虑错误传播距离、错误传播概率，解决方案包含 2 个部分</p>
<ul>
<li>数据收集：对租户是非侵入性的，用以捕获多层服务组件的依赖关系并收集必要的服务度量数据</li>
<li>根本原因定位：找出可能引发异常的根本原因列表，以及每个可能的根本原因对应的概率<ul>
<li>相似性评分的指标：基于服务的指标数据和底层基础设施的资源利用率进行计算</li>
<li>随机游走算法：模拟多层服务中异常传播的影响</li>
</ul>
</li>
</ul>
<p>在真实世界的小规模云平台上实现并部署了该系统，使用三层 Web 应用程序和 <a target="_blank" rel="noopener" href="https://storm.apache.org/">Storm</a> 应用程序进行了实验，证明了解决方案可以在虚拟机级别和进程级别定位异常根源。</p>
<p>对多种原因引起的异常进行了模拟实验，同时说明了在定位算法中采用相似度评分和随机漫步传播两步的合理性和必要性。实验结果表明，在不同场景下，定位异常的平均精度比现有方法提高了 15% ~ 71% 。</p>
<h1 id="相关工作"><a href="#相关工作" class="headerlink" title="相关工作"></a>相关工作</h1><p>Pivot Tracing、伪异常聚类算法…… 云环境下应用程序的性能异常诊断。</p>
<p>当异常沿着服务调用的路径在系统组件之间传播时，对多层服务的请求跟踪对于分析异常的根本原因是必要的。</p>
<p>请求跟踪</p>
<ul>
<li>利用特定于应用程序的知识或明确声明不同组件事件之间的因果关系，其缺点是用户必须获取和修改目标应用程序或中间件的源代码，而且不能用于黑箱服务；</li>
<li>vPath ，可以在虚拟机外进行请求跟踪，但是 vPath 是在基于 XEN 的虚拟化环境中设计的，无法移植到基于 KVM 的虚拟化环境中；</li>
<li>在不了解源代码的情况下，通过内核检测或虚拟机内部的流量监控来推断因果路径<ul>
<li>请求跟踪由 PreciseTracer 产生的因果路径图推断</li>
</ul>
</li>
</ul>
<p>社交网络中的谣言源检测旨在从网络中找出异常现象的根源，社交网络中的边缘连接具有确定性，时间是其谣言传播模型中的一个重要维度。</p>
<p>在云环境中，虚拟机之间的边缘连接很难确定，因此本文的异常传播模型不把时间作为一个维度，因为异常传播几乎是实时的。异常是否从一个节点传播到另一个节点受到其他因素的影响，例如它们之间是否存在严重的资源争夺。</p>
<h1 id="异常传播类型和系统架构"><a href="#异常传播类型和系统架构" class="headerlink" title="异常传播类型和系统架构"></a>异常传播类型和系统架构</h1><h2 id="异常传播类型"><a href="#异常传播类型" class="headerlink" title="异常传播类型"></a>异常传播类型</h2><ul>
<li>外部因素：虚拟机之间的资源争夺，异常可能从其他租户的虚拟机传播到该服务的一个虚拟机</li>
<li>内部因素：软件 bug，异常可能沿着服务调用的路径在多层服务的组件之间传播</li>
</ul>
<p>进行实验来证明这些因素是如何影响服务性能</p>
<p>实验环境：5 台物理主机构成的云环境，租户 A 申请 5 台虚拟机，租户 B 申请 3 台虚拟机，一些虚拟机分配在同一个物理主机（资源竞争），两个租户都运行三层 Web 应用程序 <a target="_blank" rel="noopener" href="https://github.com/sguazt/RUBiS">RUBiS</a> 。</p>
<ul>
<li><p>RUBiS 是一个为学术研究而开发的电子商务基准，可以根据研究人员设置的参数自动创建用户（10w）和商品（10w），初始化模拟一个在线购物网站；RUBiS 还提供了一个可模拟发送请求的用户行为的客户端，能够收集用户请求响应时间的统计结果。</p>
</li>
<li><p>租户 A 的 LVS 虚拟机根据用户请求的内容，将请求定向到两个 Apache 虚拟机中的一个（$vm_2$ 和 $vm_4$），即 $vm_1$ 实现了基于任务的负载平衡</p>
<ul>
<li><p>负载平衡策略：使用 <code>SearchItemsByRegion</code> 函数和 <code>ViewUserInfo</code> 函数（$R_1$ 表示）的请求由 $vm_2$ 服务，使用 <code>SearchItemsByCategory</code> 函数和 <code>ViewItem</code> 函数的请求（$R_2$ 表示）由 $vm_4$ 服务</p>
</li>
<li><p>2 条调用路径</p>
<ul>
<li><p>$P_1$：$vm_1 \rightarrow vm_2 \rightarrow vm_3$</p>
</li>
<li><p>$P_2$：$vm_1 \rightarrow vm_4 \rightarrow vm_5$</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>租户 B 只有 1 条调用路径 $P$ ：$vm_6 \rightarrow vm_7 \rightarrow vm_8$</p>
</li>
</ul>
<img src="https://i.loli.net/2021/06/06/E8iD1tBF4XqHIoV.png" />

<p>使用 CPU 负载生成器来提高 $vm_8$ 的 CPU 负载，同时记录租户 A 的服务请求响应时间，$R_1$ 的平均请求响应时间基本保持不变，$R_2$ 的平均响应时间随着 $vm_8$ 的负载越来越重而递增。</p>
<ul>
<li><p>$vm_5$  和 $vm_8$ 共享物理主机的 CPU 资源</p>
</li>
<li><p>2 种异常传播类型：$vm_8 \rightarrow vm_5$、$vm_5 \rightarrow vm_4 \rightarrow vm_1$</p>
</li>
</ul>
<img src="https://i.loli.net/2021/06/06/cRa5EQLmdUkqKGF.png" width=" 80%" />

<p>结论：在公有云中，存在两种异常传播路径：1）由于资源竞争而共存的虚拟机之间的异常传播路径；2）服务调用路径上的多层服务组件之间的异常传播路径。</p>
<p>命题1：云提供商有必要提供服务，帮助租户确定异常的根本原因。</p>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><p>数据收集子系统：在多层服务提供服务时一直运行</p>
<ul>
<li>在线请求跟踪</li>
<li>度量数据收集</li>
</ul>
<p>根本原因定位子系统：在租户提交异常时被激活，返回一个排序的根本原因列表</p>
<ul>
<li>构建异常传播图（VCG）</li>
<li>构建虚拟机通信图（APG）</li>
<li>相似性计算</li>
<li>随机游走算法</li>
</ul>
<img src="https://i.loli.net/2021/06/06/rZaBtY41X9JvnUI.png" width="80%" />

<p>租户发现服务请求 $r$ 的响应时间很长，提交给云提供商异常 $a$</p>
<ul>
<li><p>找出所有可能导致异常 $a$ 的原因，并构建异常传播图（Anomaly Propagation Graph, APG）$G^{APG}_{a}$。</p>
</li>
<li><p>确定 $G^{APG}_{a}$ 中每个元素作为异常 $a$ 的根本原因的概率，并找出最可能的根本原因。</p>
</li>
</ul>
<p><strong>Step 1</strong></p>
<p>跟踪在线请求，收集和保存数据。根据收集的数据可以构建请求 $r$ 的虚拟机通信图（VM Communication Graph, VCG），其中每条边反映了两台虚拟机之间的服务调用关系。</p>
<p>考虑由于资源竞争而导致的虚拟机之间的异常传播，异常传播图包含两种边，并置依赖边（collocation dependency）和服务调用边（service call）。</p>
<p><strong>Step 2</strong></p>
<p>寻找 APG 中最可能的根本原因，这里的问题是如何评估一个节点是根本原因的可能性。</p>
<p>定义度量标准：相似性。计算多层服务中各组件的服务时间并监控各虚拟机的资源使用情况，在度量数据收集模块中完成。</p>
<p>利用这些度量数据计算 APG 中每个虚拟机的相似性，然后再通过随机游走算法，结合虚拟机传播异常的概率，最终确定可能导致异常 $a$ 的根本原因。</p>
<h1 id="异常传播图（Anomaly-Propagation-Graph-APG）"><a href="#异常传播图（Anomaly-Propagation-Graph-APG）" class="headerlink" title="异常传播图（Anomaly Propagation Graph, APG）"></a>异常传播图（Anomaly Propagation Graph, APG）</h1><p>$vm_i \rightarrow vm_j$ 表示 $vm_i$ 依赖 $vm_j$：事实上，这些依赖边是异常传播的反向方向</p>
<ul>
<li><p>服务调用边：$vm_i$ 在处理请求时调用 $vm_j$</p>
</li>
<li><p>并置依赖边：$vm_i$ 和 $vm_j$ 位于同一个物理服务器中，而且 $vm_i$ 是多层服务的一个服务组件</p>
</li>
</ul>
<p>云提供商很容易检索共享物理机的虚拟机信息。例如，在 OpenStack 中，云提供商可以通过 nova 项目中实现的 api 获得物理机中的虚拟机分配情况。</p>
<p>一个请求会触发一系列的服务调用，服务调用边将形成一个有向无环图，这里称之为虚拟机通信图（VM Communication Graph, VCG），在图的拓扑结构上，VCG 实际上是对应 APG 的子图。</p>
<p>云提供商无法直接获得租户服务的调用关系信息。他们必须收集和分析数据来推断这些服务调用依赖的边缘。考虑到租户的隐私问题和多层服务的复杂性，云提供商应该在不入侵多层服务的情况下，基于请求跟踪技术构建 VCG 。</p>
<h2 id="多层服务请求跟踪"><a href="#多层服务请求跟踪" class="headerlink" title="多层服务请求跟踪"></a>多层服务请求跟踪</h2><p>在多层服务中，一个请求在操作系统内核或共享库中触发一系列的交互活动，PreciseTracer 使用 <a target="_blank" rel="noopener" href="https://www.sourceware.org/systemtap/">Systemtap</a> 捕获这些活动。</p>
<p>当为单个请求提供服务时，一系列具有因果关系或之前发生的关系的活动构成了因果路径图，PreciseTracer 提供了因果路径图，这是一个有向无环图，其中顶点是组件的活动，边表示两个活动之间的因果关系。</p>
<ul>
<li>有四种类型的活动：BEGIN、END、SEND、RECEIVE<ul>
<li>SEND 和 RECEIVE 活动是发送和接收消息的活动</li>
<li>BEGIN 活动标志着服务新请求的开始，END 活动标志着服务请求的结束</li>
</ul>
</li>
</ul>
<p>PreciseTracer 记录一个发送消息的活动为 $S^i_{i,j}$ ，表示进程 $i$ 向进程 $j$ 发送消息，记录一个接收消息的活动为 $R_j^{i,j}$，表示进程 $j$ 从进程 $i$ 接收一条消息。下图包含简单的活动序列 $\{R^1_{c,1},S^1_{1,2},R^2_{1,2},S^2_{2,3},R^3_{2,3},S^3_{3,x}\}$ ，根据这个图可以计算每个组件（虚拟机）在服务单个请求时的服务时间。对于下图中的请求，机器 B 的服务时间是 $t(S^2_{2,3})-t(R^2_{1,2})$ ，其中 $t(·)$ 为对应活动的时间戳，此外，定义 $h(·)$ 作为运行相应活动的虚拟机的主机名。</p>
<img src="https://i.loli.net/2021/06/06/fW5bkRuS8mrsFUj.png" width="80%" />

<h2 id="构造-VCG"><a href="#构造-VCG" class="headerlink" title="构造 VCG"></a>构造 VCG</h2><p>下图给出了由 PreciseTracer 在图 1 中所示场景中生成的因果路径图示例，$vm_1$ 中的服务 1 调用了两次 $vm_4$ 中的服务 2</p>
<ul>
<li><p>第一次调用：请求 $S^1_{1,2}$、$R^2_{1,2}$；响应 $S^2_{2,1}$、$R^1_{2,1}$</p>
</li>
<li><p>第二次调用：请求 $S^{1’}_{1,2}$、$R^{2’}_{1,2}$；响应 $S^{2’}_{2,1}$、$R^{1’}_{2,1}$</p>
<ul>
<li>服务 2 调用 $vm_5$ 中的服务 3 两次，然后再返回给服务 1</li>
</ul>
</li>
</ul>
<img src="https://i.loli.net/2021/06/06/TrWwPxzjV4FqnRp.png" width="80%" />

<p>不关心服务之间通信的细节，将因果图转换为虚拟机级别的服务调用边，即 VCG 。</p>
<ul>
<li><p>根据每个活动的主机名，将因果路径图中的活动划分为不同的集合，活动集合 $\S{v}$ 包含所有与 $vm_v$ 相关的活动</p>
</li>
<li><p>对于每个虚拟机 $vm_v$，按照时间戳对 $\S{v}$ 中的活动进行排序</p>
</li>
<li><p>对于每个虚拟机 $vm_v$，尝试在区分服务调用的请求者和响应者的基础上确定其相关边的方向</p>
</li>
<li><p>对于 SEND 活动，找到对应的 RECEIVE 活动</p>
</li>
<li><p>找不到满足 $h(S^j_{j,i})=h(R^j_{j,i})$ 和 $t(S^j_{j,i})&lt;t(R^j_{i,j})$ 的 SEND 活动 $S^j_{j,i}$ ，添加 $h(S^j_{j,i})\rightarrow h(R^j_{j,i})$</p>
</li>
</ul>
<h2 id="构造-APG"><a href="#构造-APG" class="headerlink" title="构造 APG"></a>构造 APG</h2><p>使用 nova api 获得并置边，根据 VCG 获得服务调用边。以图 1 所示的场景为例，租户 A 的用户发起的 <code>ViewItem</code> 请求将通过路径 2 传播，对应的 APG 如下图所示。</p>
<img src="https://i.loli.net/2021/06/06/BRlVaCuJfh4DZGA.png" width=" 70%" />

<h1 id="根本原因定位"><a href="#根本原因定位" class="headerlink" title="根本原因定位"></a>根本原因定位</h1><p>在本文中，异常是指多层服务请求的响应时间超过了用户能够容忍的时间。定义 $\Phi_a(i)$ 为虚拟机 $vm_i$ 是导致异常 $a$ 的根本原因的概率，$vm_{root}$ 表示导致异常的根本原因的虚拟机。</p>
<p>定义 $\mathbb{R}(r)$ 为一个请求的集合，这些请求构成了与 $r$ 相同的因果路径图；定义 $\mathbb{S}(vm_i,\mathbb{R}(r))$ 为 $vm_i$ 度量数据与 $\mathbb{R}(r)$ 的请求响应时间之间的相似性，相似性可以在一定程度上推导出其为根本原因的概率。</p>
<p>竞争资源可能导致响应时间增加，但不一定是异常的根本原因。以图 1 所示的场景为例，只有当 $\mathbb{S}(vm_1,R_2)$ 和 $\mathbb{S}(vm_6,R_2)$ 都很高时，租户 A 的异常才可能是由 $vm_6$ 引起。使用随机游走算法来反映异常传播的可能性。</p>
<p>命题2：作为根本原因的虚拟机必须满足两个条件：1）虚拟机的度量数据必须与请求的响应时间  $\mathbb{R}(r)$  高度相似；2）虚拟机通过 APG 传播异常的可能性必须很高。</p>
<h2 id="度量数据收集"><a href="#度量数据收集" class="headerlink" title="度量数据收集"></a>度量数据收集</h2><ol>
<li><p> 服务时间：虚拟机 $vm_i$ 对请求 $r$ 的服务时间表示为 $\eta_i = \sum_{x}(t(S^i_{i,x})-t(R^i_{x,i})) - \sum_{y}(t(R^i_{y,i})-t(S^i_{i,y}))$ ，$x$ 表示向虚拟机 $vm_i$ 发起请求的虚拟机，$y$ 表示接收虚拟机 $vm_i$ 请求的虚拟机；左式表示虚拟机 $vm_i$ 处理所有请求的时间和，包括等待响应时间，因此减去右式的等待间隔。</p>
</li>
<li><p> 资源消耗：使用 <a target="_blank" rel="noopener" href="http://ganglia.info/">Ganglia</a> 分布式监控系统收集资源利用率，默认收集物理机的度量数据，使用插件 sFlow 收集虚拟机的度量数据，包括 CPU 和内存消耗、I/O 和网络吞吐量。</p>
</li>
</ol>
<h2 id="相似度计算"><a href="#相似度计算" class="headerlink" title="相似度计算"></a>相似度计算</h2><p>度量数据和响应时间在一定程度上可以用于衡量虚拟机是导致异常的根本原因的概率。</p>
<p>仍然以图 1 所示的场景为例，增加 $vm_8$ 的 CPU 利用率，同时发送 <code>SearchItemsByCategory</code> 请求。下图显示了通过路径 2 处理请求的响应时间、$vm_5$ 的服务时间、$vm_1$ 的服务时间和 $vm_8$ 的 CPU 利用率的变化趋势，其中三条曲线和 $vm_5$ 的服务时间都有较强的相关性（$t_e$ 和 $t_s$ 之间）。</p>
<p>如图 2 所示，当 $vm_8$ 的 CPU 利用率小于某个阈值时，响应时间不会随着 $vm_8$ 的 CPU 利用率的增加而增加。</p>
<img src="https://i.loli.net/2021/06/06/Rci2AdfoFPgIsyt.png" width="80%" />

<p>如果 $vm_i$ 是多层服务的一个组件，根据其服务时间 $\eta_i$ 计算相似度；对于共享物理主机的虚拟机，首先计算请求的响应时间与不同类型的资源竞争（如 CPU 和内存、I/O 和网络吞吐量）之间的相关性，然后选择这些相关性的最大值来表示其相似性。</p>
<p>定义 $t(r)$ 表示发起请求 $r$ 的时间戳，$\tau(r)$ 表示其响应时间。根据 $t_s$ 到 $t_e$ 时间段计算的皮尔逊相关性系数，定义函数计算 $vm_i$ 度量值 $M$ 与请求 $\mathbb{R}(r)$ 响应时间的相关性</p>
<p>$$<br>\Re(i,M,\mathbb{R}(r),t_s,t_e) = \frac{Cov(\mathbb{M}^{t_e}_{t_s}(M,i),\mathbb{T}^{t_e}_{t_s}(\mathbb{R}(r)))}{\sigma_{\mathbb{M}^{t_e}_{t_s}(M,i)}\sigma_{\mathbb{T}^{t_e}_{t_s}(\mathbb{R}(r))}}<br>$$</p>
<ul>
<li><p>$\mathbb{M}^{t_e}_{t_s}(M,i)$ 表示虚拟机 $vm_i$ 的度量数据</p>
</li>
<li><p>$\mathbb{T}^{t_e}_{t_s}(\mathbb{R}(r))$ 表示相关请求的响应时间</p>
</li>
</ul>
<p>相似度 $\mathbb{S}(vm_i,\mathbb{R}(r))$</p>
<p>$$<br>\mathbb{S}(vm_i,\mathbb{R}(r))=\left\{<br>\begin{array}{rcl}<br>\Re(i,M,\mathbb{R}(r),t_s,t_e), &amp; \text{if}\ vm_i\in{VCG}\\<br>\max{\{\Re(i,M,\mathbb{R}(r),t_s,t_e)|v\in\Upsilon}\}, &amp; \text{otherwise}\\<br>\end{array} \right.<br>$$</p>
<ul>
<li>$\Upsilon$ 表示竞争的资源类型，例如 CPU、内存、I/O、网络</li>
</ul>
<ol>
<li><p>在 $vm_i$ 处理请求 $\mathbb{R}(r)$ 时，收集 $vm_i$ 的服务时间 $\eta_i$ 的历史数据</p>
<p> 给定一个因果路径图，根据拓扑排序算法，求得活动序列 $\S$，然后使用活动 $A$ 的属性元组（活动类型，程序名）来表示 $\S$ 中的活动 $A$ 。以图 5 为例，可以得到因果路径图序列为<br> $\{(B,P_1), (S, P_1), (R, P_2), (S, P_2), (R, P_1), (S, P_1), (R, P_2), (S, P_2), (R, P_3), (S, P_3), (R, P_2), (S, P_2), (R, P_3), (S, P_3), (R, P_2), (S, P_2), (R, P_1), (E,P_1)\}$ $B$、$E$、$S$、$R$ 表示四种活动，$P_i$ 表示进程 $i$ 的名称。最后，只需要找出与 $r$ 因果路径图具有相同序列的因果路径图。</p>
</li>
<li><p>确定时间点 $t_s$ 和 $t_e$</p>
<p> $$<br> t_s = \min{\{t|\frac{\tau(r_t)}{E(\mathbb{T}^t_{t-w}(\mathbb{R}(r)))}\}&gt;\delta}<br> $$</p>
<ul>
<li><p>$r_t$ 表示请求，$t$ 为时间戳，$w$ 为时间窗口长度</p>
</li>
<li><p>$t_s$ 表示最早时间点 $t$，在 $t$ 时刻发出的请求响应时间与前一个时间窗口发出的请求的平均响应时间之比大于阈值 $\delta$ （例如，1.2）</p>
</li>
</ul>
</li>
</ol>
<h2 id="随机游走算法"><a href="#随机游走算法" class="headerlink" title="随机游走算法"></a>随机游走算法</h2><p>给定一个 APG $G^{APG}(V,E)$ ，定义矩阵 $Q$</p>
<ul>
<li><p>前向边</p>
</li>
<li><p>后向边：$\rho$ 由管理员设置，范围在 0~1 之间</p>
</li>
<li><p>重边</p>
</li>
</ul>
<p>$$<br>Q_{ij}=\left\{<br>\begin{array}{rcl}<br>\mathbb{S}(vm_j,\mathbb{R}(r)), &amp; \text{if}\ e_ij\in{E}\\<br>\rho\mathbb{S}(vm_j,\mathbb{R}(r)), &amp; \text{if}\ e_{ji}\in{E},e_{ij}\notin{E}\\<br>\max{(0,\mathbb{S}(vm_i,\mathbb{R}(r))-\max_{k:e_j,k\in{E}}\mathbb{S}(vm_k,\mathbb{R}(r)))}, &amp; \text{if}\ j=i\\<br>\end{array} \right.<br>$$</p>
<p>将矩阵 $Q$ 的每一行标准化，得到转移概率矩阵 $\overline{Q}=\frac{Q_{ij}}{\sum_j{Q_{ij}}}$ ，在 APG 上进行随机游走，从 $vm_i$ 移动到 $vm_j$ 的概率为 $\overline{Q}_{ij}$ 。多次移动并计算每台虚拟机上的访问次数。更多的访问次数意味着该虚拟机更可能是一个根本原因。</p>
<h1 id="实验评估"><a href="#实验评估" class="headerlink" title="实验评估"></a>实验评估</h1><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><ul>
<li><p>OpenStack：搭建云环境，提供虚拟机服务等。</p>
</li>
<li><p>PreciserTracer：在每台虚拟机上部署代理 <em>TCP_Tracer</em> ，然后把不同虚拟机的活动日志关联到因果路径图中。从因果路径图中计算关于每个虚拟机服务时间的度量数据，并将结果存储在数据库中。</p>
</li>
<li><p>Ganglia：部署在每个物理服务器上，收集每个虚拟机的资源利用率。</p>
</li>
</ul>
<img src="https://i.loli.net/2021/06/06/Jbi5LDBOaw9EgQ1.png" width="80%" />

<h2 id="性能评估"><a href="#性能评估" class="headerlink" title="性能评估"></a>性能评估</h2><p><strong>基准方法</strong></p>
<ul>
<li>随机选择（Random Selection, RS）：模拟随机检查虚拟机</li>
<li>突变（Sudden Change, SC）：比较当前时间窗口和以前时间窗口的度量比率</li>
<li>基于距离的排名（Distance Based Rank, DBR）：每个组件 $c$ 都形成一个传播图，其中的节点是可以从 $c$ 到达的异常组件。确定根本原因转化为选择最优传播图的问题，排名由源实体到其他所有异常实体的最小总距离决定。</li>
</ul>
<p><strong>评价指标</strong></p>
<ul>
<li><p>最佳 K 精度（Precision at top K , PR@K）：每种算法给出的前 $K$ 个虚拟机</p>
</li>
<li><p>各类别平均值的平均（Mean Average Precision, MAP）：量化方法的整体性能</p>
</li>
</ul>
<p>定义 $N_a(i)$ 表示在查找到导致异常 $a$ 的根本原因 $vm_i$ 前检查过但不是真正的根本原因的虚拟机数量，基于此定义：</p>
<ul>
<li>平均假阳性（Average False Positive, AFP）</li>
<li>最大假阳性（Max False Positive, MFP）</li>
</ul>
<h2 id="虚拟机级别的根本原因分析"><a href="#虚拟机级别的根本原因分析" class="headerlink" title="虚拟机级别的根本原因分析"></a>虚拟机级别的根本原因分析</h2><p>如图 1 所示的架构，考虑 4 种情况：</p>
<ol>
<li><p>由服务中的一个组件引起并通过服务调用传播的异常（$vm_4$）</p>
<p>在 $vm_4$ 上进行延迟注入，每个请求 <code>SearchItemsByCategory</code> 的延迟在 2ms ~25 ms</p>
</li>
<li><p>由其他租户的并置虚拟机引起的异常，并通过并置边缘进行传播（$vm_8$ 和 $vm_5$）</p>
<p>编排 $vm_8$ 的 CPU 利用率，将会影响 $vm_5$ 上 MySQL 的性能，最终导致服务异常</p>
</li>
<li><p>并置的虚拟机资源不足，无法传播影响业务（几乎不影响）</p>
<p>编排 $vm_6$ 的 CPU 利用率，不影响 $vm_1$ 上 LVS 的性能</p>
</li>
<li><p>两个并置虚拟机发生资源不足，其中一个无法传播（$vm_8$ 和 $vm_5$）</p>
<p>结合情况 2、3，同时编排 $vm_6$ 和 $vm_8$ 的 CPU 利用率</p>
</li>
</ol>
<h2 id="多种原因引起异常的根本原因分析"><a href="#多种原因引起异常的根本原因分析" class="headerlink" title="多种原因引起异常的根本原因分析"></a>多种原因引起异常的根本原因分析</h2><p>接下来采用不同的根本原因分析方法来定位这三种异常的根本原因，在这个实验中度量定义中的 $\mathbb{A}$ 包含了上述三种异常情况。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Cloudslab/cloudsim">CloudSim</a> 是云计算基础设施和服务的建模和仿真框架，只能模拟非常简单的应用程序模型；<a target="_blank" rel="noopener" href="https://github.com/lsinfo3/EdgeNetworkCloudSim">Networkcloudsim</a> 在 CloudSim 的基础上进行扩展，可以使用通信元素或任务来模拟应用程序。</p>
<p>首先设计一种算法构建云环境，在租户申请虚拟机时模拟虚拟机分配到物理服务器，然后还设计了一种算法来构建面向云租户的多层服务拓扑结构，最后使用 Networkcloudsim 模拟云和租户服务的运行。</p>
<h2 id="诊断时间分析"><a href="#诊断时间分析" class="headerlink" title="诊断时间分析"></a>诊断时间分析</h2><h2 id="方法讨论"><a href="#方法讨论" class="headerlink" title="方法讨论"></a>方法讨论</h2><p>随机游走算法，排除那些仅仅因为相同的周期性用户行为模式而与多层服务高度相关的虚拟机。</p>
<img src="https://i.loli.net/2021/06/06/YR8xOzWr9fUEje7.png" width=" 80%" />

<h1 id="进程级别的根本原因分析"><a href="#进程级别的根本原因分析" class="headerlink" title="进程级别的根本原因分析"></a>进程级别的根本原因分析</h1><p>租户 A 和租户 B 同时运行 Storm 应用程序，租户 A 同时运行两个进程，如果租户 A 的服务性能异常，必须定位是哪个进程行为异常导致。</p>
<p>Storm 应用程序被建模为一个称为拓扑（topology）的有向图，通常包括两种类型的组件：spout 和 bolt ，spout 是数据流的一个源，而 bolt 使用来自 spout 或其他 bolt 的元组，并按照用户代码定义的方式进行处理。Spout 和 bolt 可以在多个虚拟机上并行执行多个任务，即在一个集群中的工作节点中。</p>
<p>下图包含一个 spout 和两个 bolt 的链式拓扑，数据 spout 是分布式流媒体平台 Kafka 的消费者，数据 spout 订阅 Kafka 的一个主题，Kafka 将自动发送数据到 spout 。数据 spout 连接到一个SplitSentence bolt ，该 bolt 将每一行拆分为单词，并使用字段分组提供给 WordCount bolt ，WordCount bolt 基于不同的输入单词元组递增计数器。</p>
<p>租户 A 将 spout 和 bolt 的并行度设置为 2 ，即对于每个 spout 或 bolt , $vm_1$、$vm_2$ 和 $vm_3$ 中都同时运行两个任务。租户 B 将 spout 和 bolt 的并行度设置为 1 。</p>
<p>由于在同一个虚拟机上运行着两个进程，所以云提供商不能使用 PreciseTracer 来执行请求跟踪或直接收集度量数据，Storm 提供了 Thrift API ，可以在不干扰租户服务的情况下监控拓扑的运行。</p>
<img src="https://i.loli.net/2021/06/06/kUquYA13ODMZNba.png" width="80%" />

<p>首先，云提供商可以使用 <code>getExecutors</code> 函数来获取租户 A 的拓扑进程列表。对于每个进程，云提供商可以使用 <code>getComponent_id</code> 函数来获取进程名，再使用 <code>getHost</code> 函数来查找进程运行的虚拟机。根据进程名可以构建进程之间的通信关系，根据虚拟机名称可以通过云平台的 API 找到租户 B 的虚拟机。</p>
<p>有了两种关系，云提供商可以构造如下图所示的 APG。</p>
<img src="https://i.loli.net/2021/06/06/tgGsAZpm2wfMxRh.png" width="80%" />

<p>然后，云提供商可以使用 <code>getComplete_ms_avg</code> 函数来获取元组进程的总时间（从数据 spout 接收句子到 WordCount bolt 完成句子的单词计数的时间），再使用 <code>getExecute_ms_avg</code> 函数获取每个 bolt 进程所花费的时间。</p>
<p>使用这些度量数据，云供应商可以计算出这些节点的相似性。</p>
<p>最后，云提供商可以对 APG 使用随机游走算法，找出根本原因列表及其相应的概率。</p>
<img src="https://i.loli.net/2021/06/06/og6IcyUTJBqmxaN.png" width="80%" /></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jckling</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jckling.github.io/2021/01/23/Notes/Root%20Cause%20Analysis%20of%20Anomalies%20of%20Multitier%20Services%20in%20Public%20Clouds/">https://jckling.github.io/2021/01/23/Notes/Root Cause Analysis of Anomalies of Multitier Services in Public Clouds/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jckling.github.io" target="_blank">Jckling's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/jckling/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/jckling/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/jckling/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1035234274961147" data-ad-slot="3100725659" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/27/Other/Chrome%20%E6%8F%92%E4%BB%B6%E6%8E%A8%E8%8D%90/"><img class="prev-cover" src="https://i.loli.net/2021/06/14/SKJsWtXpRB6lrCE.png" onerror="onerror=null;src='/img/jckling/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Chrome 插件推荐</div></div></a></div><div class="next-post pull-right"><a href="/2021/01/20/OpenStack/OpenStack%20%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/"><img class="next-cover" src="https://i.loli.net/2021/06/14/NfcmdhT7uUx4pqo.jpg" onerror="onerror=null;src='/img/jckling/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">OpenStack 部署方式总结</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/jckling/avatar.jpg" onerror="this.onerror=null;this.src='/img/jckling/avatar_404.png'" alt="avatar"/></div><div class="author-info__name">Jckling</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jckling"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎访问本站 🥳 <br/>评论需要审核，请不要重复提交~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">相关工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B%E5%92%8C%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">异常传播类型和系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">异常传播类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">3.2.</span> <span class="toc-text">系统架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E4%BC%A0%E6%92%AD%E5%9B%BE%EF%BC%88Anomaly-Propagation-Graph-APG%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">异常传播图（Anomaly Propagation Graph, APG）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%B1%82%E6%9C%8D%E5%8A%A1%E8%AF%B7%E6%B1%82%E8%B7%9F%E8%B8%AA"><span class="toc-number">4.1.</span> <span class="toc-text">多层服务请求跟踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0-VCG"><span class="toc-number">4.2.</span> <span class="toc-text">构造 VCG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0-APG"><span class="toc-number">4.3.</span> <span class="toc-text">构造 APG</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0%E5%AE%9A%E4%BD%8D"><span class="toc-number">5.</span> <span class="toc-text">根本原因定位</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%A6%E9%87%8F%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86"><span class="toc-number">5.1.</span> <span class="toc-text">度量数据收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E4%BC%BC%E5%BA%A6%E8%AE%A1%E7%AE%97"><span class="toc-number">5.2.</span> <span class="toc-text">相似度计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E6%B8%B8%E8%B5%B0%E7%AE%97%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">随机游走算法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%AF%84%E4%BC%B0"><span class="toc-number">6.</span> <span class="toc-text">实验评估</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">6.1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0"><span class="toc-number">6.2.</span> <span class="toc-text">性能评估</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BA%A7%E5%88%AB%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-number">6.3.</span> <span class="toc-text">虚拟机级别的根本原因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%A7%8D%E5%8E%9F%E5%9B%A0%E5%BC%95%E8%B5%B7%E5%BC%82%E5%B8%B8%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-number">6.4.</span> <span class="toc-text">多种原因引起异常的根本原因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%8A%E6%96%AD%E6%97%B6%E9%97%B4%E5%88%86%E6%9E%90"><span class="toc-number">6.5.</span> <span class="toc-text">诊断时间分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%AE%A8%E8%AE%BA"><span class="toc-number">6.6.</span> <span class="toc-text">方法讨论</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%BA%A7%E5%88%AB%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">进程级别的根本原因分析</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/" title="Datalog 引擎 Soufflé 指南"><img src="https://i.loli.net/2021/06/14/oSn9dxfYhEHClIe.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="Datalog 引擎 Soufflé 指南"/></a><div class="content"><a class="title" href="/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/" title="Datalog 引擎 Soufflé 指南">Datalog 引擎 Soufflé 指南</a><time datetime="2021-11-22T11:01:43.000Z" title="发表于 2021-11-22 19:01:43">2021-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/05/Jaeger/CVE-2020-12691%20%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E8%BF%BD%E8%B8%AA/" title="CVE-2020-12691 漏洞利用相关信息追踪"><img src="https://i.loli.net/2021/06/14/bk5UlhqE4DZJfYu.png" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="CVE-2020-12691 漏洞利用相关信息追踪"/></a><div class="content"><a class="title" href="/2021/11/05/Jaeger/CVE-2020-12691%20%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E8%BF%BD%E8%B8%AA/" title="CVE-2020-12691 漏洞利用相关信息追踪">CVE-2020-12691 漏洞利用相关信息追踪</a><time datetime="2021-11-05T07:25:15.000Z" title="发表于 2021-11-05 15:25:15">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/" title="LogiQL 入门"><img src="https://developer.logicblox.com/wp-content/uploads/2017/12/prod-bg-panelfour.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="LogiQL 入门"/></a><div class="content"><a class="title" href="/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/" title="LogiQL 入门">LogiQL 入门</a><time datetime="2021-10-26T08:15:05.000Z" title="发表于 2021-10-26 16:15:05">2021-10-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Gadget Inspector 源码解析"><img src="https://i.loli.net/2021/06/14/2NXqsznriG8blc7.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="Gadget Inspector 源码解析"/></a><div class="content"><a class="title" href="/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Gadget Inspector 源码解析">Gadget Inspector 源码解析</a><time datetime="2021-10-12T03:41:30.000Z" title="发表于 2021-10-12 11:41:30">2021-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/" title="Python 爬取 twitter 数据"><img src="https://about.twitter.com/content/dam/about-twitter/en/brand-toolkit/brand-banner-desktop.jpg.twimg.1920.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="Python 爬取 twitter 数据"/></a><div class="content"><a class="title" href="/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/" title="Python 爬取 twitter 数据">Python 爬取 twitter 数据</a><time datetime="2021-10-11T10:44:50.000Z" title="发表于 2021-10-11 18:44:50">2021-10-11</time></div></div></div></div><div class="card-widget ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1035234274961147" data-ad-slot="8787224657" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></main><footer id="footer" style="background-image: url('/img/jckling/post.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Jckling</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://blog-comments-puce.vercel.app',
      avatar: 'retro',
      avatarCDN: 'https://sdn.geekzu.org/avatar/',
      path: location.pathname,
      visitor: false,
      dark: 'html[data-theme="dark"]'
    }, {"emoji":"https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji"}))
  }

  if (typeof Waline === 'function') initWaline() 
  else getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js').then(initWaline)
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>